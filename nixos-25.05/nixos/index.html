<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 <title>NixOS Manual</title>
<link rel="stylesheet" type="text/css" href="style.css" /><link rel="stylesheet" type="text/css" href="highlightjs/mono-blue.css" />
<script src="./highlightjs/highlight.pack.js" type="text/javascript"></script><script src="./highlightjs/loader.js" type="text/javascript"></script><script src="./anchor.min.js" type="text/javascript"></script><script src="./anchor-use.js" type="text/javascript"></script><script src="/nix/store/gyf27a5c24hjxi15a7bjn7yjnq71apj9-nixos-manual-html/share/doc/nixos/index-redirects.js" type="text/javascript"></script>
 <meta name="generator" content="nixos-render-docs 25.05pre-git" />
 <link rel="home" href="index.html" title="NixOS Manual" />
 <link rel="next" href="options.html" title="Appendix A. Configuration Options" />
 </head>
 <body>
  <div class="navheader">
   <table width="100%" summary="Navigation header">
    <tr>
    <th colspan="3" align="center">NixOS Manual</th>
    </tr>
    <tr>
    <td width="20%" align="left">&nbsp;</td>
    <th width="60%" align="center">&nbsp;</th>
    <td width="20%" align="right">&nbsp;<a accesskey="n" href="options.html">Next</a></td>
    </tr>
   </table>
   <hr />
  </div>
 <div class="book">
  <div class="titlepage">
   <div>
   <div><h1 class="title"><a id="book-nixos-manual"></a>NixOS Manual</h1></div>
   <div><h2 class="subtitle">Version 25.05</h2></div>
   </div>
   <hr />
  </div>
<div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="preface">  <a href="index.html#preface">Preface</a> </span></dt><dt> <span class="part">  <a href="index.html#ch-installation">Installation</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#sec-obtaining">Obtaining NixOS</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-installation">Installing NixOS</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-changing-config">Changing the Configuration</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-upgrading">Upgrading NixOS</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-building-image">Building a NixOS (Live) ISO</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-image-nixos-rebuild-build-image">Building Images with <code class="literal">nixos-rebuild build-image</code></a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-image-repart">Building Images via <code class="literal">systemd-repart</code></a> </span></dt></dl></dd><dt> <span class="part">  <a href="index.html#ch-configuration">Configuration</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#sec-configuration-syntax">Configuration Syntax</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-package-management">Package Management</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-user-management">User Management</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-file-systems">File Systems</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-x11">X Window System</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-wayland">Wayland</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-gpu-accel">GPU acceleration</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-xfce">Xfce Desktop Environment</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-networking">Networking</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-kernel-config">Linux Kernel</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-subversion">Subversion</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-pantheon">Pantheon Desktop</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-gnome">GNOME Desktop</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-bootloader-external">External Bootloader Backends</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-boot-clevis">Clevis</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-garage">Garage</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-youtrack">YouTrack</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-suwayomi-server">Suwayomi-Server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-strfry">strfry</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-plausible">Plausible</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-pingvin-share">Pingvin Share</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-pict-rs">Pict-rs</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-nextcloud">Nextcloud</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-matomo">Matomo</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-lemmy">Lemmy</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-keycloak">Keycloak</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-jitsi-meet">Jitsi Meet</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-honk">Honk</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-hatsu">Hatsu</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-grocy">Grocy</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-gotosocial">GoToSocial</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-glance">Glance</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-filesender">FileSender</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-discourse">Discourse</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-davis">Davis</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-castopod">Castopod</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-c2fmzq">c2FmZQ</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-akkoma">Akkoma</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-systemd-lock-handler">systemd-lock-handler</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-kerberos-server">kerberos_server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-meilisearch">Meilisearch</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-networking-yggdrasil">Yggdrasil</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-service-umurmur">uMurmur</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-prosody">Prosody</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-pleroma">Pleroma</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-netbird-server">Netbird server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-netbird">Netbird</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-mosquitto">Mosquitto</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-jotta-cli">Jottacloud Command-line Tool</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-gns3-server">GNS3 Server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-firefox-syncserver">Firefox Sync server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-service-doh-server">DNS-over-HTTPS Server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-networking-dnsmasq">Dnsmasq</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-crab-hole">🦀 crab-hole</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-anubis">Anubis</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-samba">Samba</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-litestream">Litestream</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-prometheus-exporters">Prometheus exporters</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-parsedmarc">parsedmarc</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-ocsinventory-agent">OCS Inventory Agent</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-goss">Goss</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-certspotter">Cert Spotter</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-weechat">WeeChat</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-taskserver">Taskserver</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-sourcehut">Sourcehut</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-gitlab">GitLab</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-forgejo">Forgejo</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-dump1090-fa">Dump1090-fa</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-apache-kafka">Apache Kafka</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-anki-sync-server">Anki Sync Server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-matrix">Matrix</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-mjolnir">Mjolnir (Matrix Moderation Tool)</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-mautrix-signal">Mautrix-Signal</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-maubot">Maubot</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-draupnir">Draupnir (Matrix Moderation Bot)</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-mailman">Mailman</a> </span></dt><dt> <span class="chapter">  <a href="index.html#trezor">Trezor</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-hardware-display">Customizing display configuration</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-emacs">Emacs</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-livebook">Livebook</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-blackfire">Blackfire profiler</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-athens">Athens</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-flatpak">Flatpak</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-tigerbeetle">TigerBeetle</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-postgresql">PostgreSQL</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-foundationdb">FoundationDB</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-borgbase">BorgBackup</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-security-acme">SSL/TLS Certificates with ACME</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-programs-zsh-ohmyzsh">Oh my ZSH</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-program-plotinus">Plotinus</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-programs-digitalbitbox">Digital Bitbox</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-input-methods">Input Methods</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-profiles">Profiles</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-mattermost">Mattermost</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-kubernetes">Kubernetes</a> </span></dt></dl></dd><dt> <span class="part">  <a href="index.html#ch-running">Administration</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#sec-systemctl">Service Management</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-rebooting">Rebooting and Shutting Down</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-user-sessions">User Sessions</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-cgroups">Control Groups</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-logging">Logging</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-system-state">Necessary system state</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-nix-gc">Cleaning the Nix Store</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-containers">Container Management</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-troubleshooting">Troubleshooting</a> </span></dt></dl></dd><dt> <span class="part">  <a href="index.html#ch-development">Development</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#sec-getting-sources">Getting the Sources</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-writing-modules">Writing NixOS Modules</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-building-parts">Building Specific Parts of NixOS</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-bootspec">Bootspec</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-switching-systems">What happens during a system switch?</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-writing-documentation">Writing NixOS Documentation</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-nixos-tests">NixOS Tests</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-developing-the-test-driver">Developing the NixOS Test Driver</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-testing-installer">Testing the Installer</a> </span></dt></dl></dd><dt> <span class="chapter">  <a href="index.html#chap-contributing">Contributing to this manual</a> </span></dt><dt> <span class="appendix">  <a href="options.html">A. Configuration Options</a> </span></dt><dt> <span class="appendix">  <a href="release-notes.html">B. Release Notes</a> </span></dt> </dl></div><div class="list-of-examples"><p><strong>List of Examples</strong></p><dl><dt>1. <a href="index.html#ex-partition-scheme-MBR">Example partition schemes for NixOS on <code class="literal">/dev/sda</code> (MBR)</a></dt><dt>2. <a href="index.html#ex-partition-scheme-UEFI">Example partition schemes for NixOS on <code class="literal">/dev/sda</code> (UEFI)</a></dt><dt>3. <a href="index.html#ex-install-sequence">Commands for Installing NixOS on <code class="literal">/dev/sda</code></a></dt><dt>4. <a href="index.html#ex-config">Example: NixOS Configuration</a></dt><dt>5. <a href="index.html#ex-nixos-rebuild-build-image-customize">Customize specific image variants</a></dt><dt>6. <a href="index.html#ex-emacsNix">Nix expression to build Emacs with packages (<code class="literal">emacs.nix</code>)</a></dt><dt>7. <a href="index.html#module-services-emacs-querying-packages">Querying Emacs packages</a></dt><dt>8. <a href="index.html#module-services-emacs-configuration-nix">Custom Emacs in <code class="literal">configuration.nix</code></a></dt><dt>9. <a href="index.html#module-services-emacs-config-nix">Custom Emacs in <code class="literal">~/.config/nixpkgs/config.nix</code></a></dt><dt>10. <a href="index.html#ex-emacsGtk3Nix">Custom Emacs build</a></dt><dt>11. <a href="index.html#ex-module-syntax">Structure of NixOS Modules</a></dt><dt>12. <a href="index.html#locate-example">NixOS Module for the “locate” Service</a></dt><dt>13. <a href="index.html#exec-escaping-example">Escaping in Exec directives</a></dt><dt>14. <a href="index.html#ex-options-declarations-util-mkEnableOption-magic"><code class="literal">mkEnableOption</code> usage</a></dt><dt>15. <a href="index.html#ex-options-declarations-util-mkPackageOption-hello">Simple <code class="literal">mkPackageOption</code> usage</a></dt><dt>16. <a href="index.html#ex-options-declarations-util-mkPackageOption-ghc"><code class="literal">mkPackageOption</code> with explicit default and example</a></dt><dt>17. <a href="index.html#ex-options-declarations-util-mkPackageOption-extraDescription"><code class="literal">mkPackageOption</code> with additional description text</a></dt><dt>18. <a href="index.html#ex-option-declaration-eot-service">Extensible type placeholder in the service module</a></dt><dt>19. <a href="index.html#ex-option-declaration-eot-backend-gdm">Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">gdm</code> module</a></dt><dt>20. <a href="index.html#ex-option-declaration-eot-backend-sddm">Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">sddm</code> module</a></dt><dt>21. <a href="index.html#ex-types-anything"><code class="literal">types.anything</code></a></dt><dt>22. <a href="index.html#ex-submodule-direct">Directly defined submodule</a></dt><dt>23. <a href="index.html#ex-submodule-reference">Submodule defined as a reference</a></dt><dt>24. <a href="index.html#ex-submodule-listof-declaration">Declaration of a list of submodules</a></dt><dt>25. <a href="index.html#ex-submodule-listof-definition">Definition of a list of submodules</a></dt><dt>26. <a href="index.html#ex-submodule-attrsof-declaration">Declaration of attribute sets of submodules</a></dt><dt>27. <a href="index.html#ex-submodule-attrsof-definition">Definition of attribute sets of submodules</a></dt><dt>28. <a href="index.html#ex-extending-type-check-1">Adding a type check</a></dt><dt>29. <a href="index.html#ex-extending-type-check-2">Overriding a type check</a></dt><dt>30. <a href="index.html#ex-freeform-module">Freeform submodule</a></dt><dt>31. <a href="index.html#ex-settings-nix-representable">Module with conventional <code class="literal">settings</code> option</a></dt><dt>32. <a href="index.html#ex-settings-typed-attrs">Declaring a type-checked <code class="literal">settings</code> attribute</a></dt></dl></div>
<div class="preface"> <div class="titlepage">  <div>   <div>    <h1 id="preface" class="title" >Preface   </h1>  </div> </div></div><p>This manual describes how to install, use and extend NixOS, a Linux distribution based on the purely functional package management system <a class="link" href="https://nixos.org/nix"  target="_top">Nix</a>, that is composed using modules and packages defined in the <a class="link" href="https://nixos.org/nixpkgs"  target="_top">Nixpkgs</a> project.</p><p>Additional information regarding the Nix package manager and the Nixpkgs project can be found in respectively the <a class="link" href="https://nixos.org/nix/manual"  target="_top">Nix manual</a> and the <a class="link" href="https://nixos.org/nixpkgs/manual"  target="_top">Nixpkgs manual</a>.</p><p>If you encounter problems, please report them on the <a class="link" href="https://discourse.nixos.org"  target="_top"><code class="literal">Discourse</code></a>, the <a class="link" href="https://matrix.to/#/%23nix:nixos.org"  target="_top">Matrix room</a>, or on the <a class="link" href="irc://irc.libera.chat/#nixos"  target="_top"><code class="literal">#nixos</code> channel on Libera.Chat</a>. Alternatively, consider <a class="link" href="index.html#chap-contributing" title="Contributing to this manual" >contributing to this manual</a>. Bugs should be reported in <a class="link" href="https://github.com/NixOS/nixpkgs/issues"  target="_top">NixOS’ GitHub issue tracker</a>.</p><div class="note"><h3 class="title">Note</h3><p>Commands prefixed with <code class="literal">#</code> have to be run as root, either requiring to login as root user or temporarily switching to it using <code class="literal">sudo</code> for example.</p></div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="ch-installation" class="title" >Installation   </h1>  </div> </div></div><div class="partintro"><p>This section describes how to obtain, install, and configure NixOS for first-time use.</p><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#sec-obtaining">Obtaining NixOS</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-installation">Installing NixOS</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-changing-config">Changing the Configuration</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-upgrading">Upgrading NixOS</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-building-image">Building a NixOS (Live) ISO</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-image-nixos-rebuild-build-image">Building Images with <code class="literal">nixos-rebuild build-image</code></a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-image-repart">Building Images via <code class="literal">systemd-repart</code></a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-obtaining" class="title" >Obtaining NixOS   </h2>  </div> </div></div><p>NixOS ISO images can be downloaded from the <a class="link" href="https://nixos.org/download.html#nixos-iso"  target="_top">NixOS download
page</a>. Follow the instructions in
<a class="xref" href="index.html#sec-booting-from-usb" title="Booting from a USB flash drive" >the section called “Booting from a USB flash drive”</a> to create a bootable USB flash drive.</p><p>If you have a very old system that can’t boot from USB, you can burn the image
to an empty CD. NixOS might not work very well on such systems.</p><p>As an alternative to installing NixOS yourself, you can get a running
NixOS system through several other means:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Using virtual appliances in Open Virtualization Format (OVF) that
can be imported into VirtualBox. These are available from the <a class="link" href="https://nixos.org/download.html#nixos-virtualbox"  target="_top">NixOS
download page</a>.</p></li><li class="listitem"><p>Using AMIs for Amazon’s EC2. To find one for your region, please refer
to the <a class="link" href="https://nixos.org/download.html#nixos-amazon"  target="_top">download page</a>.</p></li><li class="listitem"><p>Using NixOps, the NixOS-based cloud deployment tool, which allows
you to provision VirtualBox and EC2 NixOS instances from declarative
specifications. Check out the <a class="link" href="https://nixos.org/nixops"  target="_top">NixOps
homepage</a> for details.</p></li></ul></div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-installation" class="title" >Installing NixOS   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-installation-booting">Booting from the install medium</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-installation-graphical">Graphical Installation</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-installation-manual">Manual Installation</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-installation-additional-notes">Additional installation notes</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-installation-booting" class="title" style="clear: both">Booting from the install medium   </h2>  </div> </div></div><p>To begin the installation, you have to boot your computer from the install drive.</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Plug in the install drive. Then turn on or restart your computer.</p></li><li class="listitem"><p>Open the boot menu by pressing the appropriate key, which is usually shown
on the display on early boot.
Select the USB flash drive (the option usually contains the word “USB”).
If you choose the incorrect drive, your computer will likely continue to
boot as normal. In that case restart your computer and pick a
different drive.</p><div class="note"><h3 class="title">Note</h3><p>The key to open the boot menu is different across computer brands and even
models. It can be <span class="keycap"><strong>F12</strong></span>, but also <span class="keycap"><strong>F1</strong></span>,
<span class="keycap"><strong>F9</strong></span>, <span class="keycap"><strong>F10</strong></span>, <span class="keycap"><strong>Enter</strong></span>, <span class="keycap"><strong>Del</strong></span>,
<span class="keycap"><strong>Esc</strong></span> or another function key. If you are unsure and don’t see
it on the early boot screen, you can search online for your computers
brand, model followed by “boot from usb”.
The computer might not even have that feature, so you have to go into the
BIOS/UEFI settings to change the boot order. Again, search online for
details about your specific computer model.</p><p>For Apple computers with Intel processors press and hold the <span class="keycap"><strong>⌥</strong></span>
(Option or Alt) key until you see the boot menu. On Apple silicon press
and hold the power button.</p></div><div class="note"><h3 class="title">Note</h3><p>If your computer supports both BIOS and UEFI boot, choose the UEFI option.
You will likely need to disable “Secure Boot” to use the UEFI option. The exact steps vary by device manufacturer but generally “Secure Boot” will be listed under “Boot”, “Security” or “Advanced” in the BIOS/UEFI menu.</p></div><div class="note"><h3 class="title">Note</h3><p>If you use a CD for the installation, the computer will probably boot from
it automatically. If not, choose the option containing the word “CD” from
the boot menu.</p></div></li><li class="listitem"><p>Shortly after selecting the appropriate boot drive, you should be
presented with a menu with different installer options. Leave the default
and wait (or press <span class="keycap"><strong>Enter</strong></span> to speed up).</p></li><li class="listitem"><p>The graphical images will start their corresponding desktop environment
and the graphical installer, which can take some time. The minimal images
will boot to a command line. You have to follow the instructions in
<a class="xref" href="index.html#sec-installation-manual" title="Manual Installation" >the section called “Manual Installation”</a> there.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-installation-graphical" class="title" style="clear: both">Graphical Installation   </h2>  </div> </div></div><p>The graphical installer is recommended for desktop users and will guide you
through the installation.</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>In the “Welcome” screen, you can select the language of the Installer and
the installed system.</p><div class="tip"><h3 class="title">Tip</h3><p>Leaving the language as “American English” will make it easier to search for
error messages in a search engine or to report an issue.</p></div></li><li class="listitem"><p>Next you should choose your location to have the timezone set correctly.
You can actually click on the map!</p><div class="note"><h3 class="title">Note</h3><p>The installer will use an online service to guess your location based on
your public IP address.</p></div></li><li class="listitem"><p>Then you can select the keyboard layout. The default keyboard model should
work well with most desktop keyboards. If you have a special keyboard or
notebook, your model might be in the list. Select the language you are most
comfortable typing in.</p></li><li class="listitem"><p>On the “Users” screen, you have to type in your display name, login name
and password. You can also enable an option to automatically login to the
desktop.</p></li><li class="listitem"><p>Then you have the option to choose a desktop environment. If you want to
create a custom setup with a window manager, you can select “No desktop”.</p><div class="tip"><h3 class="title">Tip</h3><p>If you don’t have a favorite desktop and don’t know which one to choose,
you can stick to either GNOME or Plasma. They have a quite different
design, so you should choose whichever you like better.
They are both popular choices and well tested on NixOS.</p></div></li><li class="listitem"><p>You have the option to allow unfree software in the next screen.</p></li><li class="listitem"><p>The easiest option in the “Partitioning” screen is “Erase disk”, which will
delete all data from the selected disk and install the system on it.
Also select “Swap (with Hibernation)” in the dropdown below it.
You have the option to encrypt the whole disk with LUKS.</p><div class="note"><h3 class="title">Note</h3><p>At the top left you see if the Installer was booted with BIOS or UEFI. If
you know your system supports UEFI and it shows “BIOS”, reboot with the
correct option.</p></div><div class="warning"><h3 class="title">Warning</h3><p>Make sure you have selected the correct disk at the top and that no
valuable data is still on the disk! It will be deleted when
formatting the disk.</p></div></li><li class="listitem"><p>Check the choices you made in the “Summary” and click “Install”.</p><div class="note"><h3 class="title">Note</h3><p>The installation takes about 15 minutes. The time varies based on the
selected desktop environment, internet connection speed and disk write speed.</p></div></li><li class="listitem"><p>When the install is complete, remove the USB flash drive and
reboot into your new system!</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-installation-manual" class="title" style="clear: both">Manual Installation   </h2>  </div> </div></div><p>NixOS can be installed on BIOS or UEFI systems. The procedure for a UEFI
installation is broadly the same as for a BIOS installation. The differences
are mentioned in the following steps.</p><p>The NixOS manual is available by running <code class="literal">nixos-help</code> in the command line
or from the application menu in the desktop environment.</p><p>To have access to the command line on the graphical images, open
Terminal (GNOME) or Konsole (Plasma) from the application menu.</p><p>You are logged-in automatically as <code class="literal">nixos</code>. The <code class="literal">nixos</code> user account has
an empty password so you can use <code class="literal">sudo</code> without a password:</p><pre><code class="programlisting ShellSession">$ sudo -i
</code></pre><p>You can use <code class="literal">loadkeys</code> to switch to your preferred keyboard layout.
(We even provide neo2 via <code class="literal">loadkeys de neo</code>!)</p><p>If the text is too small to be legible, try <code class="literal">setfont ter-v32n</code> to
increase the font size.</p><p>To install over a serial port connect with <code class="literal">115200n8</code> (e.g.
<code class="literal">picocom -b 115200 /dev/ttyUSB0</code>). When the bootloader lists boot
entries, select the serial console boot entry.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installation-manual-networking" class="title" >Networking in the installer   </h3>  </div> </div></div><p><span id="sec-installation-booting-networking"></span> </p><p>The boot process should have brought up networking (check <code class="literal">ip a</code>). Networking is necessary for the installer, since it will
download lots of stuff (such as source tarballs or Nixpkgs channel
binaries). It’s best if you have a DHCP server on your network.
Otherwise configure networking manually using <code class="literal">ifconfig</code>.</p><p>On the graphical installer, you can configure the network, wifi
included, through NetworkManager. Using the <code class="literal">nmtui</code> program, you can do
so even in a non-graphical session. If you prefer to configure the
network manually, disable NetworkManager with
<code class="literal">systemctl stop NetworkManager</code>.</p><p>On the minimal installer, NetworkManager is not available, so
configuration must be performed manually. To configure the wifi, first
start wpa_supplicant with <code class="literal">sudo systemctl start wpa_supplicant</code>, then
run <code class="literal">wpa_cli</code>. For most home networks, you need to type in the following
commands:</p><pre><code class="programlisting plain">&gt; add_network
0
&gt; set_network 0 ssid &quot;myhomenetwork&quot;
OK
&gt; set_network 0 psk &quot;mypassword&quot;
OK
&gt; enable_network 0
OK
</code></pre><p>For enterprise networks, for example <span class="emphasis"><em>eduroam</em></span>, instead do:</p><pre><code class="programlisting plain">&gt; add_network
0
&gt; set_network 0 ssid &quot;eduroam&quot;
OK
&gt; set_network 0 identity &quot;myname@example.com&quot;
OK
&gt; set_network 0 password &quot;mypassword&quot;
OK
&gt; enable_network 0
OK
</code></pre><p>When successfully connected, you should see a line such as this one</p><pre><code class="programlisting plain">&lt;3&gt;CTRL-EVENT-CONNECTED - Connection to 32:85:ab:ef:24:5c completed [id=0 id_str=]
</code></pre><p>you can now leave <code class="literal">wpa_cli</code> by typing <code class="literal">quit</code>.</p><p>If you would like to continue the installation from a different machine
you can use activated SSH daemon. You need to copy your ssh key to
either <code class="literal">/home/nixos/.ssh/authorized_keys</code> or
<code class="literal">/root/.ssh/authorized_keys</code> (Tip: For installers with a modifiable
filesystem such as the sd-card installer image a key can be manually
placed by mounting the image on a different machine). Alternatively you
must set a password for either <code class="literal">root</code> or <code class="literal">nixos</code> with <code class="literal">passwd</code> to be
able to login.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installation-manual-partitioning" class="title" >Partitioning and formatting   </h3>  </div> </div></div><p><span id="sec-installation-partitioning"></span> </p><p>The NixOS installer doesn’t do any partitioning or formatting, so you
need to do that yourself.</p><p>The NixOS installer ships with multiple partitioning tools. The examples
below use <code class="literal">parted</code>, but also provides <code class="literal">fdisk</code>, <code class="literal">gdisk</code>, <code class="literal">cfdisk</code>, and
<code class="literal">cgdisk</code>.</p><p>Use the command ‘lsblk’ to find the name of your ‘disk’ device.</p><p>The recommended partition scheme differs depending if the computer uses
<span class="emphasis"><em>Legacy Boot</em></span> or <span class="emphasis"><em>UEFI</em></span>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-installation-manual-partitioning-UEFI" class="title" >UEFI (GPT)   </h4>  </div> </div></div><p><span id="sec-installation-partitioning-UEFI"></span> </p><p>Here’s an example partition scheme for UEFI, using <code class="literal">/dev/sda</code> as the
device.</p><div class="note"><h3 class="title">Note</h3><p>You can safely ignore <code class="literal">parted</code>’s informational message about needing to
update /etc/fstab.</p></div><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Create a <span class="emphasis"><em>GPT</em></span> partition table.</p><pre><code class="programlisting ShellSession"># parted /dev/sda -- mklabel gpt
</code></pre></li><li class="listitem"><p>Add the <span class="emphasis"><em>root</em></span> partition. This will fill the disk except for the end
part, where the swap will live, and the space left in front (512MiB)
which will be used by the boot partition.</p><pre><code class="programlisting ShellSession"># parted /dev/sda -- mkpart root ext4 512MB -8GB
</code></pre></li><li class="listitem"><p>Next, add a <span class="emphasis"><em>swap</em></span> partition. The size required will vary according
to needs, here a 8GB one is created.</p><pre><code class="programlisting ShellSession"># parted /dev/sda -- mkpart swap linux-swap -8GB 100%
</code></pre><div class="note"><h3 class="title">Note</h3><p>The swap partition size rules are no different than for other Linux
distributions.</p></div></li><li class="listitem"><p>Finally, the <span class="emphasis"><em>boot</em></span> partition. NixOS by default uses the ESP (EFI
system partition) as its <span class="emphasis"><em>/boot</em></span> partition. It uses the initially
reserved 512MiB at the start of the disk.</p><pre><code class="programlisting ShellSession"># parted /dev/sda -- mkpart ESP fat32 1MB 512MB
# parted /dev/sda -- set 3 esp on
</code></pre><div class="note"><h3 class="title">Note</h3><p>In case you decided to not create a swap partition, replace <code class="literal">3</code> by <code class="literal">2</code>. To be sure of the id number of ESP, run <code class="literal">parted --list</code>.</p></div></li></ol></div><p>Once complete, you can follow with
<a class="xref" href="index.html#sec-installation-manual-partitioning-formatting" title="Formatting" >the section called “Formatting”</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-installation-manual-partitioning-MBR" class="title" >Legacy Boot (MBR)   </h4>  </div> </div></div><p><span id="sec-installation-partitioning-MBR"></span> </p><p>Here’s an example partition scheme for Legacy Boot, using <code class="literal">/dev/sda</code> as
the device.</p><div class="note"><h3 class="title">Note</h3><p>You can safely ignore <code class="literal">parted</code>’s informational message about needing to
update /etc/fstab.</p></div><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Create a <span class="emphasis"><em>MBR</em></span> partition table.</p><pre><code class="programlisting ShellSession"># parted /dev/sda -- mklabel msdos
</code></pre></li><li class="listitem"><p>Add the <span class="emphasis"><em>root</em></span> partition. This will fill the the disk except for the
end part, where the swap will live.</p><pre><code class="programlisting ShellSession"># parted /dev/sda -- mkpart primary 1MB -8GB
</code></pre></li><li class="listitem"><p>Set the root partition’s boot flag to on. This allows the disk to be booted from.</p><pre><code class="programlisting ShellSession"># parted /dev/sda -- set 1 boot on
</code></pre></li><li class="listitem"><p>Finally, add a <span class="emphasis"><em>swap</em></span> partition. The size required will vary
according to needs, here a 8GB one is created.</p><pre><code class="programlisting ShellSession"># parted /dev/sda -- mkpart primary linux-swap -8GB 100%
</code></pre><div class="note"><h3 class="title">Note</h3><p>The swap partition size rules are no different than for other Linux
distributions.</p></div></li></ol></div><p>Once complete, you can follow with
<a class="xref" href="index.html#sec-installation-manual-partitioning-formatting" title="Formatting" >the section called “Formatting”</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-installation-manual-partitioning-formatting" class="title" >Formatting   </h4>  </div> </div></div><p><span id="sec-installation-partitioning-formatting"></span> </p><p>Use the following commands:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>For initialising Ext4 partitions: <code class="literal">mkfs.ext4</code>. It is recommended
that you assign a unique symbolic label to the file system using the
option <code class="literal">-L label</code>, since this makes the file system configuration
independent from device changes. For example:</p><pre><code class="programlisting ShellSession"># mkfs.ext4 -L nixos /dev/sda1
</code></pre></li><li class="listitem"><p>For creating swap partitions: <code class="literal">mkswap</code>. Again it’s recommended to
assign a label to the swap partition: <code class="literal">-L label</code>. For example:</p><pre><code class="programlisting ShellSession"># mkswap -L swap /dev/sda2
</code></pre></li><li class="listitem"><p><span class="strong"><strong>UEFI systems</strong></span></p><p>For creating boot partitions: <code class="literal">mkfs.fat</code>. Again it’s recommended
to assign a label to the boot partition: <code class="literal">-n label</code>. For
example:</p><pre><code class="programlisting ShellSession"># mkfs.fat -F 32 -n boot /dev/sda3
</code></pre></li><li class="listitem"><p>For creating LVM volumes, the LVM commands, e.g., <code class="literal">pvcreate</code>,
<code class="literal">vgcreate</code>, and <code class="literal">lvcreate</code>.</p></li><li class="listitem"><p>For creating software RAID devices, use <code class="literal">mdadm</code>.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installation-manual-installing" class="title" >Installing   </h3>  </div> </div></div><p><span id="sec-installation-installing"></span> </p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Mount the target file system on which NixOS should be installed on
<code class="literal">/mnt</code>, e.g.</p><pre><code class="programlisting ShellSession"># mount /dev/disk/by-label/nixos /mnt
</code></pre></li><li class="listitem"><p><span class="strong"><strong>UEFI systems</strong></span></p><p>Mount the boot file system on <code class="literal">/mnt/boot</code>, e.g.</p><pre><code class="programlisting ShellSession"># mkdir -p /mnt/boot
# mount -o umask=077 /dev/disk/by-label/boot /mnt/boot
</code></pre></li><li class="listitem"><p>If your machine has a limited amount of memory, you may want to
activate swap devices now (<code class="literal">swapon device</code>).
The installer (or rather, the build actions that it
may spawn) may need quite a bit of RAM, depending on your
configuration.</p><pre><code class="programlisting ShellSession"># swapon /dev/sda2
</code></pre></li><li class="listitem"><p>You now need to create a file <code class="literal">/mnt/etc/nixos/configuration.nix</code>
that specifies the intended configuration of the system. This is
because NixOS has a <span class="emphasis"><em>declarative</em></span> configuration model: you create or
edit a description of the desired configuration of your system, and
then NixOS takes care of making it happen. The syntax of the NixOS
configuration file is described in <a class="xref" href="index.html#sec-configuration-syntax" title="Configuration Syntax" ><em>Configuration Syntax</em></a>,
while a list of available configuration options appears in
<a class="xref" href="options.html" title="Appendix A. Configuration Options" >Appendix&nbsp;A</a>. A minimal example is shown in
<a class="link" href="index.html#ex-config" title="Example 4. Example: NixOS Configuration" >Example: NixOS Configuration</a>.</p><p>This command accepts an optional <code class="literal">--flake</code> option, to also generate a
<code class="literal">flake.nix</code> file, if you want to set up a flake-based configuration.</p><p>The command <code class="literal">nixos-generate-config</code> can generate an initial
configuration file for you:</p><pre><code class="programlisting ShellSession"># nixos-generate-config --root /mnt
</code></pre><p>You should then edit <code class="literal">/mnt/etc/nixos/configuration.nix</code> to suit your
needs:</p><pre><code class="programlisting ShellSession"># nano /mnt/etc/nixos/configuration.nix
</code></pre><p>If you’re using the graphical ISO image, other editors may be
available (such as <code class="literal">vim</code>). If you have network access, you can also
install other editors – for instance, you can install Emacs by
running <code class="literal">nix-env -f &#x27;&lt;nixpkgs&gt;&#x27; -iA emacs</code>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">BIOS systems</span></dt><dd><p>You <span class="emphasis"><em>must</em></span> set the option <a class="xref" href="options.html#opt-boot.loader.grub.device"  ><code class="option">boot.loader.grub.device</code></a> to
specify on which disk the GRUB boot loader is to be installed.
Without it, NixOS cannot boot.</p><p>If there are other operating systems running on the machine before
installing NixOS, the <a class="xref" href="options.html#opt-boot.loader.grub.useOSProber"  ><code class="option">boot.loader.grub.useOSProber</code></a>
option can be set to <code class="literal">true</code> to automatically add them to the grub
menu.</p></dd><dt><span class="term">UEFI systems</span></dt><dd><p>You must select a boot-loader, either systemd-boot or GRUB. The recommended
option is systemd-boot: set the option <a class="xref" href="options.html#opt-boot.loader.systemd-boot.enable"  ><code class="option">boot.loader.systemd-boot.enable</code></a>
to <code class="literal">true</code>. <code class="literal">nixos-generate-config</code> should do this automatically
for new configurations when booted in UEFI mode.</p><p>You may want to look at the options starting with
<a class="link" href="options.html#opt-boot.loader.efi.canTouchEfiVariables"  ><code class="literal">boot.loader.efi</code></a> and
<a class="link" href="options.html#opt-boot.loader.systemd-boot.enable"  ><code class="literal">boot.loader.systemd-boot</code></a>
as well.</p><p>If you want to use GRUB, set <a class="xref" href="options.html#opt-boot.loader.grub.device"  ><code class="option">boot.loader.grub.device</code></a> to <code class="literal">nodev</code> and
<a class="xref" href="options.html#opt-boot.loader.grub.efiSupport"  ><code class="option">boot.loader.grub.efiSupport</code></a> to <code class="literal">true</code>.</p><p>With systemd-boot, you should not need any special configuration to detect
other installed systems. With GRUB, set <a class="xref" href="options.html#opt-boot.loader.grub.useOSProber"  ><code class="option">boot.loader.grub.useOSProber</code></a>
to <code class="literal">true</code>, but this will only detect windows partitions, not other Linux
distributions. If you dual boot another Linux distribution, use systemd-boot
instead.</p></dd></dl></div><p>If you need to configure networking for your machine the
configuration options are described in <a class="xref" href="index.html#sec-networking" title="Networking" ><em>Networking</em></a>. In
particular, while wifi is supported on the installation image, it is
not enabled by default in the configuration generated by
<code class="literal">nixos-generate-config</code>.</p><p>Another critical option is <code class="literal">fileSystems</code>, specifying the file
systems that need to be mounted by NixOS. However, you typically
don’t need to set it yourself, because <code class="literal">nixos-generate-config</code> sets
it automatically in <code class="literal">/mnt/etc/nixos/hardware-configuration.nix</code> from
your currently mounted file systems. (The configuration file
<code class="literal">hardware-configuration.nix</code> is included from <code class="literal">configuration.nix</code>
and will be overwritten by future invocations of
<code class="literal">nixos-generate-config</code>; thus, you generally should not modify it.)
Additionally, you may want to look at <a class="link" href="https://github.com/NixOS/nixos-hardware"  target="_top">Hardware configuration for
known-hardware</a> at this
point or after installation.</p><div class="note"><h3 class="title">Note</h3><p>Depending on your hardware configuration or type of file system, you
may need to set the option <code class="literal">boot.initrd.kernelModules</code> to include
the kernel modules that are necessary for mounting the root file
system, otherwise the installed system will not be able to boot. (If
this happens, boot from the installation media again, mount the
target file system on <code class="literal">/mnt</code>, fix <code class="literal">/mnt/etc/nixos/configuration.nix</code>
and rerun <code class="literal">nixos-install</code>.) In most cases, <code class="literal">nixos-generate-config</code>
will figure out the required modules.</p></div></li><li class="listitem"><p>Do the installation:</p><pre><code class="programlisting ShellSession"># nixos-install
</code></pre><p>This will install your system based on the configuration you
provided. If anything fails due to a configuration problem or any
other issue (such as a network outage while downloading binaries
from the NixOS binary cache), you can re-run <code class="literal">nixos-install</code> after
fixing your <code class="literal">configuration.nix</code>.</p><p>If you opted for a flake-based configuration, you will need to pass the
<code class="literal">--flake</code> here as well and specify the name of the configuration as used in
the <code class="literal">flake.nix</code> file. For the default generated flake, this is <code class="literal">nixos</code>.</p><pre><code class="programlisting ShellSession"># nixos-install --flake &#x27;path/to/flake.nix#nixos&#x27;
</code></pre><p>As the last step, <code class="literal">nixos-install</code> will ask you to set the password
for the <code class="literal">root</code> user, e.g.</p><pre><code class="programlisting plain">setting root password...
New password: ***
Retype new password: ***
</code></pre><p>If you have a user account declared in your <code class="literal">configuration.nix</code> and plan to log in using this user, set a password before rebooting, e.g. for the <code class="literal">alice</code> user:</p><pre><code class="programlisting ShellSession"># nixos-enter --root /mnt -c &#x27;passwd alice&#x27;
</code></pre><div class="note"><h3 class="title">Note</h3><p>For unattended installations, it is possible to use
<code class="literal">nixos-install --no-root-passwd</code> in order to disable the password
prompt entirely.</p></div></li><li class="listitem"><p>If everything went well:</p><pre><code class="programlisting ShellSession"># reboot
</code></pre></li><li class="listitem"><p>You should now be able to boot into the installed NixOS. The GRUB
boot menu shows a list of <span class="emphasis"><em>available configurations</em></span> (initially just
one). Every time you change the NixOS configuration (see <a class="link" href="index.html#sec-changing-config" title="Changing the Configuration" >Changing
Configuration</a>), a new item is added to the
menu. This allows you to easily roll back to a previous
configuration if something goes wrong.</p><p>Use your declared user account to log in.
If you didn’t declare one, you should still be able to log in using the <code class="literal">root</code> user.</p><div class="note"><h3 class="title">Note</h3><p>Some graphical display managers such as SDDM do not allow <code class="literal">root</code> login by default, so you might need to switch to TTY.
Refer to <a class="xref" href="index.html#sec-user-management" title="User Management" ><em>User Management</em></a> for details on declaring user accounts.</p></div><p>You may also want to install some software. This will be covered in
<a class="xref" href="index.html#sec-package-management" title="Package Management" ><em>Package Management</em></a>.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installation-manual-summary" class="title" >Installation summary   </h3>  </div> </div></div><p><span id="sec-installation-summary"></span> </p><p>To summarise, <a class="link" href="index.html#ex-install-sequence" title="Example 3. Commands for Installing NixOS on /dev/sda" >Example: Commands for Installing NixOS on <code class="literal">/dev/sda</code></a>
shows a typical sequence of commands for installing NixOS on an empty hard
drive (here <code class="literal">/dev/sda</code>). <a class="link" href="index.html#ex-config" title="Example 4. Example: NixOS Configuration" >Example: NixOS Configuration</a> shows a
corresponding configuration Nix expression.</p><div class="example"><span id="ex-partition-scheme-MBR" ></span><details><summary><span class="title"><strong>Example 1. Example partition schemes for NixOS on <code class="literal">/dev/sda</code> (MBR)</strong></span></summary><div class="example-contents"><pre><code class="programlisting ShellSession"># parted /dev/sda -- mklabel msdos
# parted /dev/sda -- mkpart primary 1MB -8GB
# parted /dev/sda -- mkpart primary linux-swap -8GB 100%
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-partition-scheme-UEFI" ></span><details><summary><span class="title"><strong>Example 2. Example partition schemes for NixOS on <code class="literal">/dev/sda</code> (UEFI)</strong></span></summary><div class="example-contents"><pre><code class="programlisting ShellSession"># parted /dev/sda -- mklabel gpt
# parted /dev/sda -- mkpart root ext4 512MB -8GB
# parted /dev/sda -- mkpart swap linux-swap -8GB 100%
# parted /dev/sda -- mkpart ESP fat32 1MB 512MB
# parted /dev/sda -- set 3 esp on
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-install-sequence" ></span><details><summary><span class="title"><strong>Example 3. Commands for Installing NixOS on <code class="literal">/dev/sda</code></strong></span></summary><div class="example-contents"><p>With a partitioned disk.</p><pre><code class="programlisting ShellSession"># mkfs.ext4 -L nixos /dev/sda1
# mkswap -L swap /dev/sda2
# swapon /dev/sda2
# mkfs.fat -F 32 -n boot /dev/sda3        # (for UEFI systems only)
# mount /dev/disk/by-label/nixos /mnt
# mkdir -p /mnt/boot                      # (for UEFI systems only)
# mount -o umask=077 /dev/disk/by-label/boot /mnt/boot # (for UEFI systems only)
# nixos-generate-config --root /mnt
# nano /mnt/etc/nixos/configuration.nix
# nixos-install
# reboot
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-config" ></span><details><summary><span class="title"><strong>Example 4. Example: NixOS Configuration</strong></span></summary><div class="example-contents"><pre><code class="programlisting ShellSession">{ config, pkgs, ... }: {
  imports = [
    # Include the results of the hardware scan.
    ./hardware-configuration.nix
  ];

  boot.loader.grub.device = &quot;/dev/sda&quot;;   # (for BIOS systems only)
  boot.loader.systemd-boot.enable = true; # (for UEFI systems only)

  # Note: setting fileSystems is generally not
  # necessary, since nixos-generate-config figures them out
  # automatically in hardware-configuration.nix.
  #fileSystems.&quot;/&quot;.device = &quot;/dev/disk/by-label/nixos&quot;;

  # Enable the OpenSSH server.
  services.sshd.enable = true;
}
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-installation-additional-notes" class="title" style="clear: both">Additional installation notes   </h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-booting-from-usb" class="title" >Booting from a USB flash drive   </h3>  </div> </div></div><p>The image has to be written verbatim to the USB flash drive for it to be
bootable on UEFI and BIOS systems. Here are the recommended tools to do that.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-booting-from-usb-graphical" class="title" >Creating bootable USB flash drive with a graphical tool   </h4>  </div> </div></div><p>Etcher is a popular and user-friendly tool. It works on Linux, Windows and macOS.</p><p>Download it from <a class="link" href="https://www.balena.io/etcher/"  target="_top">balena.io</a>, start the program,
select the downloaded NixOS ISO, then select the USB flash drive and flash it.</p><div class="warning"><h3 class="title">Warning</h3><p>Etcher reports errors and usage statistics by default, which can be disabled in
the settings.</p></div><p>An alternative is <a class="link" href="https://bztsrc.gitlab.io/usbimager"  target="_top">USBImager</a>,
which is very simple and does not connect to the internet. Download the version
with write-only (wo) interface for your system. Start the program,
select the image, select the USB flash drive and click “Write”.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-booting-from-usb-linux" class="title" >Creating bootable USB flash drive from a Terminal on Linux   </h4>  </div> </div></div><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Plug in the USB flash drive.</p></li><li class="listitem"><p>Find the corresponding device with <code class="literal">lsblk</code>. You can distinguish them by
their size.</p></li><li class="listitem"><p>Make sure all partitions on the device are properly unmounted. Replace <code class="literal">sdX</code>
with your device (e.g. <code class="literal">sdb</code>).</p></li></ol></div><pre><code class="programlisting ShellSession">sudo umount /dev/sdX*
</code></pre><div class="orderedlist"><ol class="orderedlist compact" start="4" type="1"><li class="listitem"><p>Then use the <code class="literal">dd</code> utility to write the image to the USB flash drive.</p></li></ol></div><pre><code class="programlisting ShellSession">sudo dd bs=4M conv=fsync oflag=direct status=progress if=&lt;path-to-image&gt; of=/dev/sdX
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-booting-from-usb-macos" class="title" >Creating bootable USB flash drive from a Terminal on macOS   </h4>  </div> </div></div><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Plug in the USB flash drive.</p></li><li class="listitem"><p>Find the corresponding device with <code class="literal">diskutil list</code>. You can distinguish them
by their size.</p></li><li class="listitem"><p>Make sure all partitions on the device are properly unmounted. Replace <code class="literal">diskX</code>
with your device (e.g. <code class="literal">disk1</code>).</p></li></ol></div><pre><code class="programlisting ShellSession">diskutil unmountDisk diskX
</code></pre><div class="orderedlist"><ol class="orderedlist compact" start="4" type="1"><li class="listitem"><p>Then use the <code class="literal">dd</code> utility to write the image to the USB flash drive.</p></li></ol></div><pre><code class="programlisting ShellSession">sudo dd if=&lt;path-to-image&gt; of=/dev/rdiskX bs=4m
</code></pre><p>After <code class="literal">dd</code> completes, a GUI dialog “The disk
you inserted was not readable by this computer” will pop up, which can
be ignored.</p><div class="note"><h3 class="title">Note</h3><p>Using the ‘raw’ <code class="literal">rdiskX</code> device instead of <code class="literal">diskX</code> with dd completes in
minutes instead of hours.</p></div><div class="orderedlist"><ol class="orderedlist compact" start="5" type="1"><li class="listitem"><p>Eject the disk when it is finished.</p></li></ol></div><pre><code class="programlisting ShellSession">diskutil eject /dev/diskX
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-booting-from-pxe" class="title" >Booting from the “netboot” media (PXE)   </h3>  </div> </div></div><p>Advanced users may wish to install NixOS using an existing PXE or iPXE
setup.</p><p>These instructions assume that you have an existing PXE or iPXE
infrastructure and want to add the NixOS installer as another
option. To build the necessary files from your current version of nixpkgs,
you can run:</p><pre><code class="programlisting ShellSession">nix-build -A netboot.x86_64-linux &#x27;&lt;nixpkgs/nixos/release.nix&gt;&#x27;
</code></pre><p>This will create a <code class="literal">result</code> directory containing: * <code class="literal">bzImage</code> – the
Linux kernel * <code class="literal">initrd</code> – the initrd file * <code class="literal">netboot.ipxe</code> – an
example ipxe script demonstrating the appropriate kernel command line
arguments for this image</p><p>If you’re using plain PXE, configure your boot loader to use the
<code class="literal">bzImage</code> and <code class="literal">initrd</code> files and have it provide the same kernel command
line arguments found in <code class="literal">netboot.ipxe</code>.</p><p>If you’re using iPXE, depending on how your HTTP/FTP/etc. server is
configured you may be able to use <code class="literal">netboot.ipxe</code> unmodified, or you may
need to update the paths to the files to match your server’s directory
layout.</p><p>In the future we may begin making these files available as build
products from hydra at which point we will update this documentation
with instructions on how to obtain them either for placing on a
dedicated TFTP server or to boot them directly over the internet.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-booting-via-kexec" class="title" >“Booting” into NixOS via kexec   </h3>  </div> </div></div><p>In some cases, your system might already be booted into/preinstalled with
another Linux distribution, and booting NixOS by attaching an installation
image is quite a manual process.</p><p>This is particularly useful for (cloud) providers where you can’t boot a custom
image, but get some Debian or Ubuntu installation.</p><p>In these cases, it might be easier to use <code class="literal">kexec</code> to “jump into NixOS” from the
running system, which only assumes <code class="literal">bash</code> and <code class="literal">kexec</code> to be installed on the
machine.</p><p>Note that kexec may not work correctly on some hardware, as devices are not
fully re-initialized in the process. In practice, this however is rarely the
case.</p><p>To build the necessary files from your current version of nixpkgs,
you can run:</p><pre><code class="programlisting ShellSession">nix-build -A kexec.x86_64-linux &#x27;&lt;nixpkgs/nixos/release.nix&gt;&#x27;
</code></pre><p>This will create a <code class="literal">result</code> directory containing the following:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">bzImage</code> (the Linux kernel)</p></li><li class="listitem"><p><code class="literal">initrd</code> (the initrd file)</p></li><li class="listitem"><p><code class="literal">kexec-boot</code> (a shellscript invoking <code class="literal">kexec</code>)</p></li></ul></div><p>These three files are meant to be copied over to the other already running
Linux Distribution.</p><p>Note its symlinks pointing elsewhere, so <code class="literal">cd</code> in, and use
<code class="literal">scp * root@$destination</code> to copy it over, rather than rsync.</p><p>Once you finished copying, execute <code class="literal">kexec-boot</code> <span class="emphasis"><em>on the destination</em></span>, and after
some seconds, the machine should be booting into an (ephemeral) NixOS
installation medium.</p><p>In case you want to describe your own system closure to kexec into, instead of
the default installer image, you can build your own <code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix">{ modulesPath, ... }: {
  imports = [
    (modulesPath + &quot;/installer/netboot/netboot-minimal.nix&quot;)
  ];

  services.openssh.enable = true;
  users.users.root.openssh.authorizedKeys.keys = [
    &quot;my-ssh-pubkey&quot;
  ];
}
</code></pre><pre><code class="programlisting ShellSession">nix-build &#x27;&lt;nixpkgs/nixos&gt;&#x27; \
  --arg configuration ./configuration.nix
  --attr config.system.build.kexecTree
</code></pre><p>Make sure your <code class="literal">configuration.nix</code> does still import <code class="literal">netboot-minimal.nix</code> (or
<code class="literal">netboot-base.nix</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installing-virtualbox-guest" class="title" >Installing in a VirtualBox guest   </h3>  </div> </div></div><p>Installing NixOS into a VirtualBox guest is convenient for users who
want to try NixOS without installing it on bare metal. If you want to set
up a VirtualBox guest, follow these instructions:</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Add a New Machine in VirtualBox with OS Type “Linux / Other Linux”</p></li><li class="listitem"><p>Base Memory Size: 768 MB or higher.</p></li><li class="listitem"><p>New Hard Disk of 10 GB or higher.</p></li><li class="listitem"><p>Mount the CD-ROM with the NixOS ISO (by clicking on CD/DVD-ROM)</p></li><li class="listitem"><p>Click on Settings / System / Processor and enable PAE/NX</p></li><li class="listitem"><p>Click on Settings / System / Acceleration and enable “VT-x/AMD-V”
acceleration</p></li><li class="listitem"><p>Click on Settings / Display / Screen and select VMSVGA as Graphics
Controller</p></li><li class="listitem"><p>Save the settings, start the virtual machine, and continue
installation like normal</p></li></ol></div><p>There are a few modifications you should make in configuration.nix.
Enable booting:</p><pre><code class="programlisting nix">{
  boot.loader.grub.device = &quot;/dev/sda&quot;;
}
</code></pre><p>Also remove the fsck that runs at startup. It will always fail to run,
stopping your boot until you press <code class="literal">*</code>.</p><pre><code class="programlisting nix">{
  boot.initrd.checkJournalingFS = false;
}
</code></pre><p>Shared folders can be given a name and a path in the host system in the
VirtualBox settings (Machine / Settings / Shared Folders, then click on
the “Add” icon). Add the following to the
<code class="literal">/etc/nixos/configuration.nix</code> to auto-mount them. If you do not add
<code class="literal">&quot;nofail&quot;</code>, the system will not boot properly.</p><pre><code class="programlisting nix">{ config, pkgs, ...} :
{
  fileSystems.&quot;/virtualboxshare&quot; = {
    fsType = &quot;vboxsf&quot;;
    device = &quot;nameofthesharedfolder&quot;;
    options = [ &quot;rw&quot; &quot;nofail&quot; ];
  };
}
</code></pre><p>The folder will be available directly under the root directory.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installing-from-other-distro" class="title" >Installing from another Linux distribution   </h3>  </div> </div></div><p>Because Nix (the package manager) &amp; Nixpkgs (the Nix packages
collection) can both be installed on any (most?) Linux distributions,
they can be used to install NixOS in various creative ways. You can, for
instance:</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Install NixOS on another partition, from your existing Linux
distribution (without the use of a USB or optical device!)</p></li><li class="listitem"><p>Install NixOS on the same partition (in place!), from your existing
non-NixOS Linux distribution using <code class="literal">NIXOS_LUSTRATE</code>.</p></li><li class="listitem"><p>Install NixOS on your hard drive from the Live CD of any Linux
distribution.</p></li></ol></div><p>The first steps to all these are the same:</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Install the Nix package manager:</p><p>Short version:</p><pre><code class="programlisting ShellSession">$ curl -L https://nixos.org/nix/install | sh
$ . $HOME/.nix-profile/etc/profile.d/nix.sh # …or open a fresh shell
</code></pre><p>More details in the <a class="link" href="https://nixos.org/nix/manual/#chap-quick-start"  target="_top"> Nix
manual</a></p></li><li class="listitem"><p>Switch to the NixOS channel:</p><p>If you’ve just installed Nix on a non-NixOS distribution, you will
be on the <code class="literal">nixpkgs</code> channel by default.</p><pre><code class="programlisting ShellSession">$ nix-channel --list
nixpkgs https://nixos.org/channels/nixpkgs-unstable
</code></pre><p>As that channel gets released without running the NixOS tests, it
will be safer to use the <code class="literal">nixos-*</code> channels instead:</p><pre><code class="programlisting ShellSession">$ nix-channel --add https://nixos.org/channels/nixos-&lt;version&gt; nixpkgs
</code></pre><p>Where <code class="literal">&lt;version&gt;</code> corresponds to the latest version available on <a class="link" href="https://channels.nixos.org/"  target="_top">channels.nixos.org</a>.</p><p>You may want to throw in a <code class="literal">nix-channel --update</code> for good measure.</p></li><li class="listitem"><p>Install the NixOS installation tools:</p><p>You’ll need <code class="literal">nixos-generate-config</code> and <code class="literal">nixos-install</code>, but this
also makes some man pages and <code class="literal">nixos-enter</code> available, just in case
you want to chroot into your NixOS partition. NixOS installs these
by default, but you don’t have NixOS yet…</p><pre><code class="programlisting ShellSession">$ nix-env -f &#x27;&lt;nixpkgs&gt;&#x27; -iA nixos-install-tools
</code></pre></li><li class="listitem"><div class="note"><h3 class="title">Note</h3><p>The following 5 steps are only for installing NixOS to another
partition. For installing NixOS in place using <code class="literal">NIXOS_LUSTRATE</code>,
skip ahead.</p></div><p>Prepare your target partition:</p><p>At this point it is time to prepare your target partition. Please
refer to the partitioning, file-system creation, and mounting steps
of <a class="xref" href="index.html#sec-installation" title="Installing NixOS" ><em>Installing NixOS</em></a></p><p>If you’re about to install NixOS in place using <code class="literal">NIXOS_LUSTRATE</code>
there is nothing to do for this step.</p></li><li class="listitem"><p>Generate your NixOS configuration:</p><pre><code class="programlisting ShellSession">$ sudo `which nixos-generate-config` --root /mnt
</code></pre><p>You’ll probably want to edit the configuration files. Refer to the
<code class="literal">nixos-generate-config</code> step in <a class="xref" href="index.html#sec-installation" title="Installing NixOS" ><em>Installing NixOS</em></a> for more
information.</p><p>Consider setting up the NixOS bootloader to give you the ability to
boot on your existing Linux partition. For instance, if you’re
using GRUB and your existing distribution is running Ubuntu, you may
want to add something like this to your <code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  boot.loader.grub.extraEntries = &#x27;&#x27;
    menuentry &quot;Ubuntu&quot; {
      search --set=ubuntu --fs-uuid 3cc3e652-0c1f-4800-8451-033754f68e6e
      configfile &quot;($ubuntu)/boot/grub/grub.cfg&quot;
    }
  &#x27;&#x27;;
}
</code></pre><p>(You can find the appropriate UUID for your partition in
<code class="literal">/dev/disk/by-uuid</code>)</p></li><li class="listitem"><p>Create the <code class="literal">nixbld</code> group and user on your original distribution:</p><pre><code class="programlisting ShellSession">$ sudo groupadd -g 30000 nixbld
$ sudo useradd -u 30000 -g nixbld -G nixbld nixbld
</code></pre></li><li class="listitem"><p>Download/build/install NixOS:</p><div class="warning"><h3 class="title">Warning</h3><p>Once you complete this step, you might no longer be able to boot on
existing systems without the help of a rescue USB drive or similar.</p></div><div class="note"><h3 class="title">Note</h3><p>On some distributions there are separate PATHS for programs intended
only for root. In order for the installation to succeed, you might
have to use <code class="literal">PATH=&quot;$PATH:/usr/sbin:/sbin&quot;</code> in the following command.</p></div><pre><code class="programlisting ShellSession">$ sudo PATH=&quot;$PATH&quot; `which nixos-install` --root /mnt
</code></pre><p>Again, please refer to the <code class="literal">nixos-install</code> step in
<a class="xref" href="index.html#sec-installation" title="Installing NixOS" ><em>Installing NixOS</em></a> for more information.</p><p>That should be it for installation to another partition!</p></li><li class="listitem"><p>Optionally, you may want to clean up your non-NixOS distribution:</p><pre><code class="programlisting ShellSession">$ sudo userdel nixbld
$ sudo groupdel nixbld
</code></pre><p>If you do not wish to keep the Nix package manager installed either,
run something like <code class="literal">sudo rm -rv ~/.nix-* /nix</code> and remove the line
that the Nix installer added to your <code class="literal">~/.profile</code>.</p></li><li class="listitem"><div class="note"><h3 class="title">Note</h3><p>The following steps are only for installing NixOS in place using
<code class="literal">NIXOS_LUSTRATE</code>:</p></div><p>Generate your NixOS configuration:</p><pre><code class="programlisting ShellSession">$ sudo `which nixos-generate-config`
</code></pre><p>Note that this will place the generated configuration files in
<code class="literal">/etc/nixos</code>. You’ll probably want to edit the configuration files.
Refer to the <code class="literal">nixos-generate-config</code> step in
<a class="xref" href="index.html#sec-installation" title="Installing NixOS" ><em>Installing NixOS</em></a> for more information.</p><div class="note"><h3 class="title">Note</h3><p>On <a class="link" href="https://en.wikipedia.org/wiki/UEFI"  target="_top">UEFI</a> systems, check that your <code class="literal">/etc/nixos/hardware-configuration.nix</code> did the right thing with the <a class="link" href="https://en.wikipedia.org/wiki/EFI_system_partition"  target="_top">EFI System Partition</a>.
In NixOS, by default, both <a class="link" href="https://systemd.io/BOOT/"  target="_top">systemd-boot</a> and <a class="link" href="https://www.gnu.org/software/grub/index.html"  target="_top">grub</a> expect it to be mounted on <code class="literal">/boot</code>.
However, the configuration generator bases its <a class="xref" href="options.html#opt-fileSystems"  ><code class="option">fileSystems</code></a> configuration on the current mount points at the time it is run.
If the current system and NixOS’s bootloader configuration don’t agree on where the <a class="link" href="https://en.wikipedia.org/wiki/EFI_system_partition"  target="_top">EFI System Partition</a> is to be mounted, you’ll need to manually alter the mount point in <code class="literal">hardware-configuration.nix</code> before building the system closure.</p></div><div class="note"><h3 class="title">Note</h3><p>The lustrate process will not work if the <a class="xref" href="options.html#opt-boot.initrd.systemd.enable"  ><code class="option">boot.initrd.systemd.enable</code></a> option is set to <code class="literal">true</code>.
If you want to use this option, wait until after the first boot into the NixOS system to enable it and rebuild.</p></div><p>You’ll likely want to set a root password for your first boot using
the configuration files because you won’t have a chance to enter a
password until after you reboot. You can initialize the root password
to an empty one with this line: (and of course don’t forget to set
one once you’ve rebooted or to lock the account with
<code class="literal">sudo passwd -l root</code> if you use <code class="literal">sudo</code>)</p><pre><code class="programlisting nix">{
  users.users.root.initialHashedPassword = &quot;&quot;;
}
</code></pre></li><li class="listitem"><p>Build the NixOS closure and install it in the <code class="literal">system</code> profile:</p><pre><code class="programlisting ShellSession">$ nix-env -p /nix/var/nix/profiles/system -f &#x27;&lt;nixpkgs/nixos&gt;&#x27; -I nixos-config=/etc/nixos/configuration.nix -iA system
</code></pre></li><li class="listitem"><p>Change ownership of the <code class="literal">/nix</code> tree to root (since your Nix install
was probably single user):</p><pre><code class="programlisting ShellSession">$ sudo chown -R 0:0 /nix
</code></pre></li><li class="listitem"><p>Set up the <code class="literal">/etc/NIXOS</code> and <code class="literal">/etc/NIXOS_LUSTRATE</code> files:</p><p><code class="literal">/etc/NIXOS</code> officializes that this is now a NixOS partition (the
bootup scripts require its presence).</p><p><code class="literal">/etc/NIXOS_LUSTRATE</code> tells the NixOS bootup scripts to move
<span class="emphasis"><em>everything</em></span> that’s in the root partition to <code class="literal">/old-root</code>. This will
move your existing distribution out of the way in the very early
stages of the NixOS bootup. There are exceptions (we do need to keep
NixOS there after all), so the NixOS lustrate process will not
touch:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>The <code class="literal">/nix</code> directory</p></li><li class="listitem"><p>The <code class="literal">/boot</code> directory</p></li><li class="listitem"><p>Any file or directory listed in <code class="literal">/etc/NIXOS_LUSTRATE</code> (one per
line)</p></li></ul></div><div class="note"><h3 class="title">Note</h3><p>The act of “lustrating” refers to the wiping of the existing distribution.
Creating <code class="literal">/etc/NIXOS_LUSTRATE</code> can also be used on NixOS to remove
all mutable files from your root partition (anything that’s not in
<code class="literal">/nix</code> or <code class="literal">/boot</code> gets “lustrated” on the next boot.</p><p>lustrate /ˈlʌstreɪt/ verb.</p><p>purify by expiatory sacrifice, ceremonial washing, or some other
ritual action.</p></div><p>Let’s create the files:</p><pre><code class="programlisting ShellSession">$ sudo touch /etc/NIXOS
$ sudo touch /etc/NIXOS_LUSTRATE
</code></pre><p>Let’s also make sure the NixOS configuration files are kept once we
reboot on NixOS:</p><pre><code class="programlisting ShellSession">$ echo etc/nixos | sudo tee -a /etc/NIXOS_LUSTRATE
</code></pre></li><li class="listitem"><p>Finally, install NixOS’s boot system, backing up the current boot system’s files in the process.</p><p>The details of this step can vary depending on the bootloader configuration in NixOS and the bootloader in use by the current system.</p><p>The commands below should work for:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="https://en.wikipedia.org/wiki/BIOS"  target="_top">BIOS</a> systems.</p></li><li class="listitem"><p><a class="link" href="https://en.wikipedia.org/wiki/UEFI"  target="_top">UEFI</a> systems where both the current system and NixOS mount the <a class="link" href="https://en.wikipedia.org/wiki/EFI_system_partition"  target="_top">EFI System Partition</a> on <code class="literal">/boot</code>.
Both <a class="link" href="https://systemd.io/BOOT/"  target="_top">systemd-boot</a> and <a class="link" href="https://www.gnu.org/software/grub/index.html"  target="_top">grub</a> expect this by default in NixOS, but other distributions vary.</p></li></ul></div><div class="warning"><h3 class="title">Warning</h3><p>Once you complete this step, your current distribution will no longer be bootable!
If you didn’t get all the NixOS configuration right, especially those settings pertaining to boot loading and root partition, NixOS may not be bootable either.
Have a USB rescue device ready in case this happens.</p></div><div class="warning"><h3 class="title">Warning</h3><p>On <a class="link" href="https://en.wikipedia.org/wiki/UEFI"  target="_top">UEFI</a> systems, anything on the <a class="link" href="https://en.wikipedia.org/wiki/EFI_system_partition"  target="_top">EFI System Partition</a> will be removed by these commands, such as other coexisting OS’s bootloaders.</p></div><pre><code class="programlisting ShellSession">$ sudo mkdir /boot.bak &amp;&amp; sudo mv /boot/* /boot.bak &amp;&amp;
sudo NIXOS_INSTALL_BOOTLOADER=1 /nix/var/nix/profiles/system/bin/switch-to-configuration boot
</code></pre><p>Cross your fingers, reboot, hopefully you should get a NixOS prompt!</p><p>In other cases, most commonly where the <a class="link" href="https://en.wikipedia.org/wiki/EFI_system_partition"  target="_top">EFI System Partition</a> of the current system is instead mounted on <code class="literal">/boot/efi</code>, the goal is to:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Make sure <code class="literal">/boot</code> (and the <a class="link" href="https://en.wikipedia.org/wiki/EFI_system_partition"  target="_top">EFI System Partition</a>, if mounted elsewhere) are mounted how the NixOS configuration would mount them.</p></li><li class="listitem"><p>Clear them of files related to the current system, backing them up outside of <code class="literal">/boot</code>.
NixOS will move the backups into <code class="literal">/old-root</code> along with everything else when it first boots.</p></li><li class="listitem"><p>Instruct the NixOS closure built earlier to install its bootloader with:</p><pre><code class="programlisting ShellSession">sudo NIXOS_INSTALL_BOOTLOADER=1 /nix/var/nix/profiles/system/bin/switch-to-configuration boot
</code></pre></li></ul></div></li><li class="listitem"><p>If for some reason you want to revert to the old distribution,
you’ll need to boot on a USB rescue disk and do something along
these lines:</p><pre><code class="programlisting ShellSession"># mkdir root
# mount /dev/sdaX root
# mkdir root/nixos-root
# mv -v root/* root/nixos-root/
# mv -v root/nixos-root/old-root/* root/
# mv -v root/boot.bak root/boot  # We had renamed this by hand earlier
# umount root
# reboot
</code></pre><p>This may work as is or you might also need to reinstall the boot
loader.</p><p>And of course, if you’re happy with NixOS and no longer need the
old distribution:</p><pre><code class="programlisting ShellSession">sudo rm -rf /old-root
</code></pre></li><li class="listitem"><p>It’s also worth noting that this whole process can be automated.
This is especially useful for Cloud VMs, where provider do not
provide NixOS. For instance,
<a class="link" href="https://github.com/elitak/nixos-infect"  target="_top">nixos-infect</a> uses the
lustrate process to convert Digital Ocean droplets to NixOS from
other distributions automatically.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installing-behind-proxy" class="title" >Installing behind a proxy   </h3>  </div> </div></div><p>To install NixOS behind a proxy, do the following before running
<code class="literal">nixos-install</code>.</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Update proxy configuration in <code class="literal">/mnt/etc/nixos/configuration.nix</code> to
keep the internet accessible after reboot.</p><pre><code class="programlisting nix">{
  networking.proxy.default = &quot;http://user:password@proxy:port/&quot;;
  networking.proxy.noProxy = &quot;127.0.0.1,localhost,internal.domain&quot;;
}
</code></pre></li><li class="listitem"><p>Setup the proxy environment variables in the shell where you are
running <code class="literal">nixos-install</code>.</p><pre><code class="programlisting ShellSession"># proxy_url=&quot;http://user:password@proxy:port/&quot;
# export http_proxy=&quot;$proxy_url&quot;
# export HTTP_PROXY=&quot;$proxy_url&quot;
# export https_proxy=&quot;$proxy_url&quot;
# export HTTPS_PROXY=&quot;$proxy_url&quot;
</code></pre></li></ol></div><div class="note"><h3 class="title">Note</h3><p>If you are switching networks with different proxy configurations, use
the <code class="literal">specialisation</code> option in <code class="literal">configuration.nix</code> to switch proxies at
runtime. Refer to <a class="xref" href="options.html" title="Appendix A. Configuration Options" >Appendix&nbsp;A</a> for more information.</p></div>
</div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-changing-config" class="title" >Changing the Configuration   </h2>  </div> </div></div><p>The file <code class="literal">/etc/nixos/configuration.nix</code> contains the current
configuration of your machine. Whenever you’ve <a class="link" href="index.html#ch-configuration" title="Configuration" >changed
something</a> in that file, you should do</p><pre><code class="programlisting ShellSession"># nixos-rebuild switch
</code></pre><p>to build the new configuration, make it the default configuration for
booting, and try to realise the configuration in the running system
(e.g., by restarting system services).</p><div class="warning"><h3 class="title">Warning</h3><p>This command doesn’t start/stop <a class="link" href="options.html#opt-systemd.user.services"  >user services</a>
automatically. <code class="literal">nixos-rebuild</code> only runs a <code class="literal">daemon-reload</code> for each user with running
user services.</p></div><div class="warning"><h3 class="title">Warning</h3><p>These commands must be executed as root, so you should either run them
from a root shell or by prefixing them with <code class="literal">sudo -i</code>.</p></div><p>You can also do</p><pre><code class="programlisting ShellSession"># nixos-rebuild test
</code></pre><p>to build the configuration and switch the running system to it, but
without making it the boot default. So if (say) the configuration locks
up your machine, you can just reboot to get back to a working
configuration.</p><p>There is also</p><pre><code class="programlisting ShellSession"># nixos-rebuild boot
</code></pre><p>to build the configuration and make it the boot default, but not switch
to it now (so it will only take effect after the next reboot).</p><p>You can make your configuration show up in a different submenu of the
GRUB 2 boot screen by giving it a different <span class="emphasis"><em>profile name</em></span>, e.g.</p><pre><code class="programlisting ShellSession"># nixos-rebuild switch -p test
</code></pre><p>which causes the new configuration (and previous ones created using
<code class="literal">-p test</code>) to show up in the GRUB submenu “NixOS - Profile ‘test’”.
This can be useful to separate test configurations from “stable”
configurations.</p><p>A repl, or read-eval-print loop, is also available. You can inspect your configuration and use the Nix language with</p><pre><code class="programlisting ShellSession"># nixos-rebuild repl
</code></pre><p>Your configuration is loaded into the <code class="literal">config</code> variable. Use tab for autocompletion, use the <code class="literal">:r</code> command to reload the configuration files. See <code class="literal">:?</code> or <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-repl.html"  target="_top"><code class="literal">nix repl</code> in the Nix manual</a> to learn more.</p><p>Finally, you can do</p><pre><code class="programlisting ShellSession">$ nixos-rebuild build
</code></pre><p>to build the configuration but nothing more. This is useful to see
whether everything compiles cleanly.</p><p>If you have a machine that supports hardware virtualisation, you can
also test the new configuration in a sandbox by building and running a
QEMU <span class="emphasis"><em>virtual machine</em></span> that contains the desired configuration. Just do</p><pre><code class="programlisting ShellSession">$ nixos-rebuild build-vm
$ ./result/bin/run-*-vm
</code></pre><p>The VM does not have any data from your host system, so your existing
user accounts and home directories will not be available unless you have
set <code class="literal">mutableUsers = false</code>. Another way is to temporarily add the
following to your configuration:</p><pre><code class="programlisting nix">{
  users.users.your-user.initialHashedPassword = &quot;test&quot;;
}
</code></pre><p><span class="emphasis"><em>Important:</em></span> delete the $hostname.qcow2 file if you have started the
virtual machine at least once without the right users, otherwise the
changes will not get picked up. You can forward ports on the host to the
guest. For instance, the following will forward host port 2222 to guest
port 22 (SSH):</p><pre><code class="programlisting ShellSession">$ QEMU_NET_OPTS=&quot;hostfwd=tcp:127.0.0.1:2222-:22&quot; ./result/bin/run-*-vm
</code></pre><p>allowing you to log in via SSH (assuming you have set the appropriate
passwords or SSH authorized keys):</p><pre><code class="programlisting ShellSession">$ ssh -p 2222 localhost
</code></pre><p>Such port forwardings connect via the VM’s virtual network interface.
Thus they cannot connect to ports that are only bound to the VM’s
loopback interface (<code class="literal">127.0.0.1</code>), and the VM’s NixOS firewall
must be configured to allow these connections.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-upgrading" class="title" >Upgrading NixOS   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-upgrading-automatic">Automatic Upgrades</a> </span></dt> </dl></div><p>The best way to keep your NixOS installation up to date is to use one of
the NixOS <span class="emphasis"><em>channels</em></span>. A channel is a Nix mechanism for distributing Nix
expressions and associated binaries. The NixOS channels are updated
automatically from NixOS’s Git repository after certain tests have
passed and all packages have been built. These channels are:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><span class="emphasis"><em>Stable channels</em></span>, such as <a class="link" href="https://channels.nixos.org/nixos-25.05"  target="_top"><code class="literal">nixos-25.05</code></a>.
These only get conservative bug fixes and package upgrades. For
instance, a channel update may cause the Linux kernel on your system
to be upgraded from 4.19.34 to 4.19.38 (a minor bug fix), but not
from 4.19.x to 4.20.x (a major change that has the potential to break things).
Stable channels are generally maintained until the next stable
branch is created.</p></li><li class="listitem"><p>The <span class="emphasis"><em>unstable channel</em></span>, <a class="link" href="https://channels.nixos.org/nixos-unstable"  target="_top"><code class="literal">nixos-unstable</code></a>.
This corresponds to NixOS’s main development branch, and may thus see
radical changes between channel updates. It’s not recommended for
production systems.</p></li><li class="listitem"><p><span class="emphasis"><em>Small channels</em></span>, such as <a class="link" href="https://channels.nixos.org/nixos-25.05-small"  target="_top"><code class="literal">nixos-25.05-small</code></a>
or <a class="link" href="https://channels.nixos.org/nixos-unstable-small"  target="_top"><code class="literal">nixos-unstable-small</code></a>.
These are identical to the stable and unstable channels described above,
except that they contain fewer binary packages. This means they get updated
faster than the regular channels (for instance, when a critical security patch
is committed to NixOS’s source tree), but may require more packages to be
built from source than usual. They’re mostly intended for server environments
and as such contain few GUI applications.</p></li></ul></div><p>To see what channels are available, go to <a class="link" href="https://channels.nixos.org"  target="_top">https://channels.nixos.org</a>.
(Note that the URIs of the various channels redirect to a directory that
contains the channel’s latest version and includes ISO images and
VirtualBox appliances.) Please note that during the release process,
channels that are not yet released will be present here as well. See the
Getting NixOS page <a class="link" href="https://nixos.org/download/"  target="_top">https://nixos.org/download/</a> to find the newest
supported stable release.</p><p>When you first install NixOS, you’re automatically subscribed to the
NixOS channel that corresponds to your installation source. For
instance, if you installed from a 25.05 ISO, you will be subscribed to
the <code class="literal">nixos-25.05</code> channel. To see which NixOS channel you’re subscribed
to, run the following as root:</p><pre><code class="programlisting ShellSession"># nix-channel --list | grep nixos
nixos https://channels.nixos.org/nixos-unstable
</code></pre><p>To switch to a different NixOS channel, do</p><pre><code class="programlisting ShellSession"># nix-channel --add https://channels.nixos.org/channel-name nixos
</code></pre><p>(Be sure to include the <code class="literal">nixos</code> parameter at the end.) For instance, to
use the NixOS 25.05 stable channel:</p><pre><code class="programlisting ShellSession"># nix-channel --add https://channels.nixos.org/nixos-25.05 nixos
</code></pre><p>If you have a server, you may want to use the “small” channel instead:</p><pre><code class="programlisting ShellSession"># nix-channel --add https://channels.nixos.org/nixos-25.05-small nixos
</code></pre><p>And if you want to live on the bleeding edge:</p><pre><code class="programlisting ShellSession"># nix-channel --add https://channels.nixos.org/nixos-unstable nixos
</code></pre><p>You can then upgrade NixOS to the latest version in your chosen channel
by running</p><pre><code class="programlisting ShellSession"># nixos-rebuild switch --upgrade
</code></pre><p>which is equivalent to the more verbose <code class="literal">nix-channel --update nixos; nixos-rebuild switch</code>.</p><div class="note"><h3 class="title">Note</h3><p>Channels are set per user. This means that running <code class="literal">nix-channel --add</code>
as a non root user (or without sudo) will not affect
configuration in <code class="literal">/etc/nixos/configuration.nix</code></p></div><div class="warning"><h3 class="title">Warning</h3><p>It is generally safe to switch back and forth between channels. The only
exception is that a newer NixOS may also have a newer Nix version, which
may involve an upgrade of Nix’s database schema. This cannot be undone
easily, so in that case you will not be able to go back to your original
channel.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-upgrading-automatic" class="title" style="clear: both">Automatic Upgrades   </h2>  </div> </div></div><p>You can keep a NixOS system up-to-date automatically by adding the
following to <code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  system.autoUpgrade.enable = true;
  system.autoUpgrade.allowReboot = true;
}
</code></pre><p>This enables a periodically executed systemd service named
<code class="literal">nixos-upgrade.service</code>. If the <code class="literal">allowReboot</code> option is <code class="literal">false</code>, it runs
<code class="literal">nixos-rebuild switch --upgrade</code> to upgrade NixOS to the latest version
in the current channel. (To see when the service runs, see <code class="literal">systemctl list-timers</code>.)
If <code class="literal">allowReboot</code> is <code class="literal">true</code>, then the system will automatically reboot if
the new generation contains a different kernel, initrd or kernel
modules. You can also specify a channel explicitly, e.g.</p><pre><code class="programlisting nix">{
  system.autoUpgrade.channel = &quot;https://channels.nixos.org/nixos-25.05&quot;;
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-building-image" class="title" >Building a NixOS (Live) ISO   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-building-image-instructions">Practical Instructions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-building-image-drivers">Additional drivers or firmware</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-building-image-tech-notes">Technical Notes</a> </span></dt> </dl></div><p>Default live installer configurations are available inside <code class="literal">nixos/modules/installer/cd-dvd</code>.
For building other system images, see <a class="link" href="index.html#sec-image-nixos-rebuild-build-image" title="Building Images with nixos-rebuild build-image" >Building Images with <code class="literal">nixos-rebuild build-image</code></a>.</p><p>You have two options:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Use any of those default configurations as is</p></li><li class="listitem"><p>Combine them with (any of) your host config(s)</p></li></ul></div><p>System images, such as the live installer ones, know how to enforce configuration settings
on which they immediately depend in order to work correctly.</p><p>However, if you are confident, you can opt to override those
enforced values with <code class="literal">mkForce</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-building-image-instructions" class="title" style="clear: both">Practical Instructions   </h2>  </div> </div></div><p>To build an ISO image for the channel <code class="literal">nixos-unstable</code>:</p><pre><code class="programlisting ShellSession">$ git clone https://github.com/NixOS/nixpkgs.git
$ cd nixpkgs/nixos
$ git switch nixos-unstable
$ nix-build -A config.system.build.isoImage -I nixos-config=modules/installer/cd-dvd/installation-cd-minimal.nix default.nix
</code></pre><p>To check the content of an ISO image, mount it like so:</p><pre><code class="programlisting ShellSession"># mount -o loop -t iso9660 ./result/iso/nixos-image-25.05pre-git-x86_64-linux.iso /mnt/iso
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-building-image-drivers" class="title" style="clear: both">Additional drivers or firmware   </h2>  </div> </div></div><p>If you need additional (non-distributable) drivers or firmware in the
installer, you might want to extend these configurations.</p><p>For example, to build the GNOME graphical installer ISO, but with support for
certain WiFi adapters present in some MacBooks, you can create the following
file at <code class="literal">modules/installer/cd-dvd/installation-cd-graphical-gnome-macbook.nix</code>:</p><pre><code class="programlisting nix">{ config, ... }:

{
  imports = [ ./installation-cd-graphical-gnome.nix ];

  boot.initrd.kernelModules = [ &quot;wl&quot; ];

  boot.kernelModules = [ &quot;kvm-intel&quot; &quot;wl&quot; ];
  boot.extraModulePackages = [ config.boot.kernelPackages.broadcom_sta ];
}
</code></pre><p>Then build it like in the example above:</p><pre><code class="programlisting ShellSession">$ git clone https://github.com/NixOS/nixpkgs.git
$ cd nixpkgs/nixos
$ export NIXPKGS_ALLOW_UNFREE=1
$ nix-build -A config.system.build.isoImage -I nixos-config=modules/installer/cd-dvd/installation-cd-graphical-gnome-macbook.nix default.nix
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-building-image-tech-notes" class="title" style="clear: both">Technical Notes   </h2>  </div> </div></div><p>The config value enforcement is implemented via <code class="literal">mkImageMediaOverride = mkOverride 60;</code>
and therefore primes over simple value assignments, but also yields to <code class="literal">mkForce</code>.</p><p>This property allows image designers to implement in semantically correct ways those
configuration values upon which the correct functioning of the image depends.</p><p>For example, the iso base image overrides those file systems which it needs at a minimum
for correct functioning, while the installer base image overrides the entire file system
layout because there can’t be any other guarantees on a live medium than those given
by the live medium itself. The latter is especially true before formatting the target
block device(s). On the other hand, the netboot iso only overrides its minimum dependencies
since netboot images are always made-to-target.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-image-nixos-rebuild-build-image" class="title" >Building Images with <code class="literal">nixos-rebuild build-image</code>   </h2>  </div> </div></div><p>Nixpkgs contains a variety of modules to build custom images for different virtualization platforms and cloud providers, such as e.g. <code class="literal">amazon-image.nix</code> and <code class="literal">proxmox-lxc.nix</code>.</p><p>While those can be imported directly, <code class="literal">system.build.images</code> provides an attribute set mapping variant names to image derivations. Available variants are defined - end extendable - in <code class="literal">image.modules</code>, an attribute set mapping variant names to NixOS modules.</p><p>All of those images can be built via both, their <code class="literal">system.build.image</code> attribute and the <code class="literal">nixos-rebuild build-image</code> command.</p><p>For example, to build an Amazon image from your existing NixOS configuration, run:</p><pre><code class="programlisting ShellSession">$ nixos-rebuild build-image --image-variant amazon
[...]
Done. The disk image can be found in /nix/store/[hash]-nixos-image-amazon-25.05pre-git-x86_64-linux/nixos-image-amazon-25.05pre-git-x86_64-linux.vpc
</code></pre><p>To get a list of all variants available, run <code class="literal">nixos-rebuild build-image</code> without arguments.</p><div class="example"><span id="ex-nixos-rebuild-build-image-customize" ></span><details><summary><span class="title"><strong>Example 5. Customize specific image variants</strong></span></summary><div class="example-contents"><p>The <code class="literal">image.modules</code> option can be used to set specific options per image variant, in a similar fashion as <a class="link" href="options.html#opt-specialisation"  target="_top">specialisations</a> for generic NixOS configurations.</p><p>E.g. images for the cloud provider Linode use <code class="literal">grub2</code> as a bootloader by default. If you are using <code class="literal">systemd-boot</code> on other platforms and want to disable it for Linode only, you could use the following options:</p><pre><code class="programlisting  nix">  image.modules.linode = {
    boot.loader.systemd-boot.enable = lib.mkForce false;
  };
</code></pre></div></details></div><br class="example-break" />
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-image-repart" class="title" >Building Images via <code class="literal">systemd-repart</code>   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-image-repart-store-partition">Nix Store Partition</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-image-repart-appliance">Appliance Image</a> </span></dt> </dl></div><p>You can build disk images in NixOS with the <code class="literal">image.repart</code> option provided by
the module <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/image/repart.nix"  target="_top">image/repart.nix</a>. This module uses <code class="literal">systemd-repart</code> to build the
images and exposes it’s entire interface via the <code class="literal">repartConfig</code> option.</p><p>An example of how to build an image:</p><pre><code class="programlisting nix">{ config, modulesPath, ... }: {

  imports = [ &quot;${modulesPath}/image/repart.nix&quot; ];

  image.repart = {
    name = &quot;image&quot;;
    partitions = {
      &quot;esp&quot; = {
        contents = {
          # ...
        };
        repartConfig = {
          Type = &quot;esp&quot;;
          # ...
        };
      };
      &quot;root&quot; = {
        storePaths = [ config.system.build.toplevel ];
        repartConfig = {
          Type = &quot;root&quot;;
          Label = &quot;nixos&quot;;
          # ...
        };
      };
    };
  };

}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-image-repart-store-partition" class="title" style="clear: both">Nix Store Partition   </h2>  </div> </div></div><p>You can define a partition that only contains the Nix store and then mount it
under <code class="literal">/nix/store</code>. Because the <code class="literal">/nix/store</code> part of the paths is already
determined by the mount point, you have to set <code class="literal">stripNixStorePrefix = true;</code> so
that the prefix is stripped from the paths before copying them into the image.</p><pre><code class="programlisting nix">{
  fileSystems.&quot;/nix/store&quot;.device = &quot;/dev/disk/by-partlabel/nix-store&quot;;

  image.repart.partitions = {
    &quot;store&quot; = {
      storePaths = [ config.system.build.toplevel ];
      stripNixStorePrefix = true;
      repartConfig = {
        Type = &quot;linux-generic&quot;;
        Label = &quot;nix-store&quot;;
        # ...
      };
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-image-repart-appliance" class="title" style="clear: both">Appliance Image   </h2>  </div> </div></div><p>The <code class="literal">image/repart.nix</code> module can also be used to build self-contained <a class="link" href="https://en.wikipedia.org/wiki/Software_appliance"  target="_top">software
appliances</a>.</p><p>The generation based update mechanism of NixOS is not suited for appliances.
Updates of appliances are usually either performed by replacing the entire
image with a new one or by updating partitions via an A/B scheme. See the
<a class="link" href="https://chromium.googlesource.com/aosp/platform/system/update_engine/+/HEAD/README.md"  target="_top">Chrome OS update process</a> for an example of how to achieve
this. The appliance image built in the following example does not contain a
<code class="literal">configuration.nix</code> and thus you will not be able to call <code class="literal">nixos-rebuild</code> from
this system. Furthermore, it uses a <a class="link" href="https://uapi-group.org/specifications/specs/unified_kernel_image/"  target="_top">Unified Kernel Image</a>.</p><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };
  efiArch = pkgs.stdenv.hostPlatform.efiArch;
in
(pkgs.nixos [
  ({ config, lib, pkgs, modulesPath, ... }: {

    imports = [ &quot;${modulesPath}/image/repart.nix&quot; ];

    boot.loader.grub.enable = false;

    fileSystems.&quot;/&quot;.device = &quot;/dev/disk/by-label/nixos&quot;;

    image.repart = {
      name = &quot;image&quot;;
      partitions = {
        &quot;esp&quot; = {
          contents = {
            &quot;/EFI/BOOT/BOOT${lib.toUpper efiArch}.EFI&quot;.source =
              &quot;${pkgs.systemd}/lib/systemd/boot/efi/systemd-boot${efiArch}.efi&quot;;

            &quot;/EFI/Linux/${config.system.boot.loader.ukiFile}&quot;.source =
              &quot;${config.system.build.uki}/${config.system.boot.loader.ukiFile}&quot;;
          };
          repartConfig = {
            Type = &quot;esp&quot;;
            Format = &quot;vfat&quot;;
            SizeMinBytes = &quot;96M&quot;;
          };
        };
        &quot;root&quot; = {
          storePaths = [ config.system.build.toplevel ];
          repartConfig = {
            Type = &quot;root&quot;;
            Format = &quot;ext4&quot;;
            Label = &quot;nixos&quot;;
            Minimize = &quot;guess&quot;;
          };
        };
      };
    };

  })
]).image
</code></pre>
</div>

</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="ch-configuration" class="title" >Configuration   </h1>  </div> </div></div><div class="partintro"><p>This chapter describes how to configure various aspects of a NixOS machine through the configuration file <code class="filename">/etc/nixos/configuration.nix</code>. As described in <a class="xref" href="index.html#sec-changing-config" title="Changing the Configuration" ><em>Changing the Configuration</em></a>, changes to this file only take effect after you run <span class="command"><strong>nixos-rebuild</strong></span>.</p><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#sec-configuration-syntax">Configuration Syntax</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-package-management">Package Management</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-user-management">User Management</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-file-systems">File Systems</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-x11">X Window System</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-wayland">Wayland</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-gpu-accel">GPU acceleration</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-xfce">Xfce Desktop Environment</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-networking">Networking</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-kernel-config">Linux Kernel</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-subversion">Subversion</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-pantheon">Pantheon Desktop</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-gnome">GNOME Desktop</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-bootloader-external">External Bootloader Backends</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-boot-clevis">Clevis</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-garage">Garage</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-youtrack">YouTrack</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-suwayomi-server">Suwayomi-Server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-strfry">strfry</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-plausible">Plausible</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-pingvin-share">Pingvin Share</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-pict-rs">Pict-rs</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-nextcloud">Nextcloud</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-matomo">Matomo</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-lemmy">Lemmy</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-keycloak">Keycloak</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-jitsi-meet">Jitsi Meet</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-honk">Honk</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-hatsu">Hatsu</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-grocy">Grocy</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-gotosocial">GoToSocial</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-glance">Glance</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-filesender">FileSender</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-discourse">Discourse</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-davis">Davis</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-castopod">Castopod</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-c2fmzq">c2FmZQ</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-akkoma">Akkoma</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-systemd-lock-handler">systemd-lock-handler</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-kerberos-server">kerberos_server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-meilisearch">Meilisearch</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-networking-yggdrasil">Yggdrasil</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-service-umurmur">uMurmur</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-prosody">Prosody</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-pleroma">Pleroma</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-netbird-server">Netbird server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-netbird">Netbird</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-mosquitto">Mosquitto</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-jotta-cli">Jottacloud Command-line Tool</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-gns3-server">GNS3 Server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-firefox-syncserver">Firefox Sync server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-service-doh-server">DNS-over-HTTPS Server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-networking-dnsmasq">Dnsmasq</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-crab-hole">🦀 crab-hole</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-anubis">Anubis</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-samba">Samba</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-litestream">Litestream</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-prometheus-exporters">Prometheus exporters</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-parsedmarc">parsedmarc</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-ocsinventory-agent">OCS Inventory Agent</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-goss">Goss</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-certspotter">Cert Spotter</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-weechat">WeeChat</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-taskserver">Taskserver</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-sourcehut">Sourcehut</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-gitlab">GitLab</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-forgejo">Forgejo</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-dump1090-fa">Dump1090-fa</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-apache-kafka">Apache Kafka</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-anki-sync-server">Anki Sync Server</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-matrix">Matrix</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-mjolnir">Mjolnir (Matrix Moderation Tool)</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-mautrix-signal">Mautrix-Signal</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-maubot">Maubot</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-draupnir">Draupnir (Matrix Moderation Bot)</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-mailman">Mailman</a> </span></dt><dt> <span class="chapter">  <a href="index.html#trezor">Trezor</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-hardware-display">Customizing display configuration</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-emacs">Emacs</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-livebook">Livebook</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-blackfire">Blackfire profiler</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-athens">Athens</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-flatpak">Flatpak</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-tigerbeetle">TigerBeetle</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-postgresql">PostgreSQL</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-foundationdb">FoundationDB</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-borgbase">BorgBackup</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-security-acme">SSL/TLS Certificates with ACME</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-programs-zsh-ohmyzsh">Oh my ZSH</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-program-plotinus">Plotinus</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-programs-digitalbitbox">Digital Bitbox</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-services-input-methods">Input Methods</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-profiles">Profiles</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-mattermost">Mattermost</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-kubernetes">Kubernetes</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-configuration-syntax" class="title" >Configuration Syntax   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-configuration-file">NixOS Configuration File</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-module-abstractions">Abstractions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-modularity">Modularity</a> </span></dt> </dl></div><p>The NixOS configuration file <code class="literal">/etc/nixos/configuration.nix</code> is actually
a <span class="emphasis"><em>Nix expression</em></span>, which is the Nix package manager’s purely functional
language for describing how to build packages and configurations. This
means you have all the expressive power of that language at your
disposal, including the ability to abstract over common patterns, which
is very useful when managing complex systems. The syntax and semantics
of the Nix language are fully described in the <a class="link" href="https://nixos.org/nix/manual/#chap-writing-nix-expressions"  target="_top">Nix
manual</a>, but
here we give a short overview of the most important constructs useful in
NixOS configuration files.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-configuration-file" class="title" style="clear: both">NixOS Configuration File   </h2>  </div> </div></div><p>The NixOS configuration file generally looks like this:</p><pre><code class="programlisting nix">{ config, pkgs, ... }:

{ /* option definitions */
}
</code></pre><p>The first line (<code class="literal">{ config, pkgs, ... }:</code>) denotes that this is actually
a function that takes at least the two arguments <code class="literal">config</code> and <code class="literal">pkgs</code>.
(These are explained later, in chapter <a class="xref" href="index.html#sec-writing-modules" title="Writing NixOS Modules" ><em>Writing NixOS Modules</em></a>) The
function returns a <span class="emphasis"><em>set</em></span> of option definitions (<code class="literal">{ ... }</code>).
These definitions have the form <code class="literal">name = value</code>, where <code class="literal">name</code> is the
name of an option and <code class="literal">value</code> is its value. For example,</p><pre><code class="programlisting nix">{ config, pkgs, ... }:

{ services.httpd.enable = true;
  services.httpd.adminAddr = &quot;alice@example.org&quot;;
  services.httpd.virtualHosts.localhost.documentRoot = &quot;/webroot&quot;;
}
</code></pre><p>defines a configuration with three option definitions that together
enable the Apache HTTP Server with <code class="literal">/webroot</code> as the document root.</p><p>Sets can be nested, and in fact dots in option names are shorthand for
defining a set containing another set. For instance,
<a class="xref" href="options.html#opt-services.httpd.enable"  ><code class="option">services.httpd.enable</code></a> defines a set named
<code class="literal">services</code> that contains a set named <code class="literal">httpd</code>, which in turn contains an
option definition named <code class="literal">enable</code> with value <code class="literal">true</code>. This means that the
example above can also be written as:</p><pre><code class="programlisting nix">{ config, pkgs, ... }:

{ services = {
    httpd = {
      enable = true;
      adminAddr = &quot;alice@example.org&quot;;
      virtualHosts = {
        localhost = {
          documentRoot = &quot;/webroot&quot;;
        };
      };
    };
  };
}
</code></pre><p>which may be more convenient if you have lots of option definitions that
share the same prefix (such as <code class="literal">services.httpd</code>).</p><p>NixOS checks your option definitions for correctness. For instance, if
you try to define an option that doesn’t exist (that is, doesn’t have a
corresponding <span class="emphasis"><em>option declaration</em></span>), <code class="literal">nixos-rebuild</code> will give an error
like:</p><pre><code class="programlisting plain">The option `services.httpd.enable&#x27; defined in `/etc/nixos/configuration.nix&#x27; does not exist.
</code></pre><p>Likewise, values in option definitions must have a correct type. For
instance, <code class="literal">services.httpd.enable</code> must be a Boolean (<code class="literal">true</code> or <code class="literal">false</code>).
Trying to give it a value of another type, such as a string, will cause
an error:</p><pre><code class="programlisting plain">The option value `services.httpd.enable&#x27; in `/etc/nixos/configuration.nix&#x27; is not a boolean.
</code></pre><p>Options have various types of values. The most important are:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Strings</span></dt><dd><p>Strings are enclosed in double quotes, e.g.</p><pre><code class="programlisting nix">{
  networking.hostName = &quot;dexter&quot;;
}
</code></pre><p>Special characters can be escaped by prefixing them with a backslash
(e.g. <code class="literal">\&quot;</code>).</p><p>Multi-line strings can be enclosed in <span class="emphasis"><em>double single quotes</em></span>, e.g.</p><pre><code class="programlisting nix">{
  networking.extraHosts =
    &#x27;&#x27;
      127.0.0.2 other-localhost
      10.0.0.1 server
    &#x27;&#x27;;
}
</code></pre><p>The main difference is that it strips from each line a number of
spaces equal to the minimal indentation of the string as a whole
(disregarding the indentation of empty lines), and that characters
like <code class="literal">&quot;</code> and <code class="literal">\</code> are not special (making it more convenient for
including things like shell code). See more info about this in the
Nix manual <a class="link" href="https://nixos.org/nix/manual/#ssec-values"  target="_top">here</a>.</p></dd><dt><span class="term">Booleans</span></dt><dd><p>These can be <code class="literal">true</code> or <code class="literal">false</code>, e.g.</p><pre><code class="programlisting nix">{
  networking.firewall.enable = true;
  networking.firewall.allowPing = false;
}
</code></pre></dd><dt><span class="term">Integers</span></dt><dd><p>For example,</p><pre><code class="programlisting nix">{
  boot.kernel.sysctl.&quot;net.ipv4.tcp_keepalive_time&quot; = 60;
}
</code></pre><p>(Note that here the attribute name <code class="literal">net.ipv4.tcp_keepalive_time</code> is
enclosed in quotes to prevent it from being interpreted as a set
named <code class="literal">net</code> containing a set named <code class="literal">ipv4</code>, and so on. This is
because it’s not a NixOS option but the literal name of a Linux
kernel setting.)</p></dd><dt><span class="term">Sets</span></dt><dd><p>Sets were introduced above. They are name/value pairs enclosed in
braces, as in the option definition</p><pre><code class="programlisting nix">{
  fileSystems.&quot;/boot&quot; =
    { device = &quot;/dev/sda1&quot;;
      fsType = &quot;ext4&quot;;
      options = [ &quot;rw&quot; &quot;data=ordered&quot; &quot;relatime&quot; ];
    };
}
</code></pre></dd><dt><span class="term">Lists</span></dt><dd><p>The important thing to note about lists is that list elements are
separated by whitespace, like this:</p><pre><code class="programlisting nix">{
  boot.kernelModules = [ &quot;fuse&quot; &quot;kvm-intel&quot; &quot;coretemp&quot; ];
}
</code></pre><p>List elements can be any other type, e.g. sets:</p><pre><code class="programlisting nix">{
  swapDevices = [ { device = &quot;/dev/disk/by-label/swap&quot;; } ];
}
</code></pre></dd><dt><span class="term">Packages</span></dt><dd><p>Usually, the packages you need are already part of the Nix Packages
collection, which is a set that can be accessed through the function
argument <code class="literal">pkgs</code>. Typical uses:</p><pre><code class="programlisting nix">{
  environment.systemPackages =
    [ pkgs.thunderbird
      pkgs.emacs
    ];

  services.postgresql.package = pkgs.postgresql_14;
}
</code></pre><p>The latter option definition changes the default PostgreSQL package
used by NixOS’s PostgreSQL service to 14.x. For more information on
packages, including how to add new ones, see
<a class="xref" href="index.html#sec-custom-packages" title="Adding Custom Packages" >the section called “Adding Custom Packages”</a>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-module-abstractions" class="title" style="clear: both">Abstractions   </h2>  </div> </div></div><p>If you find yourself repeating yourself over and over, it’s time to abstract. Take, for instance, this Apache HTTP Server configuration:</p><pre><code class="programlisting nix">{
  services.httpd.virtualHosts =
    { &quot;blog.example.org&quot; = {
        documentRoot = &quot;/webroot/blog.example.org&quot;;
        adminAddr = &quot;alice@example.org&quot;;
        forceSSL = true;
        enableACME = true;
      };
      &quot;wiki.example.org&quot; = {
        documentRoot = &quot;/webroot/wiki.example.org&quot;;
        adminAddr = &quot;alice@example.org&quot;;
        forceSSL = true;
        enableACME = true;
      };
    };
}
</code></pre><p>It defines two virtual hosts with nearly identical configuration; the only difference is the document root directories. To prevent this duplication, we can use a <code class="literal">let</code>:</p><pre><code class="programlisting nix">let
  commonConfig =
    { adminAddr = &quot;alice@example.org&quot;;
      forceSSL = true;
      enableACME = true;
    };
in
{
  services.httpd.virtualHosts =
    { &quot;blog.example.org&quot; = (commonConfig // { documentRoot = &quot;/webroot/blog.example.org&quot;; });
      &quot;wiki.example.org&quot; = (commonConfig // { documentRoot = &quot;/webroot/wiki.example.org&quot;; });
    };
}
</code></pre><p>The <code class="literal">let commonConfig = ...</code> defines a variable named <code class="literal">commonConfig</code>. The <code class="literal">//</code> operator merges two attribute sets, so the configuration of the second virtual host is the set <code class="literal">commonConfig</code> extended with the document root option.</p><p>You can write a <code class="literal">let</code> wherever an expression is allowed. Thus, you also could have written:</p><pre><code class="programlisting nix">{
  services.httpd.virtualHosts =
    let commonConfig = { /* ... */ }; in
    { &quot;blog.example.org&quot; = (commonConfig // { /* ... */ });
      &quot;wiki.example.org&quot; = (commonConfig // { /* ... */ });
    };
}
</code></pre><p>but not <code class="literal">{ let commonConfig = ...; in ...; }</code> since attributes (as opposed to attribute values) are not expressions.</p><p><span class="strong"><strong>Functions</strong></span> provide another method of abstraction. For instance, suppose that we want to generate lots of different virtual hosts, all with identical configuration except for the document root. This can be done as follows:</p><pre><code class="programlisting nix">{
  services.httpd.virtualHosts =
    let
      makeVirtualHost = webroot:
        { documentRoot = webroot;
          adminAddr = &quot;alice@example.org&quot;;
          forceSSL = true;
          enableACME = true;
        };
    in
      { &quot;example.org&quot; = (makeVirtualHost &quot;/webroot/example.org&quot;);
        &quot;example.com&quot; = (makeVirtualHost &quot;/webroot/example.com&quot;);
        &quot;example.gov&quot; = (makeVirtualHost &quot;/webroot/example.gov&quot;);
        &quot;example.nl&quot; = (makeVirtualHost &quot;/webroot/example.nl&quot;);
      };
}
</code></pre><p>Here, <code class="literal">makeVirtualHost</code> is a function that takes a single argument <code class="literal">webroot</code> and returns the configuration for a virtual host. That function is then called for several names to produce the list of virtual host configurations.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-modularity" class="title" style="clear: both">Modularity   </h2>  </div> </div></div><p>The NixOS configuration mechanism is modular. If your
<code class="literal">configuration.nix</code> becomes too big, you can split it into multiple
files. Likewise, if you have multiple NixOS configurations (e.g. for
different computers) with some commonality, you can move the common
configuration into a shared file.</p><p>Modules have exactly the same syntax as <code class="literal">configuration.nix</code>. In fact,
<code class="literal">configuration.nix</code> is itself a module. You can use other modules by
including them from <code class="literal">configuration.nix</code>, e.g.:</p><pre><code class="programlisting nix">{ config, pkgs, ... }:

{ imports = [ ./vpn.nix ./kde.nix ];
  services.httpd.enable = true;
  environment.systemPackages = [ pkgs.emacs ];
  # ...
}
</code></pre><p>Here, we include two modules from the same directory, <code class="literal">vpn.nix</code> and
<code class="literal">kde.nix</code>. The latter might look like this:</p><pre><code class="programlisting nix">{ config, pkgs, ... }:

{ services.xserver.enable = true;
  services.displayManager.sddm.enable = true;
  services.xserver.desktopManager.plasma5.enable = true;
  environment.systemPackages = [ pkgs.vim ];
}
</code></pre><p>Note that both <code class="literal">configuration.nix</code> and <code class="literal">kde.nix</code> define the option
<a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a>. When multiple modules define an
option, NixOS will try to <span class="emphasis"><em>merge</em></span> the definitions. In the case of
<a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a> the lists of packages will be
concatenated. The value in <code class="literal">configuration.nix</code> is
merged last, so for list-type options, it will appear at the end of the
merged list. If you want it to appear first, you can use <code class="literal">mkBefore</code>:</p><pre><code class="programlisting nix">{
  boot.kernelModules = mkBefore [ &quot;kvm-intel&quot; ];
}
</code></pre><p>This causes the <code class="literal">kvm-intel</code> kernel module to be loaded before any other
kernel modules.</p><p>For other types of options, a merge may not be possible. For instance,
if two modules define <a class="xref" href="options.html#opt-services.httpd.adminAddr"  ><code class="option">services.httpd.adminAddr</code></a>,
<code class="literal">nixos-rebuild</code> will give an error:</p><pre><code class="programlisting plain">The unique option `services.httpd.adminAddr&#x27; is defined multiple times, in `/etc/nixos/httpd.nix&#x27; and `/etc/nixos/configuration.nix&#x27;.
</code></pre><p>When that happens, it’s possible to force one definition take precedence
over the others:</p><pre><code class="programlisting nix">{
  services.httpd.adminAddr = pkgs.lib.mkForce &quot;bob@example.org&quot;;
}
</code></pre><p>When using multiple modules, you may need to access configuration values
defined in other modules. This is what the <code class="literal">config</code> function argument is
for: it contains the complete, merged system configuration. That is,
<code class="literal">config</code> is the result of combining the configurations returned by every
module. (If you’re wondering how it’s possible that the (indirect) <span class="emphasis"><em>result</em></span>
of a function is passed as an <span class="emphasis"><em>input</em></span> to that same function: that’s
because Nix is a “lazy” language — it only computes values when
they are needed. This works as long as no individual configuration
value depends on itself.)</p><p>For example, here is a module that adds some packages to
<a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a> only if
<a class="xref" href="options.html#opt-services.xserver.enable"  ><code class="option">services.xserver.enable</code></a> is set to <code class="literal">true</code> somewhere else:</p><pre><code class="programlisting nix">{ config, pkgs, ... }:

{ environment.systemPackages =
    if config.services.xserver.enable then
      [ pkgs.firefox
        pkgs.thunderbird
      ]
    else
      [ ];
}
</code></pre><p>With multiple modules, it may not be obvious what the final value of a
configuration option is. The command <code class="literal">nixos-option</code> allows you to find
out:</p><pre><code class="programlisting ShellSession">$ nixos-option services.xserver.enable
true

$ nixos-option boot.kernelModules
[ &quot;tun&quot; &quot;ipv6&quot; &quot;loop&quot; ... ]
</code></pre><p>Interactive exploration of the configuration is possible using <code class="literal">nix   repl</code>, a read-eval-print loop for Nix expressions. A typical use:</p><pre><code class="programlisting ShellSession">$ nix repl &#x27;&lt;nixpkgs/nixos&gt;&#x27;

nix-repl&gt; config.networking.hostName
&quot;mandark&quot;

nix-repl&gt; map (x: x.hostName) config.services.httpd.virtualHosts
[ &quot;example.org&quot; &quot;example.gov&quot; ]
</code></pre><p>While abstracting your configuration, you may find it useful to generate
modules using code, instead of writing files. The example below would
have the same effect as importing a file which sets those options.</p><pre><code class="programlisting nix">{ config, pkgs, ... }:

let netConfig = hostName: {
  networking.hostName = hostName;
  networking.useDHCP = false;
};

in

{ imports = [ (netConfig &quot;nixos.localdomain&quot;) ]; }
</code></pre>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-package-management" class="title" >Package Management   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-declarative-package-mgmt">Declarative Package Management</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-ad-hoc-packages">Ad-Hoc Package Management</a> </span></dt> </dl></div><p>This section describes how to add additional packages to your system.
NixOS has two distinct styles of package management:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><span class="emphasis"><em>Declarative</em></span>, where you declare what packages you want in your
<code class="literal">configuration.nix</code>. Every time you run <code class="literal">nixos-rebuild</code>, NixOS will
ensure that you get a consistent set of binaries corresponding to
your specification.</p></li><li class="listitem"><p><span class="emphasis"><em>Ad hoc</em></span>, where you install, upgrade and uninstall packages via the
<code class="literal">nix-env</code> command. This style allows mixing packages from different
Nixpkgs versions. It’s the only choice for non-root users.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-declarative-package-mgmt" class="title" style="clear: both">Declarative Package Management   </h2>  </div> </div></div><p>With declarative package management, you specify which packages you want
on your system by setting the option
<a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a>. For instance, adding the
following line to <code class="literal">configuration.nix</code> enables the Mozilla Thunderbird
email application:</p><pre><code class="programlisting nix">{
  environment.systemPackages = [ pkgs.thunderbird ];
}
</code></pre><p>The effect of this specification is that the Thunderbird package from
Nixpkgs will be built or downloaded as part of the system when you run
<code class="literal">nixos-rebuild switch</code>.</p><div class="note"><h3 class="title">Note</h3><p>Some packages require additional global configuration such as D-Bus or
systemd service registration so adding them to
<a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a> might not be sufficient. You are
advised to check the <a class="link" href="options.html" title="Appendix A. Configuration Options" >list of options</a> whether a NixOS
module for the package does not exist.</p></div><p>You can get a list of the available packages as follows:</p><pre><code class="programlisting ShellSession">$ nix-env -qaP &#x27;*&#x27; --description
nixos.firefox   firefox-23.0   Mozilla Firefox - the browser, reloaded
...
</code></pre><p>The first column in the output is the <span class="emphasis"><em>attribute name</em></span>, such as
<code class="literal">nixos.thunderbird</code>.</p><p>Note: the <code class="literal">nixos</code> prefix tells us that we want to get the package from
the <code class="literal">nixos</code> channel and works only in CLI tools. In declarative
configuration use <code class="literal">pkgs</code> prefix (variable).</p><p>To “uninstall” a package, remove it from
<a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a> and run <code class="literal">nixos-rebuild switch</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-customising-packages" class="title" >Customising Packages   </h3>  </div> </div></div><p>The Nixpkgs configuration for a NixOS system is set by the <code class="option">nixpkgs.config</code> option.</p><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 6. Globally allow unfree packages</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  nixpkgs.config = {
    allowUnfree = true;
  };
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>This only allows unfree software in the given NixOS configuration.
For users invoking Nix commands such as <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/nix-build"  target="_top"><code class="literal">nix-build</code></a>, Nixpkgs is configured independently.
See the <a class="link" href="https://nixos.org/manual/nixpkgs/unstable/#chap-packageconfig"  target="_top">Nixpkgs manual section on global configuration</a> for details.</p></div></div></details></div><br class="example-break" /><p>Some packages in Nixpkgs have options to enable or disable optional functionality, or change other aspects of the package.</p><div class="warning"><h3 class="title">Warning</h3><p>Unfortunately, Nixpkgs currently lacks a way to query available package configuration options.</p></div><div class="note"><h3 class="title">Note</h3><p>For example, many packages come with extensions one might add.
Examples include:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="https://search.nixos.org/packages?query=passExtensions.pass-otp"  target="_top"><code class="literal">passExtensions.pass-otp</code></a></p></li><li class="listitem"><p><a class="link" href="https://search.nixos.org/packages?query=python312Packages.requests"  target="_top"><code class="literal">python312Packages.requests</code></a></p></li></ul></div><p>You can use them like this:</p><pre><code class="programlisting nix">{
  environment.systemPackages = with pkgs; [
    sl
    (pass.withExtensions (subpkgs: with subpkgs; [
      pass-audit
      pass-otp
      pass-genphrase
    ]))
    (python3.withPackages (subpkgs: with subpkgs; [
        requests
    ]))
    cowsay
  ];
}
</code></pre></div><p>Apart from high-level options, it’s possible to tweak a package in
almost arbitrary ways, such as changing or disabling dependencies of a
package. For instance, the Emacs package in Nixpkgs by default has a
dependency on GTK 2. If you want to build it against GTK 3, you can
specify that as follows:</p><pre><code class="programlisting nix">{
  environment.systemPackages = [ (pkgs.emacs.override { gtk = pkgs.gtk3; }) ];
}
</code></pre><p>The function <code class="literal">override</code> performs the call to the Nix function that
produces Emacs, with the original arguments amended by the set of
arguments specified by you. So here the function argument <code class="literal">gtk</code> gets the
value <code class="literal">pkgs.gtk3</code>, causing Emacs to depend on GTK 3. (The parentheses
are necessary because in Nix, function application binds more weakly
than list construction, so without them,
<a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a>
would be a list with two elements.)</p><p>Even greater customisation is possible using the function
<code class="literal">overrideAttrs</code>. While the <code class="literal">override</code> mechanism above overrides the
arguments of a package function, <code class="literal">overrideAttrs</code> allows changing the
<span class="emphasis"><em>attributes</em></span> passed to <code class="literal">mkDerivation</code>. This permits changing any aspect
of the package, such as the source code. For instance, if you want to
override the source code of Emacs, you can say:</p><pre><code class="programlisting nix">{
  environment.systemPackages = [
    (pkgs.emacs.overrideAttrs (oldAttrs: {
      name = &quot;emacs-25.0-pre&quot;;
      src = /path/to/my/emacs/tree;
    }))
  ];
}
</code></pre><p>Here, <code class="literal">overrideAttrs</code> takes the Nix derivation specified by <code class="literal">pkgs.emacs</code>
and produces a new derivation in which the original’s <code class="literal">name</code> and <code class="literal">src</code>
attribute have been replaced by the given values by re-calling
<code class="literal">stdenv.mkDerivation</code>. The original attributes are accessible via the
function argument, which is conventionally named <code class="literal">oldAttrs</code>.</p><p>The overrides shown above are not global. They do not affect the
original package; other packages in Nixpkgs continue to depend on the
original rather than the customised package. This means that if another
package in your system depends on the original package, you end up with
two instances of the package. If you want to have everything depend on
your customised instance, you can apply a <span class="emphasis"><em>global</em></span> override as follows:</p><pre><code class="programlisting nix">{
  nixpkgs.config.packageOverrides = pkgs:
    { emacs = pkgs.emacs.override { gtk = pkgs.gtk3; };
    };
}
</code></pre><p>The effect of this definition is essentially equivalent to modifying the
<code class="literal">emacs</code> attribute in the Nixpkgs source tree. Any package in Nixpkgs
that depends on <code class="literal">emacs</code> will be passed your customised instance.
(However, the value <code class="literal">pkgs.emacs</code> in <code class="literal">nixpkgs.config.packageOverrides</code>
refers to the original rather than overridden instance, to prevent an
infinite recursion.)</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-custom-packages" class="title" >Adding Custom Packages   </h3>  </div> </div></div><p>It’s possible that a package you need is not available in NixOS. In that
case, you can do two things. Either you can package it with Nix, or you can try
to use prebuilt packages from upstream. Due to the peculiarities of NixOS, it
is important to note that building software from source is often easier than
using pre-built executables.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-custom-packages-nix" class="title" >Building with Nix   </h4>  </div> </div></div><p>This can be done either in-tree or out-of-tree. For an in-tree build, you can
clone the Nixpkgs repository, add the package to your clone, and (optionally)
submit a patch or pull request to have it accepted into the main Nixpkgs
repository. This is described in detail in the <a class="link" href="https://nixos.org/nixpkgs/manual"  target="_top">Nixpkgs
manual</a>. In short, you clone Nixpkgs:</p><pre><code class="programlisting ShellSession">$ git clone https://github.com/NixOS/nixpkgs
$ cd nixpkgs
</code></pre><p>Then you write and test the package as described in the Nixpkgs manual.
Finally, you add it to <a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a>, e.g.</p><pre><code class="programlisting nix">{
  environment.systemPackages = [ pkgs.my-package ];
}
</code></pre><p>and you run <code class="literal">nixos-rebuild</code>, specifying your own Nixpkgs tree:</p><pre><code class="programlisting ShellSession"># nixos-rebuild switch -I nixpkgs=/path/to/my/nixpkgs
</code></pre><p>The second possibility is to add the package outside of the Nixpkgs
tree. For instance, here is how you specify a build of the
<a class="link" href="https://www.gnu.org/software/hello/"  target="_top">GNU Hello</a> package directly in
<code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  environment.systemPackages =
    let
      my-hello = with pkgs; stdenv.mkDerivation rec {
        name = &quot;hello-2.8&quot;;
        src = fetchurl {
          url = &quot;mirror://gnu/hello/${name}.tar.gz&quot;;
          hash = &quot;sha256-5rd/gffPfa761Kn1tl3myunD8TuM+66oy1O7XqVGDXM=&quot;;
        };
      };
    in
    [ my-hello ];
}
</code></pre><p>Of course, you can also move the definition of <code class="literal">my-hello</code> into a
separate Nix expression, e.g.</p><pre><code class="programlisting nix">{
  environment.systemPackages = [ (import ./my-hello.nix) ];
}
</code></pre><p>where <code class="literal">my-hello.nix</code> contains:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; {}; # bring all of Nixpkgs into scope

stdenv.mkDerivation rec {
  name = &quot;hello-2.8&quot;;
  src = fetchurl {
    url = &quot;mirror://gnu/hello/${name}.tar.gz&quot;;
    hash = &quot;sha256-5rd/gffPfa761Kn1tl3myunD8TuM+66oy1O7XqVGDXM=&quot;;
  };
}
</code></pre><p>This allows testing the package easily:</p><pre><code class="programlisting ShellSession">$ nix-build my-hello.nix
$ ./result/bin/hello
Hello, world!
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-custom-packages-prebuilt" class="title" >Using pre-built executables   </h4>  </div> </div></div><p>Most pre-built executables will not work on NixOS. There are two notable
exceptions: flatpaks and AppImages. For flatpaks see the <a class="link" href="index.html#module-services-flatpak" title="Flatpak" >dedicated
section</a>. AppImages can run “as-is” on NixOS.</p><p>First you need to enable AppImage support: add to <code class="literal">/etc/nixos/configuration.nix</code></p><pre><code class="programlisting nix">{
  programs.appimage.enable = true;
  programs.appimage.binfmt = true;
}
</code></pre><p>Then you can run the AppImage “as-is” or with <code class="literal">appimage-run foo.appimage</code>.</p><p>If there are shared libraries missing add them with</p><pre><code class="programlisting nix">{
  programs.appimage.package = pkgs.appimage-run.override {
    extraPkgs = pkgs: [
      # missing libraries here, e.g.: `pkgs.libepoxy`
    ];
  }
}
</code></pre><p>To make other pre-built executables work on NixOS, you need to package them
with Nix and special helpers like <code class="literal">autoPatchelfHook</code> or <code class="literal">buildFHSEnv</code>. See
the <a class="link" href="https://nixos.org/nixpkgs/manual"  target="_top">Nixpkgs manual</a> for details. This
is complex and often doing a source build is easier.</p>
</div>

</div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-ad-hoc-packages" class="title" style="clear: both">Ad-Hoc Package Management   </h2>  </div> </div></div><p>With the command <code class="literal">nix-env</code>, you can install and uninstall packages from
the command line. For instance, to install Mozilla Thunderbird:</p><pre><code class="programlisting ShellSession">$ nix-env -iA nixos.thunderbird
</code></pre><p>If you invoke this as root, the package is installed in the Nix profile
<code class="literal">/nix/var/nix/profiles/default</code> and visible to all users of the system;
otherwise, the package ends up in
<code class="literal">/nix/var/nix/profiles/per-user/username/profile</code> and is not visible to
other users. The <code class="literal">-A</code> flag specifies the package by its attribute name;
without it, the package is installed by matching against its package
name (e.g. <code class="literal">thunderbird</code>). The latter is slower because it requires
matching against all available Nix packages, and is ambiguous if there
are multiple matching packages.</p><p>Packages come from the NixOS channel. You typically upgrade a package by
updating to the latest version of the NixOS channel:</p><pre><code class="programlisting ShellSession">$ nix-channel --update nixos
</code></pre><p>and then running <code class="literal">nix-env -i</code> again. Other packages in the profile are
<span class="emphasis"><em>not</em></span> affected; this is the crucial difference with the declarative
style of package management, where running <code class="literal">nixos-rebuild switch</code> causes
all packages to be updated to their current versions in the NixOS
channel. You can however upgrade all packages for which there is a newer
version by doing:</p><pre><code class="programlisting ShellSession">$ nix-env -u &#x27;*&#x27;
</code></pre><p>A package can be uninstalled using the <code class="literal">-e</code> flag:</p><pre><code class="programlisting ShellSession">$ nix-env -e thunderbird
</code></pre><p>Finally, you can roll back an undesirable <code class="literal">nix-env</code> action:</p><pre><code class="programlisting ShellSession">$ nix-env --rollback
</code></pre><p><code class="literal">nix-env</code> has many more flags. For details, see the nix-env(1) manpage or
the Nix manual.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-user-management" class="title" >User Management   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-systemd-sysusers">Create users and groups with <code class="literal">systemd-sysusers</code></a> </span></dt><dt> <span class="section">  <a href="index.html#sec-userborn">Manage users and groups with <code class="literal">userborn</code></a> </span></dt> </dl></div><p>NixOS supports both declarative and imperative styles of user
management. In the declarative style, users are specified in
<code class="literal">configuration.nix</code>. For instance, the following states that a user
account named <code class="literal">alice</code> shall exist:</p><pre><code class="programlisting nix">{
  users.users.alice = {
    isNormalUser = true;
    home = &quot;/home/alice&quot;;
    description = &quot;Alice Foobar&quot;;
    extraGroups = [ &quot;wheel&quot; &quot;networkmanager&quot; ];
    openssh.authorizedKeys.keys = [ &quot;ssh-dss AAAAB3Nza... alice@foobar&quot; ];
  };
}
</code></pre><p>Note that <code class="literal">alice</code> is a member of the <code class="literal">wheel</code> and <code class="literal">networkmanager</code>
groups, which allows her to use <code class="literal">sudo</code> to execute commands as <code class="literal">root</code> and
to configure the network, respectively. Also note the SSH public key
that allows remote logins with the corresponding private key. Users
created in this way do not have a password by default, so they cannot
log in via mechanisms that require a password. However, you can use the
<code class="literal">passwd</code> program to set a password, which is retained across invocations
of <code class="literal">nixos-rebuild</code>.</p><p>If you set <a class="xref" href="options.html#opt-users.mutableUsers"  ><code class="option">users.mutableUsers</code></a> to
false, then the contents of <code class="literal">/etc/passwd</code> and <code class="literal">/etc/group</code> will be congruent
to your NixOS configuration. For instance, if you remove a user from
<a class="xref" href="options.html#opt-users.users"  ><code class="option">users.users</code></a> and run nixos-rebuild, the user
account will cease to exist. Also, imperative commands for managing users and
groups, such as useradd, are no longer available. Passwords may still be
assigned by setting the user’s
<a class="link" href="options.html#opt-users.users._name_.hashedPassword"  >hashedPassword</a> option. A
hashed password can be generated using <code class="literal">mkpasswd</code>.</p><p>A user ID (uid) is assigned automatically. You can also specify a uid
manually by adding</p><pre><code class="programlisting nix">{
  uid = 1000;
}
</code></pre><p>to the user specification.</p><p>Groups can be specified similarly. The following states that a group
named <code class="literal">students</code> shall exist:</p><pre><code class="programlisting nix">{
  users.groups.students.gid = 1000;
}
</code></pre><p>As with users, the group ID (gid) is optional and will be assigned
automatically if it’s missing.</p><p>In the imperative style, users and groups are managed by commands such
as <code class="literal">useradd</code>, <code class="literal">groupmod</code> and so on. For instance, to create a user
account named <code class="literal">alice</code>:</p><pre><code class="programlisting ShellSession"># useradd -m alice
</code></pre><p>To make all nix tools available to this new user use `su - USER` which
opens a login shell (==shell that loads the profile) for given user.
This will create the ~/.nix-defexpr symlink. So run:</p><pre><code class="programlisting ShellSession"># su - alice -c &quot;true&quot;
</code></pre><p>The flag <code class="literal">-m</code> causes the creation of a home directory for the new user,
which is generally what you want. The user does not have an initial
password and therefore cannot log in. A password can be set using the
<code class="literal">passwd</code> utility:</p><pre><code class="programlisting ShellSession"># passwd alice
Enter new UNIX password: ***
Retype new UNIX password: ***
</code></pre><p>A user can be deleted using <code class="literal">userdel</code>:</p><pre><code class="programlisting ShellSession"># userdel -r alice
</code></pre><p>The flag <code class="literal">-r</code> deletes the user’s home directory. Accounts can be
modified using <code class="literal">usermod</code>. Unix groups can be managed using <code class="literal">groupadd</code>,
<code class="literal">groupmod</code> and <code class="literal">groupdel</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-systemd-sysusers" class="title" style="clear: both">Create users and groups with <code class="literal">systemd-sysusers</code>   </h2>  </div> </div></div><div class="note"><h3 class="title">Note</h3><p>This is experimental.</p><p>Please consider using <a class="link" href="index.html#sec-userborn" title="Manage users and groups with userborn" >Userborn</a> over systemd-sysusers as it’s
more feature complete.</p></div><p>Instead of using a custom perl script to create users and groups, you can use
systemd-sysusers:</p><pre><code class="programlisting nix">{
  systemd.sysusers.enable = true;
}
</code></pre><p>The primary benefit of this is to remove a dependency on perl.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-userborn" class="title" style="clear: both">Manage users and groups with <code class="literal">userborn</code>   </h2>  </div> </div></div><div class="note"><h3 class="title">Note</h3><p>This is experimental.</p></div><p>Like systemd-sysusers, Userborn doesn’t depend on Perl but offers some more
advantages over systemd-sysusers:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>It can create “normal” users (with a GID &gt;= 1000).</p></li><li class="listitem"><p>It can update some information about users. Most notably it can update their
passwords.</p></li><li class="listitem"><p>It will warn when users use an insecure or unsupported password hashing
scheme.</p></li></ol></div><p>Userborn is the recommended way to manage users if you don’t want to rely on
the Perl script. It aims to eventually replace the Perl script by default.</p><p>You can enable Userborn via:</p><pre><code class="programlisting nix">services.userborn.enable = true;
</code></pre><p>You can configure Userborn to store the password files
(<code class="literal">/etc/{group,passwd,shadow}</code>) outside of <code class="literal">/etc</code> and symlink them from this
location to <code class="literal">/etc</code>:</p><pre><code class="programlisting nix">services.userborn.passwordFilesLocation = &quot;/persistent/etc&quot;;
</code></pre><p>This is useful when you store <code class="literal">/etc</code> on a <code class="literal">tmpfs</code> or if <code class="literal">/etc</code> is immutable
(e.g. when using <code class="literal">system.etc.overlay.mutable = false;</code>). In the latter case the
original files are by default stored in <code class="literal">/var/lib/nixos</code>.</p><p>Userborn implements immutable users by re-mounting the password files
read-only. This means that unlike when using the Perl script, trying to add a
new user (e.g. via <code class="literal">useradd</code>) will fail right away.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="ch-file-systems" class="title" >File Systems   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-luks-file-systems">LUKS-Encrypted File Systems</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-sshfs-file-systems">SSHFS File Systems</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-overlayfs">Overlayfs</a> </span></dt> </dl></div><p>You can define file systems using the <code class="literal">fileSystems</code> configuration
option. For instance, the following definition causes NixOS to mount the
Ext4 file system on device <code class="literal">/dev/disk/by-label/data</code> onto the mount
point <code class="literal">/data</code>:</p><pre><code class="programlisting nix">{
  fileSystems.&quot;/data&quot; =
    { device = &quot;/dev/disk/by-label/data&quot;;
      fsType = &quot;ext4&quot;;
    };
}
</code></pre><p>This will create an entry in <code class="literal">/etc/fstab</code>, which will generate a
corresponding <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd.mount.html"  target="_top">systemd.mount</a>
unit via <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-fstab-generator.html"  target="_top">systemd-fstab-generator</a>.
The filesystem will be mounted automatically unless <code class="literal">&quot;noauto&quot;</code> is
present in <a class="link" href="options.html#opt-fileSystems._name_.options"  >options</a>. <code class="literal">&quot;noauto&quot;</code>
filesystems can be mounted explicitly using <code class="literal">systemctl</code> e.g.
<code class="literal">systemctl start data.mount</code>. Mount points are created automatically if they don’t
already exist. For <code class="literal">device</code>, it’s best to use the topology-independent
device aliases in <code class="literal">/dev/disk/by-label</code> and <code class="literal">/dev/disk/by-uuid</code>, as these
don’t change if the topology changes (e.g. if a disk is moved to another
IDE controller).</p><p>You can usually omit the file system type (<code class="literal">fsType</code>), since <code class="literal">mount</code> can
usually detect the type and load the necessary kernel module
automatically. However, if the file system is needed at early boot (in
the initial ramdisk) and is not <code class="literal">ext2</code>, <code class="literal">ext3</code> or <code class="literal">ext4</code>, then it’s best
to specify <code class="literal">fsType</code> to ensure that the kernel module is available.</p><div class="note"><h3 class="title">Note</h3><p>System startup will fail if any of the filesystems fails to mount,
dropping you to the emergency shell. You can make a mount asynchronous
and non-critical by adding <code class="literal">options = [ &quot;nofail&quot; ];</code>.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-luks-file-systems" class="title" style="clear: both">LUKS-Encrypted File Systems   </h2>  </div> </div></div><p>NixOS supports file systems that are encrypted using <span class="emphasis"><em>LUKS</em></span> (Linux
Unified Key Setup). For example, here is how you create an encrypted
Ext4 file system on the device
<code class="literal">/dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d</code>:</p><pre><code class="programlisting ShellSession"># cryptsetup luksFormat /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d

WARNING!
========
This will overwrite data on /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d irrevocably.

Are you sure? (Type uppercase yes): YES
Enter LUKS passphrase: ***
Verify passphrase: ***

# cryptsetup luksOpen /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d crypted
Enter passphrase for /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d: ***

# mkfs.ext4 /dev/mapper/crypted
</code></pre><p>The LUKS volume should be automatically picked up by
<code class="literal">nixos-generate-config</code>, but you might want to verify that your
<code class="literal">hardware-configuration.nix</code> looks correct. To manually ensure that the
system is automatically mounted at boot time as <code class="literal">/</code>, add the following
to <code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  boot.initrd.luks.devices.crypted.device = &quot;/dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d&quot;;
  fileSystems.&quot;/&quot;.device = &quot;/dev/mapper/crypted&quot;;
}
</code></pre><p>Should grub be used as bootloader, and <code class="literal">/boot</code> is located on an
encrypted partition, it is necessary to add the following grub option:</p><pre><code class="programlisting nix">{
  boot.loader.grub.enableCryptodisk = true;
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-luks-file-systems-fido2" class="title" >FIDO2   </h3>  </div> </div></div><p>NixOS also supports unlocking your LUKS-Encrypted file system using a FIDO2
compatible token.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-luks-file-systems-fido2-legacy" class="title" >Without systemd in initrd   </h4>  </div> </div></div><p>In the following example, we will create a new
FIDO2 credential and add it as a new key to our existing device
<code class="literal">/dev/sda2</code>:</p><pre><code class="programlisting ShellSession"># export FIDO2_LABEL=&quot;/dev/sda2 @ $HOSTNAME&quot;
# fido2luks credential &quot;$FIDO2_LABEL&quot;
f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7

# fido2luks -i add-key /dev/sda2 f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7
Password:
Password (again):
Old password:
Old password (again):
Added to key to device /dev/sda2, slot: 2
</code></pre><p>To ensure that this file system is decrypted using the FIDO2 compatible
key, add the following to <code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  boot.initrd.luks.fido2Support = true;
  boot.initrd.luks.devices.&quot;/dev/sda2&quot;.fido2.credential = &quot;f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7&quot;;
}
</code></pre><p>You can also use the FIDO2 passwordless setup, but for security reasons,
you might want to enable it only when your device is PIN protected, such
as <a class="link" href="https://trezor.io/"  target="_top">Trezor</a>.</p><pre><code class="programlisting nix">{
  boot.initrd.luks.devices.&quot;/dev/sda2&quot;.fido2.passwordLess = true;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-luks-file-systems-fido2-systemd" class="title" >systemd Stage 1   </h4>  </div> </div></div><p>If systemd stage 1 is enabled, it handles unlocking of LUKS-encrypted volumes
during boot. The following example enables systemd stage1 and adds support for
unlocking the existing LUKS2 volume <code class="literal">root</code> using any enrolled FIDO2 compatible
tokens.</p><pre><code class="programlisting nix">{
  boot.initrd = {
    luks.devices.root = {
      crypttabExtraOpts = [ &quot;fido2-device=auto&quot; ];
      device = &quot;/dev/sda2&quot;;
    };
    systemd.enable = true;
  };
}
</code></pre><p>All tokens that should be used for unlocking the LUKS2-encrypted volume must
first be enrolled using <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-cryptenroll.html"  target="_top">systemd-cryptenroll</a>.
In the following example, a new key slot for the first discovered token is
added to the LUKS volume.</p><pre><code class="programlisting ShellSession"># systemd-cryptenroll --fido2-device=auto /dev/sda2
</code></pre><p>Existing key slots are left intact, unless <code class="literal">--wipe-slot=</code> is specified. It is
recommended to add a recovery key that should be stored in a secure physical
location and can be entered wherever a password would be entered.</p><pre><code class="programlisting ShellSession"># systemd-cryptenroll --recovery-key /dev/sda2
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-sshfs-file-systems" class="title" style="clear: both">SSHFS File Systems   </h2>  </div> </div></div><p><a class="link" href="https://github.com/libfuse/sshfs"  target="_top">SSHFS</a> is a <a class="link" href="https://en.wikipedia.org/wiki/Filesystem_in_Userspace"  target="_top">FUSE</a> filesystem that allows easy access to directories on a remote machine using the SSH File Transfer Protocol (SFTP).
It means that if you have SSH access to a machine, no additional setup is needed to mount a directory.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-sshfs-interactive" class="title" >Interactive mounting   </h3>  </div> </div></div><p>In NixOS, SSHFS is packaged as <code class="literal">sshfs</code>.
Once installed, mounting a directory interactively is simple as running:</p><pre><code class="programlisting ShellSession">$ sshfs my-user@example.com:/my-dir /mnt/my-dir
</code></pre><p>Like any other FUSE file system, the directory is unmounted using:</p><pre><code class="programlisting ShellSession">$ fusermount -u /mnt/my-dir
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-sshfs-non-interactive" class="title" >Non-interactive mounting   </h3>  </div> </div></div><p>Mounting non-interactively requires some precautions because <code class="literal">sshfs</code> will run at boot and under a different user (root).
For obvious reason, you can’t input a password, so public key authentication using an unencrypted key is needed.
To create a new key without a passphrase you can do:</p><pre><code class="programlisting ShellSession">$ ssh-keygen -t ed25519 -P &#x27;&#x27; -f example-key
Generating public/private ed25519 key pair.
Your identification has been saved in example-key
Your public key has been saved in example-key.pub
The key fingerprint is:
SHA256:yjxl3UbTn31fLWeyLYTAKYJPRmzknjQZoyG8gSNEoIE my-user@workstation
</code></pre><p>To keep the key safe, change the ownership to <code class="literal">root:root</code> and make sure the permissions are <code class="literal">600</code>:
OpenSSH normally refuses to use the key if it’s not well-protected.</p><p>The file system can be configured in NixOS via the usual <a class="link" href="options.html#opt-fileSystems"  >fileSystems</a> option.
Here’s a typical setup:</p><pre><code class="programlisting nix">{
  fileSystems.&quot;/mnt/my-dir&quot; = {
    device = &quot;my-user@example.com:/my-dir/&quot;;
    fsType = &quot;sshfs&quot;;
    options =
      [ # Filesystem options
        &quot;allow_other&quot;          # for non-root access
        &quot;_netdev&quot;              # this is a network fs
        &quot;x-systemd.automount&quot;  # mount on demand

        # SSH options
        &quot;reconnect&quot;              # handle connection drops
        &quot;ServerAliveInterval=15&quot; # keep connections alive
        &quot;IdentityFile=/var/secrets/example-key&quot;
      ];
  };
}
</code></pre><p>More options from <code class="literal">ssh_config(5)</code> can be given as well, for example you can change the default SSH port or specify a jump proxy:</p><pre><code class="programlisting nix">{
  options =
    [ &quot;ProxyJump=bastion@example.com&quot;
      &quot;Port=22&quot;
    ];
}
</code></pre><p>It’s also possible to change the <code class="literal">ssh</code> command used by SSHFS to connect to the server.
For example:</p><pre><code class="programlisting nix">{
  options =
    [ (builtins.replaceStrings [&quot; &quot;] [&quot;\\040&quot;]
        &quot;ssh_command=${pkgs.openssh}/bin/ssh -v -L 8080:localhost:80&quot;)
    ];

}
</code></pre><div class="note"><h3 class="title">Note</h3><p>The escaping of spaces is needed because every option is written to the <code class="literal">/etc/fstab</code> file, which is a space-separated table.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-sshfs-troubleshooting" class="title" >Troubleshooting   </h4>  </div> </div></div><p>If you’re having a hard time figuring out why mounting is failing, you can add the option <code class="literal">&quot;debug&quot;</code>.
This enables a verbose log in SSHFS that you can access via:</p><pre><code class="programlisting ShellSession">$ journalctl -u $(systemd-escape -p /mnt/my-dir/).mount
Jun 22 11:41:18 workstation mount[87790]: SSHFS version 3.7.1
Jun 22 11:41:18 workstation mount[87793]: executing &lt;ssh&gt; &lt;-x&gt; &lt;-a&gt; &lt;-oClearAllForwardings=yes&gt; &lt;-oServerAliveInterval=15&gt; &lt;-oIdentityFile=/var/secrets/wrong-key&gt; &lt;-2&gt; &lt;my-user@example.com&gt; &lt;-s&gt; &lt;sftp&gt;
Jun 22 11:41:19 workstation mount[87793]: my-user@example.com: Permission denied (publickey).
Jun 22 11:41:19 workstation mount[87790]: read: Connection reset by peer
Jun 22 11:41:19 workstation systemd[1]: mnt-my\x2ddir.mount: Mount process exited, code=exited, status=1/FAILURE
Jun 22 11:41:19 workstation systemd[1]: mnt-my\x2ddir.mount: Failed with result &#x27;exit-code&#x27;.
Jun 22 11:41:19 workstation systemd[1]: Failed to mount /mnt/my-dir.
Jun 22 11:41:19 workstation systemd[1]: mnt-my\x2ddir.mount: Consumed 54ms CPU time, received 2.3K IP traffic, sent 2.7K IP traffic.
</code></pre><div class="note"><h3 class="title">Note</h3><p>If the mount point contains special characters it needs to be escaped using <code class="literal">systemd-escape</code>.
This is due to the way systemd converts paths into unit names.</p></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-overlayfs" class="title" style="clear: both">Overlayfs   </h2>  </div> </div></div><p>NixOS offers a convenient abstraction to create both read-only as well writable
overlays.</p><pre><code class="programlisting nix">{
  fileSystems = {
    &quot;/writable-overlay&quot; = {
      overlay = {
        lowerdir = [ writableOverlayLowerdir ];
        upperdir = &quot;/.rw-writable-overlay/upper&quot;;
        workdir = &quot;/.rw-writable-overlay/work&quot;;
      };
      # Mount the writable overlay in the initrd.
      neededForBoot = true;
    };
    &quot;/readonly-overlay&quot;.overlay.lowerdir = [
      writableOverlayLowerdir
      writableOverlayLowerdir2
    ];
  };
}
</code></pre><p>If <code class="literal">upperdir</code> and <code class="literal">workdir</code> are not null, they will be created before the
overlay is mounted.</p><p>To mount an overlay as read-only, you need to provide at least two <code class="literal">lowerdir</code>s.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11" class="title" >X Window System   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-x11-auto-login">Auto-login</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-x11-startx">Running X without a display manager</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-x11--graphics-cards-intel">Intel Graphics drivers</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-x11-graphics-cards-nvidia">Proprietary NVIDIA drivers</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-x11-touchpads">Touchpads</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-x11-gtk-and-qt-themes">GTK/Qt themes</a> </span></dt><dt> <span class="section">  <a href="index.html#custom-xkb-layouts">Custom XKB layouts</a> </span></dt> </dl></div><p>The X Window System (X11) provides the basis of NixOS’ graphical user
interface. It can be enabled as follows:</p><pre><code class="programlisting nix">{
  services.xserver.enable = true;
}
</code></pre><p>The X server will automatically detect and use the appropriate video
driver from a set of X.org drivers (such as <code class="literal">vesa</code> and <code class="literal">intel</code>). You can
also specify a driver manually, e.g.</p><pre><code class="programlisting nix">{
  services.xserver.videoDrivers = [ &quot;r128&quot; ];
}
</code></pre><p>to enable X.org’s <code class="literal">xf86-video-r128</code> driver.</p><p>You also need to enable at least one desktop or window manager.
Otherwise, you can only log into a plain undecorated <code class="literal">xterm</code> window.
Thus you should pick one or more of the following lines:</p><pre><code class="programlisting nix">{
  services.xserver.desktopManager.plasma5.enable = true;
  services.xserver.desktopManager.xfce.enable = true;
  services.xserver.desktopManager.gnome.enable = true;
  services.xserver.desktopManager.mate.enable = true;
  services.xserver.windowManager.xmonad.enable = true;
  services.xserver.windowManager.twm.enable = true;
  services.xserver.windowManager.icewm.enable = true;
  services.xserver.windowManager.i3.enable = true;
  services.xserver.windowManager.herbstluftwm.enable = true;
}
</code></pre><p>NixOS’s default <span class="emphasis"><em>display manager</em></span> (the program that provides a graphical
login prompt and manages the X server) is LightDM. You can select an
alternative one by picking one of the following lines:</p><pre><code class="programlisting nix">{
  services.displayManager.sddm.enable = true;
  services.xserver.displayManager.gdm.enable = true;
}
</code></pre><p>You can set the keyboard layout (and optionally the layout variant):</p><pre><code class="programlisting nix">{
  services.xserver.xkb.layout = &quot;de&quot;;
  services.xserver.xkb.variant = &quot;neo&quot;;
}
</code></pre><p>The X server is started automatically at boot time. If you don’t want
this to happen, you can set:</p><pre><code class="programlisting nix">{
  services.xserver.autorun = false;
}
</code></pre><p>The X server can then be started manually:</p><pre><code class="programlisting ShellSession"># systemctl start display-manager.service
</code></pre><p>On 64-bit systems, if you want OpenGL for 32-bit programs such as in
Wine, you should also set the following:</p><pre><code class="programlisting nix">{
  hardware.graphics.enable32Bit = true;
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11-auto-login" class="title" style="clear: both">Auto-login   </h2>  </div> </div></div><p>The x11 login screen can be skipped entirely, automatically logging you
into your window manager and desktop environment when you boot your
computer.</p><p>This is especially helpful if you have disk encryption enabled. Since
you already have to provide a password to decrypt your disk, entering a
second password to login can be redundant.</p><p>To enable auto-login, you need to define your default window manager and
desktop environment. If you wanted no desktop environment and i3 as your
your window manager, you’d define:</p><pre><code class="programlisting nix">{
  services.displayManager.defaultSession = &quot;none+i3&quot;;
}
</code></pre><p>Every display manager in NixOS supports auto-login, here is an example
using lightdm for a user <code class="literal">alice</code>:</p><pre><code class="programlisting nix">{
  services.xserver.displayManager.lightdm.enable = true;
  services.displayManager.autoLogin.enable = true;
  services.displayManager.autoLogin.user = &quot;alice&quot;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11-startx" class="title" style="clear: both">Running X without a display manager   </h2>  </div> </div></div><p>It is possible to avoid a display manager entirely and starting the X server
manually from a virtual terminal. Add to your configuration:</p><pre><code class="programlisting nix">{
  services.xserver.displayManager.startx = {
    enable = true;
    generateScript = true;
  };
}
</code></pre><p>then you can start the X server with the <code class="literal">startx</code> command.</p><p>The second option will generate a base <code class="literal">xinitrc</code> script that will run your
window manager and set up the systemd user session.
You can extend the script using the
<a class="link" href="options.html#opt-services.xserver.displayManager.startx.extraCommands"  >extraCommands</a>
option, for example:</p><pre><code class="programlisting nix">{
  services.xserver.displayManager.startx = {
    generateScript = true;
    extraCommands = &#x27;&#x27;
      xrdb -load .Xresources
      xsetroot -solid &#x27;#666661&#x27;
      xsetroot -cursor_name left_ptr
    &#x27;&#x27;;
  };
}
</code></pre><p>or, alternatively, you can write your own from scratch in <code class="literal">~/.xinitrc</code>.</p><p>In this case, remember you’re responsible for starting the window manager, for
example:</p><pre><code class="programlisting shell">sxhkd &amp;
bspwm &amp;
</code></pre><p>and if you have enabled some systemd user service, you will probably want to
also add these lines too:</p><pre><code class="programlisting shell"># import required env variables from the current shell
systemctl --user import-environment DISPLAY XDG_SESSION_ID
# start all graphical user services
systemctl --user start nixos-fake-graphical-session.target
# start the user dbus daemon
dbus-daemon --session --address=&quot;unix:path=/run/user/$(id -u)/bus&quot; &amp;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11--graphics-cards-intel" class="title" style="clear: both">Intel Graphics drivers   </h2>  </div> </div></div><p>The default and recommended driver for Intel Graphics in X.org is <code class="literal">modesetting</code>
(included in the xorg-server package itself).
This is a generic driver which uses the kernel <a class="link" href="https://en.wikipedia.org/wiki/Mode_setting"  target="_top">mode
setting</a> (KMS) mechanism, it
supports Glamor (2D graphics acceleration via OpenGL) and is actively
maintained, it may perform worse in some cases (like in old chipsets).</p><p>There is a second driver, <code class="literal">intel</code> (provided by the xf86-video-intel package),
specific to older Intel iGPUs from generation 2 to 9. It is not recommended by
most distributions: it lacks several modern features (for example, it doesn’t
support Glamor) and the package hasn’t been officially updated since 2015.</p><p>Third generation and older iGPUs (15-20+ years old) are not supported by the
<code class="literal">modesetting</code> driver (X will crash upon startup). Thus, the <code class="literal">intel</code> driver is
required for these chipsets.
Otherwise, the results vary depending on the hardware, so you may have to try
both drivers. Use the option
<a class="xref" href="options.html#opt-services.xserver.videoDrivers"  ><code class="option">services.xserver.videoDrivers</code></a>
to set one. The recommended configuration for modern systems is:</p><pre><code class="programlisting nix">{
  services.xserver.videoDrivers = [ &quot;modesetting&quot; ];
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>The <code class="literal">modesetting</code> driver doesn’t currently provide a <code class="literal">TearFree</code> option (this
will become available in an upcoming X.org release), So, without using a
compositor (for example, see <a class="xref" href="options.html#opt-services.picom.enable"  ><code class="option">services.picom.enable</code></a>) you will
experience screen tearing.</p></div><p>If you experience screen tearing no matter what, this configuration was
reported to resolve the issue:</p><pre><code class="programlisting nix">{
  services.xserver.videoDrivers = [ &quot;intel&quot; ];
    services.xserver.deviceSection = &#x27;&#x27;
    Option &quot;DRI&quot; &quot;2&quot;
    Option &quot;TearFree&quot; &quot;true&quot;
  &#x27;&#x27;;
}
</code></pre><p>Note that this will likely downgrade the performance compared to
<code class="literal">modesetting</code> or <code class="literal">intel</code> with DRI 3 (default).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11-graphics-cards-nvidia" class="title" style="clear: both">Proprietary NVIDIA drivers   </h2>  </div> </div></div><p>NVIDIA provides a proprietary driver for its graphics cards that has
better 3D performance than the X.org drivers. It is not enabled by
default because it’s not free software. You can enable it as follows:</p><pre><code class="programlisting nix">{
  services.xserver.videoDrivers = [ &quot;nvidia&quot; ];
}
</code></pre><p>If you have an older card, you may have to use one of the legacy drivers:</p><pre><code class="programlisting nix">{
  hardware.nvidia.package = config.boot.kernelPackages.nvidiaPackages.legacy_470;
  hardware.nvidia.package = config.boot.kernelPackages.nvidiaPackages.legacy_390;
  hardware.nvidia.package = config.boot.kernelPackages.nvidiaPackages.legacy_340;
}
</code></pre><p>You may need to reboot after enabling this driver to prevent a clash
with other kernel modules.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11-touchpads" class="title" style="clear: both">Touchpads   </h2>  </div> </div></div><p>Support for Synaptics touchpads (found in many laptops such as the Dell
Latitude series) can be enabled as follows:</p><pre><code class="programlisting nix">{
  services.libinput.enable = true;
}
</code></pre><p>The driver has many options (see <a class="xref" href="options.html" title="Appendix A. Configuration Options" >Appendix&nbsp;A</a>).
For instance, the following disables tap-to-click behavior:</p><pre><code class="programlisting nix">{
  services.libinput.touchpad.tapping = false;
}
</code></pre><p>Note: the use of <code class="literal">services.xserver.synaptics</code> is deprecated since NixOS
17.09.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11-gtk-and-qt-themes" class="title" style="clear: both">GTK/Qt themes   </h2>  </div> </div></div><p>GTK themes can be installed either to user profile or system-wide (via
<code class="literal">environment.systemPackages</code>). To make Qt 5 applications look similar to
GTK ones, you can use the following configuration:</p><pre><code class="programlisting nix">{
  qt.enable = true;
  qt.platformTheme = &quot;gtk2&quot;;
  qt.style = &quot;gtk2&quot;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="custom-xkb-layouts" class="title" style="clear: both">Custom XKB layouts   </h2>  </div> </div></div><p>It is possible to install custom <a class="link" href="https://en.wikipedia.org/wiki/X_keyboard_extension"  target="_top"> XKB
</a> keyboard layouts
using the option <code class="literal">services.xserver.xkb.extraLayouts</code>.</p><p>As a first example, we are going to create a layout based on the basic
US layout, with an additional layer to type some greek symbols by
pressing the right-alt key.</p><p>Create a file called <code class="literal">us-greek</code> with the following content (under a
directory called <code class="literal">symbols</code>; it’s an XKB peculiarity that will help with
testing):</p><pre><code class="programlisting">xkb_symbols &quot;us-greek&quot;
{
  include &quot;us(basic)&quot;            // includes the base US keys
  include &quot;level3(ralt_switch)&quot;  // configures right alt as a third level switch

  key &lt;LatA&gt; { [ a, A, Greek_alpha ] };
  key &lt;LatB&gt; { [ b, B, Greek_beta  ] };
  key &lt;LatG&gt; { [ g, G, Greek_gamma ] };
  key &lt;LatD&gt; { [ d, D, Greek_delta ] };
  key &lt;LatZ&gt; { [ z, Z, Greek_zeta  ] };
};
</code></pre><p>A minimal layout specification must include the following:</p><pre><code class="programlisting nix">{
  services.xserver.xkb.extraLayouts.us-greek = {
    description = &quot;US layout with alt-gr greek&quot;;
    languages   = [ &quot;eng&quot; ];
    symbolsFile = /yourpath/symbols/us-greek;
  };
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>The name (after <code class="literal">extraLayouts.</code>) should match the one given to the
<code class="literal">xkb_symbols</code> block.</p></div><p>Applying this customization requires rebuilding several packages, and a
broken XKB file can lead to the X session crashing at login. Therefore,
you’re strongly advised to <span class="strong"><strong>test your layout before applying it</strong></span>:</p><pre><code class="programlisting ShellSession">$ nix-shell -p xorg.xkbcomp
$ setxkbmap -I/yourpath us-greek -print | xkbcomp -I/yourpath - $DISPLAY
</code></pre><p>You can inspect the predefined XKB files for examples:</p><pre><code class="programlisting ShellSession">$ echo &quot;$(nix-build --no-out-link &#x27;&lt;nixpkgs&gt;&#x27; -A xorg.xkeyboardconfig)/etc/X11/xkb/&quot;
</code></pre><p>Once the configuration is applied, and you did a logout/login cycle, the
layout should be ready to use. You can try it by e.g. running
<code class="literal">setxkbmap us-greek</code> and then type <code class="literal">&lt;alt&gt;+a</code> (it may not get applied in
your terminal straight away). To change the default, the usual
<code class="literal">services.xserver.xkb.layout</code> option can still be used.</p><p>A layout can have several other components besides <code class="literal">xkb_symbols</code>, for
example we will define new keycodes for some multimedia key and bind
these to some symbol.</p><p>Use the <span class="emphasis"><em>xev</em></span> utility from <code class="literal">pkgs.xorg.xev</code> to find the codes of the keys
of interest, then create a <code class="literal">media-key</code> file to hold the keycodes
definitions</p><pre><code class="programlisting">xkb_keycodes &quot;media&quot;
{
 &lt;volUp&gt;   = 123;
 &lt;volDown&gt; = 456;
}
</code></pre><p>Now use the newly define keycodes in <code class="literal">media-sym</code>:</p><pre><code class="programlisting">xkb_symbols &quot;media&quot;
{
 key.type = &quot;ONE_LEVEL&quot;;
 key &lt;volUp&gt;   { [ XF86AudioLowerVolume ] };
 key &lt;volDown&gt; { [ XF86AudioRaiseVolume ] };
}
</code></pre><p>As before, to install the layout do</p><pre><code class="programlisting nix">{
  services.xserver.xkb.extraLayouts.media = {
    description  = &quot;Multimedia keys remapping&quot;;
    languages    = [ &quot;eng&quot; ];
    symbolsFile  = /path/to/media-key;
    keycodesFile = /path/to/media-sym;
  };
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>The function <code class="literal">pkgs.writeText &lt;filename&gt; &lt;content&gt;</code> can be useful if you
prefer to keep the layout definitions inside the NixOS configuration.</p></div><p>Unfortunately, the Xorg server does not (currently) support setting a
keymap directly but relies instead on XKB rules to select the matching
components (keycodes, types, …) of a layout. This means that
components other than symbols won’t be loaded by default. As a
workaround, you can set the keymap using <code class="literal">setxkbmap</code> at the start of the
session with:</p><pre><code class="programlisting nix">{
  services.xserver.displayManager.sessionCommands = &quot;setxkbmap -keycodes media&quot;;
}
</code></pre><p>If you are manually starting the X server, you should set the argument
<code class="literal">-xkbdir /etc/X11/xkb</code>, otherwise X won’t find your layout files. For
example with <code class="literal">xinit</code> run</p><pre><code class="programlisting ShellSession">$ xinit -- -xkbdir /etc/X11/xkb
</code></pre><p>To learn how to write layouts take a look at the XKB <a class="link" href="https://www.x.org/releases/current/doc/xorg-docs/input/XKB-Enhancing.html#Defining_New_Layouts"  target="_top">documentation
</a>.
More example layouts can also be found <a class="link" href="https://wiki.archlinux.org/index.php/X_KeyBoard_extension#Basic_examples"  target="_top">here
</a>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-wayland" class="title" >Wayland   </h2>  </div> </div></div><p>While X11 (see <a class="xref" href="index.html#sec-x11" title="X Window System" ><em>X Window System</em></a>) is still the primary display technology
on NixOS, Wayland support is steadily improving. Where X11 separates the
X Server and the window manager, on Wayland those are combined: a
Wayland Compositor is like an X11 window manager, but also embeds the
Wayland ‘Server’ functionality. This means it is sufficient to install
a Wayland Compositor such as sway without separately enabling a Wayland
server:</p><pre><code class="programlisting nix">{
programs.sway.enable = true;
}
</code></pre><p>This installs the sway compositor along with some essential utilities.
Now you can start sway from the TTY console.</p><p>If you are using a wlroots-based compositor, like sway, and want to be
able to share your screen, make sure to configure Pipewire using
<a class="xref" href="options.html#opt-services.pipewire.enable"  ><code class="option">services.pipewire.enable</code></a>
and related options.</p><p>For more helpful tips and tricks, see the
<a class="link" href="https://wiki.nixos.org/wiki/Sway"  target="_top">wiki page about Sway</a>.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gpu-accel" class="title" >GPU acceleration   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-gpu-accel-opencl">OpenCL</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-gpu-accel-vulkan">Vulkan</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-gpu-accel-va-api">VA-API</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-gpu-accel-common-issues">Common issues</a> </span></dt> </dl></div><p>NixOS provides various APIs that benefit from GPU hardware acceleration,
such as VA-API and VDPAU for video playback; OpenGL and Vulkan for 3D
graphics; and OpenCL for general-purpose computing. This chapter
describes how to set up GPU hardware acceleration (as far as this is not
done automatically) and how to verify that hardware acceleration is
indeed used.</p><p>Most of the aforementioned APIs are agnostic with regards to which
display server is used. Consequently, these instructions should apply
both to the X Window System and Wayland compositors.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gpu-accel-opencl" class="title" style="clear: both">OpenCL   </h2>  </div> </div></div><p><a class="link" href="https://en.wikipedia.org/wiki/OpenCL"  target="_top">OpenCL</a> is a general compute API.
It is used by various applications such as Blender and Darktable to
accelerate certain operations.</p><p>OpenCL applications load drivers through the <span class="emphasis"><em>Installable Client Driver</em></span>
(ICD) mechanism. In this mechanism, an ICD file specifies the path to
the OpenCL driver for a particular GPU family. In NixOS, there are two
ways to make ICD files visible to the ICD loader. The first is through
the <code class="literal">OCL_ICD_VENDORS</code> environment variable. This variable can contain a
directory which is scanned by the ICL loader for ICD files. For example:</p><pre><code class="programlisting ShellSession">$ export \
  OCL_ICD_VENDORS=`nix-build &#x27;&lt;nixpkgs&gt;&#x27; --no-out-link -A rocmPackages.clr.icd`/etc/OpenCL/vendors/
</code></pre><p>The second mechanism is to add the OpenCL driver package to
<a class="xref" href="options.html#opt-hardware.graphics.extraPackages"  ><code class="option">hardware.graphics.extraPackages</code></a>.
This links the ICD file under <code class="literal">/run/opengl-driver</code>, where it will be visible
to the ICD loader.</p><p>The proper installation of OpenCL drivers can be verified through the
<code class="literal">clinfo</code> command of the clinfo package. This command will report the
number of hardware devices that is found and give detailed information
for each device:</p><pre><code class="programlisting ShellSession">$ clinfo | head -n3
Number of platforms  1
Platform Name        AMD Accelerated Parallel Processing
Platform Vendor      Advanced Micro Devices, Inc.
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-opencl-amd" class="title" >AMD   </h3>  </div> </div></div><p>Modern AMD <a class="link" href="https://en.wikipedia.org/wiki/Graphics_Core_Next"  target="_top">Graphics Core
Next</a> (GCN) GPUs are
supported through the rocmPackages.clr.icd package. Adding this package to
<a class="xref" href="options.html#opt-hardware.graphics.extraPackages"  ><code class="option">hardware.graphics.extraPackages</code></a>
enables OpenCL support:</p><pre><code class="programlisting nix">{
  hardware.graphics.extraPackages = [
    rocmPackages.clr.icd
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-opencl-intel" class="title" >Intel   </h3>  </div> </div></div><p><a class="link" href="https://en.wikipedia.org/wiki/List_of_Intel_graphics_processing_units#Gen12"  target="_top">Intel Gen12 and later GPUs</a>
are supported by the Intel NEO OpenCL runtime that is provided by the <code class="literal">intel-compute-runtime</code> package.
The previous generations (8,9 and 11), have been moved to the <code class="literal">intel-compute-runtime-legacy1</code> package.
The proprietary Intel OpenCL runtime, in the <code class="literal">intel-ocl</code> package, is an alternative for Gen7 GPUs.</p><p>Both <code class="literal">intel-compute-runtime</code> packages, as well as the <code class="literal">intel-ocl</code> package can be added to
<a class="xref" href="options.html#opt-hardware.graphics.extraPackages"  ><code class="option">hardware.graphics.extraPackages</code></a>
to enable OpenCL support. For example, for Gen12 and later GPUs, the following
configuration can be used:</p><pre><code class="programlisting nix">{
  hardware.graphics.extraPackages = [
    intel-compute-runtime
  ];
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gpu-accel-vulkan" class="title" style="clear: both">Vulkan   </h2>  </div> </div></div><p><a class="link" href="https://en.wikipedia.org/wiki/Vulkan_(API)"  target="_top">Vulkan</a> is a graphics and
compute API for GPUs. It is used directly by games or indirectly though
compatibility layers like
<a class="link" href="https://github.com/doitsujin/dxvk/wiki"  target="_top">DXVK</a>.</p><p>By default, if <a class="xref" href="options.html#opt-hardware.graphics.enable"  ><code class="option">hardware.graphics.enable</code></a>
is enabled, Mesa is installed and provides Vulkan for supported hardware.</p><p>Similar to OpenCL, Vulkan drivers are loaded through the <span class="emphasis"><em>Installable
Client Driver</em></span> (ICD) mechanism. ICD files for Vulkan are JSON files that
specify the path to the driver library and the supported Vulkan version.
All successfully loaded drivers are exposed to the application as
different GPUs. In NixOS, there are two ways to make ICD files visible
to Vulkan applications: an environment variable and a module option.</p><p>The first option is through the <code class="literal">VK_ICD_FILENAMES</code> environment variable.
This variable can contain multiple JSON files, separated by <code class="literal">:</code>. For
example:</p><pre><code class="programlisting ShellSession">$ export \
  VK_ICD_FILENAMES=`nix-build &#x27;&lt;nixpkgs&gt;&#x27; --no-out-link -A amdvlk`/share/vulkan/icd.d/amd_icd64.json
</code></pre><p>The second mechanism is to add the Vulkan driver package to
<a class="xref" href="options.html#opt-hardware.graphics.extraPackages"  ><code class="option">hardware.graphics.extraPackages</code></a>.
This links the ICD file under <code class="literal">/run/opengl-driver</code>, where it will be
visible to the ICD loader.</p><p>The proper installation of Vulkan drivers can be verified through the
<code class="literal">vulkaninfo</code> command of the vulkan-tools package. This command will
report the hardware devices and drivers found, in this example output
amdvlk and radv:</p><pre><code class="programlisting ShellSession">$ vulkaninfo | grep GPU
                GPU id  : 0 (Unknown AMD GPU)
                GPU id  : 1 (AMD RADV NAVI10 (LLVM 9.0.1))
     ...
GPU0:
        deviceType     = PHYSICAL_DEVICE_TYPE_DISCRETE_GPU
        deviceName     = Unknown AMD GPU
GPU1:
        deviceType     = PHYSICAL_DEVICE_TYPE_DISCRETE_GPU
</code></pre><p>A simple graphical application that uses Vulkan is <code class="literal">vkcube</code> from the
vulkan-tools package.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-vulkan-amd" class="title" >AMD   </h3>  </div> </div></div><p>Modern AMD <a class="link" href="https://en.wikipedia.org/wiki/Graphics_Core_Next"  target="_top">Graphics Core
Next</a> (GCN) GPUs are
supported through either radv, which is part of mesa, or the amdvlk
package. Adding the amdvlk package to
<a class="xref" href="options.html#opt-hardware.graphics.extraPackages"  ><code class="option">hardware.graphics.extraPackages</code></a>
makes amdvlk the default driver and hides radv and lavapipe from the device list.
A specific driver can be forced as follows:</p><pre><code class="programlisting nix">{
  hardware.graphics.extraPackages = [
    pkgs.amdvlk
  ];

  # To enable Vulkan support for 32-bit applications, also add:
  hardware.graphics.extraPackages32 = [
    pkgs.driversi686Linux.amdvlk
  ];

  # Force radv
  environment.variables.AMD_VULKAN_ICD = &quot;RADV&quot;;
  # Or
  environment.variables.VK_ICD_FILENAMES =
    &quot;/run/opengl-driver/share/vulkan/icd.d/radeon_icd.x86_64.json&quot;;
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gpu-accel-va-api" class="title" style="clear: both">VA-API   </h2>  </div> </div></div><p><a class="link" href="https://www.intel.com/content/www/us/en/developer/articles/technical/linuxmedia-vaapi.html"  target="_top">VA-API (Video Acceleration API)</a>
is an open-source library and API specification, which provides access to
graphics hardware acceleration capabilities for video processing.</p><p>VA-API drivers are loaded by <code class="literal">libva</code>. The version in nixpkgs is built to search
the opengl driver path, so drivers can be installed in
<a class="xref" href="options.html#opt-hardware.graphics.extraPackages"  ><code class="option">hardware.graphics.extraPackages</code></a>.</p><p>VA-API can be tested using:</p><pre><code class="programlisting ShellSession">$ nix-shell -p libva-utils --run vainfo
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-va-api-intel" class="title" >Intel   </h3>  </div> </div></div><p>Modern Intel GPUs use the iHD driver, which can be installed with:</p><pre><code class="programlisting nix">{
  hardware.graphics.extraPackages = [
    intel-media-driver
  ];
}
</code></pre><p>Older Intel GPUs use the i965 driver, which can be installed with:</p><pre><code class="programlisting nix">{
  hardware.graphics.extraPackages = [
    intel-vaapi-driver
  ];
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gpu-accel-common-issues" class="title" style="clear: both">Common issues   </h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-common-issues-permissions" class="title" >User permissions   </h3>  </div> </div></div><p>Except where noted explicitly, it should not be necessary to adjust user
permissions to use these acceleration APIs. In the default
configuration, GPU devices have world-read/write permissions
(<code class="literal">/dev/dri/renderD*</code>) or are tagged as <code class="literal">uaccess</code> (<code class="literal">/dev/dri/card*</code>). The
access control lists of devices with the <code class="literal">uaccess</code> tag will be updated
automatically when a user logs in through <code class="literal">systemd-logind</code>. For example,
if the user <span class="emphasis"><em>alice</em></span> is logged in, the access control list should look as
follows:</p><pre><code class="programlisting ShellSession">$ getfacl /dev/dri/card0
# file: dev/dri/card0
# owner: root
# group: video
user::rw-
user:alice:rw-
group::rw-
mask::rw-
other::---
</code></pre><p>If you disabled (this functionality of) <code class="literal">systemd-logind</code>, you may need
to add the user to the <code class="literal">video</code> group and log in again.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-common-issues-mixing-nixpkgs" class="title" >Mixing different versions of nixpkgs   </h3>  </div> </div></div><p>The <span class="emphasis"><em>Installable Client Driver</em></span> (ICD) mechanism used by OpenCL and
Vulkan loads runtimes into its address space using <code class="literal">dlopen</code>. Mixing an
ICD loader mechanism and runtimes from different version of nixpkgs may
not work. For example, if the ICD loader uses an older version of glibc
than the runtime, the runtime may not be loadable due to missing
symbols. Unfortunately, the loader will generally be quiet about such
issues.</p><p>If you suspect that you are running into library version mismatches
between an ICL loader and a runtime, you could run an application with
the <code class="literal">LD_DEBUG</code> variable set to get more diagnostic information. For
example, OpenCL can be tested with <code class="literal">LD_DEBUG=files clinfo</code>, which should
report missing symbols.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-xfce" class="title" >Xfce Desktop Environment   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-xfce-thunar-plugins">Thunar</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-xfce-troubleshooting">Troubleshooting</a> </span></dt> </dl></div><p>To enable the Xfce Desktop Environment, set</p><pre><code class="programlisting nix">{
  services.xserver.desktopManager.xfce.enable = true;
  services.displayManager.defaultSession = &quot;xfce&quot;;
}
</code></pre><p>Optionally, <span class="emphasis"><em>picom</em></span> can be enabled for nice graphical effects, some
example settings:</p><pre><code class="programlisting nix">{
  services.picom = {
    enable = true;
    fade = true;
    inactiveOpacity = 0.9;
    shadow = true;
    fadeDelta = 4;
  };
}
</code></pre><p>Some Xfce programs are not installed automatically. To install them
manually (system wide), put them into your
<a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a> from <code class="literal">pkgs.xfce</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-xfce-thunar-plugins" class="title" style="clear: both">Thunar   </h2>  </div> </div></div><p>Thunar (the Xfce file manager) is automatically enabled when Xfce is
enabled. To enable Thunar without enabling Xfce, use the configuration
option <a class="xref" href="options.html#opt-programs.thunar.enable"  ><code class="option">programs.thunar.enable</code></a> instead of adding
<code class="literal">pkgs.xfce.thunar</code> to <a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a>.</p><p>If you’d like to add extra plugins to Thunar, add them to
<a class="xref" href="options.html#opt-programs.thunar.plugins"  ><code class="option">programs.thunar.plugins</code></a>. You shouldn’t just add them to
<a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-xfce-troubleshooting" class="title" style="clear: both">Troubleshooting   </h2>  </div> </div></div><p>Even after enabling udisks2, volume management might not work. Thunar
and/or the desktop takes time to show up. Thunar will spit out this kind
of message on start (look at <code class="literal">journalctl --user -b</code>).</p><pre><code class="programlisting plain">Thunar:2410): GVFS-RemoteVolumeMonitor-WARNING **: remote volume monitor with dbus name org.gtk.Private.UDisks2VolumeMonitor is not supported
</code></pre><p>This is caused by some needed GNOME services not running. This is all
fixed by enabling “Launch GNOME services on startup” in the Advanced
tab of the Session and Startup settings panel. Alternatively, you can
run this command to do the same thing.</p><pre><code class="programlisting ShellSession">$ xfconf-query -c xfce4-session -p /compat/LaunchGNOME -s true
</code></pre><p>It is necessary to log out and log in again for this to take effect.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-networking" class="title" >Networking   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-networkmanager">NetworkManager</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-ssh">Secure Shell Access</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-ipv4">IPv4 Configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-ipv6">IPv6 Configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-firewall">Firewall</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-wireless">Wireless Networks</a> </span></dt><dt> <span class="section">  <a href="index.html#ad-hoc-network-config">Ad-Hoc Configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-rename-ifs">Renaming network interfaces</a> </span></dt> </dl></div><p>This section describes how to configure networking components
on your NixOS machine.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-networkmanager" class="title" style="clear: both">NetworkManager   </h2>  </div> </div></div><p>To facilitate network configuration, some desktop environments use
NetworkManager. You can enable NetworkManager by setting:</p><pre><code class="programlisting nix">{
  networking.networkmanager.enable = true;
}
</code></pre><p>some desktop managers (e.g., GNOME) enable NetworkManager automatically
for you.</p><p>All users that should have permission to change network settings must
belong to the <code class="literal">networkmanager</code> group:</p><pre><code class="programlisting nix">{
  users.users.alice.extraGroups = [ &quot;networkmanager&quot; ];
}
</code></pre><p>NetworkManager is controlled using either <code class="literal">nmcli</code> or <code class="literal">nmtui</code>
(curses-based terminal user interface). See their manual pages for
details on their usage. Some desktop environments (GNOME, KDE) have
their own configuration tools for NetworkManager. On XFCE, there is no
configuration tool for NetworkManager by default: by enabling
<a class="xref" href="options.html#opt-programs.nm-applet.enable"  ><code class="option">programs.nm-applet.enable</code></a>, the graphical applet will be
installed and will launch automatically when the graphical session is
started.</p><div class="note"><h3 class="title">Note</h3><p><code class="literal">networking.networkmanager</code> and <code class="literal">networking.wireless</code> (WPA Supplicant)
can be used together if desired. To do this you need to instruct
NetworkManager to ignore those interfaces like:</p><pre><code class="programlisting nix">{
  networking.networkmanager.unmanaged = [
     &quot;*&quot; &quot;except:type:wwan&quot; &quot;except:type:gsm&quot;
  ];
}
</code></pre><p>Refer to the option description for the exact syntax and references to
external documentation.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-ssh" class="title" style="clear: both">Secure Shell Access   </h2>  </div> </div></div><p>Secure shell (SSH) access to your machine can be enabled by setting:</p><pre><code class="programlisting nix">{
  services.openssh.enable = true;
}
</code></pre><p>By default, root logins using a password are disallowed. They can be
disabled entirely by setting
<a class="xref" href="options.html#opt-services.openssh.settings.PermitRootLogin"  ><code class="option">services.openssh.settings.PermitRootLogin</code></a> to <code class="literal">&quot;no&quot;</code>.</p><p>You can declaratively specify authorised public keys for a user
as follows:</p><pre><code class="programlisting nix">{
  users.users.alice.openssh.authorizedKeys.keys =
    [ &quot;ssh-ed25519 AAAAB3NzaC1kc3MAAACBAPIkGWVEt4...&quot; ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-ipv4" class="title" style="clear: both">IPv4 Configuration   </h2>  </div> </div></div><p>By default, NixOS uses DHCP (specifically, <code class="literal">dhcpcd</code>) to automatically
configure network interfaces. However, you can configure an interface
manually as follows:</p><pre><code class="programlisting nix">{
  networking.interfaces.eth0.ipv4.addresses = [ {
    address = &quot;192.168.1.2&quot;;
    prefixLength = 24;
  } ];
}
</code></pre><p>Typically you’ll also want to set a default gateway and set of name
servers:</p><pre><code class="programlisting nix">{
  networking.defaultGateway = &quot;192.168.1.1&quot;;
  networking.nameservers = [ &quot;8.8.8.8&quot; ];
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>Statically configured interfaces are set up by the systemd service
<code class="literal">interface-name-cfg.service</code>. The default gateway and name server
configuration is performed by <code class="literal">network-setup.service</code>.</p></div><p>The host name is set using <a class="xref" href="options.html#opt-networking.hostName"  ><code class="option">networking.hostName</code></a>:</p><pre><code class="programlisting nix">{
  networking.hostName = &quot;cartman&quot;;
}
</code></pre><p>The default host name is <code class="literal">nixos</code>. Set it to the empty string (<code class="literal">&quot;&quot;</code>) to
allow the DHCP server to provide the host name.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-ipv6" class="title" style="clear: both">IPv6 Configuration   </h2>  </div> </div></div><p>IPv6 is enabled by default. Stateless address autoconfiguration is used
to automatically assign IPv6 addresses to all interfaces, and Privacy
Extensions (RFC 4946) are enabled by default. You can adjust the default
for this by setting <a class="xref" href="options.html#opt-networking.tempAddresses"  ><code class="option">networking.tempAddresses</code></a>. This option
may be overridden on a per-interface basis by
<a class="xref" href="options.html#opt-networking.interfaces._name_.tempAddress"  ><code class="option">networking.interfaces.&lt;name&gt;.tempAddress</code></a>. You can disable
IPv6 support globally by setting:</p><pre><code class="programlisting nix">{
  networking.enableIPv6 = false;
}
</code></pre><p>You can disable IPv6 on a single interface using a normal sysctl (in
this example, we use interface <code class="literal">eth0</code>):</p><pre><code class="programlisting nix">{
  boot.kernel.sysctl.&quot;net.ipv6.conf.eth0.disable_ipv6&quot; = true;
}
</code></pre><p>As with IPv4 networking interfaces are automatically configured via
DHCPv6. You can configure an interface manually:</p><pre><code class="programlisting nix">{
  networking.interfaces.eth0.ipv6.addresses = [ {
    address = &quot;fe00:aa:bb:cc::2&quot;;
    prefixLength = 64;
  } ];
}
</code></pre><p>For configuring a gateway, optionally with explicitly specified
interface:</p><pre><code class="programlisting nix">{
  networking.defaultGateway6 = {
    address = &quot;fe00::1&quot;;
    interface = &quot;enp0s3&quot;;
  };
}
</code></pre><p>See <a class="xref" href="index.html#sec-ipv4" title="IPv4 Configuration" >the section called “IPv4 Configuration”</a> for similar examples and additional information.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-firewall" class="title" style="clear: both">Firewall   </h2>  </div> </div></div><p>NixOS has a simple stateful firewall that blocks incoming connections
and other unexpected packets. The firewall applies to both IPv4 and IPv6
traffic. It is enabled by default. It can be disabled as follows:</p><pre><code class="programlisting nix">{
  networking.firewall.enable = false;
}
</code></pre><p>If the firewall is enabled, you can open specific TCP ports to the
outside world:</p><pre><code class="programlisting nix">{
  networking.firewall.allowedTCPPorts = [ 80 443 ];
}
</code></pre><p>Note that TCP port 22 (ssh) is opened automatically if the SSH daemon is
enabled (<code class="literal">services.openssh.enable = true</code>). UDP ports can be opened through
<a class="xref" href="options.html#opt-networking.firewall.allowedUDPPorts"  ><code class="option">networking.firewall.allowedUDPPorts</code></a>.</p><p>To open ranges of TCP ports:</p><pre><code class="programlisting nix">{
  networking.firewall.allowedTCPPortRanges = [
    { from = 4000; to = 4007; }
    { from = 8000; to = 8010; }
  ];
}
</code></pre><p>Similarly, UDP port ranges can be opened through
<a class="xref" href="options.html#opt-networking.firewall.allowedUDPPortRanges"  ><code class="option">networking.firewall.allowedUDPPortRanges</code></a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-wireless" class="title" style="clear: both">Wireless Networks   </h2>  </div> </div></div><p>For a desktop installation using NetworkManager (e.g., GNOME), you just
have to make sure the user is in the <code class="literal">networkmanager</code> group and you can
skip the rest of this section on wireless networks.</p><p>NixOS will start wpa_supplicant for you if you enable this setting:</p><pre><code class="programlisting nix">{
  networking.wireless.enable = true;
}
</code></pre><p>NixOS lets you specify networks for wpa_supplicant declaratively:</p><pre><code class="programlisting nix">{
  networking.wireless.networks = {
    echelon = {                # SSID with no spaces or special characters
      psk = &quot;abcdefgh&quot;;
    };
    &quot;echelon&#x27;s AP&quot; = {         # SSID with spaces and/or special characters
      psk = &quot;ijklmnop&quot;;
    };
    echelon = {                # Hidden SSID
      hidden = true;
      psk = &quot;qrstuvwx&quot;;
    };
    free.wifi = {};            # Public wireless network
  };
}
</code></pre><p>Be aware that keys will be written to the nix store in plaintext! When
no networks are set, it will default to using a configuration file at
<code class="literal">/etc/wpa_supplicant.conf</code>. You should edit this file yourself to define
wireless networks, WPA keys and so on (see wpa_supplicant.conf(5)).</p><p>If you are using WPA2 you can generate pskRaw key using
<code class="literal">wpa_passphrase</code>:</p><pre><code class="programlisting ShellSession">$ wpa_passphrase ESSID PSK
network={
        ssid=&quot;echelon&quot;
        #psk=&quot;abcdefgh&quot;
        psk=dca6d6ed41f4ab5a984c9f55f6f66d4efdc720ebf66959810f4329bb391c5435
}
</code></pre><pre><code class="programlisting nix">{
  networking.wireless.networks = {
    echelon = {
      pskRaw = &quot;dca6d6ed41f4ab5a984c9f55f6f66d4efdc720ebf66959810f4329bb391c5435&quot;;
    };
  };
}
</code></pre><p>or you can use it to directly generate the <code class="literal">wpa_supplicant.conf</code>:</p><pre><code class="programlisting ShellSession"># wpa_passphrase ESSID PSK &gt; /etc/wpa_supplicant.conf
</code></pre><p>After you have edited the <code class="literal">wpa_supplicant.conf</code>, you need to restart the
wpa_supplicant service.</p><pre><code class="programlisting ShellSession"># systemctl restart wpa_supplicant.service
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ad-hoc-network-config" class="title" style="clear: both">Ad-Hoc Configuration   </h2>  </div> </div></div><p>You can use <a class="xref" href="options.html#opt-networking.localCommands"  ><code class="option">networking.localCommands</code></a> to
specify shell commands to be run at the end of <code class="literal">network-setup.service</code>. This
is useful for doing network configuration not covered by the existing NixOS
modules. For instance, to statically configure an IPv6 address:</p><pre><code class="programlisting nix">{
  networking.localCommands =
    &#x27;&#x27;
      ip -6 addr add 2001:610:685:1::1/64 dev eth0
    &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-rename-ifs" class="title" style="clear: both">Renaming network interfaces   </h2>  </div> </div></div><p>NixOS uses the udev <a class="link" href="https://systemd.io/PREDICTABLE_INTERFACE_NAMES/"  target="_top">predictable naming
scheme</a> to assign names
to network interfaces. This means that by default cards are not given
the traditional names like <code class="literal">eth0</code> or <code class="literal">eth1</code>, whose order can change
unpredictably across reboots. Instead, relying on physical locations and
firmware information, the scheme produces names like <code class="literal">ens1</code>, <code class="literal">enp2s0</code>,
etc.</p><p>These names are predictable but less memorable and not necessarily
stable: for example installing new hardware or changing firmware
settings can result in a <a class="link" href="https://github.com/systemd/systemd/issues/3715#issue-165347602"  target="_top">name
change</a>.
If this is undesirable, for example if you have a single ethernet card,
you can revert to the traditional scheme by setting
<a class="xref" href="options.html#opt-networking.usePredictableInterfaceNames"  ><code class="option">networking.usePredictableInterfaceNames</code></a>
to <code class="literal">false</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-custom-ifnames" class="title" >Assigning custom names   </h3>  </div> </div></div><p>In case there are multiple interfaces of the same type, it’s better to
assign custom names based on the device hardware address. For example,
we assign the name <code class="literal">wan</code> to the interface with MAC address
<code class="literal">52:54:00:12:01:01</code> using a netword link unit:</p><pre><code class="programlisting nix">{
  systemd.network.links.&quot;10-wan&quot; = {
    matchConfig.PermanentMACAddress = &quot;52:54:00:12:01:01&quot;;
    linkConfig.Name = &quot;wan&quot;;
  };
}
</code></pre><p>Note that links are directly read by udev, <span class="emphasis"><em>not networkd</em></span>, and will work
even if networkd is disabled.</p><p>Alternatively, we can use a plain old udev rule:</p><pre><code class="programlisting nix">{
  boot.initrd.services.udev.rules = &#x27;&#x27;
    SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, \
    ATTR{address}==&quot;52:54:00:12:01:01&quot;, KERNEL==&quot;eth*&quot;, NAME=&quot;wan&quot;
  &#x27;&#x27;;
}
</code></pre><div class="warning"><h3 class="title">Warning</h3><p>The rule must be installed in the initrd using
<code class="literal">boot.initrd.services.udev.rules</code>, not the usual <code class="literal">services.udev.extraRules</code>
option. This is to avoid race conditions with other programs controlling
the interface.</p></div>
</div>

</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-kernel-config" class="title" >Linux Kernel   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-linux-config-customizing">Building a custom kernel</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-linux-rust">Rust</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-linux-config-developing-modules">Developing kernel modules</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-linux-zfs">ZFS</a> </span></dt> </dl></div><p>You can override the Linux kernel and associated packages using the
option <code class="literal">boot.kernelPackages</code>. For instance, this selects the Linux 3.10
kernel:</p><pre><code class="programlisting nix">{
  boot.kernelPackages = pkgs.linuxKernel.packages.linux_3_10;
}
</code></pre><p>Note that this not only replaces the kernel, but also packages that are
specific to the kernel version, such as the NVIDIA video drivers. This
ensures that driver packages are consistent with the kernel.</p><p>While <code class="literal">pkgs.linuxKernel.packages</code> contains all available kernel packages,
you may want to use one of the unversioned <code class="literal">pkgs.linuxPackages_*</code> aliases
such as <code class="literal">pkgs.linuxPackages_latest</code>, that are kept up to date with new
versions.</p><p>Please note that the current convention in NixOS is to only keep actively
maintained kernel versions on both unstable and the currently supported stable
release(s) of NixOS. This means that a non-longterm kernel will be removed after it’s
abandoned by the kernel developers, even on stable NixOS versions. If you
pin your kernel onto a non-longterm version, expect your evaluation to fail as
soon as the version is out of maintenance.</p><p>Longterm versions of kernels will be removed before the next stable NixOS that will
exceed the maintenance period of the kernel version.</p><p>The default Linux kernel configuration should be fine for most users.
You can see the configuration of your current kernel with the following
command:</p><pre><code class="programlisting ShellSession">zcat /proc/config.gz
</code></pre><p>If you want to change the kernel configuration, you can use the
<code class="literal">packageOverrides</code> feature (see <a class="xref" href="index.html#sec-customising-packages" title="Customising Packages" >the section called “Customising Packages”</a>). For
instance, to enable support for the kernel debugger KGDB:</p><pre><code class="programlisting nix">{
  nixpkgs.config.packageOverrides = pkgs: pkgs.lib.recursiveUpdate pkgs {
    linuxKernel.kernels.linux_5_10 = pkgs.linuxKernel.kernels.linux_5_10.override {
      extraConfig = &#x27;&#x27;
        KGDB y
      &#x27;&#x27;;
    };
  };
}
</code></pre><p><code class="literal">extraConfig</code> takes a list of Linux kernel configuration options, one
per line. The name of the option should not include the prefix
<code class="literal">CONFIG_</code>. The option value is typically <code class="literal">y</code>, <code class="literal">n</code> or <code class="literal">m</code> (to build
something as a kernel module).</p><p>Kernel modules for hardware devices are generally loaded automatically
by <code class="literal">udev</code>. You can force a module to be loaded via
<a class="xref" href="options.html#opt-boot.kernelModules"  ><code class="option">boot.kernelModules</code></a>, e.g.</p><pre><code class="programlisting nix">{
  boot.kernelModules = [ &quot;fuse&quot; &quot;kvm-intel&quot; &quot;coretemp&quot; ];
}
</code></pre><p>If the module is required early during the boot (e.g. to mount the root
file system), you can use <a class="xref" href="options.html#opt-boot.initrd.kernelModules"  ><code class="option">boot.initrd.kernelModules</code></a>:</p><pre><code class="programlisting nix">{
  boot.initrd.kernelModules = [ &quot;cifs&quot; ];
}
</code></pre><p>This causes the specified modules and their dependencies to be added to
the initial ramdisk.</p><p>Kernel runtime parameters can be set through
<a class="xref" href="options.html#opt-boot.kernel.sysctl"  ><code class="option">boot.kernel.sysctl</code></a>, e.g.</p><pre><code class="programlisting nix">{
  boot.kernel.sysctl.&quot;net.ipv4.tcp_keepalive_time&quot; = 120;
}
</code></pre><p>sets the kernel’s TCP keepalive time to 120 seconds. To see the
available parameters, run <code class="literal">sysctl -a</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-linux-config-customizing" class="title" style="clear: both">Building a custom kernel   </h2>  </div> </div></div><p>Please refer to the Nixpkgs manual for the various ways of <a class="link" href="https://nixos.org/nixpkgs/manual#sec-linux-kernel"  target="_top">building a custom kernel</a>.</p><p>To use your custom kernel package in your NixOS configuration, set</p><pre><code class="programlisting nix">{
  boot.kernelPackages = pkgs.linuxPackagesFor yourCustomKernel;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-linux-rust" class="title" style="clear: both">Rust   </h2>  </div> </div></div><p>The Linux kernel does not have Rust language support enabled by
default. For kernel versions 6.7 or newer, experimental Rust support
can be enabled. In a NixOS configuration, set:</p><pre><code class="programlisting nix">{
  boot.kernelPatches = [
    {
      name = &quot;Rust Support&quot;;
      patch = null;
      features = {
        rust = true;
      };
    }
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-linux-config-developing-modules" class="title" style="clear: both">Developing kernel modules   </h2>  </div> </div></div><p>This section was moved to the <a class="link" href="https://nixos.org/nixpkgs/manual#sec-linux-kernel-developing-modules"  target="_top">Nixpkgs manual</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-linux-zfs" class="title" style="clear: both">ZFS   </h2>  </div> </div></div><p>It’s a common issue that the latest stable version of ZFS doesn’t support the latest
available Linux kernel. It is recommended to use the latest available LTS that’s compatible
with ZFS. Usually this is the default kernel provided by nixpkgs (i.e. <code class="literal">pkgs.linuxPackages</code>).</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-subversion" class="title" >Subversion   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-subversion-apache-httpd">Subversion inside Apache HTTP</a> </span></dt> </dl></div><p><a class="link" href="https://subversion.apache.org/"  target="_top">Subversion</a> is a centralized
version-control system. It can use a <a class="link" href="https://svnbook.red-bean.com/en/1.7/svn-book.html#svn.serverconfig.choosing"  target="_top">variety of
protocols</a>
for communication between client and server.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-subversion-apache-httpd" class="title" style="clear: both">Subversion inside Apache HTTP   </h2>  </div> </div></div><p>This section focuses on configuring a web-based server on top of the
Apache HTTP server, which uses
<a class="link" href="http://www.webdav.org/"  target="_top">WebDAV</a>/<a class="link" href="http://www.webdav.org/deltav/WWW10/deltav-intro.htm"  target="_top">DeltaV</a>
for communication.</p><p>For more information on the general setup, please refer to the <a class="link" href="https://svnbook.red-bean.com/en/1.7/svn-book.html#svn.serverconfig.httpd"  target="_top">the
appropriate section of the Subversion
book</a>.</p><p>To configure, include in <code class="literal">/etc/nixos/configuration.nix</code> code to activate
Apache HTTP, setting <a class="xref" href="options.html#opt-services.httpd.adminAddr"  ><code class="option">services.httpd.adminAddr</code></a>
appropriately:</p><pre><code class="programlisting nix">{
  services.httpd.enable = true;
  services.httpd.adminAddr = &quot;...&quot;;
  networking.firewall.allowedTCPPorts = [ 80 443 ];
}
</code></pre><p>For a simple Subversion server with basic authentication, configure the
Subversion module for Apache as follows, setting <code class="literal">hostName</code> and
<code class="literal">documentRoot</code> appropriately, and <code class="literal">SVNParentPath</code> to the parent
directory of the repositories, <code class="literal">AuthzSVNAccessFile</code> to the location of
the <code class="literal">.authz</code> file describing access permission, and <code class="literal">AuthUserFile</code> to
the password file.</p><pre><code class="programlisting nix">{
  services.httpd.extraModules = [
      # note that order is *super* important here
      { name = &quot;dav_svn&quot;; path = &quot;${pkgs.apacheHttpdPackages.subversion}/modules/mod_dav_svn.so&quot;; }
      { name = &quot;authz_svn&quot;; path = &quot;${pkgs.apacheHttpdPackages.subversion}/modules/mod_authz_svn.so&quot;; }
    ];
    services.httpd.virtualHosts = {
      &quot;svn&quot; = {
         hostName = HOSTNAME;
         documentRoot = DOCUMENTROOT;
         locations.&quot;/svn&quot;.extraConfig = &#x27;&#x27;
             DAV svn
             SVNParentPath REPO_PARENT
             AuthzSVNAccessFile ACCESS_FILE
             AuthName &quot;SVN Repositories&quot;
             AuthType Basic
             AuthUserFile PASSWORD_FILE
             Require valid-user
        &#x27;&#x27;;
      };
    };
}
</code></pre><p>The key <code class="literal">&quot;svn&quot;</code> is just a symbolic name identifying the virtual host.
The <code class="literal">&quot;/svn&quot;</code> in <code class="literal">locations.&quot;/svn&quot;.extraConfig</code> is the path underneath
which the repositories will be served.</p><p><a class="link" href="https://wiki.archlinux.org/index.php/Subversion"  target="_top">This page</a> explains
how to set up the Subversion configuration itself. This boils down to
the following:</p><p>Underneath <code class="literal">REPO_PARENT</code> repositories can be set up as follows:</p><pre><code class="programlisting ShellSession">$ svn create REPO_NAME
</code></pre><p>Repository files need to be accessible by <code class="literal">wwwrun</code>:</p><pre><code class="programlisting ShellSession">$ chown -R wwwrun:wwwrun REPO_PARENT
</code></pre><p>The password file <code class="literal">PASSWORD_FILE</code> can be created as follows:</p><pre><code class="programlisting ShellSession">$ htpasswd -cs PASSWORD_FILE USER_NAME
</code></pre><p>Additional users can be set up similarly, omitting the <code class="literal">c</code> flag:</p><pre><code class="programlisting ShellSession">$ htpasswd -s PASSWORD_FILE USER_NAME
</code></pre><p>The file describing access permissions <code class="literal">ACCESS_FILE</code> will look something
like the following:</p><pre><code class="programlisting">[/]
* = r

[REPO_NAME:/]
USER_NAME = rw
</code></pre><p>The Subversion repositories will be accessible as
<code class="literal">http://HOSTNAME/svn/REPO_NAME</code>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-pantheon" class="title" >Pantheon Desktop   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-pantheon-enable">Enabling Pantheon</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pantheon-wingpanel-switchboard">Wingpanel and Switchboard plugins</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pantheon-faq">FAQ</a> </span></dt> </dl></div><p>Pantheon is the desktop environment created for the elementary OS distribution. It is written from scratch in Vala, utilizing GNOME technologies with GTK and Granite.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pantheon-enable" class="title" style="clear: both">Enabling Pantheon   </h2>  </div> </div></div><p>All of Pantheon is working in NixOS and the applications should be available, aside from a few <a class="link" href="https://github.com/NixOS/nixpkgs/issues/58161"  target="_top">exceptions</a>. To enable Pantheon, set</p><pre><code class="programlisting nix">{
  services.xserver.desktopManager.pantheon.enable = true;
}
</code></pre><p>This automatically enables LightDM and Pantheon’s LightDM greeter. If you’d like to disable this, set</p><pre><code class="programlisting nix">{
  services.xserver.displayManager.lightdm.greeters.pantheon.enable = false;
  services.xserver.displayManager.lightdm.enable = false;
}
</code></pre><p>but please be aware using Pantheon without LightDM as a display manager will break screenlocking from the UI. The NixOS module for Pantheon installs all of Pantheon’s default applications. If you’d like to not install Pantheon’s apps, set</p><pre><code class="programlisting nix">{
  services.pantheon.apps.enable = false;
}
</code></pre><p>You can also use <a class="xref" href="options.html#opt-environment.pantheon.excludePackages"  ><code class="option">environment.pantheon.excludePackages</code></a> to remove any other app (like <code class="literal">elementary-mail</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pantheon-wingpanel-switchboard" class="title" style="clear: both">Wingpanel and Switchboard plugins   </h2>  </div> </div></div><p>Wingpanel and Switchboard work differently than they do in other distributions, as far as using plugins. You cannot install a plugin globally (like with <code class="option">environment.systemPackages</code>) to start using it. You should instead be using the following options:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="xref" href="options.html#opt-services.xserver.desktopManager.pantheon.extraWingpanelIndicators"  ><code class="option">services.xserver.desktopManager.pantheon.extraWingpanelIndicators</code></a></p></li><li class="listitem"><p><a class="xref" href="options.html#opt-services.xserver.desktopManager.pantheon.extraSwitchboardPlugs"  ><code class="option">services.xserver.desktopManager.pantheon.extraSwitchboardPlugs</code></a></p></li></ul></div><p>to configure the programs with plugs or indicators.</p><p>The difference in NixOS is both these programs are patched to load plugins from a directory that is the value of an environment variable. All of which is controlled in Nix. If you need to configure the particular packages manually you can override the packages like:</p><pre><code class="programlisting nix">wingpanel-with-indicators.override {
  indicators = [
    pkgs.some-special-indicator
  ];
}

</code></pre><pre><code class="programlisting nix">switchboard-with-plugs.override {
  plugs = [
    pkgs.some-special-plug
  ];
}
</code></pre><p>please note that, like how the NixOS options describe these as extra plugins, this would only add to the default plugins included with the programs. If for some reason you’d like to configure which plugins to use exactly, both packages have an argument for this:</p><pre><code class="programlisting nix">wingpanel-with-indicators.override {
  useDefaultIndicators = false;
  indicators = specialListOfIndicators;
}
</code></pre><pre><code class="programlisting nix">switchboard-with-plugs.override {
  useDefaultPlugs = false;
  plugs = specialListOfPlugs;
}
</code></pre><p>this could be most useful for testing a particular plug-in in isolation.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pantheon-faq" class="title" style="clear: both">FAQ   </h2>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span id="sec-pantheon-faq-messed-up-theme"></span>I have switched from a different desktop and Pantheon’s theming looks messed up.</span></dt><dd><p>Open Switchboard and go to: Administration → About → Restore Default Settings → Restore Settings. This will reset any dconf settings to their Pantheon defaults. Note this could reset certain GNOME specific preferences if that desktop was used prior.</p></dd><dt><span class="term"><span id="sec-pantheon-faq-gnome-and-pantheon"></span>I cannot enable both GNOME and Pantheon.</span></dt><dd><p>This is a known <a class="link" href="https://github.com/NixOS/nixpkgs/issues/64611"  target="_top">issue</a> and there is no known workaround.</p></dd><dt><span class="term"><span id="sec-pantheon-faq-appcenter"></span>Does AppCenter work, or is it available?</span></dt><dd><p>AppCenter is available and the Flatpak backend should work so you can install some Flatpak applications using it. However, due to missing appstream metadata, the Packagekit backend does not function currently. See this <a class="link" href="https://github.com/NixOS/nixpkgs/issues/15932"  target="_top">issue</a>.</p><p>If you are using Pantheon, AppCenter should be installed by default if you have <a class="link" href="index.html#module-services-flatpak" title="Flatpak" >Flatpak support</a> enabled. If you also wish to add the <code class="literal">appcenter</code> Flatpak remote:</p><pre><code class="programlisting ShellSession">$ flatpak remote-add --if-not-exists appcenter https://flatpak.elementary.io/repo.flatpakrepo
</code></pre></dd></dl></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-gnome" class="title" >GNOME Desktop   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-gnome-enable">Enabling GNOME</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-gnome-enable-flashback">Enabling GNOME Flashback</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-gnome-icons-and-gtk-themes">Icons and GTK Themes</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-gnome-shell-extensions">Shell Extensions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-gnome-gsettings-overrides">GSettings Overrides</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-gnome-faq">Frequently Asked Questions</a> </span></dt> </dl></div><p>GNOME provides a simple, yet full-featured desktop environment with a focus on productivity. Its Mutter compositor supports both Wayland and X server, and the GNOME Shell user interface is fully customizable by extensions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-enable" class="title" style="clear: both">Enabling GNOME   </h2>  </div> </div></div><p>All of the core apps, optional apps, games, and core developer tools from GNOME are available.</p><p>To enable the GNOME desktop use:</p><pre><code class="programlisting nix">{
  services.xserver.desktopManager.gnome.enable = true;
  services.xserver.displayManager.gdm.enable = true;
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>While it is not strictly necessary to use GDM as the display manager with GNOME, it is recommended, as some features such as screen lock <a class="link" href="index.html#sec-gnome-faq-can-i-use-lightdm-with-gnome" title="Can I use LightDM with GNOME?" >might not work</a> without it.</p></div><p>The default applications used in NixOS are very minimal, inspired by the defaults used in <a class="link" href="https://gitlab.gnome.org/GNOME/gnome-build-meta/blob/48.0/elements/core/meta-gnome-core-apps.bst"  target="_top">gnome-build-meta</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-without-the-apps" class="title" >GNOME without the apps   </h3>  </div> </div></div><p>If you’d like to only use the GNOME desktop and not the apps, you can disable them with:</p><pre><code class="programlisting nix">{
  services.gnome.core-apps.enable = false;
}
</code></pre><p>and none of them will be installed.</p><p>If you’d only like to omit a subset of the core utilities, you can use
<a class="xref" href="options.html#opt-environment.gnome.excludePackages"  ><code class="option">environment.gnome.excludePackages</code></a>.
Note that this mechanism can only exclude core utilities, games and core developer tools.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-disabling-services" class="title" >Disabling GNOME services   </h3>  </div> </div></div><p>It is also possible to disable many of the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/b8ec4fd2a4edc4e30d02ba7b1a2cc1358f3db1d5/nixos/modules/services/x11/desktop-managers/gnome.nix#L329-L348"  target="_top">core services</a>. For example, if you do not need indexing files, you can disable TinySPARQL with:</p><pre><code class="programlisting nix">{
  services.gnome.localsearch.enable = false;
  services.gnome.tinysparql.enable = false;
}
</code></pre><p>Note, however, that doing so is not supported and might break some applications. Notably, GNOME Music cannot work without TinySPARQL.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-games" class="title" >GNOME games   </h3>  </div> </div></div><p>You can install all of the GNOME games with:</p><pre><code class="programlisting nix">{
  services.gnome.games.enable = true;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-core-developer-tools" class="title" >GNOME core developer tools   </h3>  </div> </div></div><p>You can install GNOME core developer tools with:</p><pre><code class="programlisting nix">{
  services.gnome.core-developer-tools.enable = true;
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-enable-flashback" class="title" style="clear: both">Enabling GNOME Flashback   </h2>  </div> </div></div><p>GNOME Flashback provides a desktop environment based on the classic GNOME 2 architecture. You can enable the default GNOME Flashback session, which uses the Metacity window manager, with:</p><pre><code class="programlisting nix">{
  services.xserver.desktopManager.gnome.flashback.enableMetacity = true;
}
</code></pre><p>It is also possible to create custom sessions that replace Metacity with a different window manager using <a class="xref" href="options.html#opt-services.xserver.desktopManager.gnome.flashback.customSessions"  ><code class="option">services.xserver.desktopManager.gnome.flashback.customSessions</code></a>.</p><p>The following example uses <code class="literal">xmonad</code> window manager:</p><pre><code class="programlisting nix">{
  services.xserver.desktopManager.gnome.flashback.customSessions = [
    {
      wmName = &quot;xmonad&quot;;
      wmLabel = &quot;XMonad&quot;;
      wmCommand = &quot;${pkgs.haskellPackages.xmonad}/bin/xmonad&quot;;
      enableGnomePanel = false;
    }
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-icons-and-gtk-themes" class="title" style="clear: both">Icons and GTK Themes   </h2>  </div> </div></div><p>Icon themes and GTK themes don’t require any special option to install in NixOS.</p><p>You can add them to <a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a> and switch to them with GNOME Tweaks.
If you’d like to do this manually in dconf, change the values of the following keys:</p><pre><code class="programlisting">/org/gnome/desktop/interface/gtk-theme
/org/gnome/desktop/interface/icon-theme
</code></pre><p>in <code class="literal">dconf-editor</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-shell-extensions" class="title" style="clear: both">Shell Extensions   </h2>  </div> </div></div><p>Most Shell extensions are packaged under the <code class="literal">gnomeExtensions</code> attribute.
Some packages that include Shell extensions, like <code class="literal">gpaste</code>, don’t have their extension decoupled under this attribute.</p><p>You can install them like any other package:</p><pre><code class="programlisting nix">{
  environment.systemPackages = [
    gnomeExtensions.dash-to-dock
    gnomeExtensions.gsconnect
    gnomeExtensions.mpris-indicator-button
  ];
}
</code></pre><p>Unfortunately, we lack a way for these to be managed in a completely declarative way.
So you have to enable them manually with an Extensions application.
It is possible to use a <a class="link" href="index.html#sec-gnome-gsettings-overrides" title="GSettings Overrides" >GSettings override</a> for this on <code class="literal">org.gnome.shell.enabled-extensions</code>, but that will only influence the default value.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-gsettings-overrides" class="title" style="clear: both">GSettings Overrides   </h2>  </div> </div></div><p>Majority of software building on the GNOME platform use GLib’s <a class="link" href="https://developer.gnome.org/gio/unstable/GSettings.html"  target="_top">GSettings</a> system to manage runtime configuration. For our purposes, the system consists of XML schemas describing the individual configuration options, stored in the package, and a settings backend, where the values of the settings are stored. On NixOS, like on most Linux distributions, dconf database is used as the backend.</p><p><a class="link" href="https://developer.gnome.org/gio/unstable/GSettings.html#id-1.4.19.2.9.25"  target="_top">GSettings vendor overrides</a> can be used to adjust the default values for settings of the GNOME desktop and apps by replacing the default values specified in the XML schemas. Using overrides will allow you to pre-seed user settings before you even start the session.</p><div class="warning"><h3 class="title">Warning</h3><p>Overrides really only change the default values for GSettings keys so if you or an application changes the setting value, the value set by the override will be ignored. Until <a class="link" href="https://github.com/NixOS/nixpkgs/issues/54150"  target="_top">NixOS’s dconf module implements changing values</a>, you will either need to keep that in mind and clear the setting from the backend using <code class="literal">dconf reset</code> command when that happens, or use the <a class="link" href="https://nix-community.github.io/home-manager/options.html#opt-dconf.settings"  target="_top">module from home-manager</a>.</p></div><p>You can override the default GSettings values using the
<a class="xref" href="options.html#opt-services.xserver.desktopManager.gnome.extraGSettingsOverrides"  ><code class="option">services.xserver.desktopManager.gnome.extraGSettingsOverrides</code></a> option.</p><p>Take note that whatever packages you want to override GSettings for, you need to add them to
<a class="xref" href="options.html#opt-services.xserver.desktopManager.gnome.extraGSettingsOverridePackages"  ><code class="option">services.xserver.desktopManager.gnome.extraGSettingsOverridePackages</code></a>.</p><p>You can use <code class="literal">dconf-editor</code> tool to explore which GSettings you can set.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-gsettings-overrides-example" class="title" >Example   </h3>  </div> </div></div><pre><code class="programlisting nix">{
  services.xserver.desktopManager.gnome = {
    extraGSettingsOverrides = &#x27;&#x27;
      # Change default background
      [org.gnome.desktop.background]
      picture-uri=&#x27;file://${pkgs.nixos-artwork.wallpapers.mosaic-blue.gnomeFilePath}&#x27;

      # Favorite apps in gnome-shell
      [org.gnome.shell]
      favorite-apps=[&#x27;org.gnome.Console.desktop&#x27;, &#x27;org.gnome.Nautilus.desktop&#x27;]
    &#x27;&#x27;;

    extraGSettingsOverridePackages = [
      pkgs.gsettings-desktop-schemas # for org.gnome.desktop
      pkgs.gnome-shell # for org.gnome.shell
    ];
  };
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-faq" class="title" style="clear: both">Frequently Asked Questions   </h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-faq-can-i-use-lightdm-with-gnome" class="title" >Can I use LightDM with GNOME?   </h3>  </div> </div></div><p>Yes you can, and any other display-manager in NixOS.</p><p>However, it doesn’t work correctly for the Wayland session of GNOME Shell yet, and
won’t be able to lock your screen.</p><p>See <a class="link" href="https://github.com/NixOS/nixpkgs/issues/56342"  target="_top">this issue.</a></p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-bootloader-external" class="title" >External Bootloader Backends   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-bootloader-external-developing">Developing Custom Bootloader Backends</a> </span></dt> </dl></div><p>NixOS has support for several bootloader backends by default: systemd-boot, grub, uboot, etc.
The built-in bootloader backend support is generic and supports most use cases.
Some users may prefer to create advanced workflows around managing the bootloader and bootable entries.</p><p>You can replace the built-in bootloader support with your own tooling using the “external” bootloader option.</p><p>Imagine you have created a new package called FooBoot.
FooBoot provides a program at <code class="literal">${pkgs.fooboot}/bin/fooboot-install</code> which takes the system closure’s path as its only argument and configures the system’s bootloader.</p><p>You can enable FooBoot like this:</p><pre><code class="programlisting nix">{ pkgs, ... }: {
  boot.loader.external = {
    enable = true;
    installHook = &quot;${pkgs.fooboot}/bin/fooboot-install&quot;;
  };
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-bootloader-external-developing" class="title" style="clear: both">Developing Custom Bootloader Backends   </h2>  </div> </div></div><p>Bootloaders should use <a class="link" href="https://github.com/NixOS/rfcs/pull/125"  target="_top">RFC-0125</a>’s Bootspec format and synthesis tools to identify the key properties for bootable system generations.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-boot-clevis" class="title" >Clevis   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-boot-clevis-create-secret">Create a JWE file containing your secret</a> </span></dt><dt> <span class="section">  <a href="index.html#module-boot-clevis-activate">Activate unattended decryption of a resource at boot</a> </span></dt> </dl></div><p><a class="link" href="https://github.com/latchset/clevis"  target="_top">Clevis</a>
is a framework for automated decryption of resources.
Clevis allows for secure unattended disk decryption during boot, using decryption policies that must be satisfied for the data to decrypt.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-boot-clevis-create-secret" class="title" style="clear: both">Create a JWE file containing your secret   </h2>  </div> </div></div><p>The first step is to embed your secret in a <a class="link" href="https://en.wikipedia.org/wiki/JSON_Web_Encryption"  target="_top">JWE</a> file.
JWE files have to be created through the clevis command line. 3 types of policies are supported:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>TPM policies</p></li></ol></div><p>Secrets are pinned against the presence of a TPM2 device, for example:</p><pre><code class="programlisting">echo -n hi | clevis encrypt tpm2 &#x27;{}&#x27; &gt; hi.jwe
</code></pre><div class="orderedlist"><ol class="orderedlist compact" start="2" type="1"><li class="listitem"><p>Tang policies</p></li></ol></div><p>Secrets are pinned against the presence of a Tang server, for example:</p><pre><code class="programlisting">echo -n hi | clevis encrypt tang &#x27;{&quot;url&quot;: &quot;http://tang.local&quot;}&#x27; &gt; hi.jwe
</code></pre><div class="orderedlist"><ol class="orderedlist compact" start="3" type="1"><li class="listitem"><p>Shamir Secret Sharing</p></li></ol></div><p>Using Shamir’s Secret Sharing (<a class="link" href="https://en.wikipedia.org/wiki/Shamir%27s_secret_sharing"  target="_top">sss</a>), secrets are pinned using a combination of the two preceding policies. For example:</p><pre><code class="programlisting">echo -n hi | clevis encrypt sss \
&#x27;{&quot;t&quot;: 2, &quot;pins&quot;: {&quot;tpm2&quot;: {&quot;pcr_ids&quot;: &quot;0&quot;}, &quot;tang&quot;: {&quot;url&quot;: &quot;http://tang.local&quot;}}}&#x27; \
&gt; hi.jwe
</code></pre><p>For more complete documentation on how to generate a secret with clevis, see the <a class="link" href="https://github.com/latchset/clevis"  target="_top">clevis documentation</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-boot-clevis-activate" class="title" style="clear: both">Activate unattended decryption of a resource at boot   </h2>  </div> </div></div><p>In order to activate unattended decryption of a resource at boot, enable the <code class="literal">clevis</code> module:</p><pre><code class="programlisting nix">{
  boot.initrd.clevis.enable = true;
}
</code></pre><p>Then, specify the device you want to decrypt using a given clevis secret. Clevis will automatically try to decrypt the device at boot and will fallback to interactive unlocking if the decryption policy is not fulfilled.</p><pre><code class="programlisting nix">{
  boot.initrd.clevis.devices.&quot;/dev/nvme0n1p1&quot;.secretFile = ./nvme0n1p1.jwe;
}
</code></pre><p>Only <code class="literal">bcachefs</code>, <code class="literal">zfs</code> and <code class="literal">luks</code> encrypted devices are supported at this time.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-garage" class="title" >Garage   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-garage-upgrade-scenarios">General considerations on upgrades</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-garage-advanced-upgrades">Advanced upgrades (minor/major version upgrades)</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-garage-maintainer-info">Maintainer information</a> </span></dt> </dl></div><p><a class="link" href="https://garagehq.deuxfleurs.fr/"  target="_top">Garage</a>
is an open-source, self-hostable S3 store, simpler than MinIO, for geodistributed stores.
The server setup can be automated using
<a class="link" href="options.html#opt-services.garage.enable"  >services.garage</a>. A
client configured to your local Garage instance is available in
the global environment as <code class="literal">garage-manage</code>.</p><p>The current default by NixOS is <code class="literal">garage_0_8</code> which is also the latest
major version available.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-garage-upgrade-scenarios" class="title" style="clear: both">General considerations on upgrades   </h2>  </div> </div></div><p>Garage provides a cookbook documentation on how to upgrade:
<a class="link" href="https://garagehq.deuxfleurs.fr/documentation/cookbook/upgrading/"  target="_top">https://garagehq.deuxfleurs.fr/documentation/cookbook/upgrading/</a></p><div class="warning"><h3 class="title">Warning</h3><p>Garage has two types of upgrades: patch-level upgrades and minor/major version upgrades.</p><p>In all cases, you should read the changelog and ideally test the upgrade on a staging cluster.</p><p>Checking the health of your cluster can be achieved using <code class="literal">garage-manage repair</code>.</p></div><div class="warning"><h3 class="title">Warning</h3><p>Until 1.0 is released, patch-level upgrades are considered as minor version upgrades.
Minor version upgrades are considered as major version upgrades.
i.e. 0.6 to 0.7 is a major version upgrade.</p></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><span class="strong"><strong>Straightforward upgrades (patch-level upgrades).</strong></span>
Upgrades must be performed one by one, i.e. for each node, stop it, upgrade it : change <a class="link" href="options.html#opt-system.stateVersion"  >stateVersion</a> or <a class="link" href="options.html#opt-services.garage.package"  >services.garage.package</a>, restart it if it was not already by switching.</p></li><li class="listitem"><p><span class="strong"><strong>Multiple version upgrades.</strong></span>
Garage do not provide any guarantee on moving more than one major-version forward.
E.g., if you’re on <code class="literal">0.7</code>, you cannot upgrade to <code class="literal">0.9</code>.
You need to upgrade to <code class="literal">0.8</code> first.
As long as <a class="link" href="options.html#opt-system.stateVersion"  >stateVersion</a> is declared properly,
this is enforced automatically. The module will issue a warning to remind the user to upgrade to latest
Garage <span class="emphasis"><em>after</em></span> that deploy.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-garage-advanced-upgrades" class="title" style="clear: both">Advanced upgrades (minor/major version upgrades)   </h2>  </div> </div></div><p>Here are some baseline instructions to handle advanced upgrades in Garage, when in doubt, please refer to upstream instructions.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Disable API and web access to Garage.</p></li><li class="listitem"><p>Perform <code class="literal">garage-manage repair --all-nodes --yes tables</code> and <code class="literal">garage-manage repair --all-nodes --yes blocks</code>.</p></li><li class="listitem"><p>Verify the resulting logs and check that data is synced properly between all nodes.
If you have time, do additional checks (<code class="literal">scrub</code>, <code class="literal">block_refs</code>, etc.).</p></li><li class="listitem"><p>Check if queues are empty by <code class="literal">garage-manage stats</code> or through monitoring tools.</p></li><li class="listitem"><p>Run <code class="literal">systemctl stop garage</code> to stop the actual Garage version.</p></li><li class="listitem"><p>Backup the metadata folder of ALL your nodes, e.g. for a metadata directory (the default one) in <code class="literal">/var/lib/garage/meta</code>,
you can run <code class="literal">pushd /var/lib/garage; tar -acf meta-v0.7.tar.zst meta/; popd</code>.</p></li><li class="listitem"><p>Run the offline migration: <code class="literal">nix-shell -p garage_0_8 --run &quot;garage offline-repair --yes&quot;</code>, this can take some time depending on how many objects are stored in your cluster.</p></li><li class="listitem"><p>Bump Garage version in your NixOS configuration, either by changing <a class="link" href="options.html#opt-system.stateVersion"  >stateVersion</a> or bumping <a class="link" href="options.html#opt-services.garage.package"  >services.garage.package</a>, this should restart Garage automatically.</p></li><li class="listitem"><p>Perform <code class="literal">garage-manage repair --all-nodes --yes tables</code> and <code class="literal">garage-manage repair --all-nodes --yes blocks</code>.</p></li><li class="listitem"><p>Wait for a full table sync to run.</p></li></ul></div><p>Your upgraded cluster should be in a working state, re-enable API and web access.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-garage-maintainer-info" class="title" style="clear: both">Maintainer information   </h2>  </div> </div></div><p>As stated in the previous paragraph, we must provide a clean upgrade-path for Garage
since it cannot move more than one major version forward on a single upgrade. This chapter
adds some notes how Garage updates should be rolled out in the future.
This is inspired from how Nextcloud does it.</p><p>While patch-level updates are no problem and can be done directly in the
package-expression (and should be backported to supported stable branches after that),
major-releases should be added in a new attribute (e.g. Garage <code class="literal">v0.8.0</code>
should be available in <code class="literal">nixpkgs</code> as <code class="literal">pkgs.garage_0_8_0</code>).
To provide simple upgrade paths it’s generally useful to backport those as well to stable
branches. As long as the package-default isn’t altered, this won’t break existing setups.
After that, the versioning-warning in the <code class="literal">garage</code>-module should be
updated to make sure that the
<a class="link" href="options.html#opt-services.garage.package"  >package</a>-option selects the latest version
on fresh setups.</p><p>If major-releases will be abandoned by upstream, we should check first if those are needed
in NixOS for a safe upgrade-path before removing those. In that case we should keep those
packages, but mark them as insecure in an expression like this (in
<code class="literal">&lt;nixpkgs/pkgs/tools/filesystem/garage/default.nix&gt;</code>):</p><pre><code class="programlisting nix">/* ... */
{
  garage_0_7_3 = generic {
    version = &quot;0.7.3&quot;;
    sha256 = &quot;0000000000000000000000000000000000000000000000000000&quot;;
    eol = true;
  };
}
</code></pre><p>Ideally we should make sure that it’s possible to jump two NixOS versions forward:
i.e. the warnings and the logic in the module should guard a user to upgrade from a
Garage on e.g. 22.11 to a Garage on 23.11.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-youtrack" class="title" >YouTrack   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-youtrack-installation">Installation</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-youtrack-upgrade-2022_3-2023_1">Upgrade from 2022.3 to 2023.x</a> </span></dt> </dl></div><p>YouTrack is a browser-based bug tracker, issue tracking system and project management software.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-youtrack-installation" class="title" style="clear: both">Installation   </h2>  </div> </div></div><p>YouTrack exposes a web GUI installer on first login.
You need a token to access it.
You can find this token in the log of the <code class="literal">youtrack</code> service. The log line looks like</p><pre><code class="programlisting">* JetBrains YouTrack 2023.3 Configuration Wizard will be available on [http://127.0.0.1:8090/?wizard_token=somelongtoken] after start
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-youtrack-upgrade-2022_3-2023_1" class="title" style="clear: both">Upgrade from 2022.3 to 2023.x   </h2>  </div> </div></div><p>Starting with YouTrack 2023.1, JetBrains no longer distributes it as as JAR.
The new distribution with the JetBrains Launcher as a ZIP changed the basic data structure and also some configuration parameters.
Check out https://www.jetbrains.com/help/youtrack/server/YouTrack-Java-Start-Parameters.html for more information on the new configuration options.
When upgrading to YouTrack 2023.1 or higher, a migration script will move the old state directory to <code class="literal">/var/lib/youtrack/2022_3</code> as a backup.
A one-time manual update is required:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Before you update take a backup of your YouTrack instance!</p></li><li class="listitem"><p>Migrate the options you set in <code class="literal">services.youtrack.extraParams</code> and <code class="literal">services.youtrack.jvmOpts</code> to <code class="literal">services.youtrack.generalParameters</code> and <code class="literal">services.youtrack.environmentalParameters</code> (see the examples and <a class="link" href="https://www.jetbrains.com/help/youtrack/server/2023.3/YouTrack-Java-Start-Parameters.html"  target="_top">the YouTrack docs</a>)</p></li><li class="listitem"><p>To start the upgrade set <code class="literal">services.youtrack.package = pkgs.youtrack</code></p></li><li class="listitem"><p>YouTrack then starts in upgrade mode, meaning you need to obtain the wizard token as above</p></li><li class="listitem"><p>Select you want to <span class="strong"><strong>Upgrade</strong></span> YouTrack</p></li><li class="listitem"><p>As source you select <code class="literal">/var/lib/youtrack/2022_3/teamsysdata/</code> (adopt if you have a different state path)</p></li><li class="listitem"><p>Change the data directory location to <code class="literal">/var/lib/youtrack/data/</code>. The other paths should already be right.</p></li></ol></div><p>If you migrate a larger YouTrack instance, it might be useful to set <code class="literal">-Dexodus.entityStore.refactoring.forceAll=true</code> in <code class="literal">services.youtrack.generalParameters</code> for the first startup of YouTrack 2023.x.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-suwayomi-server" class="title" >Suwayomi-Server   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-suwayomi-server-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-suwayomi-server-basic-auth">Basic authentication</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-suwayomi-server-extra-config">Extra configuration</a> </span></dt> </dl></div><p>A free and open source manga reader server that runs extensions built for Tachiyomi.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-suwayomi-server-basic-usage" class="title" style="clear: both">Basic usage   </h2>  </div> </div></div><p>By default, the module will execute Suwayomi-Server backend and web UI:</p><pre><code class="programlisting nix">{ ... }:

{
  services.suwayomi-server = {
    enable = true;
  };
}
</code></pre><p>It runs in the systemd service named <code class="literal">suwayomi-server</code> in the data directory <code class="literal">/var/lib/suwayomi-server</code>.</p><p>You can change the default parameters with some other parameters:</p><pre><code class="programlisting nix">{ ... }:

{
  services.suwayomi-server = {
    enable = true;

    dataDir = &quot;/var/lib/suwayomi&quot;; # Default is &quot;/var/lib/suwayomi-server&quot;
    openFirewall = true;

    settings = {
      server.port = 4567;
    };
  };
}
</code></pre><p>If you want to create a desktop icon, you can activate the system tray option:</p><pre><code class="programlisting nix">{ ... }:

{
  services.suwayomi-server = {
    enable = true;

    dataDir = &quot;/var/lib/suwayomi&quot;; # Default is &quot;/var/lib/suwayomi-server&quot;
    openFirewall = true;

    settings = {
      server.port = 4567;
      server.enableSystemTray = true;
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-suwayomi-server-basic-auth" class="title" style="clear: both">Basic authentication   </h2>  </div> </div></div><p>You can configure a basic authentication to the web interface with:</p><pre><code class="programlisting nix">{ ... }:

{
  services.suwayomi-server = {
    enable = true;

    openFirewall = true;

    settings = {
      server.port = 4567;
      server = {
        basicAuthEnabled = true;
        basicAuthUsername = &quot;username&quot;;

        # NOTE: this is not a real upstream option
        basicAuthPasswordFile = ./path/to/the/password/file;
      };
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-suwayomi-server-extra-config" class="title" style="clear: both">Extra configuration   </h2>  </div> </div></div><p>Not all the configuration options are available directly in this module, but you can add the other options of suwayomi-server with:</p><pre><code class="programlisting nix">{ ... }:

{
  services.suwayomi-server = {
    enable = true;

    openFirewall = true;

    settings = {
      server = {
        port = 4567;
        autoDownloadNewChapters = false;
        maxSourcesInParallel = 6;
        extensionRepos = [
          &quot;https://raw.githubusercontent.com/MY_ACCOUNT/MY_REPO/repo/index.min.json&quot;
        ];
      };
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-strfry" class="title" >strfry   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-strfry-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-strfry-reverse-proxy">Reverse Proxy</a> </span></dt> </dl></div><p>strfry is a relay for the <a class="link" href="https://github.com/nostr-protocol/nostr"  target="_top">nostr protocol</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-strfry-basic-usage" class="title" style="clear: both">Basic usage   </h2>  </div> </div></div><p>By default, the module will execute strfry:</p><pre><code class="programlisting nix">{ ... }:

{
  services.strfry.enable = true;
}
</code></pre><p>It runs in the systemd service named <code class="literal">strfry</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-strfry-reverse-proxy" class="title" style="clear: both">Reverse Proxy   </h2>  </div> </div></div><p>You can configure nginx as a reverse proxy with:</p><pre><code class="programlisting nix">{ ... }:

{
  security.acme = {
    acceptTerms = true;
    defaults.email = &quot;foo@bar.com&quot;;
  };

  services.nginx.enable = true;
  services.nginx.virtualHosts.&quot;strfry.example.com&quot; = {
    addSSL = true;
    enableACME = true;
    locations.&quot;/&quot; = {
      proxyPass = &quot;http://127.0.0.1:${toString config.services.strfry.settings.relay.port}&quot;;
      proxyWebsockets = true; # nostr uses websockets
    };
  };

  services.strfry.enable = true;
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-plausible" class="title" >Plausible   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-plausible-basic-usage">Basic Usage</a> </span></dt> </dl></div><p><a class="link" href="https://plausible.io/"  target="_top">Plausible</a> is a privacy-friendly alternative to
Google analytics.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-plausible-basic-usage" class="title" style="clear: both">Basic Usage   </h2>  </div> </div></div><p>At first, a secret key is needed to be generated. This can be done with e.g.</p><pre><code class="programlisting ShellSession">$ openssl rand -base64 64
</code></pre><p>After that, <code class="literal">plausible</code> can be deployed like this:</p><pre><code class="programlisting nix">{
  services.plausible = {
    enable = true;
    server = {
      baseUrl = &quot;http://analytics.example.org&quot;;
      # secretKeybaseFile is a path to the file which contains the secret generated
      # with openssl as described above.
      secretKeybaseFile = &quot;/run/secrets/plausible-secret-key-base&quot;;
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pingvin-share" class="title" >Pingvin Share   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-pingvin-share-basic-usage">Configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-pingvin-share-reverse-proxy-configuration">Reverse proxy configuration</a> </span></dt> </dl></div><p>A self-hosted file sharing platform and an alternative for WeTransfer.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pingvin-share-basic-usage" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><p>By default, the module will execute Pingvin Share backend and frontend on the ports 8080 and 3000.</p><p>I will run two systemd services named <code class="literal">pingvin-share-backend</code> and <code class="literal">pingvin-share-frontend</code> in the specified data directory.</p><p>Here is a basic configuration:</p><pre><code class="programlisting nix">{
  services-pingvin-share = {
    enable = true;

    openFirewall = true;

    backend.port = 9010;
    frontend.port = 9011;
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pingvin-share-reverse-proxy-configuration" class="title" style="clear: both">Reverse proxy configuration   </h2>  </div> </div></div><p>The preferred method to run this service is behind a reverse proxy not to expose an open port. This, you can configure Nginx such like this:</p><pre><code class="programlisting nix">{
  services-pingvin-share = {
    enable = true;

    hostname = &quot;pingvin-share.domain.tld&quot;;
    https = true;

    nginx.enable = true;
  };
}
</code></pre><p>Furthermore, you can increase the maximal size of an uploaded file with the option <a class="link" href="options.html#opt-services.nginx.clientMaxBodySize"  >services.nginx.clientMaxBodySize</a>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pict-rs" class="title" >Pict-rs   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-pict-rs-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-pict-rs-usage">Usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-pict-rs-missing">Missing</a> </span></dt> </dl></div><p>pict-rs is a  a simple image hosting service.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pict-rs-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>the minimum to start pict-rs is</p><pre><code class="programlisting nix">{
  services.pict-rs.enable = true;
}
</code></pre><p>this will start the http server on port 8080 by default.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pict-rs-usage" class="title" style="clear: both">Usage   </h2>  </div> </div></div><p>pict-rs offers the following endpoints:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">POST /image</code> for uploading an image. Uploaded content must be valid multipart/form-data with an
image array located within the <code class="literal">images[]</code> key</p><p>This endpoint returns the following JSON structure on success with a 201 Created status</p><pre><code class="programlisting json">{
    &quot;files&quot;: [
        {
            &quot;delete_token&quot;: &quot;JFvFhqJA98&quot;,
            &quot;file&quot;: &quot;lkWZDRvugm.jpg&quot;
        },
        {
            &quot;delete_token&quot;: &quot;kAYy9nk2WK&quot;,
            &quot;file&quot;: &quot;8qFS0QooAn.jpg&quot;
        },
        {
            &quot;delete_token&quot;: &quot;OxRpM3sf0Y&quot;,
            &quot;file&quot;: &quot;1hJaYfGE01.jpg&quot;
        }
    ],
    &quot;msg&quot;: &quot;ok&quot;
}
</code></pre></li><li class="listitem"><p><code class="literal">GET /image/download?url=...</code> Download an image from a remote server, returning the same JSON
payload as the <code class="literal">POST</code> endpoint</p></li><li class="listitem"><p><code class="literal">GET /image/original/{file}</code> for getting a full-resolution image. <code class="literal">file</code> here is the <code class="literal">file</code> key from the
<code class="literal">/image</code> endpoint’s JSON</p></li><li class="listitem"><p><code class="literal">GET /image/details/original/{file}</code> for getting the details of a full-resolution image.
The returned JSON is structured like so:</p><pre><code class="programlisting json">{
    &quot;width&quot;: 800,
    &quot;height&quot;: 537,
    &quot;content_type&quot;: &quot;image/webp&quot;,
    &quot;created_at&quot;: [
        2020,
        345,
        67376,
        394363487
    ]
}
</code></pre></li><li class="listitem"><p><code class="literal">GET /image/process.{ext}?src={file}&amp;...</code> get a file with transformations applied.
existing transformations include</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><code class="literal">identity=true</code>: apply no changes</p></li><li class="listitem"><p><code class="literal">blur={float}</code>: apply a gaussian blur to the file</p></li><li class="listitem"><p><code class="literal">thumbnail={int}</code>: produce a thumbnail of the image fitting inside an <code class="literal">{int}</code> by <code class="literal">{int}</code>
square using raw pixel sampling</p></li><li class="listitem"><p><code class="literal">resize={int}</code>: produce a thumbnail of the image fitting inside an <code class="literal">{int}</code> by <code class="literal">{int}</code> square
using a Lanczos2 filter. This is slower than sampling but looks a bit better in some cases</p></li><li class="listitem"><p><code class="literal">crop={int-w}x{int-h}</code>: produce a cropped version of the image with an <code class="literal">{int-w}</code> by <code class="literal">{int-h}</code>
aspect ratio. The resulting crop will be centered on the image. Either the width or height
of the image will remain full-size, depending on the image’s aspect ratio and the requested
aspect ratio. For example, a 1600x900 image cropped with a 1x1 aspect ratio will become 900x900. A
1600x1100 image cropped with a 16x9 aspect ratio will become 1600x900.</p></li></ul></div><p>Supported <code class="literal">ext</code> file extensions include <code class="literal">png</code>, <code class="literal">jpg</code>, and <code class="literal">webp</code></p><p>An example of usage could be</p><pre><code class="programlisting">GET /image/process.jpg?src=asdf.png&amp;thumbnail=256&amp;blur=3.0
</code></pre><p>which would create a 256x256px JPEG thumbnail and blur it</p></li><li class="listitem"><p><code class="literal">GET /image/details/process.{ext}?src={file}&amp;...</code> for getting the details of a processed image.
The returned JSON is the same format as listed for the full-resolution details endpoint.</p></li><li class="listitem"><p><code class="literal">DELETE /image/delete/{delete_token}/{file}</code> or <code class="literal">GET /image/delete/{delete_token}/{file}</code> to
delete a file, where <code class="literal">delete_token</code> and <code class="literal">file</code> are from the <code class="literal">/image</code> endpoint’s JSON</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pict-rs-missing" class="title" style="clear: both">Missing   </h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Configuring the secure-api-key is not included yet. The envisioned basic use case is consumption on localhost by other services without exposing the service to the internet.</p></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud" class="title" >Nextcloud   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-nextcloud-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-nextcloud-occ"><code class="literal">nextcloud-occ</code></a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-nextcloud-pitfalls-during-upgrade">Common problems</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-nextcloud-httpd">Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)</a> </span></dt><dt> <span class="section">  <a href="index.html#installing-apps-php-extensions-nextcloud">Installing Apps and PHP extensions</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-nextcloud-known-warnings">Known warnings</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-nextcloud-maintainer-info">Maintainer information</a> </span></dt> </dl></div><p><a class="link" href="https://nextcloud.com/"  target="_top">Nextcloud</a> is an open-source,
self-hostable cloud platform. The server setup can be automated using
<a class="link" href="options.html#opt-services.nextcloud.enable"  >services.nextcloud</a>. A
desktop client is packaged at <code class="literal">pkgs.nextcloud-client</code>.</p><p>The current default by NixOS is <code class="literal">nextcloud31</code> which is also the latest
major version available.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud-basic-usage" class="title" style="clear: both">Basic usage   </h2>  </div> </div></div><p>Nextcloud is a PHP-based application which requires an HTTP server
(<a class="link" href="options.html#opt-services.nextcloud.enable"  ><code class="literal">services.nextcloud</code></a>
and optionally supports
<a class="link" href="options.html#opt-services.nginx.enable"  ><code class="literal">services.nginx</code></a>).</p><p>For the database, you can set
<a class="link" href="options.html#opt-services.nextcloud.config.dbtype"  ><code class="literal">services.nextcloud.config.dbtype</code></a> to
either <code class="literal">sqlite</code> (the default), <code class="literal">mysql</code>, or <code class="literal">pgsql</code>. The simplest is <code class="literal">sqlite</code>,
which will be automatically created and managed by the application. For the
last two, you can easily create a local database by setting
<a class="link" href="options.html#opt-services.nextcloud.database.createLocally"  ><code class="literal">services.nextcloud.database.createLocally</code></a>
to <code class="literal">true</code>, Nextcloud will automatically be configured to connect to it through
socket.</p><p>A very basic configuration may look like this:</p><pre><code class="programlisting nix">{ pkgs, ... }:
{
  services.nextcloud = {
    enable = true;
    hostName = &quot;nextcloud.tld&quot;;
    database.createLocally = true;
    config = {
      dbtype = &quot;pgsql&quot;;
      adminpassFile = &quot;/path/to/admin-pass-file&quot;;
    };
  };

  networking.firewall.allowedTCPPorts = [ 80 443 ];
}
</code></pre><p>The <code class="literal">hostName</code> option is used internally to configure an HTTP
server using <a class="link" href="https://php-fpm.org/"  target="_top"><code class="literal">PHP-FPM</code></a>
and <code class="literal">nginx</code>. The <code class="literal">config</code> attribute set is
used by the imperative installer and all values are written to an additional file
to ensure that changes can be applied by changing the module’s options.</p><p>In case the application serves multiple domains (those are checked with
<a class="link" href="https://www.php.net/manual/en/reserved.variables.server.php"  target="_top"><code class="literal">$_SERVER[&#x27;HTTP_HOST&#x27;]</code></a>)
it’s needed to add them to
<a class="link" href="options.html#opt-services.nextcloud.settings.trusted_domains"  ><code class="literal">services.nextcloud.settings.trusted_domains</code></a>.</p><p>Auto updates for Nextcloud apps can be enabled using
<a class="link" href="options.html#opt-services.nextcloud.autoUpdateApps.enable"  ><code class="literal">services.nextcloud.autoUpdateApps</code></a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud-occ" class="title" style="clear: both"><code class="literal">nextcloud-occ</code>   </h2>  </div> </div></div><p>The management command <a class="link" href="https://docs.nextcloud.com/server/stable/admin_manual/occ_command.html"  target="_top"><code class="literal">occ</code></a> can be
invoked by using the <code class="literal">nextcloud-occ</code> wrapper that’s globally available on a system with Nextcloud enabled.</p><p>It requires elevated permissions to become the <code class="literal">nextcloud</code> user. Given the way the privilege
escalation is implemented, parameters passed via the environment to Nextcloud (e.g. <code class="literal">OC_PASS</code>) are
currently ignored.</p><p>Custom service units that need to run <code class="literal">nextcloud-occ</code> either need elevated privileges
or the systemd configuration from <code class="literal">nextcloud-setup.service</code> (recommended):</p><pre><code class="programlisting nix">{ config, ... }: {
  systemd.services.my-custom-service = {
    script = &#x27;&#x27;
      nextcloud-occ …
    &#x27;&#x27;;
    serviceConfig = {
      inherit (config.systemd.services.nextcloud-cron.serviceConfig)
        User
        LoadCredential
        KillMode;
    };
  };
}
</code></pre><p>Please note that the options required are subject to change. Please make sure to read the
release notes when upgrading.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud-pitfalls-during-upgrade" class="title" style="clear: both">Common problems   </h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><span class="strong"><strong>General notes.</strong></span>
Unfortunately Nextcloud appears to be very stateful when it comes to
managing its own configuration. The config file lives in the home directory
of the <code class="literal">nextcloud</code> user (by default
<code class="literal">/var/lib/nextcloud/config/config.php</code>) and is also used to
track several states of the application (e.g., whether installed or not).</p><p>All configuration parameters are also stored in
<code class="filename">/var/lib/nextcloud/config/override.config.php</code> which is generated by
the module and linked from the store to ensure that all values from
<code class="filename">config.php</code> can be modified by the module.
However <code class="filename">config.php</code> manages the application’s state and shouldn’t be
touched manually because of that.</p><div class="warning"><h3 class="title">Warning</h3><p>Don’t delete <code class="filename">config.php</code>! This file
tracks the application’s state and a deletion can cause unwanted
side-effects!</p></div><div class="warning"><h3 class="title">Warning</h3><p>Don’t rerun <code class="literal">nextcloud-occ maintenance:install</code>!
This command tries to install the application
and can cause unwanted side-effects!</p></div></li><li class="listitem"><p><span class="strong"><strong>Multiple version upgrades.</strong></span>
Nextcloud doesn’t allow to move more than one major-version forward. E.g., if you’re on
<code class="literal">v16</code>, you cannot upgrade to <code class="literal">v18</code>, you need to upgrade to
<code class="literal">v17</code> first. This is ensured automatically as long as the
<a class="link" href="options.html#opt-system.stateVersion"  >stateVersion</a> is declared properly. In that case
the oldest version available (one major behind the one from the previous NixOS
release) will be selected by default and the module will generate a warning that reminds
the user to upgrade to latest Nextcloud <span class="emphasis"><em>after</em></span> that deploy.</p></li><li class="listitem"><p><span class="strong"><strong><code class="literal">Error: Command &quot;upgrade&quot; is not defined.</code></strong></span>
This error usually occurs if the initial installation
(<span class="command"><strong>nextcloud-occ maintenance:install</strong></span>) has failed. After that, the application
is not installed, but the upgrade is attempted to be executed. Further context can
be found in <a class="link" href="https://github.com/NixOS/nixpkgs/issues/111175"  target="_top">NixOS/nixpkgs#111175</a>.</p><p>First of all, it makes sense to find out what went wrong by looking at the logs
of the installation via <span class="command"><strong>journalctl -u nextcloud-setup</strong></span> and try to fix
the underlying issue.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: circle;"><li class="listitem"><p>If this occurs on an <span class="emphasis"><em>existing</em></span> setup, this is most likely because
the maintenance mode is active. It can be deactivated by running
<span class="command"><strong>nextcloud-occ maintenance:mode --off</strong></span>. It’s advisable though to
check the logs first on why the maintenance mode was activated.</p></li><li class="listitem"><div class="warning"><h3 class="title">Warning</h3><p>Only perform the following measures on
<span class="emphasis"><em>freshly installed instances!</em></span></p></div><p>A re-run of the installer can be forced by <span class="emphasis"><em>deleting</em></span>
<code class="filename">/var/lib/nextcloud/config/config.php</code>. This is the only time
advisable because the fresh install doesn’t have any state that can be lost.
In case that doesn’t help, an entire re-creation can be forced via
<span class="command"><strong>rm -rf ~nextcloud/</strong></span>.</p></li></ul></div></li><li class="listitem"><p><span class="strong"><strong>Server-side encryption.</strong></span>
Nextcloud supports <a class="link" href="https://docs.nextcloud.com/server/latest/admin_manual/configuration_files/encryption_configuration.html"  target="_top">server-side encryption (SSE)</a>.
This is not an end-to-end encryption, but can be used to encrypt files that will be persisted
to external storage such as S3.</p></li><li class="listitem"><p><span class="strong"><strong>Issues with file permissions / unsafe path transitions</strong></span></p><p><a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-tmpfiles.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd-tmpfiles</span>(8)</span></a> makes sure that the paths for</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>configuration (including declarative config)</p></li><li class="listitem"><p>data</p></li><li class="listitem"><p>app store</p></li><li class="listitem"><p>home directory itself (usually <code class="literal">/var/lib/nextcloud</code>)</p></li></ul></div><p>are properly set up. However, <code class="literal">systemd-tmpfiles</code> will refuse to do so
if it detects an unsafe path transition, i.e. creating files/directories
within a directory that is neither owned by <code class="literal">root</code> nor by <code class="literal">nextcloud</code>, the
owning user of the files/directories to be created.</p><p>Symptoms of that include</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><code class="literal">config/override.config.php</code> not being updated (and the config file
eventually being garbage-collected).</p></li><li class="listitem"><p>failure to read from application data.</p></li></ul></div><p>To work around that, please make sure that all directories in question
are owned by <code class="literal">nextcloud:nextcloud</code>.</p></li><li class="listitem"><p><span class="strong"><strong><code class="literal">Failed to open stream: No such file or directory</code> after deploys</strong></span></p><p>Symptoms are errors like this after a deployment that disappear after
a few minutes:</p><pre><code class="programlisting">Warning: file_get_contents(/run/secrets/nextcloud_db_password): Failed to open stream: No such file or directory in /nix/store/lqw657xbh6h67ccv9cgv104qhcs1i2vw-nextcloud-config.php on line 11

Warning: http_response_code(): Cannot set response code - headers already sent (output started at /nix/store/lqw657xbh6h67ccv9cgv104qhcs1i2vw-nextcloud-config.php:11) in /nix/store/ikxpaq7kjdhpr4w7cgl1n28kc2gvlhg6-nextcloud-29.0.7/lib/base.php on line 639
Cannot decode /run/secrets/nextcloud_secrets, because: Syntax error
</code></pre><p>This can happen if <a class="xref" href="options.html#opt-services.nextcloud.secretFile"  ><code class="option">services.nextcloud.secretFile</code></a> or
<a class="xref" href="options.html#opt-services.nextcloud.config.dbpassFile"  ><code class="option">services.nextcloud.config.dbpassFile</code></a> are managed by
<a class="link" href="https://github.com/Mic92/sops-nix/"  target="_top">sops-nix</a>.</p><p>Here, <code class="literal">/run/secrets/nextcloud_secrets</code> is a symlink to
<code class="literal">/run/secrets.d/N/nextcloud_secrets</code>. The <code class="literal">N</code> will be incremented
when the sops-nix activation script runs, i.e.
<code class="literal">/run/secrets.d/N</code> doesn’t exist anymore after a deploy,
only <code class="literal">/run/secrets.d/N+1</code>.</p><p>PHP maintains a <a class="link" href="https://www.php.net/manual/en/ini.core.php#ini.realpath-cache-size"  target="_top">cache for <code class="literal">realpath</code></a>
that still resolves to the old path which is causing
the <code class="literal">No such file or directory</code> error. Interestingly,
the cache isn’t used for <code class="literal">file_exists</code> which is why this warning
comes instead of the error from <code class="literal">nix_read_secret</code> in
<code class="literal">override.config.php</code>.</p><p>One option to work around this is to turn off the cache by setting
the cache size to zero:</p><pre><code class="programlisting nix">services.nextcloud.phpOptions.&quot;realpath_cache_size&quot; = &quot;0&quot;;
</code></pre></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud-httpd" class="title" style="clear: both">Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)   </h2>  </div> </div></div><p>By default, <code class="literal">nginx</code> is used as reverse-proxy for <code class="literal">nextcloud</code>.
However, it’s possible to use e.g. <code class="literal">httpd</code> by explicitly disabling
<code class="literal">nginx</code> using <a class="xref" href="options.html#opt-services.nginx.enable"  ><code class="option">services.nginx.enable</code></a> and fixing the
settings <code class="literal">listen.owner</code> &amp; <code class="literal">listen.group</code> in the
<a class="link" href="options.html#opt-services.phpfpm.pools"  >corresponding <code class="literal">phpfpm</code> pool</a>.</p><p>An exemplary configuration may look like this:</p><pre><code class="programlisting nix">{ config, lib, pkgs, ... }: {
  services.nginx.enable = false;
  services.nextcloud = {
    enable = true;
    hostName = &quot;localhost&quot;;

    /* further, required options */
  };
  services.phpfpm.pools.nextcloud.settings = {
    &quot;listen.owner&quot; = config.services.httpd.user;
    &quot;listen.group&quot; = config.services.httpd.group;
  };
  services.httpd = {
    enable = true;
    adminAddr = &quot;webmaster@localhost&quot;;
    extraModules = [ &quot;proxy_fcgi&quot; ];
    virtualHosts.&quot;localhost&quot; = {
      documentRoot = config.services.nextcloud.package;
      extraConfig = &#x27;&#x27;
        &lt;Directory &quot;${config.services.nextcloud.package}&quot;&gt;
          &lt;FilesMatch &quot;\.php$&quot;&gt;
            &lt;If &quot;-f %{REQUEST_FILENAME}&quot;&gt;
              SetHandler &quot;proxy:unix:${config.services.phpfpm.pools.nextcloud.socket}|fcgi://localhost/&quot;
            &lt;/If&gt;
          &lt;/FilesMatch&gt;
          &lt;IfModule mod_rewrite.c&gt;
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.php$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.php [L]
          &lt;/IfModule&gt;
          DirectoryIndex index.php
          Require all granted
          Options +FollowSymLinks
        &lt;/Directory&gt;
      &#x27;&#x27;;
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="installing-apps-php-extensions-nextcloud" class="title" style="clear: both">Installing Apps and PHP extensions   </h2>  </div> </div></div><p>Nextcloud apps are installed statefully through the web interface.
Some apps may require extra PHP extensions to be installed.
This can be configured with the <a class="xref" href="options.html#opt-services.nextcloud.phpExtraExtensions"  ><code class="option">services.nextcloud.phpExtraExtensions</code></a> setting.</p><p>Alternatively, extra apps can also be declared with the <a class="xref" href="options.html#opt-services.nextcloud.extraApps"  ><code class="option">services.nextcloud.extraApps</code></a> setting.
When using this setting, apps can no longer be managed statefully because this can lead to Nextcloud updating apps
that are managed by Nix:</p><pre><code class="programlisting nix">{ config, pkgs, ... }: {
  services.nextcloud.extraApps = with config.services.nextcloud.package.packages.apps; [
    inherit user_oidc calendar contacts;
  ];
}
</code></pre><p>Keep in mind that this is essentially a mirror of the apps from the appstore, but managed in
nixpkgs. This is by no means a curated list of apps that receive special testing on each update.</p><p>If you want automatic updates it is recommended that you use web interface to install apps.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud-known-warnings" class="title" style="clear: both">Known warnings   </h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-nextcloud-warning-logreader" class="title" >Logreader application only supports “file” log_type   </h3>  </div> </div></div><p>This is because</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>our module writes logs into the journal (<code class="literal">journalctl -t Nextcloud</code>)</p></li><li class="listitem"><p>the Logreader application that allows reading logs in the admin panel is enabled
by default and requires logs written to a file.</p></li></ul></div><p>If you want to view logs in the admin panel,
set <a class="xref" href="options.html#opt-services.nextcloud.settings.log_type"  ><code class="option">services.nextcloud.settings.log_type</code></a> to “file”.</p><p>If you prefer logs in the journal, disable the logreader application to shut up the
“info”. We can’t really do that by default since whether apps are enabled/disabled
is part of the application’s state and tracked inside the database.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud-maintainer-info" class="title" style="clear: both">Maintainer information   </h2>  </div> </div></div><p>As stated in the previous paragraph, we must provide a clean upgrade-path for Nextcloud
since it cannot move more than one major version forward on a single upgrade. This chapter
adds some notes how Nextcloud updates should be rolled out in the future.</p><p>While minor and patch-level updates are no problem and can be done directly in the
package-expression (and should be backported to supported stable branches after that),
major-releases should be added in a new attribute (e.g. Nextcloud <code class="literal">v19.0.0</code>
should be available in <code class="literal">nixpkgs</code> as <code class="literal">pkgs.nextcloud19</code>).
To provide simple upgrade paths it’s generally useful to backport those as well to stable
branches. As long as the package-default isn’t altered, this won’t break existing setups.
After that, the versioning-warning in the <code class="literal">nextcloud</code>-module should be
updated to make sure that the
<a class="link" href="options.html#opt-services.nextcloud.package"  >package</a>-option selects the latest version
on fresh setups.</p><p>If major-releases will be abandoned by upstream, we should check first if those are needed
in NixOS for a safe upgrade-path before removing those. In that case we should keep those
packages, but mark them as insecure in an expression like this (in
<code class="literal">&lt;nixpkgs/pkgs/servers/nextcloud/default.nix&gt;</code>):</p><pre><code class="programlisting nix">/* ... */
{
  nextcloud17 = generic {
    version = &quot;17.0.x&quot;;
    sha256 = &quot;0000000000000000000000000000000000000000000000000000&quot;;
    eol = true;
  };
}
</code></pre><p>Ideally we should make sure that it’s possible to jump two NixOS versions forward:
i.e. the warnings and the logic in the module should guard a user to upgrade from a
Nextcloud on e.g. 19.09 to a Nextcloud on 20.09.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo" class="title" >Matomo   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-matomo-database-setup">Database Setup</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-matomo-archive-processing">Archive Processing</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-matomo-backups">Backup</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-matomo-issues">Issues</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-matomo-other-web-servers">Using other Web Servers than nginx</a> </span></dt> </dl></div><p>Matomo is a real-time web analytics application. This module configures
php-fpm as backend for Matomo, optionally configuring an nginx vhost as well.</p><p>An automatic setup is not supported by Matomo, so you need to configure Matomo
itself in the browser-based Matomo setup.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo-database-setup" class="title" style="clear: both">Database Setup   </h2>  </div> </div></div><p>You also need to configure a MariaDB or MySQL database and -user for Matomo
yourself, and enter those credentials in your browser. You can use
passwordless database authentication via the UNIX_SOCKET authentication
plugin with the following SQL commands:</p><pre><code class="programlisting"># For MariaDB
INSTALL PLUGIN unix_socket SONAME &#x27;auth_socket&#x27;;
CREATE DATABASE matomo;
CREATE USER &#x27;matomo&#x27;@&#x27;localhost&#x27; IDENTIFIED WITH unix_socket;
GRANT ALL PRIVILEGES ON matomo.* TO &#x27;matomo&#x27;@&#x27;localhost&#x27;;

# For MySQL
INSTALL PLUGIN auth_socket SONAME &#x27;auth_socket.so&#x27;;
CREATE DATABASE matomo;
CREATE USER &#x27;matomo&#x27;@&#x27;localhost&#x27; IDENTIFIED WITH auth_socket;
GRANT ALL PRIVILEGES ON matomo.* TO &#x27;matomo&#x27;@&#x27;localhost&#x27;;
</code></pre><p>Then fill in <code class="literal">matomo</code> as database user and database name,
and leave the password field blank. This authentication works by allowing
only the <code class="literal">matomo</code> unix user to authenticate as the
<code class="literal">matomo</code> database user (without needing a password), but no
other users. For more information on passwordless login, see
<a class="link" href="https://mariadb.com/kb/en/mariadb/unix_socket-authentication-plugin/"  target="_top">https://mariadb.com/kb/en/mariadb/unix_socket-authentication-plugin/</a>.</p><p>Of course, you can use password based authentication as well, e.g. when the
database is not on the same host.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo-archive-processing" class="title" style="clear: both">Archive Processing   </h2>  </div> </div></div><p>This module comes with the systemd service
<code class="literal">matomo-archive-processing.service</code> and a timer that
automatically triggers archive processing every hour. This means that you
can safely
<a class="link" href="https://matomo.org/docs/setup-auto-archiving/#disable-browser-triggers-for-matomo-archiving-and-limit-matomo-reports-to-updating-every-hour"  target="_top">disable browser triggers for Matomo archiving</a> at
<code class="literal">Administration &gt; System &gt; General Settings</code>.</p><p>With automatic archive processing, you can now also enable to
<a class="link" href="https://matomo.org/docs/privacy/#step-2-delete-old-visitors-logs"  target="_top">delete old visitor logs</a>
at <code class="literal">Administration &gt; System &gt; Privacy</code>, but make sure that you run <code class="literal">systemctl start matomo-archive-processing.service</code> at least once without errors if
you have already collected data before, so that the reports get archived
before the source data gets deleted.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo-backups" class="title" style="clear: both">Backup   </h2>  </div> </div></div><p>You only need to take backups of your MySQL database and the
<code class="filename">/var/lib/matomo/config/config.ini.php</code> file. Use a user
in the <code class="literal">matomo</code> group or root to access the file. For more
information, see
<a class="link" href="https://matomo.org/faq/how-to-install/faq_138/"  target="_top">https://matomo.org/faq/how-to-install/faq_138/</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo-issues" class="title" style="clear: both">Issues   </h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Matomo will warn you that the JavaScript tracker is not writable. This is
because it’s located in the read-only nix store. You can safely ignore
this, unless you need a plugin that needs JavaScript tracker access.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo-other-web-servers" class="title" style="clear: both">Using other Web Servers than nginx   </h2>  </div> </div></div><p>You can use other web servers by forwarding calls for
<code class="filename">index.php</code> and <code class="filename">piwik.php</code> to the
<a class="link" href="options.html#opt-services.phpfpm.pools._name_.socket"  ><code class="literal">services.phpfpm.pools.&lt;name&gt;.socket</code></a>
fastcgi unix socket. You can use
the nginx configuration in the module code as a reference to what else
should be configured.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-lemmy" class="title" >Lemmy   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-lemmy-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-lemmy-usage">Usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-lemmy-missing">Missing</a> </span></dt> </dl></div><p>Lemmy is a federated alternative to reddit in rust.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-lemmy-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>the minimum to start lemmy is</p><pre><code class="programlisting nix">{
  services.lemmy = {
    enable = true;
    settings = {
      hostname = &quot;lemmy.union.rocks&quot;;
      database.createLocally = true;
    };
    caddy.enable = true;
  };
}
</code></pre><p>this will start the backend on port 8536 and the frontend on port 1234.
It will expose your instance with a caddy reverse proxy to the hostname you’ve provided.
Postgres will be initialized on that same instance automatically.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-lemmy-usage" class="title" style="clear: both">Usage   </h2>  </div> </div></div><p>On first connection you will be asked to define an admin user.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-lemmy-missing" class="title" style="clear: both">Missing   </h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Exposing with nginx is not implemented yet.</p></li><li class="listitem"><p>This has been tested using a local database with a unix socket connection. Using different database settings will likely require modifications</p></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak" class="title" >Keycloak   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-keycloak-admin">Administration</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-keycloak-database">Database access</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-keycloak-hostname">Hostname</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-keycloak-tls">Setting up TLS/SSL</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-keycloak-themes">Themes</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-keycloak-settings">Configuration file settings</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-keycloak-example-config">Example configuration</a> </span></dt> </dl></div><p><a class="link" href="https://www.keycloak.org/"  target="_top">Keycloak</a> is an
open source identity and access management server with support for
<a class="link" href="https://openid.net/connect/"  target="_top">OpenID Connect</a>,
<a class="link" href="https://oauth.net/2/"  target="_top">OAUTH 2.0</a> and
<a class="link" href="https://en.wikipedia.org/wiki/SAML_2.0"  target="_top">SAML 2.0</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-admin" class="title" style="clear: both">Administration   </h2>  </div> </div></div><p>An administrative user with the username
<code class="literal">admin</code> is automatically created in the
<code class="literal">master</code> realm. Its initial password can be
configured by setting <a class="xref" href="options.html#opt-services.keycloak.initialAdminPassword"  ><code class="option">services.keycloak.initialAdminPassword</code></a>
and defaults to <code class="literal">changeme</code>. The password is
not stored safely and should be changed immediately in the
admin panel.</p><p>Refer to the <a class="link" href="https://www.keycloak.org/docs/latest/server_admin/index.html"  target="_top">Keycloak Server Administration Guide</a> for information on
how to administer your Keycloak
instance.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-database" class="title" style="clear: both">Database access   </h2>  </div> </div></div><p>Keycloak can be used with either PostgreSQL, MariaDB or
MySQL. Which one is used can be
configured in <a class="xref" href="options.html#opt-services.keycloak.database.type"  ><code class="option">services.keycloak.database.type</code></a>. The selected
database will automatically be enabled and a database and role
created unless <a class="xref" href="options.html#opt-services.keycloak.database.host"  ><code class="option">services.keycloak.database.host</code></a> is changed
from its default of <code class="literal">localhost</code> or
<a class="xref" href="options.html#opt-services.keycloak.database.createLocally"  ><code class="option">services.keycloak.database.createLocally</code></a> is set to <code class="literal">false</code>.</p><p>External database access can also be configured by setting
<a class="xref" href="options.html#opt-services.keycloak.database.host"  ><code class="option">services.keycloak.database.host</code></a>,
<a class="xref" href="options.html#opt-services.keycloak.database.name"  ><code class="option">services.keycloak.database.name</code></a>,
<a class="xref" href="options.html#opt-services.keycloak.database.username"  ><code class="option">services.keycloak.database.username</code></a>,
<a class="xref" href="options.html#opt-services.keycloak.database.useSSL"  ><code class="option">services.keycloak.database.useSSL</code></a> and
<a class="xref" href="options.html#opt-services.keycloak.database.caCert"  ><code class="option">services.keycloak.database.caCert</code></a> as
appropriate. Note that you need to manually create the database
and allow the configured database user full access to it.</p><p><a class="xref" href="options.html#opt-services.keycloak.database.passwordFile"  ><code class="option">services.keycloak.database.passwordFile</code></a>
must be set to the path to a file containing the password used
to log in to the database. If <a class="xref" href="options.html#opt-services.keycloak.database.host"  ><code class="option">services.keycloak.database.host</code></a>
and <a class="xref" href="options.html#opt-services.keycloak.database.createLocally"  ><code class="option">services.keycloak.database.createLocally</code></a>
are kept at their defaults, the database role
<code class="literal">keycloak</code> with that password is provisioned
on the local database instance.</p><div class="warning"><h3 class="title">Warning</h3><p>The path should be provided as a string, not a Nix path, since Nix
paths are copied into the world readable Nix store.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-hostname" class="title" style="clear: both">Hostname   </h2>  </div> </div></div><p>The hostname is used to build the public URL used as base for
all frontend requests and must be configured through
<a class="xref" href="options.html#opt-services.keycloak.settings.hostname"  ><code class="option">services.keycloak.settings.hostname</code></a>.</p><div class="note"><h3 class="title">Note</h3><p>If you’re migrating an old Wildfly based Keycloak instance
and want to keep compatibility with your current clients,
you’ll likely want to set <a class="xref" href="options.html#opt-services.keycloak.settings.http-relative-path"  ><code class="option">services.keycloak.settings.http-relative-path</code></a>
to <code class="literal">/auth</code>. See the option description
for more details.</p></div><p><a class="xref" href="options.html#opt-services.keycloak.settings.hostname-backchannel-dynamic"  ><code class="option">services.keycloak.settings.hostname-backchannel-dynamic</code></a>
Keycloak has the capability to offer a separate URL for backchannel requests,
enabling internal communication while maintaining the use of a public URL
for frontchannel requests. Moreover, the backchannel is dynamically
resolved based on incoming headers endpoint.</p><p>For more information on hostname configuration, see the <a class="link" href="https://www.keycloak.org/server/hostname"  target="_top">Hostname
section of the Keycloak Server Installation and Configuration
Guide</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-tls" class="title" style="clear: both">Setting up TLS/SSL   </h2>  </div> </div></div><p>By default, Keycloak won’t accept
unsecured HTTP connections originating from outside its local
network.</p><p>HTTPS support requires a TLS/SSL certificate and a private key,
both <a class="link" href="https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail"  target="_top">PEM formatted</a>.
Their paths should be set through
<a class="xref" href="options.html#opt-services.keycloak.sslCertificate"  ><code class="option">services.keycloak.sslCertificate</code></a> and
<a class="xref" href="options.html#opt-services.keycloak.sslCertificateKey"  ><code class="option">services.keycloak.sslCertificateKey</code></a>.</p><div class="warning"><h3 class="title">Warning</h3><p>The paths should be provided as a strings, not a Nix paths,
since Nix paths are copied into the world readable Nix store.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-themes" class="title" style="clear: both">Themes   </h2>  </div> </div></div><p>You can package custom themes and make them visible to
Keycloak through <a class="xref" href="options.html#opt-services.keycloak.themes"  ><code class="option">services.keycloak.themes</code></a>. See the
<a class="link" href="https://www.keycloak.org/docs/latest/server_development/#_themes"  target="_top">Themes section of the Keycloak Server Development Guide</a> and the description of the aforementioned NixOS option for
more information.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-settings" class="title" style="clear: both">Configuration file settings   </h2>  </div> </div></div><p>Keycloak server configuration parameters can be set in
<a class="xref" href="options.html#opt-services.keycloak.settings"  ><code class="option">services.keycloak.settings</code></a>. These correspond
directly to options in
<code class="filename">conf/keycloak.conf</code>. Some of the most
important parameters are documented as suboptions, the rest can
be found in the <a class="link" href="https://www.keycloak.org/server/all-config"  target="_top">All
configuration section of the Keycloak Server Installation and
Configuration Guide</a>.</p><p>Options containing secret data should be set to an attribute
set containing the attribute <code class="literal">_secret</code> - a
string pointing to a file containing the value the option
should be set to. See the description of
<a class="xref" href="options.html#opt-services.keycloak.settings"  ><code class="option">services.keycloak.settings</code></a> for an example.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-example-config" class="title" style="clear: both">Example configuration   </h2>  </div> </div></div><p>A basic configuration with some custom settings could look like this:</p><pre><code class="programlisting nix">{
  services.keycloak = {
    enable = true;
    settings = {
      hostname = &quot;keycloak.example.com&quot;;
      hostname-strict-backchannel = true;
    };
    initialAdminPassword = &quot;e6Wcm0RrtegMEHl&quot;;  # change on first login
    sslCertificate = &quot;/run/keys/ssl_cert&quot;;
    sslCertificateKey = &quot;/run/keys/ssl_key&quot;;
    database.passwordFile = &quot;/run/keys/db_password&quot;;
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-jitsi-meet" class="title" >Jitsi Meet   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-jitsi-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-jitsi-configuration">Configuration</a> </span></dt> </dl></div><p>With Jitsi Meet on NixOS you can quickly configure a complete,
private, self-hosted video conferencing solution.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-jitsi-basic-usage" class="title" style="clear: both">Basic usage   </h2>  </div> </div></div><p>A minimal configuration using Let’s Encrypt for TLS certificates looks like this:</p><pre><code class="programlisting nix">{
  services.jitsi-meet = {
    enable = true;
    hostName = &quot;jitsi.example.com&quot;;
  };
  services.jitsi-videobridge.openFirewall = true;
  networking.firewall.allowedTCPPorts = [ 80 443 ];
  security.acme.email = &quot;me@example.com&quot;;
  security.acme.acceptTerms = true;
}
</code></pre><p>Jitsi Meet depends on the Prosody XMPP server only for message passing from
the web browser while the default Prosody configuration is intended for use
with standalone XMPP clients and XMPP federation. If you only use Prosody as
a backend for Jitsi Meet it is therefore recommended to also enable
<code class="option">services.jitsi-meet.prosody.lockdown</code> option to disable unnecessary
Prosody features such as federation or the file proxy.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-jitsi-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><p>Here is the minimal configuration with additional configurations:</p><pre><code class="programlisting nix">{
  services.jitsi-meet = {
    enable = true;
    hostName = &quot;jitsi.example.com&quot;;
    prosody.lockdown = true;
    config = {
      enableWelcomePage = false;
      prejoinPageEnabled = true;
      defaultLang = &quot;fi&quot;;
    };
    interfaceConfig = {
      SHOW_JITSI_WATERMARK = false;
      SHOW_WATERMARK_FOR_GUESTS = false;
    };
  };
  services.jitsi-videobridge.openFirewall = true;
  networking.firewall.allowedTCPPorts = [ 80 443 ];
  security.acme.email = &quot;me@example.com&quot;;
  security.acme.acceptTerms = true;
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-honk" class="title" >Honk   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-honk-basic-usage">Basic usage</a> </span></dt> </dl></div><p>With Honk on NixOS you can quickly configure a complete ActivityPub server with
minimal setup and support costs.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-honk-basic-usage" class="title" style="clear: both">Basic usage   </h2>  </div> </div></div><p>A minimal configuration looks like this:</p><pre><code class="programlisting nix">{
  services.honk = {
    enable = true;
    host = &quot;0.0.0.0&quot;;
    port = 8080;
    username = &quot;username&quot;;
    passwordFile = &quot;/etc/honk/password.txt&quot;;
    servername = &quot;honk.example.com&quot;;
  };

  networking.firewall.allowedTCPPorts = [ 8080 ];
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-hatsu" class="title" >Hatsu   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-hatsu-quickstart">Quickstart</a> </span></dt> </dl></div><p><a class="link" href="https://github.com/importantimport/hatsu"  target="_top">Hatsu</a> is an fully-automated ActivityPub bridge for static sites.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-hatsu-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>the minimum configuration to start hatsu server would look like this:</p><pre><code class="programlisting nix">{
  services.hatsu = {
    enable = true;
    settings = {
      HATSU_DOMAIN = &quot;hatsu.local&quot;;
      HATSU_PRIMARY_ACCOUNT = &quot;example.com&quot;;
    };
  };
}
</code></pre><p>this will start the hatsu server on port 3939 and save the database in <code class="literal">/var/lib/hatsu/hatsu.sqlite3</code>.</p><p>Please refer to the <a class="link" href="https://hatsu.cli.rs"  target="_top">Hatsu Documentation</a> for additional configuration options.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-grocy" class="title" >Grocy   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-grocy-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-grocy-settings">Settings</a> </span></dt> </dl></div><p><a class="link" href="https://grocy.info/"  target="_top">Grocy</a> is a web-based self-hosted groceries
&amp; household management solution for your home.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-grocy-basic-usage" class="title" style="clear: both">Basic usage   </h2>  </div> </div></div><p>A very basic configuration may look like this:</p><pre><code class="programlisting nix">{ pkgs, ... }:
{
  services.grocy = {
    enable = true;
    hostName = &quot;grocy.tld&quot;;
  };
}
</code></pre><p>This configures a simple vhost using <a class="link" href="options.html#opt-services.nginx.enable"  >nginx</a>
which listens to <code class="literal">grocy.tld</code> with fully configured ACME/LE (this can be
disabled by setting <a class="link" href="options.html#opt-services.grocy.nginx.enableSSL"  >services.grocy.nginx.enableSSL</a>
to <code class="literal">false</code>). After the initial setup the credentials <code class="literal">admin:admin</code>
can be used to login.</p><p>The application’s state is persisted at <code class="literal">/var/lib/grocy/grocy.db</code> in a
<code class="literal">sqlite3</code> database. The migration is applied when requesting the <code class="literal">/</code>-route
of the application.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-grocy-settings" class="title" style="clear: both">Settings   </h2>  </div> </div></div><p>The configuration for <code class="literal">grocy</code> is located at <code class="literal">/etc/grocy/config.php</code>.
By default, the following settings can be defined in the NixOS-configuration:</p><pre><code class="programlisting nix">{ pkgs, ... }:
{
  services.grocy.settings = {
    # The default currency in the system for invoices etc.
    # Please note that exchange rates aren&#x27;t taken into account, this
    # is just the setting for what&#x27;s shown in the frontend.
    currency = &quot;EUR&quot;;

    # The display language (and locale configuration) for grocy.
    culture = &quot;de&quot;;

    calendar = {
      # Whether or not to show the week-numbers
      # in the calendar.
      showWeekNumber = true;

      # Index of the first day to be shown in the calendar (0=Sunday, 1=Monday,
      # 2=Tuesday and so on).
      firstDayOfWeek = 2;
    };
  };
}
</code></pre><p>If you want to alter the configuration file on your own, you can do this manually with
an expression like this:</p><pre><code class="programlisting nix">{ lib, ... }:
{
  environment.etc.&quot;grocy/config.php&quot;.text = lib.mkAfter &#x27;&#x27;
    // Arbitrary PHP code in grocy&#x27;s configuration file
  &#x27;&#x27;;
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gotosocial" class="title" >GoToSocial   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#modules-services-gotosocial-service-configuration">Service configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#modules-services-gotosocial-proxy-configuration">Proxy configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#modules-services-gotosocial-user-management">User management</a> </span></dt> </dl></div><p><a class="link" href="https://gotosocial.org/"  target="_top">GoToSocial</a> is an ActivityPub social network server, written in Golang.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-gotosocial-service-configuration" class="title" style="clear: both">Service configuration   </h2>  </div> </div></div><p>The following configuration sets up the PostgreSQL as database backend and binds
GoToSocial to <code class="literal">127.0.0.1:8080</code>, expecting to be run behind a HTTP proxy on <code class="literal">gotosocial.example.com</code>.</p><pre><code class="programlisting nix">{
  services.gotosocial = {
    enable = true;
    setupPostgresqlDB = true;
    settings = {
      application-name = &quot;My GoToSocial&quot;;
      host = &quot;gotosocial.example.com&quot;;
      protocol = &quot;https&quot;;
      bind-address = &quot;127.0.0.1&quot;;
      port = 8080;
    };
  };
}
</code></pre><p>Please refer to the <a class="link" href="https://docs.gotosocial.org/en/latest/configuration/general/"  target="_top">GoToSocial Documentation</a>
for additional configuration options.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-gotosocial-proxy-configuration" class="title" style="clear: both">Proxy configuration   </h2>  </div> </div></div><p>Although it is possible to expose GoToSocial directly, it is common practice to operate it behind an
HTTP reverse proxy such as nginx.</p><pre><code class="programlisting nix">{
  networking.firewall.allowedTCPPorts = [ 80 443 ];
  services.nginx = {
    enable = true;
    clientMaxBodySize = &quot;40M&quot;;
    virtualHosts = with config.services.gotosocial.settings; {
      &quot;${host}&quot; = {
        enableACME = true;
        forceSSL = true;
        locations = {
          &quot;/&quot; = {
            recommendedProxySettings = true;
            proxyWebsockets = true;
            proxyPass = &quot;http://${bind-address}:${toString port}&quot;;
          };
        };
      };
    };
  };
}
</code></pre><p>Please refer to <a class="xref" href="index.html#module-security-acme" title="SSL/TLS Certificates with ACME" ><em>SSL/TLS Certificates with ACME</em></a> for details on how to provision an SSL/TLS certificate.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-gotosocial-user-management" class="title" style="clear: both">User management   </h2>  </div> </div></div><p>After the GoToSocial service is running, the <code class="literal">gotosocial-admin</code> utility can be used to manage users. In particular an
administrative user can be created with</p><pre><code class="programlisting ShellSession">$ sudo gotosocial-admin account create --username &lt;nickname&gt; --email &lt;email&gt; --password &lt;password&gt;
$ sudo gotosocial-admin account confirm --username &lt;nickname&gt;
$ sudo gotosocial-admin account promote --username &lt;nickname&gt;
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-glance" class="title" >Glance   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-glance-quickstart">Quickstart</a> </span></dt> </dl></div><p>Glance is a self-hosted dashboard that puts all your feeds in one place.</p><p>Visit <a class="link" href="https://github.com/glanceapp/glance"  target="_top">the Glance project page</a> to learn
more about it.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-glance-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>Checkout the <a class="link" href="https://github.com/glanceapp/glance/blob/main/docs/configuration.md"  target="_top">configuration docs</a> to learn more.
Use the following configuration to start a public instance of Glance locally:</p><pre><code class="programlisting nix">{
  services.glance = {
    enable = true;
    settings = {
      pages = [
        {
          name = &quot;Home&quot;;
          columns = [
            {
              size = &quot;full&quot;;
              widgets = [
                { type = &quot;calendar&quot;; }
                {
                  type = &quot;weather&quot;;
                  location = &quot;Nivelles, Belgium&quot;;
                }
              ];
            }
          ];
        }
      ];
    };
    openFirewall = true;
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-filesender" class="title" >FileSender   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-filesender-quickstart">Quickstart</a> </span></dt> </dl></div><p><a class="link" href="https://filesender.org/software/"  target="_top">FileSender</a> is a software that makes it easy to send and receive big files.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-filesender-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>FileSender uses <a class="link" href="https://simplesamlphp.org/"  target="_top">SimpleSAMLphp</a> for authentication, which needs to be configured separately.</p><p>Minimal working instance of FileSender that uses password-authentication would look like this:</p><pre><code class="programlisting nix">let
  format = pkgs.formats.php {};
in
{
  networking.firewall.allowedTCPPorts = [ 80 443 ];
  services.filesender = {
    enable = true;
    localDomain = &quot;filesender.example.com&quot;;
    configureNginx = true;
    database.createLocally = true;

    settings = {
      auth_sp_saml_authentication_source = &quot;default&quot;;
      auth_sp_saml_uid_attribute = &quot;uid&quot;;
      storage_filesystem_path = &quot;&lt;STORAGE PATH FOR UPLOADED FILES&gt;&quot;;
      admin = &quot;admin&quot;;
      admin_email = &quot;admin@example.com&quot;;
      email_reply_to = &quot;noreply@example.com&quot;;
    };
  };
  services.simplesamlphp.filesender = {
    settings = {
      &quot;module.enable&quot;.exampleauth = true;
    };
    authSources = {
      admin = [ &quot;core:AdminPassword&quot; ];
      default = format.lib.mkMixedArray [ &quot;exampleauth:UserPass&quot; ] {
        &quot;admin:admin123&quot; = {
          uid = [ &quot;admin&quot; ];
          cn = [ &quot;admin&quot; ];
          mail = [ &quot;admin@example.com&quot; ];
        };
      };
    };
  };
}
</code></pre><div class="warning"><h3 class="title">Warning</h3><p>Example above uses hardcoded clear-text password, in production you should use other authentication method like LDAP. You can check supported authentication methods <a class="link" href="https://simplesamlphp.org/docs/stable/simplesamlphp-idp.html"  target="_top">in SimpleSAMLphp documentation</a>.</p></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse" class="title" >Discourse   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-discourse-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-discourse-tls">Using a regular TLS certificate</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-discourse-database">Database access</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-discourse-mail">Email</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-discourse-settings">Additional settings</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-discourse-plugins">Plugins</a> </span></dt> </dl></div><p><a class="link" href="https://www.discourse.org/"  target="_top">Discourse</a> is a
modern and open source discussion platform.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-basic-usage" class="title" style="clear: both">Basic usage   </h2>  </div> </div></div><p>A minimal configuration using Let’s Encrypt for TLS certificates looks like this:</p><pre><code class="programlisting nix">{
  services.discourse = {
    enable = true;
    hostname = &quot;discourse.example.com&quot;;
    admin = {
      email = &quot;admin@example.com&quot;;
      username = &quot;admin&quot;;
      fullName = &quot;Administrator&quot;;
      passwordFile = &quot;/path/to/password_file&quot;;
    };
    secretKeyBaseFile = &quot;/path/to/secret_key_base_file&quot;;
  };
  security.acme.email = &quot;me@example.com&quot;;
  security.acme.acceptTerms = true;
}
</code></pre><p>Provided a proper DNS setup, you’ll be able to connect to the
instance at <code class="literal">discourse.example.com</code> and log in
using the credentials provided in
<code class="literal">services.discourse.admin</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-tls" class="title" style="clear: both">Using a regular TLS certificate   </h2>  </div> </div></div><p>To set up TLS using a regular certificate and key on file, use
the <a class="xref" href="options.html#opt-services.discourse.sslCertificate"  ><code class="option">services.discourse.sslCertificate</code></a>
and <a class="xref" href="options.html#opt-services.discourse.sslCertificateKey"  ><code class="option">services.discourse.sslCertificateKey</code></a>
options:</p><pre><code class="programlisting nix">{
  services.discourse = {
    enable = true;
    hostname = &quot;discourse.example.com&quot;;
    sslCertificate = &quot;/path/to/ssl_certificate&quot;;
    sslCertificateKey = &quot;/path/to/ssl_certificate_key&quot;;
    admin = {
      email = &quot;admin@example.com&quot;;
      username = &quot;admin&quot;;
      fullName = &quot;Administrator&quot;;
      passwordFile = &quot;/path/to/password_file&quot;;
    };
    secretKeyBaseFile = &quot;/path/to/secret_key_base_file&quot;;
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-database" class="title" style="clear: both">Database access   </h2>  </div> </div></div><p>Discourse uses PostgreSQL to store most of its
data. A database will automatically be enabled and a database
and role created unless <a class="xref" href="options.html#opt-services.discourse.database.host"  ><code class="option">services.discourse.database.host</code></a> is changed from
its default of <code class="literal">null</code> or <a class="xref" href="options.html#opt-services.discourse.database.createLocally"  ><code class="option">services.discourse.database.createLocally</code></a> is set
to <code class="literal">false</code>.</p><p>External database access can also be configured by setting
<a class="xref" href="options.html#opt-services.discourse.database.host"  ><code class="option">services.discourse.database.host</code></a>,
<a class="xref" href="options.html#opt-services.discourse.database.username"  ><code class="option">services.discourse.database.username</code></a> and
<a class="xref" href="options.html#opt-services.discourse.database.passwordFile"  ><code class="option">services.discourse.database.passwordFile</code></a> as
appropriate. Note that you need to manually create a database
called <code class="literal">discourse</code> (or the name you chose in
<a class="xref" href="options.html#opt-services.discourse.database.name"  ><code class="option">services.discourse.database.name</code></a>) and
allow the configured database user full access to it.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-mail" class="title" style="clear: both">Email   </h2>  </div> </div></div><p>In addition to the basic setup, you’ll want to configure an SMTP
server Discourse can use to send user
registration and password reset emails, among others. You can
also optionally let Discourse receive
email, which enables people to reply to threads and conversations
via email.</p><p>A basic setup which assumes you want to use your configured
<a class="link" href="options.html#opt-services.discourse.hostname"  >hostname</a> as
email domain can be done like this:</p><pre><code class="programlisting nix">{
  services.discourse = {
    enable = true;
    hostname = &quot;discourse.example.com&quot;;
    sslCertificate = &quot;/path/to/ssl_certificate&quot;;
    sslCertificateKey = &quot;/path/to/ssl_certificate_key&quot;;
    admin = {
      email = &quot;admin@example.com&quot;;
      username = &quot;admin&quot;;
      fullName = &quot;Administrator&quot;;
      passwordFile = &quot;/path/to/password_file&quot;;
    };
    mail.outgoing = {
      serverAddress = &quot;smtp.emailprovider.com&quot;;
      port = 587;
      username = &quot;user@emailprovider.com&quot;;
      passwordFile = &quot;/path/to/smtp_password_file&quot;;
    };
    mail.incoming.enable = true;
    secretKeyBaseFile = &quot;/path/to/secret_key_base_file&quot;;
  };
}
</code></pre><p>This assumes you have set up an MX record for the address you’ve
set in <a class="link" href="options.html#opt-services.discourse.hostname"  >hostname</a> and
requires proper SPF, DKIM and DMARC configuration to be done for
the domain you’re sending from, in order for email to be reliably delivered.</p><p>If you want to use a different domain for your outgoing email
(for example <code class="literal">example.com</code> instead of
<code class="literal">discourse.example.com</code>) you should set
<a class="xref" href="options.html#opt-services.discourse.mail.notificationEmailAddress"  ><code class="option">services.discourse.mail.notificationEmailAddress</code></a> and
<a class="xref" href="options.html#opt-services.discourse.mail.contactEmailAddress"  ><code class="option">services.discourse.mail.contactEmailAddress</code></a> manually.</p><div class="note"><h3 class="title">Note</h3><p>Setup of TLS for incoming email is currently only configured
automatically when a regular TLS certificate is used, i.e. when
<a class="xref" href="options.html#opt-services.discourse.sslCertificate"  ><code class="option">services.discourse.sslCertificate</code></a> and
<a class="xref" href="options.html#opt-services.discourse.sslCertificateKey"  ><code class="option">services.discourse.sslCertificateKey</code></a> are
set.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-settings" class="title" style="clear: both">Additional settings   </h2>  </div> </div></div><p>Additional site settings and backend settings, for which no
explicit NixOS options are provided,
can be set in <a class="xref" href="options.html#opt-services.discourse.siteSettings"  ><code class="option">services.discourse.siteSettings</code></a> and
<a class="xref" href="options.html#opt-services.discourse.backendSettings"  ><code class="option">services.discourse.backendSettings</code></a> respectively.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-discourse-site-settings" class="title" >Site settings   </h3>  </div> </div></div><p>“Site settings” are the settings that can be
changed through the Discourse
UI. Their <span class="emphasis"><em>default</em></span> values can be set using
<a class="xref" href="options.html#opt-services.discourse.siteSettings"  ><code class="option">services.discourse.siteSettings</code></a>.</p><p>Settings are expressed as a Nix attribute set which matches the
structure of the configuration in
<a class="link" href="https://github.com/discourse/discourse/blob/master/config/site_settings.yml"  target="_top">config/site_settings.yml</a>.
To find a setting’s path, you only need to care about the first
two levels; i.e. its category (e.g. <code class="literal">login</code>)
and name (e.g. <code class="literal">invite_only</code>).</p><p>Settings containing secret data should be set to an attribute
set containing the attribute <code class="literal">_secret</code> - a
string pointing to a file containing the value the option
should be set to. See the example.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-discourse-backend-settings" class="title" >Backend settings   </h3>  </div> </div></div><p>Settings are expressed as a Nix attribute set which matches the
structure of the configuration in
<a class="link" href="https://github.com/discourse/discourse/blob/stable/config/discourse_defaults.conf"  target="_top">config/discourse.conf</a>.
Empty parameters can be defined by setting them to
<code class="literal">null</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-discourse-settings-example" class="title" >Example   </h3>  </div> </div></div><p>The following example sets the title and description of the
Discourse instance and enables
GitHub login in the site settings,
and changes a few request limits in the backend settings:</p><pre><code class="programlisting nix">{
  services.discourse = {
    enable = true;
    hostname = &quot;discourse.example.com&quot;;
    sslCertificate = &quot;/path/to/ssl_certificate&quot;;
    sslCertificateKey = &quot;/path/to/ssl_certificate_key&quot;;
    admin = {
      email = &quot;admin@example.com&quot;;
      username = &quot;admin&quot;;
      fullName = &quot;Administrator&quot;;
      passwordFile = &quot;/path/to/password_file&quot;;
    };
    mail.outgoing = {
      serverAddress = &quot;smtp.emailprovider.com&quot;;
      port = 587;
      username = &quot;user@emailprovider.com&quot;;
      passwordFile = &quot;/path/to/smtp_password_file&quot;;
    };
    mail.incoming.enable = true;
    siteSettings = {
      required = {
        title = &quot;My Cats&quot;;
        site_description = &quot;Discuss My Cats (and be nice plz)&quot;;
      };
      login = {
        enable_github_logins = true;
        github_client_id = &quot;a2f6dfe838cb3206ce20&quot;;
        github_client_secret._secret = /run/keys/discourse_github_client_secret;
      };
    };
    backendSettings = {
      max_reqs_per_ip_per_minute = 300;
      max_reqs_per_ip_per_10_seconds = 60;
      max_asset_reqs_per_ip_per_10_seconds = 250;
      max_reqs_per_ip_mode = &quot;warn+block&quot;;
    };
    secretKeyBaseFile = &quot;/path/to/secret_key_base_file&quot;;
  };
}
</code></pre><p>In the resulting site settings file, the
<code class="literal">login.github_client_secret</code> key will be set
to the contents of the
<code class="filename">/run/keys/discourse_github_client_secret</code>
file.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-plugins" class="title" style="clear: both">Plugins   </h2>  </div> </div></div><p>You can install Discourse plugins
using the <a class="xref" href="options.html#opt-services.discourse.plugins"  ><code class="option">services.discourse.plugins</code></a>
option. Pre-packaged plugins are provided in
<code class="literal">&lt;your_discourse_package_here&gt;.plugins</code>. If
you want the full suite of plugins provided through
<code class="literal">nixpkgs</code>, you can also set the <a class="xref" href="options.html#opt-services.discourse.package"  ><code class="option">services.discourse.package</code></a> option to
<code class="literal">pkgs.discourseAllPlugins</code>.</p><p>Plugins can be built with the
<code class="literal">&lt;your_discourse_package_here&gt;.mkDiscoursePlugin</code>
function. Normally, it should suffice to provide a
<code class="literal">name</code> and <code class="literal">src</code> attribute. If
the plugin has Ruby dependencies, however, they need to be
packaged in accordance with the <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#developing-with-ruby"  target="_top">Developing with Ruby</a>
section of the Nixpkgs manual and the
appropriate gem options set in <code class="literal">bundlerEnvArgs</code>
(normally <code class="literal">gemdir</code> is sufficient). A plugin’s
Ruby dependencies are listed in its
<code class="filename">plugin.rb</code> file as function calls to
<code class="literal">gem</code>. To construct the corresponding
<code class="filename">Gemfile</code> manually, run <span class="command"><strong>bundle init</strong></span>, then add the <code class="literal">gem</code> lines to it
verbatim.</p><p>Much of the packaging can be done automatically by the
<code class="filename">nixpkgs/pkgs/servers/web-apps/discourse/update.py</code>
script - just add the plugin to the <code class="literal">plugins</code>
list in the <code class="literal">update_plugins</code> function and run
the script:</p><pre><code class="programlisting bash">./update.py update-plugins
</code></pre><p>Some plugins provide <a class="link" href="index.html#module-services-discourse-site-settings" title="Site settings" >site settings</a>.
Their defaults can be configured using <a class="xref" href="options.html#opt-services.discourse.siteSettings"  ><code class="option">services.discourse.siteSettings</code></a>, just like
regular site settings. To find the names of these settings, look
in the <code class="literal">config/settings.yml</code> file of the plugin
repo.</p><p>For example, to add the <a class="link" href="https://github.com/discourse/discourse-spoiler-alert"  target="_top">discourse-spoiler-alert</a>
and <a class="link" href="https://github.com/discourse/discourse-solved"  target="_top">discourse-solved</a>
plugins, and disable <code class="literal">discourse-spoiler-alert</code>
by default:</p><pre><code class="programlisting nix">{
  services.discourse = {
    enable = true;
    hostname = &quot;discourse.example.com&quot;;
    sslCertificate = &quot;/path/to/ssl_certificate&quot;;
    sslCertificateKey = &quot;/path/to/ssl_certificate_key&quot;;
    admin = {
      email = &quot;admin@example.com&quot;;
      username = &quot;admin&quot;;
      fullName = &quot;Administrator&quot;;
      passwordFile = &quot;/path/to/password_file&quot;;
    };
    mail.outgoing = {
      serverAddress = &quot;smtp.emailprovider.com&quot;;
      port = 587;
      username = &quot;user@emailprovider.com&quot;;
      passwordFile = &quot;/path/to/smtp_password_file&quot;;
    };
    mail.incoming.enable = true;
    plugins = with config.services.discourse.package.plugins; [
      discourse-spoiler-alert
      discourse-solved
    ];
    siteSettings = {
      plugins = {
        spoiler_enabled = false;
      };
    };
    secretKeyBaseFile = &quot;/path/to/secret_key_base_file&quot;;
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-davis" class="title" >Davis   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-davis-basic-usage">Basic Usage</a> </span></dt> </dl></div><p><a class="link" href="https://github.com/tchapi/davis/"  target="_top">Davis</a> is a caldav and carrddav server. It
has a simple, fully translatable admin interface for sabre/dav based on Symfony
5 and Bootstrap 5, initially inspired by Baïkal.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-davis-basic-usage" class="title" style="clear: both">Basic Usage   </h2>  </div> </div></div><p>At first, an application secret is needed, this can be generated with:</p><pre><code class="programlisting ShellSession">$ cat /dev/urandom | tr -dc a-zA-Z0-9 | fold -w 48 | head -n 1
</code></pre><p>After that, <code class="literal">davis</code> can be deployed like this:</p><pre><code class="programlisting">{
  services.davis = {
    enable = true;
    hostname = &quot;davis.example.com&quot;;
    mail = {
      dsn = &quot;smtp://username@example.com:25&quot;;
      inviteFromAddress = &quot;davis@example.com&quot;;
    };
    adminLogin = &quot;admin&quot;;
    adminPasswordFile = &quot;/run/secrets/davis-admin-password&quot;;
    appSecretFile = &quot;/run/secrets/davis-app-secret&quot;;
    nginx = {};
  };
}
</code></pre><p>This deploys Davis using a sqlite database running out of <code class="literal">/var/lib/davis</code>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-castopod" class="title" >Castopod   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-castopod-quickstart">Quickstart</a> </span></dt> </dl></div><p>Castopod is an open-source hosting platform made for podcasters who want to engage and interact with their audience.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-castopod-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>Configure ACME (https://nixos.org/manual/nixos/unstable/#module-security-acme).
Use the following configuration to start a public instance of Castopod on <code class="literal">castopod.example.com</code> domain:</p><pre><code class="programlisting nix">{
  networking.firewall.allowedTCPPorts = [ 80 443 ];
  services.castopod = {
    enable = true;
    database.createLocally = true;
    nginx.virtualHost = {
      serverName = &quot;castopod.example.com&quot;;
      enableACME = true;
      forceSSL = true;
    };
  };
}
</code></pre><p>Go to <code class="literal">https://castopod.example.com/cp-install</code> to create superadmin account after applying the above configuration.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-c2fmzq" class="title" >c2FmZQ   </h2>  </div> </div></div><p>c2FmZQ is an application that can securely encrypt, store, and share files,
including but not limited to pictures and videos.</p><p>The service <code class="literal">c2fmzq-server</code> can be enabled by setting</p><pre><code class="programlisting nix">{
  services.c2fmzq-server.enable = true;
}
</code></pre><p>This will spin up an instance of the server which is API-compatible with
<a class="link" href="https://stingle.org"  target="_top">Stingle Photos</a> and an experimental Progressive Web App
(PWA) to interact with the storage via the browser.</p><p>In principle the server can be exposed directly on a public interface and there
are command line options to manage HTTPS certificates directly, but the module
is designed to be served behind a reverse proxy or only accessed via localhost.</p><pre><code class="programlisting nix">{
  services.c2fmzq-server = {
    enable = true;
    bindIP = &quot;127.0.0.1&quot;; # default
    port = 8080; # default
  };

  services.nginx = {
    enable = true;
    recommendedProxySettings = true;
    virtualHosts.&quot;example.com&quot; = {
      enableACME = true;
      forceSSL = true;
      locations.&quot;/&quot; = {
        proxyPass = &quot;http://127.0.0.1:8080&quot;;
      };
    };
  };
}
</code></pre><p>For more information, see <a class="link" href="https://github.com/c2FmZQ/c2FmZQ/"  target="_top">https://github.com/c2FmZQ/c2FmZQ/</a>.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-akkoma" class="title" >Akkoma   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#modules-services-akkoma-service-configuration">Service configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#modules-services-akkoma-user-management">User management</a> </span></dt><dt> <span class="section">  <a href="index.html#modules-services-akkoma-proxy-configuration">Proxy configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#modules-services-akkoma-frontend-management">Frontend management</a> </span></dt><dt> <span class="section">  <a href="index.html#modules-services-akkoma-federation-policies">Federation policies</a> </span></dt><dt> <span class="section">  <a href="index.html#modules-services-akkoma-upload-filters">Upload filters</a> </span></dt><dt> <span class="section">  <a href="index.html#modules-services-akkoma-migration-pleroma">Migration from Pleroma</a> </span></dt><dt> <span class="section">  <a href="index.html#modules-services-akkoma-advanced-deployment">Advanced deployment options</a> </span></dt> </dl></div><p><a class="link" href="https://akkoma.dev/"  target="_top">Akkoma</a> is a lightweight ActivityPub microblogging server forked from Pleroma.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-service-configuration" class="title" style="clear: both">Service configuration   </h2>  </div> </div></div><p>The Elixir configuration file required by Akkoma is generated automatically from
<a class="link" href="options.html#opt-services.akkoma.config"  target="_top"><code class="option">services.akkoma.config</code></a>. Secrets must be
included from external files outside of the Nix store by setting the configuration option to
an attribute set containing the attribute <code class="option">_secret</code> – a string pointing to the file
containing the actual value of the option.</p><p>For the mandatory configuration settings these secrets will be generated automatically if the
referenced file does not exist during startup, unless disabled through
<a class="link" href="options.html#opt-services.akkoma.initSecrets"  target="_top"><code class="option">services.akkoma.initSecrets</code></a>.</p><p>The following configuration binds Akkoma to the Unix socket <code class="literal">/run/akkoma/socket</code>, expecting to
be run behind a HTTP proxy on <code class="literal">fediverse.example.com</code>.</p><pre><code class="programlisting nix">{
  services.akkoma.enable = true;
  services.akkoma.config = {
    &quot;:pleroma&quot; = {
      &quot;:instance&quot; = {
        name = &quot;My Akkoma instance&quot;;
        description = &quot;More detailed description&quot;;
        email = &quot;admin@example.com&quot;;
        registration_open = false;
      };

      &quot;Pleroma.Web.Endpoint&quot; = {
        url.host = &quot;fediverse.example.com&quot;;
      };
    };
  };
}
</code></pre><p>Please refer to the <a class="link" href="https://docs.akkoma.dev/stable/configuration/cheatsheet/"  target="_top">configuration cheat sheet</a>
for additional configuration options.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-user-management" class="title" style="clear: both">User management   </h2>  </div> </div></div><p>After the Akkoma service is running, the administration utility can be used to
<a class="link" href="https://docs.akkoma.dev/stable/administration/CLI_tasks/user/"  target="_top">manage users</a>. In particular an
administrative user can be created with</p><pre><code class="programlisting ShellSession">$ pleroma_ctl user new &lt;nickname&gt; &lt;email&gt; --admin --moderator --password &lt;password&gt;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-proxy-configuration" class="title" style="clear: both">Proxy configuration   </h2>  </div> </div></div><p>Although it is possible to expose Akkoma directly, it is common practice to operate it behind an
HTTP reverse proxy such as nginx.</p><pre><code class="programlisting nix">{
  services.akkoma.nginx = {
    enableACME = true;
    forceSSL = true;
  };

  services.nginx = {
    enable = true;

    clientMaxBodySize = &quot;16m&quot;;
    recommendedTlsSettings = true;
    recommendedOptimisation = true;
    recommendedGzipSettings = true;
  };
}
</code></pre><p>Please refer to <a class="xref" href="index.html#module-security-acme" title="SSL/TLS Certificates with ACME" ><em>SSL/TLS Certificates with ACME</em></a> for details on how to provision an SSL/TLS certificate.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="modules-services-akkoma-media-proxy" class="title" >Media proxy   </h3>  </div> </div></div><p>Without the media proxy function, Akkoma does not store any remote media like pictures or video
locally, and clients have to fetch them directly from the source server.</p><pre><code class="programlisting nix">{
  # Enable nginx slice module distributed with Tengine
  services.nginx.package = pkgs.tengine;

  # Enable media proxy
  services.akkoma.config.&quot;:pleroma&quot;.&quot;:media_proxy&quot; = {
    enabled = true;
    proxy_opts.redirect_on_failure = true;
  };

  # Adjust the persistent cache size as needed:
  #  Assuming an average object size of 128 KiB, around 1 MiB
  #  of memory is required for the key zone per GiB of cache.
  # Ensure that the cache directory exists and is writable by nginx.
  services.nginx.commonHttpConfig = &#x27;&#x27;
    proxy_cache_path /var/cache/nginx/cache/akkoma-media-cache
      levels= keys_zone=akkoma_media_cache:16m max_size=16g
      inactive=1y use_temp_path=off;
  &#x27;&#x27;;

  services.akkoma.nginx = {
    locations.&quot;/proxy&quot; = {
      proxyPass = &quot;http://unix:/run/akkoma/socket&quot;;

      extraConfig = &#x27;&#x27;
        proxy_cache akkoma_media_cache;

        # Cache objects in slices of 1 MiB
        slice 1m;
        proxy_cache_key $host$uri$is_args$args$slice_range;
        proxy_set_header Range $slice_range;

        # Decouple proxy and upstream responses
        proxy_buffering on;
        proxy_cache_lock on;
        proxy_ignore_client_abort on;

        # Default cache times for various responses
        proxy_cache_valid 200 1y;
        proxy_cache_valid 206 301 304 1h;

        # Allow serving of stale items
        proxy_cache_use_stale error timeout invalid_header updating;
      &#x27;&#x27;;
    };
  };
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="modules-services-akkoma-prefetch-remote-media" class="title" >Prefetch remote media   </h4>  </div> </div></div><p>The following example enables the <code class="literal">MediaProxyWarmingPolicy</code> MRF policy which automatically
fetches all media associated with a post through the media proxy, as soon as the post is
received by the instance.</p><pre><code class="programlisting nix">{
  services.akkoma.config.&quot;:pleroma&quot;.&quot;:mrf&quot;.policies =
    map (pkgs.formats.elixirConf { }).lib.mkRaw [
      &quot;Pleroma.Web.ActivityPub.MRF.MediaProxyWarmingPolicy&quot;
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="modules-services-akkoma-media-previews" class="title" >Media previews   </h4>  </div> </div></div><p>Akkoma can generate previews for media.</p><pre><code class="programlisting nix">{
  services.akkoma.config.&quot;:pleroma&quot;.&quot;:media_preview_proxy&quot; = {
    enabled = true;
    thumbnail_max_width = 1920;
    thumbnail_max_height = 1080;
  };
}
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-frontend-management" class="title" style="clear: both">Frontend management   </h2>  </div> </div></div><p>Akkoma will be deployed with the <code class="literal">akkoma-fe</code> and <code class="literal">admin-fe</code> frontends by default. These can be
modified by setting
<a class="link" href="options.html#opt-services.akkoma.frontends"  target="_top"><code class="option">services.akkoma.frontends</code></a>.</p><p>The following example overrides the primary frontend’s default configuration using a custom
derivation.</p><pre><code class="programlisting nix">{
  services.akkoma.frontends.primary.package = pkgs.runCommand &quot;akkoma-fe&quot; {
    config = builtins.toJSON {
      expertLevel = 1;
      collapseMessageWithSubject = false;
      stopGifs = false;
      replyVisibility = &quot;following&quot;;
      webPushHideIfCW = true;
      hideScopeNotice = true;
      renderMisskeyMarkdown = false;
      hideSiteFavicon = true;
      postContentType = &quot;text/markdown&quot;;
      showNavShortcuts = false;
    };
    nativeBuildInputs = with pkgs; [ jq xorg.lndir ];
    passAsFile = [ &quot;config&quot; ];
  } &#x27;&#x27;
    mkdir $out
    lndir ${pkgs.akkoma-frontends.akkoma-fe} $out

    rm $out/static/config.json
    jq -s add ${pkgs.akkoma-frontends.akkoma-fe}/static/config.json ${config} \
      &gt;$out/static/config.json
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-federation-policies" class="title" style="clear: both">Federation policies   </h2>  </div> </div></div><p>Akkoma comes with a number of modules to police federation with other ActivityPub instances.
The most valuable for typical users is the
<a class="link" href="https://docs.akkoma.dev/stable/configuration/cheatsheet/#mrf_simple"  target="_top"><code class="literal">:mrf_simple</code></a> module
which allows limiting federation based on instance hostnames.</p><p>This configuration snippet provides an example on how these can be used. Choosing an adequate
federation policy is not trivial and entails finding a balance between connectivity to the rest
of the fediverse and providing a pleasant experience to the users of an instance.</p><pre><code class="programlisting nix">{
  services.akkoma.config.&quot;:pleroma&quot; = with (pkgs.formats.elixirConf { }).lib; {
    &quot;:mrf&quot;.policies = map mkRaw [
      &quot;Pleroma.Web.ActivityPub.MRF.SimplePolicy&quot;
    ];

    &quot;:mrf_simple&quot; = {
      # Tag all media as sensitive
      media_nsfw = mkMap {
        &quot;nsfw.weird.kinky&quot; = &quot;Untagged NSFW content&quot;;
      };

      # Reject all activities except deletes
      reject = mkMap {
        &quot;kiwifarms.cc&quot; = &quot;Persistent harassment of users, no moderation&quot;;
      };

      # Force posts to be visible by followers only
      followers_only = mkMap {
        &quot;beta.birdsite.live&quot; = &quot;Avoid polluting timelines with Twitter posts&quot;;
      };
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-upload-filters" class="title" style="clear: both">Upload filters   </h2>  </div> </div></div><p>This example strips GPS and location metadata from uploads, deduplicates them and anonymises the
the file name.</p><pre><code class="programlisting nix">{
  services.akkoma.config.&quot;:pleroma&quot;.&quot;Pleroma.Upload&quot;.filters =
    map (pkgs.formats.elixirConf { }).lib.mkRaw [
      &quot;Pleroma.Upload.Filter.Exiftool&quot;
      &quot;Pleroma.Upload.Filter.Dedupe&quot;
      &quot;Pleroma.Upload.Filter.AnonymizeFilename&quot;
    ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-migration-pleroma" class="title" style="clear: both">Migration from Pleroma   </h2>  </div> </div></div><p>Pleroma instances can be migrated to Akkoma either by copying the database and upload data or by
pointing Akkoma to the existing data. The necessary database migrations are run automatically
during startup of the service.</p><p>The configuration has to be copy‐edited manually.</p><p>Depending on the size of the database, the initial migration may take a long time and exceed the
startup timeout of the system manager. To work around this issue one may adjust the startup timeout
<code class="option">systemd.services.akkoma.serviceConfig.TimeoutStartSec</code> or simply run the migrations
manually:</p><pre><code class="programlisting ShellSession">pleroma_ctl migrate
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="modules-services-akkoma-migration-pleroma-copy" class="title" >Copying data   </h3>  </div> </div></div><p>Copying the Pleroma data instead of re‐using it in place may permit easier reversion to Pleroma,
but allows the two data sets to diverge.</p><p>First disable Pleroma and then copy its database and upload data:</p><pre><code class="programlisting ShellSession"># Create a copy of the database
nix-shell -p postgresql --run &#x27;createdb -T pleroma akkoma&#x27;

# Copy upload data
mkdir /var/lib/akkoma
cp -R --reflink=auto /var/lib/pleroma/uploads /var/lib/akkoma/
</code></pre><p>After the data has been copied, enable the Akkoma service and verify that the migration has been
successful. If no longer required, the original data may then be deleted:</p><pre><code class="programlisting ShellSession"># Delete original database
nix-shell -p postgresql --run &#x27;dropdb pleroma&#x27;

# Delete original Pleroma state
rm -r /var/lib/pleroma
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="modules-services-akkoma-migration-pleroma-reuse" class="title" >Re‐using data   </h3>  </div> </div></div><p>To re‐use the Pleroma data in place, disable Pleroma and enable Akkoma, pointing it to the
Pleroma database and upload directory.</p><pre><code class="programlisting nix">{
  # Adjust these settings according to the database name and upload directory path used by Pleroma
  services.akkoma.config.&quot;:pleroma&quot;.&quot;Pleroma.Repo&quot;.database = &quot;pleroma&quot;;
  services.akkoma.config.&quot;:pleroma&quot;.&quot;:instance&quot;.upload_dir = &quot;/var/lib/pleroma/uploads&quot;;
}
</code></pre><p>Please keep in mind that after the Akkoma service has been started, any migrations applied by
Akkoma have to be rolled back before the database can be used again with Pleroma. This can be
achieved through <code class="literal">pleroma_ctl ecto.rollback</code>. Refer to the
<a class="link" href="https://hexdocs.pm/ecto_sql/Mix.Tasks.Ecto.Rollback.html"  target="_top">Ecto SQL documentation</a> for
details.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-advanced-deployment" class="title" style="clear: both">Advanced deployment options   </h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="modules-services-akkoma-confinement" class="title" >Confinement   </h3>  </div> </div></div><p>The Akkoma systemd service may be confined to a chroot with</p><pre><code class="programlisting nix">{
  services.systemd.akkoma.confinement.enable = true;
}
</code></pre><p>Confinement of services is not generally supported in NixOS and therefore disabled by default.
Depending on the Akkoma configuration, the default confinement settings may be insufficient and
lead to subtle errors at run time, requiring adjustment:</p><p>Use
<a class="link" href="options.html#opt-systemd.services._name_.confinement.packages"  target="_top"><code class="option">services.systemd.akkoma.confinement.packages</code></a>
to make packages available in the chroot.</p><p><code class="option">services.systemd.akkoma.serviceConfig.BindPaths</code> and
<code class="option">services.systemd.akkoma.serviceConfig.BindReadOnlyPaths</code> permit access to outside paths
through bind mounts. Refer to
<a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#BindPaths="  target="_top"><code class="literal">BindPaths=</code></a>
of <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd.exec</span>(5)</span></a> for details.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="modules-services-akkoma-distributed-deployment" class="title" >Distributed deployment   </h3>  </div> </div></div><p>Being an Elixir application, Akkoma can be deployed in a distributed fashion.</p><p>This requires setting
<a class="link" href="options.html#opt-services.akkoma.dist.address"  target="_top"><code class="option">services.akkoma.dist.address</code></a> and
<a class="link" href="options.html#opt-services.akkoma.dist.cookie"  target="_top"><code class="option">services.akkoma.dist.cookie</code></a>. The
specifics depend strongly on the deployment environment. For more information please check the
relevant <a class="link" href="https://www.erlang.org/doc/reference_manual/distributed.html"  target="_top">Erlang documentation</a>.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-systemd-lock-handler" class="title" >systemd-lock-handler   </h2>  </div> </div></div><p>The <code class="literal">systemd-lock-handler</code> module provides a service that bridges
D-Bus events from <code class="literal">logind</code> to user-level systemd targets:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">lock.target</code> started by <code class="literal">loginctl lock-session</code>,</p></li><li class="listitem"><p><code class="literal">unlock.target</code> started by <code class="literal">loginctl unlock-session</code> and</p></li><li class="listitem"><p><code class="literal">sleep.target</code> started by <code class="literal">systemctl suspend</code>.</p></li></ul></div><p>You can create a user service that starts with any of these targets.</p><p>For example, to create a service for <code class="literal">swaylock</code>:</p><pre><code class="programlisting nix">{
  services.systemd-lock-handler.enable = true;

  systemd.user.services.swaylock = {
    description = &quot;Screen locker for Wayland&quot;;
    documentation = [&quot;man:swaylock(1)&quot;];

    # If swaylock exits cleanly, unlock the session:
    onSuccess = [&quot;unlock.target&quot;];

    # When lock.target is stopped, stops this too:
    partOf = [&quot;lock.target&quot;];

    # Delay lock.target until this service is ready:
    before = [&quot;lock.target&quot;];
    wantedBy = [&quot;lock.target&quot;];

    serviceConfig = {
      # systemd will consider this service started when swaylock forks...
      Type = &quot;forking&quot;;

      # ... and swaylock will fork only after it has locked the screen.
      ExecStart = &quot;${lib.getExe pkgs.swaylock} -f&quot;;

      # If swaylock crashes, always restart it immediately:
      Restart = &quot;on-failure&quot;;
      RestartSec = 0;
    };
  };
}
</code></pre><p>See <a class="link" href="https://sr.ht/~whynothugo/systemd-lock-handler"  target="_top">upstream documentation</a> for more information.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-kerberos-server" class="title" >kerberos_server   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-kerberos-server-usage">Usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-kerberos-server-notes">Notes</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-kerberos-server-upstream-documentation">Upstream Documentation</a> </span></dt> </dl></div><p>Kerberos is a computer-network authentication protocol that works on the basis of tickets to allow nodes communicating over a non-secure network to prove their identity to one another in a secure manner.</p><p>This module provides both the MIT and Heimdal implementations of the a Kerberos server.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-kerberos-server-usage" class="title" style="clear: both">Usage   </h2>  </div> </div></div><p>To enable a Kerberos server:</p><pre><code class="programlisting nix">{
  security.krb5 = {
    # Here you can choose between the MIT and Heimdal implementations.
    package = pkgs.krb5;
    # package = pkgs.heimdal;

    # Optionally set up a client on the same machine as the server
    enable = true;
    settings = {
      libdefaults.default_realm = &quot;EXAMPLE.COM&quot;;
      realms.&quot;EXAMPLE.COM&quot; = {
        kdc = &quot;kerberos.example.com&quot;;
        admin_server = &quot;kerberos.example.com&quot;;
      };
    };
  }

  services.kerberos-server = {
    enable = true;
    settings = {
      realms.&quot;EXAMPLE.COM&quot; = {
        acl = [{ principal = &quot;adminuser&quot;; access=  [&quot;add&quot; &quot;cpw&quot;]; }];
      };
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-kerberos-server-notes" class="title" style="clear: both">Notes   </h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>The Heimdal documentation will sometimes assume that state is stored in <code class="literal">/var/heimdal</code>, but this module uses <code class="literal">/var/lib/heimdal</code> instead.</p></li><li class="listitem"><p>Due to the heimdal implementation being chosen through <code class="literal">security.krb5.package</code>, it is not possible to have a system with one implementation of the client and another of the server.</p></li><li class="listitem"><p>While <code class="literal">services.kerberos_server.settings</code> has a common freeform type between the two implementations, the actual settings that can be set can vary between the two implementations. To figure out what settings are available, you should consult the upstream documentation for the implementation you are using.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-kerberos-server-upstream-documentation" class="title" style="clear: both">Upstream Documentation   </h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>MIT Kerberos homepage: https://web.mit.edu/kerberos</p></li><li class="listitem"><p>MIT Kerberos docs: https://web.mit.edu/kerberos/krb5-latest/doc/index.html</p></li><li class="listitem"><p>Heimdal Kerberos GitHub wiki: https://github.com/heimdal/heimdal/wiki</p></li><li class="listitem"><p>Heimdal kerberos doc manpages (Debian unstable): https://manpages.debian.org/unstable/heimdal-docs/index.html</p></li><li class="listitem"><p>Heimdal Kerberos kdc manpages (Debian unstable): https://manpages.debian.org/unstable/heimdal-kdc/index.html</p></li></ul></div><p>Note the version number in the URLs, it may be different for the latest version.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-meilisearch" class="title" >Meilisearch   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-meilisearch-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-meilisearch-usage">Usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-meilisearch-defaults">Defaults</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-meilisearch-missing">Missing</a> </span></dt> </dl></div><p>Meilisearch is a lightweight, fast and powerful search engine. Think elastic search with a much smaller footprint.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-meilisearch-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>the minimum to start meilisearch is</p><pre><code class="programlisting nix">{
  services.meilisearch.enable = true;
}
</code></pre><p>this will start the http server included with meilisearch on port 7700.</p><p>test with <code class="literal">curl -X GET &#x27;http://localhost:7700/health&#x27;</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-meilisearch-usage" class="title" style="clear: both">Usage   </h2>  </div> </div></div><p>you first need to add documents to an index before you can search for documents.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-meilisearch-quickstart-add" class="title" >Add a documents to the <code class="literal">movies</code> index   </h3>  </div> </div></div><p><code class="literal">curl -X POST &#x27;http://127.0.0.1:7700/indexes/movies/documents&#x27; --data &#x27;[{&quot;id&quot;: &quot;123&quot;, &quot;title&quot;: &quot;Superman&quot;}, {&quot;id&quot;: 234, &quot;title&quot;: &quot;Batman&quot;}]&#x27;</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-meilisearch-quickstart-search" class="title" >Search documents in the <code class="literal">movies</code> index   </h3>  </div> </div></div><p><code class="literal">curl &#x27;http://127.0.0.1:7700/indexes/movies/search&#x27; --data &#x27;{ &quot;q&quot;: &quot;botman&quot; }&#x27;</code> (note the typo is intentional and there to demonstrate the typo tolerant capabilities)</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-meilisearch-defaults" class="title" style="clear: both">Defaults   </h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>The default nixos package doesn’t come with the <a class="link" href="https://docs.meilisearch.com/learn/getting_started/quick_start.html#search"  target="_top">dashboard</a>, since the dashboard features makes some assets downloads at compile time.</p></li><li class="listitem"><p>Anonymized Analytics sent to meilisearch are disabled by default.</p></li><li class="listitem"><p>Default deployment is development mode. It doesn’t require a secret master key. All routes are not protected and accessible.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-meilisearch-missing" class="title" style="clear: both">Missing   </h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>the snapshot feature is not yet configurable from the module, it’s just a matter of adding the relevant environment variables.</p></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-networking-yggdrasil" class="title" >Yggdrasil   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-networking-yggdrasil-configuration">Configuration</a> </span></dt> </dl></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/networking/yggdrasil/default.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://yggdrasil-network.github.io/"  target="_top">https://yggdrasil-network.github.io/</a></p><p>Yggdrasil is an early-stage implementation of a fully end-to-end encrypted,
self-arranging IPv6 network.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-networking-yggdrasil-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-networking-yggdrasil-configuration-simple" class="title" >Simple ephemeral node   </h3>  </div> </div></div><p>An annotated example of a simple configuration:</p><pre><code class="programlisting nix">{
  services.yggdrasil = {
    enable = true;
    persistentKeys = false;
      # The NixOS module will generate new keys and a new IPv6 address each time
      # it is started if persistentKeys is not enabled.

    settings = {
      Peers = [
        # Yggdrasil will automatically connect and &quot;peer&quot; with other nodes it
        # discovers via link-local multicast announcements. Unless this is the
        # case (it probably isn&#x27;t) a node needs peers within the existing
        # network that it can tunnel to.
        &quot;tcp://1.2.3.4:1024&quot;
        &quot;tcp://1.2.3.5:1024&quot;
        # Public peers can be found at
        # https://github.com/yggdrasil-network/public-peers
      ];
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-networking-yggdrasil-configuration-prefix" class="title" >Persistent node with prefix   </h3>  </div> </div></div><p>A node with a fixed address that announces a prefix:</p><pre><code class="programlisting nix">let
  address = &quot;210:5217:69c0:9afc:1b95:b9f:8718:c3d2&quot;;
  prefix = &quot;310:5217:69c0:9afc&quot;;
  # taken from the output of &quot;yggdrasilctl getself&quot;.
in {

  services.yggdrasil = {
    enable = true;
    persistentKeys = true; # Maintain a fixed public key and IPv6 address.
    settings = {
      Peers = [ &quot;tcp://1.2.3.4:1024&quot; &quot;tcp://1.2.3.5:1024&quot; ];
      NodeInfo = {
        # This information is visible to the network.
        name = config.networking.hostName;
        location = &quot;The North Pole&quot;;
      };
    };
  };

  boot.kernel.sysctl.&quot;net.ipv6.conf.all.forwarding&quot; = 1;
    # Forward traffic under the prefix.

  networking.interfaces.${eth0}.ipv6.addresses = [{
    # Set a 300::/8 address on the local physical device.
    address = prefix + &quot;::1&quot;;
    prefixLength = 64;
  }];

  services.radvd = {
    # Announce the 300::/8 prefix to eth0.
    enable = true;
    config = &#x27;&#x27;
      interface eth0
      {
        AdvSendAdvert on;
        prefix ${prefix}::/64 {
          AdvOnLink on;
          AdvAutonomous on;
        };
        route 200::/8 {};
      };
    &#x27;&#x27;;
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-networking-yggdrasil-configuration-container" class="title" >Yggdrasil attached Container   </h3>  </div> </div></div><p>A NixOS container attached to the Yggdrasil network via a node running on the
host:</p><pre><code class="programlisting nix">let
  yggPrefix64 = &quot;310:5217:69c0:9afc&quot;;
    # Again, taken from the output of &quot;yggdrasilctl getself&quot;.
in
{
  boot.kernel.sysctl.&quot;net.ipv6.conf.all.forwarding&quot; = 1;
  # Enable IPv6 forwarding.

  networking = {
    bridges.br0.interfaces = [ ];
    # A bridge only to containers…

    interfaces.br0 = {
      # … configured with a prefix address.
      ipv6.addresses = [{
        address = &quot;${yggPrefix64}::1&quot;;
        prefixLength = 64;
      }];
    };
  };

  containers.foo = {
    autoStart = true;
    privateNetwork = true;
    hostBridge = &quot;br0&quot;;
    # Attach the container to the bridge only.
    config = { config, pkgs, ... }: {
      networking.interfaces.eth0.ipv6 = {
        addresses = [{
          # Configure a prefix address.
          address = &quot;${yggPrefix64}::2&quot;;
          prefixLength = 64;
        }];
        routes = [{
          # Configure the prefix route.
          address = &quot;200::&quot;;
          prefixLength = 7;
          via = &quot;${yggPrefix64}::1&quot;;
        }];
      };

      services.httpd.enable = true;
      networking.firewall.allowedTCPPorts = [ 80 ];
    };
  };

}
</code></pre>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-service-umurmur" class="title" >uMurmur   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-service-umurmur-quick-start">Quick Start</a> </span></dt> </dl></div><p><a class="link" href="http://umurmur.net/"  target="_top">uMurmur</a> is a minimalistic Mumble server primarily targeted to run on embedded computers. This module enables it (<code class="literal">umurmurd</code>).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-service-umurmur-quick-start" class="title" style="clear: both">Quick Start   </h2>  </div> </div></div><pre><code class="programlisting nix">{
  services.umurmur = {
    enable = true;
    openFirewall = true;
    settings = {
      port = 7365;
      channels = [
        {
          name = &quot;root&quot;;
          parent = &quot;&quot;;
          description = &quot;Root channel. No entry.&quot;;
          noenter = true;
        }
        {
          name = &quot;lobby&quot;;
          parent = &quot;root&quot;;
          description = &quot;Lobby channel&quot;;
        }
      ];
      default_channel = &quot;lobby&quot;;
    };
  };
}
</code></pre><p>See a full configuration in <a class="link" href="https://github.com/umurmur/umurmur/blob/master/umurmur.conf.example"  target="_top">umurmur.conf.example</a></p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prosody" class="title" >Prosody   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-prosody-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-prosody-letsencrypt">Let’s Encrypt Configuration</a> </span></dt> </dl></div><p><a class="link" href="https://prosody.im/"  target="_top">Prosody</a> is an open-source, modern XMPP server.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prosody-basic-usage" class="title" style="clear: both">Basic usage   </h2>  </div> </div></div><p>A common struggle for most XMPP newcomers is to find the right set
of XMPP Extensions (XEPs) to setup. Forget to activate a few of
those and your XMPP experience might turn into a nightmare!</p><p>The XMPP community tackles this problem by creating a meta-XEP
listing a decent set of XEPs you should implement. This meta-XEP
is issued every year, the 2020 edition being
<a class="link" href="https://xmpp.org/extensions/xep-0423.html"  target="_top">XEP-0423</a>.</p><p>The NixOS Prosody module will implement most of these recommendend XEPs out of
the box. That being said, two components still require some
manual configuration: the
<a class="link" href="https://xmpp.org/extensions/xep-0045.html"  target="_top">Multi User Chat (MUC)</a>
and the <a class="link" href="https://xmpp.org/extensions/xep-0363.html"  target="_top">HTTP File Upload</a> ones.
You’ll need to create a DNS subdomain for each of those. The current convention is to name your
MUC endpoint <code class="literal">conference.example.org</code> and your HTTP upload domain <code class="literal">upload.example.org</code>.</p><p>A good configuration to start with, including a
<a class="link" href="https://xmpp.org/extensions/xep-0045.html"  target="_top">Multi User Chat (MUC)</a>
endpoint as well as a <a class="link" href="https://xmpp.org/extensions/xep-0363.html"  target="_top">HTTP File Upload</a>
endpoint will look like this:</p><pre><code class="programlisting nix">{
  services.prosody = {
    enable = true;
    admins = [ &quot;root@example.org&quot; ];
    ssl.cert = &quot;/var/lib/acme/example.org/fullchain.pem&quot;;
    ssl.key = &quot;/var/lib/acme/example.org/key.pem&quot;;
    virtualHosts.&quot;example.org&quot; = {
        enabled = true;
        domain = &quot;example.org&quot;;
        ssl.cert = &quot;/var/lib/acme/example.org/fullchain.pem&quot;;
        ssl.key = &quot;/var/lib/acme/example.org/key.pem&quot;;
    };
    muc = [ {
        domain = &quot;conference.example.org&quot;;
    } ];
    uploadHttp = {
        domain = &quot;upload.example.org&quot;;
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prosody-letsencrypt" class="title" style="clear: both">Let’s Encrypt Configuration   </h2>  </div> </div></div><p>As you can see in the code snippet from the
<a class="link" href="index.html#module-services-prosody-basic-usage" title="Basic usage" >previous section</a>,
you’ll need a single TLS certificate covering your main endpoint,
the MUC one as well as the HTTP Upload one. We can generate such a
certificate by leveraging the ACME
<a class="link" href="options.html#opt-security.acme.certs._name_.extraDomainNames"  >extraDomainNames</a> module option.</p><p>Provided the setup detailed in the previous section, you’ll need the following acme configuration to generate
a TLS certificate for the three endponits:</p><pre><code class="programlisting nix">{
  security.acme = {
    email = &quot;root@example.org&quot;;
    acceptTerms = true;
    certs = {
      &quot;example.org&quot; = {
        webroot = &quot;/var/www/example.org&quot;;
        email = &quot;root@example.org&quot;;
        extraDomainNames = [ &quot;conference.example.org&quot; &quot;upload.example.org&quot; ];
      };
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma" class="title" >Pleroma   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-pleroma-generate-config">Generating the Pleroma config</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-pleroma-initialize-db">Initializing the database</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-pleroma-enable">Enabling the Pleroma service locally</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-pleroma-admin-user">Creating the admin user</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-pleroma-nginx">Configuring Nginx</a> </span></dt> </dl></div><p><a class="link" href="https://pleroma.social/"  target="_top">Pleroma</a> is a lightweight activity pub server.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma-generate-config" class="title" style="clear: both">Generating the Pleroma config   </h2>  </div> </div></div><p>The <code class="literal">pleroma_ctl</code> CLI utility will prompt you some questions and it will generate an initial config file. This is an example of usage</p><pre><code class="programlisting ShellSession">$ mkdir tmp-pleroma
$ cd tmp-pleroma
$ nix-shell -p pleroma-otp
$ pleroma_ctl instance gen --output config.exs --output-psql setup.psql
</code></pre><p>The <code class="literal">config.exs</code> file can be further customized following the instructions on the <a class="link" href="https://docs-develop.pleroma.social/backend/configuration/cheatsheet/"  target="_top">upstream documentation</a>. Many refinements can be applied also after the service is running.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma-initialize-db" class="title" style="clear: both">Initializing the database   </h2>  </div> </div></div><p>First, the Postgresql service must be enabled in the NixOS configuration</p><pre><code class="programlisting nix">{
  services.postgresql = {
    enable = true;
    package = pkgs.postgresql_13;
  };
}
</code></pre><p>and activated with the usual</p><pre><code class="programlisting ShellSession">$ nixos-rebuild switch
</code></pre><p>Then you can create and seed the database, using the <code class="literal">setup.psql</code> file that you generated in the previous section, by running</p><pre><code class="programlisting ShellSession">$ sudo -u postgres psql -f setup.psql
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma-enable" class="title" style="clear: both">Enabling the Pleroma service locally   </h2>  </div> </div></div><p>In this section we will enable the Pleroma service only locally, so its configurations can be improved incrementally.</p><p>This is an example of configuration, where <a class="xref" href="options.html#opt-services.pleroma.configs"  ><code class="option">services.pleroma.configs</code></a> option contains the content of the file <code class="literal">config.exs</code>, generated <a class="link" href="index.html#module-services-pleroma-generate-config" title="Generating the Pleroma config" >in the first section</a>, but with the secrets (database password, endpoint secret key, salts, etc.) removed. Removing secrets is important, because otherwise they will be stored publicly in the Nix store.</p><pre><code class="programlisting nix">{
  services.pleroma = {
    enable = true;
    secretConfigFile = &quot;/var/lib/pleroma/secrets.exs&quot;;
    configs = [
      &#x27;&#x27;
      import Config

      config :pleroma, Pleroma.Web.Endpoint,
        url: [host: &quot;pleroma.example.net&quot;, scheme: &quot;https&quot;, port: 443],
        http: [ip: {127, 0, 0, 1}, port: 4000]

      config :pleroma, :instance,
        name: &quot;Test&quot;,
        email: &quot;admin@example.net&quot;,
        notify_email: &quot;admin@example.net&quot;,
        limit: 5000,
        registrations_open: true

      config :pleroma, :media_proxy,
        enabled: false,
        redirect_on_failure: true

      config :pleroma, Pleroma.Repo,
        adapter: Ecto.Adapters.Postgres,
        username: &quot;pleroma&quot;,
        database: &quot;pleroma&quot;,
        hostname: &quot;localhost&quot;

      # Configure web push notifications
      config :web_push_encryption, :vapid_details,
        subject: &quot;mailto:admin@example.net&quot;

      # ... TO CONTINUE ...
      &#x27;&#x27;
    ];
  };
}
</code></pre><p>Secrets must be moved into a file pointed by <a class="xref" href="options.html#opt-services.pleroma.secretConfigFile"  ><code class="option">services.pleroma.secretConfigFile</code></a>, in our case <code class="literal">/var/lib/pleroma/secrets.exs</code>. This file can be created copying the previously generated <code class="literal">config.exs</code> file and then removing all the settings, except the secrets. This is an example</p><pre><code class="programlisting"># Pleroma instance passwords

import Config

config :pleroma, Pleroma.Web.Endpoint,
   secret_key_base: &quot;&lt;the secret generated by pleroma_ctl&gt;&quot;,
   signing_salt: &quot;&lt;the secret generated by pleroma_ctl&gt;&quot;

config :pleroma, Pleroma.Repo,
  password: &quot;&lt;the secret generated by pleroma_ctl&gt;&quot;

# Configure web push notifications
config :web_push_encryption, :vapid_details,
  public_key: &quot;&lt;the secret generated by pleroma_ctl&gt;&quot;,
  private_key: &quot;&lt;the secret generated by pleroma_ctl&gt;&quot;

# ... TO CONTINUE ...
</code></pre><p>Note that the lines of the same configuration group are comma separated (i.e. all the lines end with a comma, except the last one), so when the lines with passwords are added or removed, commas must be adjusted accordingly.</p><p>The service can be enabled with the usual</p><pre><code class="programlisting ShellSession">$ nixos-rebuild switch
</code></pre><p>The service is accessible only from the local <code class="literal">127.0.0.1:4000</code> port. It can be tested using a port forwarding like this</p><pre><code class="programlisting ShellSession">$ ssh -L 4000:localhost:4000 myuser@example.net
</code></pre><p>and then accessing <a class="link" href="http://localhost:4000"  target="_top">http://localhost:4000</a> from a web browser.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma-admin-user" class="title" style="clear: both">Creating the admin user   </h2>  </div> </div></div><p>After Pleroma service is running, all <a class="link" href="https://docs-develop.pleroma.social/"  target="_top">Pleroma administration utilities</a> can be used. In particular an admin user can be created with</p><pre><code class="programlisting ShellSession">$ pleroma_ctl user new &lt;nickname&gt; &lt;email&gt;  --admin --moderator --password &lt;password&gt;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma-nginx" class="title" style="clear: both">Configuring Nginx   </h2>  </div> </div></div><p>In this configuration, Pleroma is listening only on the local port 4000. Nginx can be configured as a Reverse Proxy, for forwarding requests from public ports to the Pleroma service. This is an example of configuration, using
<a class="link" href="https://letsencrypt.org/"  target="_top">Let’s Encrypt</a> for the TLS certificates</p><pre><code class="programlisting nix">{
  security.acme = {
    email = &quot;root@example.net&quot;;
    acceptTerms = true;
  };

  services.nginx = {
    enable = true;
    addSSL = true;

    recommendedTlsSettings = true;
    recommendedOptimisation = true;
    recommendedGzipSettings = true;

    recommendedProxySettings = false;
    # NOTE: if enabled, the NixOS proxy optimizations will override the Pleroma
    # specific settings, and they will enter in conflict.

    virtualHosts = {
      &quot;pleroma.example.net&quot; = {
        http2 = true;
        enableACME = true;
        forceSSL = true;

        locations.&quot;/&quot; = {
          proxyPass = &quot;http://127.0.0.1:4000&quot;;

          extraConfig = &#x27;&#x27;
            etag on;
            gzip on;

            add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27; always;
            add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;POST, PUT, DELETE, GET, PATCH, OPTIONS&#x27; always;
            add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Authorization, Content-Type, Idempotency-Key&#x27; always;
            add_header &#x27;Access-Control-Expose-Headers&#x27; &#x27;Link, X-RateLimit-Reset, X-RateLimit-Limit, X-RateLimit-Remaining, X-Request-Id&#x27; always;
            if ($request_method = OPTIONS) {
              return 204;
            }
            add_header X-XSS-Protection &quot;1; mode=block&quot;;
            add_header X-Permitted-Cross-Domain-Policies none;
            add_header X-Frame-Options DENY;
            add_header X-Content-Type-Options nosniff;
            add_header Referrer-Policy same-origin;
            add_header X-Download-Options noopen;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection &quot;upgrade&quot;;
            proxy_set_header Host $host;

            client_max_body_size 16m;
            # NOTE: increase if users need to upload very big files
          &#x27;&#x27;;
        };
      };
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-netbird-server" class="title" >Netbird server   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-netbird-server-quickstart">Quickstart</a> </span></dt> </dl></div><p>NetBird is a VPN built on top of WireGuard® making it easy to create secure private networks for your organization or home.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-netbird-server-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>To fully setup Netbird as a self-hosted server, we need both a Coturn server and an identity provider, the list of supported SSOs and their setup are available <a class="link" href="https://docs.netbird.io/selfhosted/selfhosted-guide#step-3-configure-identity-provider-idp"  target="_top">on Netbird’s documentation</a>.</p><p>There are quite a few settings that need to be passed to Netbird for it to function, and a minimal config looks like :</p><pre><code class="programlisting nix">services.netbird.server = {
  enable = true;

  domain = &quot;netbird.example.selfhosted&quot;;

  enableNginx = true;

  coturn = {
    enable = true;

    passwordFile = &quot;/path/to/a/secret/password&quot;;
  };

  management = {
    oidcConfigEndpoint = &quot;https://sso.example.selfhosted/oauth2/openid/netbird/.well-known/openid-configuration&quot;;

    settings = {
      TURNConfig = {
        Turns = [
          {
            Proto = &quot;udp&quot;;
            URI = &quot;turn:netbird.example.selfhosted:3478&quot;;
            Username = &quot;netbird&quot;;
            Password._secret = &quot;/path/to/a/secret/password&quot;;
          }
        ];
      };
    };
  };
};
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-netbird" class="title" >Netbird   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-netbird-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-netbird-multiple-connections">Multiple connections setup</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-netbird-firewall">Exposing services internally on the Netbird network</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-netbird-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>The absolute minimal configuration for the Netbird client daemon looks like this:</p><pre><code class="programlisting nix">{
  services.netbird.enable = true;
}
</code></pre><p>This will set up a netbird service listening on the port <code class="literal">51820</code> associated to the
<code class="literal">wt0</code> interface.</p><p>Which is equivalent to:</p><pre><code class="programlisting nix">{
  services.netbird.clients.wt0 = {
    port = 51820;
    name = &quot;netbird&quot;;
    interface = &quot;wt0&quot;;
    hardened = false;
  };
}
</code></pre><p>This will set up a <code class="literal">netbird.service</code> listening on the port <code class="literal">51820</code> associated to the
<code class="literal">wt0</code> interface. There will also be <code class="literal">netbird-wt0</code> binary installed in addition to <code class="literal">netbird</code>.</p><p>see <a class="link" href="options.html#opt-services.netbird.clients"  >clients</a> option documentation for more details.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-netbird-multiple-connections" class="title" style="clear: both">Multiple connections setup   </h2>  </div> </div></div><p>Using the <code class="literal">services.netbird.clients</code> option, it is possible to define more than
one netbird service running at the same time.</p><p>You must at least define a <code class="literal">port</code> for the service to listen on, the rest is optional:</p><pre><code class="programlisting nix">{
  services.netbird.clients.wt1.port = 51830;
  services.netbird.clients.wt2.port = 51831;
}
</code></pre><p>see <a class="link" href="options.html#opt-services.netbird.clients"  >clients</a> option documentation for more details.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-netbird-firewall" class="title" style="clear: both">Exposing services internally on the Netbird network   </h2>  </div> </div></div><p>You can easily expose services exclusively to Netbird network by combining
<a class="link" href="options.html#opt-networking.firewall.interfaces"  ><code class="literal">networking.firewall.interfaces</code></a> rules
with <a class="link" href="options.html#opt-services.netbird.clients._name_.interface"  ><code class="literal">interface</code></a> names:</p><pre><code class="programlisting nix">{
  services.netbird.clients.priv.port = 51819;
  services.netbird.clients.work.port = 51818;
  networking.firewall.interfaces = {
    &quot;${config.services.netbird.clients.priv.interface}&quot; = {
      allowedUDPPorts = [ 1234 ];
    };
    &quot;${config.services.netbird.clients.work.interface}&quot; = {
      allowedTCPPorts = [ 8080 ];
    };
  };
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-netbird-customization" class="title" >Additional customizations   </h3>  </div> </div></div><p>Each Netbird client service by default:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>runs in a <a class="link" href="options.html#opt-services.netbird.clients._name_.hardened"  >hardened</a> mode,</p></li><li class="listitem"><p>starts with the system,</p></li><li class="listitem"><p><a class="link" href="options.html#opt-services.netbird.clients._name_.openFirewall"  >opens up a firewall</a> for direct (without TURN servers)
peer-to-peer communication,</p></li><li class="listitem"><p>can be additionally configured with environment variables,</p></li><li class="listitem"><p>automatically determines whether <code class="literal">netbird-ui-&lt;name&gt;</code> should be available,</p></li></ul></div><p><a class="link" href="options.html#opt-services.netbird.clients._name_.autoStart"  >autoStart</a> allows you to start the client (an actual systemd service)
on demand, for example to connect to work-related or otherwise conflicting network only when required.
See the option description for more information.</p><p><a class="link" href="options.html#opt-services.netbird.clients._name_.environment"  >environment</a> allows you to pass additional configurations
through environment variables, but special care needs to be taken for overriding config location and
daemon address due <a class="link" href="options.html#opt-services.netbird.clients._name_.hardened"  >hardened</a> option.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mosquitto" class="title" >Mosquitto   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-mosquitto-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-mosquitto-config">Configuration</a> </span></dt> </dl></div><p>Mosquitto is a MQTT broker often used for IoT or home automation data transport.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mosquitto-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>A minimal configuration for Mosquitto is</p><pre><code class="programlisting nix">{
  services.mosquitto = {
    enable = true;
    listeners = [ {
      acl = [ &quot;pattern readwrite #&quot; ];
      omitPasswordAuth = true;
      settings.allow_anonymous = true;
    } ];
  };
}
</code></pre><p>This will start a broker on port 1883, listening on all interfaces of the machine, allowing
read/write access to all topics to any user without password requirements.</p><p>User authentication can be configured with the <code class="literal">users</code> key of listeners. A config that gives
full read access to a user <code class="literal">monitor</code> and restricted write access to a user <code class="literal">service</code> could look
like</p><pre><code class="programlisting nix">{
  services.mosquitto = {
    enable = true;
    listeners = [ {
      users = {
        monitor = {
          acl = [ &quot;read #&quot; ];
          password = &quot;monitor&quot;;
        };
        service = {
          acl = [ &quot;write service/#&quot; ];
          password = &quot;service&quot;;
        };
      };
    } ];
  };
}
</code></pre><p>TLS authentication is configured by setting TLS-related options of the listener:</p><pre><code class="programlisting nix">{
  services.mosquitto = {
    enable = true;
    listeners = [ {
      port = 8883; # port change is not required, but helpful to avoid mistakes
      # ...
      settings = {
        cafile = &quot;/path/to/mqtt.ca.pem&quot;;
        certfile = &quot;/path/to/mqtt.pem&quot;;
        keyfile = &quot;/path/to/mqtt.key&quot;;
      };
    } ];
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mosquitto-config" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><p>The Mosquitto configuration has four distinct types of settings:
the global settings of the daemon, listeners, plugins, and bridges.
Bridges and listeners are part of the global configuration, plugins are part of listeners.
Users of the broker are configured as parts of listeners rather than globally, allowing
configurations in which a given user is only allowed to log in to the broker using specific
listeners (eg to configure an admin user with full access to all topics, but restricted to
localhost).</p><p>Almost all options of Mosquitto are available for configuration at their appropriate levels, some
as NixOS options written in camel case, the remainders under <code class="literal">settings</code> with their exact names in
the Mosquitto config file. The exceptions are <code class="literal">acl_file</code> (which is always set according to the
<code class="literal">acl</code> attributes of a listener and its users) and <code class="literal">per_listener_settings</code> (which is always set to
<code class="literal">true</code>).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-mosquitto-config-passwords" class="title" >Password authentication   </h3>  </div> </div></div><p>Mosquitto can be run in two modes, with a password file or without. Each listener has its own
password file, and different listeners may use different password files. Password file generation
can be disabled by setting <code class="literal">omitPasswordAuth = true</code> for a listener; in this case it is necessary
to either set <code class="literal">settings.allow_anonymous = true</code> to allow all logins, or to configure other
authentication methods like TLS client certificates with <code class="literal">settings.use_identity_as_username = true</code>.</p><p>The default is to generate a password file for each listener from the users configured to that
listener. Users with no configured password will not be added to the password file and thus
will not be able to use the broker.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-mosquitto-config-acl" class="title" >ACL format   </h3>  </div> </div></div><p>Every listener has a Mosquitto <code class="literal">acl_file</code> attached to it. This ACL is configured via two
attributes of the config:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>the <code class="literal">acl</code> attribute of the listener configures pattern ACL entries and topic ACL entries
for anonymous users. Each entry must be prefixed with <code class="literal">pattern</code> or <code class="literal">topic</code> to distinguish
between these two cases.</p></li><li class="listitem"><p>the <code class="literal">acl</code> attribute of every user configures in the listener configured the ACL for that
given user. Only topic ACLs are supported by Mosquitto in this setting, so no prefix is
required or allowed.</p></li></ul></div><p>The default ACL for a listener is empty, disallowing all accesses from all clients. To configure
a completely open ACL, set <code class="literal">acl = [ &quot;pattern readwrite #&quot; ]</code> in the listener.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-jotta-cli" class="title" >Jottacloud Command-line Tool   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-jotta-cli-quick-start">Quick Start</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-jotta-cli-example-configuration">Example Configuration</a> </span></dt> </dl></div><p>The <a class="link" href="https://docs.jottacloud.com/en/articles/1436834-jottacloud-command-line-tool"  target="_top">Jottacloud Command-line Tool</a> is a headless <a class="link" href="https://jottacloud.com"  target="_top">Jottacloud</a> client.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-jotta-cli-quick-start" class="title" style="clear: both">Quick Start   </h2>  </div> </div></div><pre><code class="programlisting nix">{
  services.jotta-cli.enable = true;
}
</code></pre><p>This adds <code class="literal">jotta-cli</code> to <code class="literal">environment.systemPackages</code> and starts a user service that runs <code class="literal">jottad</code> with the default options.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-jotta-cli-example-configuration" class="title" style="clear: both">Example Configuration   </h2>  </div> </div></div><pre><code class="programlisting nix">services.jotta-cli = {
  enable = true;
  options = [ &quot;slow&quot; ];
  package = pkgs.jotta-cli;
};
</code></pre><p>This uses <code class="literal">jotta-cli</code> and <code class="literal">jottad</code> from the <code class="literal">pkgs.jotta-cli</code> package and starts <code class="literal">jottad</code> in low memory mode.</p><p><code class="literal">jottad</code> is also added to <code class="literal">environment.systemPackages</code>, so <code class="literal">jottad --help</code> can be used to explore options.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gns3-server" class="title" >GNS3 Server   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-gns3-server-basic-usage">Basic Usage</a> </span></dt> </dl></div><p><a class="link" href="https://www.gns3.com/"  target="_top">GNS3</a>, a network software emulator.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gns3-server-basic-usage" class="title" style="clear: both">Basic Usage   </h2>  </div> </div></div><p>A minimal configuration looks like this:</p><pre><code class="programlisting nix">{
  services.gns3-server = {
    enable = true;

    auth = {
      enable = true;
      user = &quot;gns3&quot;;
      passwordFile = &quot;/var/lib/secrets/gns3_password&quot;;
    };

    ssl = {
      enable = true;
      certFile = &quot;/var/lib/gns3/ssl/cert.pem&quot;;
      keyFile = &quot;/var/lib/gns3/ssl/key.pem&quot;;
    };

    dynamips.enable = true;
    ubridge.enable = true;
    vpcs.enable = true;
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-firefox-syncserver" class="title" >Firefox Sync server   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-firefox-syncserver-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-firefox-syncserver-configuration">More detailed setup</a> </span></dt> </dl></div><p>A storage server for Firefox Sync that you can easily host yourself.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-firefox-syncserver-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>The absolute minimal configuration for the sync server looks like this:</p><pre><code class="programlisting nix">{
  services.mysql.package = pkgs.mariadb;

  services.firefox-syncserver = {
    enable = true;
    secrets = builtins.toFile &quot;sync-secrets&quot; &#x27;&#x27;
      SYNC_MASTER_SECRET=this-secret-is-actually-leaked-to-/nix/store
    &#x27;&#x27;;
    singleNode = {
      enable = true;
      hostname = &quot;localhost&quot;;
      url = &quot;http://localhost:5000&quot;;
    };
  };
}
</code></pre><p>This will start a sync server that is only accessible locally. Once the services is
running you can navigate to <code class="literal">about:config</code> in your Firefox profile and set
<code class="literal">identity.sync.tokenserver.uri</code> to <code class="literal">http://localhost:5000/1.0/sync/1.5</code>. Your browser
will now use your local sync server for data storage.</p><div class="warning"><h3 class="title">Warning</h3><p>This configuration should never be used in production. It is not encrypted and
stores its secrets in a world-readable location.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-firefox-syncserver-configuration" class="title" style="clear: both">More detailed setup   </h2>  </div> </div></div><p>The <code class="literal">firefox-syncserver</code> service provides a number of options to make setting up
small deployment easier. These are grouped under the <code class="literal">singleNode</code> element of the
option tree and allow simple configuration of the most important parameters.</p><p>Single node setup is split into two kinds of options: those that affect the sync
server itself, and those that affect its surroundings. Options that affect the
sync server are <code class="literal">capacity</code>, which configures how many accounts may be active on
this instance, and <code class="literal">url</code>, which holds the URL under which the sync server can be
accessed. The <code class="literal">url</code> can be configured automatically when using nginx.</p><p>Options that affect the surroundings of the sync server are <code class="literal">enableNginx</code>,
<code class="literal">enableTLS</code> and <code class="literal">hostname</code>. If <code class="literal">enableNginx</code> is set the sync server module will
automatically add an nginx virtual host to the system using <code class="literal">hostname</code> as the
domain and set <code class="literal">url</code> accordingly. If <code class="literal">enableTLS</code> is set the module will also
enable ACME certificates on the new virtual host and force all connections to
be made via TLS.</p><p>For actual deployment it is also recommended to store the <code class="literal">secrets</code> file in a
secure location.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-service-doh-server" class="title" >DNS-over-HTTPS Server   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-service-doh-server-quick-start">Quick Start</a> </span></dt> </dl></div><p><a class="link" href="https://github.com/m13253/dns-over-https"  target="_top">DNS-over-HTTPS</a> is a high performance DNS over HTTPS client &amp; server. This module enables its server part (<code class="literal">doh-server</code>).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-service-doh-server-quick-start" class="title" style="clear: both">Quick Start   </h2>  </div> </div></div><p>Setup with Nginx + ACME (recommended):</p><pre><code class="programlisting nix">{
  services.doh-server = {
    enable = true;
    settings = {
      upstream = [ &quot;udp:1.1.1.1:53&quot; ];
    };
  };

  services.nginx = {
    enable = true;
    virtualHosts.&quot;doh.example.com&quot; = {
      enableACME = true;
      forceSSL = true;
      http2 = true;
      locations.&quot;/&quot;.return = 404;
      locations.&quot;/dns-query&quot; = {
        proxyPass = &quot;http://127.0.0.1:8053/dns-query&quot;;
        recommendedProxySettings = true;
      };
    };
    # and other virtual hosts ...
  };

  security.acme = {
    acceptTerms = true;
    defaults.email = &quot;you@example.com&quot;;
  };

  networking.firewall.allowedTCPPorts = [ 80 443 ];
}
</code></pre><p><code class="literal">doh-server</code> can also work as a standalone HTTPS web server (with SSL cert and key specified), but this is not recommended as <code class="literal">doh-server</code> does not do OCSP Stabbing.</p><p>Setup a standalone instance with ACME:</p><pre><code class="programlisting nix">let
  domain = &quot;doh.example.com&quot;;
in
{
  security.acme.certs.${domain} = {
    dnsProvider = &quot;cloudflare&quot;;
    credentialFiles.&quot;CF_DNS_API_TOKEN_FILE&quot; = &quot;/run/secrets/cf-api-token&quot;;
  };

  services.doh-server = {
    enable = true;
    settings = {
      listen = [ &quot;:443&quot; ];
      upstream = [ &quot;udp:1.1.1.1:53&quot; ];
    };
    useACMEHost = domain;
  };

  networking.firewall.allowedTCPPorts = [ 443 ];
}
</code></pre><p>See a full configuration in https://github.com/m13253/dns-over-https/blob/master/doh-server/doh-server.conf.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-networking-dnsmasq" class="title" >Dnsmasq   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-networking-dnsmasq-configuration">Configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-networking-dnsmasq-references">References</a> </span></dt> </dl></div><p>Dnsmasq is an integrated DNS, DHCP and TFTP server for small networks.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-networking-dnsmasq-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-networking-dnsmasq-configuration-home" class="title" >An authoritative DHCP and DNS server on a home network   </h3>  </div> </div></div><p>On a home network, you can use Dnsmasq as a DHCP and DNS server. New devices on
your network will be configured by Dnsmasq, and instructed to use it as the DNS
server by default. This allows you to rely on your own server to perform DNS
queries and caching, with DNSSEC enabled.</p><p>The following example assumes that</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>you have disabled your router’s integrated DHCP server, if it has one</p></li><li class="listitem"><p>your router’s address is set in  <a class="xref" href="options.html#opt-networking.defaultGateway.address"  ><code class="option">networking.defaultGateway.address</code></a></p></li><li class="listitem"><p>your system’s Ethernet interface is <code class="literal">eth0</code></p></li><li class="listitem"><p>you have configured the address(es) to forward DNS queries in <a class="xref" href="options.html#opt-networking.nameservers"  ><code class="option">networking.nameservers</code></a></p></li></ul></div><pre><code class="programlisting nix">{
  services.dnsmasq = {
    enable = true;
    settings = {
      interface = &quot;eth0&quot;;
      bind-interfaces = true; # Only bind to the specified interface
      dhcp-authoritative = true; # Should be set when dnsmasq is definitely the only DHCP server on a network

      server = config.networking.nameservers; # Upstream dns servers to which requests should be forwarded

      dhcp-host = [
        # Give the current system a fixed address of 192.168.0.254
        &quot;dc:a6:32:0b:ea:b9,192.168.0.254,${config.networking.hostName},infinite&quot;
      ];

      dhcp-option = [
        # Address of the gateway, i.e. your router
        &quot;option:router,${config.networking.defaultGateway.address}&quot;
      ];

      dhcp-range = [
        # Range of IPv4 addresses to give out
        # &lt;range start&gt;,&lt;range end&gt;,&lt;lease time&gt;
        &quot;192.168.0.10,192.168.0.253,24h&quot;
        # Enable stateless IPv6 allocation
        &quot;::f,::ff,constructor:eth0,ra-stateless&quot;
      ];

      dhcp-rapid-commit = true; # Faster DHCP negotiation for IPv6
      local-service = true; # Accept DNS queries only from hosts whose address is on a local subnet
      log-queries = true; # Log results of all DNS queries
      bogus-priv = true; # Don&#x27;t forward requests for the local address ranges (192.168.x.x etc) to upstream nameservers
      domain-needed = true; # Don&#x27;t forward requests without dots or domain parts to upstream nameservers

      dnssec = true; # Enable DNSSEC
      # DNSSEC trust anchor. Source: https://data.iana.org/root-anchors/root-anchors.xml
      trust-anchor = &quot;.,20326,8,2,E06D44B80B8F1D39A95C0B0D7C65D08458E880409BBC683457104237C7F8EC8D&quot;;
    };
  };
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-networking-dnsmasq-references" class="title" style="clear: both">References   </h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Upstream website: <a class="link" href="https://dnsmasq.org"  target="_top">https://dnsmasq.org</a></p></li><li class="listitem"><p>Manpage: <a class="link" href="https://dnsmasq.org/docs/dnsmasq-man.html"  target="_top">https://dnsmasq.org/docs/dnsmasq-man.html</a></p></li><li class="listitem"><p>FAQ: <a class="link" href="https://dnsmasq.org/docs/FAQ"  target="_top">https://dnsmasq.org/docs/FAQ</a></p></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-crab-hole" class="title" >🦀 crab-hole   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-crab-hole-configuration">Configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-crab-hole-troubleshooting">Troubleshooting</a> </span></dt> </dl></div><p>Crab-hole is a cross platform Pi-hole clone written in Rust using <a class="link" href="https://github.com/hickory-dns/hickory-dns"  target="_top">hickory-dns/trust-dns</a>.
It can be used as a network wide ad and spy blocker or run on your local PC.</p><p>For a secure and private communication, crab-hole has builtin support for DoH(HTTPS), DoQ(QUIC) and DoT(TLS) for down- and upstreams and DNSSEC for upstreams.
It also comes with privacy friendly default logging settings.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-crab-hole-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><p>As an example config file using Cloudflare as DoT upstream, you can use this <a class="link" href="https://github.com/LuckyTurtleDev/crab-hole/blob/main/example-config.toml"  target="_top">crab-hole.toml</a></p><p>The following is a basic nix config using UDP as a downstream and Cloudflare as upstream.</p><pre><code class="programlisting nix">{
  services.crab-hole = {
    enable = true;

    settings = {
      blocklist = {
        include_subdomains = true;
        lists = [
          &quot;https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn/hosts&quot;
          &quot;https://s3.amazonaws.com/lists.disconnect.me/simple_tracking.txt&quot;
        ];
      };

      downstream = [
        {
          protocol = &quot;udp&quot;;
          listen = &quot;127.0.0.1&quot;;
          port = 53;
        }
        {
          protocol = &quot;udp&quot;;
          listen = &quot;::1&quot;;
          port = 53;
        }
      ];

      upstream = {
        name_servers = [
          {
            socket_addr = &quot;1.1.1.1:853&quot;;
            protocol = &quot;tls&quot;;
            tls_dns_name = &quot;1dot1dot1dot1.cloudflare-dns.com&quot;;
            trust_nx_responses = false;
          }
          {
            socket_addr = &quot;[2606:4700:4700::1111]:853&quot;;
            protocol = &quot;tls&quot;;
            tls_dns_name = &quot;1dot1dot1dot1.cloudflare-dns.com&quot;;
            trust_nx_responses = false;
          }
        ];
      };
    };
  };
}
</code></pre><p>To test your setup, just query the DNS server with any domain like <code class="literal">example.com</code>.
To test if a domain gets blocked, just choose one of the domains from the blocklist.
If the server does not return an IP, this worked correctly.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-crab-hole-downstream" class="title" >Downstream options   </h3>  </div> </div></div><p>There are multiple protocols which are supported for the downstream:
UDP, TLS, HTTPS and QUIC.
Below you can find a brief overview over the various protocol options together with an example for each protocol.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-services-crab-hole-udp" class="title" >UDP   </h4>  </div> </div></div><p>UDP is the simplest downstream, but it is not encrypted.
If you want encryption, you need to use another protocol.
<span class="emphasis"><em><span class="strong"><strong>Note:</strong></span> This also opens a TCP port</em></span></p><pre><code class="programlisting nix">{
  services.crab-hole.settings.downstream = [
    {
      protocol = &quot;udp&quot;;
      listen = &quot;localhost&quot;;
      port = 53;
    }
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-services-crab-hole-tls" class="title" >TLS   </h4>  </div> </div></div><p>TLS is a simple encrypted options to serve DNS.
It comes with similar settings to UDP,
but you additionally need a valid TLS certificate and its private key.
The later are specified via a path to the files.
A valid TLS certificate and private key can be obtained using services like ACME.
Make sure the crab-hole service user has access to these files.
Additionally you can set an optional timeout value.</p><pre><code class="programlisting nix">{
  services.crab-hole.settings.downstream = [
    {
      protocol = &quot;tls&quot;;
      listen = &quot;[::]&quot;;
      port = 853;
      certificate = ./dns.example.com.crt;
      key = &quot;/dns.example.com.key&quot;;
      # optional (default = 3000)
      timeout_ms = 3000
    }
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-services-crab-hole-https" class="title" >HTTPS   </h4>  </div> </div></div><p>HTTPS has similar settings to TLS, with the only difference being the additional <code class="literal">dns_hostname</code> option.
This protocol might need a reverse proxy if other HTTPS services are to share the same port.
Make sure the service has permissions to access the certificate and key.</p><p><span class="emphasis"><em><span class="strong"><strong>Note:</strong></span> this config is untested</em></span></p><pre><code class="programlisting nix">{
  services.crab-hole.settings.downstream = [
    {
      protocol = &quot;https&quot;;
      listen = &quot;[::]&quot;;
      port = 443;
      certificate = ./dns.example.com.crt;
      key = &quot;/dns.example.com.key&quot;;
      # optional
      dns_hostname = &quot;dns.example.com&quot;;
      # optional (default = 3000)
      timeout_ms = 3000;
    }
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-services-crab-hole-quic" class="title" >QUIC   </h4>  </div> </div></div><p>QUIC has identical settings to the HTTPS protocol.
Since by default it doesn’t run on the standard HTTPS port, you shouldn’t need a reverse proxy.
Make sure the service has permissions to access the certificate and key.</p><pre><code class="programlisting nix">{
  services.crab-hole.settings.downstream = [
    {
      protocol = &quot;quic&quot;;
      listen = &quot;127.0.0.1&quot;;
      port = 853;
      certificate = ./dns.example.com.crt;
      key = &quot;/dns.example.com.key&quot;;
      # optional
      dns_hostname = &quot;dns.example.com&quot;;
      # optional (default = 3000)
      timeout_ms = 3000;
    }
  ];
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-crab-hole-upstream-options" class="title" >Upstream options   </h3>  </div> </div></div><p>You can set additional options of the underlying DNS server. A full list of all the options can be found in the <a class="link" href="https://docs.rs/trust-dns-resolver/0.23.0/trust_dns_resolver/config/struct.ResolverOpts.html"  target="_top">hickory-dns documentation</a>.</p><p>This can look like the following example.</p><pre><code class="programlisting nix">{
  services.crab-hole.settings.upstream.options = {
    validate = false;
  };
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-services-crab-hole-dnssec" class="title" >DNSSEC Issues   </h4>  </div> </div></div><p>Due to an upstream issue of <a class="link" href="https://github.com/hickory-dns/hickory-dns/issues/2429"  target="_top">hickory-dns</a>, sites without DNSSEC will not be resolved if <code class="literal">validate = true</code>.
Only DNSSEC capable sites will be resolved with this setting.
To prevent this, set <code class="literal">validate = false</code> or omit the <code class="literal">[upstream.options]</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-crab-hole-api" class="title" >API   </h3>  </div> </div></div><p>The API allows a user to fetch statistic and information about the crab-hole instance.
Basic information is available for everyone, while more detailed information is secured by a key, which will be set with the <code class="literal">admin_key</code> option.</p><pre><code class="programlisting nix">{
  services.crab-hole.settings.api = {
    listen = &quot;127.0.0.1&quot;;
    port = 8080;
    # optional (default = false)
    show_doc = true; # OpenAPI doc loads content from third party websites
    # optional
    admin_key = &quot;1234&quot;;
  };
}

</code></pre><p>The documentation can be enabled separately for the instance with <code class="literal">show_doc</code>.
This will then create an additional webserver, which hosts the API documentation.
An additional resource is in work in the <a class="link" href="https://github.com/LuckyTurtleDev/crab-hole"  target="_top">crab-hole repository</a>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-crab-hole-troubleshooting" class="title" style="clear: both">Troubleshooting   </h2>  </div> </div></div><p>You can check for errors using <code class="literal">systemctl status crab-hole</code> or <code class="literal">journalctl -xeu crab-hole.service</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-crab-hole-invalid-config" class="title" >Invalid config   </h3>  </div> </div></div><p>Some options of the service are in freeform and not type checked.
This can lead to a config which is not valid or cannot be parsed by crab-hole.
The error message will tell you what config value could not be parsed.
For more information check the <a class="link" href="https://github.com/LuckyTurtleDev/crab-hole/blob/main/example-config.toml"  target="_top">example config</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-crab-hole-permission-error" class="title" >Permission Error   </h3>  </div> </div></div><p>It can happen that the created certificates for TLS, HTTPS or QUIC are owned by another user or group.
For ACME for example this would be <code class="literal">acme:acme</code>.
To give the crab-hole service access to these files, the group which owns the certificate can be added as a supplementary group to the service.
For ACME for example:</p><pre><code class="programlisting nix">{
  services.crab-hole.supplementaryGroups = [ &quot;acme&quot; ];
}
</code></pre>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-anubis" class="title" >Anubis   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-anubis-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-anubis-configuration">Configuration</a> </span></dt> </dl></div><p><a class="link" href="https://anubis.techaro.lol"  target="_top">Anubis</a> is a scraper defense software that blocks AI scrapers. It is designed to sit
between a reverse proxy and the service to be protected.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-anubis-quickstart" class="title" style="clear: both">Quickstart   </h2>  </div> </div></div><p>This module is designed to use Unix domain sockets as the socket paths can be automatically configured for multiple
instances, but TCP sockets are also supported.</p><p>A minimal configuration with <a class="link" href="options.html#opt-services.nginx.enable"  >nginx</a> may look like the following:</p><pre><code class="programlisting nix">{ config, ... }: {
  services.anubis.instances.default.settings.TARGET = &quot;http://localhost:8000&quot;;

  # required due to unix socket permissions
  users.users.nginx.extraGroups = [ config.users.groups.anubis.name ];
  services.nginx.virtualHosts.&quot;example.com&quot; = {
    locations = {
      &quot;/&quot;.proxyPass = &quot;http://unix:${config.services.anubis.instances.default.settings.BIND}&quot;;
    };
  };
}
</code></pre><p>If Unix domain sockets are not needed or desired, this module supports operating with only TCP sockets.</p><pre><code class="programlisting nix">{
  services.anubis = {
    instances.default = {
      settings = {
        TARGET = &quot;http://localhost:8080&quot;;
        BIND = &quot;:9000&quot;;
        BIND_NETWORK = &quot;tcp&quot;;
        METRICS_BIND = &quot;127.0.0.1:9001&quot;;
        METRICS_BIND_NETWORK = &quot;tcp&quot;;
      };
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-anubis-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><p>It is possible to configure default settings for all instances of Anubis, via <code class="option">services.anubis.defaultOptions</code>.</p><pre><code class="programlisting nix">{
  services.anubis.defaultOptions = {
    botPolicy = { dnsbl = false; };
    settings.DIFFICULTY = 3;
  };
}
</code></pre><p>Note that at the moment, a custom bot policy is not merged with the baked-in one. That means to only override a setting
like <code class="literal">dnsbl</code>, copying the entire bot policy is required. Check
<a class="link" href="https://github.com/TecharoHQ/anubis/blob/1509b06cb921aff842e71fbb6636646be6ed5b46/cmd/anubis/botPolicies.json"  target="_top">the upstream repository</a>
for the policy.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-samba" class="title" >Samba   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-samba-basic-usage">Basic Usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-samba-configuring">Configuring</a> </span></dt> </dl></div><p><a class="link" href="https://www.samba.org/"  target="_top">Samba</a>, a SMB/CIFS file, print, and login server for Unix.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-samba-basic-usage" class="title" style="clear: both">Basic Usage   </h2>  </div> </div></div><p>A minimal configuration looks like this:</p><pre><code class="programlisting nix">{
  services.samba.enable = true;
}
</code></pre><p>This configuration automatically enables <code class="literal">smbd</code>, <code class="literal">nmbd</code> and <code class="literal">winbindd</code> services by default.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-samba-configuring" class="title" style="clear: both">Configuring   </h2>  </div> </div></div><p>Samba configuration is located in the <code class="literal">/etc/samba/smb.conf</code> file.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-samba-configuring-file-share" class="title" >File share   </h3>  </div> </div></div><p>This configuration will configure Samba to serve a <code class="literal">public</code> file share
which is read-only and accessible without authentication:</p><pre><code class="programlisting nix">{
  services.samba = {
    enable = true;
    settings = {
      &quot;public&quot; = {
        &quot;path&quot; = &quot;/public&quot;;
        &quot;read only&quot; = &quot;yes&quot;;
        &quot;browseable&quot; = &quot;yes&quot;;
        &quot;guest ok&quot; = &quot;yes&quot;;
        &quot;comment&quot; = &quot;Public samba share.&quot;;
      };
    };
  };
}
</code></pre>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-litestream" class="title" >Litestream   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-litestream-configuration">Configuration</a> </span></dt> </dl></div><p><a class="link" href="https://litestream.io/"  target="_top">Litestream</a> is a standalone streaming
replication tool for SQLite.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-litestream-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><p>Litestream service is managed by a dedicated user named <code class="literal">litestream</code>
which needs permission to the database file. Here’s an example config which gives
required permissions to access <a class="link" href="options.html#opt-services.grafana.settings.database.path"  >grafana database</a>:</p><pre><code class="programlisting nix">{ pkgs, ... }:
{
  users.users.litestream.extraGroups = [ &quot;grafana&quot; ];

  systemd.services.grafana.serviceConfig.ExecStartPost = &quot;+&quot; + pkgs.writeShellScript &quot;grant-grafana-permissions&quot; &#x27;&#x27;
    timeout=10

    while [ ! -f /var/lib/grafana/data/grafana.db ];
    do
      if [ &quot;$timeout&quot; == 0 ]; then
        echo &quot;ERROR: Timeout while waiting for /var/lib/grafana/data/grafana.db.&quot;
        exit 1
      fi

      sleep 1

      ((timeout--))
    done

    find /var/lib/grafana -type d -exec chmod -v 775 {} \;
    find /var/lib/grafana -type f -exec chmod -v 660 {} \;
  &#x27;&#x27;;

  services.litestream = {
    enable = true;

    environmentFile = &quot;/run/secrets/litestream&quot;;

    settings = {
      dbs = [
        {
          path = &quot;/var/lib/grafana/data/grafana.db&quot;;
          replicas = [{
            url = &quot;s3://mybkt.litestream.io/grafana&quot;;
          }];
        }
      ];
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prometheus-exporters" class="title" >Prometheus exporters   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-prometheus-exporters-configuration">Configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-prometheus-exporters-new-exporter">Adding a new exporter</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-prometheus-exporters-update-exporter-module">Updating an exporter module</a> </span></dt> </dl></div><p>Prometheus exporters provide metrics for the
<a class="link" href="https://prometheus.io"  target="_top">prometheus monitoring system</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prometheus-exporters-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><p>One of the most common exporters is the
<a class="link" href="https://github.com/prometheus/node_exporter"  target="_top">node exporter</a>,
it provides hardware and OS metrics from the host it’s
running on. The exporter could be configured as follows:</p><pre><code class="programlisting nix">{
  services.prometheus.exporters.node = {
    enable = true;
    port = 9100;
    enabledCollectors = [
      &quot;logind&quot;
      &quot;systemd&quot;
    ];
    disabledCollectors = [
      &quot;textfile&quot;
    ];
    openFirewall = true;
    firewallFilter = &quot;-i br0 -p tcp -m tcp --dport 9100&quot;;
  };
}
</code></pre><p>It should now serve all metrics from the collectors that are explicitly
enabled and the ones that are
<a class="link" href="https://github.com/prometheus/node_exporter#enabled-by-default"  target="_top">enabled by default</a>,
via http under <code class="literal">/metrics</code>. In this
example the firewall should just allow incoming connections to the
exporter’s port on the bridge interface <code class="literal">br0</code> (this would
have to be configured separately of course). For more information about
configuration see <code class="literal">man configuration.nix</code> or search through
the <a class="link" href="https://nixos.org/nixos/options.html#prometheus.exporters"  target="_top">available options</a>.</p><p>Prometheus can now be configured to consume the metrics produced by the exporter:</p><pre><code class="programlisting nix">{
    services.prometheus = {
      # ...

      scrapeConfigs = [
        {
          job_name = &quot;node&quot;;
          static_configs = [{
            targets = [ &quot;localhost:${toString config.services.prometheus.exporters.node.port}&quot; ];
          }];
        }
      ];

      # ...
    };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prometheus-exporters-new-exporter" class="title" style="clear: both">Adding a new exporter   </h2>  </div> </div></div><p>To add a new exporter, it has to be packaged first (see
<code class="literal">nixpkgs/pkgs/servers/monitoring/prometheus/</code> for
examples), then a module can be added. The postfix exporter is used in this
example:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Some default options for all exporters are provided by
<code class="literal">nixpkgs/nixos/modules/services/monitoring/prometheus/exporters.nix</code>:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><code class="literal">enable</code></p></li><li class="listitem"><p><code class="literal">port</code></p></li><li class="listitem"><p><code class="literal">listenAddress</code></p></li><li class="listitem"><p><code class="literal">extraFlags</code></p></li><li class="listitem"><p><code class="literal">openFirewall</code></p></li><li class="listitem"><p><code class="literal">firewallFilter</code></p></li><li class="listitem"><p><code class="literal">firewallRules</code></p></li><li class="listitem"><p><code class="literal">user</code></p></li><li class="listitem"><p><code class="literal">group</code></p></li></ul></div></li><li class="listitem"><p>As there is already a package available, the module can now be added. This
is accomplished by adding a new file to the
<code class="literal">nixos/modules/services/monitoring/prometheus/exporters/</code>
directory, which will be called postfix.nix and contains all exporter
specific options and configuration:</p><pre><code class="programlisting nix"># nixpkgs/nixos/modules/services/prometheus/exporters/postfix.nix
{ config, lib, pkgs, options }:
let
  # for convenience we define cfg here
  cfg = config.services.prometheus.exporters.postfix;
in
{
  port = 9154; # The postfix exporter listens on this port by default

  # `extraOpts` is an attribute set which contains additional options
  # (and optional overrides for default options).
  # Note that this attribute is optional.
  extraOpts = {
    telemetryPath = lib.mkOption {
      type = lib.types.str;
      default = &quot;/metrics&quot;;
      description = &#x27;&#x27;
        Path under which to expose metrics.
      &#x27;&#x27;;
    };
    logfilePath = lib.mkOption {
      type = lib.types.path;
      default = /var/log/postfix_exporter_input.log;
      example = /var/log/mail.log;
      description = &#x27;&#x27;
        Path where Postfix writes log entries.
        This file will be truncated by this exporter!
      &#x27;&#x27;;
    };
    showqPath = lib.mkOption {
      type = lib.types.path;
      default = /var/spool/postfix/public/showq;
      example = /var/lib/postfix/queue/public/showq;
      description = &#x27;&#x27;
        Path at which Postfix places its showq socket.
      &#x27;&#x27;;
    };
  };

  # `serviceOpts` is an attribute set which contains configuration
  # for the exporter&#x27;s systemd service. One of
  # `serviceOpts.script` and `serviceOpts.serviceConfig.ExecStart`
  # has to be specified here. This will be merged with the default
  # service configuration.
  # Note that by default &#x27;DynamicUser&#x27; is &#x27;true&#x27;.
  serviceOpts = {
    serviceConfig = {
      DynamicUser = false;
      ExecStart = &#x27;&#x27;
        ${pkgs.prometheus-postfix-exporter}/bin/postfix_exporter \
          --web.listen-address ${cfg.listenAddress}:${toString cfg.port} \
          --web.telemetry-path ${cfg.telemetryPath} \
          ${lib.concatStringsSep &quot; \\\n  &quot; cfg.extraFlags}
      &#x27;&#x27;;
    };
  };
}
</code></pre></li><li class="listitem"><p>This should already be enough for the postfix exporter. Additionally one
could now add assertions and conditional default values. This can be done
in the ‘meta-module’ that combines all exporter definitions and generates
the submodules:
<code class="literal">nixpkgs/nixos/modules/services/prometheus/exporters.nix</code></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prometheus-exporters-update-exporter-module" class="title" style="clear: both">Updating an exporter module   </h2>  </div> </div></div><p>Should an exporter option change at some point, it is possible to add
information about the change to the exporter definition similar to
<code class="literal">nixpkgs/nixos/modules/rename.nix</code>:</p><pre><code class="programlisting nix">{ config, lib, pkgs, options }:

let
  cfg = config.services.prometheus.exporters.nginx;
in
{
  port = 9113;
  extraOpts = {
    # additional module options
    # ...
  };
  serviceOpts = {
    # service configuration
    # ...
  };
  imports = [
    # &#x27;services.prometheus.exporters.nginx.telemetryEndpoint&#x27; -&gt; &#x27;services.prometheus.exporters.nginx.telemetryPath&#x27;
    (lib.mkRenamedOptionModule [ &quot;telemetryEndpoint&quot; ] [ &quot;telemetryPath&quot; ])

    # removed option &#x27;services.prometheus.exporters.nginx.insecure&#x27;
    (lib.mkRemovedOptionModule [ &quot;insecure&quot; ] &#x27;&#x27;
      This option was replaced by &#x27;prometheus.exporters.nginx.sslVerify&#x27; which defaults to true.
    &#x27;&#x27;)
    ({ options.warnings = options.warnings; })
  ];
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-parsedmarc" class="title" >parsedmarc   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-parsedmarc-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-parsedmarc-local-mail">Local mail</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-parsedmarc-grafana-geoip">Grafana and GeoIP</a> </span></dt> </dl></div><p><a class="link" href="https://domainaware.github.io/parsedmarc/"  target="_top">parsedmarc</a> is a service
which parses incoming <a class="link" href="https://dmarc.org/"  target="_top">DMARC</a> reports and stores
or sends them to a downstream service for further analysis. In
combination with Elasticsearch, Grafana and the included Grafana
dashboard, it provides a handy overview of DMARC reports over time.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-parsedmarc-basic-usage" class="title" style="clear: both">Basic usage   </h2>  </div> </div></div><p>A very minimal setup which reads incoming reports from an external
email address and saves them to a local Elasticsearch instance looks
like this:</p><pre><code class="programlisting nix">{
  services.parsedmarc = {
    enable = true;
    settings.imap = {
      host = &quot;imap.example.com&quot;;
      user = &quot;alice@example.com&quot;;
      password = &quot;/path/to/imap_password_file&quot;;
    };
    provision.geoIp = false; # Not recommended!
  };
}
</code></pre><p>Note that GeoIP provisioning is disabled in the example for
simplicity, but should be turned on for fully functional reports.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-parsedmarc-local-mail" class="title" style="clear: both">Local mail   </h2>  </div> </div></div><p>Instead of watching an external inbox, a local inbox can be
automatically provisioned. The recipient’s name is by default set to
<code class="literal">dmarc</code>, but can be configured in
<a class="link" href="options.html#opt-services.parsedmarc.provision.localMail.recipientName"  target="_top">services.parsedmarc.provision.localMail.recipientName</a>. You
need to add an MX record pointing to the host. More concretely: for
the example to work, an MX record needs to be set up for
<code class="literal">monitoring.example.com</code> and the complete email address that should be
configured in the domain’s dmarc policy is
<code class="literal">dmarc@monitoring.example.com</code>.</p><pre><code class="programlisting nix">{
  services.parsedmarc = {
    enable = true;
    provision = {
      localMail = {
        enable = true;
        hostname = monitoring.example.com;
      };
      geoIp = false; # Not recommended!
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-parsedmarc-grafana-geoip" class="title" style="clear: both">Grafana and GeoIP   </h2>  </div> </div></div><p>The reports can be visualized and summarized with parsedmarc’s
official Grafana dashboard. For all views to work, and for the data to
be complete, GeoIP databases are also required. The following example
shows a basic deployment where the provisioned Elasticsearch instance
is automatically added as a Grafana datasource, and the dashboard is
added to Grafana as well.</p><pre><code class="programlisting nix">{
  services.parsedmarc = {
    enable = true;
    provision = {
      localMail = {
        enable = true;
        hostname = url;
      };
      grafana = {
        datasource = true;
        dashboard = true;
      };
    };
  };

  # Not required, but recommended for full functionality
  services.geoipupdate = {
    settings = {
      AccountID = 000000;
      LicenseKey = &quot;/path/to/license_key_file&quot;;
    };
  };

  services.grafana = {
    enable = true;
    addr = &quot;0.0.0.0&quot;;
    domain = url;
    rootUrl = &quot;https://&quot; + url;
    protocol = &quot;socket&quot;;
    security = {
      adminUser = &quot;admin&quot;;
      adminPasswordFile = &quot;/path/to/admin_password_file&quot;;
      secretKeyFile = &quot;/path/to/secret_key_file&quot;;
    };
  };

  services.nginx = {
    enable = true;
    recommendedTlsSettings = true;
    recommendedOptimisation = true;
    recommendedGzipSettings = true;
    recommendedProxySettings = true;
    upstreams.grafana.servers.&quot;unix:/${config.services.grafana.socket}&quot; = {};
    virtualHosts.${url} = {
      root = config.services.grafana.staticRootPath;
      enableACME = true;
      forceSSL = true;
      locations.&quot;/&quot;.tryFiles = &quot;$uri @grafana&quot;;
      locations.&quot;@grafana&quot;.proxyPass = &quot;http://grafana&quot;;
    };
  };
  users.users.nginx.extraGroups = [ &quot;grafana&quot; ];
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-ocsinventory-agent" class="title" >OCS Inventory Agent   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-ocsinventory-agent-basic-usage">Basic Usage</a> </span></dt> </dl></div><p><a class="link" href="https://ocsinventory-ng.org/"  target="_top">OCS Inventory NG</a> or Open Computers and Software inventory
is an application designed to help IT administrator to keep track of the hardware and software
configurations of computers that are installed on their network.</p><p>OCS Inventory collects information about the hardware and software of networked machines
through the <span class="strong"><strong>OCS Inventory Agent</strong></span> program.</p><p>This NixOS module enables you to install and configure this agent so that it sends information from your computer to the OCS Inventory server.</p><p>For more technical information about OCS Inventory Agent, refer to <a class="link" href="https://wiki.ocsinventory-ng.org/03.Basic-documentation/Setting-up-the-UNIX-agent-manually-on-client-computers/"  target="_top">the Wiki documentation</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-ocsinventory-agent-basic-usage" class="title" style="clear: both">Basic Usage   </h2>  </div> </div></div><p>A minimal configuration looks like this:</p><pre><code class="programlisting nix">{
  services.ocsinventory-agent = {
    enable = true;
    settings = {
      server = &quot;https://ocsinventory.localhost:8080/ocsinventory&quot;;
      tag = &quot;01234567890123&quot;;
    };
  };
}
</code></pre><p>This configuration will periodically run the ocsinventory-agent SystemD service.</p><p>The OCS Inventory Agent will inventory the computer and then sends the results to the specified OCS Inventory Server.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-goss" class="title" >Goss   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-goss-basic-usage">Basic Usage</a> </span></dt> </dl></div><p><a class="link" href="https://goss.rocks/"  target="_top">goss</a> is a YAML based serverspec alternative tool
for validating a server’s configuration.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-goss-basic-usage" class="title" style="clear: both">Basic Usage   </h2>  </div> </div></div><p>A minimal configuration looks like this:</p><pre><code class="programlisting nix">{
  services.goss = {
    enable = true;

    environment = {
      GOSS_FMT = &quot;json&quot;;
      GOSS_LOGLEVEL = &quot;TRACE&quot;;
    };

    settings = {
      addr.&quot;tcp://localhost:8080&quot; = {
        reachable = true;
        local-address = &quot;127.0.0.1&quot;;
      };
      command.&quot;check-goss-version&quot; = {
        exec = &quot;${lib.getExe pkgs.goss} --version&quot;;
        exit-status = 0;
      };
      dns.localhost.resolvable = true;
      file.&quot;/nix&quot; = {
        filetype = &quot;directory&quot;;
        exists = true;
      };
      group.root.exists = true;
      kernel-param.&quot;kernel.ostype&quot;.value = &quot;Linux&quot;;
      service.goss = {
        enabled = true;
        running = true;
      };
      user.root.exists = true;
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-certspotter" class="title" >Cert Spotter   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#modules-services-certspotter-service-configuration">Service Configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#modules-services-certspotter-operation">Operation</a> </span></dt><dt> <span class="section">  <a href="index.html#modules-services-certspotter-hooks">Hooks</a> </span></dt> </dl></div><p>Cert Spotter is a tool for monitoring <a class="link" href="https://en.wikipedia.org/wiki/Certificate_Transparency"  target="_top">Certificate Transparency</a>
logs.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-certspotter-service-configuration" class="title" style="clear: both">Service Configuration   </h2>  </div> </div></div><p>A basic config that notifies you of all certificate changes for your
domain would look as follows:</p><pre><code class="programlisting nix">{
  services.certspotter = {
    enable = true;
    # replace example.org with your domain name
    watchlist = [ &quot;.example.org&quot; ];
    emailRecipients = [ &quot;webmaster@example.org&quot; ];
  };

  # Configure an SMTP client
  programs.msmtp.enable = true;
  # Or you can use any other module that provides sendmail, like
  # services.nullmailer, services.opensmtpd, services.postfix
}
</code></pre><p>In this case, the leading dot in <code class="literal">&quot;.example.org&quot;</code> means that Cert
Spotter should monitor not only <code class="literal">example.org</code>, but also all of its
subdomains.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-certspotter-operation" class="title" style="clear: both">Operation   </h2>  </div> </div></div><p><span class="strong"><strong>By default, NixOS configures Cert Spotter to skip all certificates
issued before its first launch</strong></span>, because checking the entire
Certificate Transparency logs requires downloading tens of terabytes of
data. If you want to check the <span class="emphasis"><em>entire</em></span> logs for previously issued
certificates, you have to set <code class="literal">services.certspotter.startAtEnd</code> to
<code class="literal">false</code> and remove all previously saved log state in
<code class="literal">/var/lib/certspotter/logs</code>. The downloaded logs aren’t saved, so if you
add a new domain to the watchlist and want Cert Spotter to go through
the logs again, you will have to remove <code class="literal">/var/lib/certspotter/logs</code>
again.</p><p>After catching up with the logs, Cert Spotter will start monitoring live
logs. As of October 2023, it uses around <span class="strong"><strong>20 Mbps</strong></span> of traffic on
average.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-certspotter-hooks" class="title" style="clear: both">Hooks   </h2>  </div> </div></div><p>Cert Spotter supports running custom hooks instead of (or in addition
to) sending emails. Hooks are shell scripts that will be passed certain
environment variables.</p><p>To see hook documentation, see Cert Spotter’s man pages:</p><pre><code class="programlisting ShellSession">nix-shell -p certspotter --run &#x27;man 8 certspotter-script&#x27;
</code></pre><p>For example, you can remove <code class="literal">emailRecipients</code> and send email
notifications manually using the following hook:</p><pre><code class="programlisting nix">{
  services.certspotter.hooks = [
    (pkgs.writeShellScript &quot;certspotter-hook&quot; &#x27;&#x27;
      function print_email() {
        echo &quot;Subject: [certspotter] $SUMMARY&quot;
        echo &quot;Mime-Version: 1.0&quot;
        echo &quot;Content-Type: text/plain; charset=US-ASCII&quot;
        echo
        cat &quot;$TEXT_FILENAME&quot;
      }
      print_email | ${config.services.certspotter.sendmailPath} -i webmaster@example.org
    &#x27;&#x27;)
  ];
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-weechat" class="title" >WeeChat   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-weechat-basic-usage">Basic Usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-weechat-reattach">Re-attaching to WeeChat</a> </span></dt> </dl></div><p><a class="link" href="https://weechat.org/"  target="_top">WeeChat</a> is a fast and
extensible IRC client.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-weechat-basic-usage" class="title" style="clear: both">Basic Usage   </h2>  </div> </div></div><p>By default, the module creates a
<a class="link" href="https://www.freedesktop.org/wiki/Software/systemd/"  target="_top"><code class="literal">systemd</code></a>
unit which runs the chat client in a detached
<a class="link" href="https://www.gnu.org/software/screen/"  target="_top"><code class="literal">screen</code></a>
session.</p><p>This can be done by enabling the <code class="literal">weechat</code> service:</p><pre><code class="programlisting nix">{ ... }:

{
  services.weechat.enable = true;
}
</code></pre><p>The service is managed by a dedicated user named <code class="literal">weechat</code>
in the state directory <code class="literal">/var/lib/weechat</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-weechat-reattach" class="title" style="clear: both">Re-attaching to WeeChat   </h2>  </div> </div></div><p>WeeChat runs in a screen session owned by a dedicated user. To explicitly
allow your another user to attach to this session, the
<code class="literal">screenrc</code> needs to be tweaked by adding
<a class="link" href="https://www.gnu.org/software/screen/manual/html_node/Multiuser.html#Multiuser"  target="_top">multiuser</a>
support:</p><pre><code class="programlisting nix">{
  programs.screen.screenrc = &#x27;&#x27;
    multiuser on
    acladd normal_user
  &#x27;&#x27;;
}
</code></pre><p>Now, the session can be re-attached like this:</p><pre><code class="programlisting">screen -x weechat/weechat-screen
</code></pre><p><span class="emphasis"><em>The session name can be changed using <a class="link" href="options.html#opt-services.weechat.sessionName"  target="_top">services.weechat.sessionName.</a></em></span></p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-taskserver" class="title" >Taskserver   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-taskserver-configuration">Configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-taskserver-nixos-taskserver-tool">The nixos-taskserver tool</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-taskserver-declarative-ca-management">Declarative/automatic CA management</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-taskserver-manual-ca-management">Manual CA management</a> </span></dt> </dl></div><p>Taskserver is the server component of the now deprecated version 2 of
<a class="link" href="https://taskwarrior.org/"  target="_top">Taskwarrior</a>, a free and
open source todo list application.</p><p><a class="link" href="https://github.com/GothenburgBitFactory/taskwarrior/releases/tag/v3.0.0"  target="_top">Taskwarrior 3.0.0 was released in March
2024</a>,
and the sync functionality was rewritten entirely. With it, a NixOS module
named
<a class="link" href="options.html#opt-services.taskchampion-sync-server.enable"  target="_top"><code class="literal">taskchampion-sync-server</code></a>
was added to Nixpkgs. Many people still want to use the old <a class="link" href="https://github.com/GothenburgBitFactory/taskwarrior/releases/tag/v2.6.2"  target="_top">Taskwarrior
2.6.x</a>,
and Taskserver along with it. Hence this module and this documentation will
stay here for the near future.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-taskserver-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><p>Taskserver does all of its authentication via TLS using client certificates,
so you either need to roll your own CA or purchase a certificate from a
known CA, which allows creation of client certificates. These certificates
are usually advertised as “server certificates”.</p><p>So in order to make it easier to handle your own CA, there is a helper tool
called <span class="command"><strong>nixos-taskserver</strong></span> which manages the custom CA along
with Taskserver organisations, users and groups.</p><p>While the client certificates in Taskserver only authenticate whether a user
is allowed to connect, every user has its own UUID which identifies it as an
entity.</p><p>With <span class="command"><strong>nixos-taskserver</strong></span> the client certificate is created
along with the UUID of the user, so it handles all of the credentials needed
in order to setup the Taskwarrior 2 client to work with a Taskserver.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-taskserver-nixos-taskserver-tool" class="title" style="clear: both">The nixos-taskserver tool   </h2>  </div> </div></div><p>Because Taskserver by default only provides scripts to setup users
imperatively, the <span class="command"><strong>nixos-taskserver</strong></span> tool is used for
addition and deletion of organisations along with users and groups defined
by <a class="xref" href="options.html#opt-services.taskserver.organisations"  ><code class="option">services.taskserver.organisations</code></a> and as well for
imperative set up.</p><p>The tool is designed to not interfere if the command is used to manually set
up some organisations, users or groups.</p><p>For example if you add a new organisation using <span class="command"><strong>nixos-taskserver org add foo</strong></span>, the organisation is not modified and deleted no
matter what you define in
<code class="option">services.taskserver.organisations</code>, even if you’re adding
the same organisation in that option.</p><p>The tool is modelled to imitate the official <span class="command"><strong>taskd</strong></span>
command, documentation for each subcommand can be shown by using the
<code class="option">--help</code> switch.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-taskserver-declarative-ca-management" class="title" style="clear: both">Declarative/automatic CA management   </h2>  </div> </div></div><p>Everything is done according to what you specify in the module options,
however in order to set up a Taskwarrior 2 client for synchronisation with a
Taskserver instance, you have to transfer the keys and certificates to the
client machine.</p><p>This is done using <span class="command"><strong>nixos-taskserver user export $orgname $username</strong></span> which is printing a shell script fragment to stdout
which can either be used verbatim or adjusted to import the user on the
client machine.</p><p>For example, let’s say you have the following configuration:</p><pre><code class="programlisting ShellSession">{
  services.taskserver.enable = true;
  services.taskserver.fqdn = &quot;server&quot;;
  services.taskserver.listenHost = &quot;::&quot;;
  services.taskserver.organisations.my-company.users = [ &quot;alice&quot; ];
}
</code></pre><p>This creates an organisation called <code class="literal">my-company</code> with the
user <code class="literal">alice</code>.</p><p>Now in order to import the <code class="literal">alice</code> user to another machine
<code class="literal">alicebox</code>, all we need to do is something like this:</p><pre><code class="programlisting ShellSession">$ ssh server nixos-taskserver user export my-company alice | sh
</code></pre><p>Of course, if no SSH daemon is available on the server you can also copy
&amp; paste it directly into a shell.</p><p>After this step the user should be set up and you can start synchronising
your tasks for the first time with <span class="command"><strong>task sync init</strong></span> on
<code class="literal">alicebox</code>.</p><p>Subsequent synchronisation requests merely require the command <span class="command"><strong>task sync</strong></span> after that stage.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-taskserver-manual-ca-management" class="title" style="clear: both">Manual CA management   </h2>  </div> </div></div><p>If you set any options within
<a class="link" href="options.html#opt-services.taskserver.pki.manual.ca.cert"  >service.taskserver.pki.manual</a>.*,
<span class="command"><strong>nixos-taskserver</strong></span> won’t issue certificates, but you can
still use it for adding or removing user accounts.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-sourcehut" class="title" >Sourcehut   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-sourcehut-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-sourcehut-configuration">Configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-sourcehut-httpd">Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)</a> </span></dt> </dl></div><p><a class="link" href="https://sr.ht.com/"  target="_top">Sourcehut</a> is an open-source,
self-hostable software development platform. The server setup can be automated using
<a class="link" href="options.html#opt-services.sourcehut.enable"  >services.sourcehut</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-sourcehut-basic-usage" class="title" style="clear: both">Basic usage   </h2>  </div> </div></div><p>Sourcehut is a Python and Go based set of applications.
This NixOS module also provides basic configuration integrating Sourcehut into locally running
<code class="literal">services.nginx</code>, <code class="literal">services.redis.servers.sourcehut</code>, <code class="literal">services.postfix</code>
and <code class="literal">services.postgresql</code> services.</p><p>A very basic configuration may look like this:</p><pre><code class="programlisting nix">{ pkgs, ... }:
let
  fqdn =
    let
      join = hostName: domain: hostName + optionalString (domain != null) &quot;.${domain}&quot;;
    in join config.networking.hostName config.networking.domain;
in {

  networking = {
    hostName = &quot;srht&quot;;
    domain = &quot;tld&quot;;
    firewall.allowedTCPPorts = [ 22 80 443 ];
  };

  services.sourcehut = {
    enable = true;
    git.enable = true;
    man.enable = true;
    meta.enable = true;
    nginx.enable = true;
    postfix.enable = true;
    postgresql.enable = true;
    redis.enable = true;
    settings = {
        &quot;sr.ht&quot; = {
          environment = &quot;production&quot;;
          global-domain = fqdn;
          origin = &quot;https://${fqdn}&quot;;
          # Produce keys with srht-keygen from sourcehut.coresrht.
          network-key = &quot;/run/keys/path/to/network-key&quot;;
          service-key = &quot;/run/keys/path/to/service-key&quot;;
        };
        webhooks.private-key= &quot;/run/keys/path/to/webhook-key&quot;;
    };
  };

  security.acme.certs.&quot;${fqdn}&quot;.extraDomainNames = [
    &quot;meta.${fqdn}&quot;
    &quot;man.${fqdn}&quot;
    &quot;git.${fqdn}&quot;
  ];

  services.nginx = {
    enable = true;
    # only recommendedProxySettings are strictly required, but the rest make sense as well.
    recommendedTlsSettings = true;
    recommendedOptimisation = true;
    recommendedGzipSettings = true;
    recommendedProxySettings = true;

    # Settings to setup what certificates are used for which endpoint.
    virtualHosts = {
      &quot;${fqdn}&quot;.enableACME = true;
      &quot;meta.${fqdn}&quot;.useACMEHost = fqdn;
      &quot;man.${fqdn}&quot;.useACMEHost = fqdn;
      &quot;git.${fqdn}&quot;.useACMEHost = fqdn;
    };
  };
}
</code></pre><p>The <code class="literal">hostName</code> option is used internally to configure the nginx
reverse-proxy. The <code class="literal">settings</code> attribute set is
used by the configuration generator and the result is placed in <code class="literal">/etc/sr.ht/config.ini</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-sourcehut-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><p>All configuration parameters are also stored in
<code class="literal">/etc/sr.ht/config.ini</code> which is generated by
the module and linked from the store to ensure that all values from <code class="literal">config.ini</code>
can be modified by the module.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-sourcehut-httpd" class="title" style="clear: both">Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)   </h2>  </div> </div></div><p>By default, <code class="literal">nginx</code> is used as reverse-proxy for <code class="literal">sourcehut</code>.
However, it’s possible to use e.g. <code class="literal">httpd</code> by explicitly disabling
<code class="literal">nginx</code> using <a class="xref" href="options.html#opt-services.nginx.enable"  ><code class="option">services.nginx.enable</code></a> and fixing the
<code class="literal">settings</code>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gitlab" class="title" >GitLab   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-gitlab-prerequisites">Prerequisites</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-gitlab-configuring">Configuring</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-gitlab-maintenance">Maintenance</a> </span></dt> </dl></div><p>GitLab is a feature-rich git hosting service.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gitlab-prerequisites" class="title" style="clear: both">Prerequisites   </h2>  </div> </div></div><p>The <code class="literal">gitlab</code> service exposes only an Unix socket at
<code class="literal">/run/gitlab/gitlab-workhorse.socket</code>. You need to
configure a webserver to proxy HTTP requests to the socket.</p><p>For instance, the following configuration could be used to use nginx as
frontend proxy:</p><pre><code class="programlisting nix">{
  services.nginx = {
    enable = true;
    recommendedGzipSettings = true;
    recommendedOptimisation = true;
    recommendedProxySettings = true;
    recommendedTlsSettings = true;
    virtualHosts.&quot;git.example.com&quot; = {
      enableACME = true;
      forceSSL = true;
      locations.&quot;/&quot;.proxyPass = &quot;http://unix:/run/gitlab/gitlab-workhorse.socket&quot;;
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gitlab-configuring" class="title" style="clear: both">Configuring   </h2>  </div> </div></div><p>GitLab depends on both PostgreSQL and Redis and will automatically enable
both services. In the case of PostgreSQL, a database and a role will be
created.</p><p>The default state dir is <code class="literal">/var/gitlab/state</code>. This is where
all data like the repositories and uploads will be stored.</p><p>A basic configuration with some custom settings could look like this:</p><pre><code class="programlisting nix">{
  services.gitlab = {
    enable = true;
    databasePasswordFile = &quot;/var/keys/gitlab/db_password&quot;;
    initialRootPasswordFile = &quot;/var/keys/gitlab/root_password&quot;;
    https = true;
    host = &quot;git.example.com&quot;;
    port = 443;
    user = &quot;git&quot;;
    group = &quot;git&quot;;
    smtp = {
      enable = true;
      address = &quot;localhost&quot;;
      port = 25;
    };
    secrets = {
      dbFile = &quot;/var/keys/gitlab/db&quot;;
      secretFile = &quot;/var/keys/gitlab/secret&quot;;
      otpFile = &quot;/var/keys/gitlab/otp&quot;;
      jwsFile = &quot;/var/keys/gitlab/jws&quot;;
    };
    extraConfig = {
      gitlab = {
        email_from = &quot;gitlab-no-reply@example.com&quot;;
        email_display_name = &quot;Example GitLab&quot;;
        email_reply_to = &quot;gitlab-no-reply@example.com&quot;;
        default_projects_features = { builds = false; };
      };
    };
  };
}
</code></pre><p>If you’re setting up a new GitLab instance, generate new
secrets. You for instance use
<code class="literal">tr -dc A-Za-z0-9 &lt; /dev/urandom | head -c 128 &gt; /var/keys/gitlab/db</code> to
generate a new db secret. Make sure the files can be read by, and
only by, the user specified by
<a class="link" href="options.html#opt-services.gitlab.user"  >services.gitlab.user</a>. GitLab
encrypts sensitive data stored in the database. If you’re restoring
an existing GitLab instance, you must specify the secrets secret
from <code class="literal">config/secrets.yml</code> located in your GitLab
state folder.</p><p>When <code class="literal">incoming_mail.enabled</code> is set to <code class="literal">true</code>
in <a class="link" href="options.html#opt-services.gitlab.extraConfig"  >extraConfig</a> an additional
service called <code class="literal">gitlab-mailroom</code> is enabled for fetching incoming mail.</p><p>Refer to <a class="xref" href="options.html" title="Appendix A. Configuration Options" >Appendix&nbsp;A</a> for all available configuration
options for the <a class="link" href="options.html#opt-services.gitlab.enable"  >services.gitlab</a> module.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gitlab-maintenance" class="title" style="clear: both">Maintenance   </h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-gitlab-maintenance-backups" class="title" >Backups   </h3>  </div> </div></div><p>Backups can be configured with the options in
<a class="link" href="options.html#opt-services.gitlab.backup.keepTime"  >services.gitlab.backup</a>. Use
the <a class="link" href="options.html#opt-services.gitlab.backup.startAt"  >services.gitlab.backup.startAt</a>
option to configure regular backups.</p><p>To run a manual backup, start the <code class="literal">gitlab-backup</code> service:</p><pre><code class="programlisting ShellSession">$ systemctl start gitlab-backup.service
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-gitlab-maintenance-rake" class="title" >Rake tasks   </h3>  </div> </div></div><p>You can run GitLab’s rake tasks with <code class="literal">gitlab-rake</code>
which will be available on the system when GitLab is enabled. You
will have to run the command as the user that you configured to run
GitLab with.</p><p>A list of all available rake tasks can be obtained by running:</p><pre><code class="programlisting ShellSession">$ sudo -u git -H gitlab-rake -T
</code></pre>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-forgejo" class="title" >Forgejo   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-forgejo-migration-gitea">Migration from Gitea</a> </span></dt> </dl></div><p>Forgejo is a soft-fork of gitea, with strong community focus, as well
as on self-hosting and federation. <a class="link" href="https://codeberg.org"  target="_top">Codeberg</a> is
deployed from it.</p><p>See <a class="link" href="https://forgejo.org/docs/latest/"  target="_top">upstream docs</a>.</p><p>The method of choice for running forgejo is using <a class="link" href="options.html#opt-services.forgejo.enable"  ><code class="literal">services.forgejo</code></a>.</p><div class="warning"><h3 class="title">Warning</h3><p>Running forgejo using <code class="literal">services.gitea.package = pkgs.forgejo</code> is no longer
recommended.
If you experience issues with your instance using <code class="literal">services.gitea</code>,
<span class="strong"><strong>DO NOT</strong></span> report them to the <code class="literal">services.gitea</code> module maintainers.
<span class="strong"><strong>DO</strong></span> report them to the <code class="literal">services.forgejo</code> module maintainers instead.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-forgejo-migration-gitea" class="title" style="clear: both">Migration from Gitea   </h2>  </div> </div></div><div class="note"><h3 class="title">Note</h3><p>Migrating is, while not strictly necessary at this point, highly recommended.
Both modules and projects are likely to diverge further with each release.
Which might lead to an even more involved migration.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-forgejo-migration-gitea-default" class="title" >Full-Migration   </h3>  </div> </div></div><p>This will migrate the state directory (data), rename and chown the database and
delete the gitea user.</p><div class="note"><h3 class="title">Note</h3><p>This will also change the git remote ssh-url user from <code class="literal">gitea@</code> to <code class="literal">forgejo@</code>,
when using the host’s openssh server (default) instead of the integrated one.</p></div><p>Instructions for PostgreSQL (default). Adapt accordingly for other databases:</p><pre><code class="programlisting sh">systemctl stop gitea
mv /var/lib/gitea /var/lib/forgejo
runuser -u postgres -- psql -c &#x27;
  ALTER USER gitea RENAME TO forgejo;
  ALTER DATABASE gitea RENAME TO forgejo;
&#x27;
nixos-rebuild switch
systemctl stop forgejo
chown -R forgejo:forgejo /var/lib/forgejo
systemctl restart forgejo
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-forgejo-migration-gitea-impersonate" class="title" >Alternatively, keeping the gitea user   </h3>  </div> </div></div><p>Alternatively, instead of renaming the database, copying the state folder and
changing the user, the forgejo module can be set up to re-use the old storage
locations and database, instead of having to copy or rename them.
Make sure to disable <code class="literal">services.gitea</code>, when doing this.</p><pre><code class="programlisting nix">{
  services.gitea.enable = false;

  services.forgejo = {
    enable = true;
    user = &quot;gitea&quot;;
    group = &quot;gitea&quot;;
    stateDir = &quot;/var/lib/gitea&quot;;
    database.name = &quot;gitea&quot;;
    database.user = &quot;gitea&quot;;
  };

  users.users.gitea = {
    home = &quot;/var/lib/gitea&quot;;
    useDefaultShell = true;
    group = &quot;gitea&quot;;
    isSystemUser = true;
  };

  users.groups.gitea = {};
}
</code></pre>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-dump1090-fa" class="title" >Dump1090-fa   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-dump1090-fa-configuration">Configuration</a> </span></dt> </dl></div><p><a class="link" href="https://github.com/flightaware/dump1090"  target="_top">dump1090-fa</a> is a demodulator and decoder for ADS-B, Mode S, and Mode 3A/3C aircraft transponder messages. It can receive and decode these messages from an attached software-defined radio or from data received over a network connection.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-dump1090-fa-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><p>When enabled, this module automatically creates a systemd service to start the <code class="literal">dump1090-fa</code> application. The application will then write its JSON output files to <code class="literal">/run/dump1090-fa</code>.</p><p>Exposing the integrated web interface is left to the user’s configuration. Below is a minimal example demonstrating how to serve it using Nginx:</p><pre><code class="programlisting nix">{ pkgs, ... }: {
  services.dump1090-fa.enable = true;

  services.nginx = {
    enable = true;
    virtualHosts.&quot;dump1090-fa&quot; = {
      locations = {
        &quot;/&quot;.alias = &quot;${pkgs.dump1090-fa}/share/dump1090/&quot;;
        &quot;/data/&quot;.alias = &quot;/run/dump1090-fa/&quot;;
      };
    };
  };
}

</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-apache-kafka" class="title" >Apache Kafka   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-apache-kafka-basic-usage">Basic Usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-apache-kafka-kraft">KRaft</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-apache-kafka-migrating-to-settings">Migrating to settings</a> </span></dt> </dl></div><p><a class="link" href="https://kafka.apache.org/"  target="_top">Apache Kafka</a> is an open-source distributed event
streaming platform</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-apache-kafka-basic-usage" class="title" style="clear: both">Basic Usage   </h2>  </div> </div></div><p>The Apache Kafka service is configured almost exclusively through its
<a class="link" href="options.html#opt-services.apache-kafka.settings"  >settings</a> option, with each attribute
corresponding to the <a class="link" href="https://kafka.apache.org/documentation/#configuration"  target="_top">upstream configuration
manual</a> broker settings.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-apache-kafka-kraft" class="title" style="clear: both">KRaft   </h2>  </div> </div></div><p>Unlike in Zookeeper mode, Kafka in
<a class="link" href="https://kafka.apache.org/documentation/#kraft"  target="_top">KRaft</a> mode requires each log
dir to be “formatted” (which means a cluster-specific a metadata file must
exist in each log dir)</p><p>The upstream intention is for users to execute the <a class="link" href="https://kafka.apache.org/documentation/#kraft_storage"  target="_top">storage
tool</a> to achieve this,
but this module contains a few extra options to automate this:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="xref" href="options.html#opt-services.apache-kafka.clusterId"  ><code class="option">services.apache-kafka.clusterId</code></a></p></li><li class="listitem"><p><a class="xref" href="options.html#opt-services.apache-kafka.formatLogDirs"  ><code class="option">services.apache-kafka.formatLogDirs</code></a></p></li><li class="listitem"><p><a class="xref" href="options.html#opt-services.apache-kafka.formatLogDirsIgnoreFormatted"  ><code class="option">services.apache-kafka.formatLogDirsIgnoreFormatted</code></a></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-apache-kafka-migrating-to-settings" class="title" style="clear: both">Migrating to settings   </h2>  </div> </div></div><p>Migrating a cluster to the new <code class="literal">settings</code>-based changes requires adapting removed options to the corresponding upstream settings.</p><p>This means that the upstream <a class="link" href="https://kafka.apache.org/documentation/#brokerconfigs"  target="_top">Broker Configs documentation</a> should be followed closely.</p><p>Note that dotted options in the upstream docs do <span class="emphasis"><em>not</em></span> correspond to nested Nix attrsets, but instead as quoted top level <code class="literal">settings</code> attributes, as in <code class="literal">services.apache-kafka.settings.&quot;broker.id&quot;</code>, <span class="emphasis"><em>NOT</em></span> <code class="literal">services.apache-kafka.settings.broker.id</code>.</p><p>Care should be taken, especially when migrating clusters from the old module, to ensure that the same intended configuration is reproduced faithfully via <code class="literal">settings</code>.</p><p>To assist in the comparison, the final config can be inspected by building the config file itself, ie. with: <code class="literal">nix-build &lt;nixpkgs/nixos&gt; -A config.services.apache-kafka.configFiles.serverProperties</code>.</p><p>Notable changes to be aware of include:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Removal of <code class="literal">services.apache-kafka.extraProperties</code> and <code class="literal">services.apache-kafka.serverProperties</code></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Translate using arbitrary properties using <a class="xref" href="options.html#opt-services.apache-kafka.settings"  ><code class="option">services.apache-kafka.settings</code></a></p></li><li class="listitem"><p><a class="link" href="https://kafka.apache.org/documentation.html#brokerconfigs"  target="_top">Upstream docs</a></p></li><li class="listitem"><p>The intention is for all broker properties to be fully representable via <a class="xref" href="options.html#opt-services.apache-kafka.settings"  ><code class="option">services.apache-kafka.settings</code></a>.</p></li><li class="listitem"><p>If this is not the case, please do consider raising an issue.</p></li><li class="listitem"><p>Until it can be remedied, you <span class="emphasis"><em>can</em></span> bail out by using <a class="xref" href="options.html#opt-services.apache-kafka.configFiles.serverProperties"  ><code class="option">services.apache-kafka.configFiles.serverProperties</code></a> to the path of a fully rendered properties file.</p></li></ul></div></li><li class="listitem"><p>Removal of <code class="literal">services.apache-kafka.hostname</code> and <code class="literal">services.apache-kafka.port</code></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Translate using: <code class="literal">services.apache-kafka.settings.listeners</code></p></li><li class="listitem"><p><a class="link" href="https://kafka.apache.org/documentation.html#brokerconfigs_listeners"  target="_top">Upstream docs</a></p></li></ul></div></li><li class="listitem"><p>Removal of <code class="literal">services.apache-kafka.logDirs</code></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Translate using: <code class="literal">services.apache-kafka.settings.&quot;log.dirs&quot;</code></p></li><li class="listitem"><p><a class="link" href="https://kafka.apache.org/documentation.html#brokerconfigs_log.dirs"  target="_top">Upstream docs</a></p></li></ul></div></li><li class="listitem"><p>Removal of <code class="literal">services.apache-kafka.brokerId</code></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Translate using: <code class="literal">services.apache-kafka.settings.&quot;broker.id&quot;</code></p></li><li class="listitem"><p><a class="link" href="https://kafka.apache.org/documentation.html#brokerconfigs_broker.id"  target="_top">Upstream docs</a></p></li></ul></div></li><li class="listitem"><p>Removal of <code class="literal">services.apache-kafka.zookeeper</code></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Translate using: <code class="literal">services.apache-kafka.settings.&quot;zookeeper.connect&quot;</code></p></li><li class="listitem"><p><a class="link" href="https://kafka.apache.org/documentation.html#brokerconfigs_zookeeper.connect"  target="_top">Upstream docs</a></p></li></ul></div></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-anki-sync-server" class="title" >Anki Sync Server   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-anki-sync-server-basic-usage">Basic Usage</a> </span></dt> </dl></div><p><a class="link" href="https://docs.ankiweb.net/sync-server.html"  target="_top">Anki Sync Server</a> is the built-in
sync server, present in recent versions of Anki. Advanced users who cannot or
do not wish to use AnkiWeb can use this sync server instead of AnkiWeb.</p><p>This module is compatible only with Anki versions &gt;=2.1.66, due to <a class="link" href="https://github.com/NixOS/nixpkgs/commit/05727304f8815825565c944d012f20a9a096838a"  target="_top">recent
enhancements to the Nix anki
package</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-anki-sync-server-basic-usage" class="title" style="clear: both">Basic Usage   </h2>  </div> </div></div><p>By default, the module creates a
<a class="link" href="https://www.freedesktop.org/wiki/Software/systemd/"  target="_top"><code class="literal">systemd</code></a>
unit which runs the sync server with an isolated user using the systemd
<code class="literal">DynamicUser</code> option.</p><p>This can be done by enabling the <code class="literal">anki-sync-server</code> service:</p><pre><code class="programlisting nix">{ ... }:

{
  services.anki-sync-server.enable = true;
}
</code></pre><p>It is necessary to set at least one username-password pair under
<code class="option">services.anki-sync-server.users</code>. For example</p><pre><code class="programlisting nix">{
  services.anki-sync-server.users = [
    {
      username = &quot;user&quot;;
      passwordFile = /etc/anki-sync-server/user;
    }
  ];
}
</code></pre><p>Here, <code class="literal">passwordFile</code> is the path to a file containing just the password in
plaintext. Make sure to set permissions to make this file unreadable to any
user besides root.</p><p>By default, synced data are stored in <span class="emphasis"><em>/var/lib/anki-sync-server/<span class="emphasis"><em>ankiuser</em></span></em></span>.
You can change the directory by using <code class="literal">services.anki-sync-server.baseDirectory</code></p><pre><code class="programlisting nix">{
  services.anki-sync-server.baseDirectory = &quot;/home/anki/data&quot;;
}
</code></pre><p>By default, the server listen address <code class="option">services.anki-sync-server.host</code>
is set to localhost, listening on port
<code class="option">services.anki-sync-server.port</code>, and does not open the firewall. This
is suitable for purely local testing, or to be used behind a reverse proxy. If
you want to expose the sync server directly to other computers (not recommended
in most circumstances, because the sync server doesn’t use HTTPS), then set the
following options:</p><pre><code class="programlisting nix">{
  services.anki-sync-server.address = &quot;0.0.0.0&quot;;
  services.anki-sync-server.openFirewall = true;
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matrix" class="title" >Matrix   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-matrix-synapse">Synapse Homeserver</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-matrix-register-users">Registering Matrix users</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-matrix-element-web">Element (formerly known as Riot) Web Client</a> </span></dt> </dl></div><p><a class="link" href="https://matrix.org/"  target="_top">Matrix</a> is an open standard for
interoperable, decentralised, real-time communication over IP. It can be used
to power Instant Messaging, VoIP/WebRTC signalling, Internet of Things
communication - or anywhere you need a standard HTTP API for publishing and
subscribing to data whilst tracking the conversation history.</p><p>This chapter will show you how to set up your own, self-hosted Matrix
homeserver using the Synapse reference homeserver, and how to serve your own
copy of the Element web client. See the
<a class="link" href="https://matrix.org/docs/projects/try-matrix-now.html"  target="_top">Try Matrix Now!</a>
overview page for links to Element Apps for Android and iOS,
desktop clients, as well as bridges to other networks and other projects
around Matrix.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matrix-synapse" class="title" style="clear: both">Synapse Homeserver   </h2>  </div> </div></div><p><a class="link" href="https://github.com/element-hq/synapse"  target="_top">Synapse</a> is
the reference homeserver implementation of Matrix from the core development
team at matrix.org.</p><p>Before deploying synapse server, a postgresql database must be set up.
For that, please make sure that postgresql is running and the following
SQL statements to create a user &amp; database called <code class="literal">matrix-synapse</code> were
executed before synapse starts up:</p><pre><code class="programlisting sql">CREATE ROLE &quot;matrix-synapse&quot;;
CREATE DATABASE &quot;matrix-synapse&quot; WITH OWNER &quot;matrix-synapse&quot;
  TEMPLATE template0
  LC_COLLATE = &quot;C&quot;
  LC_CTYPE = &quot;C&quot;;
</code></pre><p>Usually, it’s sufficient to do this once manually before
continuing with the installation.</p><p>Please make sure to set a different password.</p><p>The following configuration example will set up a
synapse server for the <code class="literal">example.org</code> domain, served from
the host <code class="literal">myhostname.example.org</code>. For more information,
please refer to the
<a class="link" href="https://element-hq.github.io/synapse/latest/setup/installation.html"  target="_top">installation instructions of Synapse</a> .</p><pre><code class="programlisting nix">{ pkgs, lib, config, ... }:
let
  fqdn = &quot;${config.networking.hostName}.${config.networking.domain}&quot;;
  baseUrl = &quot;https://${fqdn}&quot;;
  clientConfig.&quot;m.homeserver&quot;.base_url = baseUrl;
  serverConfig.&quot;m.server&quot; = &quot;${fqdn}:443&quot;;
  mkWellKnown = data: &#x27;&#x27;
    default_type application/json;
    add_header Access-Control-Allow-Origin *;
    return 200 &#x27;${builtins.toJSON data}&#x27;;
  &#x27;&#x27;;
in {
  networking.hostName = &quot;myhostname&quot;;
  networking.domain = &quot;example.org&quot;;
  networking.firewall.allowedTCPPorts = [ 80 443 ];

  services.postgresql.enable = true;

  services.nginx = {
    enable = true;
    recommendedTlsSettings = true;
    recommendedOptimisation = true;
    recommendedGzipSettings = true;
    recommendedProxySettings = true;
    virtualHosts = {
      # If the A and AAAA DNS records on example.org do not point on the same host as the
      # records for myhostname.example.org, you can easily move the /.well-known
      # virtualHost section of the code to the host that is serving example.org, while
      # the rest stays on myhostname.example.org with no other changes required.
      # This pattern also allows to seamlessly move the homeserver from
      # myhostname.example.org to myotherhost.example.org by only changing the
      # /.well-known redirection target.
      &quot;${config.networking.domain}&quot; = {
        enableACME = true;
        forceSSL = true;
        # This section is not needed if the server_name of matrix-synapse is equal to
        # the domain (i.e. example.org from @foo:example.org) and the federation port
        # is 8448.
        # Further reference can be found in the docs about delegation under
        # https://element-hq.github.io/synapse/latest/delegate.html
        locations.&quot;= /.well-known/matrix/server&quot;.extraConfig = mkWellKnown serverConfig;
        # This is usually needed for homeserver discovery (from e.g. other Matrix clients).
        # Further reference can be found in the upstream docs at
        # https://spec.matrix.org/latest/client-server-api/#getwell-knownmatrixclient
        locations.&quot;= /.well-known/matrix/client&quot;.extraConfig = mkWellKnown clientConfig;
      };
      &quot;${fqdn}&quot; = {
        enableACME = true;
        forceSSL = true;
        # It&#x27;s also possible to do a redirect here or something else, this vhost is not
        # needed for Matrix. It&#x27;s recommended though to *not put* element
        # here, see also the section about Element.
        locations.&quot;/&quot;.extraConfig = &#x27;&#x27;
          return 404;
        &#x27;&#x27;;
        # Forward all Matrix API calls to the synapse Matrix homeserver. A trailing slash
        # *must not* be used here.
        locations.&quot;/_matrix&quot;.proxyPass = &quot;http://[::1]:8008&quot;;
        # Forward requests for e.g. SSO and password-resets.
        locations.&quot;/_synapse/client&quot;.proxyPass = &quot;http://[::1]:8008&quot;;
      };
    };
  };

  services.matrix-synapse = {
    enable = true;
    settings.server_name = config.networking.domain;
    # The public base URL value must match the `base_url` value set in `clientConfig` above.
    # The default value here is based on `server_name`, so if your `server_name` is different
    # from the value of `fqdn` above, you will likely run into some mismatched domain names
    # in client applications.
    settings.public_baseurl = baseUrl;
    settings.listeners = [
      { port = 8008;
        bind_addresses = [ &quot;::1&quot; ];
        type = &quot;http&quot;;
        tls = false;
        x_forwarded = true;
        resources = [ {
          names = [ &quot;client&quot; &quot;federation&quot; ];
          compress = true;
        } ];
      }
    ];
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matrix-register-users" class="title" style="clear: both">Registering Matrix users   </h2>  </div> </div></div><p>If you want to run a server with public registration by anybody, you can
then enable <code class="literal">services.matrix-synapse.settings.enable_registration = true;</code>.
Otherwise, or you can generate a registration secret with
<span class="command"><strong>pwgen -s 64 1</strong></span> and set it with
<a class="xref" href="options.html#opt-services.matrix-synapse.settings.registration_shared_secret"  ><code class="option">services.matrix-synapse.settings.registration_shared_secret</code></a>.
To create a new user or admin from the terminal your client listener
must be configured to use TCP sockets. Then you can run the following
after you have set the secret and have rebuilt NixOS:</p><pre><code class="programlisting ShellSession">$ nix-shell -p matrix-synapse
$ register_new_matrix_user -k your-registration-shared-secret http://localhost:8008
New user localpart: your-username
Password:
Confirm password:
Make admin [no]:
Success!
</code></pre><p>In the example, this would create a user with the Matrix Identifier
<code class="literal">@your-username:example.org</code>.</p><div class="warning"><h3 class="title">Warning</h3><p>When using <a class="xref" href="options.html#opt-services.matrix-synapse.settings.registration_shared_secret"  ><code class="option">services.matrix-synapse.settings.registration_shared_secret</code></a>, the secret
will end up in the world-readable store. Instead it’s recommended to deploy the secret
in an additional file like this:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Create a file with the following contents:</p><pre><code class="programlisting">registration_shared_secret: your-very-secret-secret
</code></pre></li><li class="listitem"><p>Deploy the file with a secret-manager such as
<a class="link" href="https://nixops.readthedocs.io/en/latest/overview.html#managing-keys"  target="_top"><code class="option">deployment.keys</code></a>
from <span class="citerefentry"><span class="refentrytitle">nixops</span>(1)</span> or <a class="link" href="https://github.com/Mic92/sops-nix/"  target="_top">sops-nix</a> to
e.g. <code class="filename">/run/secrets/matrix-shared-secret</code> and ensure that it’s readable
by <code class="literal">matrix-synapse</code>.</p></li><li class="listitem"><p>Include the file like this in your configuration:</p><pre><code class="programlisting nix">{
  services.matrix-synapse.extraConfigFiles = [
    &quot;/run/secrets/matrix-shared-secret&quot;
  ];
}
</code></pre></li></ul></div></div><div class="note"><h3 class="title">Note</h3><p>It’s also possible to user alternative authentication mechanism such as
<a class="link" href="https://github.com/matrix-org/matrix-synapse-ldap3"  target="_top">LDAP (via <code class="literal">matrix-synapse-ldap3</code>)</a>
or <a class="link" href="https://element-hq.github.io/synapse/latest/openid.html"  target="_top">OpenID</a>.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matrix-element-web" class="title" style="clear: both">Element (formerly known as Riot) Web Client   </h2>  </div> </div></div><p><a class="link" href="https://github.com/element-hq/element-web"  target="_top">Element Web</a> is
the reference web client for Matrix and developed by the core team at
matrix.org. Element was formerly known as Riot.im, see the
<a class="link" href="https://element.io/blog/welcome-to-element/"  target="_top">Element introductory blog post</a>
for more information. The following snippet can be optionally added to the code before
to complete the synapse installation with a web client served at
<code class="literal">https://element.myhostname.example.org</code> and
<code class="literal">https://element.example.org</code>. Alternatively, you can use the hosted
copy at <a class="link" href="https://app.element.io/"  target="_top">https://app.element.io/</a>,
or use other web clients or native client applications. Due to the
<code class="literal">/.well-known</code> urls set up done above, many clients should
fill in the required connection details automatically when you enter your
Matrix Identifier. See
<a class="link" href="https://matrix.org/docs/projects/try-matrix-now.html"  target="_top">Try Matrix Now!</a>
for a list of existing clients and their supported featureset.</p><pre><code class="programlisting nix">{
  services.nginx.virtualHosts.&quot;element.${fqdn}&quot; = {
    enableACME = true;
    forceSSL = true;
    serverAliases = [
      &quot;element.${config.networking.domain}&quot;
    ];

    root = pkgs.element-web.override {
      conf = {
        default_server_config = clientConfig; # see `clientConfig` from the snippet above.
      };
    };
  };
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>The Element developers do not recommend running Element and your Matrix
homeserver on the same fully-qualified domain name for security reasons. In
the example, this means that you should not reuse the
<code class="literal">myhostname.example.org</code> virtualHost to also serve Element,
but instead serve it on a different subdomain, like
<code class="literal">element.example.org</code> in the example. See the
<a class="link" href="https://github.com/element-hq/element-web/tree/v1.10.0#important-security-notes"  target="_top">Element Important Security Notes</a>
for more information on this subject.</p></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mjolnir" class="title" >Mjolnir (Matrix Moderation Tool)   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-mjolnir-setup">Mjolnir Setup</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-mjolnir-matrix-synapse-antispam">Synapse Antispam Module</a> </span></dt> </dl></div><p>This chapter will show you how to set up your own, self-hosted
<a class="link" href="https://github.com/matrix-org/mjolnir"  target="_top">Mjolnir</a> instance.</p><p>As an all-in-one moderation tool, it can protect your server from
malicious invites, spam messages, and whatever else you don’t want.
In addition to server-level protection, Mjolnir is great for communities
wanting to protect their rooms without having to use their personal
accounts for moderation.</p><p>The bot by default includes support for bans, redactions, anti-spam,
server ACLs, room directory changes, room alias transfers, account
deactivation, room shutdown, and more.</p><p>See the <a class="link" href="https://github.com/matrix-org/mjolnir#readme"  target="_top">README</a>
page and the <a class="link" href="https://github.com/matrix-org/mjolnir/blob/main/docs/moderators.md"  target="_top">Moderator’s guide</a>
for additional instructions on how to setup and use Mjolnir.</p><p>For <a class="link" href="options.html#opt-services.mjolnir.settings"  >additional settings</a>
see <a class="link" href="https://github.com/matrix-org/mjolnir/blob/main/config/default.yaml"  target="_top">the default configuration</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mjolnir-setup" class="title" style="clear: both">Mjolnir Setup   </h2>  </div> </div></div><p>First create a new Room which will be used as a management room for Mjolnir. In
this room, Mjolnir will log possible errors and debugging information. You’ll
need to set this Room-ID in <a class="link" href="options.html#opt-services.mjolnir.managementRoom"  >services.mjolnir.managementRoom</a>.</p><p>Next, create a new user for Mjolnir on your homeserver, if not present already.</p><p>The Mjolnir Matrix user expects to be free of any rate limiting.
See <a class="link" href="https://github.com/matrix-org/synapse/issues/6286"  target="_top">Synapse #6286</a>
for an example on how to achieve this.</p><p>If you want Mjolnir to be able to deactivate users, move room aliases, shutdown rooms, etc.
you’ll need to make the Mjolnir user a Matrix server admin.</p><p>Now invite the Mjolnir user to the management room.</p><p>It is recommended to use <a class="link" href="https://github.com/matrix-org/pantalaimon"  target="_top">Pantalaimon</a>,
so your management room can be encrypted. This also applies if you are looking to moderate an encrypted room.</p><p>To enable the Pantalaimon E2E Proxy for mjolnir, enable
<a class="link" href="options.html#opt-services.mjolnir.pantalaimon.enable"  >services.mjolnir.pantalaimon</a>. This will
autoconfigure a new Pantalaimon instance, which will connect to the homeserver
set in <a class="link" href="options.html#opt-services.mjolnir.homeserverUrl"  >services.mjolnir.homeserverUrl</a> and Mjolnir itself
will be configured to connect to the new Pantalaimon instance.</p><pre><code class="programlisting nix">{
  services.mjolnir = {
    enable = true;
    homeserverUrl = &quot;https://matrix.domain.tld&quot;;
    pantalaimon = {
       enable = true;
       username = &quot;mjolnir&quot;;
       passwordFile = &quot;/run/secrets/mjolnir-password&quot;;
    };
    protectedRooms = [
      &quot;https://matrix.to/#/!xxx:domain.tld&quot;
    ];
    managementRoom = &quot;!yyy:domain.tld&quot;;
  };
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-mjolnir-setup-ems" class="title" >Element Matrix Services (EMS)   </h3>  </div> </div></div><p>If you are using a managed <a class="link" href="https://ems.element.io/"  target="_top">“Element Matrix Services (EMS)”</a>
server, you will need to consent to the terms and conditions. Upon startup, an error
log entry with a URL to the consent page will be generated.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mjolnir-matrix-synapse-antispam" class="title" style="clear: both">Synapse Antispam Module   </h2>  </div> </div></div><p>A Synapse module is also available to apply the same rulesets the bot
uses across an entire homeserver.</p><p>To use the Antispam Module, add <code class="literal">matrix-synapse-plugins.matrix-synapse-mjolnir-antispam</code>
to the Synapse plugin list and enable the <code class="literal">mjolnir.Module</code> module.</p><pre><code class="programlisting nix">{
  services.matrix-synapse = {
    plugins = with pkgs; [
      matrix-synapse-plugins.matrix-synapse-mjolnir-antispam
    ];
    extraConfig = &#x27;&#x27;
      modules:
        - module: mjolnir.Module
          config:
            # Prevent servers/users in the ban lists from inviting users on this
            # server to rooms. Default true.
            block_invites: true
            # Flag messages sent by servers/users in the ban lists as spam. Currently
            # this means that spammy messages will appear as empty to users. Default
            # false.
            block_messages: false
            # Remove users from the user directory search by filtering matrix IDs and
            # display names by the entries in the user ban list. Default false.
            block_usernames: false
            # The room IDs of the ban lists to honour. Unlike other parts of Mjolnir,
            # this list cannot be room aliases or permalinks. This server is expected
            # to already be joined to the room - Mjolnir will not automatically join
            # these rooms.
            ban_lists:
              - &quot;!roomid:example.org&quot;
    &#x27;&#x27;;
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mautrix-signal" class="title" >Mautrix-Signal   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-mautrix-signal-configuration">Configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-mautrix-signal-migrate-configuration">Migrating from an older configuration</a> </span></dt> </dl></div><p><a class="link" href="https://github.com/mautrix/signal"  target="_top">Mautrix-Signal</a> is a Matrix-Signal puppeting bridge.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mautrix-signal-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Set <a class="xref" href="options.html#opt-services.mautrix-signal.enable"  ><code class="option">services.mautrix-signal.enable</code></a> to <code class="literal">true</code>. The service will use
SQLite by default.</p></li><li class="listitem"><p>To create your configuration check the default configuration for
<a class="xref" href="options.html#opt-services.mautrix-signal.settings"  ><code class="option">services.mautrix-signal.settings</code></a>. To obtain the complete default
configuration, run
<code class="literal">nix-shell -p mautrix-signal --run &quot;mautrix-signal -c default.yaml -e&quot;</code>.</p></li></ol></div><div class="warning"><h3 class="title">Warning</h3><p>Mautrix-Signal allows for some options like <code class="literal">encryption.pickle_key</code>,
<code class="literal">provisioning.shared_secret</code>, allow the value <code class="literal">generate</code> to be set.
Since the configuration file is regenerated on every start of the
service, the generated values would be discarded and might break your
installation. Instead, set those values via
<a class="xref" href="options.html#opt-services.mautrix-signal.environmentFile"  ><code class="option">services.mautrix-signal.environmentFile</code></a>.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mautrix-signal-migrate-configuration" class="title" style="clear: both">Migrating from an older configuration   </h2>  </div> </div></div><p>With Mautrix-Signal v0.7.0 the configuration has been rearranged. Mautrix-Signal
performs an automatic configuration migration so your pre-0.7.0 configuration
should just continue to work.</p><p>In case you want to update your NixOS configuration, compare the migrated configuration
at <code class="literal">/var/lib/mautrix-signal/config.yaml</code> with the default configuration
(<code class="literal">nix-shell -p mautrix-signal --run &quot;mautrix-signal -c example.yaml -e&quot;</code>) and
update your module configuration accordingly.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-maubot" class="title" >Maubot   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-maubot-configuration">Configuration</a> </span></dt> </dl></div><p><a class="link" href="https://github.com/maubot/maubot"  target="_top">Maubot</a> is a plugin-based bot
framework for Matrix.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-maubot-configuration" class="title" style="clear: both">Configuration   </h2>  </div> </div></div><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Set <a class="xref" href="options.html#opt-services.maubot.enable"  ><code class="option">services.maubot.enable</code></a> to <code class="literal">true</code>. The service will use
SQLite by default.</p></li><li class="listitem"><p>If you want to use PostgreSQL instead of SQLite, do this:</p><pre><code class="programlisting nix">{
  services.maubot.settings.database = &quot;postgresql://maubot@localhost/maubot&quot;;
}
</code></pre><p>If the PostgreSQL connection requires a password, you will have to
add it later on step 8.</p></li><li class="listitem"><p>If you plan to expose your Maubot interface to the web, do something
like this:</p><pre><code class="programlisting nix">{
  services.nginx.virtualHosts.&quot;matrix.example.org&quot;.locations = {
    &quot;/_matrix/maubot/&quot; = {
      proxyPass = &quot;http://127.0.0.1:${toString config.services.maubot.settings.server.port}&quot;;
      proxyWebsockets = true;
    };
  };
  services.maubot.settings.server.public_url = &quot;matrix.example.org&quot;;
  # do the following only if you want to use something other than /_matrix/maubot...
  services.maubot.settings.server.ui_base_path = &quot;/another/base/path&quot;;
}
</code></pre></li><li class="listitem"><p>Optionally, set <code class="literal">services.maubot.pythonPackages</code> to a list of python3
packages to make available for Maubot plugins.</p></li><li class="listitem"><p>Optionally, set <code class="literal">services.maubot.plugins</code> to a list of Maubot
plugins (full list available at https://plugins.maubot.xyz/):</p><pre><code class="programlisting nix">{
  services.maubot.plugins = with config.services.maubot.package.plugins; [
    reactbot
    # This will only change the default config! After you create a
    # plugin instance, the default config will be copied into that
    # instance&#x27;s config in Maubot&#x27;s database, and further base config
    # changes won&#x27;t affect the running plugin.
    (rss.override {
      base_config = {
        update_interval = 60;
        max_backoff = 7200;
        spam_sleep = 2;
        command_prefix = &quot;rss&quot;;
        admins = [ &quot;@chayleaf:pavluk.org&quot; ];
      };
    })
  ];
  # ...or...
  services.maubot.plugins = config.services.maubot.package.plugins.allOfficialPlugins;
  # ...or...
  services.maubot.plugins = config.services.maubot.package.plugins.allPlugins;
  # ...or...
  services.maubot.plugins = with config.services.maubot.package.plugins; [
    (weather.override {
      # you can pass base_config as a string
      base_config = &#x27;&#x27;
        default_location: New York
        default_units: M
        default_language:
        show_link: true
        show_image: false
      &#x27;&#x27;;
    })
  ];
}
</code></pre></li><li class="listitem"><p>Start Maubot at least once before doing the following steps (it’s
necessary to generate the initial config).</p></li><li class="listitem"><p>If your PostgreSQL connection requires a password, add
<code class="literal">database: postgresql://user:password@localhost/maubot</code>
to <code class="literal">/var/lib/maubot/config.yaml</code>. This overrides the Nix-provided
config. Even then, don’t remove the <code class="literal">database</code> line from Nix config
so the module knows you use PostgreSQL!</p></li><li class="listitem"><p>To create a user account for logging into Maubot web UI and
configuring it, generate a password using the shell command
<code class="literal">mkpasswd -R 12 -m bcrypt</code>, and edit <code class="literal">/var/lib/maubot/config.yaml</code>
with the following:</p><pre><code class="programlisting yaml">admins:
    admin_username: $2b$12$g.oIStUeUCvI58ebYoVMtO/vb9QZJo81PsmVOomHiNCFbh0dJpZVa
</code></pre><p>Where <code class="literal">admin_username</code> is your username, and <code class="literal">$2b...</code> is the bcrypted
password.</p></li><li class="listitem"><p>Optional: if you want to be able to register new users with the
Maubot CLI (<code class="literal">mbc</code>), and your homeserver is private, add your
homeserver’s registration key to <code class="literal">/var/lib/maubot/config.yaml</code>:</p><pre><code class="programlisting yaml">homeservers:
    matrix.example.org:
        url: https://matrix.example.org
        secret: your-very-secret-key
</code></pre></li><li class="listitem"><p>Restart Maubot after editing <code class="literal">/var/lib/maubot/config.yaml</code>,and
Maubot will be available at
<code class="literal">https://matrix.example.org/_matrix/maubot</code>. If you want to use the
<code class="literal">mbc</code> CLI, it’s available using the <code class="literal">maubot</code> package (<code class="literal">nix-shell -p maubot</code>).</p></li></ol></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-draupnir" class="title" >Draupnir (Matrix Moderation Bot)   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-draupnir-setup">Draupnir Setup</a> </span></dt> </dl></div><p>This chapter will show you how to set up your own, self-hosted
<a class="link" href="https://github.com/the-draupnir-project/Draupnir"  target="_top">Draupnir</a> instance.</p><p>As an all-in-one moderation tool, it can protect your server from
malicious invites, spam messages, and whatever else you don’t want.
In addition to server-level protection, Draupnir is great for communities
wanting to protect their rooms without having to use their personal
accounts for moderation.</p><p>The bot by default includes support for bans, redactions, anti-spam,
server ACLs, room directory changes, room alias transfers, account
deactivation, room shutdown, and more. (This depends on homeserver configuration and implementation.)</p><p>See the <a class="link" href="https://github.com/the-draupnir-project/draupnir#readme"  target="_top">README</a>
page and the <a class="link" href="https://the-draupnir-project.github.io/draupnir-documentation/moderator/setting-up-and-configuring"  target="_top">Moderator’s guide</a>
for additional instructions on how to setup and use Draupnir.</p><p>For <a class="link" href="options.html#opt-services.draupnir.settings"  >additional settings</a>
see <a class="link" href="https://github.com/the-draupnir-project/Draupnir/blob/main/config/default.yaml"  target="_top">the default configuration</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-draupnir-setup" class="title" style="clear: both">Draupnir Setup   </h2>  </div> </div></div><p>First create a new unencrypted, private room which will be used as the management room for Draupnir.
This is the room in which moderators will interact with Draupnir and where it will log possible errors and debugging information.
You’ll need to set this room ID or alias in <a class="link" href="options.html#opt-services.draupnir.settings.managementRoom"  >services.draupnir.settings.managementRoom</a>.</p><p>Next, create a new user for Draupnir on your homeserver, if one does not already exist.</p><p>The Draupnir Matrix user expects to be free of any rate limiting.
See <a class="link" href="https://github.com/matrix-org/synapse/issues/6286"  target="_top">Synapse #6286</a>
for an example on how to achieve this.</p><p>If you want Draupnir to be able to deactivate users, move room aliases, shut down rooms, etc.
you’ll need to make the Draupnir user a Matrix server admin.</p><p>Now invite the Draupnir user to the management room.
Draupnir will automatically try to join this room on startup.</p><pre><code class="programlisting nix">{
  services.draupnir = {
    enable = true;

    settings = {
      homeserverUrl = &quot;https://matrix.org&quot;;
      managementRoom = &quot;!yyy:example.org&quot;;
    };

    secrets = {
      accessToken = &quot;/path/to/secret/containing/access-token&quot;;
    };
  };
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-draupnir-setup-ems" class="title" >Element Matrix Services (EMS)   </h3>  </div> </div></div><p>If you are using a managed <a class="link" href="https://ems.element.io/"  target="_top">“Element Matrix Services (EMS)”</a>
server, you will need to consent to the terms and conditions. Upon startup, an error
log entry with a URL to the consent page will be generated.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mailman" class="title" >Mailman   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-mailman-basic-usage">Basic usage with Postfix</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-mailman-other-mtas">Using with other MTAs</a> </span></dt> </dl></div><p><a class="link" href="https://www.list.org"  target="_top">Mailman</a> is free
software for managing electronic mail discussion and e-newsletter
lists. Mailman and its web interface can be configured using the
corresponding NixOS module. Note that this service is best used with
an existing, securely configured Postfix setup, as it does not automatically configure this.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mailman-basic-usage" class="title" style="clear: both">Basic usage with Postfix   </h2>  </div> </div></div><p>For a basic configuration with Postfix as the MTA, the following settings are suggested:</p><pre><code class="programlisting nix">{ config, ... }: {
  services.postfix = {
    enable = true;
    relayDomains = [&quot;hash:/var/lib/mailman/data/postfix_domains&quot;];
    sslCert = config.security.acme.certs.&quot;lists.example.org&quot;.directory + &quot;/full.pem&quot;;
    sslKey = config.security.acme.certs.&quot;lists.example.org&quot;.directory + &quot;/key.pem&quot;;
    config = {
      transport_maps = [&quot;hash:/var/lib/mailman/data/postfix_lmtp&quot;];
      local_recipient_maps = [&quot;hash:/var/lib/mailman/data/postfix_lmtp&quot;];
    };
  };
  services.mailman = {
    enable = true;
    serve.enable = true;
    hyperkitty.enable = true;
    webHosts = [&quot;lists.example.org&quot;];
    siteOwner = &quot;mailman@example.org&quot;;
  };
  services.nginx.virtualHosts.&quot;lists.example.org&quot;.enableACME = true;
  networking.firewall.allowedTCPPorts = [ 25 80 443 ];
}
</code></pre><p>DNS records will also be required:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">AAAA</code> and <code class="literal">A</code> records pointing to the host in question, in order for browsers to be able to discover the address of the web server;</p></li><li class="listitem"><p>An <code class="literal">MX</code> record pointing to a domain name at which the host is reachable, in order for other mail servers to be able to deliver emails to the mailing lists it hosts.</p></li></ul></div><p>After this has been done and appropriate DNS records have been
set up, the Postorius mailing list manager and the Hyperkitty
archive browser will be available at
https://lists.example.org/. Note that this setup is not
sufficient to deliver emails to most email providers nor to
avoid spam – a number of additional measures for authenticating
incoming and outgoing mails, such as SPF, DMARC and DKIM are
necessary, but outside the scope of the Mailman module.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mailman-other-mtas" class="title" style="clear: both">Using with other MTAs   </h2>  </div> </div></div><p>Mailman also supports other MTA, though with a little bit more configuration. For example, to use Mailman with Exim, you can use the following settings:</p><pre><code class="programlisting nix">{ config, ... }: {
  services = {
    mailman = {
      enable = true;
      siteOwner = &quot;mailman@example.org&quot;;
      enablePostfix = false;
      settings.mta = {
        incoming = &quot;mailman.mta.exim4.LMTP&quot;;
        outgoing = &quot;mailman.mta.deliver.deliver&quot;;
        lmtp_host = &quot;localhost&quot;;
        lmtp_port = &quot;8024&quot;;
        smtp_host = &quot;localhost&quot;;
        smtp_port = &quot;25&quot;;
        configuration = &quot;python:mailman.config.exim4&quot;;
      };
    };
    exim = {
      enable = true;
      # You can configure Exim in a separate file to reduce configuration.nix clutter
      config = builtins.readFile ./exim.conf;
    };
  };
}
</code></pre><p>The exim config needs some special additions to work with Mailman. Currently
NixOS can’t manage Exim config with such granularity. Please refer to
<a class="link" href="https://mailman.readthedocs.io/en/latest/src/mailman/docs/mta.html"  target="_top">Mailman documentation</a>
for more info on configuring Mailman for working with Exim.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="trezor" class="title" >Trezor   </h2>  </div> </div></div><p>Trezor is an open-source cryptocurrency hardware wallet and security token
allowing secure storage of private keys.</p><p>It offers advanced features such U2F two-factor authorization, SSH login
through
<a class="link" href="https://wiki.trezor.io/Apps:SSH_agent"  target="_top">Trezor SSH agent</a>,
<a class="link" href="https://wiki.trezor.io/GPG"  target="_top">GPG</a> and a
<a class="link" href="https://wiki.trezor.io/Trezor_Password_Manager"  target="_top">password manager</a>.
For more information, guides and documentation, see <a class="link" href="https://wiki.trezor.io"  target="_top">https://wiki.trezor.io</a>.</p><p>To enable Trezor support, add the following to your <code class="filename">configuration.nix</code>:</p><pre><code class="programlisting">services.trezord.enable = true;
</code></pre><p>This will add all necessary udev rules and start Trezor Bridge.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-hardware-display" class="title" >Customizing display configuration   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-hardware-display-modes">Forcing display modes</a> </span></dt><dt> <span class="section">  <a href="index.html#module-hardware-display-edid-custom">Crafting custom EDID files</a> </span></dt><dt> <span class="section">  <a href="index.html#module-hardware-display-edid-assign">Assigning EDID files to displays</a> </span></dt><dt> <span class="section">  <a href="index.html#module-hardware-display-edid-linuxhw">Pulling files from linuxhw/EDID database</a> </span></dt><dt> <span class="section">  <a href="index.html#module-hardware-display-edid-modelines">Using XFree86 Modeline definitions</a> </span></dt><dt> <span class="section">  <a href="index.html#module-hardware-display-pg278q">Complete example for Asus PG278Q</a> </span></dt> </dl></div><p>This section describes how to customize display configuration using:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>kernel modes</p></li><li class="listitem"><p>EDID files</p></li></ul></div><p>Example situations it can help you with:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>display controllers (external hardware) not advertising EDID at all,</p></li><li class="listitem"><p>misbehaving graphics drivers,</p></li><li class="listitem"><p>loading custom display configuration before the Display Manager is running,</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-hardware-display-modes" class="title" style="clear: both">Forcing display modes   </h2>  </div> </div></div><p>In case of very wrong monitor controller and/or video driver combination you can
<a class="link" href="https://mjmwired.net/kernel/Documentation/fb/modedb.txt#41"  target="_top">force the display to be enabled</a>
and skip some driver-side checks by adding <code class="literal">video=&lt;OUTPUT&gt;:e</code> to <code class="literal">boot.kernelParams</code>.
This is exactly the case with <a class="link" href="https://gitlab.freedesktop.org/drm/amd/-/issues/615#note_1987392"  target="_top"><code class="literal">amdgpu</code> drivers</a></p><pre><code class="programlisting nix">{
  # force enabled output to skip `amdgpu` checks
  hardware.display.outputs.&quot;DP-1&quot;.mode = &quot;e&quot;;
  # completely disable output no matter what is connected to it
  hardware.display.outputs.&quot;VGA-2&quot;.mode = &quot;d&quot;;

  /* equals
  boot.kernelParams = [ &quot;video=DP-1:e&quot; &quot;video=VGA-2:d&quot; ];
  */
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-hardware-display-edid-custom" class="title" style="clear: both">Crafting custom EDID files   </h2>  </div> </div></div><p>To make custom EDID binaries discoverable you should first create a derivation storing them at
<code class="literal">$out/lib/firmware/edid/</code> and secondly add that derivation to <code class="literal">hardware.display.edid.packages</code> NixOS option:</p><pre><code class="programlisting nix">{
  hardware.display.edid.packages = [
    (pkgs.runCommand &quot;edid-custom&quot; {} &#x27;&#x27;
       mkdir -p $out/lib/firmware/edid
       base64 -d &gt; &quot;$out/lib/firmware/edid/custom1.bin&quot; &lt;&lt;&#x27;EOF&#x27;
       &lt;insert your base64 encoded EDID file here `base64 &lt; /sys/class/drm/card0-.../edid`&gt;
       EOF
       base64 -d &gt; &quot;$out/lib/firmware/edid/custom2.bin&quot; &lt;&lt;&#x27;EOF&#x27;
       &lt;insert your base64 encoded EDID file here `base64 &lt; /sys/class/drm/card1-.../edid`&gt;
       EOF
    &#x27;&#x27;)
  ];
}
</code></pre><p>There are 2 options significantly easing preparation of EDID files:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">hardware.display.edid.linuxhw</code></p></li><li class="listitem"><p><code class="literal">hardware.display.edid.modelines</code></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-hardware-display-edid-assign" class="title" style="clear: both">Assigning EDID files to displays   </h2>  </div> </div></div><p>To assign available custom EDID binaries to your monitor (video output) use <code class="literal">hardware.display.outputs.&quot;&lt;NAME&gt;&quot;.edid</code> option.
Under the hood it adds <code class="literal">drm.edid_firmware</code> entry to <code class="literal">boot.kernelParams</code> NixOS option for each configured output:</p><pre><code class="programlisting nix">{
  hardware.display.outputs.&quot;VGA-1&quot;.edid = &quot;custom1.bin&quot;;
  hardware.display.outputs.&quot;VGA-2&quot;.edid = &quot;custom2.bin&quot;;
  /* equals:
  boot.kernelParams = [ &quot;drm.edid_firmware=VGA-1:edid/custom1.bin,VGA-2:edid/custom2.bin&quot; ];
  */
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-hardware-display-edid-linuxhw" class="title" style="clear: both">Pulling files from linuxhw/EDID database   </h2>  </div> </div></div><p><code class="literal">hardware.display.edid.linuxhw</code> utilizes <code class="literal">pkgs.linuxhw-edid-fetcher</code> to extract EDID files
from https://github.com/linuxhw/EDID based on simple string/regexp search identifying exact entries:</p><pre><code class="programlisting nix">{
  hardware.display.edid.linuxhw.&quot;PG278Q_2014&quot; = [ &quot;PG278Q&quot; &quot;2014&quot; ];

  /* equals:
  hardware.display.edid.packages = [
    (pkgs.linuxhw-edid-fetcher.override {
      displays = {
        &quot;PG278Q_2014&quot; = [ &quot;PG278Q&quot; &quot;2014&quot; ];
      };
    })
  ];
  */
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-hardware-display-edid-modelines" class="title" style="clear: both">Using XFree86 Modeline definitions   </h2>  </div> </div></div><p><code class="literal">hardware.display.edid.modelines</code> utilizes <code class="literal">pkgs.edid-generator</code> package allowing you to
conveniently use <a class="link" href="https://en.wikipedia.org/wiki/XFree86_Modeline"  target="_top"><code class="literal">XFree86 Modeline</code></a> entries as EDID binaries:</p><pre><code class="programlisting nix">{
  hardware.display.edid.modelines.&quot;PG278Q_60&quot; = &quot;    241.50   2560 2608 2640 2720   1440 1443 1448 1481   -hsync +vsync&quot;;
  hardware.display.edid.modelines.&quot;PG278Q_120&quot; = &quot;   497.75   2560 2608 2640 2720   1440 1443 1448 1525   +hsync -vsync&quot;;

  /* equals:
  hardware.display.edid.packages = [
    (pkgs.edid-generator.overrideAttrs {
      clean = true;
      modelines = &#x27;&#x27;
        Modeline &quot;PG278Q_60&quot;      241.50   2560 2608 2640 2720   1440 1443 1448 1481   -hsync +vsync
        Modeline &quot;PG278Q_120&quot;     497.75   2560 2608 2640 2720   1440 1443 1448 1525   +hsync -vsync
      &#x27;&#x27;;
    })
  ];
  */
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-hardware-display-pg278q" class="title" style="clear: both">Complete example for Asus PG278Q   </h2>  </div> </div></div><p>And finally this is a complete working example for a 2014 (first) batch of <a class="link" href="https://gitlab.freedesktop.org/drm/amd/-/issues/615#note_1987392"  target="_top">Asus PG278Q monitor with <code class="literal">amdgpu</code> drivers</a>:</p><pre><code class="programlisting nix">{
  hardware.display.edid.modelines.&quot;PG278Q_60&quot; = &quot;   241.50   2560 2608 2640 2720   1440 1443 1448 1481   -hsync +vsync&quot;;
  hardware.display.edid.modelines.&quot;PG278Q_120&quot; = &quot;  497.75   2560 2608 2640 2720   1440 1443 1448 1525   +hsync -vsync&quot;;

  hardware.display.outputs.&quot;DP-1&quot;.edid = &quot;PG278Q_60.bin&quot;;
  hardware.display.outputs.&quot;DP-1&quot;.mode = &quot;e&quot;;
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-emacs" class="title" >Emacs   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-emacs-installing">Installing Emacs</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-emacs-running">Running Emacs as a Service</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-emacs-configuring">Configuring Emacs</a> </span></dt> </dl></div><p><a class="link" href="https://www.gnu.org/software/emacs/"  target="_top">Emacs</a> is an
extensible, customizable, self-documenting real-time display editor — and
more. At its core is an interpreter for Emacs Lisp, a dialect of the Lisp
programming language with extensions to support text editing.</p><p>Emacs runs within a graphical desktop environment using the X Window System,
but works equally well on a text terminal. Under
macOS, a “Mac port” edition is available, which
uses Apple’s native GUI frameworks.</p><p>Nixpkgs provides a superior environment for
running Emacs. It’s simple to create custom builds
by overriding the default packages. Chaotic collections of Emacs Lisp code
and extensions can be brought under control using declarative package
management. NixOS even provides a
<span class="command"><strong>systemd</strong></span> user service for automatically starting the Emacs
daemon.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-emacs-installing" class="title" style="clear: both">Installing Emacs   </h2>  </div> </div></div><p>Emacs can be installed in the normal way for Nix (see
<a class="xref" href="index.html#sec-package-management" title="Package Management" ><em>Package Management</em></a>). In addition, a NixOS
<span class="emphasis"><em>service</em></span> can be enabled.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-releases" class="title" >The Different Releases of Emacs   </h3>  </div> </div></div><p>Nixpkgs defines several basic Emacs packages.
The following are attributes belonging to the <code class="varname">pkgs</code> set:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="varname">emacs</code></span></dt><dd><p>The latest stable version of Emacs using the <a class="link" href="http://www.gtk.org"  target="_top">GTK 2</a>
widget toolkit.</p></dd><dt><span class="term"><code class="varname">emacs-nox</code></span></dt><dd><p>Emacs built without any dependency on X11 libraries.</p></dd><dt><span class="term"><code class="varname">emacsMacport</code></span></dt><dd><p>Emacs with the “Mac port” patches, providing a more native look and
feel under macOS.</p></dd></dl></div><p>If those aren’t suitable, then the following imitation Emacs editors are
also available in Nixpkgs:
<a class="link" href="https://www.gnu.org/software/zile/"  target="_top">Zile</a>,
<a class="link" href="http://homepage.boetes.org/software/mg/"  target="_top">mg</a>,
<a class="link" href="http://yi-editor.github.io/"  target="_top">Yi</a>,
<a class="link" href="https://joe-editor.sourceforge.io/"  target="_top">jmacs</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-adding-packages" class="title" >Adding Packages to Emacs   </h3>  </div> </div></div><p>Emacs includes an entire ecosystem of functionality beyond text editing,
including a project planner, mail and news reader, debugger interface,
calendar, and more.</p><p>Most extensions are gotten with the Emacs packaging system
(<code class="filename">package.el</code>) from
<a class="link" href="https://elpa.gnu.org/"  target="_top">Emacs Lisp Package Archive (ELPA)</a>,
<a class="link" href="https://melpa.org/"  target="_top">MELPA</a>,
<a class="link" href="https://stable.melpa.org/"  target="_top">MELPA Stable</a>, and
<a class="link" href="http://orgmode.org/elpa.html"  target="_top">Org ELPA</a>. Nixpkgs is
regularly updated to mirror all these archives.</p><p>Under NixOS, you can continue to use
<code class="literal">package-list-packages</code> and
<code class="literal">package-install</code> to install packages. You can also
declare the set of Emacs packages you need using the derivations from
Nixpkgs. The rest of this section discusses declarative installation of
Emacs packages through nixpkgs.</p><p>The first step to declare the list of packages you want in your Emacs
installation is to create a dedicated derivation. This can be done in a
dedicated <code class="filename">emacs.nix</code> file such as:</p><div class="example"><span id="ex-emacsNix" ></span><details><summary><span class="title"><strong>Example 7. Nix expression to build Emacs with packages (<code class="literal">emacs.nix</code>)</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">/*
This is a nix expression to build Emacs and some Emacs packages I like
from source on any distribution where Nix is installed. This will install
all the dependencies from the nixpkgs repository and build the binary files
without interfering with the host distribution.

To build the project, type the following from the current directory:

$ nix-build emacs.nix

To run the newly compiled executable:

$ ./result/bin/emacs
*/

# The first non-comment line in this file indicates that
# the whole file represents a function.
{ pkgs ? import &lt;nixpkgs&gt; {} }:

let
  # The let expression below defines a myEmacs binding pointing to the
  # current stable version of Emacs. This binding is here to separate
  # the choice of the Emacs binary from the specification of the
  # required packages.
  myEmacs = pkgs.emacs;
  # This generates an emacsWithPackages function. It takes a single
  # argument: a function from a package set to a list of packages
  # (the packages that will be available in Emacs).
  emacsWithPackages = (pkgs.emacsPackagesFor myEmacs).emacsWithPackages;
in
  # The rest of the file specifies the list of packages to install. In the
  # example, two packages (magit and zerodark-theme) are taken from
  # MELPA stable.
  emacsWithPackages (epkgs: (with epkgs.melpaStablePackages; [
    magit          # ; Integrate git &lt;C-x g&gt;
    zerodark-theme # ; Nicolas&#x27; theme
  ])
  # Two packages (undo-tree and zoom-frm) are taken from MELPA.
  ++ (with epkgs.melpaPackages; [
    undo-tree      # ; &lt;C-x u&gt; to show the undo tree
    zoom-frm       # ; increase/decrease font size for all buffers %lt;C-x C-+&gt;
  ])
  # Three packages are taken from GNU ELPA.
  ++ (with epkgs.elpaPackages; [
    auctex         # ; LaTeX mode
    beacon         # ; highlight my cursor when scrolling
    nameless       # ; hide current package name everywhere in elisp code
  ])
  # notmuch is taken from a nixpkgs derivation which contains an Emacs mode.
  ++ [
    pkgs.notmuch   # From main packages set
  ])
</code></pre></div></details></div><br class="example-break" /><p>The result of this configuration will be an <span class="command"><strong>emacs</strong></span>
command which launches Emacs with all of your chosen packages in the
<code class="varname">load-path</code>.</p><p>You can check that it works by executing this in a terminal:</p><pre><code class="programlisting ShellSession">$ nix-build emacs.nix
$ ./result/bin/emacs -q
</code></pre><p>and then typing <code class="literal">M-x package-initialize</code>. Check that you
can use all the packages you want in this Emacs instance. For example, try
switching to the zerodark theme through <code class="literal">M-x load-theme &lt;RET&gt; zerodark &lt;RET&gt; y</code>.</p><div class="tip"><h3 class="title">Tip</h3><p>A few popular extensions worth checking out are: auctex, company,
edit-server, flycheck, helm, iedit, magit, multiple-cursors, projectile,
and yasnippet.</p></div><p>The list of available packages in the various ELPA repositories can be seen
with the following commands:</p><div class="example"><span id="module-services-emacs-querying-packages" ></span><details><summary><span class="title"><strong>Example 8. Querying Emacs packages</strong></span></summary><div class="example-contents"><pre><code class="programlisting">nix-env -f &quot;&lt;nixpkgs&gt;&quot; -qaP -A emacs.pkgs.elpaPackages
nix-env -f &quot;&lt;nixpkgs&gt;&quot; -qaP -A emacs.pkgs.melpaPackages
nix-env -f &quot;&lt;nixpkgs&gt;&quot; -qaP -A emacs.pkgs.melpaStablePackages
nix-env -f &quot;&lt;nixpkgs&gt;&quot; -qaP -A emacs.pkgs.orgPackages
</code></pre></div></details></div><br class="example-break" /><p>If you are on NixOS, you can install this particular Emacs for all users by
putting the <code class="literal">emacs.nix</code> file in <code class="literal">/etc/nixos</code> and adding it to the list of
system packages (see <a class="xref" href="index.html#sec-declarative-package-mgmt" title="Declarative Package Management" >the section called “Declarative Package Management”</a>). Simply modify your
file <code class="filename">configuration.nix</code> to make it contain:</p><div class="example"><span id="module-services-emacs-configuration-nix" ></span><details><summary><span class="title"><strong>Example 9. Custom Emacs in <code class="literal">configuration.nix</code></strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
 environment.systemPackages = [
   # [...]
   (import ./emacs.nix { inherit pkgs; })
  ];
}
</code></pre></div></details></div><br class="example-break" /><p>In this case, the next <span class="command"><strong>nixos-rebuild switch</strong></span> will take
care of adding your <span class="command"><strong>emacs</strong></span> to the <code class="varname">PATH</code>
environment variable (see <a class="xref" href="index.html#sec-changing-config" title="Changing the Configuration" ><em>Changing the Configuration</em></a>).</p><p>If you are not on NixOS or want to install this particular Emacs only for
yourself, you can do so by putting <code class="literal">emacs.nix</code> in <code class="literal">~/.config/nixpkgs</code> and
adding it to your <code class="filename">~/.config/nixpkgs/config.nix</code> (see
<a class="link" href="https://nixos.org/nixpkgs/manual/#sec-modify-via-packageOverrides"  target="_top">Nixpkgs manual</a>):</p><div class="example"><span id="module-services-emacs-config-nix" ></span><details><summary><span class="title"><strong>Example 10. Custom Emacs in <code class="literal">~/.config/nixpkgs/config.nix</code></strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  packageOverrides = super: let self = super.pkgs; in {
    myemacs = import ./emacs.nix { pkgs = self; };
  };
}
</code></pre></div></details></div><br class="example-break" /><p>In this case, the next <code class="literal">nix-env -f &#x27;&lt;nixpkgs&gt;&#x27; -iA myemacs</code> will take care of adding your emacs to the
<code class="varname">PATH</code> environment variable.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-advanced" class="title" >Advanced Emacs Configuration   </h3>  </div> </div></div><p>If you want, you can tweak the Emacs package itself from your
<code class="filename">emacs.nix</code>. For example, if you want to have a
GTK 3-based Emacs instead of the default GTK 2-based binary and remove the
automatically generated <code class="filename">emacs.desktop</code> (useful if you
only use <span class="command"><strong>emacsclient</strong></span>), you can change your file
<code class="filename">emacs.nix</code> in this way:</p><div class="example"><span id="ex-emacsGtk3Nix" ></span><details><summary><span class="title"><strong>Example 11. Custom Emacs build</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  myEmacs = (pkgs.emacs.override {
    # Use gtk3 instead of the default gtk2
    withGTK3 = true;
    withGTK2 = false;
  }).overrideAttrs (attrs: {
    # I don&#x27;t want emacs.desktop file because I only use
    # emacsclient.
    postInstall = (attrs.postInstall or &quot;&quot;) + &#x27;&#x27;
      rm $out/share/applications/emacs.desktop
    &#x27;&#x27;;
  });
in [ /* ... */ ]
</code></pre></div></details></div><br class="example-break" /><p>After building this file as shown in <a class="xref" href="index.html#ex-emacsNix" title="Example 7. Nix expression to build Emacs with packages (emacs.nix)" >Example 7</a>, you
will get an GTK 3-based Emacs binary pre-loaded with your favorite packages.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-emacs-running" class="title" style="clear: both">Running Emacs as a Service   </h2>  </div> </div></div><p>NixOS provides an optional
<span class="command"><strong>systemd</strong></span> service which launches
<a class="link" href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html"  target="_top">Emacs daemon</a>
with the user’s login session.</p><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/editors/emacs.nix</code></p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-enabling" class="title" >Enabling the Service   </h3>  </div> </div></div><p>To install and enable the <span class="command"><strong>systemd</strong></span> user service for Emacs
daemon, add the following to your <code class="filename">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  services.emacs.enable = true;
}
</code></pre><p>The <code class="varname">services.emacs.package</code> option allows a custom
derivation to be used, for example, one created by
<code class="literal">emacsWithPackages</code>.</p><p>Ensure that the Emacs server is enabled for your user’s Emacs
configuration, either by customizing the <code class="varname">server-mode</code>
variable, or by adding <code class="literal">(server-start)</code> to
<code class="filename">~/.emacs.d/init.el</code>.</p><p>To start the daemon, execute the following:</p><pre><code class="programlisting ShellSession">$ nixos-rebuild switch  # to activate the new configuration.nix
$ systemctl --user daemon-reload        # to force systemd reload
$ systemctl --user start emacs.service  # to start the Emacs daemon
</code></pre><p>The server should now be ready to serve Emacs clients.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-starting-client" class="title" >Starting the client   </h3>  </div> </div></div><p>Ensure that the Emacs server is enabled, either by customizing the
<code class="varname">server-mode</code> variable, or by adding
<code class="literal">(server-start)</code> to <code class="filename">~/.emacs</code>.</p><p>To connect to the Emacs daemon, run one of the following:</p><pre><code class="programlisting">emacsclient FILENAME
emacsclient --create-frame  # opens a new frame (window)
emacsclient --create-frame --tty  # opens a new frame on the current terminal
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-editor-variable" class="title" >Configuring the <code class="varname">EDITOR</code> variable   </h3>  </div> </div></div><p>If <a class="xref" href="options.html#opt-services.emacs.defaultEditor"  ><code class="option">services.emacs.defaultEditor</code></a> is
<code class="literal">true</code>, the <code class="varname">EDITOR</code> variable will be set
to a wrapper script which launches <span class="command"><strong>emacsclient</strong></span>.</p><p>Any setting of <code class="varname">EDITOR</code> in the shell config files will
override <code class="varname">services.emacs.defaultEditor</code>. To make sure
<code class="varname">EDITOR</code> refers to the Emacs wrapper script, remove any
existing <code class="varname">EDITOR</code> assignment from
<code class="filename">.profile</code>, <code class="filename">.bashrc</code>,
<code class="filename">.zshenv</code> or any other shell config file.</p><p>If you have formed certain bad habits when editing files, these can be
corrected with a shell alias to the wrapper script:</p><pre><code class="programlisting">alias vi=$EDITOR
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-per-user" class="title" >Per-User Enabling of the Service   </h3>  </div> </div></div><p>In general, <span class="command"><strong>systemd</strong></span> user services are globally enabled
by symlinks in <code class="filename">/etc/systemd/user</code>. In the case where
Emacs daemon is not wanted for all users, it is possible to install the
service but not globally enable it:</p><pre><code class="programlisting nix">{
  services.emacs.enable = false;
  services.emacs.install = true;
}
</code></pre><p>To enable the <span class="command"><strong>systemd</strong></span> user service for just the
currently logged in user, run:</p><pre><code class="programlisting">systemctl --user enable emacs
</code></pre><p>This will add the symlink
<code class="filename">~/.config/systemd/user/emacs.service</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-emacs-configuring" class="title" style="clear: both">Configuring Emacs   </h2>  </div> </div></div><p>If you want to only use extension packages from Nixpkgs, you can add
<code class="literal">(setq package-archives nil)</code> to your init file.</p><p>After the declarative Emacs package configuration has been tested,
previously downloaded packages can be cleaned up by removing
<code class="filename">~/.emacs.d/elpa</code> (do make a backup first, in case you
forgot a package).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-major-mode" class="title" >A Major Mode for Nix Expressions   </h3>  </div> </div></div><p>Of interest may be <code class="varname">melpaPackages.nix-mode</code>, which
provides syntax highlighting for the Nix language. This is particularly
convenient if you regularly edit Nix files.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-man-pages" class="title" >Accessing man pages   </h3>  </div> </div></div><p>You can use <code class="literal">woman</code> to get completion of all available
man pages. For example, type <code class="literal">M-x woman &lt;RET&gt; nixos-rebuild &lt;RET&gt;.</code></p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-livebook" class="title" >Livebook   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-livebook-basic-usage">Basic Usage</a> </span></dt> </dl></div><p><a class="link" href="https://livebook.dev/"  target="_top">Livebook</a> is a web application for writing
interactive and collaborative code notebooks.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-livebook-basic-usage" class="title" style="clear: both">Basic Usage   </h2>  </div> </div></div><p>Enabling the <code class="literal">livebook</code> service creates a user
<a class="link" href="https://www.freedesktop.org/wiki/Software/systemd/"  target="_top"><code class="literal">systemd</code></a> unit
which runs the server.</p><pre><code class="programlisting nix">{ ... }:

{
  services.livebook = {
    enableUserService = true;
    environment = {
      LIVEBOOK_PORT = 20123;
      LIVEBOOK_PASSWORD = &quot;mypassword&quot;;
    };
    # See note below about security
    environmentFile = &quot;/var/lib/livebook.env&quot;;
  };
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>The Livebook server has the ability to run any command as the user it
is running under, so securing access to it with a password is highly
recommended.</p><p>Putting the password in the Nix configuration like above is an easy way to get
started but it is not recommended in the real world because the resulting
environment variables can be read by unprivileged users.  A better approach
would be to put the password in some secure user-readable location and set
<code class="literal">environmentFile = /home/user/secure/livebook.env</code>.</p></div><p>The <a class="link" href="https://hexdocs.pm/livebook/readme.html#environment-variables"  target="_top">Livebook
documentation</a>
lists all the applicable environment variables. It is recommended to at least
set <code class="literal">LIVEBOOK_PASSWORD</code> or <code class="literal">LIVEBOOK_TOKEN_ENABLED=false</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-livebook-extra-dependencies" class="title" >Extra dependencies   </h3>  </div> </div></div><p>By default, the Livebook service is run with minimum dependencies, but
some features require additional packages.  For example, the machine
learning Kinos require <code class="literal">gcc</code> and <code class="literal">gnumake</code>.  To add these, use
<code class="literal">extraPackages</code>:</p><pre><code class="programlisting nix">{
  services.livebook.extraPackages = with pkgs; [ gcc gnumake ];
}
</code></pre>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-blackfire" class="title" >Blackfire profiler   </h2>  </div> </div></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/development/blackfire.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://blackfire.io/docs/introduction"  target="_top">https://blackfire.io/docs/introduction</a></p><p><a class="link" href="https://blackfire.io"  target="_top">Blackfire</a> is a proprietary tool for profiling applications. There are several languages supported by the product but currently only PHP support is packaged in Nixpkgs. The back-end consists of a module that is loaded into the language runtime (called <span class="emphasis"><em>probe</em></span>) and a service (<span class="emphasis"><em>agent</em></span>) that the probe connects to and that sends the profiles to the server.</p><p>To use it, you will need to enable the agent and the probe on your server. The exact method will depend on the way you use PHP but here is an example of NixOS configuration for PHP-FPM:</p><pre><code class="programlisting nix">let
  php = pkgs.php.withExtensions ({ enabled, all }: enabled ++ (with all; [
    blackfire
  ]));
in {
  # Enable the probe extension for PHP-FPM.
  services.phpfpm = {
    phpPackage = php;
  };

  # Enable and configure the agent.
  services.blackfire-agent = {
    enable = true;
    settings = {
      # You will need to get credentials at https://blackfire.io/my/settings/credentials
      # You can also use other options described in https://blackfire.io/docs/up-and-running/configuration/agent
      server-id = &quot;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&quot;;
      server-token = &quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;;
    };
  };

  # Make the agent run on start-up.
  # (WantedBy= from the upstream unit not respected: https://github.com/NixOS/nixpkgs/issues/81138)
  # Alternately, you can start it manually with `systemctl start blackfire-agent`.
  systemd.services.blackfire-agent.wantedBy = [ &quot;phpfpm-foo.service&quot; ];
}
</code></pre><p>On your developer machine, you will also want to install <a class="link" href="https://blackfire.io/docs/up-and-running/installation#install-a-profiling-client"  target="_top">the client</a> (see <code class="literal">blackfire</code> package) or the browser extension to actually trigger the profiling.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-athens" class="title" >Athens   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-development-athens-configuring">Configuring</a> </span></dt><dt> <span class="section">  <a href="index.html#opt-services-development-athens-caching-proxy">Basic usage for a caching proxy configuration</a> </span></dt> </dl></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/development/athens.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://docs.gomods.io/"  target="_top">https://docs.gomods.io/</a></p><p><a class="link" href="https://github.com/gomods/athens"  target="_top">Athens</a>
is a Go module datastore and proxy</p><p>The main goal of Athens is providing a Go proxy (<code class="literal">$GOPROXY</code>) in regions without access to <code class="literal">https://proxy.golang.org</code> or to
improve the speed of Go module downloads for CI/CD systems.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-development-athens-configuring" class="title" style="clear: both">Configuring   </h2>  </div> </div></div><p>A complete list of options for the Athens module may be found
<a class="link" href="options.html#opt-services.athens.enable"  >here</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="opt-services-development-athens-caching-proxy" class="title" style="clear: both">Basic usage for a caching proxy configuration   </h2>  </div> </div></div><p>A very basic configuration for Athens that acts as a caching and forwarding HTTP proxy is:</p><pre><code class="programlisting nix">{
    services.athens = {
      enable = true;
    };
}
</code></pre><p>If you want to prevent Athens from writing to disk, you can instead configure it to cache modules only in memory:</p><pre><code class="programlisting nix">{
    services.athens = {
      enable = true;
      storageType = &quot;memory&quot;;
    };
}
</code></pre><p>To use the local proxy in Go builds (outside of <code class="literal">nix</code>), you can set the proxy as environment variable:</p><pre><code class="programlisting nix">{
  environment.variables = {
    GOPROXY = &quot;http://localhost:3000&quot;;
  };
}
</code></pre><p>To also use the local proxy for Go builds happening in <code class="literal">nix</code> (with <code class="literal">buildGoModule</code>), the nix daemon can be configured to pass the GOPROXY environment variable to the <code class="literal">goModules</code> fixed-output derivation.</p><p>This can either be done via the nix-daemon systemd unit:</p><pre><code class="programlisting nix">{
  systemd.services.nix-daemon.environment.GOPROXY = &quot;http://localhost:3000&quot;;
}
</code></pre><p>or via the <a class="link" href="https://nix.dev/manual/nix/2.24/command-ref/conf-file#conf-impure-env"  target="_top">impure-env experimental feature</a>:</p><pre><code class="programlisting nix">{
  nix.settings.experimental-features = [ &quot;configurable-impure-env&quot; ];
  nix.settings.impure-env = &quot;GOPROXY=http://localhost:3000&quot;;
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-flatpak" class="title" >Flatpak   </h2>  </div> </div></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/desktop/flatpak.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://github.com/flatpak/flatpak/wiki"  target="_top">https://github.com/flatpak/flatpak/wiki</a></p><p>Flatpak is a system for building, distributing, and running sandboxed desktop
applications on Linux.</p><p>To enable Flatpak, add the following to your <code class="filename">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  services.flatpak.enable = true;
}
</code></pre><p>For the sandboxed apps to work correctly, desktop integration portals need to
be installed. If you run GNOME, this will be handled automatically for you;
in other cases, you will need to add something like the following to your
<code class="filename">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  xdg.portal.extraPortals = [ pkgs.xdg-desktop-portal-gtk ];
  xdg.portal.config.common.default = &quot;gtk&quot;;
}
</code></pre><p>Then, you will need to add a repository, for example,
<a class="link" href="https://github.com/flatpak/flatpak/wiki"  target="_top">Flathub</a>,
either using the following commands:</p><pre><code class="programlisting ShellSession">$ flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
$ flatpak update
</code></pre><p>or by opening the
<a class="link" href="https://flathub.org/repo/flathub.flatpakrepo"  target="_top">repository file</a> in GNOME Software.</p><p>Finally, you can search and install programs:</p><pre><code class="programlisting ShellSession">$ flatpak search bustle
$ flatpak install flathub org.freedesktop.Bustle
$ flatpak run org.freedesktop.Bustle
</code></pre><p>Again, GNOME Software offers graphical interface for these tasks.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-tigerbeetle" class="title" >TigerBeetle   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-tigerbeetle-configuring">Configuring</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-tigerbeetle-upgrading">Upgrading</a> </span></dt> </dl></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/databases/tigerbeetle.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://docs.tigerbeetle.com/"  target="_top">https://docs.tigerbeetle.com/</a></p><p>TigerBeetle is a distributed financial accounting database designed for mission critical safety and performance.</p><p>To enable TigerBeetle, add the following to your <code class="filename">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  services.tigerbeetle.enable = true;
}
</code></pre><p>When first started, the TigerBeetle service will create its data file at <code class="filename">/var/lib/tigerbeetle</code> unless the file already exists, in which case it will just use the existing file.
If you make changes to the configuration of TigerBeetle after its data file was already created (for example increasing the replica count), you may need to remove the existing file to avoid conflicts.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-tigerbeetle-configuring" class="title" style="clear: both">Configuring   </h2>  </div> </div></div><p>By default, TigerBeetle will only listen on a local interface.
To configure it to listen on a different interface (and to configure it to connect to other replicas, if you’re creating more than one), you’ll have to set the <code class="literal">addresses</code> option.
Note that the TigerBeetle module won’t open any firewall ports automatically, so if you configure it to listen on an external interface, you’ll need to ensure that connections can reach it:</p><pre><code class="programlisting nix">{
  services.tigerbeetle = {
    enable = true;
    addresses = [ &quot;0.0.0.0:3001&quot; ];
  };

  networking.firewall.allowedTCPPorts = [ 3001 ];
}
</code></pre><p>A complete list of options for TigerBeetle can be found <a class="link" href="options.html#opt-services.tigerbeetle.enable"  >here</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-tigerbeetle-upgrading" class="title" style="clear: both">Upgrading   </h2>  </div> </div></div><p>Usually, TigerBeetle’s <a class="link" href="https://docs.tigerbeetle.com/operating/upgrading"  target="_top">upgrade process</a> only requires replacing the binary used for the servers.
This is not directly possible with NixOS since the new binary will be located at a different place in the Nix store.</p><p>However, since TigerBeetle is managed through systemd on NixOS, the only action you need to take when upgrading is to make sure the version of TigerBeetle you’re upgrading to supports upgrades from the version you’re currently running.
This information will be on the <a class="link" href="https://github.com/tigerbeetle/tigerbeetle/releases"  target="_top">release notes</a> for the version you’re upgrading to.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-postgresql" class="title" >PostgreSQL   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-postgres-configuring">Configuring</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-postgres-initializing">Initializing</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-postgres-authentication">Authentication</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-postgres-upgrading">Upgrading</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-postgres-versioning">Versioning and End-of-Life</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-postgres-pg_config"><code class="literal">pg_config</code></a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-postgres-options">Options</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-postgres-plugins">Plugins</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-postgres-pls">Procedural Languages</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-postgres-jit">JIT (Just-In-Time compilation)</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-postgres-hardening">Service hardening</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-postgres-upstream-deviation">Notable differences to upstream</a> </span></dt> </dl></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/databases/postgresql.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://www.postgresql.org/docs/"  target="_top">https://www.postgresql.org/docs/</a></p><p>PostgreSQL is an advanced, free, relational database.
</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-configuring" class="title" style="clear: both">Configuring   </h2>  </div> </div></div><p>To enable PostgreSQL, add the following to your <code class="filename">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  services.postgresql.enable = true;
  services.postgresql.package = pkgs.postgresql_15;
}
</code></pre><p>The default PostgreSQL version is approximately the latest major version available on the NixOS release matching your <a class="link" href="options.html#opt-system.stateVersion"  ><code class="literal">system.stateVersion</code></a>.
This is because PostgreSQL upgrades require a manual migration process (see below).
Hence, upgrades must happen by setting <a class="link" href="options.html#opt-services.postgresql.package"  ><code class="literal">services.postgresql.package</code></a> explicitly.</p><p>By default, PostgreSQL stores its databases in <code class="filename">/var/lib/postgresql/$psqlSchema</code>. You can override this using <a class="xref" href="options.html#opt-services.postgresql.dataDir"  ><code class="option">services.postgresql.dataDir</code></a>, e.g.</p><pre><code class="programlisting nix">{
  services.postgresql.dataDir = &quot;/data/postgresql&quot;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-initializing" class="title" style="clear: both">Initializing   </h2>  </div> </div></div><p>As of NixOS 24.05,
<code class="literal">services.postgresql.ensureUsers.*.ensurePermissions</code> has been
removed, after a change to default permissions in PostgreSQL 15
invalidated most of its previous use cases:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>In psql &lt; 15, <code class="literal">ALL PRIVILEGES</code> used to include <code class="literal">CREATE TABLE</code>, where
in psql &gt;= 15 that would be a separate permission</p></li><li class="listitem"><p>psql &gt;= 15 instead gives only the database owner create permissions</p></li><li class="listitem"><p>Even on psql &lt; 15 (or databases migrated to &gt;= 15), it is
recommended to manually assign permissions along these lines</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>https://www.postgresql.org/docs/release/15.0/</p></li><li class="listitem"><p>https://www.postgresql.org/docs/15/ddl-schemas.html#DDL-SCHEMAS-PRIV</p></li></ul></div></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-postgres-initializing-ownership" class="title" >Assigning ownership   </h3>  </div> </div></div><p>Usually, the database owner should be a database user of the same
name. This can be done with
<code class="literal">services.postgresql.ensureUsers.*.ensureDBOwnership = true;</code>.</p><p>If the database user name equals the connecting system user name,
postgres by default will accept a passwordless connection via unix
domain socket. This makes it possible to run many postgres-backed
services without creating any database secrets at all.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-postgres-initializing-extra-permissions" class="title" >Assigning extra permissions   </h3>  </div> </div></div><p>For many cases, it will be enough to have the database user be the
owner. Until <code class="literal">services.postgresql.ensureUsers.*.ensurePermissions</code> has
been re-thought, if more users need access to the database, please use
one of the following approaches:</p><p><span class="strong"><strong>WARNING:</strong></span> <code class="literal">services.postgresql.initialScript</code> is not recommended
for <code class="literal">ensurePermissions</code> replacement, as that is <span class="emphasis"><em>only run on first
start of PostgreSQL</em></span>.</p><p><span class="strong"><strong>NOTE:</strong></span> all of these methods may be obsoleted, when <code class="literal">ensure*</code> is
reworked, but it is expected that they will stay viable for running
database migrations.</p><p><span class="strong"><strong>NOTE:</strong></span> please make sure that any added migrations are idempotent (re-runnable).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-services-postgres-initializing-extra-permissions-superuser" class="title" >as superuser   </h4>  </div> </div></div><p><span class="strong"><strong>Advantage:</strong></span> compatible with postgres &lt; 15, because it’s run
as the database superuser <code class="literal">postgres</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="module-services-postgres-initializing-extra-permissions-superuser-post-start" class="title" >in database <code class="literal">postStart</code>   </h5>  </div> </div></div><p><span class="strong"><strong>Disadvantage:</strong></span> need to take care of ordering yourself. In this
example, <code class="literal">mkAfter</code> ensures that permissions are assigned after any
databases from <code class="literal">ensureDatabases</code> and <code class="literal">extraUser1</code> from <code class="literal">ensureUsers</code>
are already created.</p><pre><code class="programlisting nix">  {
    systemd.services.postgresql.postStart = lib.mkAfter &#x27;&#x27;
      $PSQL service1 -c &#x27;GRANT SELECT ON ALL TABLES IN SCHEMA public TO &quot;extraUser1&quot;&#x27;
      $PSQL service1 -c &#x27;GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO &quot;extraUser1&quot;&#x27;
      # ....
    &#x27;&#x27;;
  }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="module-services-postgres-initializing-extra-permissions-superuser-oneshot" class="title" >in intermediate oneshot service   </h5>  </div> </div></div><pre><code class="programlisting nix">  {
    systemd.services.&quot;migrate-service1-db1&quot; = {
      serviceConfig.Type = &quot;oneshot&quot;;
      requiredBy = &quot;service1.service&quot;;
      before = &quot;service1.service&quot;;
      after = &quot;postgresql.service&quot;;
      serviceConfig.User = &quot;postgres&quot;;
      environment.PSQL = &quot;psql --port=${toString services.postgresql.settings.port}&quot;;
      path = [ postgresql ];
      script = &#x27;&#x27;
        $PSQL service1 -c &#x27;GRANT SELECT ON ALL TABLES IN SCHEMA public TO &quot;extraUser1&quot;&#x27;
        $PSQL service1 -c &#x27;GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO &quot;extraUser1&quot;&#x27;
        # ....
      &#x27;&#x27;;
    };
  }
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-services-postgres-initializing-extra-permissions-service-user" class="title" >as service user   </h4>  </div> </div></div><p><span class="strong"><strong>Advantage:</strong></span> re-uses systemd’s dependency ordering;</p><p><span class="strong"><strong>Disadvantage:</strong></span> relies on service user having grant permission. To be combined with <code class="literal">ensureDBOwnership</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="module-services-postgres-initializing-extra-permissions-service-user-pre-start" class="title" >in service <code class="literal">preStart</code>   </h5>  </div> </div></div><pre><code class="programlisting nix">  {
    environment.PSQL = &quot;psql --port=${toString services.postgresql.settings.port}&quot;;
    path = [ postgresql ];
    systemd.services.&quot;service1&quot;.preStart = &#x27;&#x27;
      $PSQL -c &#x27;GRANT SELECT ON ALL TABLES IN SCHEMA public TO &quot;extraUser1&quot;&#x27;
      $PSQL -c &#x27;GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO &quot;extraUser1&quot;&#x27;
      # ....
    &#x27;&#x27;;
  }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="module-services-postgres-initializing-extra-permissions-service-user-oneshot" class="title" >in intermediate oneshot service   </h5>  </div> </div></div><pre><code class="programlisting nix">  {
    systemd.services.&quot;migrate-service1-db1&quot; = {
      serviceConfig.Type = &quot;oneshot&quot;;
      requiredBy = &quot;service1.service&quot;;
      before = &quot;service1.service&quot;;
      after = &quot;postgresql.service&quot;;
      serviceConfig.User = &quot;service1&quot;;
      environment.PSQL = &quot;psql --port=${toString services.postgresql.settings.port}&quot;;
      path = [ postgresql ];
      script = &#x27;&#x27;
        $PSQL -c &#x27;GRANT SELECT ON ALL TABLES IN SCHEMA public TO &quot;extraUser1&quot;&#x27;
        $PSQL -c &#x27;GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO &quot;extraUser1&quot;&#x27;
        # ....
      &#x27;&#x27;;
    };
  }
</code></pre>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-authentication" class="title" style="clear: both">Authentication   </h2>  </div> </div></div><p>Local connections are made through unix sockets by default and support <a class="link" href="https://www.postgresql.org/docs/current/auth-peer.html"  target="_top">peer authentication</a>.
This allows system users to login with database roles of the same name.
For example, the <code class="literal">postgres</code> system user is allowed to login with the database role <code class="literal">postgres</code>.</p><p>System users and database roles might not always match.
In this case, to allow access for a service, you can create a <a class="link" href="https://www.postgresql.org/docs/current/auth-username-maps.html"  target="_top">user name map</a> between system roles and an existing database role.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-postgres-authentication-user-mapping" class="title" >User Mapping   </h3>  </div> </div></div><p>Assume that your app creates a role <code class="literal">admin</code> and you want the <code class="literal">root</code> user to be able to login with it.
You can then use <a class="xref" href="options.html#opt-services.postgresql.identMap"  ><code class="option">services.postgresql.identMap</code></a> to define the map and <a class="xref" href="options.html#opt-services.postgresql.authentication"  ><code class="option">services.postgresql.authentication</code></a> to enable it:</p><pre><code class="programlisting nix">services.postgresql = {
  identMap = &#x27;&#x27;
    admin root admin
  &#x27;&#x27;;
  authentication = &#x27;&#x27;
    local all admin peer map=admin
  &#x27;&#x27;;
}
</code></pre><div class="warning"><h3 class="title">Warning</h3><p>To avoid conflicts with other modules, you should never apply a map to <code class="literal">all</code> roles.
Because PostgreSQL will stop on the first matching line in <code class="literal">pg_hba.conf</code>, a line matching all roles would lock out other services.
Each module should only manage user maps for the database roles that belong to this module.
Best practice is to name the map after the database role it manages to avoid name conflicts.</p></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-upgrading" class="title" style="clear: both">Upgrading   </h2>  </div> </div></div><div class="note"><h3 class="title">Note</h3><p>The steps below demonstrate how to upgrade from an older version to <code class="literal">pkgs.postgresql_13</code>.
These instructions are also applicable to other versions.</p></div><p>Major PostgreSQL upgrades require a downtime and a few imperative steps to be called. This is the case because
each major version has some internal changes in the databases’ state. Because of that,
NixOS places the state into <code class="filename">/var/lib/postgresql/&amp;lt;version&amp;gt;</code> where each <code class="literal">version</code>
can be obtained like this:</p><pre><code class="programlisting">$ nix-instantiate --eval -A postgresql_13.psqlSchema
&quot;13&quot;
</code></pre><p>For an upgrade, a script like this can be used to simplify the process:</p><pre><code class="programlisting nix">{ config, lib, pkgs, ... }:
{
  environment.systemPackages = [
    (let
      # XXX specify the postgresql package you&#x27;d like to upgrade to.
      # Do not forget to list the extensions you need.
      newPostgres = pkgs.postgresql_13.withPackages (pp: [
        # pp.plv8
      ]);
      cfg = config.services.postgresql;
    in pkgs.writeScriptBin &quot;upgrade-pg-cluster&quot; &#x27;&#x27;
      set -eux
      # XXX it&#x27;s perhaps advisable to stop all services that depend on postgresql
      systemctl stop postgresql

      export NEWDATA=&quot;/var/lib/postgresql/${newPostgres.psqlSchema}&quot;
      export NEWBIN=&quot;${newPostgres}/bin&quot;

      export OLDDATA=&quot;${cfg.dataDir}&quot;
      export OLDBIN=&quot;${cfg.finalPackage}/bin&quot;

      install -d -m 0700 -o postgres -g postgres &quot;$NEWDATA&quot;
      cd &quot;$NEWDATA&quot;
      sudo -u postgres &quot;$NEWBIN/initdb&quot; -D &quot;$NEWDATA&quot; ${lib.escapeShellArgs cfg.initdbArgs}

      sudo -u postgres &quot;$NEWBIN/pg_upgrade&quot; \
        --old-datadir &quot;$OLDDATA&quot; --new-datadir &quot;$NEWDATA&quot; \
        --old-bindir &quot;$OLDBIN&quot; --new-bindir &quot;$NEWBIN&quot; \
        &quot;$@&quot;
    &#x27;&#x27;)
  ];
}
</code></pre><p>The upgrade process is:</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Add the above to your <code class="filename">configuration.nix</code> and rebuild. Alternatively, add that into a separate file and reference it in the <code class="literal">imports</code> list.</p></li><li class="listitem"><p>Login as root (<code class="literal">sudo su -</code>).</p></li><li class="listitem"><p>Run <code class="literal">upgrade-pg-cluster</code>. This will stop the old postgresql cluster, initialize a new one and migrate the old one to the new one. You may supply arguments like <code class="literal">--jobs 4</code> and <code class="literal">--link</code> to speedup the migration process. See <a class="link" href="https://www.postgresql.org/docs/current/pgupgrade.html"  target="_top">https://www.postgresql.org/docs/current/pgupgrade.html</a> for details.</p></li><li class="listitem"><p>Change the postgresql package in NixOS configuration to the one you were upgrading to via <a class="xref" href="options.html#opt-services.postgresql.package"  ><code class="option">services.postgresql.package</code></a>. Rebuild NixOS. This should start the new postgres version using the upgraded data directory and all services you stopped during the upgrade.</p></li><li class="listitem"><p>After the upgrade it’s advisable to analyze the new cluster:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>For PostgreSQL ≥ 14, use the <code class="literal">vacuumdb</code> command printed by the upgrades script.</p></li><li class="listitem"><p>For PostgreSQL &lt; 14, run (as <code class="literal">su -l postgres</code> in the <a class="xref" href="options.html#opt-services.postgresql.dataDir"  ><code class="option">services.postgresql.dataDir</code></a>, in this example <code class="filename">/var/lib/postgresql/13</code>):</p><pre><code class="programlisting">$ ./analyze_new_cluster.sh
</code></pre></li></ul></div><div class="warning"><h3 class="title">Warning</h3><p>The next step removes the old state-directory!</p></div><pre><code class="programlisting">$ ./delete_old_cluster.sh
</code></pre></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-versioning" class="title" style="clear: both">Versioning and End-of-Life   </h2>  </div> </div></div><p>PostgreSQL’s versioning policy is described <a class="link" href="https://www.postgresql.org/support/versioning/"  target="_top">here</a>. TLDR:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Each major version is supported for 5 years.</p></li><li class="listitem"><p>Every three months there will be a new minor release, containing bug and security fixes.</p></li><li class="listitem"><p>For criticial/security fixes there could be more minor releases inbetween. This happens <span class="emphasis"><em>very</em></span> infrequently.</p></li><li class="listitem"><p>After five years, a final minor version is released. This usually happens in early November.</p></li><li class="listitem"><p>After that a version is considered end-of-life (EOL).</p></li><li class="listitem"><p>Around February each year is the first time an EOL-release will not have received regular updates anymore.</p></li></ul></div><p>Technically, we’d not want to have EOL’ed packages in a stable NixOS release, which is to be supported until one month after the previous release. Thus, with NixOS’ release schedule in May and November, the oldest PostgreSQL version in nixpkgs would have to be supported until December. It could be argued that a soon-to-be-EOL-ed version should thus be removed in May for the .05 release already. But since new security vulnerabilities are first disclosed in February of the following year, we agreed on keeping the oldest PostgreSQL major version around one more cycle in <a class="link" href="https://github.com/NixOS/nixpkgs/pull/310580#discussion_r1597284693"  target="_top">#310580</a>.</p><p>Thus:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>In September/October the new major version will be released and added to nixos-unstable.</p></li><li class="listitem"><p>In November the last minor version for the oldest major will be released.</p></li><li class="listitem"><p>Both the current stable .05 release and nixos-unstable should be updated to the latest minor that will usually be released in November.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>This is relevant for people who need to use this major for as long as possible. In that case its desirable to be able to pin nixpkgs to a commit that still has it, at the latest minor available.</p></li></ul></div></li><li class="listitem"><p>In November, before branch-off for the .11 release and after the update to the latest minor, the EOL-ed major will be removed from nixos-unstable.</p></li></ul></div><p>This leaves a small gap of a couple of weeks after the latest minor release and the end of our support window for the .05 release, in which there could be an emergency release to other major versions of PostgreSQL - but not the oldest major we have in that branch. In that case: If we can’t trivially patch the issue, we will mark the package/version as insecure <span class="strong"><strong>immediately</strong></span>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-pg_config" class="title" style="clear: both"><code class="literal">pg_config</code>   </h2>  </div> </div></div><p><code class="literal">pg_config</code> is not part of the <code class="literal">postgresql</code>-package itself.
It is available under <code class="literal">postgresql_&lt;major&gt;.pg_config</code> and <code class="literal">libpq.pg_config</code>.
Use the <code class="literal">pg_config</code> from the postgresql package you’re using in your build.</p><p>Also, <code class="literal">pg_config</code> is a shell-script that replicates the behavior of the upstream <code class="literal">pg_config</code> and ensures at build-time that the output doesn’t change.</p><p>This approach is done for the following reasons:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>By using a shell script, cross compilation of extensions is made easier.</p></li><li class="listitem"><p>The separation allowed a massive reduction of the runtime closure’s size.
Any attempts to move <code class="literal">pg_config</code> into <code class="literal">$dev</code> resulted in brittle and more complex solutions
(see commits <a class="link" href="https://github.com/NixOS/nixpkgs/commit/0c477676412564bd2d5dadc37cf245fe4259f4d9"  target="_top"><code class="literal">0c47767</code></a>, <a class="link" href="https://github.com/NixOS/nixpkgs/commit/435f51c37faf74375134dfbd7c5a4560da2a9ea7"  target="_top"><code class="literal">435f51c</code></a>).</p></li><li class="listitem"><p><code class="literal">pg_config</code> is only needed to build extensions or in some exceptions for building client libraries linking to <code class="literal">libpq.so</code>.
If such a build works without <code class="literal">pg_config</code>, this is strictly preferable over adding <code class="literal">pg_config</code> to the build environment.</p><p>With the current approach it’s now explicit that this is needed.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-options" class="title" style="clear: both">Options   </h2>  </div> </div></div><p>A complete list of options for the PostgreSQL module may be found <a class="link" href="options.html#opt-services.postgresql.enable"  >here</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-plugins" class="title" style="clear: both">Plugins   </h2>  </div> </div></div><p>The collection of plugins for each PostgreSQL version can be accessed with <code class="literal">.pkgs</code>. For example, for the <code class="literal">pkgs.postgresql_15</code> package, its plugin collection is accessed by <code class="literal">pkgs.postgresql_15.pkgs</code>:</p><pre><code class="programlisting ShellSession">$ nix repl &#x27;&lt;nixpkgs&gt;&#x27;

Loading &#x27;&lt;nixpkgs&gt;&#x27;...
Added 10574 variables.

nix-repl&gt; postgresql_15.pkgs.&lt;TAB&gt;&lt;TAB&gt;
postgresql_15.pkgs.cstore_fdw        postgresql_15.pkgs.pg_repack
postgresql_15.pkgs.pg_auto_failover  postgresql_15.pkgs.pg_safeupdate
postgresql_15.pkgs.pg_bigm           postgresql_15.pkgs.pg_similarity
postgresql_15.pkgs.pg_cron           postgresql_15.pkgs.pg_topn
postgresql_15.pkgs.pg_hll            postgresql_15.pkgs.pgjwt
postgresql_15.pkgs.pg_partman        postgresql_15.pkgs.pgroonga
...
</code></pre><p>To add plugins via NixOS configuration, set <code class="literal">services.postgresql.extensions</code>:</p><pre><code class="programlisting nix">{
  services.postgresql.package = pkgs.postgresql_17;
  services.postgresql.extensions = ps: with ps; [
    pg_repack
    postgis
  ];
}
</code></pre><p>You can build a custom <code class="literal">postgresql-with-plugins</code> (to be used outside of NixOS) using the function <code class="literal">.withPackages</code>. For example, creating a custom PostgreSQL package in an overlay can look like this:</p><pre><code class="programlisting nix">self: super: {
  postgresql_custom = self.postgresql_17.withPackages (ps: [
    ps.pg_repack
    ps.postgis
  ]);
}
</code></pre><p>Here’s a recipe on how to override a particular plugin through an overlay:</p><pre><code class="programlisting nix">self: super: {
  postgresql_15 = super.postgresql_15// {
    pkgs = super.postgresql_15.pkgs // {
      pg_repack = super.postgresql_15.pkgs.pg_repack.overrideAttrs (_: {
        name = &quot;pg_repack-v20181024&quot;;
        src = self.fetchzip {
          url = &quot;https://github.com/reorg/pg_repack/archive/923fa2f3c709a506e111cc963034bf2fd127aa00.tar.gz&quot;;
          sha256 = &quot;17k6hq9xaax87yz79j773qyigm4fwk8z4zh5cyp6z0sxnwfqxxw5&quot;;
        };
      });
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-pls" class="title" style="clear: both">Procedural Languages   </h2>  </div> </div></div><p>PostgreSQL ships the additional procedural languages PL/Perl, PL/Python and PL/Tcl as extensions.
They are packaged as plugins and can be made available in the same way as external extensions:</p><pre><code class="programlisting nix">{
  services.postgresql.extensions = ps: with ps; [
    plperl
    plpython3
    pltcl
  ];
}
</code></pre><p>Each procedural language plugin provides a <code class="literal">.withPackages</code> helper to make language specific packages available at run-time.</p><p>For example, to make <code class="literal">python3Packages.base58</code> available:</p><pre><code class="programlisting nix">{
  services.postgresql.extensions = pgps: with pgps; [
    (plpython3.withPackages (pyps: with pyps; [ base58 ]))
  ];
}
</code></pre><p>This currently works for:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">plperl</code> by re-using <code class="literal">perl.withPackages</code></p></li><li class="listitem"><p><code class="literal">plpython3</code> by re-using <code class="literal">python3.withPackages</code></p></li><li class="listitem"><p><code class="literal">plr</code> by exposing <code class="literal">rPackages</code></p></li><li class="listitem"><p><code class="literal">pltcl</code> by exposing <code class="literal">tclPackages</code></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-jit" class="title" style="clear: both">JIT (Just-In-Time compilation)   </h2>  </div> </div></div><p><a class="link" href="https://www.postgresql.org/docs/current/jit-reason.html"  target="_top">JIT</a>-support in the PostgreSQL package
is disabled by default because of the ~600MiB closure-size increase from the LLVM dependency. It
can be optionally enabled in PostgreSQL with the following config option:</p><pre><code class="programlisting nix">{
  services.postgresql.enableJIT = true;
}
</code></pre><p>This makes sure that the <a class="link" href="https://www.postgresql.org/docs/current/runtime-config-query.html#GUC-JIT"  target="_top"><code class="literal">jit</code></a>-setting
is set to <code class="literal">on</code> and a PostgreSQL package with JIT enabled is used. Further tweaking of the JIT compiler, e.g. setting a different
query cost threshold via <a class="link" href="https://www.postgresql.org/docs/current/runtime-config-query.html#GUC-JIT-ABOVE-COST"  target="_top"><code class="literal">jit_above_cost</code></a>
can be done manually via <a class="link" href="options.html#opt-services.postgresql.settings"  ><code class="literal">services.postgresql.settings</code></a>.</p><p>The attribute-names of JIT-enabled PostgreSQL packages are suffixed with <code class="literal">_jit</code>, i.e. for each <code class="literal">pkgs.postgresql</code>
(and <code class="literal">pkgs.postgresql_&lt;major&gt;</code>) in <code class="literal">nixpkgs</code> there’s also a <code class="literal">pkgs.postgresql_jit</code> (and <code class="literal">pkgs.postgresql_&lt;major&gt;_jit</code>).
Alternatively, a JIT-enabled variant can be derived from a given <code class="literal">postgresql</code> package via <code class="literal">postgresql.withJIT</code>.
This is also useful if it’s not clear which attribute from <code class="literal">nixpkgs</code> was originally used (e.g. when working with
<a class="link" href="options.html#opt-services.postgresql.package"  ><code class="literal">config.services.postgresql.package</code></a> or if the package was modified via an
overlay) since all modifications are propagated to <code class="literal">withJIT</code>. I.e.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; {
  overlays = [
    (self: super: {
      postgresql = super.postgresql.overrideAttrs (_: { pname = &quot;foobar&quot;; });
    })
  ];
};
postgresql.withJIT.pname
</code></pre><p>evaluates to <code class="literal">&quot;foobar&quot;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-hardening" class="title" style="clear: both">Service hardening   </h2>  </div> </div></div><p>The service created by the <a class="link" href="options.html#opt-services.postgresql.enable"  ><code class="literal">postgresql</code>-module</a> uses
several common hardening options from <code class="literal">systemd</code>, most notably:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Memory pages must not be both writable and executable (this only applies to non-JIT setups).</p></li><li class="listitem"><p>A system call filter (see <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd.exec</span>(5)</span></a> for details on <code class="literal">@system-service</code>).</p></li><li class="listitem"><p>A stricter default UMask (<code class="literal">0027</code>).</p></li><li class="listitem"><p>Only sockets of type <code class="literal">AF_INET</code>/<code class="literal">AF_INET6</code>/<code class="literal">AF_NETLINK</code>/<code class="literal">AF_UNIX</code> allowed.</p></li><li class="listitem"><p>Restricted filesystem access (private <code class="literal">/tmp</code>, most of the file-system hierarchy is mounted read-only, only process directories in <code class="literal">/proc</code> that are owned by the same user).</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>When using <a class="link" href="https://www.postgresql.org/docs/current/manage-ag-tablespaces.html"  target="_top"><code class="literal">TABLESPACE</code></a>s, make sure to add the filesystem paths to <code class="literal">ReadWritePaths</code> like this:</p><pre><code class="programlisting nix">{
  systemd.services.postgresql.serviceConfig.ReadWritePaths = [
    &quot;/path/to/tablespace/location&quot;
  ];
}
</code></pre></li></ul></div></li></ul></div><p>The NixOS module also contains necessary adjustments for extensions from <code class="literal">nixpkgs</code>,
if these are enabled. If an extension or a postgresql feature from <code class="literal">nixpkgs</code> breaks
with hardening, it’s considered a bug.</p><p>When using extensions that are not packaged in <code class="literal">nixpkgs</code>, hardening adjustments may
become necessary.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-upstream-deviation" class="title" style="clear: both">Notable differences to upstream   </h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>To avoid circular dependencies between default and -dev outputs, the output of the <code class="literal">pg_config</code> system view has been removed.</p></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb" class="title" >FoundationDB   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-foundationdb-configuring">Configuring and basic setup</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-foundationdb-scaling">Scaling processes and backup agents</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-foundationdb-clustering">Clustering</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-foundationdb-connectivity">Client connectivity</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-foundationdb-authorization">Client authorization and TLS</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-foundationdb-disaster-recovery">Backups and Disaster Recovery</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-foundationdb-limitations">Known limitations</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-foundationdb-options">Options</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-foundationdb-full-docs">Full documentation</a> </span></dt> </dl></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/databases/foundationdb.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://apple.github.io/foundationdb/"  target="_top">https://apple.github.io/foundationdb/</a></p><p><span class="emphasis"><em>Maintainer:</em></span> Austin Seipp</p><p><span class="emphasis"><em>Available version(s):</em></span> 7.1.x</p><p>FoundationDB (or “FDB”) is an open source, distributed, transactional
key-value store.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-configuring" class="title" style="clear: both">Configuring and basic setup   </h2>  </div> </div></div><p>To enable FoundationDB, add the following to your
<code class="filename">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  services.foundationdb.enable = true;
  services.foundationdb.package = pkgs.foundationdb73; # FoundationDB 7.3.x
}
</code></pre><p>The <code class="option">services.foundationdb.package</code> option is required, and
must always be specified. Due to the fact FoundationDB network protocols and
on-disk storage formats may change between (major) versions, and upgrades
must be explicitly handled by the user, you must always manually specify
this yourself so that the NixOS module will use the proper version. Note
that minor, bugfix releases are always compatible.</p><p>After running <span class="command"><strong>nixos-rebuild</strong></span>, you can verify whether
FoundationDB is running by executing <span class="command"><strong>fdbcli</strong></span> (which is
added to <code class="option">environment.systemPackages</code>):</p><pre><code class="programlisting ShellSession">$ sudo -u foundationdb fdbcli
Using cluster file `/etc/foundationdb/fdb.cluster&#x27;.

The database is available.

Welcome to the fdbcli. For help, type `help&#x27;.
fdb&gt; status

Using cluster file `/etc/foundationdb/fdb.cluster&#x27;.

Configuration:
  Redundancy mode        - single
  Storage engine         - memory
  Coordinators           - 1

Cluster:
  FoundationDB processes - 1
  Machines               - 1
  Memory availability    - 5.4 GB per process on machine with least available
  Fault Tolerance        - 0 machines
  Server time            - 04/20/18 15:21:14

...

fdb&gt;
</code></pre><p>You can also write programs using the available client libraries. For
example, the following Python program can be run in order to grab the
cluster status, as a quick example. (This example uses
<span class="command"><strong>nix-shell</strong></span> shebang support to automatically supply the
necessary Python modules).</p><pre><code class="programlisting ShellSession">a@link&gt; cat fdb-status.py
#! /usr/bin/env nix-shell
#! nix-shell -i python -p python pythonPackages.foundationdb73

import fdb
import json

def main():
    fdb.api_version(520)
    db = fdb.open()

    @fdb.transactional
    def get_status(tr):
        return str(tr[&#x27;\xff\xff/status/json&#x27;])

    obj = json.loads(get_status(db))
    print(&#x27;FoundationDB available: %s&#x27; % obj[&#x27;client&#x27;][&#x27;database_status&#x27;][&#x27;available&#x27;])

if __name__ == &quot;__main__&quot;:
    main()
a@link&gt; chmod +x fdb-status.py
a@link&gt; ./fdb-status.py
FoundationDB available: True
a@link&gt;
</code></pre><p>FoundationDB is run under the <span class="command"><strong>foundationdb</strong></span> user and group
by default, but this may be changed in the NixOS configuration. The systemd
unit <span class="command"><strong>foundationdb.service</strong></span> controls the
<span class="command"><strong>fdbmonitor</strong></span> process.</p><p>By default, the NixOS module for FoundationDB creates a single SSD-storage
based database for development and basic usage. This storage engine is
designed for SSDs and will perform poorly on HDDs; however it can handle far
more data than the alternative “memory” engine and is a better default
choice for most deployments. (Note that you can change the storage backend
on-the-fly for a given FoundationDB cluster using
<span class="command"><strong>fdbcli</strong></span>.)</p><p>Furthermore, only 1 server process and 1 backup agent are started in the
default configuration. See below for more on scaling to increase this.</p><p>FoundationDB stores all data for all server processes under
<code class="filename">/var/lib/foundationdb</code>. You can override this using
<code class="option">services.foundationdb.dataDir</code>, e.g.</p><pre><code class="programlisting nix">{
  services.foundationdb.dataDir = &quot;/data/fdb&quot;;
}
</code></pre><p>Similarly, logs are stored under <code class="filename">/var/log/foundationdb</code>
by default, and there is a corresponding
<code class="option">services.foundationdb.logDir</code> as well.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-scaling" class="title" style="clear: both">Scaling processes and backup agents   </h2>  </div> </div></div><p>Scaling the number of server processes is quite easy; simply specify
<code class="option">services.foundationdb.serverProcesses</code> to be the number of
FoundationDB worker processes that should be started on the machine.</p><p>FoundationDB worker processes typically require 4GB of RAM per-process at
minimum for good performance, so this option is set to 1 by default since
the maximum amount of RAM is unknown. You’re advised to abide by this
restriction, so pick a number of processes so that each has 4GB or more.</p><p>A similar option exists in order to scale backup agent processes,
<code class="option">services.foundationdb.backupProcesses</code>. Backup agents are
not as performance/RAM sensitive, so feel free to experiment with the number
of available backup processes.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-clustering" class="title" style="clear: both">Clustering   </h2>  </div> </div></div><p>FoundationDB on NixOS works similarly to other Linux systems, so this
section will be brief. Please refer to the full FoundationDB documentation
for more on clustering.</p><p>FoundationDB organizes clusters using a set of
<span class="emphasis"><em>coordinators</em></span>, which are just specially-designated
worker processes. By default, every installation of FoundationDB on NixOS
will start as its own individual cluster, with a single coordinator: the
first worker process on <span class="command"><strong>localhost</strong></span>.</p><p>Coordinators are specified globally using the
<span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> file, which all servers and
client applications will use to find and join coordinators. Note that this
file <span class="emphasis"><em>can not</em></span> be managed by NixOS so easily:
FoundationDB is designed so that it will rewrite the file at runtime for all
clients and nodes when cluster coordinators change, with clients
transparently handling this without intervention. It is fundamentally a
mutable file, and you should not try to manage it in any way in NixOS.</p><p>When dealing with a cluster, there are two main things you want to do:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Add a node to the cluster for storage/compute.</p></li><li class="listitem"><p>Promote an ordinary worker to a coordinator.</p></li></ul></div><p>A node must already be a member of the cluster in order to properly be
promoted to a coordinator, so you must always add it first if you wish to
promote it.</p><p>To add a machine to a FoundationDB cluster:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Choose one of the servers to start as the initial coordinator.</p></li><li class="listitem"><p>Copy the <span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> file from this
server to all the other servers. Restart FoundationDB on all of these
other servers, so they join the cluster.</p></li><li class="listitem"><p>All of these servers are now connected and working together in the
cluster, under the chosen coordinator.</p></li></ul></div><p>At this point, you can add as many nodes as you want by just repeating the
above steps. By default there will still be a single coordinator: you can
use <span class="command"><strong>fdbcli</strong></span> to change this and add new coordinators.</p><p>As a convenience, FoundationDB can automatically assign coordinators based
on the redundancy mode you wish to achieve for the cluster. Once all the
nodes have been joined, simply set the replication policy, and then issue
the <span class="command"><strong>coordinators auto</strong></span> command</p><p>For example, assuming we have 3 nodes available, we can enable double
redundancy mode, then auto-select coordinators. For double redundancy, 3
coordinators is ideal: therefore FoundationDB will make
<span class="emphasis"><em>every</em></span> node a coordinator automatically:</p><pre><code class="programlisting ShellSession">fdbcli&gt; configure double ssd
fdbcli&gt; coordinators auto
</code></pre><p>This will transparently update all the servers within seconds, and
appropriately rewrite the <span class="command"><strong>fdb.cluster</strong></span> file, as well as
informing all client processes to do the same.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-connectivity" class="title" style="clear: both">Client connectivity   </h2>  </div> </div></div><p>By default, all clients must use the current <span class="command"><strong>fdb.cluster</strong></span>
file to access a given FoundationDB cluster. This file is located by default
in <span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> on all machines with the
FoundationDB service enabled, so you may copy the active one from your
cluster to a new node in order to connect, if it is not part of the cluster.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-authorization" class="title" style="clear: both">Client authorization and TLS   </h2>  </div> </div></div><p>By default, any user who can connect to a FoundationDB process with the
correct cluster configuration can access anything. FoundationDB uses a
pluggable design to transport security, and out of the box it supports a
LibreSSL-based plugin for TLS support. This plugin not only does in-flight
encryption, but also performs client authorization based on the given
endpoint’s certificate chain. For example, a FoundationDB server may be
configured to only accept client connections over TLS, where the client TLS
certificate is from organization <span class="emphasis"><em>Acme Co</em></span> in the
<span class="emphasis"><em>Research and Development</em></span> unit.</p><p>Configuring TLS with FoundationDB is done using the
<code class="option">services.foundationdb.tls</code> options in order to control the
peer verification string, as well as the certificate and its private key.</p><p>Note that the certificate and its private key must be accessible to the
FoundationDB user account that the server runs under. These files are also
NOT managed by NixOS, as putting them into the store may reveal private
information.</p><p>After you have a key and certificate file in place, it is not enough to
simply set the NixOS module options – you must also configure the
<span class="command"><strong>fdb.cluster</strong></span> file to specify that a given set of
coordinators use TLS. This is as simple as adding the suffix
<span class="command"><strong>:tls</strong></span> to your cluster coordinator configuration, after the
port number. For example, assuming you have a coordinator on localhost with
the default configuration, simply specifying:</p><pre><code class="programlisting">XXXXXX:XXXXXX@127.0.0.1:4500:tls
</code></pre><p>will configure all clients and server processes to use TLS from now on.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-disaster-recovery" class="title" style="clear: both">Backups and Disaster Recovery   </h2>  </div> </div></div><p>The usual rules for doing FoundationDB backups apply on NixOS as written in
the FoundationDB manual. However, one important difference is the security
profile for NixOS: by default, the <span class="command"><strong>foundationdb</strong></span> systemd
unit uses <span class="emphasis"><em>Linux namespaces</em></span> to restrict write access to
the system, except for the log directory, data directory, and the
<span class="command"><strong>/etc/foundationdb/</strong></span> directory. This is enforced by default
and cannot be disabled.</p><p>However, a side effect of this is that the <span class="command"><strong>fdbbackup</strong></span>
command doesn’t work properly for local filesystem backups: FoundationDB
uses a server process alongside the database processes to perform backups
and copy the backups to the filesystem. As a result, this process is put
under the restricted namespaces above: the backup process can only write to
a limited number of paths.</p><p>In order to allow flexible backup locations on local disks, the FoundationDB
NixOS module supports a
<code class="option">services.foundationdb.extraReadWritePaths</code> option. This
option takes a list of paths, and adds them to the systemd unit, allowing
the processes inside the service to write (and read) the specified
directories.</p><p>For example, to create backups in <span class="command"><strong>/opt/fdb-backups</strong></span>, first
set up the paths in the module options:</p><pre><code class="programlisting nix">{
  services.foundationdb.extraReadWritePaths = [ &quot;/opt/fdb-backups&quot; ];
}
</code></pre><p>Restart the FoundationDB service, and it will now be able to write to this
directory (even if it does not yet exist.) Note: this path
<span class="emphasis"><em>must</em></span> exist before restarting the unit. Otherwise,
systemd will not include it in the private FoundationDB namespace (and it
will not add it dynamically at runtime).</p><p>You can now perform a backup:</p><pre><code class="programlisting ShellSession">$ sudo -u foundationdb fdbbackup start  -t default -d file:///opt/fdb-backups
$ sudo -u foundationdb fdbbackup status -t default
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-limitations" class="title" style="clear: both">Known limitations   </h2>  </div> </div></div><p>The FoundationDB setup for NixOS should currently be considered beta.
FoundationDB is not new software, but the NixOS compilation and integration
has only undergone fairly basic testing of all the available functionality.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>There is no way to specify individual parameters for individual
<span class="command"><strong>fdbserver</strong></span> processes. Currently, all server processes
inherit all the global <span class="command"><strong>fdbmonitor</strong></span> settings.</p></li><li class="listitem"><p>Ruby bindings are not currently installed.</p></li><li class="listitem"><p>Go bindings are not currently installed.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-options" class="title" style="clear: both">Options   </h2>  </div> </div></div><p>NixOS’s FoundationDB module allows you to configure all of the most relevant
configuration options for <span class="command"><strong>fdbmonitor</strong></span>, matching it quite
closely. A complete list of options for the FoundationDB module may be found
<a class="link" href="options.html#opt-services.foundationdb.enable"  >here</a>. You should
also read the FoundationDB documentation as well.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-full-docs" class="title" style="clear: both">Full documentation   </h2>  </div> </div></div><p>FoundationDB is a complex piece of software, and requires careful
administration to properly use. Full documentation for administration can be
found here: <a class="link" href="https://apple.github.io/foundationdb/"  target="_top">https://apple.github.io/foundationdb/</a>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-borgbase" class="title" >BorgBackup   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-backup-borgbackup-configuring">Configuring</a> </span></dt><dt> <span class="section">  <a href="index.html#opt-services-backup-borgbackup-local-directory">Basic usage for a local backup</a> </span></dt><dt> <span class="section">  <a href="index.html#opt-services-backup-create-server">Create a borg backup server</a> </span></dt><dt> <span class="section">  <a href="index.html#opt-services-backup-borgbackup-remote-server">Backup to the borg repository server</a> </span></dt><dt> <span class="section">  <a href="index.html#opt-services-backup-borgbackup-borgbase">Backup to a hosting service</a> </span></dt><dt> <span class="section">  <a href="index.html#opt-services-backup-borgbackup-vorta">Vorta backup client for the desktop</a> </span></dt> </dl></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/backup/borgbackup.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://borgbackup.readthedocs.io/"  target="_top">https://borgbackup.readthedocs.io/</a></p><p><a class="link" href="https://www.borgbackup.org/"  target="_top">BorgBackup</a> (short: Borg)
is a deduplicating backup program. Optionally, it supports compression and
authenticated encryption.</p><p>The main goal of Borg is to provide an efficient and secure way to backup
data. The data deduplication technique used makes Borg suitable for daily
backups since only changes are stored. The authenticated encryption technique
makes it suitable for backups to not fully trusted targets.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-backup-borgbackup-configuring" class="title" style="clear: both">Configuring   </h2>  </div> </div></div><p>A complete list of options for the Borgbase module may be found
<a class="link" href="options.html#opt-services.borgbackup.jobs"  >here</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="opt-services-backup-borgbackup-local-directory" class="title" style="clear: both">Basic usage for a local backup   </h2>  </div> </div></div><p>A very basic configuration for backing up to a locally accessible directory is:</p><pre><code class="programlisting nix">{
    services.borgbackup.jobs = {
      rootBackup = {
        paths = &quot;/&quot;;
        exclude = [ &quot;/nix&quot; &quot;/path/to/local/repo&quot; ];
        repo = &quot;/path/to/local/repo&quot;;
        doInit = true;
        encryption = {
          mode = &quot;repokey&quot;;
          passphrase = &quot;secret&quot;;
        };
        compression = &quot;auto,lzma&quot;;
        startAt = &quot;weekly&quot;;
      };
    };
}
</code></pre><div class="warning"><h3 class="title">Warning</h3><p>If you do not want the passphrase to be stored in the world-readable
Nix store, use passCommand. You find an example below.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="opt-services-backup-create-server" class="title" style="clear: both">Create a borg backup server   </h2>  </div> </div></div><p>You should use a different SSH key for each repository you write to,
because the specified keys are restricted to running borg serve and can only
access this single repository. You need the output of the generate pub file.</p><pre><code class="programlisting ShellSession"># sudo ssh-keygen -N &#x27;&#x27; -t ed25519 -f /run/keys/id_ed25519_my_borg_repo
# cat /run/keys/id_ed25519_my_borg_repo
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID78zmOyA+5uPG4Ot0hfAy+sLDPU1L4AiIoRYEIVbbQ/ root@nixos
</code></pre><p>Add the following snippet to your NixOS configuration:</p><pre><code class="programlisting nix">{
  services.borgbackup.repos = {
    my_borg_repo = {
      authorizedKeys = [
        &quot;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID78zmOyA+5uPG4Ot0hfAy+sLDPU1L4AiIoRYEIVbbQ/ root@nixos&quot;
      ] ;
      path = &quot;/var/lib/my_borg_repo&quot; ;
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="opt-services-backup-borgbackup-remote-server" class="title" style="clear: both">Backup to the borg repository server   </h2>  </div> </div></div><p>The following NixOS snippet creates an hourly backup to the service
(on the host nixos) as created in the section above. We assume
that you have stored a secret passphrasse in the file
<code class="filename">/run/keys/borgbackup_passphrase</code>, which should be only
accessible by root</p><pre><code class="programlisting nix">{
  services.borgbackup.jobs = {
    backupToLocalServer = {
      paths = [ &quot;/etc/nixos&quot; ];
      doInit = true;
      repo =  &quot;borg@nixos:.&quot; ;
      encryption = {
        mode = &quot;repokey-blake2&quot;;
        passCommand = &quot;cat /run/keys/borgbackup_passphrase&quot;;
      };
      environment = { BORG_RSH = &quot;ssh -i /run/keys/id_ed25519_my_borg_repo&quot;; };
      compression = &quot;auto,lzma&quot;;
      startAt = &quot;hourly&quot;;
    };
  };
}
</code></pre><p>The following few commands (run as root) let you test your backup.</p><pre><code class="programlisting">&gt; nixos-rebuild switch
...restarting the following units: polkit.service
&gt; systemctl restart borgbackup-job-backupToLocalServer
&gt; sleep 10
&gt; systemctl restart borgbackup-job-backupToLocalServer
&gt; export BORG_PASSPHRASE=topSecret
&gt; borg list --rsh=&#x27;ssh -i /run/keys/id_ed25519_my_borg_repo&#x27; borg@nixos:.
nixos-backupToLocalServer-2020-03-30T21:46:17 Mon, 2020-03-30 21:46:19 [84feb97710954931ca384182f5f3cb90665f35cef214760abd7350fb064786ac]
nixos-backupToLocalServer-2020-03-30T21:46:30 Mon, 2020-03-30 21:46:32 [e77321694ecd160ca2228611747c6ad1be177d6e0d894538898de7a2621b6e68]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="opt-services-backup-borgbackup-borgbase" class="title" style="clear: both">Backup to a hosting service   </h2>  </div> </div></div><p>Several companies offer <a class="link" href="https://www.borgbackup.org/support/commercial.html"  target="_top">(paid) hosting services</a>
for Borg repositories.</p><p>To backup your home directory to borgbase you have to:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Generate a SSH key without a password, to access the remote server. E.g.</p><pre><code class="programlisting">sudo ssh-keygen -N &#x27;&#x27; -t ed25519 -f /run/keys/id_ed25519_borgbase
</code></pre></li><li class="listitem"><p>Create the repository on the server by following the instructions for your
hosting server.</p></li><li class="listitem"><p>Initialize the repository on the server. Eg.</p><pre><code class="programlisting">sudo borg init --encryption=repokey-blake2  \
    --rsh &quot;ssh -i /run/keys/id_ed25519_borgbase&quot; \
    zzz2aaaaa@zzz2aaaaa.repo.borgbase.com:repo
</code></pre></li><li class="listitem"><p>Add it to your NixOS configuration, e.g.</p><pre><code class="programlisting">{
    services.borgbackup.jobs = {
    my_Remote_Backup = {
        paths = [ &quot;/&quot; ];
        exclude = [ &quot;/nix&quot; &quot;&#x27;**/.cache&#x27;&quot; ];
        repo =  &quot;zzz2aaaaa@zzz2aaaaa.repo.borgbase.com:repo&quot;;
          encryption = {
          mode = &quot;repokey-blake2&quot;;
          passCommand = &quot;cat /run/keys/borgbackup_passphrase&quot;;
        };
        environment = { BORG_RSH = &quot;ssh -i /run/keys/id_ed25519_borgbase&quot;; };
        compression = &quot;auto,lzma&quot;;
        startAt = &quot;daily&quot;;
    };
  };
}}
</code></pre></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="opt-services-backup-borgbackup-vorta" class="title" style="clear: both">Vorta backup client for the desktop   </h2>  </div> </div></div><p>Vorta is a backup client for macOS and Linux desktops. It integrates the
mighty BorgBackup with your desktop environment to protect your data from
disk failure, ransomware and theft.</p><p>It can be installed in NixOS e.g. by adding <code class="literal">pkgs.vorta</code>
to <a class="xref" href="options.html#opt-environment.systemPackages"  ><code class="option">environment.systemPackages</code></a>.</p><p>Details about using Vorta can be found under
<a class="link" href="https://vorta.borgbase.com/usage"  target="_top">https://vorta.borgbase.com</a> .</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme" class="title" >SSL/TLS Certificates with ACME   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-security-acme-prerequisites">Prerequisites</a> </span></dt><dt> <span class="section">  <a href="index.html#module-security-acme-nginx">Using ACME certificates in Nginx</a> </span></dt><dt> <span class="section">  <a href="index.html#module-security-acme-httpd">Using ACME certificates in Apache/httpd</a> </span></dt><dt> <span class="section">  <a href="index.html#module-security-acme-configuring">Manual configuration of HTTP-01 validation</a> </span></dt><dt> <span class="section">  <a href="index.html#module-security-acme-config-dns">Configuring ACME for DNS validation</a> </span></dt><dt> <span class="section">  <a href="index.html#module-security-acme-config-dns-with-vhosts">Using DNS validation with web server virtual hosts</a> </span></dt><dt> <span class="section">  <a href="index.html#module-security-acme-root-owned">Using ACME with services demanding root owned certificates</a> </span></dt><dt> <span class="section">  <a href="index.html#module-security-acme-regenerate">Regenerating certificates</a> </span></dt><dt> <span class="section">  <a href="index.html#module-security-acme-fix-jws">Fixing JWS Verification error</a> </span></dt> </dl></div><p>NixOS supports automatic domain validation &amp; certificate retrieval and
renewal using the ACME protocol. Any provider can be used, but by default
NixOS uses Let’s Encrypt. The alternative ACME client
<a class="link" href="https://go-acme.github.io/lego/"  target="_top">lego</a> is used under
the hood.</p><p>Automatic cert validation and configuration for Apache and Nginx virtual
hosts is included in NixOS, however if you would like to generate a wildcard
cert or you are not using a web server you will have to configure DNS
based validation.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-prerequisites" class="title" style="clear: both">Prerequisites   </h2>  </div> </div></div><p>To use the ACME module, you must accept the provider’s terms of service
by setting <a class="xref" href="options.html#opt-security.acme.acceptTerms"  ><code class="option">security.acme.acceptTerms</code></a>
to <code class="literal">true</code>. The Let’s Encrypt ToS can be found
<a class="link" href="https://letsencrypt.org/repository/"  target="_top">here</a>.</p><p>You must also set an email address to be used when creating accounts with
Let’s Encrypt. You can set this for all certs with
<a class="xref" href="options.html#opt-security.acme.defaults.email"  ><code class="option">security.acme.defaults.email</code></a>
and/or on a per-cert basis with
<a class="xref" href="options.html#opt-security.acme.certs._name_.email"  ><code class="option">security.acme.certs.&lt;name&gt;.email</code></a>.
This address is only used for registration and renewal reminders,
and cannot be used to administer the certificates in any way.</p><p>Alternatively, you can use a different ACME server by changing the
<a class="xref" href="options.html#opt-security.acme.defaults.server"  ><code class="option">security.acme.defaults.server</code></a> option
to a provider of your choosing, or just change the server for one cert with
<a class="xref" href="options.html#opt-security.acme.certs._name_.server"  ><code class="option">security.acme.certs.&lt;name&gt;.server</code></a>.</p><p>You will need an HTTP server or DNS server for verification. For HTTP,
the server must have a webroot defined that can serve
<code class="filename">.well-known/acme-challenge</code>. This directory must be
writeable by the user that will run the ACME client. For DNS, you must
set up credentials with your provider/server for use with lego.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-nginx" class="title" style="clear: both">Using ACME certificates in Nginx   </h2>  </div> </div></div><p>NixOS supports fetching ACME certificates for you by setting
<code class="literal">enableACME = true;</code> in a virtualHost config. We first create self-signed
placeholder certificates in place of the real ACME certs. The placeholder
certs are overwritten when the ACME certs arrive. For
<code class="literal">foo.example.com</code> the config would look like this:</p><pre><code class="programlisting nix">{
  security.acme.acceptTerms = true;
  security.acme.defaults.email = &quot;admin+acme@example.com&quot;;
  services.nginx = {
    enable = true;
    virtualHosts = {
      &quot;foo.example.com&quot; = {
        forceSSL = true;
        enableACME = true;
        # All serverAliases will be added as extra domain names on the certificate.
        serverAliases = [ &quot;bar.example.com&quot; ];
        locations.&quot;/&quot; = {
          root = &quot;/var/www&quot;;
        };
      };

      # We can also add a different vhost and reuse the same certificate
      # but we have to append extraDomainNames manually beforehand:
      # security.acme.certs.&quot;foo.example.com&quot;.extraDomainNames = [ &quot;baz.example.com&quot; ];
      &quot;baz.example.com&quot; = {
        forceSSL = true;
        useACMEHost = &quot;foo.example.com&quot;;
        locations.&quot;/&quot; = {
          root = &quot;/var/www&quot;;
        };
      };
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-httpd" class="title" style="clear: both">Using ACME certificates in Apache/httpd   </h2>  </div> </div></div><p>Using ACME certificates with Apache virtual hosts is identical
to using them with Nginx. The attribute names are all the same, just replace
“nginx” with “httpd” where appropriate.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-configuring" class="title" style="clear: both">Manual configuration of HTTP-01 validation   </h2>  </div> </div></div><p>First off you will need to set up a virtual host to serve the challenges.
This example uses a vhost called <code class="literal">certs.example.com</code>, with
the intent that you will generate certs for all your vhosts and redirect
everyone to HTTPS.</p><pre><code class="programlisting nix">{
  security.acme.acceptTerms = true;
  security.acme.defaults.email = &quot;admin+acme@example.com&quot;;

  # /var/lib/acme/.challenges must be writable by the ACME user
  # and readable by the Nginx user. The easiest way to achieve
  # this is to add the Nginx user to the ACME group.
  users.users.nginx.extraGroups = [ &quot;acme&quot; ];

  services.nginx = {
    enable = true;
    virtualHosts = {
      &quot;acmechallenge.example.com&quot; = {
        # Catchall vhost, will redirect users to HTTPS for all vhosts
        serverAliases = [ &quot;*.example.com&quot; ];
        locations.&quot;/.well-known/acme-challenge&quot; = {
          root = &quot;/var/lib/acme/.challenges&quot;;
        };
        locations.&quot;/&quot; = {
          return = &quot;301 https://$host$request_uri&quot;;
        };
      };
    };
  };
  # Alternative config for Apache
  users.users.wwwrun.extraGroups = [ &quot;acme&quot; ];
  services.httpd = {
    enable = true;
    virtualHosts = {
      &quot;acmechallenge.example.com&quot; = {
        # Catchall vhost, will redirect users to HTTPS for all vhosts
        serverAliases = [ &quot;*.example.com&quot; ];
        # /var/lib/acme/.challenges must be writable by the ACME user and readable by the Apache user.
        # By default, this is the case.
        documentRoot = &quot;/var/lib/acme/.challenges&quot;;
        extraConfig = &#x27;&#x27;
          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge [NC]
          RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R=301]
        &#x27;&#x27;;
      };
    };
  };
}
</code></pre><p>Now you need to configure ACME to generate a certificate.</p><pre><code class="programlisting nix">{
  security.acme.certs.&quot;foo.example.com&quot; = {
    webroot = &quot;/var/lib/acme/.challenges&quot;;
    email = &quot;foo@example.com&quot;;
    # Ensure that the web server you use can read the generated certs
    # Take a look at the group option for the web server you choose.
    group = &quot;nginx&quot;;
    # Since we have a wildcard vhost to handle port 80,
    # we can generate certs for anything!
    # Just make sure your DNS resolves them.
    extraDomainNames = [ &quot;mail.example.com&quot; ];
  };
}
</code></pre><p>The private key <code class="filename">key.pem</code> and certificate
<code class="filename">fullchain.pem</code> will be put into
<code class="filename">/var/lib/acme/foo.example.com</code>.</p><p>Refer to <a class="xref" href="options.html" title="Appendix A. Configuration Options" >Appendix&nbsp;A</a> for all available configuration
options for the <a class="link" href="options.html#opt-security.acme.certs"  >security.acme</a>
module.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-config-dns" class="title" style="clear: both">Configuring ACME for DNS validation   </h2>  </div> </div></div><p>This is useful if you want to generate a wildcard certificate, since
ACME servers will only hand out wildcard certs over DNS validation.
There are a number of supported DNS providers and servers you can utilise,
see the <a class="link" href="https://go-acme.github.io/lego/dns/"  target="_top">lego docs</a>
for provider/server specific configuration values. For the sake of these
docs, we will provide a fully self-hosted example using bind.</p><pre><code class="programlisting nix">{
  services.bind = {
    enable = true;
    extraConfig = &#x27;&#x27;
      include &quot;/var/lib/secrets/dnskeys.conf&quot;;
    &#x27;&#x27;;
    zones = [
      rec {
        name = &quot;example.com&quot;;
        file = &quot;/var/db/bind/${name}&quot;;
        master = true;
        extraConfig = &quot;allow-update { key rfc2136key.example.com.; };&quot;;
      }
    ];
  };

  # Now we can configure ACME
  security.acme.acceptTerms = true;
  security.acme.defaults.email = &quot;admin+acme@example.com&quot;;
  security.acme.certs.&quot;example.com&quot; = {
    domain = &quot;*.example.com&quot;;
    dnsProvider = &quot;rfc2136&quot;;
    environmentFile = &quot;/var/lib/secrets/certs.secret&quot;;
    # We don&#x27;t need to wait for propagation since this is a local DNS server
    dnsPropagationCheck = false;
  };
}
</code></pre><p>The <code class="filename">dnskeys.conf</code> and <code class="filename">certs.secret</code>
must be kept secure and thus you should not keep their contents in your
Nix config. Instead, generate them one time with a systemd service:</p><pre><code class="programlisting nix">{
  systemd.services.dns-rfc2136-conf = {
    requiredBy = [&quot;acme-example.com.service&quot; &quot;bind.service&quot;];
    before = [&quot;acme-example.com.service&quot; &quot;bind.service&quot;];
    unitConfig = {
      ConditionPathExists = &quot;!/var/lib/secrets/dnskeys.conf&quot;;
    };
    serviceConfig = {
      Type = &quot;oneshot&quot;;
      UMask = 0077;
    };
    path = [ pkgs.bind ];
    script = &#x27;&#x27;
      mkdir -p /var/lib/secrets
      chmod 755 /var/lib/secrets
      tsig-keygen rfc2136key.example.com &gt; /var/lib/secrets/dnskeys.conf
      chown named:root /var/lib/secrets/dnskeys.conf
      chmod 400 /var/lib/secrets/dnskeys.conf

      # extract secret value from the dnskeys.conf
      while read x y; do if [ &quot;$x&quot; = &quot;secret&quot; ]; then secret=&quot;&#x27;&#x27;${y:1:&#x27;&#x27;${#y}-3}&quot;; fi; done &lt; /var/lib/secrets/dnskeys.conf

      cat &gt; /var/lib/secrets/certs.secret &lt;&lt; EOF
      RFC2136_NAMESERVER=&#x27;127.0.0.1:53&#x27;
      RFC2136_TSIG_ALGORITHM=&#x27;hmac-sha256.&#x27;
      RFC2136_TSIG_KEY=&#x27;rfc2136key.example.com&#x27;
      RFC2136_TSIG_SECRET=&#x27;$secret&#x27;
      EOF
      chmod 400 /var/lib/secrets/certs.secret
    &#x27;&#x27;;
  };
}
</code></pre><p>Now you’re all set to generate certs! You should monitor the first invocation
by running <code class="literal">systemctl start acme-example.com.service &amp; journalctl -fu acme-example.com.service</code> and watching its log output.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-config-dns-with-vhosts" class="title" style="clear: both">Using DNS validation with web server virtual hosts   </h2>  </div> </div></div><p>It is possible to use DNS-01 validation with all certificates,
including those automatically configured via the Nginx/Apache
<a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.enableACME"  ><code class="literal">enableACME</code></a>
option. This configuration pattern is fully
supported and part of the module’s test suite for Nginx + Apache.</p><p>You must follow the guide above on configuring DNS-01 validation
first, however instead of setting the options for one certificate
(e.g. <a class="xref" href="options.html#opt-security.acme.certs._name_.dnsProvider"  ><code class="option">security.acme.certs.&lt;name&gt;.dnsProvider</code></a>)
you will set them as defaults
(e.g. <a class="xref" href="options.html#opt-security.acme.defaults.dnsProvider"  ><code class="option">security.acme.defaults.dnsProvider</code></a>).</p><pre><code class="programlisting nix">{
  # Configure ACME appropriately
  security.acme.acceptTerms = true;
  security.acme.defaults.email = &quot;admin+acme@example.com&quot;;
  security.acme.defaults = {
    dnsProvider = &quot;rfc2136&quot;;
    environmentFile = &quot;/var/lib/secrets/certs.secret&quot;;
    # We don&#x27;t need to wait for propagation since this is a local DNS server
    dnsPropagationCheck = false;
  };

  # For each virtual host you would like to use DNS-01 validation with,
  # set acmeRoot = null
  services.nginx = {
    enable = true;
    virtualHosts = {
      &quot;foo.example.com&quot; = {
        enableACME = true;
        acmeRoot = null;
      };
    };
  };
}
</code></pre><p>And that’s it! Next time your configuration is rebuilt, or when
you add a new virtualHost, it will be DNS-01 validated.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-root-owned" class="title" style="clear: both">Using ACME with services demanding root owned certificates   </h2>  </div> </div></div><p>Some services refuse to start if the configured certificate files
are not owned by root. PostgreSQL and OpenSMTPD are examples of these.
There is no way to change the user the ACME module uses (it will always be
<code class="literal">acme</code>), however you can use systemd’s
<code class="literal">LoadCredential</code> feature to resolve this elegantly.
Below is an example configuration for OpenSMTPD, but this pattern
can be applied to any service.</p><pre><code class="programlisting nix">{
  # Configure ACME however you like (DNS or HTTP validation), adding
  # the following configuration for the relevant certificate.
  # Note: You cannot use `systemctl reload` here as that would mean
  # the LoadCredential configuration below would be skipped and
  # the service would continue to use old certificates.
  security.acme.certs.&quot;mail.example.com&quot;.postRun = &#x27;&#x27;
    systemctl restart opensmtpd
  &#x27;&#x27;;

  # Now you must augment OpenSMTPD&#x27;s systemd service to load
  # the certificate files.
  systemd.services.opensmtpd.requires = [&quot;acme-finished-mail.example.com.target&quot;];
  systemd.services.opensmtpd.serviceConfig.LoadCredential = let
    certDir = config.security.acme.certs.&quot;mail.example.com&quot;.directory;
  in [
    &quot;cert.pem:${certDir}/cert.pem&quot;
    &quot;key.pem:${certDir}/key.pem&quot;
  ];

  # Finally, configure OpenSMTPD to use these certs.
  services.opensmtpd = let
    credsDir = &quot;/run/credentials/opensmtpd.service&quot;;
  in {
    enable = true;
    setSendmail = false;
    serverConfiguration = &#x27;&#x27;
      pki mail.example.com cert &quot;${credsDir}/cert.pem&quot;
      pki mail.example.com key &quot;${credsDir}/key.pem&quot;
      listen on localhost tls pki mail.example.com
      action act1 relay host smtp://127.0.0.1:10027
      match for local action act1
    &#x27;&#x27;;
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-regenerate" class="title" style="clear: both">Regenerating certificates   </h2>  </div> </div></div><p>Should you need to regenerate a particular certificate in a hurry, such
as when a vulnerability is found in Let’s Encrypt, there is now a convenient
mechanism for doing so. Running
<code class="literal">systemctl clean --what=state acme-example.com.service</code>
will remove all certificate files and the account data for the given domain,
allowing you to then <code class="literal">systemctl start acme-example.com.service</code>
to generate fresh ones.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-fix-jws" class="title" style="clear: both">Fixing JWS Verification error   </h2>  </div> </div></div><p>It is possible that your account credentials file may become corrupt and need
to be regenerated. In this scenario lego will produce the error <code class="literal">JWS verification error</code>.
The solution is to simply delete the associated accounts file and
re-run the affected service(s).</p><pre><code class="programlisting shell"># Find the accounts folder for the certificate
systemctl cat acme-example.com.service | grep -Po &#x27;accounts/[^:]*&#x27;
export accountdir=&quot;$(!!)&quot;
# Move this folder to some place else
mv /var/lib/acme/.lego/$accountdir{,.bak}
# Recreate the folder using systemd-tmpfiles
systemd-tmpfiles --create
# Get a new account and reissue certificates
# Note: Do this for all certs that share the same account email address
systemctl start acme-example.com.service
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-zsh-ohmyzsh" class="title" >Oh my ZSH   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-programs-oh-my-zsh-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="index.html#module-programs-oh-my-zsh-additions">Custom additions</a> </span></dt><dt> <span class="section">  <a href="index.html#module-programs-oh-my-zsh-environments">Custom environments</a> </span></dt><dt> <span class="section">  <a href="index.html#module-programs-oh-my-zsh-packaging-customizations">Package your own customizations</a> </span></dt> </dl></div><p><a class="link" href="https://ohmyz.sh/"  target="_top"><code class="literal">oh-my-zsh</code></a> is a framework to manage your <a class="link" href="https://www.zsh.org/"  target="_top">ZSH</a>
configuration including completion scripts for several CLI tools or custom
prompt themes.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-oh-my-zsh-usage" class="title" style="clear: both">Basic usage   </h2>  </div> </div></div><p>The module uses the <code class="literal">oh-my-zsh</code> package with all available
features. The initial setup using Nix expressions is fairly similar to the
configuration format of <code class="literal">oh-my-zsh</code>.</p><pre><code class="programlisting nix">{
  programs.zsh.ohMyZsh = {
    enable = true;
    plugins = [ &quot;git&quot; &quot;python&quot; &quot;man&quot; ];
    theme = &quot;agnoster&quot;;
  };
}
</code></pre><p>For a detailed explanation of these arguments please refer to the
<a class="link" href="https://github.com/robbyrussell/oh-my-zsh/wiki"  target="_top"><code class="literal">oh-my-zsh</code> docs</a>.</p><p>The expression generates the needed configuration and writes it into your
<code class="literal">/etc/zshrc</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-oh-my-zsh-additions" class="title" style="clear: both">Custom additions   </h2>  </div> </div></div><p>Sometimes third-party or custom scripts such as a modified theme may be
needed. <code class="literal">oh-my-zsh</code> provides the
<a class="link" href="https://github.com/robbyrussell/oh-my-zsh/wiki/Customization#overriding-internals"  target="_top"><code class="literal">ZSH_CUSTOM</code></a>
environment variable for this which points to a directory with additional
scripts.</p><p>The module can do this as well:</p><pre><code class="programlisting nix">{
  programs.zsh.ohMyZsh.custom = &quot;~/path/to/custom/scripts&quot;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-oh-my-zsh-environments" class="title" style="clear: both">Custom environments   </h2>  </div> </div></div><p>There are several extensions for <code class="literal">oh-my-zsh</code> packaged in
<code class="literal">nixpkgs</code>. One of them is
<a class="link" href="https://github.com/spwhitt/nix-zsh-completions"  target="_top">nix-zsh-completions</a>
which bundles completion scripts and a plugin for <code class="literal">oh-my-zsh</code>.</p><p>Rather than using a single mutable path for <code class="literal">ZSH_CUSTOM</code>,
it’s also possible to generate this path from a list of Nix packages:</p><pre><code class="programlisting nix">{ pkgs, ... }:
{
  programs.zsh.ohMyZsh.customPkgs = [
    pkgs.nix-zsh-completions
    # and even more...
  ];
}
</code></pre><p>Internally a single store path will be created using
<code class="literal">buildEnv</code>. Please refer to the docs of
<a class="link" href="https://nixos.org/nixpkgs/manual/#sec-building-environment"  target="_top"><code class="literal">buildEnv</code></a>
for further reference.</p><p><span class="emphasis"><em>Please keep in mind that this is not compatible with
<code class="literal">programs.zsh.ohMyZsh.custom</code> as it requires an immutable
store path while <code class="literal">custom</code> shall remain mutable! An
evaluation failure will be thrown if both <code class="literal">custom</code> and
<code class="literal">customPkgs</code> are set.</em></span></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-oh-my-zsh-packaging-customizations" class="title" style="clear: both">Package your own customizations   </h2>  </div> </div></div><p>If third-party customizations (e.g. new themes) are supposed to be added to
<code class="literal">oh-my-zsh</code> there are several pitfalls to keep in mind:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>To comply with the default structure of <code class="literal">ZSH</code> the entire
output needs to be written to <code class="literal">$out/share/zsh.</code></p></li><li class="listitem"><p>Completion scripts are supposed to be stored at
<code class="literal">$out/share/zsh/site-functions</code>. This directory is part of the
<a class="link" href="https://zsh.sourceforge.io/Doc/Release/Functions.html"  target="_top"><code class="literal">fpath</code></a>
and the package should be compatible with pure <code class="literal">ZSH</code>
setups. The module will automatically link the contents of
<code class="literal">site-functions</code> to completions directory in the proper
store path.</p></li><li class="listitem"><p>The <code class="literal">plugins</code> directory needs the structure
<code class="literal">pluginname/pluginname.plugin.zsh</code> as structured in the
<a class="link" href="https://github.com/robbyrussell/oh-my-zsh/tree/91b771914bc7c43dd7c7a43b586c5de2c225ceb7/plugins"  target="_top">upstream repo.</a></p></li></ul></div><p>A derivation for <code class="literal">oh-my-zsh</code> may look like this:</p><pre><code class="programlisting nix">{ stdenv, fetchFromGitHub }:

stdenv.mkDerivation rec {
  name = &quot;exemplary-zsh-customization-${version}&quot;;
  version = &quot;1.0.0&quot;;
  src = fetchFromGitHub {
    # path to the upstream repository
  };

  dontBuild = true;
  installPhase = &#x27;&#x27;
    mkdir -p $out/share/zsh/site-functions
    cp {themes,plugins} $out/share/zsh
    cp completions $out/share/zsh/site-functions
  &#x27;&#x27;;
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-program-plotinus" class="title" >Plotinus   </h2>  </div> </div></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/programs/plotinus.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://github.com/p-e-w/plotinus"  target="_top">https://github.com/p-e-w/plotinus</a></p><p>Plotinus is a searchable command palette in every modern GTK application.</p><p>When in a GTK 3 application and Plotinus is enabled, you can press
<code class="literal">Ctrl+Shift+P</code> to open the command palette. The command
palette provides a searchable list of of all menu items in the application.</p><p>To enable Plotinus, add the following to your
<code class="filename">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  programs.plotinus.enable = true;
}
</code></pre>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-digitalbitbox" class="title" >Digital Bitbox   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-digitalbitbox-package">Package</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-digitalbitbox-hardware-module">Hardware</a> </span></dt> </dl></div><p>Digital Bitbox is a hardware wallet and second-factor authenticator.</p><p>The <code class="literal">digitalbitbox</code> programs module may be installed by setting
<code class="literal">programs.digitalbitbox</code> to <code class="literal">true</code> in a manner similar to</p><pre><code class="programlisting nix">{
  programs.digitalbitbox.enable = true;
}
</code></pre><p>and bundles the <code class="literal">digitalbitbox</code> package (see <a class="xref" href="index.html#sec-digitalbitbox-package" title="Package" >the section called “Package”</a>),
which contains the <code class="literal">dbb-app</code> and <code class="literal">dbb-cli</code> binaries, along with the hardware
module (see <a class="xref" href="index.html#sec-digitalbitbox-hardware-module" title="Hardware" >the section called “Hardware”</a>) which sets up the necessary
udev rules to access the device.</p><p>Enabling the digitalbitbox module is pretty much the easiest way to get a
Digital Bitbox device working on your system.</p><p>For more information, see <a class="link" href="https://digitalbitbox.com/start_linux"  target="_top">https://digitalbitbox.com/start_linux</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-digitalbitbox-package" class="title" style="clear: both">Package   </h2>  </div> </div></div><p>The binaries, <code class="literal">dbb-app</code> (a GUI tool) and <code class="literal">dbb-cli</code> (a CLI tool), are available
through the <code class="literal">digitalbitbox</code> package which could be installed as follows:</p><pre><code class="programlisting nix">{
  environment.systemPackages = [
    pkgs.digitalbitbox
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-digitalbitbox-hardware-module" class="title" style="clear: both">Hardware   </h2>  </div> </div></div><p>The digitalbitbox hardware package enables the udev rules for Digital Bitbox
devices and may be installed as follows:</p><pre><code class="programlisting nix">{
  hardware.digitalbitbox.enable = true;
}
</code></pre><p>In order to alter the udev rules, one may provide different values for the
<code class="literal">udevRule51</code> and <code class="literal">udevRule52</code> attributes by means of overriding as follows:</p><pre><code class="programlisting nix">{
  programs.digitalbitbox = {
    enable = true;
    package = pkgs.digitalbitbox.override {
      udevRule51 = &quot;something else&quot;;
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods" class="title" >Input Methods   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-services-input-methods-ibus">IBus</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-input-methods-fcitx">Fcitx5</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-input-methods-nabi">Nabi</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-input-methods-uim">Uim</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-input-methods-hime">Hime</a> </span></dt><dt> <span class="section">  <a href="index.html#module-services-input-methods-kime">Kime</a> </span></dt> </dl></div><p>Input methods are an operating system component that allows any data, such as
keyboard strokes or mouse movements, to be received as input. In this way
users can enter characters and symbols not found on their input devices.
Using an input method is obligatory for any language that has more graphemes
than there are keys on the keyboard.</p><p>The following input methods are available in NixOS:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>IBus: The intelligent input bus.</p></li><li class="listitem"><p>Fcitx5: The next generation of fcitx, addons (including engines, dictionaries, skins) can be added using <code class="literal">i18n.inputMethod.fcitx5.addons</code>.</p></li><li class="listitem"><p>Nabi: A Korean input method based on XIM.</p></li><li class="listitem"><p>Uim: The universal input method, is a library with a XIM bridge.</p></li><li class="listitem"><p>Hime: An extremely easy-to-use input method framework.</p></li><li class="listitem"><p>Kime: Korean IME</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-ibus" class="title" style="clear: both">IBus   </h2>  </div> </div></div><p>IBus is an Intelligent Input Bus. It provides full featured and user
friendly input method user interface.</p><p>The following snippet can be used to configure IBus:</p><pre><code class="programlisting nix">{
  i18n.inputMethod = {
    enable = true;
    type = &quot;ibus&quot;;
    ibus.engines = with pkgs.ibus-engines; [ anthy hangul mozc ];
  };
}
</code></pre><p><code class="literal">i18n.inputMethod.ibus.engines</code> is optional and can be used
to add extra IBus engines.</p><p>Available extra IBus engines are:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Anthy (<code class="literal">ibus-engines.anthy</code>): Anthy is a system for
Japanese input method. It converts Hiragana text to Kana Kanji mixed text.</p></li><li class="listitem"><p>Hangul (<code class="literal">ibus-engines.hangul</code>): Korean input method.</p></li><li class="listitem"><p>libpinyin (<code class="literal">ibus-engines.libpinyin</code>): A Chinese input method.</p></li><li class="listitem"><p>m17n (<code class="literal">ibus-engines.m17n</code>): m17n is an input method that
uses input methods and corresponding icons in the m17n database.</p></li><li class="listitem"><p>mozc (<code class="literal">ibus-engines.mozc</code>): A Japanese input method from
Google.</p></li><li class="listitem"><p>Table (<code class="literal">ibus-engines.table</code>): An input method that load
tables of input methods.</p></li><li class="listitem"><p>table-others (<code class="literal">ibus-engines.table-others</code>): Various
table-based input methods. To use this, and any other table-based input
methods, it must appear in the list of engines along with
<code class="literal">table</code>. For example:</p><pre><code class="programlisting nix">{
  ibus.engines = with pkgs.ibus-engines; [ table table-others ];
}
</code></pre></li></ul></div><p>To use any input method, the package must be added in the configuration, as
shown above, and also (after running <code class="literal">nixos-rebuild</code>) the
input method must be added from IBus’ preference dialog.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-input-methods-troubleshooting" class="title" >Troubleshooting   </h3>  </div> </div></div><p>If IBus works in some applications but not others, a likely cause of this
is that IBus is depending on a different version of <code class="literal">glib</code>
to what the applications are depending on. This can be checked by running
<code class="literal">nix-store -q --requisites &lt;path&gt; | grep glib</code>,
where <code class="literal">&lt;path&gt;</code> is the path of either IBus or an
application in the Nix store. The <code class="literal">glib</code> packages must
match exactly. If they do not, uninstalling and reinstalling the
application is a likely fix.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-fcitx" class="title" style="clear: both">Fcitx5   </h2>  </div> </div></div><p>Fcitx5 is an input method framework with extension support. It has three
built-in Input Method Engine, Pinyin, QuWei and Table-based input methods.</p><p>The following snippet can be used to configure Fcitx:</p><pre><code class="programlisting nix">{
  i18n.inputMethod = {
    enable = true;
    type = &quot;fcitx5&quot;;
    fcitx5.addons = with pkgs; [ fcitx5-mozc fcitx5-hangul fcitx5-m17n ];
  };
}
</code></pre><p><code class="literal">i18n.inputMethod.fcitx5.addons</code> is optional and can be
used to add extra Fcitx5 addons.</p><p>Available extra Fcitx5 addons are:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Anthy (<code class="literal">fcitx5-anthy</code>): Anthy is a system for
Japanese input method. It converts Hiragana text to Kana Kanji mixed text.</p></li><li class="listitem"><p>Chewing (<code class="literal">fcitx5-chewing</code>): Chewing is an
intelligent Zhuyin input method. It is one of the most popular input
methods among Traditional Chinese Unix users.</p></li><li class="listitem"><p>Hangul (<code class="literal">fcitx5-hangul</code>): Korean input method.</p></li><li class="listitem"><p>Unikey (<code class="literal">fcitx5-unikey</code>): Vietnamese input method.</p></li><li class="listitem"><p>m17n (<code class="literal">fcitx5-m17n</code>): m17n is an input method that
uses input methods and corresponding icons in the m17n database.</p></li><li class="listitem"><p>mozc (<code class="literal">fcitx5-mozc</code>): A Japanese input method from
Google.</p></li><li class="listitem"><p>table-others (<code class="literal">fcitx5-table-other</code>): Various
table-based input methods.</p></li><li class="listitem"><p>chinese-addons (<code class="literal">fcitx5-chinese-addons</code>): Various chinese input methods.</p></li><li class="listitem"><p>rime (<code class="literal">fcitx5-rime</code>): RIME support for fcitx5.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-nabi" class="title" style="clear: both">Nabi   </h2>  </div> </div></div><p>Nabi is an easy to use Korean X input method. It allows you to enter
phonetic Korean characters (hangul) and pictographic Korean characters
(hanja).</p><p>The following snippet can be used to configure Nabi:</p><pre><code class="programlisting nix">{
  i18n.inputMethod = {
    enable = true;
    type = &quot;nabi&quot;;
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-uim" class="title" style="clear: both">Uim   </h2>  </div> </div></div><p>Uim (short for “universal input method”) is a multilingual input method
framework. Applications can use it through so-called bridges.</p><p>The following snippet can be used to configure uim:</p><pre><code class="programlisting nix">{
  i18n.inputMethod = {
    enable = true;
    type = &quot;uim&quot;;
  };
}
</code></pre><p>Note: The <a class="xref" href="options.html#opt-i18n.inputMethod.uim.toolbar"  ><code class="option">i18n.inputMethod.uim.toolbar</code></a> option can be
used to choose uim toolbar.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-hime" class="title" style="clear: both">Hime   </h2>  </div> </div></div><p>Hime is an extremely easy-to-use input method framework. It is lightweight,
stable, powerful and supports many commonly used input methods, including
Cangjie, Zhuyin, Dayi, Rank, Shrimp, Greek, Korean Pinyin, Latin Alphabet,
etc…</p><p>The following snippet can be used to configure Hime:</p><pre><code class="programlisting nix">{
  i18n.inputMethod = {
    enable = true;
    type = &quot;hime&quot;;
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-kime" class="title" style="clear: both">Kime   </h2>  </div> </div></div><p>Kime is Korean IME. it’s built with Rust language and let you get simple, safe, fast Korean typing</p><p>The following snippet can be used to configure Kime:</p><pre><code class="programlisting nix">{
  i18n.inputMethod = {
    enable = true;
    type = &quot;kime&quot;;
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="ch-profiles" class="title" >Profiles   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-profile-all-hardware">All Hardware</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-profile-base">Base</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-profile-clone-config">Clone Config</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-profile-demo">Demo</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-profile-docker-container">Docker Container</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-profile-graphical">Graphical</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-profile-hardened">Hardened</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-profile-headless">Headless</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-profile-installation-device">Installation Device</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-perlless">Perlless</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-profile-minimal">Minimal</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-profile-qemu-guest">QEMU Guest</a> </span></dt> </dl></div><p>In some cases, it may be desirable to take advantage of commonly-used,
predefined configurations provided by nixpkgs, but different from those
that come as default. This is a role fulfilled by NixOS’s Profiles,
which come as files living in <code class="literal">&lt;nixpkgs/nixos/modules/profiles&gt;</code>. That
is to say, expected usage is to add them to the imports list of your
<code class="literal">/etc/configuration.nix</code> as such:</p><pre><code class="programlisting nix">{
  imports = [
    &lt;nixpkgs/nixos/modules/profiles/profile-name.nix&gt;
  ];
}
</code></pre><p>Even if some of these profiles seem only useful in the context of
install media, many are actually intended to be used in real installs.</p><p>What follows is a brief explanation on the purpose and use-case for each
profile. Detailing each option configured by each one is out of scope.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-all-hardware" class="title" style="clear: both">All Hardware   </h2>  </div> </div></div><p>Enables all hardware supported by NixOS: i.e., all firmware is included, and
all devices from which one may boot are enabled in the initrd. Its primary
use is in the NixOS installation CDs.</p><p>The enabled kernel modules include support for SATA and PATA, SCSI
(partially), USB, Firewire (untested), Virtio (QEMU, KVM, etc.), VMware, and
Hyper-V. Additionally, <a class="xref" href="options.html#opt-hardware.enableAllFirmware"  ><code class="option">hardware.enableAllFirmware</code></a> is
enabled, and the firmware for the ZyDAS ZD1211 chipset is specifically
installed.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-base" class="title" style="clear: both">Base   </h2>  </div> </div></div><p>Defines the software packages included in the “minimal” installation CD. It
installs several utilities useful in a simple recovery or install media, such
as a text-mode web browser, and tools for manipulating block devices,
networking, hardware diagnostics, and filesystems (with their respective
kernel modules).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-clone-config" class="title" style="clear: both">Clone Config   </h2>  </div> </div></div><p>This profile is used in installer images. It provides an editable
configuration.nix that imports all the modules that were also used when
creating the image in the first place. As a result it allows users to edit
and rebuild the live-system.</p><p>On images where the installation media also becomes an installation target,
copying over <code class="literal">configuration.nix</code> should be disabled by
setting <code class="literal">installer.cloneConfig</code> to <code class="literal">false</code>.
For example, this is done in <code class="literal">sd-image-aarch64-installer.nix</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-demo" class="title" style="clear: both">Demo   </h2>  </div> </div></div><p>This profile just enables a <code class="literal">demo</code> user, with password <code class="literal">demo</code>, uid <code class="literal">1000</code>, <code class="literal">wheel</code> group and
<a class="link" href="options.html#opt-services.displayManager.autoLogin"  >autologin in the SDDM display manager</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-docker-container" class="title" style="clear: both">Docker Container   </h2>  </div> </div></div><p>This is the profile from which the Docker images are generated. It prepares a
working system by importing the <a class="link" href="index.html#sec-profile-minimal" title="Minimal" >Minimal</a> and
<a class="link" href="index.html#sec-profile-clone-config" title="Clone Config" >Clone Config</a> profiles, and
setting appropriate configuration options that are useful inside a container
context, like <a class="xref" href="options.html#opt-boot.isContainer"  ><code class="option">boot.isContainer</code></a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-graphical" class="title" style="clear: both">Graphical   </h2>  </div> </div></div><p>Defines a NixOS configuration with the Plasma 5 desktop. It’s used by the
graphical installation CD.</p><p>It sets <a class="xref" href="options.html#opt-services.xserver.enable"  ><code class="option">services.xserver.enable</code></a>,
<a class="xref" href="options.html#opt-services.displayManager.sddm.enable"  ><code class="option">services.displayManager.sddm.enable</code></a>,
<a class="xref" href="options.html#opt-services.xserver.desktopManager.plasma5.enable"  ><code class="option">services.xserver.desktopManager.plasma5.enable</code></a>,
and <a class="xref" href="options.html#opt-services.libinput.enable"  ><code class="option">services.libinput.enable</code></a> to true. It also
includes glxinfo and firefox in the system packages list.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-hardened" class="title" style="clear: both">Hardened   </h2>  </div> </div></div><p>A profile with most (vanilla) hardening options enabled by default,
potentially at the cost of stability, features and performance.</p><p>This includes a hardened kernel, and limiting the system information
available to processes through the <code class="literal">/sys</code> and
<code class="literal">/proc</code> filesystems. It also disables the User Namespaces
feature of the kernel, which stops Nix from being able to build anything
(this particular setting can be overridden via
<a class="xref" href="options.html#opt-security.allowUserNamespaces"  ><code class="option">security.allowUserNamespaces</code></a>). See the
<a class="link" href="https://github.com/nixos/nixpkgs/tree/master/nixos/modules/profiles/hardened.nix"  target="_top">profile source</a>
for further detail on which settings are altered.</p><div class="warning"><h3 class="title">Warning</h3><p>This profile enables options that are known to affect system
stability. If you experience any stability issues when using the
profile, try disabling it. If you report an issue and use this
profile, always mention that you do.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-headless" class="title" style="clear: both">Headless   </h2>  </div> </div></div><p>Common configuration for headless machines (e.g., Amazon EC2 instances).</p><p>Disables <a class="link" href="options.html#opt-boot.vesa"  >vesa</a>, serial consoles,
<a class="link" href="options.html#opt-systemd.enableEmergencyMode"  >emergency mode</a>,
<a class="link" href="options.html#opt-boot.loader.grub.splashImage"  >grub splash images</a>
and configures the kernel to reboot automatically on panic.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-installation-device" class="title" style="clear: both">Installation Device   </h2>  </div> </div></div><p>Provides a basic configuration for installation devices like CDs.
This enables redistributable firmware, includes the
<a class="link" href="index.html#sec-profile-clone-config" title="Clone Config" >Clone Config profile</a>
and a copy of the Nixpkgs channel, so <code class="literal">nixos-install</code>
works out of the box.</p><p>Documentation for <a class="link" href="options.html#opt-documentation.enable"  >Nixpkgs</a>
and <a class="link" href="options.html#opt-documentation.nixos.enable"  >NixOS</a> are
forcefully enabled (to override the
<a class="link" href="index.html#sec-profile-minimal" title="Minimal" >Minimal profile</a> preference); the
NixOS manual is shown automatically on TTY 8, udisks is disabled.
Autologin is enabled as <code class="literal">nixos</code> user, while passwordless
login as both <code class="literal">root</code> and <code class="literal">nixos</code> is possible.
Passwordless <code class="literal">sudo</code> is enabled too.
<a class="link" href="options.html#opt-networking.wireless.enable"  >wpa_supplicant</a> is
enabled, but configured to not autostart.</p><p>It is explained how to login, start the ssh server, and if available,
how to start the display manager.</p><p>Several settings are tweaked so that the installer has a better chance of
succeeding under low-memory environments.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-perlless" class="title" style="clear: both">Perlless   </h2>  </div> </div></div><p>Render your system completely perlless (i.e. without the perl interpreter). This
includes a mechanism so that your build fails if it contains a Nix store path
that references the string “perl”.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-minimal" class="title" style="clear: both">Minimal   </h2>  </div> </div></div><p>This profile defines a small NixOS configuration. It does not contain any
graphical stuff. It’s a very short file that sets the supported locales
to only support the user-selected locale, and
<a class="link" href="options.html#opt-documentation.enable"  >disables packages’ documentation</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-qemu-guest" class="title" style="clear: both">QEMU Guest   </h2>  </div> </div></div><p>This profile contains common configuration for virtual machines running under
QEMU (using virtio).</p><p>It makes virtio modules available on the initrd and sets the system time from
the hardware clock to work around a bug in qemu-kvm.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-mattermost" class="title" >Mattermost   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-mattermost-derivation">Using the Mattermost derivation</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-mattermost-plugins">Using Mattermost plugins</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-mattermost-plugins-build">Building Mattermost plugins</a> </span></dt> </dl></div><p>The NixOS Mattermost module lets you build <a class="link" href="https://mattermost.com"  target="_top">Mattermost</a>
instances for collaboration over chat, optionally with custom builds of plugins
specific to your instance.</p><p>To enable Mattermost using Postgres, use a config like this:</p><pre><code class="programlisting nix">{
  services.mattermost = {
    enable = true;

    # You can change this if you are reverse proxying.
    host = &quot;0.0.0.0&quot;;
    port = 8065;

    # Allow modifications to the config from Mattermost.
    mutableConfig = true;

    # Override modifications to the config with your NixOS config.
    preferNixConfig = true;

    socket = {
      # Enable control with the `mmctl` socket.
      enable = true;

      # Exporting the control socket will add `mmctl` to your PATH, and export
      # MMCTL_LOCAL_SOCKET_PATH systemwide. Otherwise, you can get the socket
      # path out of `config.mattermost.socket.path` and set it manually.
      export = true;
    };

    # For example, to disable auto-installation of prepackaged plugins.
    settings.PluginSettings.AutomaticPrepackagedPlugins = false;
  }
}
</code></pre><p>As of NixOS 25.05, Mattermost uses peer authentication with Postgres or
MySQL by default. If you previously used password auth on localhost,
this will automatically be configured if your <code class="literal">stateVersion</code> is set to at least
<code class="literal">25.05</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-mattermost-derivation" class="title" style="clear: both">Using the Mattermost derivation   </h2>  </div> </div></div><p>The nixpkgs <code class="literal">mattermost</code> derivation runs the entire test suite during the
<code class="literal">checkPhase</code>. This test suite is run with a live MySQL and Postgres database
instance in the sandbox. If you are building Mattermost, this can take a while,
especially if it is building on a resource-constrained system.</p><p>The following passthrus are designed to assist with enabling or disabling
the <code class="literal">checkPhase</code>:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">mattermost.withTests</code></p></li><li class="listitem"><p><code class="literal">mattermost.withoutTests</code></p></li></ul></div><p>The default (<code class="literal">mattermost</code>) is an alias for <code class="literal">mattermost.withTests</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-mattermost-plugins" class="title" style="clear: both">Using Mattermost plugins   </h2>  </div> </div></div><p>You can configure Mattermost plugins by either using prebuilt binaries or by
building your own. We test building and using plugins in the NixOS test suite.</p><p>Mattermost plugins are tarballs containing a system-specific statically linked
Go binary and webapp resources.</p><p>Here is an example with a prebuilt plugin tarball:</p><pre><code class="programlisting nix">{
  services.mattermost = {
    plugins = with pkgs; [
      /*
       * todo
       * 0.7.1
       * https://github.com/mattermost/mattermost-plugin-todo/releases/tag/v0.7.1
       */
      (fetchurl {
        # Note: Don&#x27;t unpack the tarball; the NixOS module will repack it for you.
        url = &quot;https://github.com/mattermost-community/mattermost-plugin-todo/releases/download/v0.7.1/com.mattermost.plugin-todo-0.7.1.tar.gz&quot;;
        hash = &quot;sha256-P+Z66vqE7FRmc2kTZw9FyU5YdLLbVlcJf11QCbfeJ84=&quot;;
      })
    ];
  };
}
</code></pre><p>Once the plugin is installed and the config rebuilt, you can enable this plugin
in the System Console.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-mattermost-plugins-build" class="title" style="clear: both">Building Mattermost plugins   </h2>  </div> </div></div><p>The <code class="literal">mattermost</code> derivation includes the <code class="literal">buildPlugin</code> passthru for building
plugins that use the “standard” Mattermost plugin build template at
<a class="link" href="https://github.com/mattermost/mattermost-plugin-demo"  target="_top">mattermost-plugin-demo</a>.</p><p>Since this is a “de facto” standard for building Mattermost plugins that makes
assumptions about the build environment, the <code class="literal">buildPlugin</code> helper tries to fit
these assumptions the best it can.</p><p>Here is how to build the above Todo plugin. Note that we rely on
package-lock.json being assembled correctly, so must use a version where it is!
If there is no lockfile or the lockfile is incorrect, Nix cannot fetch NPM build
and runtime dependencies for a sandbox build.</p><pre><code class="programlisting nix">{
  services.mattermost = {
    plugins = with pkgs; [
      (mattermost.buildPlugin {
        pname = &quot;mattermost-plugin-todo&quot;;
        version = &quot;0.8-pre&quot;;
        src = fetchFromGitHub {
          owner = &quot;mattermost-community&quot;;
          repo = &quot;mattermost-plugin-todo&quot;;
          # 0.7.1 didn&#x27;t work, seems to use an older set of node dependencies.
          rev = &quot;f25dc91ea401c9f0dcd4abcebaff10eb8b9836e5&quot;;
          hash = &quot;sha256-OM+m4rTqVtolvL5tUE8RKfclqzoe0Y38jLU60Pz7+HI=&quot;;
        };
        vendorHash = &quot;sha256-5KpechSp3z/Nq713PXYruyNxveo6CwrCSKf2JaErbgg=&quot;;
        npmDepsHash = &quot;sha256-o2UOEkwb8Vx2lDWayNYgng0GXvmS6lp/ExfOq3peyMY=&quot;;
        extraGoModuleAttrs = {
          npmFlags = [ &quot;--legacy-peer-deps&quot; ];
        };
      })
    ];
  };
}
</code></pre><p>See <code class="literal">pkgs/by-name/ma/mattermost/build-plugin.nix</code> for all the options.
As in the previous example, once the plugin is installed and the config rebuilt,
you can enable this plugin in the System Console.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-kubernetes" class="title" >Kubernetes   </h2>  </div> </div></div><p>The NixOS Kubernetes module is a collective term for a handful of
individual submodules implementing the Kubernetes cluster components.</p><p>There are generally two ways of enabling Kubernetes on NixOS. One way is
to enable and configure cluster components appropriately by hand:</p><pre><code class="programlisting nix">{
  services.kubernetes = {
    apiserver.enable = true;
    controllerManager.enable = true;
    scheduler.enable = true;
    addonManager.enable = true;
    proxy.enable = true;
    flannel.enable = true;
  };
}
</code></pre><p>Another way is to assign cluster roles (“master” and/or “node”) to
the host. This enables apiserver, controllerManager, scheduler,
addonManager, kube-proxy and etcd:</p><pre><code class="programlisting nix">{
  services.kubernetes.roles = [ &quot;master&quot; ];
}
</code></pre><p>While this will enable the kubelet and kube-proxy only:</p><pre><code class="programlisting nix">{
  services.kubernetes.roles = [ &quot;node&quot; ];
}
</code></pre><p>Assigning both the master and node roles is usable if you want a single
node Kubernetes cluster for dev or testing purposes:</p><pre><code class="programlisting nix">{
  services.kubernetes.roles = [ &quot;master&quot; &quot;node&quot; ];
}
</code></pre><p>Note: Assigning either role will also default both
<a class="xref" href="options.html#opt-services.kubernetes.flannel.enable"  ><code class="option">services.kubernetes.flannel.enable</code></a>
and <a class="xref" href="options.html#opt-services.kubernetes.easyCerts"  ><code class="option">services.kubernetes.easyCerts</code></a>
to true. This sets up flannel as CNI and activates automatic PKI bootstrapping.</p><div class="note"><h3 class="title">Note</h3><p>It is mandatory to configure:
<a class="xref" href="options.html#opt-services.kubernetes.masterAddress"  ><code class="option">services.kubernetes.masterAddress</code></a>.
The masterAddress must be resolveable and routeable by all cluster nodes.
In single node clusters, this can be set to <code class="literal">localhost</code>.</p></div><p>Role-based access control (RBAC) authorization mode is enabled by
default. This means that anonymous requests to the apiserver secure port
will expectedly cause a permission denied error. All cluster components
must therefore be configured with x509 certificates for two-way tls
communication. The x509 certificate subject section determines the roles
and permissions granted by the apiserver to perform clusterwide or
namespaced operations. See also: <a class="link" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/"  target="_top"> Using RBAC
Authorization</a>.</p><p>The NixOS kubernetes module provides an option for automatic certificate
bootstrapping and configuration,
<a class="xref" href="options.html#opt-services.kubernetes.easyCerts"  ><code class="option">services.kubernetes.easyCerts</code></a>.
The PKI bootstrapping process involves setting up a certificate authority (CA)
daemon (cfssl) on the kubernetes master node. cfssl generates a CA-cert
for the cluster, and uses the CA-cert for signing subordinate certs issued
to each of the cluster components. Subsequently, the certmgr daemon monitors
active certificates and renews them when needed. For single node Kubernetes
clusters, setting <a class="xref" href="options.html#opt-services.kubernetes.easyCerts"  ><code class="option">services.kubernetes.easyCerts</code></a>
= true is sufficient and no further action is required. For joining extra node
machines to an existing cluster on the other hand, establishing initial
trust is mandatory.</p><p>To add new nodes to the cluster: On any (non-master) cluster node where
<a class="xref" href="options.html#opt-services.kubernetes.easyCerts"  ><code class="option">services.kubernetes.easyCerts</code></a>
is enabled, the helper script <code class="literal">nixos-kubernetes-node-join</code> is available on PATH.
Given a token on stdin, it will copy the token to the kubernetes secrets directory
and restart the certmgr service. As requested certificates are issued, the
script will restart kubernetes cluster components as needed for them to
pick up new keypairs.</p><div class="note"><h3 class="title">Note</h3><p>Multi-master (HA) clusters are not supported by the easyCerts module.</p></div><p>In order to interact with an RBAC-enabled cluster as an administrator,
one needs to have cluster-admin privileges. By default, when easyCerts
is enabled, a cluster-admin kubeconfig file is generated and linked into
<code class="literal">/etc/kubernetes/cluster-admin.kubeconfig</code> as determined by
<a class="xref" href="options.html#opt-services.kubernetes.pki.etcClusterAdminKubeconfig"  ><code class="option">services.kubernetes.pki.etcClusterAdminKubeconfig</code></a>.
<code class="literal">export KUBECONFIG=/etc/kubernetes/cluster-admin.kubeconfig</code> will make
kubectl use this kubeconfig to access and authenticate the cluster. The
cluster-admin kubeconfig references an auto-generated keypair owned by
root. Thus, only root on the kubernetes master may obtain cluster-admin
rights by means of this file.</p>
</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="ch-running" class="title" >Administration   </h1>  </div> </div></div><div class="partintro"><p>This chapter describes various aspects of managing a running NixOS system, such as how to use the <span class="command"><strong>systemd</strong></span> service manager.</p><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#sec-systemctl">Service Management</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-rebooting">Rebooting and Shutting Down</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-user-sessions">User Sessions</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-cgroups">Control Groups</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-logging">Logging</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-system-state">Necessary system state</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-nix-gc">Cleaning the Nix Store</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-containers">Container Management</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-troubleshooting">Troubleshooting</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-systemctl" class="title" >Service Management   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sect-nixos-systemd-general">Interacting with a running systemd</a> </span></dt><dt> <span class="section">  <a href="index.html#sect-nixos-systemd-nixos">systemd in NixOS</a> </span></dt><dt> <span class="section">  <a href="index.html#sect-nixos-systemd-template-units">Template units</a> </span></dt> </dl></div><p>In NixOS, all system services are started and monitored using the
systemd program. systemd is the “init” process of the system (i.e. PID
1), the parent of all other processes. It manages a set of so-called
“units”, which can be things like system services (programs), but also
mount points, swap files, devices, targets (groups of units) and more.
Units can have complex dependencies; for instance, one unit can require
that another unit must be successfully started before the first unit can
be started. When the system boots, it starts a unit named
<code class="literal">default.target</code>; the dependencies of this unit cause all system
services to be started, file systems to be mounted, swap files to be
activated, and so on.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sect-nixos-systemd-general" class="title" style="clear: both">Interacting with a running systemd   </h2>  </div> </div></div><p>The command <code class="literal">systemctl</code> is the main way to interact with <code class="literal">systemd</code>. The
following paragraphs demonstrate ways to interact with any OS running
systemd as init system. NixOS is of no exception. The <a class="link" href="index.html#sect-nixos-systemd-nixos" title="systemd in NixOS" >next section
</a> explains NixOS specific things worth
knowing.</p><p>Without any arguments, <code class="literal">systemctl</code> the status of active units:</p><pre><code class="programlisting ShellSession">$ systemctl
-.mount          loaded active mounted   /
swapfile.swap    loaded active active    /swapfile
sshd.service     loaded active running   SSH Daemon
graphical.target loaded active active    Graphical Interface
...
</code></pre><p>You can ask for detailed status information about a unit, for instance,
the PostgreSQL database service:</p><pre><code class="programlisting ShellSession">$ systemctl status postgresql.service
postgresql.service - PostgreSQL Server
          Loaded: loaded (/nix/store/pn3q73mvh75gsrl8w7fdlfk3fq5qm5mw-unit/postgresql.service)
          Active: active (running) since Mon, 2013-01-07 15:55:57 CET; 9h ago
        Main PID: 2390 (postgres)
          CGroup: name=systemd:/system/postgresql.service
                  ├─2390 postgres
                  ├─2418 postgres: writer process
                  ├─2419 postgres: wal writer process
                  ├─2420 postgres: autovacuum launcher process
                  ├─2421 postgres: stats collector process
                  └─2498 postgres: zabbix zabbix [local] idle

Jan 07 15:55:55 hagbard postgres[2394]: [1-1] LOG:  database system was shut down at 2013-01-07 15:55:05 CET
Jan 07 15:55:57 hagbard postgres[2390]: [1-1] LOG:  database system is ready to accept connections
Jan 07 15:55:57 hagbard postgres[2420]: [1-1] LOG:  autovacuum launcher started
Jan 07 15:55:57 hagbard systemd[1]: Started PostgreSQL Server.
</code></pre><p>Note that this shows the status of the unit (active and running), all
the processes belonging to the service, as well as the most recent log
messages from the service.</p><p>Units can be stopped, started or restarted:</p><pre><code class="programlisting ShellSession"># systemctl stop postgresql.service
# systemctl start postgresql.service
# systemctl restart postgresql.service
</code></pre><p>These operations are synchronous: they wait until the service has
finished starting or stopping (or has failed). Starting a unit will
cause the dependencies of that unit to be started as well (if
necessary).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sect-nixos-systemd-nixos" class="title" style="clear: both">systemd in NixOS   </h2>  </div> </div></div><p>Packages in Nixpkgs sometimes provide systemd units with them, usually
in e.g <code class="literal">#pkg-out#/lib/systemd/</code>. Putting such a package in
<code class="literal">environment.systemPackages</code> doesn’t make the service available to
users or the system.</p><p>In order to enable a systemd <span class="emphasis"><em>system</em></span> service with provided upstream
package, use (e.g):</p><pre><code class="programlisting nix">{
  systemd.packages = [ pkgs.packagekit ];
}
</code></pre><p>Usually NixOS modules written by the community do the above, plus take
care of other details. If a module was written for a service you are
interested in, you’d probably need only to use
<code class="literal">services.#name#.enable = true;</code>. These services are defined in
Nixpkgs’ <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/modules"  target="_top"> <code class="literal">nixos/modules/</code> directory
</a>. In case
the service is simple enough, the above method should work, and start
the service on boot.</p><p><span class="emphasis"><em>User</em></span> systemd services on the other hand, should be treated
differently. Given a package that has a systemd unit file at
<code class="literal">#pkg-out#/lib/systemd/user/</code>, using <a class="xref" href="options.html#opt-systemd.packages"  ><code class="option">systemd.packages</code></a> will
make you able to start the service via <code class="literal">systemctl --user start</code>, but it
won’t start automatically on login. However, You can imperatively
enable it by adding the package’s attribute to
<a class="xref" href="options.html#opt-systemd.packages"  ><code class="option">systemd.packages</code></a> and then do this (e.g):</p><pre><code class="programlisting ShellSession">$ mkdir -p ~/.config/systemd/user/default.target.wants
$ ln -s /run/current-system/sw/lib/systemd/user/syncthing.service ~/.config/systemd/user/default.target.wants/
$ systemctl --user daemon-reload
$ systemctl --user enable syncthing.service
</code></pre><p>If you are interested in a timer file, use <code class="literal">timers.target.wants</code> instead
of <code class="literal">default.target.wants</code> in the 1st and 2nd command.</p><p>Using <code class="literal">systemctl --user enable syncthing.service</code> instead of the above,
will work, but it’ll use the absolute path of <code class="literal">syncthing.service</code> for
the symlink, and this path is in <code class="literal">/nix/store/.../lib/systemd/user/</code>.
Hence <a class="link" href="index.html#sec-nix-gc" title="Cleaning the Nix Store" >garbage collection</a> will remove that file and you
will wind up with a broken symlink in your systemd configuration, which
in turn will not make the service / timer start on login.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sect-nixos-systemd-template-units" class="title" style="clear: both">Template units   </h2>  </div> </div></div><p>systemd supports templated units where a base unit can be started multiple
times with a different parameter. The syntax to accomplish this is
<code class="literal">service-name@instance-name.service</code>. Units get the instance name passed to
them (see <code class="literal">systemd.unit(5)</code>). NixOS has support for these kinds of units and
for template-specific overrides. A service needs to be defined twice, once
for the base unit and once for the instance. All instances must include
<code class="literal">overrideStrategy = &quot;asDropin&quot;</code> for the change detection to work. This
example illustrates this:</p><pre><code class="programlisting nix">{
  systemd.services = {
    &quot;base-unit@&quot;.serviceConfig = {
      ExecStart = &quot;...&quot;;
      User = &quot;...&quot;;
    };
    &quot;base-unit@instance-a&quot; = {
      overrideStrategy = &quot;asDropin&quot;; # needed for templates to work
      wantedBy = [ &quot;multi-user.target&quot; ]; # causes NixOS to manage the instance
    };
    &quot;base-unit@instance-b&quot; = {
      overrideStrategy = &quot;asDropin&quot;; # needed for templates to work
      wantedBy = [ &quot;multi-user.target&quot; ]; # causes NixOS to manage the instance
      serviceConfig.User = &quot;root&quot;; # also override something for this specific instance
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-rebooting" class="title" >Rebooting and Shutting Down   </h2>  </div> </div></div><p>The system can be shut down (and automatically powered off) by doing:</p><pre><code class="programlisting ShellSession"># shutdown
</code></pre><p>This is equivalent to running <code class="literal">systemctl poweroff</code>.</p><p>To reboot the system, run</p><pre><code class="programlisting ShellSession"># reboot
</code></pre><p>which is equivalent to <code class="literal">systemctl reboot</code>. Alternatively, you can
quickly reboot the system using <code class="literal">kexec</code>, which bypasses the BIOS by
directly loading the new kernel into memory:</p><pre><code class="programlisting ShellSession"># systemctl kexec
</code></pre><p>The machine can be suspended to RAM (if supported) using <code class="literal">systemctl suspend</code>,
and suspended to disk using <code class="literal">systemctl hibernate</code>.</p><p>These commands can be run by any user who is logged in locally, i.e. on
a virtual console or in X11; otherwise, the user is asked for
authentication.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-user-sessions" class="title" >User Sessions   </h2>  </div> </div></div><p>Systemd keeps track of all users who are logged into the system (e.g. on
a virtual console or remotely via SSH). The command <code class="literal">loginctl</code> allows
querying and manipulating user sessions. For instance, to list all user
sessions:</p><pre><code class="programlisting ShellSession">$ loginctl
   SESSION        UID USER             SEAT
        c1        500 eelco            seat0
        c3          0 root             seat0
        c4        500 alice
</code></pre><p>This shows that two users are logged in locally, while another is logged
in remotely. (“Seats” are essentially the combinations of displays and
input devices attached to the system; usually, there is only one seat.)
To get information about a session:</p><pre><code class="programlisting ShellSession">$ loginctl session-status c3
c3 - root (0)
           Since: Tue, 2013-01-08 01:17:56 CET; 4min 42s ago
          Leader: 2536 (login)
            Seat: seat0; vc3
             TTY: /dev/tty3
         Service: login; type tty; class user
           State: online
          CGroup: name=systemd:/user/root/c3
                  ├─ 2536 /nix/store/10mn4xip9n7y9bxqwnsx7xwx2v2g34xn-shadow-4.1.5.1/bin/login --
                  ├─10339 -bash
                  └─10355 w3m nixos.org
</code></pre><p>This shows that the user is logged in on virtual console 3. It also
lists the processes belonging to this session. Since systemd keeps track
of this, you can terminate a session in a way that ensures that all the
session’s processes are gone:</p><pre><code class="programlisting ShellSession"># loginctl terminate-session c3
</code></pre>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-cgroups" class="title" >Control Groups   </h2>  </div> </div></div><p>To keep track of the processes in a running system, systemd uses
<span class="emphasis"><em>control groups</em></span> (cgroups). A control group is a set of processes used
to allocate resources such as CPU, memory or I/O bandwidth. There can be
multiple control group hierarchies, allowing each kind of resource to be
managed independently.</p><p>The command <code class="literal">systemd-cgls</code> lists all control groups in the <code class="literal">systemd</code>
hierarchy, which is what systemd uses to keep track of the processes
belonging to each service or user session:</p><pre><code class="programlisting ShellSession">$ systemd-cgls
├─user
│ └─eelco
│   └─c1
│     ├─ 2567 -:0
│     ├─ 2682 kdeinit4: kdeinit4 Running...
│     ├─ ...
│     └─10851 sh -c less -R
└─system
  ├─httpd.service
  │ ├─2444 httpd -f /nix/store/3pyacby5cpr55a03qwbnndizpciwq161-httpd.conf -DNO_DETACH
  │ └─...
  ├─dhcpcd.service
  │ └─2376 dhcpcd --config /nix/store/f8dif8dsi2yaa70n03xir8r653776ka6-dhcpcd.conf
  └─ ...
</code></pre><p>Similarly, <code class="literal">systemd-cgls cpu</code> shows the cgroups in the CPU hierarchy,
which allows per-cgroup CPU scheduling priorities. By default, every
systemd service gets its own CPU cgroup, while all user sessions are in
the top-level CPU cgroup. This ensures, for instance, that a thousand
run-away processes in the <code class="literal">httpd.service</code> cgroup cannot starve the CPU
for one process in the <code class="literal">postgresql.service</code> cgroup. (By contrast, it
they were in the same cgroup, then the PostgreSQL process would get
1/1001 of the cgroup’s CPU time.) You can limit a service’s CPU share in
<code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  systemd.services.httpd.serviceConfig.CPUShares = 512;
}
</code></pre><p>By default, every cgroup has 1024 CPU shares, so this will halve the CPU
allocation of the <code class="literal">httpd.service</code> cgroup.</p><p>There also is a <code class="literal">memory</code> hierarchy that controls memory allocation
limits; by default, all processes are in the top-level cgroup, so any
service or session can exhaust all available memory. Per-cgroup memory
limits can be specified in <code class="literal">configuration.nix</code>; for instance, to limit
<code class="literal">httpd.service</code> to 512 MiB of RAM (excluding swap):</p><pre><code class="programlisting nix">{
  systemd.services.httpd.serviceConfig.MemoryLimit = &quot;512M&quot;;
}
</code></pre><p>The command <code class="literal">systemd-cgtop</code> shows a continuously updated list of all
cgroups with their CPU and memory usage.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-logging" class="title" >Logging   </h2>  </div> </div></div><p>System-wide logging is provided by systemd’s <span class="emphasis"><em>journal</em></span>, which subsumes
traditional logging daemons such as syslogd and klogd. Log entries are
kept in binary files in <code class="literal">/var/log/journal/</code>. The command <code class="literal">journalctl</code>
allows you to see the contents of the journal. For example,</p><pre><code class="programlisting ShellSession">$ journalctl -b
</code></pre><p>shows all journal entries since the last reboot. (The output of
<code class="literal">journalctl</code> is piped into <code class="literal">less</code> by default.) You can use various
options and match operators to restrict output to messages of interest.
For instance, to get all messages from PostgreSQL:</p><pre><code class="programlisting ShellSession">$ journalctl -u postgresql.service
-- Logs begin at Mon, 2013-01-07 13:28:01 CET, end at Tue, 2013-01-08 01:09:57 CET. --
...
Jan 07 15:44:14 hagbard postgres[2681]: [2-1] LOG:  database system is shut down
-- Reboot --
Jan 07 15:45:10 hagbard postgres[2532]: [1-1] LOG:  database system was shut down at 2013-01-07 15:44:14 CET
Jan 07 15:45:13 hagbard postgres[2500]: [1-1] LOG:  database system is ready to accept connections
</code></pre><p>Or to get all messages since the last reboot that have at least a
“critical” severity level:</p><pre><code class="programlisting ShellSession">$ journalctl -b -p crit
Dec 17 21:08:06 mandark sudo[3673]: pam_unix(sudo:auth): auth could not identify password for [alice]
Dec 29 01:30:22 mandark kernel[6131]: [1053513.909444] CPU6: Core temperature above threshold, cpu clock throttled (total events = 1)
</code></pre><p>The system journal is readable by root and by users in the <code class="literal">wheel</code> and
<code class="literal">systemd-journal</code> groups. All users have a private journal that can be
read using <code class="literal">journalctl</code>.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="ch-system-state" class="title" >Necessary system state   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-nixos-state">NixOS</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-systemd-state">systemd</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-zfs-state">ZFS</a> </span></dt> </dl></div><p>Normally — on systems with a persistent <code class="literal">rootfs</code> — system services can persist state to
the filesystem without administrator intervention.</p><p>However, it is possible and not-uncommon to create <a class="link" href="https://wiki.nixos.org/wiki/Impermanence"  target="_top">impermanent systems</a>, whose
<code class="literal">rootfs</code> is either a <code class="literal">tmpfs</code> or reset during boot. While NixOS itself supports
this kind of configuration, special care needs to be taken.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-nixos-state" class="title" style="clear: both">NixOS   </h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-state-nix" class="title" ><code class="literal">/nix</code>   </h3>  </div> </div></div><p>NixOS needs the entirety of <code class="literal">/nix</code> to be persistent, as it includes:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">/nix/store</code>, which contains all the system’s executables, libraries, and supporting data;</p></li><li class="listitem"><p><code class="literal">/nix/var/nix</code>, which contains:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>the Nix daemon’s database;</p></li><li class="listitem"><p>roots whose transitive closure is preserved when garbage-collecting the Nix store;</p></li><li class="listitem"><p>system-wide and per-user profiles.</p></li></ul></div></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-state-boot" class="title" ><code class="literal">/boot</code>   </h3>  </div> </div></div><p><code class="literal">/boot</code> should also be persistent, as it contains:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>the kernel and initrd which the bootloader loads,</p></li><li class="listitem"><p>the bootloader’s configuration, including the kernel’s command-line which
determines the store path to use as system environment.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-state-users" class="title" >Users and groups   </h3>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">/var/lib/nixos</code> should persist: it holds state needed to generate stable
uids and gids for declaratively-managed users and groups, etc.</p></li><li class="listitem"><p><code class="literal">users.mutableUsers</code> should be false, <span class="emphasis"><em>or</em></span> the following files under <code class="literal">/etc</code>
should all persist:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><a class="link" href="https://man.archlinux.org/man/passwd.5" target="_top"><span class="citerefentry"><span class="refentrytitle">passwd</span>(5)</span></a> and <a class="link" href="https://man.archlinux.org/man/group.5" target="_top"><span class="citerefentry"><span class="refentrytitle">group</span>(5)</span></a>,</p></li><li class="listitem"><p><span class="citerefentry"><span class="refentrytitle">shadow</span>(5)</span> and <span class="citerefentry"><span class="refentrytitle">gshadow</span>(5)</span>,</p></li><li class="listitem"><p><span class="citerefentry"><span class="refentrytitle">subuid</span>(5)</span> and <span class="citerefentry"><span class="refentrytitle">subgid</span>(5)</span>.</p></li></ul></div></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-systemd-state" class="title" style="clear: both">systemd   </h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-machine-id" class="title" ><code class="literal">machine-id(5)</code>   </h3>  </div> </div></div><p><code class="literal">systemd</code> uses per-machine identifier — <a class="link" href="https://www.freedesktop.org/software/systemd/man/machine-id.html" target="_top"><span class="citerefentry"><span class="refentrytitle">machine-id</span>(5)</span></a> — which must be
unique and persistent; otherwise, the system journal may fail to list earlier
boots, etc.</p><p><code class="literal">systemd</code> generates a random <code class="literal">machine-id(5)</code> during boot if it does not already exist,
and persists it in <code class="literal">/etc/machine-id</code>.  As such, it suffices to make that file persistent.</p><p>Alternatively, it is possible to generate a random <code class="literal">machine-id(5)</code>; while the
specification allows for <span class="emphasis"><em>any</em></span> hex-encoded 128b value, systemd itself uses
<a class="link" href="https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_(random)"  target="_top">UUIDv4</a>, <span class="emphasis"><em>i.e.</em></span> random UUIDs, and it is thus preferable to do so as well, in
case some software assumes <code class="literal">machine-id(5)</code> to be a UUIDv4. Those can be
generated with <code class="literal">uuidgen -r | tr -d -</code> (<code class="literal">tr</code> being used to remove the dashes).</p><p>Such a <code class="literal">machine-id(5)</code> can be set by writing it to <code class="literal">/etc/machine-id</code> or through
the kernel’s command-line, though NixOS’ systemd maintainers <a class="link" href="https://github.com/NixOS/nixpkgs/pull/268995"  target="_top">discourage</a> the
latter approach.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-var-systemd" class="title" ><code class="literal">/var/lib/systemd</code>   </h3>  </div> </div></div><p>Moreover, <code class="literal">systemd</code> expects its state directory — <code class="literal">/var/lib/systemd</code> — to persist, for:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-random-seed.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd-random-seed</span>(8)</span></a>, which loads a 256b “seed” into the kernel’s RNG
at boot time, and saves a fresh one during shutdown;</p></li><li class="listitem"><p><a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd.timer.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd.timer</span>(5)</span></a> with <code class="literal">Persistent=yes</code>, which are then run after boot if
the timer would have triggered during the time the system was shut down;</p></li><li class="listitem"><p><a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-coredump.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd-coredump</span>(8)</span></a> to store core dumps there by default;
(see <a class="link" href="https://www.freedesktop.org/software/systemd/man/coredump.conf.html" target="_top"><span class="citerefentry"><span class="refentrytitle">coredump.conf</span>(5)</span></a>)</p></li><li class="listitem"><p><a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-timesyncd.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd-timesyncd</span>(8)</span></a>;</p></li><li class="listitem"><p><a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-backlight.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd-backlight</span>(8)</span></a> and <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-rfkill.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd-rfkill</span>(8)</span></a> persist hardware-related
state;</p></li><li class="listitem"><p>possibly other things, this list is not meant to be exhaustive.</p></li></ul></div><p>In any case, making <code class="literal">/var/lib/systemd</code> persistent is recommended.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-var-journal" class="title" ><code class="literal">/var/log/journal/{machine-id}</code>   </h3>  </div> </div></div><p>Lastly, <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-journald.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd-journald</span>(8)</span></a> writes the system’s journal in binary
form to <code class="literal">/var/log/journal/{machine-id}</code>; if (locally) persisting the entire log
is desired, it is recommended to make all of <code class="literal">/var/log/journal</code> persistent.</p><p>If not, one can set <code class="literal">Storage=volatile</code> in <a class="link" href="https://www.freedesktop.org/software/systemd/man/journald.conf.html" target="_top"><span class="citerefentry"><span class="refentrytitle">journald.conf</span>(5)</span></a>
(<a class="link" href="options.html#opt-services.journald.storage"  ><code class="literal">services.journald.storage = &quot;volatile&quot;;</code></a>),
which disables journal persistence and causes it to be written to
<code class="literal">/run/log/journal</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-zfs-state" class="title" style="clear: both">ZFS   </h2>  </div> </div></div><p>When using ZFS, <code class="literal">/etc/zfs/zpool.cache</code> should be persistent (or a symlink to a persistent
location) as it is the default value for the <code class="literal">cachefile</code> <a class="link" href="man:zpoolprops(7)"  target="_top">property</a>.</p><p>This cachefile is used on system startup to discover ZFS pools, so ZFS pools
holding the <code class="literal">rootfs</code> and/or early-boot datasets such as <code class="literal">/nix</code> can be set to
<code class="literal">cachefile=none</code>.</p><p>In principle, if there are no other pools attached to the system, <code class="literal">zpool.cache</code>
does not need to be persisted; it is however <span class="emphasis"><em>strongly recommended</em></span> to persist
it, in case additional pools are added later on, temporarily or permanently:</p><p>While mishandling the cachefile does not lead to data loss by itself, it may
cause zpools not to be imported during boot, and services may then write to a
location where a dataset was expected to be mounted.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-nix-gc" class="title" >Cleaning the Nix Store   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sect-nixos-gc-boot-entries">NixOS Boot Entries</a> </span></dt> </dl></div><p>Nix has a purely functional model, meaning that packages are never
upgraded in place. Instead new versions of packages end up in a
different location in the Nix store (<code class="literal">/nix/store</code>). You should
periodically run Nix’s <span class="emphasis"><em>garbage collector</em></span> to remove old, unreferenced
packages. This is easy:</p><pre><code class="programlisting ShellSession">$ nix-collect-garbage
</code></pre><p>Alternatively, you can use a systemd unit that does the same in the
background:</p><pre><code class="programlisting ShellSession"># systemctl start nix-gc.service
</code></pre><p>You can tell NixOS in <code class="literal">configuration.nix</code> to run this unit automatically
at certain points in time, for instance, every night at 03:15:</p><pre><code class="programlisting nix">{
  nix.gc.automatic = true;
  nix.gc.dates = &quot;03:15&quot;;
}
</code></pre><p>The commands above do not remove garbage collector roots, such as old
system configurations. Thus they do not remove the ability to roll back
to previous configurations. The following command deletes old roots,
removing the ability to roll back to them:</p><pre><code class="programlisting ShellSession">$ nix-collect-garbage -d
</code></pre><p>You can also do this for specific profiles, e.g.</p><pre><code class="programlisting ShellSession">$ nix-env -p /nix/var/nix/profiles/per-user/eelco/profile --delete-generations old
</code></pre><p>Note that NixOS system configurations are stored in the profile
<code class="literal">/nix/var/nix/profiles/system</code>.</p><p>Another way to reclaim disk space (often as much as 40% of the size of
the Nix store) is to run Nix’s store optimiser, which seeks out
identical files in the store and replaces them with hard links to a
single copy.</p><pre><code class="programlisting ShellSession">$ nix-store --optimise
</code></pre><p>Since this command needs to read the entire Nix store, it can take quite
a while to finish.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sect-nixos-gc-boot-entries" class="title" style="clear: both">NixOS Boot Entries   </h2>  </div> </div></div><p>If your <code class="literal">/boot</code> partition runs out of space, after clearing old profiles
you must rebuild your system with <code class="literal">nixos-rebuild boot</code> or <code class="literal">nixos-rebuild switch</code> to update the <code class="literal">/boot</code> partition and clear space.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="ch-containers" class="title" >Container Management   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-imperative-containers">Imperative Container Management</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-declarative-containers">Declarative Container Specification</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-container-networking">Container Networking</a> </span></dt> </dl></div><p>NixOS allows you to easily run other NixOS instances as <span class="emphasis"><em>containers</em></span>.
Containers are a light-weight approach to virtualisation that runs
software in the container at the same speed as in the host system. NixOS
containers share the Nix store of the host, making container creation
very efficient.</p><div class="warning"><h3 class="title">Warning</h3><p>Currently, NixOS containers are not perfectly isolated from the host
system. This means that a user with root access to the container can do
things that affect the host. So you should not give container root
access to untrusted users.</p></div><p>NixOS containers can be created in two ways: imperatively, using the
command <code class="literal">nixos-container</code>, and declaratively, by specifying them in your
<code class="literal">configuration.nix</code>. The declarative approach implies that containers
get upgraded along with your host system when you run <code class="literal">nixos-rebuild</code>,
which is often not what you want. By contrast, in the imperative
approach, containers are configured and updated independently from the
host system.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-imperative-containers" class="title" style="clear: both">Imperative Container Management   </h2>  </div> </div></div><p>We’ll cover imperative container management using <code class="literal">nixos-container</code>
first. Be aware that container management is currently only possible as
<code class="literal">root</code>.</p><p>You create a container with identifier <code class="literal">foo</code> as follows:</p><pre><code class="programlisting ShellSession"># nixos-container create foo
</code></pre><p>This creates the container’s root directory in <code class="literal">/var/lib/nixos-containers/foo</code>
and a small configuration file in <code class="literal">/etc/nixos-containers/foo.conf</code>. It also
builds the container’s initial system configuration and stores it in
<code class="literal">/nix/var/nix/profiles/per-container/foo/system</code>. You can modify the
initial configuration of the container on the command line. For
instance, to create a container that has <code class="literal">sshd</code> running, with the given
public key for <code class="literal">root</code>:</p><pre><code class="programlisting ShellSession"># nixos-container create foo --config &#x27;
  services.openssh.enable = true;
  users.users.root.openssh.authorizedKeys.keys = [&quot;ssh-dss AAAAB3N…&quot;];
&#x27;
</code></pre><p>By default the next free address in the <code class="literal">10.233.0.0/16</code> subnet will be
chosen as container IP. This behavior can be altered by setting
<code class="literal">--host-address</code> and <code class="literal">--local-address</code>:</p><pre><code class="programlisting ShellSession"># nixos-container create test --config-file test-container.nix \
    --local-address 10.235.1.2 --host-address 10.235.1.1
</code></pre><p>Creating a container does not start it. To start the container, run:</p><pre><code class="programlisting ShellSession"># nixos-container start foo
</code></pre><p>This command will return as soon as the container has booted and has
reached <code class="literal">multi-user.target</code>. On the host, the container runs within a
systemd unit called <code class="literal">container@container-name.service</code>. Thus, if
something went wrong, you can get status info using <code class="literal">systemctl</code>:</p><pre><code class="programlisting ShellSession"># systemctl status container@foo
</code></pre><p>If the container has started successfully, you can log in as root using
the <code class="literal">root-login</code> operation:</p><pre><code class="programlisting ShellSession"># nixos-container root-login foo
[root@foo:~]#
</code></pre><p>Note that only root on the host can do this (since there is no
authentication). You can also get a regular login prompt using the
<code class="literal">login</code> operation, which is available to all users on the host:</p><pre><code class="programlisting ShellSession"># nixos-container login foo
foo login: alice
Password: ***
</code></pre><p>With <code class="literal">nixos-container run</code>, you can execute arbitrary commands in the
container:</p><pre><code class="programlisting ShellSession"># nixos-container run foo -- uname -a
Linux foo 3.4.82 #1-NixOS SMP Thu Mar 20 14:44:05 UTC 2014 x86_64 GNU/Linux
</code></pre><p>There are several ways to change the configuration of the container.
First, on the host, you can edit
<code class="literal">/var/lib/nixos-containers/foo/etc/nixos/configuration.nix</code>, and run</p><pre><code class="programlisting ShellSession"># nixos-container update foo
</code></pre><p>This will build and activate the new configuration. You can also specify
a new configuration on the command line:</p><pre><code class="programlisting ShellSession"># nixos-container update foo --config &#x27;
  services.httpd.enable = true;
  services.httpd.adminAddr = &quot;foo@example.org&quot;;
  networking.firewall.allowedTCPPorts = [ 80 ];
&#x27;

# curl http://$(nixos-container show-ip foo)/
&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 3.2 Final//EN&quot;&gt;…
</code></pre><p>However, note that this will overwrite the container’s
<code class="literal">/etc/nixos/configuration.nix</code>.</p><p>Alternatively, you can change the configuration from within the
container itself by running <code class="literal">nixos-rebuild switch</code> inside the container.
Note that the container by default does not have a copy of the NixOS
channel, so you should run <code class="literal">nix-channel --update</code> first.</p><p>Containers can be stopped and started using <code class="literal">nixos-container   stop</code> and <code class="literal">nixos-container start</code>, respectively, or by using
<code class="literal">systemctl</code> on the container’s service unit. To destroy a container,
including its file system, do</p><pre><code class="programlisting ShellSession"># nixos-container destroy foo
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-declarative-containers" class="title" style="clear: both">Declarative Container Specification   </h2>  </div> </div></div><p>You can also specify containers and their configuration in the host’s
<code class="literal">configuration.nix</code>. For example, the following specifies that there
shall be a container named <code class="literal">database</code> running PostgreSQL:</p><pre><code class="programlisting nix">{
  containers.database =
    { config =
        { config, pkgs, ... }:
        { services.postgresql.enable = true;
        services.postgresql.package = pkgs.postgresql_14;
        };
    };
}
</code></pre><p>If you run <code class="literal">nixos-rebuild switch</code>, the container will be built. If the
container was already running, it will be updated in place, without
rebooting. The container can be configured to start automatically by
setting <code class="literal">containers.database.autoStart = true</code> in its configuration.</p><p>By default, declarative containers share the network namespace of the
host, meaning that they can listen on (privileged) ports. However, they
cannot change the network configuration. You can give a container its
own network as follows:</p><pre><code class="programlisting nix">{
  containers.database = {
    privateNetwork = true;
    hostAddress = &quot;192.168.100.10&quot;;
    localAddress = &quot;192.168.100.11&quot;;
  };
}
</code></pre><p>This gives the container a private virtual Ethernet interface with IP
address <code class="literal">192.168.100.11</code>, which is hooked up to a virtual Ethernet
interface on the host with IP address <code class="literal">192.168.100.10</code>. (See the next
section for details on container networking.)</p><p>To disable the container, just remove it from <code class="literal">configuration.nix</code> and
run <code class="literal">nixos-rebuild   switch</code>. Note that this will not delete the root directory of the
container in <code class="literal">/var/lib/nixos-containers</code>. Containers can be destroyed using
the imperative method: <code class="literal">nixos-container destroy foo</code>.</p><p>Declarative containers can be started and stopped using the
corresponding systemd service, e.g.
<code class="literal">systemctl start container@database</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-container-networking" class="title" style="clear: both">Container Networking   </h2>  </div> </div></div><p>When you create a container using <code class="literal">nixos-container create</code>, it gets it
own private IPv4 address in the range <code class="literal">10.233.0.0/16</code>. You can get the
container’s IPv4 address as follows:</p><pre><code class="programlisting ShellSession"># nixos-container show-ip foo
10.233.4.2

$ ping -c1 10.233.4.2
64 bytes from 10.233.4.2: icmp_seq=1 ttl=64 time=0.106 ms
</code></pre><p>Networking is implemented using a pair of virtual Ethernet devices. The
network interface in the container is called <code class="literal">eth0</code>, while the matching
interface in the host is called <code class="literal">ve-container-name</code> (e.g., <code class="literal">ve-foo</code>).
The container has its own network namespace and the <code class="literal">CAP_NET_ADMIN</code>
capability, so it can perform arbitrary network configuration such as
setting up firewall rules, without affecting or having access to the
host’s network.</p><p>By default, containers cannot talk to the outside network. If you want
that, you should set up Network Address Translation (NAT) rules on the
host to rewrite container traffic to use your external IP address. This
can be accomplished using the following configuration on the host:</p><pre><code class="programlisting nix">{
  networking.nat.enable = true;
  networking.nat.internalInterfaces = [&quot;ve-+&quot;];
  networking.nat.externalInterface = &quot;eth0&quot;;
}
</code></pre><p>where <code class="literal">eth0</code> should be replaced with the desired external interface.
Note that <code class="literal">ve-+</code> is a wildcard that matches all container interfaces.</p><p>If you are using Network Manager, you need to explicitly prevent it from
managing container interfaces:</p><pre><code class="programlisting nix">{
  networking.networkmanager.unmanaged = [ &quot;interface-name:ve-*&quot; ];
}
</code></pre><p>You may need to restart your system for the changes to take effect.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="ch-troubleshooting" class="title" >Troubleshooting   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-boot-problems">Boot Problems</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-maintenance-mode">Maintenance Mode</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-rollback">Rolling Back Configuration Changes</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-nix-store-corruption">Nix Store Corruption</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-nix-network-issues">Network Problems</a> </span></dt> </dl></div><p>This chapter describes solutions to common problems you might encounter
when you manage your NixOS system.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-boot-problems" class="title" style="clear: both">Boot Problems   </h2>  </div> </div></div><p>If NixOS fails to boot, there are a number of kernel command line parameters that may help you to identify or fix the issue. You can add these parameters in the GRUB boot menu by pressing “e” to modify the selected boot entry and editing the line starting with <code class="literal">linux</code>. The following are some useful kernel command line parameters that are recognised by the NixOS boot scripts or by systemd:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">boot.shell_on_fail</code></span></dt><dd><p>Allows the user to start a root shell if something goes wrong in stage 1 of the boot process (the initial ramdisk). This is disabled by default because there is no authentication for the root shell.</p></dd><dt><span class="term"><code class="literal">boot.debug1</code></span></dt><dd><p>Start an interactive shell in stage 1 before anything useful has been done. That is, no modules have been loaded and no file systems have been mounted, except for <code class="literal">/proc</code> and <code class="literal">/sys</code>.</p></dd><dt><span class="term"><code class="literal">boot.debug1devices</code></span></dt><dd><p>Like <code class="literal">boot.debug1</code>, but runs stage1 until kernel modules are loaded and device nodes are created. This may help with e.g. making the keyboard work.</p></dd><dt><span class="term"><code class="literal">boot.debug1mounts</code></span></dt><dd><p>Like <code class="literal">boot.debug1</code> or <code class="literal">boot.debug1devices</code>, but runs stage1 until all filesystems that are mounted during initrd are mounted (see <a class="link" href="options.html#opt-fileSystems._name_.neededForBoot"  >neededForBoot</a>). As a motivating example, this could be useful if you’ve forgotten to set <a class="link" href="options.html#opt-fileSystems._name_.neededForBoot"  >neededForBoot</a> on a file system.</p></dd><dt><span class="term"><code class="literal">boot.trace</code></span></dt><dd><p>Print every shell command executed by the stage 1 and 2 boot scripts.</p></dd><dt><span class="term"><code class="literal">single</code></span></dt><dd><p>Boot into rescue mode (a.k.a. single user mode). This will cause systemd to start nothing but the unit <code class="literal">rescue.target</code>, which runs <code class="literal">sulogin</code> to prompt for the root password and start a root login shell. Exiting the shell causes the system to continue with the normal boot process.</p></dd><dt><span class="term"><code class="literal">systemd.log_level=debug</code> <code class="literal">systemd.log_target=console</code></span></dt><dd><p>Make systemd very verbose and send log messages to the console instead of the journal. For more parameters recognised by systemd, see systemd(1).</p></dd></dl></div><p>In addition, these arguments are recognised by the live image only:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">live.nixos.passwd=password</code></span></dt><dd><p>Set the password for the <code class="literal">nixos</code> live user. This can be used for SSH access if there are issues using the terminal.</p></dd></dl></div><p>Notice that for <code class="literal">boot.shell_on_fail</code>, <code class="literal">boot.debug1</code>, <code class="literal">boot.debug1devices</code>, and <code class="literal">boot.debug1mounts</code>, if you did <span class="strong"><strong>not</strong></span> select “start the new shell as pid 1”, and you <code class="literal">exit</code> from the new shell, boot will proceed normally from the point where it failed, as if you’d chosen “ignore the error and continue”.</p><p>If no login prompts or X11 login screens appear (e.g. due to hanging dependencies), you can press Alt+ArrowUp. If you’re lucky, this will start rescue mode (described above). (Also note that since most units have a 90-second timeout before systemd gives up on them, the <code class="literal">agetty</code> login prompts should appear eventually unless something is very wrong.)</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-maintenance-mode" class="title" style="clear: both">Maintenance Mode   </h2>  </div> </div></div><p>You can enter rescue mode by running:</p><pre><code class="programlisting ShellSession"># systemctl rescue
</code></pre><p>This will eventually give you a single-user root shell. Systemd will
stop (almost) all system services. To get out of maintenance mode, just
exit from the rescue shell.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-rollback" class="title" style="clear: both">Rolling Back Configuration Changes   </h2>  </div> </div></div><p>After running <code class="literal">nixos-rebuild</code> to switch to a new configuration, you may
find that the new configuration doesn’t work very well. In that case,
there are several ways to return to a previous configuration.</p><p>First, the GRUB boot manager allows you to boot into any previous
configuration that hasn’t been garbage-collected. These configurations
can be found under the GRUB submenu “NixOS - All configurations”. This
is especially useful if the new configuration fails to boot. After the
system has booted, you can make the selected configuration the default
for subsequent boots:</p><pre><code class="programlisting ShellSession"># /run/current-system/bin/switch-to-configuration boot
</code></pre><p>Second, you can switch to the previous configuration in a running
system:</p><pre><code class="programlisting ShellSession"># nixos-rebuild switch --rollback
</code></pre><p>This is equivalent to running:</p><pre><code class="programlisting ShellSession"># /nix/var/nix/profiles/system-N-link/bin/switch-to-configuration switch
</code></pre><p>where <code class="literal">N</code> is the number of the NixOS system configuration. To get a
list of the available configurations, do:</p><pre><code class="programlisting ShellSession">$ ls -l /nix/var/nix/profiles/system-*-link
...
lrwxrwxrwx 1 root root 78 Aug 12 13:54 /nix/var/nix/profiles/system-268-link -&gt; /nix/store/202b...-nixos-13.07pre4932_5a676e4-4be1055
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-nix-store-corruption" class="title" style="clear: both">Nix Store Corruption   </h2>  </div> </div></div><p>After a system crash, it’s possible for files in the Nix store to become
corrupted. (For instance, the Ext4 file system has the tendency to
replace un-synced files with zero bytes.) NixOS tries hard to prevent
this from happening: it performs a <code class="literal">sync</code> before switching to a new
configuration, and Nix’s database is fully transactional. If corruption
still occurs, you may be able to fix it automatically.</p><p>If the corruption is in a path in the closure of the NixOS system
configuration, you can fix it by doing</p><pre><code class="programlisting ShellSession"># nixos-rebuild switch --repair
</code></pre><p>This will cause Nix to check every path in the closure, and if its
cryptographic hash differs from the hash recorded in Nix’s database, the
path is rebuilt or redownloaded.</p><p>You can also scan the entire Nix store for corrupt paths:</p><pre><code class="programlisting ShellSession"># nix-store --verify --check-contents --repair
</code></pre><p>Any corrupt paths will be redownloaded if they’re available in a binary
cache; otherwise, they cannot be repaired.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-nix-network-issues" class="title" style="clear: both">Network Problems   </h2>  </div> </div></div><p>Nix uses a so-called <span class="emphasis"><em>binary cache</em></span> to optimise building a package from
source into downloading it as a pre-built binary. That is, whenever a
command like <code class="literal">nixos-rebuild</code> needs a path in the Nix store, Nix will try
to download that path from the Internet rather than build it from
source. The default binary cache is <code class="literal">https://cache.nixos.org/</code>. If this
cache is unreachable, Nix operations may take a long time due to HTTP
connection timeouts. You can disable the use of the binary cache by
adding <code class="literal">--option use-binary-caches false</code>, e.g.</p><pre><code class="programlisting ShellSession"># nixos-rebuild switch --option use-binary-caches false
</code></pre><p>If you have an alternative binary cache at your disposal, you can use it
instead:</p><pre><code class="programlisting ShellSession"># nixos-rebuild switch --option binary-caches http://my-cache.example.org/
</code></pre>
</div>
</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="ch-development" class="title" >Development   </h1>  </div> </div></div><div class="partintro"><p>This chapter describes how you can modify and extend NixOS.</p><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#sec-getting-sources">Getting the Sources</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-writing-modules">Writing NixOS Modules</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-building-parts">Building Specific Parts of NixOS</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-bootspec">Bootspec</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-switching-systems">What happens during a system switch?</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-writing-documentation">Writing NixOS Documentation</a> </span></dt><dt> <span class="chapter">  <a href="index.html#sec-nixos-tests">NixOS Tests</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-developing-the-test-driver">Developing the NixOS Test Driver</a> </span></dt><dt> <span class="chapter">  <a href="index.html#ch-testing-installer">Testing the Installer</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-getting-sources" class="title" >Getting the Sources   </h2>  </div> </div></div><p>By default, NixOS’s <code class="literal">nixos-rebuild</code> command uses the NixOS and Nixpkgs
sources provided by the <code class="literal">nixos</code> channel (kept in
<code class="literal">/nix/var/nix/profiles/per-user/root/channels/nixos</code>). To modify NixOS,
however, you should check out the latest sources from Git. This is as
follows:</p><pre><code class="programlisting ShellSession">$ git clone https://github.com/NixOS/nixpkgs
$ cd nixpkgs
$ git remote update origin
</code></pre><p>This will check out the latest Nixpkgs sources to <code class="literal">./nixpkgs</code> the NixOS
sources to <code class="literal">./nixpkgs/nixos</code>. (The NixOS source tree lives in a
subdirectory of the Nixpkgs repository.) The <code class="literal">nixpkgs</code> repository has
branches that correspond to each Nixpkgs/NixOS channel (see
<a class="xref" href="index.html#sec-upgrading" title="Upgrading NixOS" ><em>Upgrading NixOS</em></a> for more information about channels). Thus, the
Git branch <code class="literal">origin/nixos-17.03</code> will contain the latest built and tested
version available in the <code class="literal">nixos-17.03</code> channel.</p><p>It’s often inconvenient to develop directly on the master branch, since
if somebody has just committed (say) a change to GCC, then the binary
cache may not have caught up yet and you’ll have to rebuild everything
from source. So you may want to create a local branch based on your
current NixOS version:</p><pre><code class="programlisting ShellSession">$ nixos-version
17.09pre104379.6e0b727 (Hummingbird)

$ git checkout -b local 6e0b727
</code></pre><p>Or, to base your local branch on the latest version available in a NixOS
channel:</p><pre><code class="programlisting ShellSession">$ git remote update origin
$ git checkout -b local origin/nixos-17.03
</code></pre><p>(Replace <code class="literal">nixos-17.03</code> with the name of the channel you want to use.)
You can use <code class="literal">git merge</code> or <code class="literal">git   rebase</code> to keep your local branch in sync with the channel, e.g.</p><pre><code class="programlisting ShellSession">$ git remote update origin
$ git merge origin/nixos-17.03
</code></pre><p>You can use <code class="literal">git cherry-pick</code> to copy commits from your local branch to
the upstream branch.</p><p>If you want to rebuild your system using your (modified) sources, you
need to tell <code class="literal">nixos-rebuild</code> about them using the <code class="literal">-I</code> flag:</p><pre><code class="programlisting ShellSession"># nixos-rebuild switch -I nixpkgs=/my/sources/nixpkgs
</code></pre><p>If you want <code class="literal">nix-env</code> to use the expressions in <code class="literal">/my/sources</code>, use
<code class="literal">nix-env -f   /my/sources/nixpkgs</code>, or change the default by adding a symlink in
<code class="literal">~/.nix-defexpr</code>:</p><pre><code class="programlisting ShellSession">$ ln -s /my/sources/nixpkgs ~/.nix-defexpr/nixpkgs
</code></pre><p>You may want to delete the symlink <code class="literal">~/.nix-defexpr/channels_root</code> to
prevent root’s NixOS channel from clashing with your own tree (this may
break the command-not-found utility though). If you want to go back to
the default state, you may just remove the <code class="literal">~/.nix-defexpr</code> directory
completely, log out and log in again and it should have been recreated
with a link to the root channels.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-writing-modules" class="title" >Writing NixOS Modules   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-option-declarations">Option Declarations</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-option-types">Options Types</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-option-definitions">Option Definitions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-assertions">Warnings and Assertions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-meta-attributes">Meta Attributes</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-importing-modules">Importing Modules</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-replace-modules">Replace Modules</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-freeform-modules">Freeform modules</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-settings-options">Options for Program Settings</a> </span></dt> </dl></div><p>NixOS has a modular system for declarative configuration. This system
combines multiple <span class="emphasis"><em>modules</em></span> to produce the full system configuration.
One of the modules that constitute the configuration is
<code class="literal">/etc/nixos/configuration.nix</code>. Most of the others live in the
<a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/modules"  target="_top"><code class="literal">nixos/modules</code></a>
subdirectory of the Nixpkgs tree.</p><p>Each NixOS module is a file that handles one logical aspect of the
configuration, such as a specific kind of hardware, a service, or
network settings. A module configuration does not have to handle
everything from scratch; it can use the functionality provided by other
modules for its implementation. Thus a module can <span class="emphasis"><em>declare</em></span> options that
can be used by other modules, and conversely can <span class="emphasis"><em>define</em></span> options
provided by other modules in its own implementation. For example, the
module
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/security/pam.nix"  target="_top"><code class="literal">pam.nix</code></a>
declares the option <code class="literal">security.pam.services</code> that allows other modules (e.g.
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/networking/ssh/sshd.nix"  target="_top"><code class="literal">sshd.nix</code></a>)
to define PAM services; and it defines the option <code class="literal">environment.etc</code> (declared by
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/system/etc/etc.nix"  target="_top"><code class="literal">etc.nix</code></a>)
to cause files to be created in <code class="literal">/etc/pam.d</code>.</p><p>In <a class="xref" href="index.html#sec-configuration-syntax" title="Configuration Syntax" ><em>Configuration Syntax</em></a>, we saw the following structure of
NixOS modules:</p><pre><code class="programlisting nix">{ config, pkgs, ... }:

{ # option definitions
}
</code></pre><p>This is actually an <span class="emphasis"><em>abbreviated</em></span> form of module that only defines
options, but does not declare any. The structure of full NixOS modules
is shown in <a class="link" href="index.html#ex-module-syntax" title="Example 12. Structure of NixOS Modules" >Example: Structure of NixOS Modules</a>.</p><div class="example"><span id="ex-module-syntax" ></span><details><summary><span class="title"><strong>Example 12. Structure of NixOS Modules</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ config, pkgs, ... }:

{
  imports =
    [ # paths of other modules
    ];

  options = {
    # option declarations
  };

  config = {
    # option definitions
  };
}
</code></pre></div></details></div><br class="example-break" /><p>The meaning of each part is as follows.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>The first line makes the current Nix expression a function. The variable
<code class="literal">pkgs</code> contains Nixpkgs (by default, it takes the <code class="literal">nixpkgs</code> entry of
<code class="literal">NIX_PATH</code>, see the <a class="link" href="https://nixos.org/manual/nix/stable/#sec-common-env"  target="_top">Nix manual</a>
for further details), while <code class="literal">config</code> contains the full system
configuration. This line can be omitted if there is no reference to
<code class="literal">pkgs</code> and <code class="literal">config</code> inside the module.</p></li><li class="listitem"><p>This <code class="literal">imports</code> list enumerates the paths to other NixOS modules that
should be included in the evaluation of the system configuration. A
default set of modules is defined in the file <code class="literal">modules/module-list.nix</code>.
These don’t need to be added in the import list.</p></li><li class="listitem"><p>The attribute <code class="literal">options</code> is a nested set of <span class="emphasis"><em>option declarations</em></span>
(described below).</p></li><li class="listitem"><p>The attribute <code class="literal">config</code> is a nested set of <span class="emphasis"><em>option definitions</em></span> (also
described below).</p></li></ul></div><p><a class="link" href="index.html#locate-example" title="Example 13. NixOS Module for the “locate” Service" >Example: NixOS Module for the “locate” Service</a>
shows a module that handles the regular update of the “locate” database,
an index of all files in the file system. This module declares two
options that can be defined by other modules (typically the user’s
<code class="literal">configuration.nix</code>): <code class="literal">services.locate.enable</code> (whether the database should
be updated) and <code class="literal">services.locate.interval</code> (when the update should be done).
It implements its functionality by defining two options declared by other
modules: <code class="literal">systemd.services</code> (the set of all systemd services) and
<code class="literal">systemd.timers</code> (the list of commands to be executed periodically by
<code class="literal">systemd</code>).</p><p>Care must be taken when writing systemd services using <code class="literal">Exec*</code> directives. By
default systemd performs substitution on <code class="literal">%&lt;char&gt;</code> specifiers in these
directives, expands environment variables from <code class="literal">$FOO</code> and <code class="literal">${FOO}</code>, splits
arguments on whitespace, and splits commands on <code class="literal">;</code>. All of these must be escaped
to avoid unexpected substitution or splitting when interpolating into an <code class="literal">Exec*</code>
directive, e.g. when using an <code class="literal">extraArgs</code> option to pass additional arguments to
the service. The functions <code class="literal">utils.escapeSystemdExecArg</code> and
<code class="literal">utils.escapeSystemdExecArgs</code> are provided for this, see <a class="link" href="index.html#exec-escaping-example" title="Example 14. Escaping in Exec directives" >Example: Escaping in
Exec directives</a> for an example. When using these
functions system environment substitution should <span class="emphasis"><em>not</em></span> be disabled explicitly.</p><div class="example"><span id="locate-example" ></span><details><summary><span class="title"><strong>Example 13. NixOS Module for the “locate” Service</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ config, lib, pkgs, ... }:

let
  inherit (lib) concatStringsSep mkIf mkOption optionalString types;
  cfg = config.services.locate;
in {
  options.services.locate = {
    enable = mkOption {
      type = types.bool;
      default = false;
      description = &#x27;&#x27;
        If enabled, NixOS will periodically update the database of
        files used by the locate command.
      &#x27;&#x27;;
    };

    interval = mkOption {
      type = types.str;
      default = &quot;02:15&quot;;
      example = &quot;hourly&quot;;
      description = &#x27;&#x27;
        Update the locate database at this interval. Updates by
        default at 2:15 AM every day.

        The format is described in
        systemd.time(7).
      &#x27;&#x27;;
    };

    # Other options omitted for documentation
  };

  config = {
    systemd.services.update-locatedb =
      { description = &quot;Update Locate Database&quot;;
        path  = [ pkgs.su ];
        script =
          &#x27;&#x27;
            mkdir -p $(dirname ${toString cfg.output})
            chmod 0755 $(dirname ${toString cfg.output})
            exec updatedb \
              --localuser=${cfg.localuser} \
              ${optionalString (!cfg.includeStore) &quot;--prunepaths=&#x27;/nix/store&#x27;&quot;} \
              --output=${toString cfg.output} ${concatStringsSep &quot; &quot; cfg.extraFlags}
          &#x27;&#x27;;
      };

    systemd.timers.update-locatedb = mkIf cfg.enable
      { description = &quot;Update timer for locate database&quot;;
        partOf      = [ &quot;update-locatedb.service&quot; ];
        wantedBy    = [ &quot;timers.target&quot; ];
        timerConfig.OnCalendar = cfg.interval;
      };
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="exec-escaping-example" ></span><details><summary><span class="title"><strong>Example 14. Escaping in Exec directives</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ config, pkgs, utils, ... }:

let
  cfg = config.services.echo;
  echoAll = pkgs.writeScript &quot;echo-all&quot; &#x27;&#x27;
    #! ${pkgs.runtimeShell}
    for s in &quot;$@&quot;; do
      printf &#x27;%s\n&#x27; &quot;$s&quot;
    done
  &#x27;&#x27;;
  args = [ &quot;a%Nything&quot; &quot;lang=\${LANG}&quot; &quot;;&quot; &quot;/bin/sh -c date&quot; ];
in {
  systemd.services.echo =
    { description = &quot;Echo to the journal&quot;;
      wantedBy = [ &quot;multi-user.target&quot; ];
      serviceConfig.Type = &quot;oneshot&quot;;
      serviceConfig.ExecStart = &#x27;&#x27;
        ${echoAll} ${utils.escapeSystemdExecArgs args}
      &#x27;&#x27;;
    };
}
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-option-declarations" class="title" style="clear: both">Option Declarations   </h2>  </div> </div></div><p>An option declaration specifies the name, type and description of a
NixOS configuration option. It is invalid to define an option that
hasn’t been declared in any module. An option declaration generally
looks like this:</p><pre><code class="programlisting nix">{
  options = {
    name = mkOption {
      type = type specification;
      default = default value;
      example = example value;
      description = &quot;Description for use in the NixOS manual.&quot;;
    };
  };
}
</code></pre><p>The attribute names within the <code class="literal">name</code> attribute path must be camel
cased in general but should, as an exception, match the <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-package-naming"  target="_top"> package
attribute name</a>
when referencing a Nixpkgs package. For example, the option
<code class="literal">services.nix-serve.bindAddress</code> references the <code class="literal">nix-serve</code> Nixpkgs
package.</p><p>The function <code class="literal">mkOption</code> accepts the following arguments.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">type</code></span></dt><dd><p>The type of the option (see <a class="xref" href="index.html#sec-option-types" title="Options Types" >the section called “Options Types”</a>). This
argument is mandatory for nixpkgs modules. Setting this is highly
recommended for the sake of documentation and type checking. In case it is
not set, a fallback type with unspecified behavior is used.</p></dd><dt><span class="term"><code class="literal">default</code></span></dt><dd><p>The default value used if no value is defined by any module. A
default is not required; but if a default is not given, then users
of the module will have to define the value of the option, otherwise
an error will be thrown.</p></dd><dt><span class="term"><code class="literal">defaultText</code></span></dt><dd><p>A textual representation of the default value to be rendered verbatim in
the manual. Useful if the default value is a complex expression or depends
on other values or packages.
Use <code class="literal">lib.literalExpression</code> for a Nix expression, <code class="literal">lib.literalMD</code> for
a plain English description in <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-contributing-markup"  target="_top">Nixpkgs-flavored Markdown</a> format.</p></dd><dt><span class="term"><code class="literal">example</code></span></dt><dd><p>An example value that will be shown in the NixOS manual.
You can use <code class="literal">lib.literalExpression</code> and <code class="literal">lib.literalMD</code> in the same way
as in <code class="literal">defaultText</code>.</p></dd><dt><span class="term"><code class="literal">description</code></span></dt><dd><p>A textual description of the option in <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-contributing-markup"  target="_top">Nixpkgs-flavored Markdown</a> format that will be
included in the NixOS manual.</p></dd></dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-declarations-util" class="title" >Utility functions for common option patterns   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-option-declarations-util-mkEnableOption" class="title" ><code class="literal">mkEnableOption</code>   </h4>  </div> </div></div><p>Creates an Option attribute set for a boolean value option i.e an
option to be toggled on or off.</p><p>This function takes a single string argument, the name of the thing to be toggled.</p><p>The option’s description is “Whether to enable &lt;name&gt;.”.</p><p>For example:</p><div class="example"><span id="ex-options-declarations-util-mkEnableOption-magic" ></span><details><summary><span class="title"><strong>Example 15. <code class="literal">mkEnableOption</code> usage</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">lib.mkEnableOption &quot;magic&quot;
# is like
lib.mkOption {
  type = lib.types.bool;
  default = false;
  example = true;
  description = &quot;Whether to enable magic.&quot;;
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-option-declarations-util-mkPackageOption" class="title" ><code class="literal">mkPackageOption</code>   </h4>  </div> </div></div><p>Usage:</p><pre><code class="programlisting nix">mkPackageOption pkgs &quot;name&quot; { default = [ &quot;path&quot; &quot;in&quot; &quot;pkgs&quot; ]; example = &quot;literal example&quot;; }
</code></pre><p>Creates an Option attribute set for an option that specifies the package a module should use for some purpose.</p><p><span class="strong"><strong>Note</strong></span>: You should make package options for your modules, where applicable. While one can always overwrite a specific package throughout nixpkgs by using <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#chap-overlays"  target="_top">nixpkgs overlays</a>, they slow down nixpkgs evaluation significantly and are harder to debug when issues arise.</p><p>The package is specified in the third argument under <code class="literal">default</code> as a list of strings
representing its attribute path in nixpkgs (or another package set).
Because of this, you need to pass nixpkgs itself (or a subset) as the first argument.</p><p>The second argument may be either a string or a list of strings.
It provides the display name of the package in the description of the generated option
(using only the last element if the passed value is a list)
and serves as the fallback value for the <code class="literal">default</code> argument.</p><p>To include extra information in the description, pass <code class="literal">extraDescription</code> to
append arbitrary text to the generated description.
You can also pass an <code class="literal">example</code> value, either a literal string or an attribute path.</p><p>The default argument can be omitted if the provided name is
an attribute of pkgs (if name is a string) or a
valid attribute path in pkgs (if name is a list).</p><p>If you wish to explicitly provide no default, pass <code class="literal">null</code> as <code class="literal">default</code>.</p><p><span id="ex-options-declarations-util-mkPackageOption"></span>
Examples:</p><div class="example"><span id="ex-options-declarations-util-mkPackageOption-hello" ></span><details><summary><span class="title"><strong>Example 16. Simple <code class="literal">mkPackageOption</code> usage</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">lib.mkPackageOption pkgs &quot;hello&quot; { }
# is like
lib.mkOption {
  type = lib.types.package;
  default = pkgs.hello;
  defaultText = lib.literalExpression &quot;pkgs.hello&quot;;
  description = &quot;The hello package to use.&quot;;
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-options-declarations-util-mkPackageOption-ghc" ></span><details><summary><span class="title"><strong>Example 17. <code class="literal">mkPackageOption</code> with explicit default and example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">lib.mkPackageOption pkgs &quot;GHC&quot; {
  default = [ &quot;ghc&quot; ];
  example = &quot;pkgs.haskell.packages.ghc92.ghc.withPackages (hkgs: [ hkgs.primes ])&quot;;
}
# is like
lib.mkOption {
  type = lib.types.package;
  default = pkgs.ghc;
  defaultText = lib.literalExpression &quot;pkgs.ghc&quot;;
  example = lib.literalExpression &quot;pkgs.haskell.packages.ghc92.ghc.withPackages (hkgs: [ hkgs.primes ])&quot;;
  description = &quot;The GHC package to use.&quot;;
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-options-declarations-util-mkPackageOption-extraDescription" ></span><details><summary><span class="title"><strong>Example 18. <code class="literal">mkPackageOption</code> with additional description text</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mkPackageOption pkgs [ &quot;python312Packages&quot; &quot;torch&quot; ] {
  extraDescription = &quot;This is an example and doesn&#x27;t actually do anything.&quot;;
}
# is like
lib.mkOption {
  type = lib.types.package;
  default = pkgs.python312Packages.torch;
  defaultText = lib.literalExpression &quot;pkgs.python312Packages.torch&quot;;
  description = &quot;The pytorch package to use. This is an example and doesn&#x27;t actually do anything.&quot;;
}
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-declarations-eot" class="title" >Extensible Option Types   </h3>  </div> </div></div><p>Extensible option types is a feature that allows to extend certain types
declaration through multiple module files. This feature only work with a
restricted set of types, namely <code class="literal">enum</code> and <code class="literal">submodules</code> and any composed
forms of them.</p><p>Extensible option types can be used for <code class="literal">enum</code> options that affects
multiple modules, or as an alternative to related <code class="literal">enable</code> options.</p><p>As an example, we will take the case of display managers. There is a
central display manager module for generic display manager options and a
module file per display manager backend (sddm, gdm …).</p><p>There are two approaches we could take with this module structure:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Configuring the display managers independently by adding an enable
option to every display manager module backend. (NixOS)</p></li><li class="listitem"><p>Configuring the display managers in the central module by adding
an option to select which display manager backend to use.</p></li></ul></div><p>Both approaches have problems.</p><p>Making backends independent can quickly become hard to manage. For
display managers, there can only be one enabled at a time, but the
type system cannot enforce this restriction as there is no relation
between each backend’s <code class="literal">enable</code> option. As a result, this restriction
has to be done explicitly by adding assertions in each display manager
backend module.</p><p>On the other hand, managing the display manager backends in the
central module will require changing the central module option every
time a new backend is added or removed.</p><p>By using extensible option types, it is possible to create a placeholder
option in the central module
(<a class="link" href="index.html#ex-option-declaration-eot-service" title="Example 19. Extensible type placeholder in the service module" >Example: Extensible type placeholder in the service module</a>),
and to extend it in each backend module
(<a class="link" href="index.html#ex-option-declaration-eot-backend-gdm" title="Example 20. Extending services.xserver.displayManager.enable in the gdm module" >Example: Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">gdm</code> module</a>,
<a class="link" href="index.html#ex-option-declaration-eot-backend-sddm" title="Example 21. Extending services.xserver.displayManager.enable in the sddm module" >Example: Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">sddm</code> module</a>).</p><p>As a result, <code class="literal">displayManager.enable</code> option values can be added without
changing the main service module file and the type system automatically
enforces that there can only be a single display manager enabled.</p><div class="example"><span id="ex-option-declaration-eot-service" ></span><details><summary><span class="title"><strong>Example 19. Extensible type placeholder in the service module</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  services.xserver.displayManager.enable = mkOption {
    description = &quot;Display manager to use&quot;;
    type = with types; nullOr (enum [ ]);
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-option-declaration-eot-backend-gdm" ></span><details><summary><span class="title"><strong>Example 20. Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">gdm</code> module</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  services.xserver.displayManager.enable = mkOption {
    type = with types; nullOr (enum [ &quot;gdm&quot; ]);
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-option-declaration-eot-backend-sddm" ></span><details><summary><span class="title"><strong>Example 21. Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">sddm</code> module</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  services.xserver.displayManager.enable = mkOption {
    type = with types; nullOr (enum [ &quot;sddm&quot; ]);
  };
}
</code></pre></div></details></div><br class="example-break" /><p>The placeholder declaration is a standard <code class="literal">mkOption</code> declaration, but it
is important that extensible option declarations only use the <code class="literal">type</code>
argument.</p><p>Extensible option types work with any of the composed variants of <code class="literal">enum</code>
such as <code class="literal">with types; nullOr (enum [ &quot;foo&quot; &quot;bar&quot; ])</code> or <code class="literal">with types; listOf (enum [ &quot;foo&quot; &quot;bar&quot; ])</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-option-types" class="title" style="clear: both">Options Types   </h2>  </div> </div></div><p>Option types are a way to put constraints on the values a module option
can take. Types are also responsible of how values are merged in case of
multiple value definitions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-basic" class="title" >Basic types   </h3>  </div> </div></div><p>Basic types are the simplest available types in the module system. Basic
types include multiple string types that mainly differ in how definition
merging is handled.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.bool</code></span></dt><dd><p>A boolean, its values can be <code class="literal">true</code> or <code class="literal">false</code>.
All definitions must have the same value, after priorities. An error is thrown in case of a conflict.</p></dd><dt><span class="term"><code class="literal">types.boolByOr</code></span></dt><dd><p>A boolean, its values can be <code class="literal">true</code> or <code class="literal">false</code>.
The result is <code class="literal">true</code> if <span class="emphasis"><em>any</em></span> of multiple definitions is <code class="literal">true</code>.
In other words, definitions are merged with the logical <span class="emphasis"><em>OR</em></span> operator.</p></dd><dt><span class="term"><code class="literal">types.path</code></span></dt><dd><p>A filesystem path that starts with a slash. Even if derivations can be
considered as paths, the more specific <code class="literal">types.package</code> should be preferred.</p></dd><dt><span class="term"><code class="literal">types.pathInStore</code></span></dt><dd><p>A path that is contained in the Nix store. This can be a top-level store
path like <code class="literal">pkgs.hello</code> or a descendant like <code class="literal">&quot;${pkgs.hello}/bin/hello&quot;</code>.</p></dd><dt><span class="term"><code class="literal">types.pathWith</code> { <span class="emphasis"><em><code class="literal">inStore</code></em></span> ? <code class="literal">null</code>, <span class="emphasis"><em><code class="literal">absolute</code></em></span> ? <code class="literal">null</code> }</span></dt><dd><p>A filesystem path. Either a string or something that can be coerced
to a string.</p><p><span class="strong"><strong>Parameters</strong></span></p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">inStore</code> (<code class="literal">Boolean</code> or <code class="literal">null</code>, default <code class="literal">null</code>)</span></dt><dd><p>Whether the path must be in the store (<code class="literal">true</code>), must not be in the store
(<code class="literal">false</code>), or it doesn’t matter (<code class="literal">null</code>)</p></dd><dt><span class="term"><code class="literal">absolute</code> (<code class="literal">Boolean</code> or <code class="literal">null</code>, default <code class="literal">null</code>)</span></dt><dd><p>Whether the path must be absolute (<code class="literal">true</code>), must not be absolute
(<code class="literal">false</code>), or it doesn’t matter (<code class="literal">null</code>)</p></dd></dl></div><p><span class="strong"><strong>Behavior</strong></span></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pathWith { inStore = true; }</code> is equivalent to <code class="literal">pathInStore</code></p></li><li class="listitem"><p><code class="literal">pathWith { absolute = true; }</code> is equivalent to <code class="literal">path</code></p></li><li class="listitem"><p><code class="literal">pathWith { inStore = false; absolute = true; }</code> requires an absolute
path that is not in the store. Useful for password files that shouldn’t be
leaked into the store.</p></li></ul></div></dd><dt><span class="term"><code class="literal">types.package</code></span></dt><dd><p>A top-level store path. This can be an attribute set pointing
to a store path, like a derivation or a flake input.</p></dd><dt><span class="term"><code class="literal">types.enum</code> <span class="emphasis"><em><code class="literal">l</code></em></span></span></dt><dd><p>One element of the list <span class="emphasis"><em><code class="literal">l</code></em></span>, e.g. <code class="literal">types.enum [ &quot;left&quot; &quot;right&quot; ]</code>.
Multiple definitions cannot be merged.</p><p>If you want to pair these values with more information, possibly of
distinct types, consider using a <a class="link" href="index.html#sec-option-types-sums" title="Sum types" >sum type</a>.</p></dd><dt><span class="term"><code class="literal">types.anything</code></span></dt><dd><p>A type that accepts any value and recursively merges attribute sets
together. This type is recommended when the option type is unknown.</p><div class="example"><span id="ex-types-anything" ></span><details><summary><span class="title"><strong>Example 22. <code class="literal">types.anything</code></strong></span></summary><div class="example-contents"><p>Two definitions of this type like</p><pre><code class="programlisting nix">{
  str = lib.mkDefault &quot;foo&quot;;
  pkg.hello = pkgs.hello;
  fun.fun = x: x + 1;
}
</code></pre><pre><code class="programlisting nix">{
  str = lib.mkIf true &quot;bar&quot;;
  pkg.gcc = pkgs.gcc;
  fun.fun = lib.mkForce (x: x + 2);
}
</code></pre><p>will get merged to</p><pre><code class="programlisting nix">{
  str = &quot;bar&quot;;
  pkg.gcc = pkgs.gcc;
  pkg.hello = pkgs.hello;
  fun.fun = x: x + 2;
}
</code></pre></div></details></div><br class="example-break" /></dd><dt><span class="term"><code class="literal">types.raw</code></span></dt><dd><p>A type which doesn’t do any checking, merging or nested evaluation. It
accepts a single arbitrary value that is not recursed into, making it
useful for values coming from outside the module system, such as package
sets or arbitrary data. Options of this type are still evaluated according
to priorities and conditionals, so <code class="literal">mkForce</code>, <code class="literal">mkIf</code> and co. still work on
the option value itself, but not for any value nested within it. This type
should only be used when checking, merging and nested evaluation are not
desirable.</p></dd><dt><span class="term"><code class="literal">types.optionType</code></span></dt><dd><p>The type of an option’s type. Its merging operation ensures that nested
options have the correct file location annotated, and that if possible,
multiple option definitions are correctly merged together. The main use
case is as the type of the <code class="literal">_module.freeformType</code> option.</p></dd><dt><span class="term"><code class="literal">types.attrs</code></span></dt><dd><p>A free-form attribute set.</p><div class="warning"><h3 class="title">Warning</h3><p>This type will be deprecated in the future because it doesn’t
recurse into attribute sets, silently drops earlier attribute
definitions, and doesn’t discharge <code class="literal">lib.mkDefault</code>, <code class="literal">lib.mkIf</code>
and co. For allowing arbitrary attribute sets, prefer
<code class="literal">types.attrsOf types.anything</code> instead which doesn’t have these
problems.</p></div></dd><dt><span class="term"><code class="literal">types.pkgs</code></span></dt><dd><p>A type for the top level Nixpkgs package set.</p></dd></dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-option-types-numeric" class="title" >Numeric types   </h4>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.int</code></span></dt><dd><p>A signed integer.</p></dd><dt><span class="term"><code class="literal">types.ints.{s8, s16, s32}</code></span></dt><dd><p>Signed integers with a fixed length (8, 16 or 32 bits). They go from
−2^n/2 to
2^n/2−1 respectively (e.g. <code class="literal">−128</code> to
<code class="literal">127</code> for 8 bits).</p></dd><dt><span class="term"><code class="literal">types.ints.unsigned</code></span></dt><dd><p>An unsigned integer (that is &gt;= 0).</p></dd><dt><span class="term"><code class="literal">types.ints.{u8, u16, u32}</code></span></dt><dd><p>Unsigned integers with a fixed length (8, 16 or 32 bits). They go
from 0 to 2^n−1 respectively (e.g. <code class="literal">0</code>
to <code class="literal">255</code> for 8 bits).</p></dd><dt><span class="term"><code class="literal">types.ints.between</code> <span class="emphasis"><em><code class="literal">lowest highest</code></em></span></span></dt><dd><p>An integer between <span class="emphasis"><em><code class="literal">lowest</code></em></span> and <span class="emphasis"><em><code class="literal">highest</code></em></span> (both inclusive).</p></dd><dt><span class="term"><code class="literal">types.ints.positive</code></span></dt><dd><p>A positive integer (that is &gt; 0).</p></dd><dt><span class="term"><code class="literal">types.port</code></span></dt><dd><p>A port number. This type is an alias to
<code class="literal">types.ints.u16</code>.</p></dd><dt><span class="term"><code class="literal">types.float</code></span></dt><dd><p>A floating point number.</p><div class="warning"><h3 class="title">Warning</h3><p>Converting a floating point number to a string with <code class="literal">toString</code> or <code class="literal">toJSON</code>
may result in <a class="link" href="https://github.com/NixOS/nix/issues/5733"  target="_top">precision loss</a>.</p></div></dd><dt><span class="term"><code class="literal">types.number</code></span></dt><dd><p>Either a signed integer or a floating point number. No implicit conversion
is done between the two types, and multiple equal definitions will only be
merged if they have the same type.</p></dd><dt><span class="term"><code class="literal">types.numbers.between</code> <span class="emphasis"><em><code class="literal">lowest highest</code></em></span></span></dt><dd><p>An integer or floating point number between <span class="emphasis"><em><code class="literal">lowest</code></em></span> and <span class="emphasis"><em><code class="literal">highest</code></em></span> (both inclusive).</p></dd><dt><span class="term"><code class="literal">types.numbers.nonnegative</code></span></dt><dd><p>A nonnegative integer or floating point number (that is &gt;= 0).</p></dd><dt><span class="term"><code class="literal">types.numbers.positive</code></span></dt><dd><p>A positive integer or floating point number (that is &gt; 0).</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-option-types-string" class="title" >String types   </h4>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.str</code></span></dt><dd><p>A string. Multiple definitions cannot be merged.</p></dd><dt><span class="term"><code class="literal">types.separatedString</code> <span class="emphasis"><em><code class="literal">sep</code></em></span></span></dt><dd><p>A string. Multiple definitions are concatenated with <span class="emphasis"><em><code class="literal">sep</code></em></span>, e.g.
<code class="literal">types.separatedString &quot;|&quot;</code>.</p></dd><dt><span class="term"><code class="literal">types.lines</code></span></dt><dd><p>A string. Multiple definitions are concatenated with a new line
<code class="literal">&quot;\n&quot;</code>.</p></dd><dt><span class="term"><code class="literal">types.commas</code></span></dt><dd><p>A string. Multiple definitions are concatenated with a comma <code class="literal">&quot;,&quot;</code>.</p></dd><dt><span class="term"><code class="literal">types.envVar</code></span></dt><dd><p>A string. Multiple definitions are concatenated with a colon <code class="literal">&quot;:&quot;</code>.</p></dd><dt><span class="term"><code class="literal">types.strMatching</code></span></dt><dd><p>A string matching a specific regular expression. Multiple
definitions cannot be merged. The regular expression is processed
using <code class="literal">builtins.match</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-option-types-specialised" class="title" >Specialised types   </h4>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.luaInline</code></span></dt><dd><p>A string wrapped using <code class="literal">lib.mkLuaInline</code>. Allows embedding lua expressions
inline within generated lua. Multiple definitions cannot be merged.</p></dd></dl></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-submodule" class="title" >Submodule types   </h3>  </div> </div></div><p>Submodules are detailed in <a class="link" href="index.html#section-option-types-submodule" title="Submodule" >Submodule</a>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.submodule</code> <span class="emphasis"><em><code class="literal">o</code></em></span></span></dt><dd><p>A set of sub options <span class="emphasis"><em><code class="literal">o</code></em></span>. <span class="emphasis"><em><code class="literal">o</code></em></span> can be an attribute set, a function
returning an attribute set, or a path to a file containing such a
value. Submodules are used in composed types to create modular
options. This is equivalent to
<code class="literal">types.submoduleWith { modules = toList o; shorthandOnlyDefinesConfig = true; }</code>.</p></dd><dt><span class="term"><code class="literal">types.submoduleWith</code> { <span class="emphasis"><em><code class="literal">modules</code></em></span>, <span class="emphasis"><em><code class="literal">specialArgs</code></em></span> ? {}, <span class="emphasis"><em><code class="literal">shorthandOnlyDefinesConfig</code></em></span> ? false }</span></dt><dd><p>Like <code class="literal">types.submodule</code>, but more flexible and with better defaults.
It has parameters</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><span class="emphasis"><em><code class="literal">modules</code></em></span> A list of modules to use by default for this
submodule type. This gets combined with all option definitions
to build the final list of modules that will be included.</p><div class="note"><h3 class="title">Note</h3><p>Only options defined with this argument are included in rendered
documentation.</p></div></li><li class="listitem"><p><span class="emphasis"><em><code class="literal">specialArgs</code></em></span> An attribute set of extra arguments to be passed
to the module functions. The option <code class="literal">_module.args</code> should be
used instead for most arguments since it allows overriding.
<span class="emphasis"><em><code class="literal">specialArgs</code></em></span> should only be used for arguments that can’t go
through the module fixed-point, because of infinite recursion or
other problems. An example is overriding the <code class="literal">lib</code> argument,
because <code class="literal">lib</code> itself is used to define <code class="literal">_module.args</code>, which
makes using <code class="literal">_module.args</code> to define it impossible.</p></li><li class="listitem"><p><span class="emphasis"><em><code class="literal">shorthandOnlyDefinesConfig</code></em></span> Whether definitions of this type
should default to the <code class="literal">config</code> section of a module (see
<a class="link" href="index.html#ex-module-syntax" title="Example 12. Structure of NixOS Modules" >Example: Structure of NixOS Modules</a>)
if it is an attribute set. Enabling this only has a benefit
when the submodule defines an option named <code class="literal">config</code> or <code class="literal">options</code>.
In such a case it would allow the option to be set with
<code class="literal">the-submodule.config = &quot;value&quot;</code> instead of requiring
<code class="literal">the-submodule.config.config = &quot;value&quot;</code>. This is because
only when modules <span class="emphasis"><em>don’t</em></span> set the <code class="literal">config</code> or <code class="literal">options</code>
keys, all keys are interpreted as option definitions in the
<code class="literal">config</code> section. Enabling this option implicitly puts all
attributes in the <code class="literal">config</code> section.</p><p>With this option enabled, defining a non-<code class="literal">config</code> section
requires using a function:
<code class="literal">the-submodule = { ... }: { options = { ... }; }</code>.</p></li></ul></div></dd><dt><span class="term"><code class="literal">types.deferredModule</code></span></dt><dd><p>Whereas <code class="literal">submodule</code> represents an option tree, <code class="literal">deferredModule</code> represents
a module value, such as a module file or a configuration.</p><p>It can be set multiple times.</p><p>Module authors can use its value in <code class="literal">imports</code>, in <code class="literal">submoduleWith</code>’s <code class="literal">modules</code>
or in <code class="literal">evalModules</code>’ <code class="literal">modules</code> parameter, among other places.</p><p>Note that <code class="literal">imports</code> must be evaluated before the module fixpoint. Because
of this, deferred modules can only be imported into “other” fixpoints, such
as submodules.</p><p>One use case for this type is the type of a “default” module that allow the
user to affect all submodules in an <code class="literal">attrsOf submodule</code> at once. This is
more convenient and discoverable than expecting the module user to
type-merge with the <code class="literal">attrsOf submodule</code> option.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-unions" class="title" >Union types   </h3>  </div> </div></div><p>A union of types is a type such that a value is valid when it is valid for at least one of those types.</p><p>If some values are instances of more than one of the types, it is not possible to distinguish which type they are meant to be instances of. If that’s needed, consider using a <a class="link" href="index.html#sec-option-types-sums" title="Sum types" >sum type</a>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.either</code> <span class="emphasis"><em><code class="literal">t1 t2</code></em></span></span></dt><dd><p>Type <span class="emphasis"><em><code class="literal">t1</code></em></span> or type <span class="emphasis"><em><code class="literal">t2</code></em></span>, e.g. <code class="literal">with types; either int str</code>.
Multiple definitions cannot be merged.</p></dd><dt><span class="term"><code class="literal">types.oneOf</code> [ <span class="emphasis"><em><code class="literal">t1 t2</code></em></span> … ]</span></dt><dd><p>Type <span class="emphasis"><em><code class="literal">t1</code></em></span> or type <span class="emphasis"><em><code class="literal">t2</code></em></span> and so forth, e.g.
<code class="literal">with types; oneOf [ int str bool ]</code>. Multiple definitions cannot be
merged.</p></dd><dt><span class="term"><code class="literal">types.nullOr</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p><code class="literal">null</code> or type <span class="emphasis"><em><code class="literal">t</code></em></span>. Multiple definitions are merged according to
type <span class="emphasis"><em><code class="literal">t</code></em></span>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-sums" class="title" >Sum types   </h3>  </div> </div></div><p>A sum type can be thought of, conceptually, as a <span class="emphasis"><em><code class="literal">types.enum</code></em></span> where each valid item is paired with at least a type, through some value syntax.
Nix does not have a built-in syntax for this pairing of a label and a type or value, so sum types may be represented in multiple ways.</p><p>If the you’re interested in can be distinguished without a label, you may simplify your value syntax with a <a class="link" href="index.html#sec-option-types-unions" title="Union types" >union type</a> instead.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.attrTag</code> <span class="emphasis"><em><code class="literal">{ attr1 = option1; attr2 = option2; ... }</code></em></span></span></dt><dd><p>An attribute set containing one attribute, whose name must be picked from
the attribute set (<code class="literal">attr1</code>, etc) and whose value consists of definitions that are valid for the corresponding option (<code class="literal">option1</code>, etc).</p><p>This type appears in the documentation as <span class="emphasis"><em>attribute-tagged union</em></span>.</p><p>Example:</p><pre><code class="programlisting nix">{ lib, ... }:
let inherit (lib) type mkOption;
in {
  options.toyRouter.rules = mkOption {
    description = &#x27;&#x27;
      Rules for a fictional packet routing service.
    &#x27;&#x27;;
    type = types.attrsOf (
      types.attrTag {
        bounce = mkOption {
          description = &quot;Send back a packet explaining why it wasn&#x27;t forwarded.&quot;;
          type = types.submodule {
            options.errorMessage = mkOption { … };
          };
        };
        forward = mkOption {
          description = &quot;Forward the packet.&quot;;
          type = types.submodule {
            options.destination = mkOption { … };
          };
        };
        drop = types.mkOption {
          description = &quot;Drop the packet without sending anything back.&quot;;
          type = types.submodule {};
        };
      });
  };
  config.toyRouter.rules = {
    http = {
      bounce = {
        errorMessage = &quot;Unencrypted HTTP is banned. You must always use https://.&quot;;
      };
    };
    ssh = { drop = {}; };
  };
}
</code></pre></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-composed" class="title" >Composed types   </h3>  </div> </div></div><p>Composed types are types that take a type as parameter. <code class="literal">listOf    int</code> and <code class="literal">either int str</code> are examples of composed types.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.listOf</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p>A list of <span class="emphasis"><em><code class="literal">t</code></em></span> type, e.g. <code class="literal">types.listOf         int</code>. Multiple definitions are merged with list concatenation.</p></dd><dt><span class="term"><code class="literal">types.attrsOf</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p>An attribute set of where all the values are of <span class="emphasis"><em><code class="literal">t</code></em></span> type. Multiple
definitions result in the joined attribute set.</p><div class="note"><h3 class="title">Note</h3><p>This type is <span class="emphasis"><em>strict</em></span> in its values, which in turn means attributes
cannot depend on other attributes. See <code class="literal">          types.lazyAttrsOf</code> for a lazy version.</p></div></dd><dt><span class="term"><code class="literal">types.lazyAttrsOf</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p>An attribute set of where all the values are of <span class="emphasis"><em><code class="literal">t</code></em></span> type. Multiple
definitions result in the joined attribute set. This is the lazy
version of <code class="literal">types.attrsOf         </code>, allowing attributes to depend on each other.</p><div class="warning"><h3 class="title">Warning</h3><p>This version does not fully support conditional definitions! With an
option <code class="literal">foo</code> of this type and a definition
<code class="literal">foo.attr = lib.mkIf false 10</code>, evaluating <code class="literal">foo ? attr</code> will return
<code class="literal">true</code> even though it should be false. Accessing the value will then
throw an error. For types <span class="emphasis"><em><code class="literal">t</code></em></span> that have an <code class="literal">emptyValue</code> defined,
that value will be returned instead of throwing an error. So if the
type of <code class="literal">foo.attr</code> was <code class="literal">lazyAttrsOf (nullOr int)</code>, <code class="literal">null</code> would be
returned instead for the same <code class="literal">mkIf false</code> definition.</p></div></dd><dt><span class="term"><code class="literal">types.attrsWith</code> { <span class="emphasis"><em><code class="literal">elemType</code></em></span>, <span class="emphasis"><em><code class="literal">lazy</code></em></span> ? false, <span class="emphasis"><em><code class="literal">placeholder</code></em></span> ? “name” }</span></dt><dd><p>An attribute set of where all the values are of <span class="emphasis"><em><code class="literal">elemType</code></em></span> type.</p><p><span class="strong"><strong>Parameters</strong></span></p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">elemType</code> (Required)</span></dt><dd><p>Specifies the type of the values contained in the attribute set.</p></dd><dt><span class="term"><code class="literal">lazy</code></span></dt><dd><p>Determines whether the attribute set is lazily evaluated. See: <code class="literal">types.lazyAttrsOf</code></p></dd><dt><span class="term"><code class="literal">placeholder</code> (<code class="literal">String</code>, default: <code class="literal">name</code> )</span></dt><dd><p>Placeholder string in documentation for the attribute names.
The default value <code class="literal">name</code> results in the placeholder <code class="literal">&lt;name&gt;</code></p></dd></dl></div><p><span class="strong"><strong>Behavior</strong></span></p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">attrsWith { elemType = t; }</code> is equivalent to <code class="literal">attrsOf t</code></p></li><li class="listitem"><p><code class="literal">attrsWith { lazy = true; elemType = t; }</code> is equivalent to <code class="literal">lazyAttrsOf t</code></p></li><li class="listitem"><p><code class="literal">attrsWith { placeholder = &quot;id&quot;; elemType = t; }</code></p><p>Displays the option as <code class="literal">foo.&lt;id&gt;</code> in the manual.</p></li></ul></div></dd><dt><span class="term"><code class="literal">types.uniq</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p>Ensures that type <span class="emphasis"><em><code class="literal">t</code></em></span> cannot be merged. It is used to ensure option
definitions are provided only once.</p></dd><dt><span class="term"><code class="literal">types.unique</code> <code class="literal">{ message = m }</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p>Ensures that type <span class="emphasis"><em><code class="literal">t</code></em></span> cannot be merged. Prints the message <span class="emphasis"><em><code class="literal">m</code></em></span>, after
the line <code class="literal">The option &lt;option path&gt; is defined multiple times.</code> and before
a list of definition locations.</p></dd><dt><span class="term"><code class="literal">types.coercedTo</code> <span class="emphasis"><em><code class="literal">from f to</code></em></span></span></dt><dd><p>Type <span class="emphasis"><em><code class="literal">to</code></em></span> or type <span class="emphasis"><em><code class="literal">from</code></em></span> which will be coerced to type <span class="emphasis"><em><code class="literal">to</code></em></span> using
function <span class="emphasis"><em><code class="literal">f</code></em></span> which takes an argument of type <span class="emphasis"><em><code class="literal">from</code></em></span> and return a
value of type <span class="emphasis"><em><code class="literal">to</code></em></span>. Can be used to preserve backwards compatibility
of an option if its type was changed.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="section-option-types-submodule" class="title" >Submodule   </h3>  </div> </div></div><p><code class="literal">submodule</code> is a very powerful type that defines a set of sub-options
that are handled like a separate module.</p><p>It takes a parameter <span class="emphasis"><em><code class="literal">o</code></em></span>, that should be a set, or a function returning
a set with an <code class="literal">options</code> key defining the sub-options. Submodule option
definitions are type-checked accordingly to the <code class="literal">options</code> declarations.
Of course, you can nest submodule option definitions for even higher
modularity.</p><p>The option set can be defined directly
(<a class="link" href="index.html#ex-submodule-direct" title="Example 23. Directly defined submodule" >Example: Directly defined submodule</a>) or as reference
(<a class="link" href="index.html#ex-submodule-reference" title="Example 24. Submodule defined as a reference" >Example: Submodule defined as a reference</a>).</p><p>Note that even if your submodule’s options all have a default value,
you will still need to provide a default value (e.g. an empty attribute set)
if you want to allow users to leave it undefined.</p><div class="example"><span id="ex-submodule-direct" ></span><details><summary><span class="title"><strong>Example 23. Directly defined submodule</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  options.mod = mkOption {
    description = &quot;submodule example&quot;;
    type = with types; submodule {
      options = {
        foo = mkOption {
          type = int;
        };
        bar = mkOption {
          type = str;
        };
      };
    };
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-submodule-reference" ></span><details><summary><span class="title"><strong>Example 24. Submodule defined as a reference</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">let
  modOptions = {
    options = {
      foo = mkOption {
        type = int;
      };
      bar = mkOption {
        type = int;
      };
    };
  };
in
{
  options.mod = mkOption {
    description = &quot;submodule example&quot;;
    type = with types; submodule modOptions;
  };
}
</code></pre></div></details></div><br class="example-break" /><p>The <code class="literal">submodule</code> type is especially interesting when used with composed
types like <code class="literal">attrsOf</code> or <code class="literal">listOf</code>. When composed with <code class="literal">listOf</code>
(<a class="link" href="index.html#ex-submodule-listof-declaration" title="Example 25. Declaration of a list of submodules" >Example: Declaration of a list of submodules</a>), <code class="literal">submodule</code> allows
multiple definitions of the submodule option set
(<a class="link" href="index.html#ex-submodule-listof-definition" title="Example 26. Definition of a list of submodules" >Example: Definition of a list of submodules</a>).</p><div class="example"><span id="ex-submodule-listof-declaration" ></span><details><summary><span class="title"><strong>Example 25. Declaration of a list of submodules</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  options.mod = mkOption {
    description = &quot;submodule example&quot;;
    type = with types; listOf (submodule {
      options = {
        foo = mkOption {
          type = int;
        };
        bar = mkOption {
          type = str;
        };
      };
    });
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-submodule-listof-definition" ></span><details><summary><span class="title"><strong>Example 26. Definition of a list of submodules</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  config.mod = [
    { foo = 1; bar = &quot;one&quot;; }
    { foo = 2; bar = &quot;two&quot;; }
  ];
}
</code></pre></div></details></div><br class="example-break" /><p>When composed with <code class="literal">attrsOf</code>
(<a class="link" href="index.html#ex-submodule-attrsof-declaration" title="Example 27. Declaration of attribute sets of submodules" >Example: Declaration of attribute sets of submodules</a>), <code class="literal">submodule</code> allows
multiple named definitions of the submodule option set
(<a class="link" href="index.html#ex-submodule-attrsof-definition" title="Example 28. Definition of attribute sets of submodules" >Example: Definition of attribute sets of submodules</a>).</p><div class="example"><span id="ex-submodule-attrsof-declaration" ></span><details><summary><span class="title"><strong>Example 27. Declaration of attribute sets of submodules</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  options.mod = mkOption {
    description = &quot;submodule example&quot;;
    type = with types; attrsOf (submodule {
      options = {
        foo = mkOption {
          type = int;
        };
        bar = mkOption {
          type = str;
        };
      };
    });
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-submodule-attrsof-definition" ></span><details><summary><span class="title"><strong>Example 28. Definition of attribute sets of submodules</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  config.mod.one = { foo = 1; bar = &quot;one&quot;; };
  config.mod.two = { foo = 2; bar = &quot;two&quot;; };
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-extending" class="title" >Extending types   </h3>  </div> </div></div><p>Types are mainly characterized by their <code class="literal">check</code> and <code class="literal">merge</code> functions.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">check</code></span></dt><dd><p>The function to type check the value. Takes a value as parameter and
return a boolean. It is possible to extend a type check with the
<code class="literal">addCheck</code> function (<a class="link" href="index.html#ex-extending-type-check-1" title="Example 29. Adding a type check" >Example: Adding a type check</a>),
or to fully override the check function
(<a class="link" href="index.html#ex-extending-type-check-2" title="Example 30. Overriding a type check" >Example: Overriding a type check</a>).</p><div class="example"><span id="ex-extending-type-check-1" ></span><details><summary><span class="title"><strong>Example 29. Adding a type check</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  byte = mkOption {
    description = &quot;An integer between 0 and 255.&quot;;
    type = types.addCheck types.int (x: x &gt;= 0 &amp;&amp; x &lt;= 255);
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-extending-type-check-2" ></span><details><summary><span class="title"><strong>Example 30. Overriding a type check</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  nixThings = mkOption {
    description = &quot;words that start with &#x27;nix&#x27;&quot;;
    type = types.str // {
      check = (x: lib.hasPrefix &quot;nix&quot; x);
    };
  };
}
</code></pre></div></details></div><br class="example-break" /></dd><dt><span class="term"><code class="literal">merge</code></span></dt><dd><p>Function to merge the options values when multiple values are set.
The function takes two parameters, <code class="literal">loc</code> the option path as a list
of strings, and <code class="literal">defs</code> the list of defined values as a list. It is
possible to override a type merge function for custom needs.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-custom" class="title" >Custom types   </h3>  </div> </div></div><p>Custom types can be created with the <code class="literal">mkOptionType</code> function. As type
creation includes some more complex topics such as submodule handling,
it is recommended to get familiar with <code class="literal">types.nix</code> code before creating
a new type.</p><p>The only required parameter is <code class="literal">name</code>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>A string representation of the type function name.</p></dd><dt><span class="term"><code class="literal">description</code></span></dt><dd><p>Description of the type used in documentation. Give information of
the type and any of its arguments.</p></dd><dt><span class="term"><code class="literal">check</code></span></dt><dd><p>A function to type check the definition value. Takes the definition
value as a parameter and returns a boolean indicating the type check
result, <code class="literal">true</code> for success and <code class="literal">false</code> for failure.</p></dd><dt><span class="term"><code class="literal">merge</code></span></dt><dd><p>A function to merge multiple definitions values. Takes two
parameters:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em><code class="literal">loc</code></em></span></span></dt><dd><p>The option path as a list of strings, e.g. <code class="literal">[&quot;boot&quot; &quot;loader            &quot;grub&quot; &quot;enable&quot;]</code>.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">defs</code></em></span></span></dt><dd><p>The list of sets of defined <code class="literal">value</code> and <code class="literal">file</code> where the value
was defined, e.g. <code class="literal">[ {            file = &quot;/foo.nix&quot;; value = 1; } { file = &quot;/bar.nix&quot;; value = 2 }            ]</code>. The <code class="literal">merge</code> function should return the merged value
or throw an error in case the values are impossible or not meant
to be merged.</p></dd></dl></div></dd><dt><span class="term"><code class="literal">getSubOptions</code></span></dt><dd><p>For composed types that can take a submodule as type parameter, this
function generate sub-options documentation. It takes the current
option prefix as a list and return the set of sub-options. Usually
defined in a recursive manner by adding a term to the prefix, e.g.
<code class="literal">prefix:         elemType.getSubOptions (prefix ++         [&quot;prefix&quot;])</code> where <span class="emphasis"><em><code class="literal">&quot;prefix&quot;</code></em></span> is the newly added prefix.</p></dd><dt><span class="term"><code class="literal">getSubModules</code></span></dt><dd><p>For composed types that can take a submodule as type parameter, this
function should return the type parameters submodules. If the type
parameter is called <code class="literal">elemType</code>, the function should just recursively
look into submodules by returning <code class="literal">elemType.getSubModules;</code>.</p></dd><dt><span class="term"><code class="literal">substSubModules</code></span></dt><dd><p>For composed types that can take a submodule as type parameter, this
function can be used to substitute the parameter of a submodule
type. It takes a module as parameter and return the type with the
submodule options substituted. It is usually defined as a type
function call with a recursive call to <code class="literal">substSubModules</code>, e.g for a
type <code class="literal">composedType</code> that take an <code class="literal">elemtype</code> type parameter, this
function should be defined as <code class="literal">m:         composedType (elemType.substSubModules m)</code>.</p></dd><dt><span class="term"><code class="literal">typeMerge</code></span></dt><dd><p>A function to merge multiple type declarations. Takes the type to
merge <code class="literal">functor</code> as parameter. A <code class="literal">null</code> return value means that type
cannot be merged.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em><code class="literal">f</code></em></span></span></dt><dd><p>The type to merge <code class="literal">functor</code>.</p></dd></dl></div><p>Note: There is a generic <code class="literal">defaultTypeMerge</code> that work with most of
value and composed types.</p></dd><dt><span class="term"><code class="literal">functor</code></span></dt><dd><p>An attribute set representing the type. It is used for type
operations and has the following keys:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">type</code></span></dt><dd><p>The type function.</p></dd><dt><span class="term"><code class="literal">wrapped</code></span></dt><dd><p>Holds the type parameter for composed types.</p></dd><dt><span class="term"><code class="literal">payload</code></span></dt><dd><p>Holds the value parameter for value types. The types that have a
<code class="literal">payload</code> are the <code class="literal">enum</code>, <code class="literal">separatedString</code> and <code class="literal">submodule</code>
types.</p></dd><dt><span class="term"><code class="literal">binOp</code></span></dt><dd><p>A binary operation that can merge the payloads of two same
types. Defined as a function that take two payloads as
parameters and return the payloads merged.</p></dd></dl></div></dd></dl></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-option-definitions" class="title" style="clear: both">Option Definitions   </h2>  </div> </div></div><p>Option definitions are generally straight-forward bindings of values to
option names, like</p><pre><code class="programlisting nix">{
  config = {
    services.httpd.enable = true;
  };
}
</code></pre><p>However, sometimes you need to wrap an option definition or set of
option definitions in a <span class="emphasis"><em>property</em></span> to achieve certain effects:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-definitions-delaying-conditionals" class="title" >Delaying Conditionals   </h3>  </div> </div></div><p>If a set of option definitions is conditional on the value of another
option, you may need to use <code class="literal">mkIf</code>. Consider, for instance:</p><pre><code class="programlisting nix">{
  config = if config.services.httpd.enable then {
    environment.systemPackages = [ /* ... */ ];
    # ...
  } else {};
}
</code></pre><p>This definition will cause Nix to fail with an “infinite recursion”
error. Why? Because the value of <code class="literal">config.services.httpd.enable</code> depends
on the value being constructed here. After all, you could also write the
clearly circular and contradictory:</p><pre><code class="programlisting nix">{
  config = if config.services.httpd.enable then {
    services.httpd.enable = false;
  } else {
    services.httpd.enable = true;
  };
}
</code></pre><p>The solution is to write:</p><pre><code class="programlisting nix">{
  config = mkIf config.services.httpd.enable {
    environment.systemPackages = [ /* ... */ ];
    # ...
  };
}
</code></pre><p>The special function <code class="literal">mkIf</code> causes the evaluation of the conditional to
be “pushed down” into the individual definitions, as if you had written:</p><pre><code class="programlisting nix">{
  config = {
    environment.systemPackages = if config.services.httpd.enable then [ /* ... */ ] else [];
    # ...
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-definitions-setting-priorities" class="title" >Setting Priorities   </h3>  </div> </div></div><p>A module can override the definitions of an option in other modules by
setting an <span class="emphasis"><em>override priority</em></span>. All option definitions that do not have the lowest
priority value are discarded. By default, option definitions have
priority 100 and option defaults have priority 1500.
You can specify an explicit priority by using <code class="literal">mkOverride</code>, e.g.</p><pre><code class="programlisting nix">{
  services.openssh.enable = mkOverride 10 false;
}
</code></pre><p>This definition causes all other definitions with priorities above 10 to
be discarded. The function <code class="literal">mkForce</code> is equal to <code class="literal">mkOverride 50</code>, and
<code class="literal">mkDefault</code> is equal to <code class="literal">mkOverride 1000</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-definitions-ordering" class="title" >Ordering Definitions   </h3>  </div> </div></div><p>It is also possible to influence the order in which the definitions for an option are
merged by setting an <span class="emphasis"><em>order priority</em></span> with <code class="literal">mkOrder</code>. The default order priority is 1000.
The functions <code class="literal">mkBefore</code> and <code class="literal">mkAfter</code> are equal to <code class="literal">mkOrder 500</code> and <code class="literal">mkOrder 1500</code>, respectively.
As an example,</p><pre><code class="programlisting nix">{
  hardware.firmware = mkBefore [ myFirmware ];
}
</code></pre><p>This definition ensures that <code class="literal">myFirmware</code> comes before other unordered
definitions in the final list value of <code class="literal">hardware.firmware</code>.</p><p>Note that this is different from <a class="link" href="index.html#sec-option-definitions-setting-priorities" title="Setting Priorities" >override priorities</a>:
setting an order does not affect whether the definition is included or not.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-definitions-merging" class="title" >Merging Configurations   </h3>  </div> </div></div><p>In conjunction with <code class="literal">mkIf</code>, it is sometimes useful for a module to
return multiple sets of option definitions, to be merged together as if
they were declared in separate modules. This can be done using
<code class="literal">mkMerge</code>:</p><pre><code class="programlisting nix">{
  config = mkMerge
    [ # Unconditional stuff.
      { environment.systemPackages = [ /* ... */ ];
      }
      # Conditional stuff.
      (mkIf config.services.bla.enable {
        environment.systemPackages = [ /* ... */ ];
      })
    ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-definitions-definitions" class="title" >Free-floating definitions   </h3>  </div> </div></div><div class="note"><h3 class="title">Note</h3><p>The module system internally transforms module syntax into definitions. This always happens internally.</p></div><p>It is possible to create first class definitions which are not transformed <span class="emphasis"><em>again</em></span> into definitions by the module system.</p><p>Usually the file location of a definition is implicit and equal to the file it came from.
However, when manipulating definitions, it may be useful for them to be completely self-contained (or “free-floating”).</p><p>A free-floating definition is created with <code class="literal">mkDefinition { file = ...; value = ...; }</code>.</p><p>Preserving the file location creates better error messages, for example when copying definitions from one option to another.</p><p>Other properties like <code class="literal">mkOverride</code> <code class="literal">mkMerge</code> <code class="literal">mkAfter</code> can be used in the <code class="literal">value</code> attribute but not on the entire definition.</p><p>This is what would work</p><pre><code class="programlisting nix">mkDefinition {
   value = mkForce 42;
   file = &quot;somefile.nix&quot;;
}
</code></pre><p>While this would NOT work.</p><pre><code class="programlisting nix">mkForce (mkDefinition {
   value = 42;
   file = &quot;somefile.nix&quot;;
})
</code></pre><p>The following shows an example configuration that yields an error with the custom position information:</p><pre><code class="programlisting nix">{
  _file = &quot;file.nix&quot;;
  options.foo = mkOption {
    default = 13;
  };
  config.foo = lib.mkDefinition {
    file = &quot;custom place&quot;;
    # mkOptionDefault creates a conflict with the option foo&#x27;s `default = 1` on purpose
    # So we see the error message below contains the conflicting values and different positions
    value = lib.mkOptionDefault 42;
  };
}
</code></pre><p>evaluating the module yields the following error:</p><pre><code class="programlisting">error: Cannot merge definitions of `foo&#x27;. Definition values:
- In `file.nix&#x27;: 13
- In `custom place&#x27;: 42
</code></pre><p>To set the file location for all definitions in a module, you may add the <code class="literal">_file</code> module syntax attribute, which has a similar effect to using <code class="literal">mkDefinition</code> on all definitions in the module, without the hassle.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-assertions" class="title" style="clear: both">Warnings and Assertions   </h2>  </div> </div></div><p>When configuration problems are detectable in a module, it is a good idea to write an assertion or warning. Doing so provides clear feedback to the user and prevents errors after the build.</p><p>Although Nix has the <code class="literal">abort</code> and <code class="literal">builtins.trace</code> <a class="link" href="https://nixos.org/nix/manual/#ssec-builtins"  target="_top">functions</a> to perform such tasks, they are not ideally suited for NixOS modules. Instead of these functions, you can declare your warnings and assertions using the NixOS module system.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-assertions-warnings" class="title" >Warnings   </h3>  </div> </div></div><p>This is an example of using <code class="literal">warnings</code>.</p><pre><code class="programlisting nix">{ config, lib, ... }:
{
  config = lib.mkIf config.services.foo.enable {
    warnings =
      if config.services.foo.bar
      then [ &#x27;&#x27;You have enabled the bar feature of the foo service.
               This is known to cause some specific problems in certain situations.
               &#x27;&#x27; ]
      else [];
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-assertions-assetions" class="title" >Assertions   </h3>  </div> </div></div><p>This example, extracted from the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/release-17.09/nixos/modules/services/logging/syslogd.nix"  target="_top"><code class="literal">syslogd</code> module</a> shows how to use <code class="literal">assertions</code>. Since there can only be one active syslog daemon at a time, an assertion is useful to prevent such a broken system from being built.</p><pre><code class="programlisting nix">{ config, lib, ... }:
{
  config = lib.mkIf config.services.syslogd.enable {
    assertions =
      [ { assertion = !config.services.rsyslogd.enable;
          message = &quot;rsyslogd conflicts with syslogd&quot;;
        }
      ];
  };
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-meta-attributes" class="title" style="clear: both">Meta Attributes   </h2>  </div> </div></div><p>Like Nix packages, NixOS modules can declare meta-attributes to provide
extra information. Module meta attributes are defined in the <code class="literal">meta.nix</code>
special module.</p><p><code class="literal">meta</code> is a top level attribute like <code class="literal">options</code> and <code class="literal">config</code>. Available
meta-attributes are <code class="literal">maintainers</code>, <code class="literal">doc</code>, and <code class="literal">buildDocsInSandbox</code>.</p><p>Each of the meta-attributes must be defined at most once per module
file.</p><pre><code class="programlisting nix">{ config, lib, pkgs, ... }:
{
  options = {
    # ...
  };

  config = {
    # ...
  };

  meta = {
    maintainers = with lib.maintainers; [ ];
    doc = ./default.md;
    buildDocsInSandbox = true;
  };
}
</code></pre><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">maintainers</code> contains a list of the module maintainers.</p></li><li class="listitem"><p><code class="literal">doc</code> points to a valid <a class="link" href="https://nixos.org/manual/nixpkgs/unstable/#sec-contributing-markup"  target="_top">Nixpkgs-flavored CommonMark</a> file containing the module
documentation. Its contents is automatically added to
<a class="xref" href="index.html#ch-configuration" title="Configuration" >Configuration</a>. Changes to a module documentation have to
be checked to not break building the NixOS manual:</p><pre><code class="programlisting ShellSession">$ nix-build nixos/release.nix -A manual.x86_64-linux
</code></pre></li><li class="listitem"><p><code class="literal">buildDocsInSandbox</code> indicates whether the option documentation for the
module can be built in a derivation sandbox. This option is currently only
honored for modules shipped by nixpkgs. User modules and modules taken from
<code class="literal">extraModules</code> are always built outside of the sandbox, as has
been the case in previous releases.</p><p>Building NixOS option documentation in a sandbox allows caching of the built
documentation, which greatly decreases the amount of time needed to evaluate
a system configuration that has NixOS documentation enabled. The sandbox also
restricts which attributes may be referenced by documentation attributes
(such as option descriptions) to the <code class="literal">options</code> and <code class="literal">lib</code> module arguments and
the <code class="literal">pkgs.formats</code> attribute of the <code class="literal">pkgs</code> argument, <code class="literal">config</code> and the rest of
<code class="literal">pkgs</code> are disallowed and will cause doc build failures when used. This
restriction is necessary because we cannot reproduce the full nixpkgs
instantiation with configuration and overlays from a system configuration
inside the sandbox. The <code class="literal">options</code> argument only includes options of modules
that are also built inside the sandbox, referencing an option of a module
that isn’t built in the sandbox is also forbidden.</p><p>The default is <code class="literal">true</code> and should usually not be changed; set it to <code class="literal">false</code>
only if the module requires access to <code class="literal">pkgs</code> in its documentation (e.g.
because it loads information from a linked package to build an option type)
or if its documentation depends on other modules that also aren’t sandboxed
(e.g. by using types defined in the other module).</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-importing-modules" class="title" style="clear: both">Importing Modules   </h2>  </div> </div></div><p>Sometimes NixOS modules need to be used in configuration but exist
outside of Nixpkgs. These modules can be imported:</p><pre><code class="programlisting nix">{ config, lib, pkgs, ... }:

{
  imports =
    [ # Use a locally-available module definition in
      # ./example-module/default.nix
        ./example-module
    ];

  services.exampleModule.enable = true;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-replace-modules" class="title" style="clear: both">Replace Modules   </h2>  </div> </div></div><p>Modules that are imported can also be disabled. The option declarations,
config implementation and the imports of a disabled module will be
ignored, allowing another to take its place. This can be used to
import a set of modules from another channel while keeping the rest of
the system on a stable release.</p><p><code class="literal">disabledModules</code> is a top level attribute like <code class="literal">imports</code>, <code class="literal">options</code> and
<code class="literal">config</code>. It contains a list of modules that will be disabled. This can
either be:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>the full path to the module,</p></li><li class="listitem"><p>or a string with the filename relative to the modules path (eg. &lt;nixpkgs/nixos/modules&gt; for nixos),</p></li><li class="listitem"><p>or an attribute set containing a specific <code class="literal">key</code> attribute.</p></li></ul></div><p>The latter allows some modules to be disabled, despite them being distributed
via attributes instead of file paths. The <code class="literal">key</code> should be globally unique, so
it is recommended to include a file path in it, or rely on a framework to do it
for you.</p><p>This example will replace the existing postgresql module with the
version defined in the nixos-unstable channel while keeping the rest of
the modules and packages from the original nixos channel. This only
overrides the module definition, this won’t use postgresql from
nixos-unstable unless explicitly configured to do so.</p><pre><code class="programlisting nix">{ config, lib, pkgs, ... }:

{
  disabledModules = [ &quot;services/databases/postgresql.nix&quot; ];

  imports =
    [ # Use postgresql service from nixos-unstable channel.
      # sudo nix-channel --add https://nixos.org/channels/nixos-unstable nixos-unstable
      &lt;nixos-unstable/nixos/modules/services/databases/postgresql.nix&gt;
    ];

  services.postgresql.enable = true;
}
</code></pre><p>This example shows how to define a custom module as a replacement for an
existing module. Importing this module will disable the original module
without having to know its implementation details.</p><pre><code class="programlisting nix">{ config, lib, pkgs, ... }:

let
  inherit (lib) mkIf mkOption types;
  cfg = config.programs.man;
in

{
  disabledModules = [ &quot;services/programs/man.nix&quot; ];

  options = {
    programs.man.enable = mkOption {
      type = types.bool;
      default = true;
      description = &quot;Whether to enable manual pages.&quot;;
    };
  };

  config = mkIf cfg.enabled {
    warnings = [ &quot;disabled manpages for production deployments.&quot; ];
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-freeform-modules" class="title" style="clear: both">Freeform modules   </h2>  </div> </div></div><p>Freeform modules allow you to define values for option paths that have
not been declared explicitly. This can be used to add attribute-specific
types to what would otherwise have to be <code class="literal">attrsOf</code> options in order to
accept all attribute names.</p><p>This feature can be enabled by using the attribute <code class="literal">freeformType</code> to
define a freeform type. By doing this, all assignments without an
associated option will be merged using the freeform type and combined
into the resulting <code class="literal">config</code> set. Since this feature nullifies name
checking for entire option trees, it is only recommended for use in
submodules.</p><div class="example"><span id="ex-freeform-module" ></span><details><summary><span class="title"><strong>Example 31. Freeform submodule</strong></span></summary><div class="example-contents"><p>The following shows a submodule assigning a freeform type that allows
arbitrary attributes with <code class="literal">str</code> values below <code class="literal">settings</code>, but also
declares an option for the <code class="literal">settings.port</code> attribute to have it
type-checked and assign a default value. See
<a class="link" href="index.html#ex-settings-typed-attrs" title="Example 33. Declaring a type-checked settings attribute" >Example: Declaring a type-checked <code class="literal">settings</code> attribute</a>
for a more complete example.</p><pre><code class="programlisting nix">{ lib, config, ... }: {

  options.settings = lib.mkOption {
    type = lib.types.submodule {

      freeformType = with lib.types; attrsOf str;

      # We want this attribute to be checked for the correct type
      options.port = lib.mkOption {
        type = lib.types.port;
        # Declaring the option also allows defining a default value
        default = 8080;
      };

    };
  };
}
</code></pre><p>And the following shows what such a module then allows</p><pre><code class="programlisting nix">{
  # Not a declared option, but the freeform type allows this
  settings.logLevel = &quot;debug&quot;;

  # Not allowed because the the freeform type only allows strings
  # settings.enable = true;

  # Allowed because there is a port option declared
  settings.port = 80;

  # Not allowed because the port option doesn&#x27;t allow strings
  # settings.port = &quot;443&quot;;
}
</code></pre></div></details></div><br class="example-break" /><div class="note"><h3 class="title">Note</h3><p>Freeform attributes cannot depend on other attributes of the same set
without infinite recursion:</p><pre><code class="programlisting nix">{
  # This throws infinite recursion encountered
  settings.logLevel = lib.mkIf (config.settings.port == 80) &quot;debug&quot;;
}
</code></pre><p>To prevent this, declare options for all attributes that need to depend
on others. For above example this means to declare <code class="literal">logLevel</code> to be an
option.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-settings-options" class="title" style="clear: both">Options for Program Settings   </h2>  </div> </div></div><p>Many programs have configuration files where program-specific settings
can be declared. File formats can be separated into two categories:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Nix-representable ones: These can trivially be mapped to a subset of
Nix syntax. E.g. JSON is an example, since its values like
<code class="literal">{&quot;foo&quot;:{&quot;bar&quot;:10}}</code> can be mapped directly to Nix:
<code class="literal">{ foo = { bar = 10; }; }</code>. Other examples are INI, YAML and TOML.
The following section explains the convention for these settings.</p></li><li class="listitem"><p>Non-nix-representable ones: These can’t be trivially mapped to a
subset of Nix syntax. Most generic programming languages are in this
group, e.g. bash, since the statement <code class="literal">if true; then echo hi; fi</code>
doesn’t have a trivial representation in Nix.</p><p>Currently there are no fixed conventions for these, but it is common
to have a <code class="literal">configFile</code> option for setting the configuration file
path directly. The default value of <code class="literal">configFile</code> can be an
auto-generated file, with convenient options for controlling the
contents. For example an option of type <code class="literal">attrsOf str</code> can be used
for representing environment variables which generates a section
like <code class="literal">export FOO=&quot;foo&quot;</code>. Often it can also be useful to also include
an <code class="literal">extraConfig</code> option of type <code class="literal">lines</code> to allow arbitrary text
after the autogenerated part of the file.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-settings-nix-representable" class="title" >Nix-representable Formats (JSON, YAML, TOML, INI, …)   </h3>  </div> </div></div><p>By convention, formats like this are handled with a generic <code class="literal">settings</code>
option, representing the full program configuration as a Nix value. The
type of this option should represent the format. The most common formats
have a predefined type and string generator already declared under
<code class="literal">pkgs.formats</code>:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pkgs.formats.javaProperties</code> { <span class="emphasis"><em><code class="literal">comment</code></em></span> ? <code class="literal">&quot;Generated with Nix&quot;</code> }</span></dt><dd><p>A function taking an attribute set with values</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">comment</code></span></dt><dd><p>A string to put at the start of the
file in a comment. It can have multiple
lines.</p></dd></dl></div><p>It returns the <code class="literal">type</code>: <code class="literal">attrsOf str</code> and a function
<code class="literal">generate</code> to build a Java <code class="literal">.properties</code> file, taking
care of the correct escaping, etc.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.hocon</code> { <span class="emphasis"><em><code class="literal">generator</code></em></span> ? <code class="literal">&lt;derivation&gt;</code>, <span class="emphasis"><em><code class="literal">validator</code></em></span> ? <code class="literal">&lt;derivation&gt;</code>, <span class="emphasis"><em><code class="literal">doCheck</code></em></span> ? true }</span></dt><dd><p>A function taking an attribute set with values</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">generator</code></span></dt><dd><p>A derivation used for converting the JSON output
from the nix settings into HOCON. This might be
useful if your HOCON variant is slightly different
from the java-based one, or for testing purposes.</p></dd><dt><span class="term"><code class="literal">validator</code></span></dt><dd><p>A derivation used for verifying that the HOCON
output is correct and parsable. This might be
useful if your HOCON variant is slightly different
from the java-based one, or for testing purposes.</p></dd><dt><span class="term"><code class="literal">doCheck</code></span></dt><dd><p>Whether to enable/disable the validator check.</p></dd></dl></div><p>It returns an attrset with a <code class="literal">type</code>, <code class="literal">generate</code> function,
and a <code class="literal">lib</code> attset, as specified <a class="link" href="index.html#pkgs-formats-result"  >below</a>.
Some of the lib functions will be best understood if you have
read the reference specification. You can find this
specification here:</p><p><a class="link" href="https://github.com/lightbend/config/blob/main/HOCON.md"  target="_top">https://github.com/lightbend/config/blob/main/HOCON.md</a></p><p>Inside of <code class="literal">lib</code>, you will find these functions</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">mkInclude</code></span></dt><dd><p>This is used together with a specially named
attribute <code class="literal">includes</code>, to include other HOCON
sources into the document.</p><p>The function has a shorthand variant where it
is up to the HOCON parser to figure out what type
of include is being used. The include will default
to being non-required. If you want to be more
explicit about the details of the include, you can
provide an attrset with following arguments</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">required</code></span></dt><dd><p>Whether the parser should fail upon failure
to include the document</p></dd><dt><span class="term"><code class="literal">type</code></span></dt><dd><p>Type of the source of the included document.
Valid values are <code class="literal">file</code>, <code class="literal">url</code> and <code class="literal">classpath</code>.
See upstream documentation for the semantics
behind each value</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>The URI/path/classpath pointing to the source of
the document to be included.</p></dd></dl></div><p><code class="literal">Example usage:</code></p><pre><code class="programlisting nix">  let
    format = pkgs.formats.hocon { };
    hocon_file = pkgs.writeText &quot;to_include.hocon&quot; &#x27;&#x27;
      a = 1;
    &#x27;&#x27;;
  in {
    some.nested.hocon.attrset = {
      _includes = [
        (format.lib.mkInclude hocon_file)
        (format.lib.mkInclude &quot;https://example.com/to_include.hocon&quot;)
        (format.lib.mkInclude {
          required = true;
          type = &quot;file&quot;;
          value = include_file;
        })
      ];
      ...
    };
  }
</code></pre></dd><dt><span class="term"><code class="literal">mkAppend</code></span></dt><dd><p>This is used to invoke the <code class="literal">+=</code> operator.
This can be useful if you need to add something
to a list that is included from outside of nix.
See upstream documentation for the semantics
behind the <code class="literal">+=</code> operation.</p><p><code class="literal">Example usage:</code></p><pre><code class="programlisting nix">  let
    format = pkgs.formats.hocon { };
    hocon_file = pkgs.writeText &quot;to_include.hocon&quot; &#x27;&#x27;
      a = [ 1 ];
      b = [ 2 ];
    &#x27;&#x27;;
  in {
    _includes = [
      (format.lib.mkInclude hocon_file)
    ];

    c = 3;
    a = format.lib.mkAppend 3;
    b = format.lib.mkAppend (format.lib.mkSubstitution &quot;c&quot;);
  }
</code></pre></dd><dt><span class="term"><code class="literal">mkSubstitution</code></span></dt><dd><p>This is used to make HOCON substitutions.
Similarly to <code class="literal">mkInclude</code>, this function has
a shorthand variant where you just give it
the string with the substitution value.
The substitution is not optional by default.
Alternatively, you can provide an attrset
with more options</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">optional</code></span></dt><dd><p>Whether the parser should fail upon
failure to fetch the substitution value.</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>The name of the variable to use for
substitution.</p></dd></dl></div><p>See upstream documentation for semantics
behind the substitution functionality.</p><p><code class="literal">Example usage:</code></p><pre><code class="programlisting nix">  let
    format = pkgs.formats.hocon { };
  in {
    a = 1;
    b = format.lib.mkSubstitution &quot;a&quot;;
    c = format.lib.mkSubstitution &quot;SOME_ENVVAR&quot;;
    d = format.lib.mkSubstitution {
      value = &quot;SOME_OPTIONAL_ENVVAR&quot;;
      optional = true;
    };
  }
</code></pre></dd></dl></div><p><code class="literal">Implementation notes:</code></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>classpath includes are not implemented in pyhocon,
which is used for validating the HOCON output. This
means that if you are using classpath includes,
you will want to either use an alternative validator
or set <code class="literal">doCheck = false</code> in the format options.</p></li></ul></div></dd><dt><span class="term"><code class="literal">pkgs.formats.libconfig</code> { <span class="emphasis"><em><code class="literal">generator</code></em></span> ? <code class="literal">&lt;derivation&gt;</code>, <span class="emphasis"><em><code class="literal">validator</code></em></span> ? <code class="literal">&lt;derivation&gt;</code> }</span></dt><dd><p>A function taking an attribute set with values</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">generator</code></span></dt><dd><p>A derivation used for converting the JSON output
from the nix settings into libconfig. This might be
useful if your libconfig variant is slightly different
from the original one, or for testing purposes.</p></dd><dt><span class="term"><code class="literal">validator</code></span></dt><dd><p>A derivation used for verifying that the libconfig
output is correct and parsable. This might be
useful if your libconfig variant is slightly different
from the original one, or for testing purposes.</p></dd></dl></div><p>It returns an attrset with a <code class="literal">type</code>, <code class="literal">generate</code> function,
and a <code class="literal">lib</code> attset, as specified <a class="link" href="index.html#pkgs-formats-result"  >below</a>.
Some of the lib functions will be best understood if you have
read the reference specification. You can find this
specification here:</p><p><a class="link" href="https://hyperrealm.github.io/libconfig/libconfig_manual.html#Configuration-Files"  target="_top">https://hyperrealm.github.io/libconfig/libconfig_manual.html#Configuration-Files</a></p><p>Inside of <code class="literal">lib</code>, you will find these functions</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">mkHex</code>, <code class="literal">mkOctal</code>, <code class="literal">mkFloat</code></span></dt><dd><p>Use these to specify numbers in other formats.</p><p><code class="literal">Example usage:</code></p><pre><code class="programlisting nix">  let
    format = pkgs.formats.libconfig { };
  in {
    myHexValue = format.lib.mkHex &quot;0x1FC3&quot;;
    myOctalValue = format.lib.mkOctal &quot;0027&quot;;
    myFloatValue = format.lib.mkFloat &quot;1.2E-3&quot;;
  }
</code></pre></dd><dt><span class="term"><code class="literal">mkArray</code>, <code class="literal">mkList</code></span></dt><dd><p>Use these to differentiate between whether
a nix list should be considered as a libconfig
array or a libconfig list. See the upstream
documentation for the semantics behind these types.</p><p><code class="literal">Example usage:</code></p><pre><code class="programlisting nix">  let
    format = pkgs.formats.libconfig { };
  in {
    myList = format.lib.mkList [ &quot;foo&quot; 1 true ];
    myArray = format.lib.mkArray [ 1 2 3 ];
  }
</code></pre></dd></dl></div><p><code class="literal">Implementation notes:</code></p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Since libconfig does not allow setting names to start with an underscore,
this is used as a prefix for both special types and include directives.</p></li><li class="listitem"><p>The difference between 32bit and 64bit values became optional in libconfig
1.5, so we assume 64bit values for all numbers.</p></li></ul></div></dd><dt><span class="term"><code class="literal">pkgs.formats.json</code> { }</span></dt><dd><p>A function taking an empty attribute set (for future extensibility)
and returning a set with JSON-specific attributes <code class="literal">type</code> and
<code class="literal">generate</code> as specified <a class="link" href="index.html#pkgs-formats-result"  >below</a>.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.yaml</code> { }</span></dt><dd><p>A function taking an empty attribute set (for future extensibility)
and returning a set with YAML-specific attributes <code class="literal">type</code> and
<code class="literal">generate</code> as specified <a class="link" href="index.html#pkgs-formats-result"  >below</a>.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.ini</code> { <span class="emphasis"><em><code class="literal">listsAsDuplicateKeys</code></em></span> ? false, <span class="emphasis"><em><code class="literal">listToValue</code></em></span> ? null, ... }</span></dt><dd><p>A function taking an attribute set with values</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">listsAsDuplicateKeys</code></span></dt><dd><p>A boolean for controlling whether list values can be used to
represent duplicate INI keys</p></dd><dt><span class="term"><code class="literal">listToValue</code></span></dt><dd><p>A function for turning a list of values into a single value.</p></dd></dl></div><p>It returns a set with INI-specific attributes <code class="literal">type</code> and <code class="literal">generate</code>
as specified <a class="link" href="index.html#pkgs-formats-result"  >below</a>.
The type of the input is an <span class="emphasis"><em>attrset</em></span> of sections; key-value pairs where
the key is the section name and the value is the corresponding content
which is also an <span class="emphasis"><em>attrset</em></span> of key-value pairs for the actual key-value
mappings of the INI format.
The values of the INI atoms are subject to the above parameters (e.g. lists
may be transformed into multiple key-value pairs depending on
<code class="literal">listToValue</code>).</p><p>The attribute <code class="literal">lib.type.atom</code> contains the used INI atom.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.iniWithGlobalSection</code> { <span class="emphasis"><em><code class="literal">listsAsDuplicateKeys</code></em></span> ? false, <span class="emphasis"><em><code class="literal">listToValue</code></em></span> ? null, ... }</span></dt><dd><p>A function taking an attribute set with values</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">listsAsDuplicateKeys</code></span></dt><dd><p>A boolean for controlling whether list values can be used to
represent duplicate INI keys</p></dd><dt><span class="term"><code class="literal">listToValue</code></span></dt><dd><p>A function for turning a list of values into a single value.</p></dd></dl></div><p>It returns a set with INI-specific attributes <code class="literal">type</code> and <code class="literal">generate</code>
as specified <a class="link" href="index.html#pkgs-formats-result"  >below</a>.
The type of the input is an <span class="emphasis"><em>attrset</em></span> of the structure
<code class="literal">{ sections = {}; globalSection = {}; }</code> where <span class="emphasis"><em>sections</em></span> are several
sections as with <span class="emphasis"><em>pkgs.formats.ini</em></span> and <span class="emphasis"><em>globalSection</em></span> being just a single
attrset of key-value pairs for a single section, the global section which
precedes the section definitions.</p><p>The attribute <code class="literal">lib.type.atom</code> contains the used INI atom.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.toml</code> { }</span></dt><dd><p>A function taking an empty attribute set (for future extensibility)
and returning a set with TOML-specific attributes <code class="literal">type</code> and
<code class="literal">generate</code> as specified <a class="link" href="index.html#pkgs-formats-result"  >below</a>.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.xml</code> { format ? “badgerfish”, withHeader ? true}</span></dt><dd><p>A function taking an attribute set with values
and returning a set with XML-specific attributes <code class="literal">type</code> and
<code class="literal">generate</code> as specified <a class="link" href="index.html#pkgs-formats-result"  >below</a>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">format</code></span></dt><dd><p>Input format. Because XML can not be translated one-to-one, we have to use intermediate formats. Possible values:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">&quot;badgerfish&quot;</code>: Uses <a class="link" href="http://www.sklar.com/badgerfish/"  target="_top">badgerfish</a> conversion.</p></li></ul></div></dd><dt><span class="term"><code class="literal">withHeader</code></span></dt><dd><p>Outputs the xml with header.</p></dd></dl></div></dd><dt><span class="term"><code class="literal">pkgs.formats.cdn</code> { }</span></dt><dd><p>A function taking an empty attribute set (for future extensibility)
and returning a set with <a class="link" href="https://github.com/dzikoysk/cdn"  target="_top">CDN</a>-specific
attributes <code class="literal">type</code> and <code class="literal">generate</code> as specified <a class="link" href="index.html#pkgs-formats-result"  >below</a>.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.elixirConf { elixir ? pkgs.elixir }</code></span></dt><dd><p>A function taking an attribute set with values</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">elixir</code></span></dt><dd><p>The Elixir package which will be used to format the generated output</p></dd></dl></div><p>It returns a set with Elixir-Config-specific attributes <code class="literal">type</code>, <code class="literal">lib</code>, and
<code class="literal">generate</code> as specified <a class="link" href="index.html#pkgs-formats-result"  >below</a>.</p><p>The <code class="literal">lib</code> attribute contains functions to be used in settings, for
generating special Elixir values:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">mkRaw elixirCode</code></span></dt><dd><p>Outputs the given string as raw Elixir code</p></dd><dt><span class="term"><code class="literal">mkGetEnv { envVariable, fallback ? null }</code></span></dt><dd><p>Makes the configuration fetch an environment variable at runtime</p></dd><dt><span class="term"><code class="literal">mkAtom atom</code></span></dt><dd><p>Outputs the given string as an Elixir atom, instead of the default
Elixir binary string. Note: lowercase atoms still needs to be prefixed
with <code class="literal">:</code></p></dd><dt><span class="term"><code class="literal">mkTuple array</code></span></dt><dd><p>Outputs the given array as an Elixir tuple, instead of the default
Elixir list</p></dd><dt><span class="term"><code class="literal">mkMap attrset</code></span></dt><dd><p>Outputs the given attribute set as an Elixir map, instead of the
default Elixir keyword list</p></dd></dl></div></dd><dt><span class="term"><code class="literal">pkgs.formats.lua { asBindings ? false, multiline ? true, columnWidth ? 100, indentWidth ? 2, indentUsingTabs ? false }</code></span></dt><dd><p>A function taking an attribute set with values</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">asBindings</code> (default <code class="literal">false</code>)</span></dt><dd><p>Whether to treat attributes as variable bindings</p></dd><dt><span class="term"><code class="literal">multiline</code> (default <code class="literal">true</code>)</span></dt><dd><p>Whether to produce a multiline output. The output may still wrap across
multiple lines if it would otherwise exceed <code class="literal">columnWidth</code>.</p></dd><dt><span class="term"><code class="literal">columnWidth</code> (default <code class="literal">100</code>)</span></dt><dd><p>The column width to use to attempt to wrap lines.</p></dd><dt><span class="term"><code class="literal">indentWidth</code> (default <code class="literal">2</code>)</span></dt><dd><p>The width of a single indentation level.</p></dd><dt><span class="term"><code class="literal">indentUsingTabs</code> (default <code class="literal">false</code>)</span></dt><dd><p>Whether the indentation should use tabs instead of spaces.</p></dd></dl></div></dd><dt><span class="term"><code class="literal">pkgs.formats.php { finalVariable }</code> <span id="pkgs-formats-php"></span></span></dt><dd><p>A function taking an attribute set with values</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">finalVariable</code></span></dt><dd><p>The variable that will store generated expression (usually <code class="literal">config</code>). If set to <code class="literal">null</code>, generated expression will contain <code class="literal">return</code>.</p></dd></dl></div><p>It returns a set with PHP-Config-specific attributes <code class="literal">type</code>, <code class="literal">lib</code>, and
<code class="literal">generate</code> as specified <a class="link" href="index.html#pkgs-formats-result"  >below</a>.</p><p>The <code class="literal">lib</code> attribute contains functions to be used in settings, for
generating special PHP values:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">mkRaw phpCode</code></span></dt><dd><p>Outputs the given string as raw PHP code</p></dd><dt><span class="term"><code class="literal">mkMixedArray list set</code></span></dt><dd><p>Creates PHP array that contains both indexed and associative values. For example, <code class="literal">lib.mkMixedArray [ &quot;hello&quot; &quot;world&quot; ] { &quot;nix&quot; = &quot;is-great&quot;; }</code> returns <code class="literal">[&#x27;hello&#x27;, &#x27;world&#x27;, &#x27;nix&#x27; =&gt; &#x27;is-great&#x27;]</code></p></dd></dl></div></dd></dl></div><p><span id="pkgs-formats-result"></span>
These functions all return an attribute set with these values:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">type</code></span></dt><dd><p>A module system type representing a value of the format</p></dd><dt><span class="term"><code class="literal">lib</code></span></dt><dd><p>Utility functions for convenience, or special interactions with the format.
This attribute is optional. It may contain inside a <code class="literal">types</code> attribute
containing types specific to this format.</p></dd><dt><span class="term"><code class="literal">generate</code> <span class="emphasis"><em><code class="literal">filename jsonValue</code></em></span></span></dt><dd><p>A function that can render a value of the format to a file. Returns
a file path.</p><div class="note"><h3 class="title">Note</h3><p>This function puts the value contents in the Nix store. So this
should be avoided for secrets.</p></div></dd></dl></div><div class="example"><span id="ex-settings-nix-representable" ></span><details><summary><span class="title"><strong>Example 32. Module with conventional <code class="literal">settings</code> option</strong></span></summary><div class="example-contents"><p>The following shows a module for an example program that uses a JSON
configuration file. It demonstrates how above values can be used, along
with some other related best practices. See the comments for
explanations.</p><pre><code class="programlisting nix">{ options, config, lib, pkgs, ... }:
let
  cfg = config.services.foo;
  # Define the settings format used for this program
  settingsFormat = pkgs.formats.json {};
in {

  options.services.foo = {
    enable = lib.mkEnableOption &quot;foo service&quot;;

    settings = lib.mkOption {
      # Setting this type allows for correct merging behavior
      type = settingsFormat.type;
      default = {};
      description = &#x27;&#x27;
        Configuration for foo, see
        &lt;link xlink:href=&quot;https://example.com/docs/foo&quot;/&gt;
        for supported settings.
      &#x27;&#x27;;
    };
  };

  config = lib.mkIf cfg.enable {
    # We can assign some default settings here to make the service work by just
    # enabling it. We use `mkDefault` for values that can be changed without
    # problems
    services.foo.settings = {
      # Fails at runtime without any value set
      log_level = lib.mkDefault &quot;WARN&quot;;

      # We assume systemd&#x27;s `StateDirectory` is used, so we require this value,
      # therefore no mkDefault
      data_path = &quot;/var/lib/foo&quot;;

      # Since we use this to create a user we need to know the default value at
      # eval time
      user = lib.mkDefault &quot;foo&quot;;
    };

    environment.etc.&quot;foo.json&quot;.source =
      # The formats generator function takes a filename and the Nix value
      # representing the format value and produces a filepath with that value
      # rendered in the format
      settingsFormat.generate &quot;foo-config.json&quot; cfg.settings;

    # We know that the `user` attribute exists because we set a default value
    # for it above, allowing us to use it without worries here
    users.users.${cfg.settings.user} = { isSystemUser = true; };

    # ...
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-settings-attrs-options" class="title" >Option declarations for attributes   </h4>  </div> </div></div><p>Some <code class="literal">settings</code> attributes may deserve some extra care. They may need a
different type, default or merging behavior, or they are essential
options that should show their documentation in the manual. This can be
done using <a class="xref" href="index.html#sec-freeform-modules" title="Freeform modules" >the section called “Freeform modules”</a>.</p><p>We extend above example using freeform modules to declare an option for
the port, which will enforce it to be a valid integer and make it show
up in the manual.</p><div class="example"><span id="ex-settings-typed-attrs" ></span><details><summary><span class="title"><strong>Example 33. Declaring a type-checked <code class="literal">settings</code> attribute</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  settings = lib.mkOption {
    type = lib.types.submodule {

      freeformType = settingsFormat.type;

      # Declare an option for the port such that the type is checked and this option
      # is shown in the manual.
      options.port = lib.mkOption {
        type = lib.types.port;
        default = 8080;
        description = &#x27;&#x27;
          Which port this service should listen on.
        &#x27;&#x27;;
      };

    };
    default = {};
    description = &#x27;&#x27;
      Configuration for Foo, see
      &lt;link xlink:href=&quot;https://example.com/docs/foo&quot;/&gt;
      for supported values.
    &#x27;&#x27;;
  };
}
</code></pre></div></details></div><br class="example-break" />
</div>

</div>

</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-building-parts" class="title" >Building Specific Parts of NixOS   </h2>  </div> </div></div><p>With the command <code class="literal">nix-build</code>, you can build specific parts of your NixOS
configuration. This is done as follows:</p><pre><code class="programlisting ShellSession">$ cd /path/to/nixpkgs/nixos
$ nix-build -A config.option
</code></pre><p>where <code class="literal">option</code> is a NixOS option with type “derivation” (i.e. something
that can be built). Attributes of interest include:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">system.build.toplevel</code></span></dt><dd><p>The top-level option that builds the entire NixOS system. Everything
else in your configuration is indirectly pulled in by this option.
This is what <code class="literal">nixos-rebuild</code> builds and what <code class="literal">/run/current-system</code>
points to afterwards.</p><p>A shortcut to build this is:</p><pre><code class="programlisting ShellSession">$ nix-build -A system
</code></pre></dd><dt><span class="term"><code class="literal">system.build.manual.manualHTML</code></span></dt><dd><p>The NixOS manual.</p></dd><dt><span class="term"><code class="literal">system.build.etc</code></span></dt><dd><p>A tree of symlinks that form the static parts of <code class="literal">/etc</code>.</p></dd><dt><span class="term"><code class="literal">system.build.initialRamdisk</code> , <code class="literal">system.build.kernel</code></span></dt><dd><p>The initial ramdisk and kernel of the system. This allows a quick
way to test whether the kernel and the initial ramdisk boot
correctly, by using QEMU’s <code class="literal">-kernel</code> and <code class="literal">-initrd</code> options:</p><pre><code class="programlisting ShellSession">$ nix-build -A config.system.build.initialRamdisk -o initrd
$ nix-build -A config.system.build.kernel -o kernel
$ qemu-system-x86_64 -kernel ./kernel/bzImage -initrd ./initrd/initrd -hda /dev/null
</code></pre></dd><dt><span class="term"><code class="literal">system.build.nixos-rebuild</code> , <code class="literal">system.build.nixos-install</code> , <code class="literal">system.build.nixos-generate-config</code></span></dt><dd><p>These build the corresponding NixOS commands.</p></dd><dt><span class="term"><code class="literal">systemd.units.unit-name.unit</code></span></dt><dd><p>This builds the unit with the specified name. Note that since unit
names contain dots (e.g. <code class="literal">httpd.service</code>), you need to put them
between quotes, like this:</p><pre><code class="programlisting ShellSession">$ nix-build -A &#x27;config.systemd.units.&quot;httpd.service&quot;.unit&#x27;
</code></pre><p>You can also test individual units, without rebuilding the whole
system, by putting them in <code class="literal">/run/systemd/system</code>:</p><pre><code class="programlisting ShellSession">$ cp $(nix-build -A &#x27;config.systemd.units.&quot;httpd.service&quot;.unit&#x27;)/httpd.service \
    /run/systemd/system/tmp-httpd.service
# systemctl daemon-reload
# systemctl start tmp-httpd.service
</code></pre><p>Note that the unit must not have the same name as any unit in
<code class="literal">/etc/systemd/system</code> since those take precedence over
<code class="literal">/run/systemd/system</code>. That’s why the unit is installed as
<code class="literal">tmp-httpd.service</code> here.</p></dd></dl></div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-bootspec" class="title" >Bootspec   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-bootspec-schema">Schema</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-bootspec-extensions">Extensions mechanism</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-bootspec-external-bootloaders">External bootloaders</a> </span></dt> </dl></div><p>Bootspec is a feature introduced in <a class="link" href="https://github.com/NixOS/rfcs/pull/125"  target="_top">RFC-0125</a> in order to standardize bootloader support and advanced boot workflows such as SecureBoot and potentially more.
The reference implementation can be found <a class="link" href="https://github.com/NixOS/nixpkgs/pull/172237"  target="_top">here</a>.</p><p>The creation of bootspec documents is enabled by default.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-bootspec-schema" class="title" style="clear: both">Schema   </h2>  </div> </div></div><p>The bootspec schema is versioned and validated against <a class="link" href="https://cuelang.org/"  target="_top">a CUE schema file</a> which should considered as the source of truth for your applications.</p><p>You will find the current version <a class="link" href="../../../modules/system/activation/bootspec.cue"  target="_top">here</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-bootspec-extensions" class="title" style="clear: both">Extensions mechanism   </h2>  </div> </div></div><p>Bootspec cannot account for all usecases.</p><p>For this purpose, Bootspec offers a generic extension facility <a class="link" href="options.html#opt-boot.bootspec.extensions"  target="_top"><code class="literal">boot.bootspec.extensions</code></a> which can be used to inject any data needed for your usecases.</p><p>An example for SecureBoot is to get the Nix store path to <code class="literal">/etc/os-release</code> in order to bake it into a unified kernel image:</p><pre><code class="programlisting nix">{ config, lib, ... }: {
  boot.bootspec.extensions = {
    &quot;org.secureboot.osRelease&quot; = config.environment.etc.&quot;os-release&quot;.source;
  };
}
</code></pre><p>To reduce incompatibility and prevent names from clashing between applications, it is <span class="strong"><strong>highly recommended</strong></span> to use a unique namespace for your extensions.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-bootspec-external-bootloaders" class="title" style="clear: both">External bootloaders   </h2>  </div> </div></div><p>It is possible to enable your own bootloader through <a class="link" href="options.html#opt-boot.loader.external.installHook"  target="_top"><code class="literal">boot.loader.external.installHook</code></a> which can wrap an existing bootloader.</p><p>Currently, there is no good story to compose existing bootloaders to enrich their features, e.g. SecureBoot, etc.
It will be necessary to reimplement or reuse existing parts.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-switching-systems" class="title" >What happens during a system switch?   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-unit-handling">Unit handling</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-activation-script">Activation script</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-non-switchable-system">Non Switchable Systems</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-etc-overlay"><code class="literal">/etc</code> via overlay filesystem</a> </span></dt> </dl></div><p>Running <code class="literal">nixos-rebuild switch</code> is one of the more common tasks under NixOS.
This chapter explains some of the internals of this command to make it simpler
for new module developers to configure their units correctly and to make it
easier to understand what is happening and why for curious administrators.</p><p><code class="literal">nixos-rebuild</code>, like many deployment solutions, calls <code class="literal">switch-to-configuration</code>
which resides in a NixOS system at <code class="literal">$out/bin/switch-to-configuration</code>. The
script is called with the action that is to be performed like <code class="literal">switch</code>, <code class="literal">test</code>,
<code class="literal">boot</code>. There is also the <code class="literal">dry-activate</code> action which does not really perform
the actions but rather prints what it would do if you called it with <code class="literal">test</code>.
This feature can be used to check what service states would be changed if the
configuration was switched to.</p><p>If the action is <code class="literal">switch</code> or <code class="literal">boot</code>, the bootloader is updated first so the
configuration will be the next one to boot. Unless <code class="literal">NIXOS_NO_SYNC</code> is set to
<code class="literal">1</code>, <code class="literal">/nix/store</code> is synced to disk.</p><p>If the action is <code class="literal">switch</code> or <code class="literal">test</code>, the currently running system is inspected
and the actions to switch to the new system are calculated. This process takes
two data sources into account: <code class="literal">/etc/fstab</code> and the current systemd status.
Mounts and swaps are read from <code class="literal">/etc/fstab</code> and the corresponding actions are
generated. If the options of a mount are modified, for example, the proper <code class="literal">.mount</code>
unit is reloaded (or restarted if anything else changed and it’s neither the root
mount or the nix store). The current systemd state is inspected, the difference
between the current system and the desired configuration is calculated and
actions are generated to get to this state. There are a lot of nuances that can
be controlled by the units which are explained here.</p><p>After calculating what should be done, the actions are carried out. The order
of actions is always the same:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Stop units (<code class="literal">systemctl stop</code>)</p></li><li class="listitem"><p>Run activation script (<code class="literal">$out/activate</code>)</p></li><li class="listitem"><p>See if the activation script requested more units to restart</p></li><li class="listitem"><p>Restart systemd if needed (<code class="literal">systemd daemon-reexec</code>)</p></li><li class="listitem"><p>Forget about the failed state of units (<code class="literal">systemctl reset-failed</code>)</p></li><li class="listitem"><p>Reload systemd (<code class="literal">systemctl daemon-reload</code>)</p></li><li class="listitem"><p>Reload systemd user instances (<code class="literal">systemctl --user daemon-reload</code>)</p></li><li class="listitem"><p>Reactivate sysinit (<code class="literal">systemctl restart sysinit-reactivation.target</code>)</p></li><li class="listitem"><p>Reload units (<code class="literal">systemctl reload</code>)</p></li><li class="listitem"><p>Restart units (<code class="literal">systemctl restart</code>)</p></li><li class="listitem"><p>Start units (<code class="literal">systemctl start</code>)</p></li><li class="listitem"><p>Inspect what changed during these actions and print units that failed and
that were newly started</p></li></ul></div><p>By default, some units are filtered from the outputs to make it less spammy.
This can be disabled for development or testing by setting the environment variable
<code class="literal">STC_DISPLAY_ALL_UNITS=1</code></p><p>Most of these actions are either self-explaining but some of them have to do
with our units or the activation script. For this reason, these topics are
explained in the next sections.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-unit-handling" class="title" style="clear: both">Unit handling   </h2>  </div> </div></div><p>To figure out what units need to be started/stopped/restarted/reloaded, the
script first checks the current state of the system, similar to what <code class="literal">systemctl list-units</code> shows. For each of the units, the script goes through the following
checks:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Is the unit file still in the new system? If not, <span class="strong"><strong>stop</strong></span> the service unless
it sets <code class="literal">X-StopOnRemoval</code> in the <code class="literal">[Unit]</code> section to <code class="literal">false</code>.</p></li><li class="listitem"><p>Is it a <code class="literal">.target</code> unit? If so, <span class="strong"><strong>start</strong></span> it unless it sets
<code class="literal">RefuseManualStart</code> in the <code class="literal">[Unit]</code> section to <code class="literal">true</code> or <code class="literal">X-OnlyManualStart</code>
in the <code class="literal">[Unit]</code> section to <code class="literal">true</code>. Also <span class="strong"><strong>stop</strong></span> the unit again unless it
sets <code class="literal">X-StopOnReconfiguration</code> to <code class="literal">false</code>.</p></li><li class="listitem"><p>Are the contents of the unit files different? They are compared by parsing
them and comparing their contents. If they are different but only
<code class="literal">X-Reload-Triggers</code> in the <code class="literal">[Unit]</code> section is changed, <span class="strong"><strong>reload</strong></span> the unit.
The NixOS module system allows setting these triggers with the option
<a class="link" href="options.html#opt-systemd.services"  >systemd.services.&lt;name&gt;.reloadTriggers</a>. There are
some additional keys in the <code class="literal">[Unit]</code> section that are ignored as well. If the
unit files differ in any way, the following actions are performed:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: circle;"><li class="listitem"><p><code class="literal">.path</code> and <code class="literal">.slice</code> units are ignored. There is no need to restart them
since changes in their values are applied by systemd when systemd is
reloaded.</p></li><li class="listitem"><p><code class="literal">.mount</code> units are <span class="strong"><strong>reload</strong></span>ed if only their <code class="literal">Options</code> changed. If anything
else changed (like <code class="literal">What</code>), they are <span class="strong"><strong>restart</strong></span>ed unless they are the mount
unit for <code class="literal">/</code> or <code class="literal">/nix</code> in which case they are reloaded to prevent the system
from crashing. Note that this is the case for <code class="literal">.mount</code> units and not for
mounts from <code class="literal">/etc/fstab</code>. These are explained in <a class="xref" href="index.html#sec-switching-systems" title="What happens during a system switch?" ><em>What happens during a system switch?</em></a>.</p></li><li class="listitem"><p><code class="literal">.socket</code> units are currently ignored. This is to be fixed at a later
point.</p></li><li class="listitem"><p>The rest of the units (mostly <code class="literal">.service</code> units) are then <span class="strong"><strong>reload</strong></span>ed if
<code class="literal">X-ReloadIfChanged</code> in the <code class="literal">[Service]</code> section is set to <code class="literal">true</code> (exposed
via <a class="link" href="options.html#opt-systemd.services"  >systemd.services.&lt;name&gt;.reloadIfChanged</a>).
A little exception is done for units that were deactivated in the meantime,
for example because they require a unit that got stopped before. These
are <span class="strong"><strong>start</strong></span>ed instead of reloaded.</p></li><li class="listitem"><p>If the reload flag is not set, some more flags decide if the unit is
skipped. These flags are <code class="literal">X-RestartIfChanged</code> in the <code class="literal">[Service]</code> section
(exposed via
<a class="link" href="options.html#opt-systemd.services"  >systemd.services.&lt;name&gt;.restartIfChanged</a>),
<code class="literal">RefuseManualStop</code> in the <code class="literal">[Unit]</code> section, and <code class="literal">X-OnlyManualStart</code> in the
<code class="literal">[Unit]</code> section.</p></li><li class="listitem"><p>Further behavior depends on the unit having <code class="literal">X-StopIfChanged</code> in the
<code class="literal">[Service]</code> section set to <code class="literal">true</code> (exposed via
<a class="link" href="options.html#opt-systemd.services"  >systemd.services.&lt;name&gt;.stopIfChanged</a>). This is
set to <code class="literal">true</code> by default and must be explicitly turned off if not wanted.
If the flag is enabled, the unit is <span class="strong"><strong>stop</strong></span>ped and then <span class="strong"><strong>start</strong></span>ed. If
not, the unit is <span class="strong"><strong>restart</strong></span>ed. The goal of the flag is to make sure that
the new unit never runs in the old environment which is still in place
before the activation script is run. This behavior is different when the
service is socket-activated, as outlined in the following steps.</p></li><li class="listitem"><p>The last thing that is taken into account is whether the unit is a
service and socket-activated. A correspondence between a
<code class="literal">.service</code> and its <code class="literal">.socket</code> unit is detected automatically, but
services can <span class="strong"><strong>opt out</strong></span> of that detection by setting
<code class="literal">X-NotSocketActivated</code> to <code class="literal">yes</code> in their <code class="literal">[Service]</code>
section. Otherwise, if <code class="literal">X-StopIfChanged</code> is <span class="strong"><strong>not</strong></span> set, the
service is <span class="strong"><strong>restart</strong></span>ed with the others. If it is set, both the
service and the socket are <span class="strong"><strong>stop</strong></span>ped and the socket is
<span class="strong"><strong>start</strong></span>ed, leaving socket activation to start the service when
it’s needed.</p></li></ul></div></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-sysinit-reactivation" class="title" >Sysinit reactivation   </h3>  </div> </div></div><p><a class="link" href="https://www.freedesktop.org/software/systemd/man/latest/systemd.special.html#sysinit.target"  target="_top"><code class="literal">sysinit.target</code></a>
is a systemd target that encodes system initialization (i.e. early startup). A
few units that need to run very early in the bootup process are ordered to
finish before this target is reached. Probably the most notable one of these is
<code class="literal">systemd-tmpfiles-setup.service</code>. We will refer to these units as “sysinit
units”.</p><p>“Normal” systemd units, by default, are ordered AFTER <code class="literal">sysinit.target</code>. In
other words, these “normal” units expect all services ordered before
<code class="literal">sysinit.target</code> to have finished without explicitly declaring this dependency
relationship for each dependency. See the <a class="link" href="https://www.freedesktop.org/software/systemd/man/latest/bootup.html"  target="_top">systemd
bootup</a>
for more details on the bootup process.</p><p>When restarting both a unit ordered before <code class="literal">sysinit.target</code> as well as one
after, this presents a problem because they would be started at the same time
as they do not explicitly declare their dependency relations.</p><p>To solve this, NixOS has an artificial <code class="literal">sysinit-reactivation.target</code> which
allows you to ensure that services ordered before <code class="literal">sysinit.target</code> are
restarted correctly. This applies both to the ordering between these sysinit
services as well as ensuring that sysinit units are restarted before “normal”
units.</p><p>To make an existing sysinit service restart correctly during system switch, you
have to declare:</p><pre><code class="programlisting nix">{
  systemd.services.my-sysinit = {
    requiredBy = [ &quot;sysinit-reactivation.target&quot; ];
    before = [ &quot;sysinit-reactivation.target&quot; ];
    restartTriggers = [ config.environment.etc.&quot;my-sysinit.d&quot;.source ];
  };
}
</code></pre><p>You need to configure appropriate <code class="literal">restartTriggers</code> specific to your service.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-activation-script" class="title" style="clear: both">Activation script   </h2>  </div> </div></div><p>The activation script is a bash script called to activate the new
configuration which resides in a NixOS system in <code class="literal">$out/activate</code>. Since its
contents depend on your system configuration, the contents may differ.
This chapter explains how the script works in general and some common NixOS
snippets. Please be aware that the script is executed on every boot and system
switch, so tasks that can be performed in other places should be performed
there (for example letting a directory of a service be created by systemd using
mechanisms like <code class="literal">StateDirectory</code>, <code class="literal">CacheDirectory</code>, … or if that’s not
possible using <code class="literal">preStart</code> of the service).</p><p>Activation scripts are defined as snippets using
<a class="xref" href="options.html#opt-system.activationScripts"  ><code class="option">system.activationScripts</code></a>. They can either be a simple multiline string
or an attribute set that can depend on other snippets. The builder for the
activation script will take these dependencies into account and order the
snippets accordingly. As a simple example:</p><pre><code class="programlisting nix">{
  system.activationScripts.my-activation-script = {
    deps = [ &quot;etc&quot; ];
    # supportsDryActivation = true;
    text = &#x27;&#x27;
      echo &quot;Hallo i bims&quot;
    &#x27;&#x27;;
  };
}
</code></pre><p>This example creates an activation script snippet that is run after the <code class="literal">etc</code>
snippet. The special variable <code class="literal">supportsDryActivation</code> can be set so the snippet
is also run when <code class="literal">nixos-rebuild dry-activate</code> is run. To differentiate between
real and dry activation, the <code class="literal">$NIXOS_ACTION</code> environment variable can be
read which is set to <code class="literal">dry-activate</code> when a dry activation is done.</p><p>An activation script can write to special files instructing
<code class="literal">switch-to-configuration</code> to restart/reload units. The script will take these
requests into account and will incorporate the unit configuration as described
above. This means that the activation script will “fake” a modified unit file
and <code class="literal">switch-to-configuration</code> will act accordingly. By doing so, configuration
like <a class="link" href="options.html#opt-systemd.services"  >systemd.services.&lt;name&gt;.restartIfChanged</a> is
respected. Since the activation script is run <span class="strong"><strong>after</strong></span> services are already
stopped, <a class="link" href="options.html#opt-systemd.services"  >systemd.services.&lt;name&gt;.stopIfChanged</a>
cannot be taken into account anymore and the unit is always restarted instead
of being stopped and started afterwards.</p><p>The files that can be written to are <code class="literal">/run/nixos/activation-restart-list</code> and
<code class="literal">/run/nixos/activation-reload-list</code> with their respective counterparts for
dry activation being <code class="literal">/run/nixos/dry-activation-restart-list</code> and
<code class="literal">/run/nixos/dry-activation-reload-list</code>. Those files can contain
newline-separated lists of unit names where duplicates are being ignored. These
files are not create automatically and activation scripts must take the
possibility into account that they have to create them first.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-activation-script-nixos-snippets" class="title" >NixOS snippets   </h3>  </div> </div></div><p>There are some snippets NixOS enables by default because disabling them would
most likely break your system. This section lists a few of them and what they
do:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">binsh</code> creates <code class="literal">/bin/sh</code> which points to the runtime shell</p></li><li class="listitem"><p><code class="literal">etc</code> sets up the contents of <code class="literal">/etc</code>, this includes systemd units and
excludes <code class="literal">/etc/passwd</code>, <code class="literal">/etc/group</code>, and <code class="literal">/etc/shadow</code> (which are managed by
the <code class="literal">users</code> snippet)</p></li><li class="listitem"><p><code class="literal">hostname</code> sets the system’s hostname in the kernel (not in <code class="literal">/etc</code>)</p></li><li class="listitem"><p><code class="literal">modprobe</code> sets the path to the <code class="literal">modprobe</code> binary for module auto-loading</p></li><li class="listitem"><p><code class="literal">nix</code> prepares the nix store and adds a default initial channel</p></li><li class="listitem"><p><code class="literal">specialfs</code> is responsible for mounting filesystems like <code class="literal">/proc</code> and <code class="literal">sys</code></p></li><li class="listitem"><p><code class="literal">users</code> creates and removes users and groups by managing <code class="literal">/etc/passwd</code>,
<code class="literal">/etc/group</code> and <code class="literal">/etc/shadow</code>. This also creates home directories</p></li><li class="listitem"><p><code class="literal">usrbinenv</code> creates <code class="literal">/usr/bin/env</code></p></li><li class="listitem"><p><code class="literal">var</code> creates some directories in <code class="literal">/var</code> that are not service-specific</p></li><li class="listitem"><p><code class="literal">wrappers</code> creates setuid wrappers like <code class="literal">sudo</code></p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-non-switchable-system" class="title" style="clear: both">Non Switchable Systems   </h2>  </div> </div></div><p>In certain systems, most notably image based appliances, updates are handled
outside the system. This means that you do not need to rebuild your
configuration on the system itself anymore.</p><p>If you want to build such a system, you can use the <code class="literal">image-based-appliance</code>
profile:</p><pre><code class="programlisting nix">{ modulesPath, ... }: {
  imports = [ &quot;${modulesPath}/profiles/image-based-appliance.nix&quot; ];
}
</code></pre><p>The most notable deviation of this profile from a standard NixOS configuration
is that after building it, you cannot switch <span class="emphasis"><em>to</em></span> the configuration anymore.
The profile sets <code class="literal">config.system.switch.enable = false;</code>, which excludes
<code class="literal">switch-to-configuration</code>, the central script called by <code class="literal">nixos-rebuild</code>, from
your system. Removing this script makes the image lighter and slightly more
secure.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-etc-overlay" class="title" style="clear: both"><code class="literal">/etc</code> via overlay filesystem   </h2>  </div> </div></div><div class="note"><h3 class="title">Note</h3><p>This is experimental and requires a kernel version &gt;= 6.6 because it uses
new overlay features and relies on the new mount API.</p></div><p>Instead of using a custom perl script to activate <code class="literal">/etc</code>, you activate it via an
overlay filesystem:</p><pre><code class="programlisting nix">{
  system.etc.overlay.enable = true;
}
</code></pre><p>Using an overlay has two benefits:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>it removes a dependency on perl</p></li><li class="listitem"><p>it makes activation faster (up to a few seconds)</p></li></ol></div><p>By default, the <code class="literal">/etc</code> overlay is mounted writable (i.e. there is a writable
upper layer). However, you can also mount <code class="literal">/etc</code> immutably (i.e. read-only) by
setting:</p><pre><code class="programlisting nix">{
  system.etc.overlay.mutable = false;
}
</code></pre><p>The overlay is atomically replaced during system switch. However, files that
have been modified will NOT be overwritten. This is the biggest change compared
to the perl-based system.</p><p>If you manually make changes to <code class="literal">/etc</code> on your system and then switch to a new
configuration where <code class="literal">system.etc.overlay.mutable = false;</code>, you will not be able
to see the previously made changes in <code class="literal">/etc</code> anymore. However the changes are
not completely gone, they are still in the upperdir of the previous overlay in
<code class="literal">/.rw-etc/upper</code>.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-writing-documentation" class="title" >Writing NixOS Documentation   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-writing-docs-building-the-manual">Building the Manual</a> </span></dt> </dl></div><p>As NixOS grows, so too does the need for a catalogue and explanation of
its extensive functionality. Collecting pertinent information from
disparate sources and presenting it in an accessible style would be a
worthy contribution to the project.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-writing-docs-building-the-manual" class="title" style="clear: both">Building the Manual   </h2>  </div> </div></div><p>The sources of the <a class="xref" href="index.html" title="NixOS Manual" >NixOS Manual</a> are in the
<a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/doc/manual"  target="_top"><code class="literal">nixos/doc/manual</code></a>
subdirectory of the Nixpkgs repository.</p><p>You can quickly validate your edits with <code class="literal">devmode</code>:</p><pre><code class="programlisting ShellSession">$ cd /path/to/nixpkgs/nixos/doc/manual
$ nix-shell
[nix-shell:~]$ devmode
</code></pre><p>Once you are done making modifications to the manual, it’s important to
build it before committing. You can do that as follows:</p><pre><code class="programlisting ShellSession">nix-build nixos/release.nix -A manual.x86_64-linux
</code></pre><p>When this command successfully finishes, it will tell you where the
manual got generated. The HTML will be accessible through the <code class="literal">result</code>
symlink at <code class="literal">./result/share/doc/nixos/index.html</code>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-nixos-tests" class="title" >NixOS Tests   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-writing-nixos-tests">Writing Tests</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-running-nixos-tests">Running Tests</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-running-nixos-tests-interactively">Running Tests interactively</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-linking-nixos-tests-to-packages">Linking NixOS tests to packages</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-nixos-test-testing-hardware-features">Testing Hardware Features</a> </span></dt> </dl></div><p>When you add some feature to NixOS, you should write a test for it.
NixOS tests are kept in the directory <code class="literal">nixos/tests</code>, and are executed
(using Nix) by a testing framework that automatically starts one or more
virtual machines containing the NixOS system(s) required for the test.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-writing-nixos-tests" class="title" style="clear: both">Writing Tests   </h2>  </div> </div></div><p>A NixOS test is a module that has the following structure:</p><pre><code class="programlisting nix">{

  # One or more machines:
  nodes =
    { machine =
        { config, pkgs, ... }: { /* ... */ };
      machine2 =
        { config, pkgs, ... }: { /* ... */ };
      # …
    };

  testScript =
    &#x27;&#x27;
      Python code…
    &#x27;&#x27;;
}
</code></pre><p>We refer to the whole test above as a test module, whereas the values
in <a class="link" href="index.html#test-opt-nodes"  ><code class="literal">nodes.&lt;name&gt;</code></a> are NixOS modules themselves.</p><p>The option <a class="link" href="index.html#test-opt-testScript"  ><code class="literal">testScript</code></a> is a piece of Python code that executes the
test (described below). During the test, it will start one or more
virtual machines, the configuration of which is described by
the option <a class="link" href="index.html#test-opt-nodes"  ><code class="literal">nodes</code></a>.</p><p>An example of a single-node test is
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/login.nix"  target="_top"><code class="literal">login.nix</code></a>.
It only needs a single machine to test whether users can log in
on the virtual console, whether device ownership is correctly maintained
when switching between consoles, and so on. An interesting multi-node test is
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/nfs/simple.nix"  target="_top"><code class="literal">nfs/simple.nix</code></a>.
It uses two client nodes to test correct locking across server crashes.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-calling-nixos-tests" class="title" >Calling a test   </h3>  </div> </div></div><p>Tests are invoked differently depending on whether the test is part of NixOS or lives in a different project.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-call-nixos-test-in-nixos" class="title" >Testing within NixOS   </h4>  </div> </div></div><p>Tests that are part of NixOS are added to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/all-tests.nix"  target="_top"><code class="literal">nixos/tests/all-tests.nix</code></a>.</p><pre><code class="programlisting nix">{
  hostname = runTest ./hostname.nix;
}
</code></pre><p>Overrides can be added by defining an anonymous module in <code class="literal">all-tests.nix</code>.</p><pre><code class="programlisting nix">{
  hostname = runTest {
    imports = [ ./hostname.nix ];
    defaults.networking.firewall.enable = false;
  };
}
</code></pre><p>You can run a test with attribute name <code class="literal">hostname</code> in <code class="literal">nixos/tests/all-tests.nix</code> by invoking:</p><pre><code class="programlisting shell">cd /my/git/clone/of/nixpkgs
nix-build -A nixosTests.hostname
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-call-nixos-test-outside-nixos" class="title" >Testing outside the NixOS project   </h4>  </div> </div></div><p>Outside the <code class="literal">nixpkgs</code> repository, you can use the <code class="literal">runNixOSTest</code> function from
<code class="literal">pkgs.testers</code>:</p><pre><code class="programlisting nix">let pkgs = import &lt;nixpkgs&gt; {};
in

pkgs.testers.runNixOSTest {
  imports = [ ./test.nix ];
  defaults.services.foo.package = mypkg;
}
</code></pre><p><code class="literal">runNixOSTest</code> returns a derivation that runs the test.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-nodes" class="title" >Configuring the nodes   </h3>  </div> </div></div><p>There are a few special NixOS options for test VMs:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">virtualisation.memorySize</code></span></dt><dd><p>The memory of the VM in megabytes.</p></dd><dt><span class="term"><code class="literal">virtualisation.vlans</code></span></dt><dd><p>The virtual networks to which the VM is connected. See
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/nat.nix"  target="_top"><code class="literal">nat.nix</code></a>
for an example.</p></dd><dt><span class="term"><code class="literal">virtualisation.writableStore</code></span></dt><dd><p>By default, the Nix store in the VM is not writable. If you enable
this option, a writable union file system is mounted on top of the
Nix store to make it appear writable. This is necessary for tests
that run Nix operations that modify the store.</p></dd></dl></div><p>For more options, see the module
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/virtualisation/qemu-vm.nix"  target="_top"><code class="literal">qemu-vm.nix</code></a>.</p><p>The test script is a sequence of Python statements that perform various
actions, such as starting VMs, executing commands in the VMs, and so on.
Each virtual machine is represented as an object stored in the variable
<code class="literal">name</code> if this is also the identifier of the machine in the declarative
config. If you specified a node <code class="literal">nodes.machine</code>, the following example starts the
machine, waits until it has finished booting, then executes a command
and checks that the output is more-or-less correct:</p><pre><code class="programlisting py">machine.start()
machine.wait_for_unit(&quot;default.target&quot;)
t.assertIn(&quot;Linux&quot;, machine.succeed(&quot;uname&quot;), &quot;Wrong OS&quot;)
</code></pre><p>The first line is technically unnecessary; machines are implicitly started
when you first execute an action on them (such as <code class="literal">wait_for_unit</code> or
<code class="literal">succeed</code>). If you have multiple machines, you can speed up the test by
starting them in parallel:</p><pre><code class="programlisting py">start_all()
</code></pre><p>Under the variable <code class="literal">t</code>, all assertions from <a class="link" href="https://docs.python.org/3/library/unittest.html"  target="_top"><code class="literal">unittest.TestCase</code></a> are available.</p><p>If the hostname of a node contains characters that can’t be used in a
Python variable name, those characters will be replaced with
underscores in the variable name, so <code class="literal">nodes.machine-a</code> will be exposed
to Python as <code class="literal">machine_a</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-machine-objects" class="title" >Machine objects   </h3>  </div> </div></div><p>The following methods are available on machine objects:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">block()</span></dt><dd><p>Simulate unplugging the Ethernet cable that connects the machine to
the other machines.
This happens by shutting down eth1 (the multicast interface used to talk
to the other VMs). eth0 is kept online to still enable the test driver
to communicate with the machine.</p></dd><dt><span class="term">console_interact()</span></dt><dd><p>Allows you to directly interact with QEMU’s stdin, by forwarding
terminal input to the QEMU process.
This is for use with the interactive test driver, not for production
tests, which run unattended.
Output from QEMU is only read line-wise. <code class="literal">Ctrl-c</code> kills QEMU and
<code class="literal">Ctrl-d</code> closes console and returns to the test runner.</p></dd><dt><span class="term">copy_from_host(source, target)</span></dt><dd><p>Copies a file from host to machine, e.g.,
<code class="literal">copy_from_host(&quot;myfile&quot;, &quot;/etc/my/important/file&quot;)</code>.</p><p>The first argument is the file on the host. Note that the “host” refers
to the environment in which the test driver runs, which is typically the
Nix build sandbox.</p><p>The second argument is the location of the file on the machine that will
be written to.</p><p>The file is copied via the <code class="literal">shared_dir</code> directory which is shared among
all the VMs (using a temporary directory).
The access rights bits will mimic the ones from the host file and
user:group will be root:root.</p></dd><dt><span class="term">copy_from_host_via_shell(source, target)</span></dt><dd><p>Copy a file from the host into the guest by piping it over the
shell into the destination file. Works without host-guest shared folder.
Prefer copy_from_host for whenever possible.</p></dd><dt><span class="term">copy_from_vm(source, target_dir)</span></dt><dd><p>Copy a file from the VM (specified by an in-VM source path) to a path
relative to <code class="literal">$out</code>. The file is copied via the <code class="literal">shared_dir</code> shared among
all the VMs (using a temporary directory).</p></dd><dt><span class="term">crash()</span></dt><dd><p>Simulate a sudden power failure, by telling the VM to exit immediately.</p></dd><dt><span class="term">dump_tty_contents(tty)</span></dt><dd><p>Debugging: Dump the contents of the TTY&lt;n&gt;</p></dd><dt><span class="term">execute(command, check_return, check_output, timeout)</span></dt><dd><p>Execute a shell command, returning a list <code class="literal">(status, stdout)</code>.</p><p>Commands are run with <code class="literal">set -euo pipefail</code> set:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>If several commands are separated by <code class="literal">;</code> and one fails, the
command as a whole will fail.</p></li><li class="listitem"><p>For pipelines, the last non-zero exit status will be returned
(if there is one; otherwise zero will be returned).</p></li><li class="listitem"><p>Dereferencing unset variables fails the command.</p></li><li class="listitem"><p>It will wait for stdout to be closed.</p></li></ul></div><p>If the command detaches, it must close stdout, as <code class="literal">execute</code> will wait
for this to consume all output reliably. This can be achieved by
redirecting stdout to stderr <code class="literal">&gt;&amp;2</code>, to <code class="literal">/dev/console</code>, <code class="literal">/dev/null</code> or
a file. Examples of detaching commands are <code class="literal">sleep 365d &amp;</code>, where the
shell forks a new process that can write to stdout and <code class="literal">xclip -i</code>, where
the <code class="literal">xclip</code> command itself forks without closing stdout.</p><p>Takes an optional parameter <code class="literal">check_return</code> that defaults to <code class="literal">True</code>.
Setting this parameter to <code class="literal">False</code> will not check for the return code
and return -1 instead. This can be used for commands that shut down
the VM and would therefore break the pipe that would be used for
retrieving the return code.</p><p>A timeout for the command can be specified (in seconds) using the optional
<code class="literal">timeout</code> parameter, e.g., <code class="literal">execute(cmd, timeout=10)</code> or
<code class="literal">execute(cmd, timeout=None)</code>. The default is 900 seconds.</p></dd><dt><span class="term">fail()</span></dt><dd><p>Like <code class="literal">succeed</code>, but raising an exception if the command returns a zero
status.</p></dd><dt><span class="term">forward_port(host_port, guest_port)</span></dt><dd><p>Forward a TCP port on the host to a TCP port on the guest.
Useful during interactive testing.</p></dd><dt><span class="term">get_screen_text()</span></dt><dd><p>Return a textual representation of what is currently visible on the
machine’s screen using optical character recognition.</p><div class="note"><h3 class="title">Note</h3><p>This requires <a class="link" href="index.html#test-opt-enableOCR"  ><code class="literal">enableOCR</code></a> to be set to <code class="literal">true</code>.</p></div></dd><dt><span class="term">get_screen_text_variants()</span></dt><dd><p>Return a list of different interpretations of what is currently
visible on the machine’s screen using optical character
recognition. The number and order of the interpretations is not
specified and is subject to change, but if no exception is raised at
least one will be returned.</p><div class="note"><h3 class="title">Note</h3><p>This requires <a class="link" href="index.html#test-opt-enableOCR"  ><code class="literal">enableOCR</code></a> to be set to <code class="literal">true</code>.</p></div></dd><dt><span class="term">reboot()</span></dt><dd><p>Press Ctrl+Alt+Delete in the guest.</p><p>Prepares the machine to be reconnected which is useful if the
machine was started with <code class="literal">allow_reboot = True</code></p></dd><dt><span class="term">screenshot(filename)</span></dt><dd><p>Take a picture of the display of the virtual machine, in PNG format.
The screenshot will be available in the derivation output.</p></dd><dt><span class="term">send_chars(chars, delay)</span></dt><dd><p>Simulate typing a sequence of characters on the virtual keyboard,
e.g., <code class="literal">send_chars(&quot;foobar\n&quot;)</code> will type the string <code class="literal">foobar</code>
followed by the Enter key.</p></dd><dt><span class="term">send_console(chars)</span></dt><dd><p>Send keys to the kernel console. This allows interaction with the systemd
emergency mode, for example. Takes a string that is sent, e.g.,
<code class="literal">send_console(&quot;\n\nsystemctl default\n&quot;)</code>.</p></dd><dt><span class="term">send_key(key, delay, log)</span></dt><dd><p>Simulate pressing keys on the virtual keyboard, e.g.,
<code class="literal">send_key(&quot;ctrl-alt-delete&quot;)</code>.</p><p>Please also refer to the QEMU documentation for more information on the
input syntax: https://en.wikibooks.org/wiki/QEMU/Monitor#sendkey_keys</p></dd><dt><span class="term">send_monitor_command(command)</span></dt><dd><p>Send a command to the QEMU monitor. This allows attaching
virtual USB disks to a running machine, among other things.</p></dd><dt><span class="term">shell_interact(address)</span></dt><dd><p>Allows you to directly interact with the guest shell. This should
only be used during test development, not in production tests.
Killing the interactive session with <code class="literal">Ctrl-d</code> or <code class="literal">Ctrl-c</code> also ends
the guest session.</p></dd><dt><span class="term">shutdown()</span></dt><dd><p>Shut down the machine, waiting for the VM to exit.</p></dd><dt><span class="term">start(allow_reboot)</span></dt><dd><p>Start the virtual machine. This method is asynchronous — it does
not wait for the machine to finish booting.</p></dd><dt><span class="term">succeed()</span></dt><dd><p>Execute a shell command, raising an exception if the exit status is
not zero, otherwise returning the standard output. Similar to <code class="literal">execute</code>,
except that the timeout is <code class="literal">None</code> by default. See <code class="literal">execute</code> for details on
command execution.</p></dd><dt><span class="term">switch_root()</span></dt><dd><p>Transition from stage 1 to stage 2. This requires the
machine to be configured with <code class="literal">testing.initrdBackdoor = true</code>
and <code class="literal">boot.initrd.systemd.enable = true</code>.</p></dd><dt><span class="term">systemctl(q, user)</span></dt><dd><p>Runs <code class="literal">systemctl</code> commands with optional support for
<code class="literal">systemctl --user</code></p><pre><code class="programlisting py"># run `systemctl list-jobs --no-pager`
machine.systemctl(&quot;list-jobs --no-pager&quot;)

# spawn a shell for `any-user` and run
# `systemctl --user list-jobs --no-pager`
machine.systemctl(&quot;list-jobs --no-pager&quot;, &quot;any-user&quot;)
</code></pre></dd><dt><span class="term">unblock()</span></dt><dd><p>Undo the effect of <code class="literal">block</code>.</p></dd><dt><span class="term">wait_for_closed_port(port, addr, timeout)</span></dt><dd><p>Wait until nobody is listening on the given TCP port and IP address
(default <code class="literal">localhost</code>).</p></dd><dt><span class="term">wait_for_console_text(regex, timeout)</span></dt><dd><p>Wait until the supplied regular expressions match a line of the
serial console output.
This method is useful when OCR is not possible or inaccurate.</p></dd><dt><span class="term">wait_for_file(filename, timeout)</span></dt><dd><p>Waits until the file exists in the machine’s file system.</p></dd><dt><span class="term">wait_for_open_port(port, addr, timeout)</span></dt><dd><p>Wait until a process is listening on the given TCP port and IP address
(default <code class="literal">localhost</code>).</p></dd><dt><span class="term">wait_for_open_unix_socket(addr, is_datagram, timeout)</span></dt><dd><p>Wait until a process is listening on the given UNIX-domain socket
(default to a UNIX-domain stream socket).</p></dd><dt><span class="term">wait_for_qmp_event(event_filter, timeout)</span></dt><dd><p>Wait for a QMP event which you can filter with the <code class="literal">event_filter</code> function.
The function takes as an input a dictionary of the event and if it returns True, we return that event,
if it does not, we wait for the next event and retry.</p><p>It will skip all events received in the meantime, if you want to keep them,
you have to do the bookkeeping yourself and store them somewhere.</p><p>By default, it will wait up to 10 minutes, <code class="literal">timeout</code> is in seconds.</p></dd><dt><span class="term">wait_for_text(regex, timeout)</span></dt><dd><p>Wait until the supplied regular expressions matches the textual
contents of the screen by using optical character recognition (see
<code class="literal">get_screen_text</code> and <code class="literal">get_screen_text_variants</code>).</p><div class="note"><h3 class="title">Note</h3><p>This requires <a class="link" href="index.html#test-opt-enableOCR"  ><code class="literal">enableOCR</code></a> to be set to <code class="literal">true</code>.</p></div></dd><dt><span class="term">wait_for_unit(unit, user, timeout)</span></dt><dd><p>Wait for a systemd unit to get into “active” state.
Throws exceptions on “failed” and “inactive” states as well as after
timing out.</p></dd><dt><span class="term">wait_for_window(regexp, timeout)</span></dt><dd><p>Wait until an X11 window has appeared whose name matches the given
regular expression, e.g., <code class="literal">wait_for_window(&quot;Terminal&quot;)</code>.</p></dd><dt><span class="term">wait_for_x(timeout)</span></dt><dd><p>Wait until it is possible to connect to the X server.</p></dd><dt><span class="term">wait_until_fails(command, timeout)</span></dt><dd><p>Like <code class="literal">wait_until_succeeds</code>, but repeating the command until it fails.</p></dd><dt><span class="term">wait_until_succeeds(command, timeout)</span></dt><dd><p>Repeat a shell command with 1-second intervals until it succeeds.
Has a default timeout of 900 seconds which can be modified, e.g.
<code class="literal">wait_until_succeeds(cmd, timeout=10)</code>. See <code class="literal">execute</code> for details on
command execution.
Throws an exception on timeout.</p></dd><dt><span class="term">wait_until_tty_matches(tty, regexp, timeout)</span></dt><dd><p>Wait until the visible output on the chosen TTY matches regular
expression. Throws an exception on timeout.</p></dd></dl></div><p>To test user units declared by <code class="literal">systemd.user.services</code> the optional
<code class="literal">user</code> argument can be used:</p><pre><code class="programlisting py">machine.start()
machine.wait_for_x()
machine.wait_for_unit(&quot;xautolock.service&quot;, &quot;x-session-user&quot;)
</code></pre><p>This applies to <code class="literal">systemctl</code>, <code class="literal">get_unit_info</code>, <code class="literal">wait_for_unit</code>,
<code class="literal">start_job</code> and <code class="literal">stop_job</code>.</p><p>For faster dev cycles it’s also possible to disable the code-linters
(this shouldn’t be committed though):</p><pre><code class="programlisting nix">{
  skipLint = true;
  nodes.machine =
    { config, pkgs, ... }:
    { # configuration…
    };

  testScript =
    &#x27;&#x27;
      Python code…
    &#x27;&#x27;;
}
</code></pre><p>This will produce a Nix warning at evaluation time. To fully disable the
linter, wrap the test script in comment directives to disable the Black
linter directly (again, don’t commit this within the Nixpkgs
repository):</p><pre><code class="programlisting nix">{
  testScript =
    &#x27;&#x27;
      # fmt: off
      Python code…
      # fmt: on
    &#x27;&#x27;;
}
</code></pre><p>Similarly, the type checking of test scripts can be disabled in the following
way:</p><pre><code class="programlisting nix">{
  skipTypeCheck = true;
  nodes.machine =
    { config, pkgs, ... }:
    { # configuration…
    };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-failing-tests-early" class="title" >Failing tests early   </h3>  </div> </div></div><p>To fail tests early when certain invariants are no longer met (instead of waiting for the build to time out), the decorator <code class="literal">polling_condition</code> is provided. For example, if we are testing a program <code class="literal">foo</code> that should not quit after being started, we might write the following:</p><pre><code class="programlisting py">@polling_condition
def foo_running():
    machine.succeed(&quot;pgrep -x foo&quot;)


machine.succeed(&quot;foo --start&quot;)
machine.wait_until_succeeds(&quot;pgrep -x foo&quot;)

with foo_running:
    ...  # Put `foo` through its paces
</code></pre><p><code class="literal">polling_condition</code> takes the following (optional) arguments:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">seconds_interval</code></span></dt><dd><p>specifies how often the condition should be polled:</p></dd></dl></div><pre><code class="programlisting py">@polling_condition(seconds_interval=10)
def foo_running():
    machine.succeed(&quot;pgrep -x foo&quot;)
</code></pre><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">description</code></span></dt><dd><p>is used in the log when the condition is checked. If this is not provided, the description is pulled from the docstring of the function. These two are therefore equivalent:</p></dd></dl></div><pre><code class="programlisting py">@polling_condition
def foo_running():
    &quot;check that foo is running&quot;
    machine.succeed(&quot;pgrep -x foo&quot;)
</code></pre><pre><code class="programlisting py">@polling_condition(description=&quot;check that foo is running&quot;)
def foo_running():
    machine.succeed(&quot;pgrep -x foo&quot;)
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-python-packages-in-test-script" class="title" >Adding Python packages to the test script   </h3>  </div> </div></div><p>When additional Python libraries are required in the test script, they can be
added using the parameter <code class="literal">extraPythonPackages</code>. For example, you could add
<code class="literal">numpy</code> like this:</p><pre><code class="programlisting nix">{
  extraPythonPackages = p: [ p.numpy ];

  nodes = { };

  # Type checking on extra packages doesn&#x27;t work yet
  skipTypeCheck = true;

  testScript = &#x27;&#x27;
    import numpy as np
    assert str(np.zeros(4)) == &quot;[0. 0. 0. 0.]&quot;
  &#x27;&#x27;;
}
</code></pre><p>In that case, <code class="literal">numpy</code> is chosen from the generic <code class="literal">python3Packages</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-test-options-reference" class="title" >Test Options Reference   </h3>  </div> </div></div><p>The following options can be used when writing tests.</p><div class="variablelist">
<a id="test-options-list"></a>
 <dl class="variablelist">
<dt>
 <span class="term">
 <a id="test-opt-enableOCR"></a><a class="term" href="index.html#test-opt-enableOCR"><code class="option">enableOCR</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to enable Optical Character Recognition functionality for
testing graphical programs. See <a class="link" href="index.html#ssec-machine-objects" title="Machine objects" ><code class="literal">Machine objects</code></a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-defaults"></a><a class="term" href="index.html#test-opt-defaults"><code class="option">defaults</code>
  </a>
 </span>
</dt>
<dd>
<p>NixOS configuration that is applied to all <a class="link" href="index.html#test-opt-nodes"  ><code class="option">nodes</code></a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
module</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">{ }</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-driver"></a><a class="term" href="index.html#test-opt-driver"><code class="option">driver</code>
  </a>
 </span>
</dt>
<dd>
<p>Package containing a script that runs the test.</p>

<p><span class="emphasis"><em>Type:</em></span>
package</p>

<p><span class="emphasis"><em>Default:</em></span>
set by the test framework</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-extraBaseModules"></a><a class="term" href="index.html#test-opt-extraBaseModules"><code class="option">extraBaseModules</code>
  </a>
 </span>
</dt>
<dd>
<p>NixOS configuration that, like <a class="link" href="index.html#test-opt-defaults"  ><code class="option">defaults</code></a>, is applied to all <a class="link" href="index.html#test-opt-nodes"  ><code class="option">nodes</code></a> and can not be undone with <a class="link" href="https://search.nixos.org/options?show=specialisation.%3Cname%3E.inheritParentConfig&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=specialisation"  target="_top"><code class="literal">specialisation.&lt;name&gt;.inheritParentConfig</code></a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
module</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">{ }</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-extraDriverArgs"></a><a class="term" href="index.html#test-opt-extraDriverArgs"><code class="option">extraDriverArgs</code>
  </a>
 </span>
</dt>
<dd>
<p>Extra arguments to pass to the test driver.</p><p>They become part of <a class="link" href="index.html#test-opt-driver"  ><code class="option">driver</code></a> via <code class="literal">wrapProgram</code>.</p>

<p><span class="emphasis"><em>Type:</em></span>
list of string</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">[ ]</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-extraPythonPackages"></a><a class="term" href="index.html#test-opt-extraPythonPackages"><code class="option">extraPythonPackages</code>
  </a>
 </span>
</dt>
<dd>
<p>Python packages to add to the test driver.</p><p>The argument is a Python package set, similar to <code class="literal">pkgs.pythonPackages</code>.</p>

<p><span class="emphasis"><em>Type:</em></span>
function that evaluates to a(n) list of package</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">&lt;function&gt;</code></p>

<p><span class="emphasis"><em>Example:</em></span></p><pre><code class="programlisting">p: [ p.numpy ]

</code></pre>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-globalTimeout"></a><a class="term" href="index.html#test-opt-globalTimeout"><code class="option">globalTimeout</code>
  </a>
 </span>
</dt>
<dd>
<p>A global timeout for the complete test, expressed in seconds.
Beyond that timeout, every resource will be killed and released and the test will fail.</p><p>By default, we use a 1 hour timeout.</p>

<p><span class="emphasis"><em>Type:</em></span>
signed integer</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">3600</code></p>

<p><span class="emphasis"><em>Example:</em></span>
<code class="literal">600</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-hostPkgs"></a><a class="term" href="index.html#test-opt-hostPkgs"><code class="option">hostPkgs</code>
  </a>
 </span>
</dt>
<dd>
<p>Nixpkgs attrset used outside the nodes.</p>

<p><span class="emphasis"><em>Type:</em></span>
raw value</p>

<p><span class="emphasis"><em>Example:</em></span></p><pre><code class="programlisting">import nixpkgs { inherit system config overlays; }

</code></pre>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-interactive"></a><a class="term" href="index.html#test-opt-interactive"><code class="option">interactive</code>
  </a>
 </span>
</dt>
<dd>
<p>Tests <a class="link" href="index.html#sec-running-nixos-tests-interactively" title="Running Tests interactively" >can be run interactively</a>
using the program in the test derivation’s <code class="literal">.driverInteractive</code> attribute.</p><p>When they are, the configuration will include anything set in this submodule.</p><p>You can set any top-level test option here.</p><p>Example test module:</p><pre><code class="programlisting nix">{ config, lib, ... }: {

  nodes.rabbitmq = {
    services.rabbitmq.enable = true;
  };

  # When running interactively ...
  interactive.nodes.rabbitmq = {
    # ... enable the web ui.
    services.rabbitmq.managementPlugin.enable = true;
  };
}
</code></pre><p>For details, see the section about <a class="link" href="index.html#sec-running-nixos-tests-interactively" title="Running Tests interactively" >running tests interactively</a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
submodule</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/interactive.nix" target="_top">
nixos/lib/testing/interactive.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-meta"></a><a class="term" href="index.html#test-opt-meta"><code class="option">meta</code>
  </a>
 </span>
</dt>
<dd>
<p>The <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#chap-meta"  target="_top"><code class="literal">meta</code></a> attributes that will be set on the returned derivations.</p><p>Not all <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#chap-meta"  target="_top"><code class="literal">meta</code></a> attributes are supported, but more can be added as desired.</p>

<p><span class="emphasis"><em>Type:</em></span>
submodule</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">{ }</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/meta.nix" target="_top">
nixos/lib/testing/meta.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-meta.broken"></a><a class="term" href="index.html#test-opt-meta.broken"><code class="option">meta.broken</code>
  </a>
 </span>
</dt>
<dd>
<p>Sets the <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#var-meta-broken"  target="_top"><code class="literal">meta.broken</code></a> attribute on the <a class="link" href="index.html#test-opt-test"  ><code class="option">test</code></a> derivation.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/meta.nix" target="_top">
nixos/lib/testing/meta.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-meta.hydraPlatforms"></a><a class="term" href="index.html#test-opt-meta.hydraPlatforms"><code class="option">meta.hydraPlatforms</code>
  </a>
 </span>
</dt>
<dd>
<p>Sets the <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#var-meta-hydraPlatforms"  target="_top"><code class="literal">meta.hydraPlatforms</code></a> attribute on the <a class="link" href="index.html#test-opt-test"  ><code class="option">test</code></a> derivation.</p>

<p><span class="emphasis"><em>Type:</em></span>
list of raw value</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">lib.platforms.linux</code> only, as the <code class="literal">hydra.nixos.org</code> build farm does not currently support virtualisation on Darwin.</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/meta.nix" target="_top">
nixos/lib/testing/meta.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-meta.maintainers"></a><a class="term" href="index.html#test-opt-meta.maintainers"><code class="option">meta.maintainers</code>
  </a>
 </span>
</dt>
<dd>
<p>The <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#var-meta-maintainers"  target="_top">list of maintainers</a> for this test.</p>

<p><span class="emphasis"><em>Type:</em></span>
list of raw value</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">[ ]</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/meta.nix" target="_top">
nixos/lib/testing/meta.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-meta.platforms"></a><a class="term" href="index.html#test-opt-meta.platforms"><code class="option">meta.platforms</code>
  </a>
 </span>
</dt>
<dd>
<p>Sets the <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#var-meta-platforms"  target="_top"><code class="literal">meta.platforms</code></a> attribute on the <a class="link" href="index.html#test-opt-test"  ><code class="option">test</code></a> derivation.</p>

<p><span class="emphasis"><em>Type:</em></span>
list of raw value</p>

<p><span class="emphasis"><em>Default:</em></span></p><pre><code class="programlisting">[
  &quot;aarch64-linux&quot;
  &quot;armv5tel-linux&quot;
  &quot;armv6l-linux&quot;
  &quot;armv7a-linux&quot;
  &quot;armv7l-linux&quot;
  &quot;i686-linux&quot;
  &quot;loongarch64-linux&quot;
  &quot;m68k-linux&quot;
  &quot;microblaze-linux&quot;
  &quot;microblazeel-linux&quot;
  &quot;mips-linux&quot;
  &quot;mips64-linux&quot;
  &quot;mips64el-linux&quot;
  &quot;mipsel-linux&quot;
  &quot;powerpc64-linux&quot;
  &quot;powerpc64le-linux&quot;
  &quot;riscv32-linux&quot;
  &quot;riscv64-linux&quot;
  &quot;s390-linux&quot;
  &quot;s390x-linux&quot;
  &quot;x86_64-linux&quot;
  &quot;x86_64-darwin&quot;
  &quot;aarch64-darwin&quot;
]
</code></pre>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/meta.nix" target="_top">
nixos/lib/testing/meta.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-meta.timeout"></a><a class="term" href="index.html#test-opt-meta.timeout"><code class="option">meta.timeout</code>
  </a>
 </span>
</dt>
<dd>
<p>The <a class="link" href="index.html#test-opt-test"  ><code class="option">test</code></a>’s <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#var-meta-timeout"  target="_top"><code class="literal">meta.timeout</code></a> in seconds.</p>

<p><span class="emphasis"><em>Type:</em></span>
null or signed integer</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">3600</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/meta.nix" target="_top">
nixos/lib/testing/meta.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-name"></a><a class="term" href="index.html#test-opt-name"><code class="option">name</code>
  </a>
 </span>
</dt>
<dd>
<p>The name of the test.</p><p>This is used in the derivation names of the <a class="link" href="index.html#test-opt-driver"  ><code class="option">driver</code></a> and <a class="link" href="index.html#test-opt-test"  ><code class="option">test</code></a> runner.</p>

<p><span class="emphasis"><em>Type:</em></span>
string</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/name.nix" target="_top">
nixos/lib/testing/name.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-node.pkgs"></a><a class="term" href="index.html#test-opt-node.pkgs"><code class="option">node.pkgs</code>
  </a>
 </span>
</dt>
<dd>
<p>The Nixpkgs to use for the nodes.</p><p>Setting this will make the <code class="literal">nixpkgs.*</code> options read-only, to avoid mistakenly testing with a Nixpkgs configuration that diverges from regular use.</p>

<p><span class="emphasis"><em>Type:</em></span>
null or Nixpkgs package set</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">null</code>, so construct <code class="literal">pkgs</code> according to the <code class="literal">nixpkgs.*</code> options as usual.</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-node.pkgsReadOnly"></a><a class="term" href="index.html#test-opt-node.pkgsReadOnly"><code class="option">node.pkgsReadOnly</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to make the <code class="literal">nixpkgs.*</code> options read-only. This is only relevant when <a class="link" href="index.html#test-opt-node.pkgs"  ><code class="literal">node.pkgs</code></a> is set.</p><p>Set this to <code class="literal">false</code> when any of the <a class="link" href="index.html#test-opt-nodes"  ><code class="literal">nodes</code></a> needs to configure any of the <code class="literal">nixpkgs.*</code> options. This will slow down evaluation of your test a bit.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">node.pkgs != null</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-node.specialArgs"></a><a class="term" href="index.html#test-opt-node.specialArgs"><code class="option">node.specialArgs</code>
  </a>
 </span>
</dt>
<dd>
<p>An attribute set of arbitrary values that will be made available as module arguments during the resolution of module <code class="literal">imports</code>.</p><p>Note that it is not possible to override these from within the NixOS configurations. If you argument is not relevant to <code class="literal">imports</code>, consider setting <code class="option">defaults._module.args.&lt;name&gt;</code> instead.</p>

<p><span class="emphasis"><em>Type:</em></span>
lazy attribute set of raw value</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">{ }</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-nodes"></a><a class="term" href="index.html#test-opt-nodes"><code class="option">nodes</code>
  </a>
 </span>
</dt>
<dd>
<p>An attribute set of NixOS configuration modules.</p><p>The configurations are augmented by the <a class="link" href="index.html#test-opt-defaults"  ><code class="literal">defaults</code></a> option.</p><p>They are assigned network addresses according to the <code class="literal">nixos/lib/testing/network.nix</code> module.</p><p>A few special options are available, that aren’t in a plain NixOS configuration. See <a class="link" href="index.html#sec-nixos-test-nodes" title="Configuring the nodes" >Configuring the nodes</a></p>

<p><span class="emphasis"><em>Type:</em></span>
lazy attribute set of module</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-passthru"></a><a class="term" href="index.html#test-opt-passthru"><code class="option">passthru</code>
  </a>
 </span>
</dt>
<dd>
<p>Attributes to add to the returned derivations,
which are not necessarily part of the build.</p><p>This is a bit like doing <code class="literal">drv // { myAttr = true; }</code> (which would be lost by <code class="literal">overrideAttrs</code>).
It does not change the actual derivation, but adds the attribute nonetheless, so that
consumers of what would be <code class="literal">drv</code> have more information.</p>

<p><span class="emphasis"><em>Type:</em></span>
lazy attribute set of raw value</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/run.nix" target="_top">
nixos/lib/testing/run.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-qemu.package"></a><a class="term" href="index.html#test-opt-qemu.package"><code class="option">qemu.package</code>
  </a>
 </span>
</dt>
<dd>
<p>Which qemu package to use for the virtualisation of <a class="link" href="index.html#test-opt-nodes"  ><code class="option">nodes</code></a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
package</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">&quot;hostPkgs.qemu_test&quot;</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-skipLint"></a><a class="term" href="index.html#test-opt-skipLint"><code class="option">skipLint</code>
  </a>
 </span>
</dt>
<dd>
<p>Do not run the linters. This may speed up your iteration cycle, but it is not something you should commit.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-skipTypeCheck"></a><a class="term" href="index.html#test-opt-skipTypeCheck"><code class="option">skipTypeCheck</code>
  </a>
 </span>
</dt>
<dd>
<p>Disable type checking. This must not be enabled for new NixOS tests.</p><p>This may speed up your iteration cycle, unless you’re working on the <a class="link" href="index.html#test-opt-testScript"  ><code class="option">testScript</code></a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-sshBackdoor.enable"></a><a class="term" href="index.html#test-opt-sshBackdoor.enable"><code class="option">sshBackdoor.enable</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to turn on the VSOCK-based access to all VMs. This provides an unauthenticated access intended for debugging.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-sshBackdoor.vsockOffset"></a><a class="term" href="index.html#test-opt-sshBackdoor.vsockOffset"><code class="option">sshBackdoor.vsockOffset</code>
  </a>
 </span>
</dt>
<dd>
<p>This field is only relevant when multiple users run the (interactive)
driver outside the sandbox and with the SSH backdoor activated.
The typical symptom for this being a problem are error messages like this:
<code class="literal">vhost-vsock: unable to set guest cid: Address already in use</code></p><p>This option allows to assign an offset to each vsock number to
resolve this.</p><p>This is a 32bit number. The lowest possible vsock number is <code class="literal">3</code>
(i.e. with the lowest node number being <code class="literal">1</code>, this is 2+1).</p>

<p><span class="emphasis"><em>Type:</em></span>
integer between 2 and 4294967296 (both inclusive)</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">2</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-test"></a><a class="term" href="index.html#test-opt-test"><code class="option">test</code>
  </a>
 </span>
</dt>
<dd>
<p>Derivation that runs the test as its “build” process.</p><p>This implies that NixOS tests run isolated from the network, making them
more dependable.</p>

<p><span class="emphasis"><em>Type:</em></span>
package</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/run.nix" target="_top">
nixos/lib/testing/run.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-testScript"></a><a class="term" href="index.html#test-opt-testScript"><code class="option">testScript</code>
  </a>
 </span>
</dt>
<dd>
<p>A series of python declarations and statements that you write to perform
the test.</p>

<p><span class="emphasis"><em>Type:</em></span>
string or function that evaluates to a(n) string</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/testScript.nix" target="_top">
nixos/lib/testing/testScript.nix
</a></code>
</td></tr>
</table>
</dd>
 </dl>
</div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-running-nixos-tests" class="title" style="clear: both">Running Tests   </h2>  </div> </div></div><p>You can run tests using <code class="literal">nix-build</code>. For example, to run the test
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/login.nix"  target="_top"><code class="literal">login.nix</code></a>,
you do:</p><pre><code class="programlisting ShellSession">$ cd /my/git/clone/of/nixpkgs
$ nix-build -A nixosTests.login
</code></pre><p>After building/downloading all required dependencies, this will perform
a build that starts a QEMU/KVM virtual machine containing a NixOS
system. The virtual machine mounts the Nix store of the host; this makes
VM creation very fast, as no disk image needs to be created. Afterwards,
you can view a log of the test:</p><pre><code class="programlisting ShellSession">$ nix-store --read-log result
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-running-nixos-tests-requirements" class="title" >System Requirements   </h3>  </div> </div></div><p>NixOS tests require virtualization support.
This means that the machine must have <code class="literal">kvm</code> in its <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/conf-file.html?highlight=system-features#conf-system-features"  target="_top">system features</a> list, or <code class="literal">apple-virt</code> in case of macOS.
These features are autodetected locally, but <code class="literal">apple-virt</code> is only autodetected since Nix 2.19.0.</p><p>Features of <span class="strong"><strong>remote builders</strong></span> must additionally be configured manually on the client, e.g. on NixOS with <a class="link" href="https://search.nixos.org/options?show=nix.buildMachines.*.supportedFeatures&amp;sort=alpha_asc&amp;query=nix.buildMachines"  target="_top"><code class="literal">nix.buildMachines.*.supportedFeatures</code></a> or through general <a class="link" href="https://nixos.org/manual/nix/stable/advanced-topics/distributed-builds"  target="_top">Nix configuration</a>.</p><p>If you run the tests on a <span class="strong"><strong>macOS</strong></span> machine, you also need a “remote” builder for Linux; possibly a VM. <a class="link" href="https://daiderd.com/nix-darwin/"  target="_top">nix-darwin</a> users may enable <a class="link" href="https://daiderd.com/nix-darwin/manual/index.html#opt-nix.linux-builder.enable"  target="_top"><code class="literal">nix.linux-builder.enable</code></a> to launch such a VM.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-running-nixos-tests-interactively" class="title" style="clear: both">Running Tests interactively   </h2>  </div> </div></div><p>The test itself can be run interactively. This is particularly useful
when developing or debugging a test:</p><pre><code class="programlisting ShellSession">$ nix-build . -A nixosTests.login.driverInteractive
$ ./result/bin/nixos-test-driver
[...]
&gt;&gt;&gt;
</code></pre><div class="note"><h3 class="title">Note</h3><p>By executing the test driver in this way,
the VMs executed may gain network &amp; Internet access via their backdoor control interface,
typically recognized as <code class="literal">eth0</code>.</p></div><p>You can then take any Python statement, e.g.</p><pre><code class="programlisting py">&gt;&gt;&gt; start_all()
&gt;&gt;&gt; test_script()
&gt;&gt;&gt; machine.succeed(&quot;touch /tmp/foo&quot;)
&gt;&gt;&gt; print(machine.succeed(&quot;pwd&quot;)) # Show stdout of command
</code></pre><p>The function <code class="literal">test_script</code> executes the entire test script and drops you
back into the test driver command line upon its completion. This allows
you to inspect the state of the VMs after the test (e.g. to debug the
test script).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-shell-access" class="title" >Shell access in interactive mode   </h3>  </div> </div></div><p>The function <code class="literal">&lt;yourmachine&gt;.shell_interact()</code> grants access to a shell running
inside a virtual machine. To use it, replace <code class="literal">&lt;yourmachine&gt;</code> with the name of a
virtual machine defined in the test, for example: <code class="literal">machine.shell_interact()</code>.
Keep in mind that this shell may not display everything correctly as it is
running within an interactive Python REPL, and logging output from the virtual
machine may overwrite input and output from the guest shell:</p><pre><code class="programlisting py">&gt;&gt;&gt; machine.shell_interact()
machine: Terminal is ready (there is no initial prompt):
$ hostname
machine
</code></pre><p>As an alternative, you can proxy the guest shell to a local TCP server by first
starting a TCP server in a terminal using the command:</p><pre><code class="programlisting ShellSession">$ socat &#x27;READLINE,PROMPT=$ &#x27; tcp-listen:4444,reuseaddr
</code></pre><p>In the terminal where the test driver is running, connect to this server by
using:</p><pre><code class="programlisting py">&gt;&gt;&gt; machine.shell_interact(&quot;tcp:127.0.0.1:4444&quot;)
</code></pre><p>Once the connection is established, you can enter commands in the socat terminal
where socat is running.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-ssh-access" class="title" >SSH Access for test machines   </h3>  </div> </div></div><p>An SSH-based backdoor to log into machines can be enabled with</p><pre><code class="programlisting nix">{
  name = &quot;…&quot;;
  nodes.machines = { /* … */ };
  interactive.sshBackdoor.enable = true;
}
</code></pre><div class="warning"><h3 class="title">Warning</h3><p>Make sure to only enable the backdoor for interactive tests
(i.e. by using <code class="literal">interactive.sshBackdoor.enable</code>)! This is the only
supported configuration.</p><p>Running a test in a sandbox with this will fail because <code class="literal">/dev/vhost-vsock</code> isn’t available
in the sandbox.</p></div><p>This creates a <a class="link" href="https://man7.org/linux/man-pages/man7/vsock.7.html"  target="_top">vsock socket</a>
for each VM to log in with SSH. This configures root login with an empty password.</p><p>When the VMs get started interactively with the test-driver, it’s possible to
connect to <code class="literal">machine</code> with</p><pre><code class="programlisting">$ ssh vsock/3 -o User=root
</code></pre><p>The socket numbers correspond to the node number of the test VM, but start
at three instead of one because that’s the lowest possible
vsock number. The exact SSH commands are also printed out when starting
<code class="literal">nixos-test-driver</code>.</p><p>On non-NixOS systems you’ll probably need to enable
the SSH config from <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-ssh-proxy.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd-ssh-proxy</span>(1)</span></a> yourself.</p><p>If starting VM fails with an error like</p><pre><code class="programlisting">qemu-system-x86_64: -device vhost-vsock-pci,guest-cid=3: vhost-vsock: unable to set guest cid: Address already in use
</code></pre><p>it means that the vsock numbers for the VMs are already in use. This can happen
if another interactive test with SSH backdoor enabled is running on the machine.</p><p>In that case, you need to assign another range of vsock numbers. You can pick another
offset with</p><pre><code class="programlisting nix">{
  sshBackdoor = {
    enable = true;
    vsockOffset = 23542;
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-port-forwarding" class="title" >Port forwarding to NixOS test VMs   </h3>  </div> </div></div><p>If your test has only a single VM, you may use e.g.</p><pre><code class="programlisting ShellSession">$ QEMU_NET_OPTS=&quot;hostfwd=tcp:127.0.0.1:2222-:22&quot; ./result/bin/nixos-test-driver
</code></pre><p>to port-forward a port in the VM (here <code class="literal">22</code>) to the host machine (here port <code class="literal">2222</code>).</p><p>This naturally does not work when multiple machines are involved,
since a single port on the host cannot forward to multiple VMs.</p><p>If the test defines multiple machines, you may opt to <span class="emphasis"><em>temporarily</em></span> set
<code class="literal">virtualisation.forwardPorts</code> in the test definition for debugging.</p><p>Such port forwardings connect via the VM’s virtual network interface.
Thus they cannot connect to ports that are only bound to the VM’s
loopback interface (<code class="literal">127.0.0.1</code>), and the VM’s NixOS firewall
must be configured to allow these connections.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-reuse-vm-state" class="title" >Reuse VM state   </h3>  </div> </div></div><p>You can re-use the VM states coming from a previous run by setting the
<code class="literal">--keep-vm-state</code> flag.</p><pre><code class="programlisting ShellSession">$ ./result/bin/nixos-test-driver --keep-vm-state
</code></pre><p>The machine state is stored in the <code class="literal">$TMPDIR/vm-state-machinename</code>
directory.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-interactive-configuration" class="title" >Interactive-only test configuration   </h3>  </div> </div></div><p>The <code class="literal">.driverInteractive</code> attribute combines the regular test configuration with
definitions from the <a class="link" href="index.html#test-opt-interactive"  ><code class="literal">interactive</code> submodule</a>. This gives you
a more usable, graphical, but slightly different configuration.</p><p>You can add your own interactive-only test configuration by adding extra
configuration to the <a class="link" href="index.html#test-opt-interactive"  ><code class="literal">interactive</code> submodule</a>.</p><p>To interactively run only the regular configuration, build the <code class="literal">&lt;test&gt;.driver</code> attribute
instead, and call it with the flag <code class="literal">result/bin/nixos-test-driver --interactive</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-linking-nixos-tests-to-packages" class="title" style="clear: both">Linking NixOS tests to packages   </h2>  </div> </div></div><p>You can link NixOS module tests to the packages that they exercised,
so that the tests can be run automatically during code review when the package gets changed.
This is
<a class="link" href="https://nixos.org/manual/nixpkgs/stable/#ssec-nixos-tests-linking"  target="_top">described in the nixpkgs manual</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-nixos-test-testing-hardware-features" class="title" style="clear: both">Testing Hardware Features   </h2>  </div> </div></div><p>This section covers how to test various features using NixOS tests that would
normally only be possible with hardware. It is designed to showcase the NixOS test
framework’s flexibility when combined with various hardware simulation libraries
or kernel modules.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-wifi" class="title" >Wi-Fi   </h3>  </div> </div></div><p>Use <code class="literal">services.vwifi</code> to set up a virtual Wi-Fi physical layer. Create at least two nodes
for this kind of test: one with vwifi active, and either a station or an access point.
Give each a static IP address on the test network so they will never collide.
This module likely supports other topologies too; document them if you make one.</p><p>This NixOS module leverages <a class="link" href="https://github.com/Raizo62/vwifi"  target="_top">vwifi</a>. Read the
upstream repository’s documentation for more information.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-nixos-test-wifi-vwifi-server" class="title" >vwifi server   </h4>  </div> </div></div><p>This node runs the vwifi server, and otherwise does not interact with the network.
You can run <code class="literal">vwifi-ctrl</code> on this node to control characteristics of the simulated
physical layer.</p><pre><code class="programlisting nix">airgap =
  { config, ... }:
  {
    networking.interfaces.eth1.ipv4.addresses = lib.mkForce [
      {
        address = &quot;192.168.1.2&quot;;
        prefixLength = 24;
      }
    ];
    services.vwifi = {
      server = {
        enable = true;
        ports.tcp = 8212;
        # uncomment if you want to enable monitor mode on another node
        # ports.spy = 8213;
        openFirewall = true;
      };
    };
  };
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-nixos-test-wifi-ap" class="title" >AP   </h4>  </div> </div></div><p>A node like this will act as a wireless access point in infrastructure mode.</p><pre><code class="programlisting nix">ap =
  { config, ... }:
  {
    networking.interfaces.eth1.ipv4.addresses = lib.mkForce [
      {
        address = &quot;192.168.1.3&quot;;
        prefixLength = 24;
      }
    ];
    services.hostapd = {
      enable = true;
      radios.wlan0 = {
        channel = 1;
        networks.wlan0 = {
          ssid = &quot;NixOS Test Wi-Fi Network&quot;;
          authentication = {
            mode = &quot;wpa3-sae&quot;;
            saePasswords = [ { password = &quot;supersecret&quot;; } ];
            enableRecommendedPairwiseCiphers = true;
          };
        };
      };
    };
    services.vwifi = {
      module = {
        enable = true;
        macPrefix = &quot;74:F8:F6:00:01&quot;;
      };
      client = {
        enable = true;
        serverAddress = &quot;192.168.1.2&quot;;
      };
    };
  };
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-nixos-test-wifi-station" class="title" >Station   </h4>  </div> </div></div><p>A node like this acts as a wireless client.</p><pre><code class="programlisting nix">station =
  { config, ... }:
  {
    networking.interfaces.eth1.ipv4.addresses = lib.mkForce [
      {
        address = &quot;192.168.1.3&quot;;
        prefixLength = 24;
      }
    ];
    networking.wireless = {
      # No, really, we want it enabled!
      enable = lib.mkOverride 0 true;
      interfaces = [ &quot;wlan0&quot; ];
      networks = {
        &quot;NixOS Test Wi-Fi Network&quot; = {
          psk = &quot;supersecret&quot;;
          authProtocols = [ &quot;SAE&quot; ];
        };
      };
    };
    services.vwifi = {
      module = {
        enable = true;
        macPrefix = &quot;74:F8:F6:00:02&quot;;
      };
      client = {
        enable = true;
        serverAddress = &quot;192.168.1.2&quot;;
      };
    };
  };
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-nixos-test-wifi-monitor" class="title" >Monitor   </h4>  </div> </div></div><p>When the monitor mode interface is enabled, this node will receive
all packets broadcast by all other nodes through the spy interface.</p><pre><code class="programlisting nix">monitor =
  { config, ... }:
  {
    networking.interfaces.eth1.ipv4.addresses = lib.mkForce [
      {
        address = &quot;192.168.1.4&quot;;
        prefixLength = 24;
      }
    ];

    services.vwifi = {
      module = {
        enable = true;
        macPrefix = &quot;74:F8:F6:00:03&quot;;
      };
      client = {
        enable = true;
        spy = true;
        serverAddress = &quot;192.168.1.2&quot;;
      };
    };
</code></pre>
</div>

</div>

</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-developing-the-test-driver" class="title" >Developing the NixOS Test Driver   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-test-the-test-framework">Testing changes to the test framework</a> </span></dt> </dl></div><p>The NixOS test framework is a project of its own.</p><p>It consists of roughly the following components:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">nixos/lib/test-driver</code>: The Python framework that sets up the test and runs the <a class="link" href="index.html#test-opt-testScript"  ><code class="literal">testScript</code></a></p></li><li class="listitem"><p><code class="literal">nixos/lib/testing</code>: The Nix code responsible for the wiring, written using the (NixOS) Module System.</p></li></ul></div><p>These components are exposed publicly through:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">nixos/lib/default.nix</code>: The public interface that exposes the <code class="literal">nixos/lib/testing</code> entrypoint.</p></li><li class="listitem"><p><code class="literal">flake.nix</code>: Exposes the <code class="literal">lib.nixos</code>, including the public test interface.</p></li></ul></div><p>Beyond the test driver itself, its integration into NixOS and Nixpkgs is important.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pkgs/top-level/all-packages.nix</code>: Defines the <code class="literal">nixosTests</code> attribute, used
by the package <code class="literal">tests</code> attributes and OfBorg.</p></li><li class="listitem"><p><code class="literal">nixos/release.nix</code>: Defines the <code class="literal">tests</code> attribute built by Hydra, independently, but analogous to <code class="literal">nixosTests</code></p></li><li class="listitem"><p><code class="literal">nixos/release-combined.nix</code>: Defines which tests are channel blockers.</p></li></ul></div><p>Finally, we have legacy entrypoints that users should move away from, but are cared for on a best effort basis.
These include <code class="literal">pkgs.nixosTest</code>, <code class="literal">testing-python.nix</code> and <code class="literal">make-test-python.nix</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-test-the-test-framework" class="title" style="clear: both">Testing changes to the test framework   </h2>  </div> </div></div><p>We currently have limited unit tests for the framework itself. You may run these with <code class="literal">nix-build -A nixosTests.nixos-test-driver</code>.</p><p>When making significant changes to the test framework, we run the tests on Hydra, to avoid disrupting the larger NixOS project.</p><p>For this, we use the <code class="literal">python-test-refactoring</code> branch in the <code class="literal">NixOS/nixpkgs</code> repository, and its <a class="link" href="https://hydra.nixos.org/jobset/nixos/python-test-refactoring"  target="_top">corresponding Hydra jobset</a>.
This branch is used as a pointer, and not as a feature branch.</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Rebase the PR onto a recent, good evaluation of <code class="literal">nixos-unstable</code></p></li><li class="listitem"><p>Create a baseline evaluation by force-pushing this revision of <code class="literal">nixos-unstable</code> to <code class="literal">python-test-refactoring</code>.</p></li><li class="listitem"><p>Note the evaluation number (we’ll call it <code class="literal">&lt;previous&gt;</code>)</p></li><li class="listitem"><p>Push the PR to <code class="literal">python-test-refactoring</code> and evaluate the PR on Hydra</p></li><li class="listitem"><p>Create a comparison URL by navigating to the latest build of the PR and adding to the URL <code class="literal">?compare=&lt;previous&gt;</code>. This is not necessary for the evaluation that comes right after the baseline.</p></li></ol></div><p>Review the removed tests and newly failed tests using the constructed URL; otherwise you will accidentally compare iterations of the PR instead of changes to the PR base.</p><p>As we currently have some flaky tests, newly failing tests are expected, but should be reviewed to make sure that</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>The number of failures did not increase significantly.</p></li><li class="listitem"><p>All failures that do occur can reasonably be assumed to fail for a different reason than the changes.</p></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="ch-testing-installer" class="title" >Testing the Installer   </h2>  </div> </div></div><p>Building, burning, and booting from an installation CD is rather
tedious, so here is a quick way to see if the installer works properly:</p><pre><code class="programlisting ShellSession"># mount -t tmpfs none /mnt
# nixos-generate-config --root /mnt
$ nix-build &#x27;&lt;nixpkgs&gt;&#x27; -A nixos-install
# ./result/bin/nixos-install
</code></pre><p>To start a login shell in the new NixOS installation in <code class="literal">/mnt</code>:</p><pre><code class="programlisting ShellSession">$ nix-build &#x27;&lt;nixpkgs&gt;&#x27; -A nixos-enter
# ./result/bin/nixos-enter
</code></pre>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h1 id="chap-contributing" class="title" >Contributing to this manual   </h1>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-contributing-redirects">Testing redirects</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-contributing-options">Contributing to the <code class="literal">configuration.nix</code> options documentation</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-contributing-nixos-tools">Contributing to <code class="literal">nixos-*</code> tools’ manpages</a> </span></dt> </dl></div><p>The sources of the NixOS manual are in the <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/doc/manual"  target="_top">nixos/doc/manual</a> subdirectory of the <a class="link" href="https://github.com/NixOS/nixpkgs"  target="_top">Nixpkgs</a> repository.
This manual uses the <a class="link" href="https://nixos.org/manual/nixpkgs/unstable/#sec-contributing-markup"  target="_top">Nixpkgs manual syntax</a>.</p><p>You can quickly check your edits with the following:</p><pre><code class="programlisting ShellSession">$ cd /path/to/nixpkgs
$ $EDITOR doc/nixos/manual/... # edit the manual
$ nix-build nixos/release.nix -A manual.x86_64-linux
</code></pre><p>If the build succeeds, the manual will be in <code class="literal">./result/share/doc/nixos/index.html</code>.</p><p>There’s also <a class="link" href="https://nixos.org/manual/nixpkgs/unstable/#sec-contributing-devmode"  target="_top">a convenient development daemon</a>.</p><p>The above instructions don’t deal with the appendix of available <code class="literal">configuration.nix</code> options, and the manual pages related to NixOS. These are built, and written in a different location and in a different format, as explained in the next sections.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h1 id="sec-contributing-redirects" class="title" style="clear: both">Testing redirects   </h1>  </div> </div></div><p>Once you have a successful build, you can open the relevant HTML (path mentioned above) in a browser along with the anchor, and observe the redirection.</p><p>Note that if you already loaded the page and <span class="emphasis"><em>then</em></span> input the anchor, you will need to perform a reload. This is because browsers do not re-run client JS code when only the anchor has changed.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h1 id="sec-contributing-options" class="title" style="clear: both">Contributing to the <code class="literal">configuration.nix</code> options documentation   </h1>  </div> </div></div><p>The documentation for all the different <code class="literal">configuration.nix</code> options is automatically generated by reading the <code class="literal">description</code>s of all the NixOS options defined at <code class="literal">nixos/modules/</code>. If you want to improve such <code class="literal">description</code>, find it in the <code class="literal">nixos/modules/</code> directory, and edit it and open a pull request.</p><p>To see how your changes render on the web, run again:</p><pre><code class="programlisting ShellSession">$ nix-build nixos/release.nix -A manual.x86_64-linux
</code></pre><p>And you’ll see the changes to the appendix in the path <code class="literal">result/share/doc/nixos/options.html</code>.</p><p>You can also build only the <code class="literal">configuration.nix(5)</code> manual page, via:</p><pre><code class="programlisting ShellSession">$ cd /path/to/nixpkgs
$ nix-build nixos/release.nix -A nixos-configuration-reference-manpage.x86_64-linux
</code></pre><p>And observe the result via:</p><pre><code class="programlisting ShellSession">$ man --local-file result/share/man/man5/configuration.nix.5
</code></pre><p>If you’re on a different architecture that’s supported by NixOS (check file <code class="literal">nixos/release.nix</code> on Nixpkgs’ repository) then replace <code class="literal">x86_64-linux</code> with the architecture. <code class="literal">nix-build</code> will complain otherwise, but should also tell you which architecture you have + the supported ones.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h1 id="sec-contributing-nixos-tools" class="title" style="clear: both">Contributing to <code class="literal">nixos-*</code> tools’ manpages   </h1>  </div> </div></div><p>The manual pages for the tools available in the installation image can be found in Nixpkgs by running (e.g for <code class="literal">nixos-rebuild</code>):</p><pre><code class="programlisting ShellSession">$ git ls | grep nixos-rebuild.8
</code></pre><p>Man pages are written in <a class="link" href="https://mandoc.bsd.lv/man/mdoc.7.html"  target="_top"><code class="literal">mdoc(7)</code> format</a> and should be portable between mandoc and groff for rendering (except for minor differences, notably different spacing rules.)</p><p>For a preview, run <code class="literal">man --local-file path/to/file.8</code>.</p><p>Being written in <code class="literal">mdoc</code>, these manpages use semantic markup. This following subsections provides a guideline on where to apply which semantic elements.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ssec-contributing-nixos-tools-cli-and-args" class="title" style="clear: both">Command lines and arguments   </h2>  </div> </div></div><p>In any manpage, commands, flags and arguments to the <span class="emphasis"><em>current</em></span> executable should be marked according to their semantics. Commands, flags and arguments passed to <span class="emphasis"><em>other</em></span> executables should not be marked like this and should instead be considered as code examples and marked with <code class="literal">Ql</code>.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Use <code class="literal">Fl</code> to mark flag arguments, <code class="literal">Ar</code> for their arguments.</p></li><li class="listitem"><p>Repeating arguments should be marked by adding an ellipsis (spelled with periods, <code class="literal">...</code>).</p></li><li class="listitem"><p>Use <code class="literal">Cm</code> to mark literal string arguments, e.g. the <code class="literal">boot</code> command argument passed to <code class="literal">nixos-rebuild</code>.</p></li><li class="listitem"><p>Optional flags or arguments should be marked with <code class="literal">Op</code>. This includes optional repeating arguments.</p></li><li class="listitem"><p>Required flags or arguments should not be marked.</p></li><li class="listitem"><p>Mutually exclusive groups of arguments should be enclosed in curly brackets, preferably created with <code class="literal">Bro</code>/<code class="literal">Brc</code> blocks.</p></li></ul></div><p>When an argument is used in an example it should be marked up with <code class="literal">Ar</code> again to differentiate it from a constant. For example, a command with a <code class="literal">--host name</code> option that calls ssh to retrieve the host’s local time would signify this thusly:</p><pre><code class="programlisting">This will run
.Ic ssh Ar name Ic time
to retrieve the remote time.
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ssec-contributing-nixos-tools-options-and-environment" class="title" style="clear: both">Paths, NixOS options, environment variables   </h2>  </div> </div></div><p>Constant paths should be marked with <code class="literal">Pa</code>, NixOS options with <code class="literal">Va</code>, and environment variables with <code class="literal">Ev</code>.</p><p>Generated paths, e.g. <code class="literal">result/bin/run-hostname-vm</code> (where <code class="literal">hostname</code> is a variable or arguments) should be marked as <code class="literal">Ql</code> inline literals with their variable components marked appropriately.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>When <code class="literal">hostname</code> refers to an argument, it becomes <code class="literal">.Ql result/bin/run- Ns Ar hostname Ns -vm</code></p></li><li class="listitem"><p>When <code class="literal">hostname</code> refers to a variable, it becomes <code class="literal">.Ql result/bin/run- Ns Va hostname Ns -vm</code></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ssec-contributing-nixos-tools-code-examples" class="title" style="clear: both">Code examples and other commands   </h2>  </div> </div></div><p>In free text names and complete invocations of other commands (e.g. <code class="literal">ssh</code> or <code class="literal">tar -xvf src.tar</code>) should be marked with <code class="literal">Ic</code>, fragments of command lines should be marked with <code class="literal">Ql</code>.</p><p>Larger code blocks or those that cannot be shown inline should use indented literal display block markup for their contents, i.e.</p><pre><code class="programlisting">.Bd -literal -offset indent
...
.Ed
</code></pre><p>Contents of code blocks may be marked up further, e.g. if they refer to arguments that will be substituted into them:</p><pre><code class="programlisting">.Bd -literal -offset indent
{
  config.networking.hostname = &quot;\c
.Ar hostname Ns \c
&quot;;
}
.Ed
</code></pre>
</div>

</div>

</div>
 </div>
  <div class="navfooter">
   <hr />
   <table width="100%" summary="Navigation footer">
    <tr>
    <td width="40%" align="left">&nbsp;</td>
    <td width="20%" align="center">&nbsp;</td>
    <td width="40%" align="right">&nbsp;<a accesskey="n" href="options.html">Next</a></td>
    </tr>
    <tr>
     <td width="40%" align="left" valign="top">&nbsp;</td>
     <td width="20%" align="center">&nbsp;</td>
     <td width="40%" align="right" valign="top">&nbsp;Appendix A. Configuration Options</td>
    </tr>
   </table>
  </div>
 </body>
</html>