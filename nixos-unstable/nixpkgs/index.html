<?xml version="1.0" encoding="utf-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 <title>Nixpkgs Reference Manual</title>
<link rel="stylesheet" type="text/css" href="style.css" /><link rel="stylesheet" type="text/css" href="highlightjs/mono-blue.css" />
<script src="./highlightjs/highlight.pack.js" type="text/javascript"></script><script src="./highlightjs/loader.js" type="text/javascript"></script><script src="./anchor.min.js" type="text/javascript"></script><script src="./anchor-use.js" type="text/javascript"></script><script src="./index-redirects.js" type="text/javascript"></script>
 <meta name="generator" content="nixos-render-docs" />
 <link rel="home" href="index.html" title="Nixpkgs Reference Manual" />
 <link rel="next" href="release-notes.html" title="Appendix A. Release Notes" />
 </head>
 <body>
  <div class="navheader">
   <table width="100%" summary="Navigation header">
    <tr>
    <th colspan="3" align="center">Nixpkgs Reference Manual</th>
    </tr>
    <tr>
    <td width="20%" align="left">&nbsp;</td>
    <th width="60%" align="center">&nbsp;</th>
    <td width="20%" align="right">&nbsp;<a accesskey="n" href="release-notes.html">Next</a></td>
    </tr>
   </table>
   <hr />
  </div>
 <div class="book">
  <div class="titlepage">
   <div>
   <div><h1 class="title"><a id="nixpkgs-manual"></a>Nixpkgs Reference Manual</h1></div>
   <div><h2 class="subtitle">Version 25.11pre-git</h2></div>
   </div>
   <hr />
  </div>
<div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#preface">Preface</a> </span></dt><dt> <span class="part">  <a href="index.html#part-using">Using Nixpkgs</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#chap-platform-support">Platform Support</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-packageconfig">Global configuration</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-overlays">Overlays</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-overrides">Overriding</a> </span></dt></dl></dd><dt> <span class="part">  <a href="index.html#id-1.4">Nixpkgs <code class="literal">lib</code></a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#chap-functions">Functions reference</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-system">Module System</a> </span></dt></dl></dd><dt> <span class="part">  <a href="index.html#part-stdenv">Standard environment</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#chap-stdenv">The Standard Environment</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-meta">Meta-attributes</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-passthru">Passthru-attributes</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-multiple-output">Multiple-output packages</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-cross">Cross-compilation</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-platform-notes">Platform Notes</a> </span></dt></dl></dd><dt> <span class="part">  <a href="index.html#part-toolchains">Toolchains</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#chap-toolchains">The LLVM Toolchain</a> </span></dt></dl></dd><dt> <span class="part">  <a href="index.html#part-builders">Build helpers</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#chap-build-helpers-finalAttrs">Fixed-point arguments of build helpers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-pkgs-fetchers">Fetchers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-trivial-builders">Trivial build helpers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-testers">Testers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-devShellTools">Development Shell helpers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-special">Special build helpers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-images">Images</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-hooks">Hooks reference</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-language-support">Languages and frameworks</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-packages">Packages</a> </span></dt></dl></dd><dt> <span class="part">  <a href="index.html#part-development">Development of Nixpkgs</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#sec-opening-issues">Opening issues</a> </span></dt></dl></dd><dt> <span class="part">  <a href="index.html#part-contributing">Contributing to Nixpkgs</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#chap-quick-start">Quick Start to Adding a Package</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-conventions">Coding conventions</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-submitting-changes">Submitting changes</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-vulnerability-roundup">Vulnerability Roundup</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-reviewing-contributions">Reviewing contributions</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-contributing">Contributing to Nixpkgs documentation</a> </span></dt></dl></dd><dt> <span class="part">  <a href="index.html#part-interoperability">Interoperability Standards</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="index.html#chap-interop-cyclonedx">CycloneDX</a> </span></dt></dl></dd><dt> <span class="appendix">  <a href="release-notes.html">A. Release Notes</a> </span></dt> </dl></div><div class="list-of-examples"><p><strong>List of Examples</strong></p><dl><dt>1. <a href="index.html#map-attrs-recursive-example">Map over leaf attributes</a></dt><dt>2. <a href="index.html#map-attrs-recursive-cond-example">Map over an leaf attributes defined by a condition</a></dt><dt>3. <a href="index.html#ex-makeScope">Create an interdependent package set on top of <code class="literal">pkgs</code></a></dt><dt>4. <a href="index.html#ex-makeScope-callPackage">Using <code class="literal">callPackage</code> from a scope</a></dt><dt>5. <a href="index.html#ex-gdb-debug-symbols-socat">Enable debug symbols for use with GDB</a></dt><dt>6. <a href="index.html#ex-accessing-passthru">Setting and accessing <code class="literal">passthru</code> attributes</a></dt><dt>7. <a href="index.html#ex-build-helpers-extendMkDerivation">Example definition of <code class="literal">mkLocalDerivation</code> extended from <code class="literal">stdenv.mkDerivation</code> with <code class="literal">lib.extendMkDerivation</code></a></dt><dt>8. <a href="index.html#ex-fetchers-update-fod-hash">Update source hash with the fake hash method</a></dt><dt>9. <a href="index.html#ex-fetchers-fetchurl-nixpkgs-version">Using <code class="literal">fetchurl</code> to download a file</a></dt><dt>10. <a href="index.html#ex-fetchers-fetchurl-nixpkgs-version-multiple-urls">Using <code class="literal">fetchurl</code> to download a file with multiple possible URLs</a></dt><dt>11. <a href="index.html#ex-fetchers-fetchurl-nixpkgs-version-postfetch">Manipulating the content downloaded by <code class="literal">fetchurl</code></a></dt><dt>12. <a href="index.html#ex-fetchers-fetchzip-simple-striproot">Using <code class="literal">fetchzip</code> to output contents directly</a></dt><dt>13. <a href="index.html#ex-fetchers-fetchzip-rar-archive">Using <code class="literal">fetchzip</code> to decompress a <code class="literal">.rar</code> file</a></dt><dt>14. <a href="index.html#ex-fetchgit-sparseCheckout">Use <code class="literal">sparseCheckout</code> to only include some directories:</a></dt><dt>15. <a href="index.html#ex-runcommandwith">Invocation of <code class="literal">runCommandWith</code></a></dt><dt>16. <a href="index.html#ex-runcommand-simple">Invocation of <code class="literal">runCommand</code></a></dt><dt>17. <a href="index.html#ex-makeDesktopItem">Usage 1 of <code class="literal">makeDesktopItem</code></a></dt><dt>18. <a href="index.html#ex2-makeDesktopItem">Usage 2 of <code class="literal">makeDesktopItem</code></a></dt><dt>19. <a href="index.html#ex-writeTextFile">Usage 1 of <code class="literal">writeTextFile</code></a></dt><dt>20. <a href="index.html#ex2-writeTextFile">Usage 2 of <code class="literal">writeTextFile</code></a></dt><dt>21. <a href="index.html#ex3-writeTextFile">Usage 3 of <code class="literal">writeTextFile</code></a></dt><dt>22. <a href="index.html#ex-writeText">Usage of <code class="literal">writeText</code></a></dt><dt>23. <a href="index.html#ex-writeTextDir">Usage of <code class="literal">writeTextDir</code></a></dt><dt>24. <a href="index.html#ex-writeScript">Usage of <code class="literal">writeScript</code></a></dt><dt>25. <a href="index.html#ex-writeScriptBin">Usage of <code class="literal">writeScriptBin</code></a></dt><dt>26. <a href="index.html#ex-writeShellScript">Usage of <code class="literal">writeShellScript</code></a></dt><dt>27. <a href="index.html#ex-writeShellScriptBin">Usage of <code class="literal">writeShellScriptBin</code></a></dt><dt>28. <a href="index.html#ex-haspkgconfigmodules-defaultvalues">Check that <code class="literal">pkg-config</code> modules are exposed using default values</a></dt><dt>29. <a href="index.html#ex-haspkgconfigmodules-explicitmodules">Check that <code class="literal">pkg-config</code> modules are exposed using explicit module names</a></dt><dt>30. <a href="index.html#ex-hascmakeconfigmodules">Check that <code class="literal">*config.cmake</code> modules are exposed using explicit module names</a></dt><dt>31. <a href="index.html#ex-lycheelinkcheck">Check hyperlinks in the <code class="literal">nix</code> documentation</a></dt><dt>32. <a href="index.html#ex-shellcheck">Run <code class="literal">testers.shellcheck</code></a></dt><dt>33. <a href="index.html#ex-shfmt">Run <code class="literal">testers.shfmt</code></a></dt><dt>34. <a href="index.html#ex-testversion-hello">Check a program version using all the default values</a></dt><dt>35. <a href="index.html#ex-testversion-different-commandversion">Check the program version using a specified command and expected version string</a></dt><dt>36. <a href="index.html#ex-testBuildFailure-showingenvironmentchanges">Check that a build fails, and verify the changes made during build</a></dt><dt>37. <a href="index.html#ex-testBuildFailurePrime-doc-example">Check that a build fails, and verify the changes made during build</a></dt><dt>38. <a href="index.html#ex-testEqualContents-toyexample">Check that two paths have the same contents</a></dt><dt>39. <a href="index.html#ex-testEqualArrayOrMap-test-function-add-cowbell">Test a function which appends a value to an array</a></dt><dt>40. <a href="index.html#ex-testEqualDerivation-hello">Check that two packages produce the same derivation</a></dt><dt>41. <a href="index.html#ex-invalidateFetcherByDrvHash-nix">Prevent nix from reusing the output of a fetcher</a></dt><dt>42. <a href="index.html#ex-tester-runCommand-nix">Run a command with network access</a></dt><dt>43. <a href="index.html#ex-runNixOSTest-hello">Run a NixOS test using <code class="literal">runNixOSTest</code></a></dt><dt>44. <a href="index.html#ex-fakeNss-dockerTools-buildImage">Using <code class="literal">fakeNss</code> with <code class="literal">dockerTools.buildImage</code></a></dt><dt>45. <a href="index.html#ex-fakeNss-overriding">Using <code class="literal">fakeNss</code> with an override to add extra lines</a></dt><dt>46. <a href="index.html#ex-wrapping-appimage-from-github">Wrapping an AppImage from GitHub</a></dt><dt>47. <a href="index.html#ex-wrapping-appimage-with-extrapkgs">Wrapping an AppImage with extra packages</a></dt><dt>48. <a href="index.html#ex-extracting-appimage">Extracting an AppImage to install extra files</a></dt><dt>49. <a href="index.html#ex-extracting-appimage-with-postextract">Extracting an AppImage to install extra files, using <code class="literal">postExtract</code></a></dt><dt>50. <a href="index.html#ex-dockerTools-buildImage">Building a Docker image</a></dt><dt>51. <a href="index.html#ex-dockerTools-buildImage-runAsRoot">Building a Docker image with <code class="literal">runAsRoot</code></a></dt><dt>52. <a href="index.html#ex-dockerTools-buildImage-extraCommands">Building a Docker image with <code class="literal">extraCommands</code></a></dt><dt>53. <a href="index.html#ex-dockerTools-buildImage-creatednow">Building a Docker image with a creation date set to the current time</a></dt><dt>54. <a href="index.html#ex-dockerTools-buildLayeredImage-hello">Building a layered Docker image</a></dt><dt>55. <a href="index.html#ex-dockerTools-streamLayeredImage-hello">Streaming a layered Docker image</a></dt><dt>56. <a href="index.html#ex-dockerTools-streamLayeredImage-exploringlayers">Exploring the layers in an image built with <code class="literal">streamLayeredImage</code></a></dt><dt>57. <a href="index.html#ex-dockerTools-streamLayeredImage-configclosure">Building a layered Docker image with packages directly in <code class="literal">config</code></a></dt><dt>58. <a href="index.html#ex-dockerTools-pullImage-niximage">Pulling the nixos/nix Docker image from the default registry</a></dt><dt>59. <a href="index.html#ex-dockerTools-pullImage-differentregistry">Pulling the nixos/nix Docker image from a specific registry</a></dt><dt>60. <a href="index.html#ex-dockerTools-pullImage-nixprefetchdocker">Finding the digest and hash values to use for <code class="literal">dockerTools.pullImage</code></a></dt><dt>61. <a href="index.html#ex-dockerTools-exportImage-hello">Exporting a Docker image with <code class="literal">dockerTools.exportImage</code></a></dt><dt>62. <a href="index.html#ex-dockerTools-exportImage-importingDocker">Importing an archive built with <code class="literal">dockerTools.exportImage</code> in Docker</a></dt><dt>63. <a href="index.html#ex-dockerTools-exportImage-naming">Exploring output naming with <code class="literal">dockerTools.exportImage</code></a></dt><dt>64. <a href="index.html#ex-dockerTools-exportImage-fromImagePath">Using <code class="literal">dockerTools.exportImage</code> with a path as <code class="literal">fromImage</code></a></dt><dt>65. <a href="index.html#ex-dockerTools-helpers-buildImage">Using <code class="literal">dockerTools</code>’s environment helpers with <code class="literal">buildImage</code></a></dt><dt>66. <a href="index.html#ex-dockerTools-helpers-buildLayeredImage">Using <code class="literal">dockerTools</code>’s environment helpers with <code class="literal">buildLayeredImage</code></a></dt><dt>67. <a href="index.html#ex-dockerTools-shadowSetup-buildImage">Using <code class="literal">dockerTools.shadowSetup</code> with <code class="literal">dockerTools.buildImage</code></a></dt><dt>68. <a href="index.html#ex-dockerTools-shadowSetup-buildLayeredImage">Using <code class="literal">dockerTools.shadowSetup</code> with <code class="literal">dockerTools.buildLayeredImage</code></a></dt><dt>69. <a href="index.html#ex-dockerTools-buildNixShellImage-hello">Building a Docker image with <code class="literal">buildNixShellImage</code> with the build environment for the <code class="literal">hello</code> package</a></dt><dt>70. <a href="index.html#ex-dockerTools-streamNixShellImage-hello">Building a Docker image with <code class="literal">streamNixShellImage</code> with the build environment for the <code class="literal">hello</code> package</a></dt><dt>71. <a href="index.html#ex-dockerTools-streamNixShellImage-extendingBuildInputs">Adding extra packages to a Docker image built with <code class="literal">streamNixShellImage</code></a></dt><dt>72. <a href="index.html#ex-dockerTools-streamNixShellImage-addingShellHook">Adding a <code class="literal">shellHook</code> to a Docker image built with <code class="literal">streamNixShellImage</code></a></dt><dt>73. <a href="index.html#ex-ociTools-buildContainer-bash">Creating an OCI runtime container that runs <code class="literal">bash</code></a></dt><dt>74. <a href="index.html#ex-portableService-hello">Building a Portable Service image</a></dt><dt>75. <a href="index.html#ex-portableService-symlinks">Specifying symlinks when building a Portable Service image</a></dt><dt>76. <a href="index.html#ex-mkbinarycache-copying-package-closure">Copying a package and its closure to another machine with <code class="literal">mkBinaryCache</code></a></dt><dt>77. <a href="index.html#example-navigte-nix-repl">Navigate Java compiler variants in <code class="literal">javaPackages</code> with <code class="literal">nix repl</code></a></dt><dt>78. <a href="index.html#example-list-haskellPackages">List all Python packages in Nixpkgs</a></dt><dt>79. <a href="index.html#ex-beam-ephemeral-shell">Ephemeral shell</a></dt><dt>80. <a href="index.html#ex-beam-declarative-shell">Declarative shell</a></dt><dt>81. <a href="index.html#usage-1-pkgs.zlib.override">Using <code class="literal">pkgs.zlib.override {}</code></a></dt><dt>82. <a href="index.html#usage-2-pkgs.buildemscriptenpackage">Using <code class="literal">pkgs.buildEmscriptenPackage {}</code></a></dt><dt>83. <a href="index.html#ex-overriding-kernel-derivation">Overriding the kernel derivation</a></dt><dt>84. <a href="index.html#ex-using-linux-manual-config">Using <code class="literal">pkgs.linuxPackages_custom</code> with a specific source, version, and config file</a></dt><dt>85. <a href="index.html#ex-edit-compile-run-kernel-modules">Edit-compile-run loop when developing <code class="literal">mellanox</code> drivers</a></dt><dt>86. <a href="index.html#ex-pkgs-substitute">Usage of <code class="literal">pkgs.substitute</code></a></dt><dt>87. <a href="index.html#ex-pkgs-replace-vars">Usage of <code class="literal">pkgs.replaceVars</code></a></dt><dt>88. <a href="index.html#ex-pkgs-replace-vars-with">Usage of <code class="literal">pkgs.replaceVarsWith</code></a></dt></dl></div>
<div class="chapter"> <div class="titlepage">  <div>   <div>    <h1 id="preface" class="title" >Preface   </h1>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#overview-of-nixpkgs">Overview of Nixpkgs</a> </span></dt> </dl></div><p>The Nix Packages collection (Nixpkgs) is a set of thousands of packages for the
<a class="link" href="https://nixos.org/nix/"  target="_top">Nix package manager</a>, released under a
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/COPYING"  target="_top">permissive MIT license</a>.
Packages are available for several platforms, and can be used with the Nix
package manager on most GNU/Linux distributions as well as <a class="link" href="https://nixos.org/nixos"  target="_top">NixOS</a>.</p><p>This document is the user <a class="link" href="https://nix.dev/contributing/documentation/diataxis#reference"  target="_top"><span class="emphasis"><em>reference</em></span></a> manual for Nixpkgs.
It describes entire public interface of Nixpkgs in a concise and orderly manner, and all relevant behaviors, with examples and cross-references.</p><p>To discover other kinds of documentation:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="https://nix.dev/"  target="_top">nix.dev</a>: Tutorials and guides for getting things done with Nix</p></li><li class="listitem"><p><a class="link" href="https://search.nixos.org/options"  target="_top">NixOS <span class="strong"><strong>Option Search</strong></span></a> and reference documentation</p></li><li class="listitem"><p><a class="link" href="https://search.nixos.org/packages"  target="_top">Nixpkgs <span class="strong"><strong>Package Search</strong></span></a></p></li><li class="listitem"><p><a class="link" href="https://nixos.org/manual/nixos/stable/"  target="_top"><span class="strong"><strong>NixOS</strong></span> manual</a>: Reference documentation for the NixOS Linux distribution</p></li><li class="listitem"><p><a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top"><code class="literal">CONTRIBUTING.md</code></a>: Contributing to Nixpkgs, including this manual</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h1 id="overview-of-nixpkgs" class="title" style="clear: both">Overview of Nixpkgs   </h1>  </div> </div></div><p>Nix expressions describe how to build packages from source and are collected in
the <a class="link" href="https://github.com/NixOS/nixpkgs"  target="_top">nixpkgs repository</a>. Also included in the
collection are Nix expressions for
<a class="link" href="https://nixos.org/nixos/manual/index.html#sec-writing-modules"  target="_top">NixOS modules</a>.
With these expressions the Nix package manager can build binary packages.</p><p>Packages, including the Nix packages collection, are distributed through
<a class="link" href="https://nixos.org/nix/manual/#sec-channels"  target="_top">channels</a>. The collection is
distributed for users of Nix on non-NixOS distributions through the channel
<code class="literal">nixpkgs-unstable</code>. Users of NixOS generally use one of the <code class="literal">nixos-*</code> channels,
e.g. <code class="literal">nixos-22.11</code>, which includes all packages and modules for the stable NixOS
22.11. Stable NixOS releases are generally only given
security updates. More up to date packages and modules are available via the
<code class="literal">nixos-unstable</code> channel.</p><p>Both <code class="literal">nixos-unstable</code> and <code class="literal">nixpkgs-unstable</code> follow the <code class="literal">master</code> branch of the
nixpkgs repository, although both do lag the <code class="literal">master</code> branch by generally
<a class="link" href="https://status.nixos.org/"  target="_top">a couple of days</a>. Updates to a channel are
distributed as soon as all tests for that channel pass, e.g.
<a class="link" href="https://hydra.nixos.org/job/nixpkgs/trunk/unstable#tabs-constituents"  target="_top">this table</a>
shows the status of tests for the <code class="literal">nixpkgs-unstable</code> channel.</p><p>The tests are conducted by a cluster called <a class="link" href="https://nixos.org/hydra/"  target="_top">Hydra</a>,
which also builds binary packages from the Nix expressions in Nixpkgs for
<code class="literal">x86_64-linux</code>, <code class="literal">aarch64-linux</code>, <code class="literal">x86_64-darwin</code> and <code class="literal">aarch64-darwin</code>.
The binaries are made available via a <a class="link" href="https://cache.nixos.org"  target="_top">binary cache</a>.</p><p>The current Nix expressions of the channels are available in the
<a class="link" href="https://github.com/NixOS/nixpkgs"  target="_top">nixpkgs repository</a> in branches
that correspond to the channel names (e.g. <code class="literal">nixos-22.11-small</code>).</p>
</div>

</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="part-using" class="title" >Using Nixpkgs   </h1>  </div> </div></div><div class="partintro"><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#chap-platform-support">Platform Support</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-packageconfig">Global configuration</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-overlays">Overlays</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-overrides">Overriding</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-platform-support" class="title" >Platform Support   </h2>  </div> </div></div><p>Packages receive varying degrees of support, both in terms of maintainer attention and available computation resources for continuous integration (CI).</p><p>Below is the list of the best supported platforms:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">x86_64-linux</code>: Highest level of support.</p></li><li class="listitem"><p><code class="literal">aarch64-linux</code>: Well supported, with most packages building successfully in CI.</p></li><li class="listitem"><p><code class="literal">aarch64-darwin</code>: Receives better support than <code class="literal">x86_64-darwin</code>.</p></li><li class="listitem"><p><code class="literal">x86_64-darwin</code>: Receives some support.</p></li></ul></div><p>There are many other platforms with varying levels of support.
The provisional platform list in <a class="link" href="https://github.com/NixOS/rfcs/blob/master/rfcs/0046-platform-support-tiers.md#appendix-a-non-normative-description-of-platforms-in-november-2019"  target="_top">Appendix A</a> of <a class="link" href="https://github.com/NixOS/rfcs/blob/master/rfcs/0046-platform-support-tiers.md"  target="_top">RFC046</a>, while not up to date, can be used as guidance.</p><p>A more formal definition of the platform support tiers is provided in <a class="link" href="https://github.com/NixOS/rfcs/blob/master/rfcs/0046-platform-support-tiers.md"  target="_top">RFC046</a>, but has not been fully implemented yet.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-packageconfig" class="title" >Global configuration   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-allow-broken">Installing broken packages</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-allow-unsupported-system">Installing packages on unsupported systems</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-allow-unfree">Installing unfree packages</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-allow-insecure">Installing insecure packages</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-modify-via-packageOverrides">Modify packages via <code class="literal">packageOverrides</code></a> </span></dt><dt> <span class="section">  <a href="index.html#sec-config-options-reference"><code class="literal">config</code> Options Reference</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-declarative-package-management">Declarative Package Management</a> </span></dt> </dl></div><p>Nix comes with certain defaults about which packages can and cannot be installed, based on a package’s metadata.
By default, Nix will prevent installation if any of the following criteria are true:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>The package is thought to be broken, and has had its <code class="literal">meta.broken</code> set to <code class="literal">true</code>.</p></li><li class="listitem"><p>The package isn’t intended to run on the given system, as none of its <code class="literal">meta.platforms</code> match the given system.</p></li><li class="listitem"><p>The package’s <code class="literal">meta.license</code> is set to a license which is considered to be unfree.</p></li><li class="listitem"><p>The package has known security vulnerabilities but has not or can not be updated for some reason, and a list of issues has been entered in to the package’s <code class="literal">meta.knownVulnerabilities</code>.</p></li></ul></div><p>Each of these criteria can be altered in the Nixpkgs configuration.</p><div class="note"><h3 class="title">Note</h3><p>All this is checked during evaluation already, and the check includes any package that is evaluated.
In particular, all build-time dependencies are checked.</p></div><p>A user’s Nixpkgs configuration is stored in a user-specific configuration file located at <code class="literal">~/.config/nixpkgs/config.nix</code>. For example:</p><pre><code class="programlisting nix">{ allowUnfree = true; }
</code></pre><div class="caution"><h3 class="title">Caution</h3><p>Unfree software is not tested or built in Nixpkgs continuous integration, and therefore not cached.
Most unfree licenses prohibit either executing or distributing the software.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-allow-broken" class="title" style="clear: both">Installing broken packages   </h2>  </div> </div></div><p>There are two ways to try compiling a package which has been marked as broken.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>For allowing the build of a broken package once, you can use an environment variable for a single invocation of the nix tools:</p><pre><code class="programlisting ShellSession">$ export NIXPKGS_ALLOW_BROKEN=1
</code></pre></li><li class="listitem"><p>For permanently allowing broken packages to be built, you may add <code class="literal">allowBroken = true;</code> to your user’s configuration file, like this:</p><pre><code class="programlisting nix">{ allowBroken = true; }
</code></pre></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-allow-unsupported-system" class="title" style="clear: both">Installing packages on unsupported systems   </h2>  </div> </div></div><p>There are also two ways to try compiling a package which has been marked as unsupported for the given system.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>For allowing the build of an unsupported package once, you can use an environment variable for a single invocation of the nix tools:</p><pre><code class="programlisting ShellSession">$ export NIXPKGS_ALLOW_UNSUPPORTED_SYSTEM=1
</code></pre></li><li class="listitem"><p>For permanently allowing unsupported packages to be built, you may add <code class="literal">allowUnsupportedSystem = true;</code> to your user’s configuration file, like this:</p><pre><code class="programlisting nix">{ allowUnsupportedSystem = true; }
</code></pre></li></ul></div><p>The difference between a package being unsupported on some system and being broken is admittedly a bit fuzzy. If a program <span class="emphasis"><em>ought</em></span> to work on a certain platform, but doesn’t, the platform should be included in <code class="literal">meta.platforms</code>, but marked as broken with e.g.  <code class="literal">meta.broken = !hostPlatform.isWindows</code>. Of course, this begs the question of what “ought” means exactly. That is left to the package maintainer.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-allow-unfree" class="title" style="clear: both">Installing unfree packages   </h2>  </div> </div></div><p>All users of Nixpkgs are free software users, and many users (and developers) of Nixpkgs want to limit and tightly control their exposure to unfree software.
At the same time, many users need (or want) to run some specific pieces of proprietary software.
Nixpkgs includes some expressions for unfree software packages.
By default unfree software cannot be installed and doesn’t show up in searches.</p><p>There are several ways to tweak how Nix handles a package which has been marked as unfree.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>To temporarily allow all unfree packages, you can use an environment variable for a single invocation of the nix tools:</p><pre><code class="programlisting ShellSession">$ export NIXPKGS_ALLOW_UNFREE=1
</code></pre></li><li class="listitem"><p>It is possible to permanently allow individual unfree packages, while still blocking unfree packages by default using the <code class="literal">allowUnfreePredicate</code> configuration option in the user configuration file.</p><p>This option is a function which accepts a package as a parameter, and returns a boolean. The following example configuration accepts a package and always returns false:</p><pre><code class="programlisting nix">{ allowUnfreePredicate = (pkg: false); }
</code></pre><p>For a more useful example, try the following. This configuration only allows unfree packages named roon-server and visual studio code:</p><pre><code class="programlisting nix">{
  allowUnfreePredicate =
    pkg:
    builtins.elem (lib.getName pkg) [
      &quot;roon-server&quot;
      &quot;vscode&quot;
    ];
}
</code></pre></li><li class="listitem"><p>It is also possible to allow and block licenses that are specifically acceptable or not acceptable, using <code class="literal">allowlistedLicenses</code> and <code class="literal">blocklistedLicenses</code>, respectively.</p><p>The following example configuration allowlists the licenses <code class="literal">amd</code> and <code class="literal">wtfpl</code>:</p><pre><code class="programlisting nix">{
  allowlistedLicenses = with lib.licenses; [
    amd
    wtfpl
  ];
}
</code></pre><p>The following example configuration blocklists the <code class="literal">gpl3Only</code> and <code class="literal">agpl3Only</code> licenses:</p><pre><code class="programlisting nix">{
  blocklistedLicenses = with lib.licenses; [
    agpl3Only
    gpl3Only
  ];
}
</code></pre><p>Note that <code class="literal">allowlistedLicenses</code> only applies to unfree licenses unless <code class="literal">allowUnfree</code> is enabled. It is not a generic allowlist for all types of licenses. <code class="literal">blocklistedLicenses</code> applies to all licenses.</p></li></ul></div><p>A complete list of licenses can be found in the file <code class="literal">lib/licenses.nix</code> of the nixpkgs tree.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-allow-insecure" class="title" style="clear: both">Installing insecure packages   </h2>  </div> </div></div><p>There are several ways to tweak how Nix handles a package which has been marked as insecure.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>To temporarily allow all insecure packages, you can use an environment variable for a single invocation of the nix tools:</p><pre><code class="programlisting ShellSession">$ export NIXPKGS_ALLOW_INSECURE=1
</code></pre></li><li class="listitem"><p>It is possible to permanently allow individual insecure packages, while still blocking other insecure packages by default using the <code class="literal">permittedInsecurePackages</code> configuration option in the user configuration file.</p><p>The following example configuration permits the installation of the hypothetically insecure package <code class="literal">hello</code>, version <code class="literal">1.2.3</code>:</p><pre><code class="programlisting nix">{ permittedInsecurePackages = [ &quot;hello-1.2.3&quot; ]; }
</code></pre></li><li class="listitem"><p>It is also possible to create a custom policy around which insecure packages to allow and deny, by overriding the <code class="literal">allowInsecurePredicate</code> configuration option.</p><p>The <code class="literal">allowInsecurePredicate</code> option is a function which accepts a package and returns a boolean, much like <code class="literal">allowUnfreePredicate</code>.</p><p>The following configuration example allows any version of the <code class="literal">ovftool</code> package:</p><pre><code class="programlisting nix">{ allowInsecurePredicate = pkg: builtins.elem (lib.getName pkg) [ &quot;ovftool&quot; ]; }
</code></pre><p>Note that <code class="literal">permittedInsecurePackages</code> is only checked if <code class="literal">allowInsecurePredicate</code> is not specified.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-modify-via-packageOverrides" class="title" style="clear: both">Modify packages via <code class="literal">packageOverrides</code>   </h2>  </div> </div></div><p>You can define a function called <code class="literal">packageOverrides</code> in your local <code class="literal">~/.config/nixpkgs/config.nix</code> to override Nix packages. It must be a function that takes pkgs as an argument and returns a modified set of packages.</p><pre><code class="programlisting nix">{
  packageOverrides = pkgs: rec {
    foo = pkgs.foo.override {
      # ...
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-config-options-reference" class="title" style="clear: both"><code class="literal">config</code> Options Reference   </h2>  </div> </div></div><p>The following attributes can be passed in <a class="link" href="index.html#chap-packageconfig" title="Global configuration" ><code class="literal">config</code></a>.</p><div class="variablelist">
<a id="configuration-variable-list"></a>
 <dl class="variablelist">
<dt>
 <span class="term">
 <a id="opt-enableParallelBuildingByDefault"></a><a class="term" href="index.html#opt-enableParallelBuildingByDefault"><code class="option">enableParallelBuildingByDefault</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to set <code class="literal">enableParallelBuilding</code> to true by default while building nixpkgs packages.
Changing the default may cause a mass rebuild.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-allowAliases"></a><a class="term" href="index.html#opt-allowAliases"><code class="option">allowAliases</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to expose old attribute names for compatibility.</p><p>The recommended setting is to enable this, as it
improves backward compatibility, easing updates.</p><p>The only reason to disable aliases is for continuous
integration purposes. For instance, Nixpkgs should
not depend on aliases in its internal code. Projects
that aren’t Nixpkgs should be cautious of instantly
removing all usages of aliases, as migrating too soon
can break compatibility with the stable Nixpkgs releases.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">true</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-allowBroken"></a><a class="term" href="index.html#opt-allowBroken"><code class="option">allowBroken</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to allow broken packages.</p><p>See <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#sec-allow-broken"  target="_top">Installing broken packages</a> in the NixOS manual.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false || builtins.getEnv &quot;NIXPKGS_ALLOW_BROKEN&quot; == &quot;1&quot;</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-allowUnfree"></a><a class="term" href="index.html#opt-allowUnfree"><code class="option">allowUnfree</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to allow unfree packages.</p><p>See <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#sec-allow-unfree"  target="_top">Installing unfree packages</a> in the NixOS manual.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false || builtins.getEnv &quot;NIXPKGS_ALLOW_UNFREE&quot; == &quot;1&quot;</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-allowUnsupportedSystem"></a><a class="term" href="index.html#opt-allowUnsupportedSystem"><code class="option">allowUnsupportedSystem</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to allow unsupported packages.</p><p>See <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#sec-allow-unsupported-system"  target="_top">Installing packages on unsupported systems</a> in the NixOS manual.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false || builtins.getEnv &quot;NIXPKGS_ALLOW_UNSUPPORTED_SYSTEM&quot; == &quot;1&quot;</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-allowVariants"></a><a class="term" href="index.html#opt-allowVariants"><code class="option">allowVariants</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to expose the nixpkgs variants.</p><p>Variants are instances of the current nixpkgs instance with different stdenvs or other applied options.
This allows for using different toolchains, libcs, or global build changes across nixpkgs.
Disabling can ensure nixpkgs is only building for the platform which you specified.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">true</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-checkMeta"></a><a class="term" href="index.html#opt-checkMeta"><code class="option">checkMeta</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to check that the <code class="literal">meta</code> attribute of derivations are correct during evaluation time.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-configurePlatformsByDefault"></a><a class="term" href="index.html#opt-configurePlatformsByDefault"><code class="option">configurePlatformsByDefault</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to set <code class="literal">configurePlatforms</code> to <code class="literal">[&quot;build&quot; &quot;host&quot;]</code> by default while building nixpkgs packages.
Changing the default may cause a mass rebuild.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-contentAddressedByDefault"></a><a class="term" href="index.html#opt-contentAddressedByDefault"><code class="option">contentAddressedByDefault</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to set <code class="literal">__contentAddressed</code> to true by default while building nixpkgs packages.
Changing the default may cause a mass rebuild.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-cudaSupport"></a><a class="term" href="index.html#opt-cudaSupport"><code class="option">cudaSupport</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to build packages with CUDA support by default while building nixpkgs packages.
Changing the default may cause a mass rebuild.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-doCheckByDefault"></a><a class="term" href="index.html#opt-doCheckByDefault"><code class="option">doCheckByDefault</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to run <code class="literal">checkPhase</code> by default while building nixpkgs packages.
Changing the default may cause a mass rebuild.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-fetchedSourceNameDefault"></a><a class="term" href="index.html#opt-fetchedSourceNameDefault"><code class="option">fetchedSourceNameDefault</code>
  </a>
 </span>
</dt>
<dd>
<p>This controls the default derivation <code class="literal">name</code> attribute set by the
<code class="literal">fetch*</code> (<code class="literal">fetchzip</code>, <code class="literal">fetchFromGitHub</code>, etc) functions.</p><p>Possible values and the resulting <code class="literal">.name</code>:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">&quot;source&quot;</code> -&gt; <code class="literal">&quot;source&quot;</code></p></li><li class="listitem"><p><code class="literal">&quot;versioned&quot;</code> -&gt; <code class="literal">&quot;${repo}-${rev}-source&quot;</code></p></li><li class="listitem"><p><code class="literal">&quot;full&quot;</code> -&gt; <code class="literal">&quot;${repo}-${rev}-${fetcherName}-source&quot;</code></p></li></ul></div><p>The default <code class="literal">&quot;source&quot;</code> is the best choice for minimal rebuilds, it
will ignore any non-hash changes (like branches being renamed, source
URLs changing, etc) at the cost of <code class="literal">/nix/store</code> being easily
cache-poisoned (see <a class="link" href="https://github.com/NixOS/nix/issues/969"  target="_top">NixOS/nix#969</a>).</p><p>Setting this to <code class="literal">&quot;versioned&quot;</code> greatly helps with discoverability of
sources in <code class="literal">/nix/store</code> and makes cache-poisoning of <code class="literal">/nix/store</code> much
harder, at the cost of a single mass-rebuild for all <code class="literal">src</code>
derivations, and an occasional rebuild when a source changes some of
its non-hash attributes.</p><p>Setting this to <code class="literal">&quot;full&quot;</code> is similar to setting it to <code class="literal">&quot;versioned&quot;</code>,
but the use of <code class="literal">fetcherName</code> in the derivation name will force a
rebuild when <code class="literal">src</code> switches between <code class="literal">fetch*</code> functions, thus forcing
<code class="literal">nix</code> to check new derivation’s <code class="literal">outputHash</code>, which is useful for
debugging.</p><p>Also, <code class="literal">&quot;full&quot;</code> is useful for easy collection and tracking of
statistics of where the packages you use are hosted.</p><p>If you are a developer, you should probably set this to at
least<code class="literal">&quot;versioned&quot;</code>.</p><p>Changing the default will cause a mass rebuild.</p>

<p><span class="emphasis"><em>Type:</em></span>
one of “source”, “versioned”, “full”</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">&quot;source&quot;</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-microsoftVisualStudioLicenseAccepted"></a><a class="term" href="index.html#opt-microsoftVisualStudioLicenseAccepted"><code class="option">microsoftVisualStudioLicenseAccepted</code>
  </a>
 </span>
</dt>
<dd>
<p>If the Microsoft Visual Studio license has been accepted.</p><p>Please read https://www.visualstudio.com/license-terms/mt644918/ and enable this config if you accept.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false || builtins.getEnv &quot;NIXPKGS_ALLOW_UNFREE&quot; == &quot;1&quot;</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-replaceBootstrapFiles"></a><a class="term" href="index.html#opt-replaceBootstrapFiles"><code class="option">replaceBootstrapFiles</code>
  </a>
 </span>
</dt>
<dd>
<p>Use the bootstrap files returned instead of the default bootstrap
files.
The default bootstrap files are passed as an argument.
Changing the default may cause a mass rebuild.</p>

<p><span class="emphasis"><em>Type:</em></span>
function that evaluates to a(n) attribute set of package</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">lib.id</code></p>

<p><span class="emphasis"><em>Example:</em></span></p><pre><code class="programlisting">prevFiles:
let
  replacements = {
    &quot;sha256-YQlr088HPoVWBU2jpPhpIMyOyoEDZYDw1y60SGGbUM0=&quot; = import &lt;nix/fetchurl.nix&gt; {
      url = &quot;(custom glibc linux x86_64 bootstrap-tools.tar.xz)&quot;;
      hash = &quot;(...)&quot;;
    };
    &quot;sha256-QrTEnQTBM1Y/qV9odq8irZkQSD9uOMbs2Q5NgCvKCNQ=&quot; = import &lt;nix/fetchurl.nix&gt; {
      url = &quot;(custom glibc linux x86_64 busybox)&quot;;
      hash = &quot;(...)&quot;;
      executable = true;
    };
  };
in
builtins.mapAttrs (name: prev: replacements.${prev.outputHash} or prev) prevFiles

</code></pre>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-rewriteURL"></a><a class="term" href="index.html#opt-rewriteURL"><code class="option">rewriteURL</code>
  </a>
 </span>
</dt>
<dd>
<p>A hook to rewrite/filter URLs before they are fetched.</p><p>The function is passed the URL as a string, and is expected to return a new URL, or null if the given URL should not be attempted.</p><p>This function is applied <span class="emphasis"><em>prior</em></span> to resolving mirror:// URLs.</p><p>The intended use is to allow URL rewriting to insert company-internal mirrors, or work around company firewalls and similar network restrictions.</p>

<p><span class="emphasis"><em>Type:</em></span>
function that evaluates to a(n) (null or string)</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">(url: url)</code></p>

<p><span class="emphasis"><em>Example:</em></span></p><pre><code class="programlisting">{
  # Use Nix like it&#x27;s 2024! ;-)
  rewriteURL = url: &quot;https://web.archive.org/web/2024/${url}&quot;;
}

</code></pre>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-rocmSupport"></a><a class="term" href="index.html#opt-rocmSupport"><code class="option">rocmSupport</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to build packages with ROCm support by default while building nixpkgs packages.
Changing the default may cause a mass rebuild.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-showDerivationWarnings"></a><a class="term" href="index.html#opt-showDerivationWarnings"><code class="option">showDerivationWarnings</code>
  </a>
 </span>
</dt>
<dd>
<p>Which warnings to display for potentially dangerous
or deprecated values passed into <code class="literal">stdenv.mkDerivation</code>.</p><p>A list of warnings can be found in
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/stdenv/generic/check-meta.nix"  target="_top">/pkgs/stdenv/generic/check-meta.nix</a>.</p><p>This is not a stable interface; warnings may be added, changed
or removed without prior notice.</p>

<p><span class="emphasis"><em>Type:</em></span>
list of value “maintainerless” (singular enum)</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">[ ]</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-strictDepsByDefault"></a><a class="term" href="index.html#opt-strictDepsByDefault"><code class="option">strictDepsByDefault</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to set <code class="literal">strictDeps</code> to true by default while building nixpkgs packages.
Changing the default may cause a mass rebuild.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-structuredAttrsByDefault"></a><a class="term" href="index.html#opt-structuredAttrsByDefault"><code class="option">structuredAttrsByDefault</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to set <code class="literal">__structuredAttrs</code> to true by default while building nixpkgs packages.
Changing the default may cause a mass rebuild.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-warnUndeclaredOptions"></a><a class="term" href="index.html#opt-warnUndeclaredOptions"><code class="option">warnUndeclaredOptions</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to warn when <code class="literal">config</code> contains an unrecognized attribute.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/config.nix" target="_top">
pkgs/top-level/config.nix
</a></code>
</td></tr>
</table>
</dd>
 </dl>
</div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-declarative-package-management" class="title" style="clear: both">Declarative Package Management   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-building-environment">Build an environment</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-getting-documentation">Getting documentation</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-gnu-info-setup">GNU info setup</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-building-environment" class="title" >Build an environment   </h3>  </div> </div></div><p>Using <code class="literal">packageOverrides</code>, it is possible to manage packages declaratively. This means that we can list all of our desired packages within a declarative Nix expression. For example, to have <code class="literal">aspell</code>, <code class="literal">bc</code>, <code class="literal">ffmpeg</code>, <code class="literal">coreutils</code>, <code class="literal">gdb</code>, <code class="literal">nix</code>, <code class="literal">emscripten</code>, <code class="literal">jq</code>, <code class="literal">nox</code>, and <code class="literal">silver-searcher</code>, we could use the following in <code class="literal">~/.config/nixpkgs/config.nix</code>:</p><pre><code class="programlisting nix">{
  packageOverrides =
    pkgs: with pkgs; {
      myPackages = pkgs.buildEnv {
        name = &quot;my-packages&quot;;
        paths = [
          aspell
          bc
          coreutils
          gdb
          ffmpeg
          nix
          emscripten
          jq
          nox
          silver-searcher
        ];
      };
    };
}
</code></pre><p>To install it into our environment, you can just run <code class="literal">nix-env -iA nixpkgs.myPackages</code>. If you want to load the packages to be built from a working copy of <code class="literal">nixpkgs</code> you just run <code class="literal">nix-env -f. -iA myPackages</code>. To explore what’s been installed, just look through <code class="literal">~/.nix-profile/</code>. You can see that a lot of stuff has been installed. Some of this stuff is useful some of it isn’t. Let’s tell Nixpkgs to only link the stuff that we want:</p><pre><code class="programlisting nix">{
  packageOverrides =
    pkgs: with pkgs; {
      myPackages = pkgs.buildEnv {
        name = &quot;my-packages&quot;;
        paths = [
          aspell
          bc
          coreutils
          gdb
          ffmpeg
          nix
          emscripten
          jq
          nox
          silver-searcher
        ];
        pathsToLink = [
          &quot;/share&quot;
          &quot;/bin&quot;
        ];
      };
    };
}
</code></pre><p><code class="literal">pathsToLink</code> tells Nixpkgs to only link the paths listed which gets rid of the extra stuff in the profile. <code class="literal">/bin</code> and <code class="literal">/share</code> are good defaults for a user environment, getting rid of the clutter. If you are running on Nix on MacOS, you may want to add another path as well, <code class="literal">/Applications</code>, that makes GUI apps available.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-getting-documentation" class="title" >Getting documentation   </h3>  </div> </div></div><p>After building that new environment, look through <code class="literal">~/.nix-profile</code> to make sure everything is there that we wanted. Discerning readers will note that some files are missing. Look inside <code class="literal">~/.nix-profile/share/man/man1/</code> to verify this. There are no man pages for any of the Nix tools! This is because some packages like Nix have multiple outputs for things like documentation (see section 4). Let’s make Nix install those as well.</p><pre><code class="programlisting nix">{
  packageOverrides =
    pkgs: with pkgs; {
      myPackages = pkgs.buildEnv {
        name = &quot;my-packages&quot;;
        paths = [
          aspell
          bc
          coreutils
          ffmpeg
          nix
          emscripten
          jq
          nox
          silver-searcher
        ];
        pathsToLink = [
          &quot;/share/man&quot;
          &quot;/share/doc&quot;
          &quot;/bin&quot;
        ];
        extraOutputsToInstall = [
          &quot;man&quot;
          &quot;doc&quot;
        ];
      };
    };
}
</code></pre><p>This provides us with some useful documentation for using our packages.  However, if we actually want those manpages to be detected by man, we need to set up our environment. This can also be managed within Nix expressions.</p><pre><code class="programlisting nix">{
  packageOverrides = pkgs: {
    myProfile = pkgs.writeText &quot;my-profile&quot; &#x27;&#x27;
      export PATH=$HOME/.nix-profile/bin:/nix/var/nix/profiles/default/bin:/sbin:/bin:/usr/sbin:/usr/bin
      export MANPATH=$HOME/.nix-profile/share/man:/nix/var/nix/profiles/default/share/man:/usr/share/man
    &#x27;&#x27;;
    myPackages = pkgs.buildEnv {
      name = &quot;my-packages&quot;;
      paths = with pkgs; [
        (runCommand &quot;profile&quot; { } &#x27;&#x27;
          mkdir -p $out/etc/profile.d
          cp ${myProfile} $out/etc/profile.d/my-profile.sh
        &#x27;&#x27;)
        aspell
        bc
        coreutils
        ffmpeg
        man
        nix
        emscripten
        jq
        nox
        silver-searcher
      ];
      pathsToLink = [
        &quot;/share/man&quot;
        &quot;/share/doc&quot;
        &quot;/bin&quot;
        &quot;/etc&quot;
      ];
      extraOutputsToInstall = [
        &quot;man&quot;
        &quot;doc&quot;
      ];
    };
  };
}
</code></pre><p>For this to work fully, you must also have this script sourced when you are logged in. Try adding something like this to your <code class="literal">~/.profile</code> file:</p><pre><code class="programlisting ShellSession">#!/bin/sh
if [ -d &quot;${HOME}/.nix-profile/etc/profile.d&quot; ]; then
  for i in &quot;${HOME}/.nix-profile/etc/profile.d/&quot;*.sh; do
    if [ -r &quot;$i&quot; ]; then
      . &quot;$i&quot;
    fi
  done
fi
</code></pre><p>Now just run <code class="literal">. &quot;${HOME}/.profile&quot;</code> and you can start loading man pages from your environment.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnu-info-setup" class="title" >GNU info setup   </h3>  </div> </div></div><p>Configuring GNU info is a little bit trickier than man pages. To work correctly, info needs a database to be generated. This can be done with some small modifications to our environment scripts.</p><pre><code class="programlisting nix">{
  packageOverrides = pkgs: {
    myProfile = pkgs.writeText &quot;my-profile&quot; &#x27;&#x27;
      export PATH=$HOME/.nix-profile/bin:/nix/var/nix/profiles/default/bin:/sbin:/bin:/usr/sbin:/usr/bin
      export MANPATH=$HOME/.nix-profile/share/man:/nix/var/nix/profiles/default/share/man:/usr/share/man
      export INFOPATH=$HOME/.nix-profile/share/info:/nix/var/nix/profiles/default/share/info:/usr/share/info
    &#x27;&#x27;;
    myPackages = pkgs.buildEnv {
      name = &quot;my-packages&quot;;
      paths = with pkgs; [
        (runCommand &quot;profile&quot; { } &#x27;&#x27;
          mkdir -p $out/etc/profile.d
          cp ${myProfile} $out/etc/profile.d/my-profile.sh
        &#x27;&#x27;)
        aspell
        bc
        coreutils
        ffmpeg
        man
        nix
        emscripten
        jq
        nox
        silver-searcher
        texinfoInteractive
      ];
      pathsToLink = [
        &quot;/share/man&quot;
        &quot;/share/doc&quot;
        &quot;/share/info&quot;
        &quot;/bin&quot;
        &quot;/etc&quot;
      ];
      extraOutputsToInstall = [
        &quot;man&quot;
        &quot;doc&quot;
        &quot;info&quot;
      ];
      postBuild = &#x27;&#x27;
        if [ -x $out/bin/install-info -a -w $out/share/info ]; then
          shopt -s nullglob
          for i in $out/share/info/*.info $out/share/info/*.info.gz; do
              $out/bin/install-info $i $out/share/info/dir
          done
        fi
      &#x27;&#x27;;
    };
  };
}
</code></pre><p><code class="literal">postBuild</code> tells Nixpkgs to run a command after building the environment. In this case, <code class="literal">install-info</code> adds the installed info pages to <code class="literal">dir</code> which is GNU info’s default root node. Note that <code class="literal">texinfoInteractive</code> is added to the environment to give the <code class="literal">install-info</code> command.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-overlays" class="title" >Overlays   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-overlays-install">Installing overlays</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-overlays-definition">Defining overlays</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-overlays-alternatives">Using overlays to configure alternatives</a> </span></dt> </dl></div><p>This chapter describes how to extend and change Nixpkgs using overlays.  Overlays are used to add layers in the fixed-point used by Nixpkgs to compose the set of all packages.</p><p>Nixpkgs can be configured with a list of overlays, which are applied in order. This means that the order of the overlays can be significant if multiple layers override the same package.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-overlays-install" class="title" style="clear: both">Installing overlays   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-overlays-argument">Set overlays in NixOS or Nix expressions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-overlays-lookup">Install overlays via configuration lookup</a> </span></dt> </dl></div><p>The list of overlays can be set either explicitly in a Nix expression, or through <code class="literal">&lt;nixpkgs-overlays&gt;</code> or user configuration files.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-overlays-argument" class="title" >Set overlays in NixOS or Nix expressions   </h3>  </div> </div></div><p>On a NixOS system the value of the <code class="literal">nixpkgs.overlays</code> option, if present, is passed to the system Nixpkgs directly as an argument. Note that this does not affect the overlays for non-NixOS operations (e.g.  <code class="literal">nix-env</code>), which are <a class="link" href="index.html#sec-overlays-lookup" title="Install overlays via configuration lookup" >looked up</a> independently.</p><p>The list of overlays can be passed explicitly when importing nixpkgs, for example <code class="literal">import &lt;nixpkgs&gt; { overlays = [ overlay1 overlay2 ]; }</code>.</p><p>NOTE: DO NOT USE THIS in nixpkgs. Further overlays can be added by calling the <code class="literal">pkgs.extend</code> or <code class="literal">pkgs.appendOverlays</code>, although it is often preferable to avoid these functions, because they recompute the Nixpkgs fixpoint, which is somewhat expensive to do.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-overlays-lookup" class="title" >Install overlays via configuration lookup   </h3>  </div> </div></div><p>The list of overlays is determined as follows.</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>First, if an <a class="link" href="index.html#sec-overlays-argument" title="Set overlays in NixOS or Nix expressions" ><code class="literal">overlays</code> argument</a> to the Nixpkgs function itself is given, then that is used and no path lookup will be performed.</p></li><li class="listitem"><p>Otherwise, if the Nix path entry <code class="literal">&lt;nixpkgs-overlays&gt;</code> exists, we look for overlays at that path, as described below.</p><p>See the <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/env-common.html#env-NIX_PATH"  target="_top">section on <code class="literal">NIX_PATH</code></a> in the Nix manual for more details on how to set a value for <code class="literal">&lt;nixpkgs-overlays&gt;.</code></p></li><li class="listitem"><p>If one of <code class="literal">~/.config/nixpkgs/overlays.nix</code> and <code class="literal">~/.config/nixpkgs/overlays/</code> exists, then we look for overlays at that path, as described below. It is an error if both exist.</p></li></ol></div><p>If we are looking for overlays at a path, then there are two cases:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>If the path is a file, then the file is imported as a Nix expression and used as the list of overlays.</p></li><li class="listitem"><p>If the path is a directory, then we take the content of the directory, order it lexicographically, and attempt to interpret each as an overlay by:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: circle;"><li class="listitem"><p>Importing the file, if it is a <code class="literal">.nix</code> file.</p></li><li class="listitem"><p>Importing a top-level <code class="literal">default.nix</code> file, if it is a directory.</p></li></ul></div></li></ul></div><p>Because overlays that are set in NixOS configuration do not affect non-NixOS operations such as <code class="literal">nix-env</code>, the <code class="literal">overlays.nix</code> option provides a convenient way to use the same overlays for a NixOS system configuration and user configuration: the same file can be used as <code class="literal">overlays.nix</code> and imported as the value of <code class="literal">nixpkgs.overlays</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-overlays-definition" class="title" style="clear: both">Defining overlays   </h2>  </div> </div></div><p>Overlays are Nix functions which accept two arguments, conventionally called <code class="literal">self</code> and <code class="literal">super</code>, and return a set of packages. For example, the following is a valid overlay.</p><pre><code class="programlisting nix">self: super:

{
  boost = super.boost.override { python = self.python3; };
  rr = super.callPackage ./pkgs/rr { stdenv = self.stdenv_32bit; };
}
</code></pre><p>The first argument (<code class="literal">self</code>) corresponds to the final package set. You should use this set for the dependencies of all packages specified in your overlay. For example, all the dependencies of <code class="literal">rr</code> in the example above come from <code class="literal">self</code>, as well as the overridden dependencies used in the <code class="literal">boost</code> override.</p><p>The second argument (<code class="literal">super</code>) corresponds to the result of the evaluation of the previous stages of Nixpkgs. It does not contain any of the packages added by the current overlay, nor any of the following overlays. This set should be used either to refer to packages you wish to override, or to access functions defined in Nixpkgs. For example, the original recipe of <code class="literal">boost</code> in the above example, comes from <code class="literal">super</code>, as well as the <code class="literal">callPackage</code> function.</p><p>The value returned by this function should be a set similar to <code class="literal">pkgs/top-level/all-packages.nix</code>, containing overridden and/or new packages.</p><p>Overlays are similar to other methods for customizing Nixpkgs, in particular the <code class="literal">packageOverrides</code> attribute described in <a class="xref" href="index.html#sec-modify-via-packageOverrides" title="Modify packages via packageOverrides" >the section called “Modify packages via <code class="literal">packageOverrides</code>”</a>. Indeed, <code class="literal">packageOverrides</code> acts as an overlay with only the <code class="literal">super</code> argument. It is therefore appropriate for basic use, but overlays are more powerful and easier to distribute.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-overlays-alternatives" class="title" style="clear: both">Using overlays to configure alternatives   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-overlays-alternatives-blas-lapack">BLAS/LAPACK</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-overlays-alternatives-mpi">Switching the MPI implementation</a> </span></dt> </dl></div><p>Certain software packages have different implementations of the same interface. Other distributions have functionality to switch between these. For example, Debian provides <a class="link" href="https://wiki.debian.org/DebianAlternatives"  target="_top">DebianAlternatives</a>.  Nixpkgs has what we call <code class="literal">alternatives</code>, which are configured through overlays.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-overlays-alternatives-blas-lapack" class="title" >BLAS/LAPACK   </h3>  </div> </div></div><p>In Nixpkgs, we have multiple implementations of the BLAS/LAPACK numerical linear algebra interfaces. They are:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="https://www.openblas.net/"  target="_top">OpenBLAS</a></p><p>The Nixpkgs attribute is <code class="literal">openblas</code> for ILP64 (integer width = 64 bits) and <code class="literal">openblasCompat</code> for LP64 (integer width = 32 bits).  <code class="literal">openblasCompat</code> is the default.</p></li><li class="listitem"><p><a class="link" href="https://www.netlib.org/lapack/"  target="_top">LAPACK reference</a> (also provides BLAS and CBLAS)</p><p>The Nixpkgs attribute is <code class="literal">lapack-reference</code>.</p></li><li class="listitem"><p><a class="link" href="https://software.intel.com/en-us/mkl"  target="_top">Intel MKL</a> (only works on the x86_64 architecture, unfree)</p><p>The Nixpkgs attribute is <code class="literal">mkl</code>.</p></li><li class="listitem"><p><a class="link" href="https://github.com/flame/blis"  target="_top">BLIS</a></p><p>BLIS, available through the attribute <code class="literal">blis</code>, is a framework for linear algebra kernels. In addition, it implements the BLAS interface.</p></li><li class="listitem"><p><a class="link" href="https://developer.amd.com/amd-aocl/blas-library/"  target="_top">AMD BLIS/LIBFLAME</a> (optimized for modern AMD x86_64 CPUs)</p><p>The AMD fork of the BLIS library, with attribute <code class="literal">amd-blis</code>, extends BLIS with optimizations for modern AMD CPUs. The changes are usually submitted to the upstream BLIS project after some time. However, AMD BLIS typically provides some performance improvements on AMD Zen CPUs. The complementary AMD LIBFLAME library, with attribute <code class="literal">amd-libflame</code>, provides a LAPACK implementation.</p></li></ul></div><p>Introduced in <a class="link" href="https://github.com/NixOS/nixpkgs/pull/83888"  target="_top">PR #83888</a>, we are able to override the <code class="literal">blas</code> and <code class="literal">lapack</code> packages to use different implementations, through the <code class="literal">blasProvider</code> and <code class="literal">lapackProvider</code> argument. This can be used to select a different provider. BLAS providers will have symlinks in <code class="literal">$out/lib/libblas.so.3</code> and <code class="literal">$out/lib/libcblas.so.3</code> to their respective BLAS libraries.  Likewise, LAPACK providers will have symlinks in <code class="literal">$out/lib/liblapack.so.3</code> and <code class="literal">$out/lib/liblapacke.so.3</code> to their respective LAPACK libraries. For example, Intel MKL is both a BLAS and LAPACK provider. An overlay can be created to use Intel MKL that looks like:</p><pre><code class="programlisting nix">self: super:

{
  blas = super.blas.override { blasProvider = self.mkl; };

  lapack = super.lapack.override { lapackProvider = self.mkl; };
}
</code></pre><p>This overlay uses Intel’s MKL library for both BLAS and LAPACK interfaces. Note that the same can be accomplished at runtime using <code class="literal">LD_LIBRARY_PATH</code> of <code class="literal">libblas.so.3</code> and <code class="literal">liblapack.so.3</code>. For instance:</p><pre><code class="programlisting ShellSession">$ LD_LIBRARY_PATH=$(nix-build -A mkl)/lib${LD_LIBRARY_PATH:+:}$LD_LIBRARY_PATH nix-shell -p octave --run octave
</code></pre><p>Intel MKL requires an <code class="literal">openmp</code> implementation when running with multiple processors. By default, <code class="literal">mkl</code> will use Intel’s <code class="literal">iomp</code> implementation if no other is specified, but this is a runtime-only dependency and binary compatible with the LLVM implementation. To use that one instead, Intel recommends users set it with <code class="literal">LD_PRELOAD</code>. Note that <code class="literal">mkl</code> is only available on <code class="literal">x86_64-linux</code> and <code class="literal">x86_64-darwin</code>. Moreover, Hydra is not building and distributing pre-compiled binaries using it.</p><p>To override <code class="literal">blas</code> and <code class="literal">lapack</code> with its reference implementations (i.e. for development purposes), one can use the following overlay:</p><pre><code class="programlisting nix">self: super:

{
  blas = super.blas.override { blasProvider = self.lapack-reference; };

  lapack = super.lapack.override { lapackProvider = self.lapack-reference; };
}
</code></pre><p>For BLAS/LAPACK switching to work correctly, all packages must depend on <code class="literal">blas</code> or <code class="literal">lapack</code>. This ensures that only one BLAS/LAPACK library is used at one time. There are two versions of BLAS/LAPACK currently in the wild, <code class="literal">LP64</code> (integer size = 32 bits) and <code class="literal">ILP64</code> (integer size = 64 bits). The attributes <code class="literal">blas</code> and <code class="literal">lapack</code> are <code class="literal">LP64</code> by default. Their <code class="literal">ILP64</code> version are provided through the attributes <code class="literal">blas-ilp64</code> and <code class="literal">lapack-ilp64</code>. Some software needs special flags or patches to work with <code class="literal">ILP64</code>. You can check if <code class="literal">ILP64</code> is used in Nixpkgs with <code class="literal">blas.isILP64</code> and <code class="literal">lapack.isILP64</code>. Some software does NOT work with <code class="literal">ILP64</code>, and derivations need to specify an assertion to prevent this. You can prevent <code class="literal">ILP64</code> from being used with the following:</p><pre><code class="programlisting nix">{
  stdenv,
  blas,
  lapack,
  ...
}:

assert (!blas.isILP64) &amp;&amp; (!lapack.isILP64);

stdenv.mkDerivation {
  # ...
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-overlays-alternatives-mpi" class="title" >Switching the MPI implementation   </h3>  </div> </div></div><p>All programs that are built with <a class="link" href="https://en.wikipedia.org/wiki/Message_Passing_Interface"  target="_top">MPI</a> support use the generic attribute <code class="literal">mpi</code> as an input. At the moment Nixpkgs natively provides two different MPI implementations:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="https://www.open-mpi.org/"  target="_top">Open MPI</a> (default), attribute name
<code class="literal">openmpi</code></p></li><li class="listitem"><p><a class="link" href="https://www.mpich.org/"  target="_top">MPICH</a>, attribute name <code class="literal">mpich</code></p></li><li class="listitem"><p><a class="link" href="https://mvapich.cse.ohio-state.edu/"  target="_top">MVAPICH</a>, attribute name <code class="literal">mvapich</code></p></li></ul></div><p>To provide MPI enabled applications that use <code class="literal">MPICH</code>, instead of the default <code class="literal">Open MPI</code>, use the following overlay:</p><pre><code class="programlisting nix">self: super:

{
  mpi = self.mpich;
}
</code></pre>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-overrides" class="title" >Overriding   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-pkg-override">&lt;pkg&gt;.override</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkg-overrideAttrs">&lt;pkg&gt;.overrideAttrs</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkg-overrideDerivation">&lt;pkg&gt;.overrideDerivation</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-lib-makeOverridable">lib.makeOverridable</a> </span></dt> </dl></div><p>Sometimes one wants to override parts of <code class="literal">nixpkgs</code>, e.g. derivation attributes, the results of derivations.</p><p>These functions are used to make changes to packages, returning only single packages. <a class="link" href="index.html#chap-overlays" title="Overlays" >Overlays</a>, on the other hand, can be used to combine the overridden packages across the entire package set of Nixpkgs.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkg-override" class="title" style="clear: both">&lt;pkg&gt;.override   </h2>  </div> </div></div><p>The function <code class="literal">override</code> is usually available for all the derivations in the nixpkgs expression (<code class="literal">pkgs</code>).</p><p>It is used to override the arguments passed to a function.</p><p>Example usages:</p><pre><code class="programlisting nix">pkgs.foo.override {
  arg1 = val1;
  arg2 = val2; # ...
}
</code></pre><p>It’s also possible to access the previous arguments.</p><pre><code class="programlisting nix">pkgs.foo.override (previous: {
  arg1 = previous.arg1; # ...
})
</code></pre><pre><code class="programlisting nix">import pkgs.path {
  overlays = [ (self: super: { foo = super.foo.override { barSupport = true; }; }) ];
}
</code></pre><pre><code class="programlisting nix">{
  mypkg = pkgs.callPackage ./mypkg.nix {
    mydep = pkgs.mydep.override {
      # ...
    };
  };
}
</code></pre><p>In the first example, <code class="literal">pkgs.foo</code> is the result of a function call with some default arguments, usually a derivation. Using <code class="literal">pkgs.foo.override</code> will call the same function with the given new arguments.</p><p>Many packages, like the <code class="literal">foo</code> example above, provide package options with default values in their arguments, to facilitate overriding.
Because it’s not usually feasible to test that packages build with all combinations of options, you might find that a package doesn’t build if you override options to non-default values.</p><p>Package maintainers are not expected to fix arbitrary combinations of options.
If you find that something doesn’t work, please submit a fix, ideally with a regression test.
If you want to ensure that things keep working, consider <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/maintainers"  target="_top">becoming a maintainer</a> for the package.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkg-overrideAttrs" class="title" style="clear: both">&lt;pkg&gt;.overrideAttrs   </h2>  </div> </div></div><p>The function <code class="literal">overrideAttrs</code> allows overriding the attribute set passed to a <code class="literal">stdenv.mkDerivation</code> call, producing a new derivation based on the original one. This function is available on all derivations produced by the <code class="literal">stdenv.mkDerivation</code> function, which is most packages in the nixpkgs expression <code class="literal">pkgs</code>.</p><p>Example usages:</p><pre><code class="programlisting nix">{
  helloBar = pkgs.hello.overrideAttrs (
    finalAttrs: previousAttrs: { pname = previousAttrs.pname + &quot;-bar&quot;; }
  );
}
</code></pre><p>In the above example, “-bar” is appended to the pname attribute, while all other attributes will be retained from the original <code class="literal">hello</code> package.</p><p>The argument <code class="literal">previousAttrs</code> is conventionally used to refer to the attr set originally passed to <code class="literal">stdenv.mkDerivation</code>.</p><p>The argument <code class="literal">finalAttrs</code> refers to the final attributes passed to <code class="literal">mkDerivation</code>, plus the <code class="literal">finalPackage</code> attribute which is equal to the result of <code class="literal">mkDerivation</code> or subsequent <code class="literal">overrideAttrs</code> calls.</p><p>If only a one-argument function is written, the argument has the meaning of <code class="literal">previousAttrs</code>.</p><p>Function arguments can be omitted entirely if there is no need to access <code class="literal">previousAttrs</code> or <code class="literal">finalAttrs</code>.</p><pre><code class="programlisting nix">{ helloWithDebug = pkgs.hello.overrideAttrs { separateDebugInfo = true; }; }
</code></pre><p>In the above example, the <code class="literal">separateDebugInfo</code> attribute is overridden to be true, thus building debug info for <code class="literal">helloWithDebug</code>.</p><div class="note"><h3 class="title">Note</h3><p>Note that <code class="literal">separateDebugInfo</code> is processed only by the <code class="literal">stdenv.mkDerivation</code> function, not the generated, raw Nix derivation. Thus, using <code class="literal">overrideDerivation</code> will not work in this case, as it overrides only the attributes of the final derivation. It is for this reason that <code class="literal">overrideAttrs</code> should be preferred in (almost) all cases to <code class="literal">overrideDerivation</code>, i.e. to allow using <code class="literal">stdenv.mkDerivation</code> to process input arguments, as well as the fact that it is easier to use (you can use the same attribute names you see in your Nix code, instead of the ones generated (e.g. <code class="literal">buildInputs</code> vs <code class="literal">nativeBuildInputs</code>), and it involves less typing).</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkg-overrideDerivation" class="title" style="clear: both">&lt;pkg&gt;.overrideDerivation   </h2>  </div> </div></div><div class="warning"><h3 class="title">Warning</h3><p>You should prefer <code class="literal">overrideAttrs</code> in almost all cases, see its documentation for the reasons why. <code class="literal">overrideDerivation</code> is not deprecated and will continue to work, but is less nice to use and does not have as many abilities as <code class="literal">overrideAttrs</code>.</p></div><div class="warning"><h3 class="title">Warning</h3><p>Do not use this function in Nixpkgs as it evaluates a derivation before modifying it, which breaks package abstraction. In addition, this evaluation-per-function application incurs a performance penalty, which can become a problem if many overrides are used. It is only intended for ad-hoc customisation, such as in <code class="literal">~/.config/nixpkgs/config.nix</code>.</p></div><p>The function <code class="literal">overrideDerivation</code> creates a new derivation based on an existing one by overriding the original’s attributes with the attribute set produced by the specified function. This function is available on all derivations defined using the <code class="literal">makeOverridable</code> function. Most standard derivation-producing functions, such as <code class="literal">stdenv.mkDerivation</code>, are defined using this function, which means most packages in the nixpkgs expression, <code class="literal">pkgs</code>, have this function.</p><p>Example usage:</p><pre><code class="programlisting nix">{
  mySed = pkgs.gnused.overrideDerivation (oldAttrs: {
    name = &quot;sed-4.2.2-pre&quot;;
    src = fetchurl {
      url = &quot;ftp://alpha.gnu.org/gnu/sed/sed-4.2.2-pre.tar.bz2&quot;;
      hash = &quot;sha256-MxBJRcM2rYzQYwJ5XKxhXTQByvSg5jZc5cSHEZoB2IY=&quot;;
    };
    patches = [ ];
  });
}
</code></pre><p>In the above example, the <code class="literal">name</code>, <code class="literal">src</code>, and <code class="literal">patches</code> of the derivation will be overridden, while all other attributes will be retained from the original derivation.</p><p>The argument <code class="literal">oldAttrs</code> is used to refer to the attribute set of the original derivation.</p><div class="note"><h3 class="title">Note</h3><p>A package’s attributes are evaluated <span class="emphasis"><em>before</em></span> being modified by the <code class="literal">overrideDerivation</code> function. For example, the <code class="literal">name</code> attribute reference in <code class="literal">url = &quot;mirror://gnu/hello/${name}.tar.gz&quot;;</code> is filled-in <span class="emphasis"><em>before</em></span> the <code class="literal">overrideDerivation</code> function modifies the attribute set. This means that overriding the <code class="literal">name</code> attribute, in this example, <span class="emphasis"><em>will not</em></span> change the value of the <code class="literal">url</code> attribute. Instead, we need to override both the <code class="literal">name</code> <span class="emphasis"><em>and</em></span> <code class="literal">url</code> attributes.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-lib-makeOverridable" class="title" style="clear: both">lib.makeOverridable   </h2>  </div> </div></div><p>The function <code class="literal">lib.makeOverridable</code> is used to make the result of a function easily customizable. This utility only makes sense for functions that accept an argument set and return an attribute set.</p><p>Example usage:</p><pre><code class="programlisting nix">{
  f =
    { a, b }:
    {
      result = a + b;
    };
  c = lib.makeOverridable f {
    a = 1;
    b = 2;
  };
}
</code></pre><p>The variable <code class="literal">c</code> is the value of the <code class="literal">f</code> function applied with some default arguments. Hence the value of <code class="literal">c.result</code> is <code class="literal">3</code>, in this example.</p><p>The variable <code class="literal">c</code> however also has some additional functions, like
<a class="link" href="index.html#sec-pkg-override" title="&lt;pkg&gt;.override" >c.override</a> which can be used to override the
default arguments. In this example the value of
<code class="literal">(c.override { a = 4; }).result</code> is 6.</p>
</div>

</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="id-1.4" class="title" >Nixpkgs <code class="literal">lib</code>   </h1>  </div> </div></div><div class="partintro"><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#chap-functions">Functions reference</a> </span></dt><dt> <span class="chapter">  <a href="index.html#module-system">Module System</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-functions" class="title" >Functions reference   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-functions-library">Nixpkgs Library Functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-generators">Generators</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-debug">Debugging Nix Expressions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-prefer-remote-fetch">prefer-remote-fetch overlay</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-nix-gitignore">pkgs.nix-gitignore</a> </span></dt> </dl></div><p>The nixpkgs repository has several utility functions to manipulate Nix expressions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-functions-library" class="title" style="clear: both">Nixpkgs Library Functions   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-functions-library-asserts">lib.asserts: assertion functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-attrsets">lib.attrsets: attribute set functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-strings">lib.strings: string manipulation functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-versions">lib.versions: version string functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-trivial">lib.trivial: miscellaneous functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-fixedPoints">lib.fixedPoints: explicit recursion functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-lists">lib.lists: list manipulation functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-debug">lib.debug: debugging functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-options">lib.options: NixOS / nixpkgs option handling</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-path">lib.path: path functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-fetchers">lib.fetchers: functions which can be reused across fetchers</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-filesystem">lib.filesystem: filesystem functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-fileset">lib.fileset: file set functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-sources">lib.sources: source filtering functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-cli">lib.cli: command-line serialization functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-generators">lib.generators: functions that create file formats from nix data structures</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-gvariant">lib.gvariant: GVariant formatted string serialization functions</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-customisation">lib.customisation: Functions to customise (derivation-related) functions, derivations, or attribute sets</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-meta">lib.meta: functions for derivation metadata</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-functions-library-derivations">lib.derivations: miscellaneous derivation-specific functions</a> </span></dt> </dl></div><p>Nixpkgs provides a standard library at <code class="literal">pkgs.lib</code>, or through <code class="literal">import &lt;nixpkgs/lib&gt;</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-asserts" class="title" >lib.asserts: assertion functions   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.asserts.assertMsg" class="title" ><code class="literal">lib.asserts.assertMsg</code>   </h4>  </div> </div></div><p>Throw if pred is false, else return pred.
Intended to be used to augment asserts with helpful error messages.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate that needs to succeed, otherwise <code class="literal">msg</code> is thrown</p></dd><dt><span class="term"><code class="literal">msg</code></span></dt><dd><p>Message to throw in case <code class="literal">pred</code> fails</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.1.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">assertMsg :: Bool -&gt; String -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.1.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 1. <code class="literal">lib.asserts.assertMsg</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">assertMsg false &quot;nope&quot;
stderr&gt; error: nope
assert assertMsg (&quot;foo&quot; == &quot;bar&quot;) &quot;foo is not bar, silly&quot;; &quot;&quot;
stderr&gt; error: foo is not bar, silly
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/asserts.nix#L50"  target="_top">lib/asserts.nix:50</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.asserts.assertOneOf" class="title" ><code class="literal">lib.asserts.assertOneOf</code>   </h4>  </div> </div></div><p>Specialized <code class="literal">assertMsg</code> for checking if <code class="literal">val</code> is one of the elements
of the list <code class="literal">xs</code>. Useful for checking enums.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>The name of the variable the user entered <code class="literal">val</code> into, for inclusion in the error message</p></dd><dt><span class="term"><code class="literal">val</code></span></dt><dd><p>The value of what the user provided, to be compared against the values in <code class="literal">xs</code></p></dd><dt><span class="term"><code class="literal">xs</code></span></dt><dd><p>The list of valid values</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">assertOneOf :: String -&gt; ComparableVal -&gt; List ComparableVal -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.2.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 2. <code class="literal">lib.asserts.assertOneOf</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">let sslLibrary = &quot;libressl&quot;;
in assertOneOf &quot;sslLibrary&quot; sslLibrary [ &quot;openssl&quot; &quot;bearssl&quot; ]
stderr&gt; error: sslLibrary must be one of [
stderr&gt;   &quot;openssl&quot;
stderr&gt;   &quot;bearssl&quot;
stderr&gt; ], but is: &quot;libressl&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/asserts.nix#L91"  target="_top">lib/asserts.nix:91</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.asserts.assertEachOneOf" class="title" ><code class="literal">lib.asserts.assertEachOneOf</code>   </h4>  </div> </div></div><p>Specialized <code class="literal">assertMsg</code> for checking if every one of <code class="literal">vals</code> is one of the elements
of the list <code class="literal">xs</code>. Useful for checking lists of supported attributes.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>The name of the variable the user entered <code class="literal">val</code> into, for inclusion in the error message</p></dd><dt><span class="term"><code class="literal">vals</code></span></dt><dd><p>The list of values of what the user provided, to be compared against the values in <code class="literal">xs</code></p></dd><dt><span class="term"><code class="literal">xs</code></span></dt><dd><p>The list of valid values</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">assertEachOneOf :: String -&gt; List ComparableVal -&gt; List ComparableVal -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.3.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 3. <code class="literal">lib.asserts.assertEachOneOf</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">let sslLibraries = [ &quot;libressl&quot; &quot;bearssl&quot; ];
in assertEachOneOf &quot;sslLibraries&quot; sslLibraries [ &quot;openssl&quot; &quot;bearssl&quot; ]
stderr&gt; error: each element in sslLibraries must be one of [
stderr&gt;   &quot;openssl&quot;
stderr&gt;   &quot;bearssl&quot;
stderr&gt; ], but is: [
stderr&gt;   &quot;libressl&quot;
stderr&gt;   &quot;bearssl&quot;
stderr&gt; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/asserts.nix#L139"  target="_top">lib/asserts.nix:139</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.asserts.checkAssertWarn" class="title" ><code class="literal">lib.asserts.checkAssertWarn</code>   </h4>  </div> </div></div><p>Wrap a value with logic that throws an error when assertions
fail and emits any warnings.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">assertions</code></span></dt><dd><p>A list of assertions. If any of their <code class="literal">assertion</code> attrs is <code class="literal">false</code>, their <code class="literal">message</code> attrs will be emitted in a <code class="literal">throw</code>.</p></dd><dt><span class="term"><code class="literal">warnings</code></span></dt><dd><p>A list of strings to emit as warnings. This function does no filtering on this list.</p></dd><dt><span class="term"><code class="literal">val</code></span></dt><dd><p>A value to return, wrapped in <code class="literal">warn</code>, if a <code class="literal">throw</code> is not necessary.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">checkAssertWarn :: [ { assertion :: Bool; message :: String } ] -&gt; [ String ] -&gt; Any -&gt; Any
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-6-1.4.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 4. <code class="literal">lib.asserts.checkAssertWarn</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">checkAssertWarn
  [ { assertion = false; message = &quot;Will fail&quot;; } ]
  [ ]
  null
stderr&gt;        error:
stderr&gt;        Failed assertions:
stderr&gt;        - Will fail

checkAssertWarn
  [ { assertion = true; message = &quot;Will not fail&quot;; } ]
  [ &quot;Will warn&quot; ]
  null
stderr&gt; evaluation warning: Will warn
null
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/asserts.nix#L192"  target="_top">lib/asserts.nix:192</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-attrsets" class="title" >lib.attrsets: attribute set functions   </h3>  </div> </div></div><p>Operations on attribute sets.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.attrByPath" class="title" ><code class="literal">lib.attrsets.attrByPath</code>   </h4>  </div> </div></div><p>Return an attribute from nested attribute sets.</p><p>Nix has an <a class="link" href="https://nixos.org/manual/nix/stable/language/operators#attribute-selection"  target="_top">attribute selection operator <code class="literal">.</code></a> which is sufficient for such queries, as long as the number of attributes is static. For example:</p><pre><code class="programlisting nix">(x.a.b or 6) == attrByPath [&quot;a&quot; &quot;b&quot;] 6 x
# and
(x.${f p}.&quot;example.com&quot; or 6) == attrByPath [ (f p) &quot;example.com&quot; ] 6 x
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">attrPath</code></span></dt><dd><p>A list of strings representing the attribute path to return from <code class="literal">set</code></p></dd><dt><span class="term"><code class="literal">default</code></span></dt><dd><p>Default value if <code class="literal">attrPath</code> does not resolve to an existing value</p></dd><dt><span class="term"><code class="literal">set</code></span></dt><dd><p>The nested attribute set to select values from</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.1.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">attrByPath :: [String] -&gt; Any -&gt; AttrSet -&gt; Any
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.1.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 5. <code class="literal">lib.attrsets.attrByPath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">x = { a = { b = 3; }; }
# [&quot;a&quot; &quot;b&quot;] is equivalent to x.a.b
# 6 is a default value to return if the path does not exist in attrset
attrByPath [&quot;a&quot; &quot;b&quot;] 6 x
=&gt; 3
attrByPath [&quot;z&quot; &quot;z&quot;] 6 x
=&gt; 6
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L92"  target="_top">lib/attrsets.nix:92</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.hasAttrByPath" class="title" ><code class="literal">lib.attrsets.hasAttrByPath</code>   </h4>  </div> </div></div><p>Return if an attribute from nested attribute set exists.</p><p>Nix has a <a class="link" href="https://nixos.org/manual/nix/stable/language/operators#has-attribute"  target="_top">has attribute operator <code class="literal">?</code></a>, which is sufficient for such queries, as long as the number of attributes is static. For example:</p><pre><code class="programlisting nix">(x?a.b) == hasAttrByPath [&quot;a&quot; &quot;b&quot;] x
# and
(x?${f p}.&quot;example.com&quot;) == hasAttrByPath [ (f p) &quot;example.com&quot; ] x
</code></pre><p><span class="strong"><strong>Laws</strong></span>:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><pre><code class="programlisting nix">hasAttrByPath [] x == true
</code></pre></li></ol></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">attrPath</code></span></dt><dd><p>A list of strings representing the attribute path to check from <code class="literal">set</code></p></dd><dt><span class="term"><code class="literal">e</code></span></dt><dd><p>The nested attribute set to check</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">hasAttrByPath :: [String] -&gt; AttrSet -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.2.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 6. <code class="literal">lib.attrsets.hasAttrByPath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">x = { a = { b = 3; }; }
hasAttrByPath [&quot;a&quot; &quot;b&quot;] x
=&gt; true
hasAttrByPath [&quot;z&quot; &quot;z&quot;] x
=&gt; false
hasAttrByPath [] (throw &quot;no need&quot;)
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L160"  target="_top">lib/attrsets.nix:160</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.longestValidPathPrefix" class="title" ><code class="literal">lib.attrsets.longestValidPathPrefix</code>   </h4>  </div> </div></div><p>Return the longest prefix of an attribute path that refers to an existing attribute in a nesting of attribute sets.</p><p>Can be used after <a class="link" href="index.html#function-library-lib.attrsets.mapAttrsRecursiveCond" title="lib.attrsets.mapAttrsRecursiveCond" ><code class="literal">mapAttrsRecursiveCond</code></a> to apply a condition,
although this will evaluate the predicate function on sibling attributes as well.</p><p>Note that the empty attribute path is valid for all values, so this function only throws an exception if any of its inputs does.</p><p><span class="strong"><strong>Laws</strong></span>:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><pre><code class="programlisting nix">attrsets.longestValidPathPrefix [] x == []
</code></pre></li><li class="listitem"><pre><code class="programlisting nix">hasAttrByPath (attrsets.longestValidPathPrefix p x) x == true
</code></pre></li></ol></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">attrPath</code></span></dt><dd><p>A list of strings representing the longest possible path that may be returned.</p></dd><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>The nested attribute set to check.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">attrsets.longestValidPathPrefix :: [String] -&gt; Value -&gt; [String]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.3.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 7. <code class="literal">lib.attrsets.longestValidPathPrefix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">x = { a = { b = 3; }; }
attrsets.longestValidPathPrefix [&quot;a&quot; &quot;b&quot; &quot;c&quot;] x
=&gt; [&quot;a&quot; &quot;b&quot;]
attrsets.longestValidPathPrefix [&quot;a&quot;] x
=&gt; [&quot;a&quot;]
attrsets.longestValidPathPrefix [&quot;z&quot; &quot;z&quot;] x
=&gt; []
attrsets.longestValidPathPrefix [&quot;z&quot; &quot;z&quot;] (throw &quot;no need&quot;)
=&gt; []
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L229"  target="_top">lib/attrsets.nix:229</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.setAttrByPath" class="title" ><code class="literal">lib.attrsets.setAttrByPath</code>   </h4>  </div> </div></div><p>Create a new attribute set with <code class="literal">value</code> set at the nested attribute location specified in <code class="literal">attrPath</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">attrPath</code></span></dt><dd><p>A list of strings representing the attribute path to set</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>The value to set at the location described by <code class="literal">attrPath</code></p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">setAttrByPath :: [String] -&gt; Any -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.4.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 8. <code class="literal">lib.attrsets.setAttrByPath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">setAttrByPath [&quot;a&quot; &quot;b&quot;] 3
=&gt; { a = { b = 3; }; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L289"  target="_top">lib/attrsets.nix:289</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.getAttrFromPath" class="title" ><code class="literal">lib.attrsets.getAttrFromPath</code>   </h4>  </div> </div></div><p>Like <code class="literal">attrByPath</code>, but without a default value. If it doesn’t find the
path it will throw an error.</p><p>Nix has an <a class="link" href="https://nixos.org/manual/nix/stable/language/operators#attribute-selection"  target="_top">attribute selection operator</a> which is sufficient for such queries, as long as the number of attributes is static. For example:</p><pre><code class="programlisting nix">x.a.b == getAttrFromPath [&quot;a&quot; &quot;b&quot;] x
# and
x.${f p}.&quot;example.com&quot; == getAttrFromPath [ (f p) &quot;example.com&quot; ] x
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">attrPath</code></span></dt><dd><p>A list of strings representing the attribute path to get from <code class="literal">set</code></p></dd><dt><span class="term"><code class="literal">set</code></span></dt><dd><p>The nested attribute set to find the value in.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.5.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getAttrFromPath :: [String] -&gt; AttrSet -&gt; Any
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.5.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 9. <code class="literal">lib.attrsets.getAttrFromPath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">x = { a = { b = 3; }; }
getAttrFromPath [&quot;a&quot; &quot;b&quot;] x
=&gt; 3
getAttrFromPath [&quot;z&quot; &quot;z&quot;] x
=&gt; error: cannot find attribute `z.z&#x27;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L339"  target="_top">lib/attrsets.nix:339</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.concatMapAttrs" class="title" ><code class="literal">lib.attrsets.concatMapAttrs</code>   </h4>  </div> </div></div><p>Map each attribute in the given set and merge them into a new attribute set.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.6.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">concatMapAttrs :: (String -&gt; a -&gt; AttrSet) -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.6.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 10. <code class="literal">lib.attrsets.concatMapAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concatMapAttrs
  (name: value: {
    ${name} = value;
    ${name + value} = value;
  })
  { x = &quot;a&quot;; y = &quot;b&quot;; }
=&gt; { x = &quot;a&quot;; xa = &quot;a&quot;; y = &quot;b&quot;; yb = &quot;b&quot;; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L378"  target="_top">lib/attrsets.nix:378</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.updateManyAttrsByPath" class="title" ><code class="literal">lib.attrsets.updateManyAttrsByPath</code>   </h4>  </div> </div></div><p>Update or set specific paths of an attribute set.</p><p>Takes a list of updates to apply and an attribute set to apply them to,
and returns the attribute set with the updates applied. Updates are
represented as <code class="literal">{ path = ...; update = ...; }</code> values, where <code class="literal">path</code> is a
list of strings representing the attribute path that should be updated,
and <code class="literal">update</code> is a function that takes the old value at that attribute path
as an argument and returns the new
value it should be.</p><p>Properties:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Updates to deeper attribute paths are applied before updates to more
shallow attribute paths</p></li><li class="listitem"><p>Multiple updates to the same attribute path are applied in the order
they appear in the update list</p></li><li class="listitem"><p>If any but the last <code class="literal">path</code> element leads into a value that is not an
attribute set, an error is thrown</p></li><li class="listitem"><p>If there is an update for an attribute path that doesn’t exist,
accessing the argument in the update function causes an error, but
intermediate attribute sets are implicitly created as needed</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.7.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">updateManyAttrsByPath :: [{ path :: [String]; update :: (Any -&gt; Any); }] -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.7.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 11. <code class="literal">lib.attrsets.updateManyAttrsByPath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">updateManyAttrsByPath [
  {
    path = [ &quot;a&quot; &quot;b&quot; ];
    update = old: { d = old.c; };
  }
  {
    path = [ &quot;a&quot; &quot;b&quot; &quot;c&quot; ];
    update = old: old + 1;
  }
  {
    path = [ &quot;x&quot; &quot;y&quot; ];
    update = old: &quot;xy&quot;;
  }
] { a.b.c = 0; }
=&gt; { a = { b = { d = 1; }; }; x = { y = &quot;xy&quot;; }; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L436"  target="_top">lib/attrsets.nix:436</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.attrVals" class="title" ><code class="literal">lib.attrsets.attrVals</code>   </h4>  </div> </div></div><p>Return the specified attributes from a set.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.8.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">nameList</code></span></dt><dd><p>The list of attributes to fetch from <code class="literal">set</code>. Each attribute name must exist on the attrbitue set</p></dd><dt><span class="term"><code class="literal">set</code></span></dt><dd><p>The set to get attribute values from</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.8.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">attrVals :: [String] -&gt; AttrSet -&gt; [Any]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.8.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 12. <code class="literal">lib.attrsets.attrVals</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">attrVals [&quot;a&quot; &quot;b&quot; &quot;c&quot;] as
=&gt; [as.a as.b as.c]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L535"  target="_top">lib/attrsets.nix:535</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.attrValues" class="title" ><code class="literal">lib.attrsets.attrValues</code>   </h4>  </div> </div></div><p>Return the values of all attributes in the given set, sorted by
attribute name.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.9.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">attrValues :: AttrSet -&gt; [Any]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.9.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 13. <code class="literal">lib.attrsets.attrValues</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">attrValues {c = 3; a = 1; b = 2;}
=&gt; [1 2 3]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L558"  target="_top">lib/attrsets.nix:558</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.getAttrs" class="title" ><code class="literal">lib.attrsets.getAttrs</code>   </h4>  </div> </div></div><p>Given a set of attribute names, return the set of the corresponding
attributes from the given set.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.10.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">names</code></span></dt><dd><p>A list of attribute names to get out of <code class="literal">set</code></p></dd><dt><span class="term"><code class="literal">attrs</code></span></dt><dd><p>The set to get the named attributes from</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.10.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getAttrs :: [String] -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.10.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 14. <code class="literal">lib.attrsets.getAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">getAttrs [ &quot;a&quot; &quot;b&quot; ] { a = 1; b = 2; c = 3; }
=&gt; { a = 1; b = 2; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L591"  target="_top">lib/attrsets.nix:591</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.catAttrs" class="title" ><code class="literal">lib.attrsets.catAttrs</code>   </h4>  </div> </div></div><p>Collect each attribute named <code class="literal">attr</code> from a list of attribute
sets.  Sets that don’t contain the named attribute are ignored.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.11.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">attr</code></span></dt><dd><p>The attribute name to get out of the sets.</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>The list of attribute sets to go through</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.11.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">catAttrs :: String -&gt; [AttrSet] -&gt; [Any]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.11.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 15. <code class="literal">lib.attrsets.catAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">catAttrs &quot;a&quot; [{a = 1;} {b = 0;} {a = 2;}]
=&gt; [1 2]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L624"  target="_top">lib/attrsets.nix:624</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.filterAttrs" class="title" ><code class="literal">lib.attrsets.filterAttrs</code>   </h4>  </div> </div></div><p>Filter an attribute set by removing all attributes for which the
given predicate return false.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.12.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate taking an attribute name and an attribute value, which returns <code class="literal">true</code> to include the attribute, or <code class="literal">false</code> to exclude the attribute.</p></dd><dt><span class="term"><code class="literal">set</code></span></dt><dd><p>The attribute set to filter</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.12.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">filterAttrs :: (String -&gt; Any -&gt; Bool) -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.12.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 16. <code class="literal">lib.attrsets.filterAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">filterAttrs (n: v: n == &quot;foo&quot;) { foo = 1; bar = 2; }
=&gt; { foo = 1; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L657"  target="_top">lib/attrsets.nix:657</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.filterAttrsRecursive" class="title" ><code class="literal">lib.attrsets.filterAttrsRecursive</code>   </h4>  </div> </div></div><p>Filter an attribute set recursively by removing all attributes for
which the given predicate return false.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.13.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate taking an attribute name and an attribute value, which returns <code class="literal">true</code> to include the attribute, or <code class="literal">false</code> to exclude the attribute.</p></dd><dt><span class="term"><code class="literal">set</code></span></dt><dd><p>The attribute set to filter</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.13.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">filterAttrsRecursive :: (String -&gt; Any -&gt; Bool) -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.13.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 17. <code class="literal">lib.attrsets.filterAttrsRecursive</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">filterAttrsRecursive (n: v: v != null) { foo = { bar = null; }; }
=&gt; { foo = {}; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L690"  target="_top">lib/attrsets.nix:690</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.foldlAttrs" class="title" ><code class="literal">lib.attrsets.foldlAttrs</code>   </h4>  </div> </div></div><p>Like <a class="link" href="index.html#function-library-lib.lists.foldl-prime" title="lib.lists.foldl&#x27;" ><code class="literal">lib.lists.foldl&#x27;</code></a> but for attribute sets.
Iterates over every name-value pair in the given attribute set.
The result of the callback function is often called <code class="literal">acc</code> for accumulator. It is passed between callbacks from left to right and the final <code class="literal">acc</code> is the return value of <code class="literal">foldlAttrs</code>.</p><p>Attention:</p><p>There is a completely different function <code class="literal">lib.foldAttrs</code>
which has nothing to do with this function, despite the similar name.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.14.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">init</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">set</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.14.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">foldlAttrs :: ( a -&gt; String -&gt; b -&gt; a ) -&gt; a -&gt; { ... :: b } -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.14.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 18. <code class="literal">lib.attrsets.foldlAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">foldlAttrs
  (acc: name: value: {
    sum = acc.sum + value;
    names = acc.names ++ [name];
  })
  { sum = 0; names = []; }
  {
    foo = 1;
    bar = 10;
  }
-&gt;
  {
    sum = 11;
    names = [&quot;bar&quot; &quot;foo&quot;];
  }

foldlAttrs
  (throw &quot;function not needed&quot;)
  123
  {};
-&gt;
  123

foldlAttrs
  (acc: _: _: acc)
  3
  { z = throw &quot;value not needed&quot;; a = throw &quot;value not needed&quot;; };
-&gt;
  3

The accumulator doesn&#x27;t have to be an attrset.
It can be as simple as a number or string.

foldlAttrs
  (acc: _: v: acc * 10 + v)
  1
  { z = 1; a = 2; };
-&gt;
  121
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L785"  target="_top">lib/attrsets.nix:785</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.foldAttrs" class="title" ><code class="literal">lib.attrsets.foldAttrs</code>   </h4>  </div> </div></div><p>Apply fold functions to values grouped by key.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.15.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">op</code></span></dt><dd><p>A function, given a value and a collector combines the two.</p></dd><dt><span class="term"><code class="literal">nul</code></span></dt><dd><p>The starting value.</p></dd><dt><span class="term"><code class="literal">list_of_attrs</code></span></dt><dd><p>A list of attribute sets to fold together by key.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.15.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">foldAttrs :: (Any -&gt; Any -&gt; Any) -&gt; Any -&gt; [AttrSets] -&gt; Any
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.15.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 19. <code class="literal">lib.attrsets.foldAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">foldAttrs (item: acc: [item] ++ acc) [] [{ a = 2; } { a = 3; }]
=&gt; { a = [ 2 3 ]; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L823"  target="_top">lib/attrsets.nix:823</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.collect" class="title" ><code class="literal">lib.attrsets.collect</code>   </h4>  </div> </div></div><p>Recursively collect sets that verify a given predicate named <code class="literal">pred</code>
from the set <code class="literal">attrs</code>. The recursion is stopped when the predicate is
verified.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.16.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Given an attribute’s value, determine if recursion should stop.</p></dd><dt><span class="term"><code class="literal">attrs</code></span></dt><dd><p>The attribute set to recursively collect.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.16.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">collect :: (AttrSet -&gt; Bool) -&gt; AttrSet -&gt; [x]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.16.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 20. <code class="literal">lib.attrsets.collect</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">collect isList { a = { b = [&quot;b&quot;]; }; c = [1]; }
=&gt; [[&quot;b&quot;] [1]]

collect (x: x ? outPath)
   { a = { outPath = &quot;a/&quot;; }; b = { outPath = &quot;b/&quot;; }; }
=&gt; [{ outPath = &quot;a/&quot;; } { outPath = &quot;b/&quot;; }]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L865"  target="_top">lib/attrsets.nix:865</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.cartesianProduct" class="title" ><code class="literal">lib.attrsets.cartesianProduct</code>   </h4>  </div> </div></div><p>Return the cartesian product of attribute set value combinations.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.17.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">attrsOfLists</code></span></dt><dd><p>Attribute set with attributes that are lists of values</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.17.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">cartesianProduct :: AttrSet -&gt; [AttrSet]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.17.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 21. <code class="literal">lib.attrsets.cartesianProduct</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">cartesianProduct { a = [ 1 2 ]; b = [ 10 20 ]; }
=&gt; [
     { a = 1; b = 10; }
     { a = 1; b = 20; }
     { a = 2; b = 10; }
     { a = 2; b = 20; }
   ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L905"  target="_top">lib/attrsets.nix:905</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.mapCartesianProduct" class="title" ><code class="literal">lib.attrsets.mapCartesianProduct</code>   </h4>  </div> </div></div><p>Return the result of function f applied to the cartesian product of attribute set value combinations.
Equivalent to using cartesianProduct followed by map.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.18.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>A function, given an attribute set, it returns a new value.</p></dd><dt><span class="term"><code class="literal">attrsOfLists</code></span></dt><dd><p>Attribute set with attributes that are lists of values</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.18.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mapCartesianProduct :: (AttrSet -&gt; a) -&gt; AttrSet -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.18.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 22. <code class="literal">lib.attrsets.mapCartesianProduct</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mapCartesianProduct ({a, b}: &quot;${a}-${b}&quot;) { a = [ &quot;1&quot; &quot;2&quot; ]; b = [ &quot;3&quot; &quot;4&quot; ]; }
=&gt; [ &quot;1-3&quot; &quot;1-4&quot; &quot;2-3&quot; &quot;2-4&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L945"  target="_top">lib/attrsets.nix:945</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.nameValuePair" class="title" ><code class="literal">lib.attrsets.nameValuePair</code>   </h4>  </div> </div></div><p>Utility function that creates a <code class="literal">{name, value}</code> pair as expected by <code class="literal">builtins.listToAttrs</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.19.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>Attribute name</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>Attribute value</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.19.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">nameValuePair :: String -&gt; Any -&gt; { name :: String; value :: Any; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.19.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 23. <code class="literal">lib.attrsets.nameValuePair</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">nameValuePair &quot;some&quot; 6
=&gt; { name = &quot;some&quot;; value = 6; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L977"  target="_top">lib/attrsets.nix:977</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.mapAttrs" class="title" ><code class="literal">lib.attrsets.mapAttrs</code>   </h4>  </div> </div></div><p>Apply a function to each element in an attribute set, creating a new attribute set.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.20.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>A function that takes an attribute name and its value, and returns the new value for the attribute.</p></dd><dt><span class="term"><code class="literal">attrset</code></span></dt><dd><p>The attribute set to iterate through.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.20.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mapAttrs :: (String -&gt; Any -&gt; Any) -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.20.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 24. <code class="literal">lib.attrsets.mapAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mapAttrs (name: value: name + &quot;-&quot; + value)
   { x = &quot;foo&quot;; y = &quot;bar&quot;; }
=&gt; { x = &quot;x-foo&quot;; y = &quot;y-bar&quot;; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1010"  target="_top">lib/attrsets.nix:1010</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.mapAttrs-prime" class="title" ><code class="literal">lib.attrsets.mapAttrs&#x27;</code>   </h4>  </div> </div></div><p>Like <code class="literal">mapAttrs</code>, but allows the name of each attribute to be
changed in addition to the value.  The applied function should
return both the new name and value as a <code class="literal">nameValuePair</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.21.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>A function, given an attribute’s name and value, returns a new <code class="literal">nameValuePair</code>.</p></dd><dt><span class="term"><code class="literal">set</code></span></dt><dd><p>Attribute set to map over.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.21.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mapAttrs&#x27; :: (String -&gt; Any -&gt; { name :: String; value :: Any; }) -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.21.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 25. <code class="literal">lib.attrsets.mapAttrs&#x27;</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mapAttrs&#x27; (name: value: nameValuePair (&quot;foo_&quot; + name) (&quot;bar-&quot; + value))
   { x = &quot;a&quot;; y = &quot;b&quot;; }
=&gt; { foo_x = &quot;bar-a&quot;; foo_y = &quot;bar-b&quot;; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1045"  target="_top">lib/attrsets.nix:1045</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.mapAttrsToList" class="title" ><code class="literal">lib.attrsets.mapAttrsToList</code>   </h4>  </div> </div></div><p>Call a function for each attribute in the given set and return
the result in a list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.22.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>A function, given an attribute’s name and value, returns a new value.</p></dd><dt><span class="term"><code class="literal">attrs</code></span></dt><dd><p>Attribute set to map over.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.22.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mapAttrsToList :: (String -&gt; a -&gt; b) -&gt; AttrSet -&gt; [b]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.22.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 26. <code class="literal">lib.attrsets.mapAttrsToList</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mapAttrsToList (name: value: name + value)
   { x = &quot;a&quot;; y = &quot;b&quot;; }
=&gt; [ &quot;xa&quot; &quot;yb&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1079"  target="_top">lib/attrsets.nix:1079</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.attrsToList" class="title" ><code class="literal">lib.attrsets.attrsToList</code>   </h4>  </div> </div></div><p>Deconstruct an attrset to a list of name-value pairs as expected by <a class="link" href="https://nixos.org/manual/nix/stable/language/builtins.html#builtins-listToAttrs"  target="_top"><code class="literal">builtins.listToAttrs</code></a>.
Each element of the resulting list is an attribute set with these attributes:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">name</code> (string): The name of the attribute</p></li><li class="listitem"><p><code class="literal">value</code> (any): The value of the attribute</p></li></ul></div><p>The following is always true:</p><pre><code class="programlisting nix">builtins.listToAttrs (attrsToList attrs) == attrs
</code></pre><div class="warning"><h3 class="title">Warning</h3><p>The opposite is not always true. In general expect that</p><pre><code class="programlisting nix">attrsToList (builtins.listToAttrs list) != list
</code></pre><p>This is because the <code class="literal">listToAttrs</code> removes duplicate names and doesn’t preserve the order of the list.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.23.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">set</code></span></dt><dd><p>The attribute set to deconstruct.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.23.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">attrsToList :: AttrSet -&gt; [ { name :: String; value :: Any; } ]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.23.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 27. <code class="literal">lib.attrsets.attrsToList</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">attrsToList { foo = 1; bar = &quot;asdf&quot;; }
=&gt; [ { name = &quot;bar&quot;; value = &quot;asdf&quot;; } { name = &quot;foo&quot;; value = 1; } ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1124"  target="_top">lib/attrsets.nix:1124</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.mapAttrsRecursive" class="title" ><code class="literal">lib.attrsets.mapAttrsRecursive</code>   </h4>  </div> </div></div><p>Like <code class="literal">mapAttrs</code>, except that it recursively applies itself to the <span class="emphasis"><em>leaf</em></span> attributes of a potentially-nested attribute set:
the second argument of the function will never be an attrset.
Also, the first argument of the mapping function is a <span class="emphasis"><em>list</em></span> of the attribute names that form the path to the leaf attribute.</p><p>For a function that gives you control over what counts as a leaf, see <code class="literal">mapAttrsRecursiveCond</code>.</p><div class="example"><span id="map-attrs-recursive-example" ></span><details><summary><span class="title"><strong>Example 28. Map over leaf attributes</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mapAttrsRecursive (path: value: concatStringsSep &quot;-&quot; (path ++ [value]))
  { n = { a = &quot;A&quot;; m = { b = &quot;B&quot;; c = &quot;C&quot;; }; }; d = &quot;D&quot;; }
</code></pre><p>evaluates to</p><pre><code class="programlisting nix">{ n = { a = &quot;n-a-A&quot;; m = { b = &quot;n-m-b-B&quot;; c = &quot;n-m-c-C&quot;; }; }; d = &quot;d-D&quot;; }
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.24.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mapAttrsRecursive :: ([String] -&gt; a -&gt; b) -&gt; AttrSet -&gt; AttrSet
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1151"  target="_top">lib/attrsets.nix:1151</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.mapAttrsRecursiveCond" class="title" ><code class="literal">lib.attrsets.mapAttrsRecursiveCond</code>   </h4>  </div> </div></div><p>Like <code class="literal">mapAttrsRecursive</code>, but it takes an additional predicate that tells it whether to recurse into an attribute set.
If the predicate returns false, <code class="literal">mapAttrsRecursiveCond</code> does not recurse, but instead applies the mapping function.
If the predicate returns true, it does recurse, and does not apply the mapping function.</p><div class="example"><span id="map-attrs-recursive-cond-example" ></span><details><summary><span class="title"><strong>Example 29. Map over an leaf attributes defined by a condition</strong></span></summary><div class="example-contents"><p>Map derivations to their <code class="literal">name</code> attribute.
Derivatons are identified as attribute sets that contain <code class="literal">{ type = &quot;derivation&quot;; }</code>.</p><pre><code class="programlisting nix">mapAttrsRecursiveCond
  (as: !(as ? &quot;type&quot; &amp;&amp; as.type == &quot;derivation&quot;))
  (path: x: x.name)
  attrs
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.25.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mapAttrsRecursiveCond :: (AttrSet -&gt; Bool) -&gt; ([String] -&gt; a -&gt; b) -&gt; AttrSet -&gt; AttrSet
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1176"  target="_top">lib/attrsets.nix:1176</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.genAttrs" class="title" ><code class="literal">lib.attrsets.genAttrs</code>   </h4>  </div> </div></div><p>Generate an attribute set by mapping a function over a list of
attribute names.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.26.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">names</code></span></dt><dd><p>Names of values in the resulting attribute set.</p></dd><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>A function, given the name of the attribute, returns the attribute’s value.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.26.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">genAttrs :: [ String ] -&gt; (String -&gt; Any) -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.26.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 30. <code class="literal">lib.attrsets.genAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">genAttrs [ &quot;foo&quot; &quot;bar&quot; ] (name: &quot;x_&quot; + name)
=&gt; { foo = &quot;x_foo&quot;; bar = &quot;x_bar&quot;; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1219"  target="_top">lib/attrsets.nix:1219</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.isDerivation" class="title" ><code class="literal">lib.attrsets.isDerivation</code>   </h4>  </div> </div></div><p>Check whether the argument is a derivation. Any set with
<code class="literal">{ type = &quot;derivation&quot;; }</code> counts as a derivation.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.27.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>Value to check.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.27.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">isDerivation :: Any -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.27.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 31. <code class="literal">lib.attrsets.isDerivation</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">nixpkgs = import &lt;nixpkgs&gt; {}
isDerivation nixpkgs.ruby
=&gt; true
isDerivation &quot;foobar&quot;
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1251"  target="_top">lib/attrsets.nix:1251</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.toDerivation" class="title" ><code class="literal">lib.attrsets.toDerivation</code>   </h4>  </div> </div></div><p>Converts a store path to a fake derivation.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.28.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>A store path to convert to a derivation.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.28.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toDerivation :: Path -&gt; Derivation
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1268"  target="_top">lib/attrsets.nix:1268</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.optionalAttrs" class="title" ><code class="literal">lib.attrsets.optionalAttrs</code>   </h4>  </div> </div></div><p>If <code class="literal">cond</code> is true, return the attribute set <code class="literal">as</code>,
otherwise an empty attribute set.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.29.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">cond</code></span></dt><dd><p>Condition under which the <code class="literal">as</code> attribute set is returned.</p></dd><dt><span class="term"><code class="literal">as</code></span></dt><dd><p>The attribute set to return if <code class="literal">cond</code> is <code class="literal">true</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.29.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">optionalAttrs :: Bool -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.29.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 32. <code class="literal">lib.attrsets.optionalAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">optionalAttrs (true) { my = &quot;set&quot;; }
=&gt; { my = &quot;set&quot;; }
optionalAttrs (false) { my = &quot;set&quot;; }
=&gt; { }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1316"  target="_top">lib/attrsets.nix:1316</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.zipAttrsWithNames" class="title" ><code class="literal">lib.attrsets.zipAttrsWithNames</code>   </h4>  </div> </div></div><p>Merge sets of attributes and use the function <code class="literal">f</code> to merge attributes
values.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.30.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">names</code></span></dt><dd><p>List of attribute names to zip.</p></dd><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>A function, accepts an attribute name, all the values, and returns a combined value.</p></dd><dt><span class="term"><code class="literal">sets</code></span></dt><dd><p>List of values from the list of attribute sets.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.30.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">zipAttrsWithNames :: [ String ] -&gt; (String -&gt; [ Any ] -&gt; Any) -&gt; [ AttrSet ] -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.30.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 33. <code class="literal">lib.attrsets.zipAttrsWithNames</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">zipAttrsWithNames [&quot;a&quot;] (name: vs: vs) [{a = &quot;x&quot;;} {a = &quot;y&quot;; b = &quot;z&quot;;}]
=&gt; { a = [&quot;x&quot; &quot;y&quot;]; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1353"  target="_top">lib/attrsets.nix:1353</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.zipAttrsWith" class="title" ><code class="literal">lib.attrsets.zipAttrsWith</code>   </h4>  </div> </div></div><p>Merge sets of attributes and use the function f to merge attribute values.
Like <code class="literal">lib.attrsets.zipAttrsWithNames</code> with all key names are passed for <code class="literal">names</code>.</p><p>Implementation note: Common names appear multiple times in the list of
names, hopefully this does not affect the system because the maximal
laziness avoid computing twice the same expression and <code class="literal">listToAttrs</code> does
not care about duplicated attribute names.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.31.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">zipAttrsWith :: (String -&gt; [ Any ] -&gt; Any) -&gt; [ AttrSet ] -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.31.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 34. <code class="literal">lib.attrsets.zipAttrsWith</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">zipAttrsWith (name: values: values) [{a = &quot;x&quot;;} {a = &quot;y&quot;; b = &quot;z&quot;;}]
=&gt; { a = [&quot;x&quot; &quot;y&quot;]; b = [&quot;z&quot;]; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1388"  target="_top">lib/attrsets.nix:1388</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.zipAttrs" class="title" ><code class="literal">lib.attrsets.zipAttrs</code>   </h4>  </div> </div></div><p>Merge sets of attributes and combine each attribute value in to a list.</p><p>Like <code class="literal">lib.attrsets.zipAttrsWith</code> with <code class="literal">(name: values: values)</code> as the function.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.32.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">zipAttrs :: [ AttrSet ] -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.32.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 35. <code class="literal">lib.attrsets.zipAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">zipAttrs [{a = &quot;x&quot;;} {a = &quot;y&quot;; b = &quot;z&quot;;}]
=&gt; { a = [&quot;x&quot; &quot;y&quot;]; b = [&quot;z&quot;]; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1413"  target="_top">lib/attrsets.nix:1413</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.mergeAttrsList" class="title" ><code class="literal">lib.attrsets.mergeAttrsList</code>   </h4>  </div> </div></div><p>Merge a list of attribute sets together using the <code class="literal">//</code> operator.
In case of duplicate attributes, values from later list elements take precedence over earlier ones.
The result is the same as <code class="literal">foldl mergeAttrs { }</code>, but the performance is better for large inputs.
For n list elements, each with an attribute set containing m unique attributes, the complexity of this operation is O(nm log n).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.33.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.33.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mergeAttrsList :: [ Attrs ] -&gt; Attrs
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.33.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 36. <code class="literal">lib.attrsets.mergeAttrsList</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mergeAttrsList [ { a = 0; b = 1; } { c = 2; d = 3; } ]
=&gt; { a = 0; b = 1; c = 2; d = 3; }
mergeAttrsList [ { a = 0; } { a = 1; } ]
=&gt; { a = 1; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1446"  target="_top">lib/attrsets.nix:1446</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.recursiveUpdateUntil" class="title" ><code class="literal">lib.attrsets.recursiveUpdateUntil</code>   </h4>  </div> </div></div><p>Does the same as the update operator ‘//’ except that attributes are
merged until the given predicate is verified.  The predicate should
accept 3 arguments which are the path to reach the attribute, a part of
the first attribute set and a part of the second attribute set.  When
the predicate is satisfied, the value of the first attribute set is
replaced by the value of the second attribute set.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.34.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate, taking the path to the current attribute as a list of strings for attribute names, and the two values at that path from the original arguments.</p></dd><dt><span class="term"><code class="literal">lhs</code></span></dt><dd><p>Left attribute set of the merge.</p></dd><dt><span class="term"><code class="literal">rhs</code></span></dt><dd><p>Right attribute set of the merge.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.34.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">recursiveUpdateUntil :: ( [ String ] -&gt; AttrSet -&gt; AttrSet -&gt; Bool ) -&gt; AttrSet -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.34.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 37. <code class="literal">lib.attrsets.recursiveUpdateUntil</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">recursiveUpdateUntil (path: l: r: path == [&quot;foo&quot;]) {
  # first attribute set
  foo.bar = 1;
  foo.baz = 2;
  bar = 3;
} {
  #second attribute set
  foo.bar = 1;
  foo.quz = 2;
  baz = 4;
}

=&gt; {
  foo.bar = 1; # &#x27;foo.*&#x27; from the second set
  foo.quz = 2; #
  bar = 3;     # &#x27;bar&#x27; from the first set
  baz = 4;     # &#x27;baz&#x27; from the second set
}
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1523"  target="_top">lib/attrsets.nix:1523</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.recursiveUpdate" class="title" ><code class="literal">lib.attrsets.recursiveUpdate</code>   </h4>  </div> </div></div><p>A recursive variant of the update operator ‘//’.  The recursion
stops when one of the attribute values is not an attribute set,
in which case the right hand side value takes precedence over the
left hand side value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.35.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">lhs</code></span></dt><dd><p>Left attribute set of the merge.</p></dd><dt><span class="term"><code class="literal">rhs</code></span></dt><dd><p>Right attribute set of the merge.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.35.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">recursiveUpdate :: AttrSet -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.35.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 38. <code class="literal">lib.attrsets.recursiveUpdate</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">recursiveUpdate {
  boot.loader.grub.enable = true;
  boot.loader.grub.device = &quot;/dev/hda&quot;;
} {
  boot.loader.grub.device = &quot;&quot;;
}

returns: {
  boot.loader.grub.enable = true;
  boot.loader.grub.device = &quot;&quot;;
}
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1583"  target="_top">lib/attrsets.nix:1583</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.matchAttrs" class="title" ><code class="literal">lib.attrsets.matchAttrs</code>   </h4>  </div> </div></div><p>Recurse into every attribute set of the first argument and check that:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Each attribute path also exists in the second argument.</p></li><li class="listitem"><p>If the attribute’s value is not a nested attribute set, it must have the same value in the right argument.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.36.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pattern</code></span></dt><dd><p>Attribute set structure to match</p></dd><dt><span class="term"><code class="literal">attrs</code></span></dt><dd><p>Attribute set to check</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.36.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">matchAttrs :: AttrSet -&gt; AttrSet -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.36.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 39. <code class="literal">lib.attrsets.matchAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">matchAttrs { cpu = {}; } { cpu = { bits = 64; }; }
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1622"  target="_top">lib/attrsets.nix:1622</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.overrideExisting" class="title" ><code class="literal">lib.attrsets.overrideExisting</code>   </h4>  </div> </div></div><p>Override only the attributes that are already present in the old set
useful for deep-overriding.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.37.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">old</code></span></dt><dd><p>Original attribute set</p></dd><dt><span class="term"><code class="literal">new</code></span></dt><dd><p>Attribute set with attributes to override in <code class="literal">old</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.37.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">overrideExisting :: AttrSet -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.37.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 40. <code class="literal">lib.attrsets.overrideExisting</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">overrideExisting {} { a = 1; }
=&gt; {}
overrideExisting { b = 2; } { a = 1; }
=&gt; { b = 2; }
overrideExisting { a = 3; b = 2; } { a = 1; }
=&gt; { a = 1; b = 2; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1675"  target="_top">lib/attrsets.nix:1675</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.showAttrPath" class="title" ><code class="literal">lib.attrsets.showAttrPath</code>   </h4>  </div> </div></div><p>Turns a list of strings into a human-readable description of those
strings represented as an attribute path. The result of this function is
not intended to be machine-readable.
Create a new attribute set with <code class="literal">value</code> set at the nested attribute location specified in <code class="literal">attrPath</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.38.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>Attribute path to render to a string</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.38.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">showAttrPath :: [String] -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.38.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 41. <code class="literal">lib.attrsets.showAttrPath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">showAttrPath [ &quot;foo&quot; &quot;10&quot; &quot;bar&quot; ]
=&gt; &quot;foo.\&quot;10\&quot;.bar&quot;
showAttrPath []
=&gt; &quot;&lt;root attribute path&gt;&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1708"  target="_top">lib/attrsets.nix:1708</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.getOutput" class="title" ><code class="literal">lib.attrsets.getOutput</code>   </h4>  </div> </div></div><p>Get a package output.
If no output is found, fallback to <code class="literal">.out</code> and then to the default.
The function is idempotent: <code class="literal">getOutput &quot;b&quot; (getOutput &quot;a&quot; p) == getOutput &quot;a&quot; p</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.39.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">output</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">pkg</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.39.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getOutput :: String -&gt; :: Derivation -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.39.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 42. <code class="literal">lib.attrsets.getOutput</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">&quot;${getOutput &quot;dev&quot; pkgs.openssl}&quot;
=&gt; &quot;/nix/store/9rz8gxhzf8sw4kf2j2f1grr49w8zx5vj-openssl-1.0.1r-dev&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1744"  target="_top">lib/attrsets.nix:1744</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.getFirstOutput" class="title" ><code class="literal">lib.attrsets.getFirstOutput</code>   </h4>  </div> </div></div><p>Get the first of the <code class="literal">outputs</code> provided by the package, or the default.
This function is aligned with <code class="literal">_overrideFirst()</code> from the <code class="literal">multiple-outputs.sh</code> setup hook.
Like <code class="literal">getOutput</code>, the function is idempotent.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.40.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">outputs</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">pkg</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.40.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getFirstOutput :: [String] -&gt; Derivation -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.40.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 43. <code class="literal">lib.attrsets.getFirstOutput</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">&quot;${getFirstOutput [ &quot;include&quot; &quot;dev&quot; ] pkgs.openssl}&quot;
=&gt; &quot;/nix/store/00000000000000000000000000000000-openssl-1.0.1r-dev&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1780"  target="_top">lib/attrsets.nix:1780</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.getBin" class="title" ><code class="literal">lib.attrsets.getBin</code>   </h4>  </div> </div></div><p>Get a package’s <code class="literal">bin</code> output.
If the output does not exist, fallback to <code class="literal">.out</code> and then to the default.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.41.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pkg</code></span></dt><dd><p>The package whose <code class="literal">bin</code> output will be retrieved.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.41.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getBin :: Derivation -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.41.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 44. <code class="literal">lib.attrsets.getBin</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">&quot;${getBin pkgs.openssl}&quot;
=&gt; &quot;/nix/store/00000000000000000000000000000000-openssl-1.0.1r&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1815"  target="_top">lib/attrsets.nix:1815</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.getLib" class="title" ><code class="literal">lib.attrsets.getLib</code>   </h4>  </div> </div></div><p>Get a package’s <code class="literal">lib</code> output.
If the output does not exist, fallback to <code class="literal">.out</code> and then to the default.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.42.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pkg</code></span></dt><dd><p>The package whose <code class="literal">lib</code> output will be retrieved.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.42.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getLib :: Derivation -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.42.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 45. <code class="literal">lib.attrsets.getLib</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">&quot;${getLib pkgs.openssl}&quot;
=&gt; &quot;/nix/store/9rz8gxhzf8sw4kf2j2f1grr49w8zx5vj-openssl-1.0.1r-lib&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1844"  target="_top">lib/attrsets.nix:1844</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.getStatic" class="title" ><code class="literal">lib.attrsets.getStatic</code>   </h4>  </div> </div></div><p>Get a package’s <code class="literal">static</code> output.
If the output does not exist, fallback to <code class="literal">.lib</code>, then to <code class="literal">.out</code>, and then to the default.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.43.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pkg</code></span></dt><dd><p>The package whose <code class="literal">static</code> output will be retrieved.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.43.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getStatic :: Derivation -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.43.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 46. <code class="literal">lib.attrsets.getStatic</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">&quot;${lib.getStatic pkgs.glibc}&quot;
=&gt; &quot;/nix/store/00000000000000000000000000000000-glibc-2.39-52-static&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1873"  target="_top">lib/attrsets.nix:1873</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.getDev" class="title" ><code class="literal">lib.attrsets.getDev</code>   </h4>  </div> </div></div><p>Get a package’s <code class="literal">dev</code> output.
If the output does not exist, fallback to <code class="literal">.out</code> and then to the default.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.44.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pkg</code></span></dt><dd><p>The package whose <code class="literal">dev</code> output will be retrieved.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.44.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getDev :: Derivation -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.44.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 47. <code class="literal">lib.attrsets.getDev</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">&quot;${getDev pkgs.openssl}&quot;
=&gt; &quot;/nix/store/9rz8gxhzf8sw4kf2j2f1grr49w8zx5vj-openssl-1.0.1r-dev&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1906"  target="_top">lib/attrsets.nix:1906</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.getInclude" class="title" ><code class="literal">lib.attrsets.getInclude</code>   </h4>  </div> </div></div><p>Get a package’s <code class="literal">include</code> output.
If the output does not exist, fallback to <code class="literal">.dev</code>, then to <code class="literal">.out</code>, and then to the default.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.45.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pkg</code></span></dt><dd><p>The package whose <code class="literal">include</code> output will be retrieved.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.45.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getInclude :: Derivation -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.45.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 48. <code class="literal">lib.attrsets.getInclude</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">&quot;${getInclude pkgs.openssl}&quot;
=&gt; &quot;/nix/store/00000000000000000000000000000000-openssl-1.0.1r-dev&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1935"  target="_top">lib/attrsets.nix:1935</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.getMan" class="title" ><code class="literal">lib.attrsets.getMan</code>   </h4>  </div> </div></div><p>Get a package’s <code class="literal">man</code> output.
If the output does not exist, fallback to <code class="literal">.out</code> and then to the default.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.46.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pkg</code></span></dt><dd><p>The package whose <code class="literal">man</code> output will be retrieved.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.46.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getMan :: Derivation -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.46.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 49. <code class="literal">lib.attrsets.getMan</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">&quot;${getMan pkgs.openssl}&quot;
=&gt; &quot;/nix/store/9rz8gxhzf8sw4kf2j2f1grr49w8zx5vj-openssl-1.0.1r-man&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1968"  target="_top">lib/attrsets.nix:1968</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.chooseDevOutputs" class="title" ><code class="literal">lib.attrsets.chooseDevOutputs</code>   </h4>  </div> </div></div><p>Pick the outputs of packages to place in <code class="literal">buildInputs</code></p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.47.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pkgs</code></span></dt><dd><p>List of packages.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.47.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">chooseDevOutputs :: [Derivation] -&gt; [Derivation]
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L1985"  target="_top">lib/attrsets.nix:1985</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.recurseIntoAttrs" class="title" ><code class="literal">lib.attrsets.recurseIntoAttrs</code>   </h4>  </div> </div></div><p>Make various Nix tools consider the contents of the resulting
attribute set when looking for what to build, find, etc.</p><p>This function only affects a single attribute set; it does not
apply itself recursively for nested attribute sets.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.48.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">attrs</code></span></dt><dd><p>An attribute set to scan for derivations.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.48.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">recurseIntoAttrs :: AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.48.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 50. <code class="literal">lib.attrsets.recurseIntoAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ pkgs ? import &lt;nixpkgs&gt; {} }:
{
  myTools = pkgs.lib.recurseIntoAttrs {
    inherit (pkgs) hello figlet;
  };
}
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L2021"  target="_top">lib/attrsets.nix:2021</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.dontRecurseIntoAttrs" class="title" ><code class="literal">lib.attrsets.dontRecurseIntoAttrs</code>   </h4>  </div> </div></div><p>Undo the effect of recurseIntoAttrs.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.49.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">attrs</code></span></dt><dd><p>An attribute set to not scan for derivations.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.49.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">dontRecurseIntoAttrs :: AttrSet -&gt; AttrSet
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L2038"  target="_top">lib/attrsets.nix:2038</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.attrsets.unionOfDisjoint" class="title" ><code class="literal">lib.attrsets.unionOfDisjoint</code>   </h4>  </div> </div></div><p><code class="literal">unionOfDisjoint x y</code> is equal to <code class="literal">x // y // z</code> where the
attrnames in <code class="literal">z</code> are the intersection of the attrnames in <code class="literal">x</code> and
<code class="literal">y</code>, and all values <code class="literal">assert</code> with an error message.  This
operator is commutative, unlike (//).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.50.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-7-1.50.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">unionOfDisjoint :: AttrSet -&gt; AttrSet -&gt; AttrSet
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/attrsets.nix#L2062"  target="_top">lib/attrsets.nix:2062</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-strings" class="title" >lib.strings: string manipulation functions   </h3>  </div> </div></div><p>String manipulation functions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.concatStrings" class="title" ><code class="literal">lib.strings.concatStrings</code>   </h4>  </div> </div></div><p>Concatenate a list of strings.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.1.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">concatStrings :: [string] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.1.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 51. <code class="literal">lib.strings.concatStrings</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concatStrings [&quot;foo&quot; &quot;bar&quot;]
=&gt; &quot;foobar&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L64"  target="_top">lib/strings.nix:64</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.concatMapStrings" class="title" ><code class="literal">lib.strings.concatMapStrings</code>   </h4>  </div> </div></div><p>Map a function over a list and concatenate the resulting strings.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">concatMapStrings :: (a -&gt; string) -&gt; [a] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.2.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 52. <code class="literal">lib.strings.concatMapStrings</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concatMapStrings (x: &quot;a&quot; + x) [&quot;foo&quot; &quot;bar&quot;]
=&gt; &quot;afooabar&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L94"  target="_top">lib/strings.nix:94</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.concatImapStrings" class="title" ><code class="literal">lib.strings.concatImapStrings</code>   </h4>  </div> </div></div><p>Like <code class="literal">concatMapStrings</code> except that the f functions also gets the
position as a parameter.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">concatImapStrings :: (int -&gt; a -&gt; string) -&gt; [a] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.3.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 53. <code class="literal">lib.strings.concatImapStrings</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concatImapStrings (pos: x: &quot;${toString pos}-${x}&quot;) [&quot;foo&quot; &quot;bar&quot;]
=&gt; &quot;1-foo2-bar&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L125"  target="_top">lib/strings.nix:125</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.intersperse" class="title" ><code class="literal">lib.strings.intersperse</code>   </h4>  </div> </div></div><p>Place an element between each element of a list</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">separator</code></span></dt><dd><p>Separator to add between elements</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">intersperse :: a -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.4.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 54. <code class="literal">lib.strings.intersperse</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">intersperse &quot;/&quot; [&quot;usr&quot; &quot;local&quot; &quot;bin&quot;]
=&gt; [&quot;usr&quot; &quot;/&quot; &quot;local&quot; &quot;/&quot; &quot;bin&quot;].
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L155"  target="_top">lib/strings.nix:155</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.concatStringsSep" class="title" ><code class="literal">lib.strings.concatStringsSep</code>   </h4>  </div> </div></div><p>Concatenate a list of strings with a separator between each element</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">sep</code></span></dt><dd><p>Separator to add between elements</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>List of input strings</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.5.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">concatStringsSep :: string -&gt; [string] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.5.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 55. <code class="literal">lib.strings.concatStringsSep</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concatStringsSep &quot;/&quot; [&quot;usr&quot; &quot;local&quot; &quot;bin&quot;]
=&gt; &quot;usr/local/bin&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L195"  target="_top">lib/strings.nix:195</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.concatMapStringsSep" class="title" ><code class="literal">lib.strings.concatMapStringsSep</code>   </h4>  </div> </div></div><p>Maps a function over a list of strings and then concatenates the
result with the specified separator interspersed between
elements.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">sep</code></span></dt><dd><p>Separator to add between elements</p></dd><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>Function to map over the list</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>List of input strings</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.6.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">concatMapStringsSep :: string -&gt; (a -&gt; string) -&gt; [a] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.6.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 56. <code class="literal">lib.strings.concatMapStringsSep</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concatMapStringsSep &quot;-&quot; (x: toUpper x)  [&quot;foo&quot; &quot;bar&quot; &quot;baz&quot;]
=&gt; &quot;FOO-BAR-BAZ&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L230"  target="_top">lib/strings.nix:230</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.concatImapStringsSep" class="title" ><code class="literal">lib.strings.concatImapStringsSep</code>   </h4>  </div> </div></div><p>Same as <code class="literal">concatMapStringsSep</code>, but the mapping function
additionally receives the position of its argument.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.7.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">sep</code></span></dt><dd><p>Separator to add between elements</p></dd><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>Function that receives elements and their positions</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>List of input strings</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.7.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">concatIMapStringsSep :: string -&gt; (int -&gt; a -&gt; string) -&gt; [a] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.7.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 57. <code class="literal">lib.strings.concatImapStringsSep</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concatImapStringsSep &quot;-&quot; (pos: x: toString (x / pos)) [ 6 6 6 ]
=&gt; &quot;6-3-2&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L266"  target="_top">lib/strings.nix:266</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.concatMapAttrsStringSep" class="title" ><code class="literal">lib.strings.concatMapAttrsStringSep</code>   </h4>  </div> </div></div><p>Like <a class="link" href="index.html#function-library-lib.strings.concatMapStringsSep" title="lib.strings.concatMapStringsSep" ><code class="literal">concatMapStringsSep</code></a>
but takes an attribute set instead of a list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.8.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">sep</code></span></dt><dd><p>Separator to add between item strings</p></dd><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>Function that takes each key and value and return a string</p></dd><dt><span class="term"><code class="literal">attrs</code></span></dt><dd><p>Attribute set to map from</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.8.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">concatMapAttrsStringSep :: String -&gt; (String -&gt; Any -&gt; String) -&gt; AttrSet -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.8.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 58. <code class="literal">lib.strings.concatMapAttrsStringSep</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concatMapAttrsStringSep &quot;\n&quot; (name: value: &quot;${name}: foo-${value}&quot;) { a = &quot;0.1.0&quot;; b = &quot;0.2.0&quot;; }
=&gt; &quot;a: foo-0.1.0\nb: foo-0.2.0&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L303"  target="_top">lib/strings.nix:303</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.concatLines" class="title" ><code class="literal">lib.strings.concatLines</code>   </h4>  </div> </div></div><p>Concatenate a list of strings, adding a newline at the end of each one.
Defined as <code class="literal">concatMapStrings (s: s + &quot;\n&quot;)</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.9.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>List of strings. Any element that is not a string will be implicitly converted to a string.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.9.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">concatLines :: [string] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.9.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 59. <code class="literal">lib.strings.concatLines</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concatLines [ &quot;foo&quot; &quot;bar&quot; ]
=&gt; &quot;foo\nbar\n&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L333"  target="_top">lib/strings.nix:333</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.replaceString" class="title" ><code class="literal">lib.strings.replaceString</code>   </h4>  </div> </div></div><p>Given string <code class="literal">s</code>, replace every occurrence of the string <code class="literal">from</code> with the string <code class="literal">to</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.10.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">from</code></span></dt><dd><p>The string to be replaced</p></dd><dt><span class="term"><code class="literal">to</code></span></dt><dd><p>The string to replace with</p></dd><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>The original string where replacements will be made</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.10.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">replaceString :: string -&gt; string -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.10.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 60. <code class="literal">lib.strings.replaceString</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">replaceString &quot;world&quot; &quot;Nix&quot; &quot;Hello, world!&quot;
=&gt; &quot;Hello, Nix!&quot;
replaceString &quot;.&quot; &quot;_&quot; &quot;v1.2.3&quot;
=&gt; &quot;v1_2_3&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L368"  target="_top">lib/strings.nix:368</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.replicate" class="title" ><code class="literal">lib.strings.replicate</code>   </h4>  </div> </div></div><p>Repeat a string <code class="literal">n</code> times,
and concatenate the parts into a new string.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.11.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">n</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.11.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">replicate :: int -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.11.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 61. <code class="literal">lib.strings.replicate</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">replicate 3 &quot;v&quot;
=&gt; &quot;vvv&quot;
replicate 5 &quot;hello&quot;
=&gt; &quot;hellohellohellohellohello&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L401"  target="_top">lib/strings.nix:401</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.trim" class="title" ><code class="literal">lib.strings.trim</code>   </h4>  </div> </div></div><p>Remove leading and trailing whitespace from a string <code class="literal">s</code>.</p><p>Whitespace is defined as any of the following characters:
&quot; &quot;, “\t” “\r” “\n”</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.12.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>The string to trim</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.12.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">trim :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.12.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 62. <code class="literal">lib.strings.trim</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">trim &quot;   hello, world!   &quot;
=&gt; &quot;hello, world!&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L431"  target="_top">lib/strings.nix:431</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.trimWith" class="title" ><code class="literal">lib.strings.trimWith</code>   </h4>  </div> </div></div><p>Remove leading and/or trailing whitespace from a string <code class="literal">s</code>.</p><p>To remove both leading and trailing whitespace, you can also use <a class="link" href="index.html#function-library-lib.strings.trim" title="lib.strings.trim" ><code class="literal">trim</code></a></p><p>Whitespace is defined as any of the following characters:
&quot; &quot;, “\t” “\r” “\n”</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.13.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">config</code> (Attribute set)</span></dt><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">start</code></span></dt><dd><p>Whether to trim leading whitespace (<code class="literal">false</code> by default)</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">end</code></span></dt><dd><p>Whether to trim trailing whitespace (<code class="literal">false</code> by default)</p></dd></dl></div></dd><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>The string to trim</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.13.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">trimWith :: { start :: Bool; end :: Bool } -&gt; String -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.13.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 63. <code class="literal">lib.strings.trimWith</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">trimWith { start = true; } &quot;   hello, world!   &quot;}
=&gt; &quot;hello, world!   &quot;

trimWith { end = true; } &quot;   hello, world!   &quot;}
=&gt; &quot;   hello, world!&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L475"  target="_top">lib/strings.nix:475</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.makeSearchPath" class="title" ><code class="literal">lib.strings.makeSearchPath</code>   </h4>  </div> </div></div><p>Construct a Unix-style, colon-separated search path consisting of
the given <code class="literal">subDir</code> appended to each of the given paths.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.14.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">subDir</code></span></dt><dd><p>Directory name to append</p></dd><dt><span class="term"><code class="literal">paths</code></span></dt><dd><p>List of base paths</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.14.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">makeSearchPath :: string -&gt; [string] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.14.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 64. <code class="literal">lib.strings.makeSearchPath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">makeSearchPath &quot;bin&quot; [&quot;/root&quot; &quot;/usr&quot; &quot;/usr/local&quot;]
=&gt; &quot;/root/bin:/usr/bin:/usr/local/bin&quot;
makeSearchPath &quot;bin&quot; [&quot;&quot;]
=&gt; &quot;/bin&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L536"  target="_top">lib/strings.nix:536</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.makeSearchPathOutput" class="title" ><code class="literal">lib.strings.makeSearchPathOutput</code>   </h4>  </div> </div></div><p>Construct a Unix-style search path by appending the given
<code class="literal">subDir</code> to the specified <code class="literal">output</code> of each of the packages.</p><p>If no output by the given name is found, fallback to <code class="literal">.out</code> and then to
the default.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.15.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">output</code></span></dt><dd><p>Package output to use</p></dd><dt><span class="term"><code class="literal">subDir</code></span></dt><dd><p>Directory name to append</p></dd><dt><span class="term"><code class="literal">pkgs</code></span></dt><dd><p>List of packages</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.15.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">makeSearchPathOutput :: string -&gt; string -&gt; [package] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.15.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 65. <code class="literal">lib.strings.makeSearchPathOutput</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">makeSearchPathOutput &quot;dev&quot; &quot;bin&quot; [ pkgs.openssl pkgs.zlib ]
=&gt; &quot;/nix/store/9rz8gxhzf8sw4kf2j2f1grr49w8zx5vj-openssl-1.0.1r-dev/bin:/nix/store/wwh7mhwh269sfjkm6k5665b5kgp7jrk2-zlib-1.2.8/bin&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L574"  target="_top">lib/strings.nix:574</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.makeLibraryPath" class="title" ><code class="literal">lib.strings.makeLibraryPath</code>   </h4>  </div> </div></div><p>Construct a library search path (such as RPATH) containing the
libraries for a set of packages</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.16.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">packages</code></span></dt><dd><p>List of packages</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.16.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">makeLibraryPath :: [package] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.16.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 66. <code class="literal">lib.strings.makeLibraryPath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">makeLibraryPath [ &quot;/usr&quot; &quot;/usr/local&quot; ]
=&gt; &quot;/usr/lib:/usr/local/lib&quot;
pkgs = import &lt;nixpkgs&gt; { }
makeLibraryPath [ pkgs.openssl pkgs.zlib ]
=&gt; &quot;/nix/store/9rz8gxhzf8sw4kf2j2f1grr49w8zx5vj-openssl-1.0.1r/lib:/nix/store/wwh7mhwh269sfjkm6k5665b5kgp7jrk2-zlib-1.2.8/lib&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L607"  target="_top">lib/strings.nix:607</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.makeIncludePath" class="title" ><code class="literal">lib.strings.makeIncludePath</code>   </h4>  </div> </div></div><p>Construct an include search path (such as C_INCLUDE_PATH) containing the
header files for a set of packages or paths.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.17.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">packages</code></span></dt><dd><p>List of packages</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.17.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">makeIncludePath :: [package] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.17.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 67. <code class="literal">lib.strings.makeIncludePath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">makeIncludePath [ &quot;/usr&quot; &quot;/usr/local&quot; ]
=&gt; &quot;/usr/include:/usr/local/include&quot;
pkgs = import &lt;nixpkgs&gt; { }
makeIncludePath [ pkgs.openssl pkgs.zlib ]
=&gt; &quot;/nix/store/9rz8gxhzf8sw4kf2j2f1grr49w8zx5vj-openssl-1.0.1r-dev/include:/nix/store/wwh7mhwh269sfjkm6k5665b5kgp7jrk2-zlib-1.2.8-dev/include&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L638"  target="_top">lib/strings.nix:638</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.makeBinPath" class="title" ><code class="literal">lib.strings.makeBinPath</code>   </h4>  </div> </div></div><p>Construct a binary search path (such as $PATH) containing the
binaries for a set of packages.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.18.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">packages</code></span></dt><dd><p>List of packages</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.18.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">makeBinPath :: [package] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.18.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 68. <code class="literal">lib.strings.makeBinPath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">makeBinPath [&quot;/root&quot; &quot;/usr&quot; &quot;/usr/local&quot;]
=&gt; &quot;/root/bin:/usr/bin:/usr/local/bin&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L666"  target="_top">lib/strings.nix:666</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.normalizePath" class="title" ><code class="literal">lib.strings.normalizePath</code>   </h4>  </div> </div></div><p>Normalize path, removing extraneous /s</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.19.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.19.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">normalizePath :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.19.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 69. <code class="literal">lib.strings.normalizePath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">normalizePath &quot;/a//b///c/&quot;
=&gt; &quot;/a/b/c/&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L693"  target="_top">lib/strings.nix:693</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.optionalString" class="title" ><code class="literal">lib.strings.optionalString</code>   </h4>  </div> </div></div><p>Depending on the boolean `cond’, return either the given string
or the empty string. Useful to concatenate against a bigger string.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.20.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">cond</code></span></dt><dd><p>Condition</p></dd><dt><span class="term"><code class="literal">string</code></span></dt><dd><p>String to return if condition is true</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.20.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">optionalString :: bool -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.20.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 70. <code class="literal">lib.strings.optionalString</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">optionalString true &quot;some-string&quot;
=&gt; &quot;some-string&quot;
optionalString false &quot;some-string&quot;
=&gt; &quot;&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L736"  target="_top">lib/strings.nix:736</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.hasPrefix" class="title" ><code class="literal">lib.strings.hasPrefix</code>   </h4>  </div> </div></div><p>Determine whether a string has given prefix.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.21.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pref</code></span></dt><dd><p>Prefix to check for</p></dd><dt><span class="term"><code class="literal">str</code></span></dt><dd><p>Input string</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.21.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">hasPrefix :: string -&gt; string -&gt; bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.21.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 71. <code class="literal">lib.strings.hasPrefix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">hasPrefix &quot;foo&quot; &quot;foobar&quot;
=&gt; true
hasPrefix &quot;foo&quot; &quot;barfoo&quot;
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L768"  target="_top">lib/strings.nix:768</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.hasSuffix" class="title" ><code class="literal">lib.strings.hasSuffix</code>   </h4>  </div> </div></div><p>Determine whether a string has given suffix.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.22.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">suffix</code></span></dt><dd><p>Suffix to check for</p></dd><dt><span class="term"><code class="literal">content</code></span></dt><dd><p>Input string</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.22.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">hasSuffix :: string -&gt; string -&gt; bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.22.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 72. <code class="literal">lib.strings.hasSuffix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">hasSuffix &quot;foo&quot; &quot;foobar&quot;
=&gt; false
hasSuffix &quot;foo&quot; &quot;barfoo&quot;
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L811"  target="_top">lib/strings.nix:811</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.hasInfix" class="title" ><code class="literal">lib.strings.hasInfix</code>   </h4>  </div> </div></div><p>Determine whether a string contains the given infix</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.23.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">infix</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">content</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.23.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">hasInfix :: string -&gt; string -&gt; bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.23.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 73. <code class="literal">lib.strings.hasInfix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">hasInfix &quot;bc&quot; &quot;abcd&quot;
=&gt; true
hasInfix &quot;ab&quot; &quot;abcd&quot;
=&gt; true
hasInfix &quot;cd&quot; &quot;abcd&quot;
=&gt; true
hasInfix &quot;foo&quot; &quot;abcd&quot;
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L861"  target="_top">lib/strings.nix:861</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.stringToCharacters" class="title" ><code class="literal">lib.strings.stringToCharacters</code>   </h4>  </div> </div></div><p>Convert a string <code class="literal">s</code> to a list of characters (i.e. singleton strings).
This allows you to, e.g., map a function over each character.  However,
note that this will likely be horribly inefficient; Nix is not a
general purpose programming language. Complex string manipulations
should, if appropriate, be done in a derivation.
Also note that Nix treats strings as a list of bytes and thus doesn’t
handle unicode.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.24.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.24.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">stringToCharacters :: string -&gt; [string]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.24.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 74. <code class="literal">lib.strings.stringToCharacters</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">stringToCharacters &quot;&quot;
=&gt; [ ]
stringToCharacters &quot;abc&quot;
=&gt; [ &quot;a&quot; &quot;b&quot; &quot;c&quot; ]
stringToCharacters &quot;🦄&quot;
=&gt; [ &quot;�&quot; &quot;�&quot; &quot;�&quot; &quot;�&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L908"  target="_top">lib/strings.nix:908</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.stringAsChars" class="title" ><code class="literal">lib.strings.stringAsChars</code>   </h4>  </div> </div></div><p>Manipulate a string character by character and replace them by
strings before concatenating the results.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.25.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>Function to map over each individual character</p></dd><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>Input string</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.25.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">stringAsChars :: (string -&gt; string) -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.25.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 75. <code class="literal">lib.strings.stringAsChars</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">stringAsChars (x: if x == &quot;a&quot; then &quot;i&quot; else x) &quot;nax&quot;
=&gt; &quot;nix&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L939"  target="_top">lib/strings.nix:939</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.charToInt" class="title" ><code class="literal">lib.strings.charToInt</code>   </h4>  </div> </div></div><p>Convert char to ascii value, must be in printable range</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.26.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">c</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.26.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">charToInt :: string -&gt; int
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.26.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 76. <code class="literal">lib.strings.charToInt</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">charToInt &quot;A&quot;
=&gt; 65
charToInt &quot;(&quot;
=&gt; 40
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L973"  target="_top">lib/strings.nix:973</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.escape" class="title" ><code class="literal">lib.strings.escape</code>   </h4>  </div> </div></div><p>Escape occurrence of the elements of <code class="literal">list</code> in <code class="literal">string</code> by
prefixing it with a backslash.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.27.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">string</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.27.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">escape :: [string] -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.27.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 77. <code class="literal">lib.strings.escape</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">escape [&quot;(&quot; &quot;)&quot;] &quot;(foo)&quot;
=&gt; &quot;\\(foo\\)&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1004"  target="_top">lib/strings.nix:1004</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.escapeC" class="title" ><code class="literal">lib.strings.escapeC</code>   </h4>  </div> </div></div><p>Escape occurrence of the element of <code class="literal">list</code> in <code class="literal">string</code> by
converting to its ASCII value and prefixing it with \x.
Only works for printable ascii characters.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.28.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">string</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.28.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">escapeC = [string] -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.28.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 78. <code class="literal">lib.strings.escapeC</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">escapeC [&quot; &quot;] &quot;foo bar&quot;
=&gt; &quot;foo\\x20bar&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1036"  target="_top">lib/strings.nix:1036</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.escapeURL" class="title" ><code class="literal">lib.strings.escapeURL</code>   </h4>  </div> </div></div><p>Escape the <code class="literal">string</code> so it can be safely placed inside a URL
query.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.29.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">string</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.29.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">escapeURL :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.29.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 79. <code class="literal">lib.strings.escapeURL</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">escapeURL &quot;foo/bar baz&quot;
=&gt; &quot;foo%2Fbar%20baz&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1068"  target="_top">lib/strings.nix:1068</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.escapeShellArg" class="title" ><code class="literal">lib.strings.escapeShellArg</code>   </h4>  </div> </div></div><p>Quote <code class="literal">string</code> to be used safely within the Bourne shell if it has any
special characters.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.30.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">string</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.30.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">escapeShellArg :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.30.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 80. <code class="literal">lib.strings.escapeShellArg</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">escapeShellArg &quot;esc&#x27;ape\nme&quot;
=&gt; &quot;&#x27;esc&#x27;\\&#x27;&#x27;ape\nme&#x27;&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1170"  target="_top">lib/strings.nix:1170</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.escapeShellArgs" class="title" ><code class="literal">lib.strings.escapeShellArgs</code>   </h4>  </div> </div></div><p>Quote all arguments that have special characters to be safely passed to the
Bourne shell.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.31.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">args</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.31.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">escapeShellArgs :: [string] -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.31.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 81. <code class="literal">lib.strings.escapeShellArgs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">escapeShellArgs [&quot;one&quot; &quot;two three&quot; &quot;four&#x27;five&quot;]
=&gt; &quot;one &#x27;two three&#x27; &#x27;four&#x27;\\&#x27;&#x27;five&#x27;&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1206"  target="_top">lib/strings.nix:1206</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.isValidPosixName" class="title" ><code class="literal">lib.strings.isValidPosixName</code>   </h4>  </div> </div></div><p>Test whether the given <code class="literal">name</code> is a valid POSIX shell variable name.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.32.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.32.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">string -&gt; bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.32.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 82. <code class="literal">lib.strings.isValidPosixName</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">isValidPosixName &quot;foo_bar000&quot;
=&gt; true
isValidPosixName &quot;0-bad.jpg&quot;
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1235"  target="_top">lib/strings.nix:1235</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.toShellVar" class="title" ><code class="literal">lib.strings.toShellVar</code>   </h4>  </div> </div></div><p>Translate a Nix value into a shell variable declaration, with proper escaping.</p><p>The value can be a string (mapped to a regular variable), a list of strings
(mapped to a Bash-style array) or an attribute set of strings (mapped to a
Bash-style associative array). Note that “string” includes string-coercible
values like paths or derivations.</p><p>Strings are translated into POSIX sh-compatible code; lists and attribute sets
assume a shell that understands Bash syntax (e.g. Bash or ZSH).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.33.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.33.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">string -&gt; ( string | [string] | { ${name} :: string; } ) -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.33.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 83. <code class="literal">lib.strings.toShellVar</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">&#x27;&#x27;
  ${toShellVar &quot;foo&quot; &quot;some string&quot;}
  [[ &quot;$foo&quot; == &quot;some string&quot; ]]
&#x27;&#x27;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1275"  target="_top">lib/strings.nix:1275</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.toShellVars" class="title" ><code class="literal">lib.strings.toShellVars</code>   </h4>  </div> </div></div><p>Translate an attribute set <code class="literal">vars</code> into corresponding shell variable declarations
using <code class="literal">toShellVar</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.34.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">vars</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.34.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toShellVars :: {
  ${name} :: string | [ string ] | { ${key} :: string; };
} -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.34.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 84. <code class="literal">lib.strings.toShellVars</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">let
  foo = &quot;value&quot;;
  bar = foo;
in &#x27;&#x27;
  ${toShellVars { inherit foo bar; }}
  [[ &quot;$foo&quot; == &quot;$bar&quot; ]]
&#x27;&#x27;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1321"  target="_top">lib/strings.nix:1321</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.escapeNixString" class="title" ><code class="literal">lib.strings.escapeNixString</code>   </h4>  </div> </div></div><p>Turn a string <code class="literal">s</code> into a Nix expression representing that string</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.35.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.35.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">escapeNixString :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.35.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 85. <code class="literal">lib.strings.escapeNixString</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">escapeNixString &quot;hello\${}\n&quot;
=&gt; &quot;\&quot;hello\\\${}\\n\&quot;&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1348"  target="_top">lib/strings.nix:1348</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.escapeRegex" class="title" ><code class="literal">lib.strings.escapeRegex</code>   </h4>  </div> </div></div><p>Turn a string <code class="literal">s</code> into an exact regular expression</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.36.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.36.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">escapeRegex :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.36.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 86. <code class="literal">lib.strings.escapeRegex</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">escapeRegex &quot;[^a-z]*&quot;
=&gt; &quot;\\[\\^a-z]\\*&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1375"  target="_top">lib/strings.nix:1375</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.escapeNixIdentifier" class="title" ><code class="literal">lib.strings.escapeNixIdentifier</code>   </h4>  </div> </div></div><p>Quotes a string <code class="literal">s</code> if it can’t be used as an identifier directly.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.37.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.37.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">escapeNixIdentifier :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.37.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 87. <code class="literal">lib.strings.escapeNixIdentifier</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">escapeNixIdentifier &quot;hello&quot;
=&gt; &quot;hello&quot;
escapeNixIdentifier &quot;0abc&quot;
=&gt; &quot;\&quot;0abc\&quot;&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1404"  target="_top">lib/strings.nix:1404</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.escapeXML" class="title" ><code class="literal">lib.strings.escapeXML</code>   </h4>  </div> </div></div><p>Escapes a string <code class="literal">s</code> such that it is safe to include verbatim in an XML
document.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.38.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.38.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">escapeXML :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.38.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 88. <code class="literal">lib.strings.escapeXML</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">escapeXML &#x27;&#x27;&quot;test&quot; &#x27;test&#x27; &lt; &amp; &gt;&#x27;&#x27;
=&gt; &quot;&amp;quot;test&amp;quot; &amp;apos;test&amp;apos; &amp;lt; &amp;amp; &amp;gt;&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1435"  target="_top">lib/strings.nix:1435</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.toLower" class="title" ><code class="literal">lib.strings.toLower</code>   </h4>  </div> </div></div><p>Converts an ASCII string <code class="literal">s</code> to lower-case.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.39.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>The string to convert to lower-case.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.39.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toLower :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.39.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 89. <code class="literal">lib.strings.toLower</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">toLower &quot;HOME&quot;
=&gt; &quot;home&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1472"  target="_top">lib/strings.nix:1472</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.toUpper" class="title" ><code class="literal">lib.strings.toUpper</code>   </h4>  </div> </div></div><p>Converts an ASCII string <code class="literal">s</code> to upper-case.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.40.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>The string to convert to upper-case.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.40.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toUpper :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.40.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 90. <code class="literal">lib.strings.toUpper</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">toUpper &quot;home&quot;
=&gt; &quot;HOME&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1499"  target="_top">lib/strings.nix:1499</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.toSentenceCase" class="title" ><code class="literal">lib.strings.toSentenceCase</code>   </h4>  </div> </div></div><p>Converts the first character of a string <code class="literal">s</code> to upper-case.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.41.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">str</code></span></dt><dd><p>The string to convert to sentence case.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.41.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toSentenceCase :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.41.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 91. <code class="literal">lib.strings.toSentenceCase</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">toSentenceCase &quot;home&quot;
=&gt; &quot;Home&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1526"  target="_top">lib/strings.nix:1526</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.toCamelCase" class="title" ><code class="literal">lib.strings.toCamelCase</code>   </h4>  </div> </div></div><p>Converts a string to camelCase. Handles snake_case, PascalCase,
kebab-case strings as well as strings delimited by spaces.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.42.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">string</code></span></dt><dd><p>The string to convert to camelCase</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.42.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toCamelCase :: string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.42.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 92. <code class="literal">lib.strings.toCamelCase</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">toCamelCase &quot;hello-world&quot;
=&gt; &quot;helloWorld&quot;
toCamelCase &quot;hello_world&quot;
=&gt; &quot;helloWorld&quot;
toCamelCase &quot;hello world&quot;
=&gt; &quot;helloWorld&quot;
toCamelCase &quot;HelloWorld&quot;
=&gt; &quot;helloWorld&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1570"  target="_top">lib/strings.nix:1570</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.addContextFrom" class="title" ><code class="literal">lib.strings.addContextFrom</code>   </h4>  </div> </div></div><p>Appends string context from string like object <code class="literal">src</code> to <code class="literal">target</code>.</p><div class="warning"><h3 class="title">Warning</h3><p>This is an implementation
detail of Nix and should be used carefully.</p></div><p>Strings in Nix carry an invisible <code class="literal">context</code> which is a list of strings
representing store paths. If the string is later used in a derivation
attribute, the derivation will properly populate the inputDrvs and
inputSrcs.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.43.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">src</code></span></dt><dd><p>The string to take the context from. If the argument is not a string,
it will be implicitly converted to a string.</p></dd><dt><span class="term"><code class="literal">target</code></span></dt><dd><p>The string to append the context to. If the argument is not a string,
it will be implicitly converted to a string.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.43.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">addContextFrom :: string -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.43.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 93. <code class="literal">lib.strings.addContextFrom</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">pkgs = import &lt;nixpkgs&gt; { };
addContextFrom pkgs.coreutils &quot;bar&quot;
=&gt; &quot;bar&quot;
</code></pre><p>The context can be displayed using the <code class="literal">toString</code> function:</p><pre><code class="programlisting nix">nix-repl&gt; builtins.getContext (lib.strings.addContextFrom pkgs.coreutils &quot;bar&quot;)
{
  &quot;/nix/store/m1s1d2dk2dqqlw3j90jl3cjy2cykbdxz-coreutils-9.5.drv&quot; = { ... };
}
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1645"  target="_top">lib/strings.nix:1645</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.splitString" class="title" ><code class="literal">lib.strings.splitString</code>   </h4>  </div> </div></div><p>Cut a string with a separator and produces a list of strings which
were separated by this separator.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.44.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">sep</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">s</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.44.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">splitString :: string -&gt; string -&gt; [string]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.44.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 94. <code class="literal">lib.strings.splitString</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">splitString &quot;.&quot; &quot;foo.bar.baz&quot;
=&gt; [ &quot;foo&quot; &quot;bar&quot; &quot;baz&quot; ]
splitString &quot;/&quot; &quot;/usr/local/bin&quot;
=&gt; [ &quot;&quot; &quot;usr&quot; &quot;local&quot; &quot;bin&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1678"  target="_top">lib/strings.nix:1678</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.splitStringBy" class="title" ><code class="literal">lib.strings.splitStringBy</code>   </h4>  </div> </div></div><p>Splits a string into substrings based on a predicate that examines adjacent characters.</p><p>This function provides a flexible way to split strings by checking pairs of characters
against a custom predicate function. Unlike simpler splitting functions, this allows
for context-aware splitting based on character transitions and patterns.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.45.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">predicate</code></span></dt><dd><p>Function that takes two arguments (previous character and current character)
and returns true when the string should be split at the current position.
For the first character, previous will be “” (empty string).</p></dd><dt><span class="term"><code class="literal">keepSplit</code></span></dt><dd><p>Boolean that determines whether the splitting character should be kept as
part of the result. If true, the character will be included at the beginning
of the next substring; if false, it will be discarded.</p></dd><dt><span class="term"><code class="literal">str</code></span></dt><dd><p>The input string to split.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.45.2" class="title" >Return   </h5>  </div> </div></div><p>A list of substrings from the original string, split according to the predicate.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.45.3" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">splitStringBy :: (string -&gt; string -&gt; bool) -&gt; bool -&gt; string -&gt; [string]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.45.4" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 95. <code class="literal">lib.strings.splitStringBy</code> usage example</strong></span></summary><div class="example-contents"><p>Split on periods and hyphens, discarding the separators:</p><pre><code class="programlisting nix">splitStringBy (prev: curr: builtins.elem curr [ &quot;.&quot; &quot;-&quot; ]) false &quot;foo.bar-baz&quot;
=&gt; [ &quot;foo&quot; &quot;bar&quot; &quot;baz&quot; ]
</code></pre><p>Split on transitions from lowercase to uppercase, keeping the uppercase characters:</p><pre><code class="programlisting nix">splitStringBy (prev: curr: builtins.match &quot;[a-z]&quot; prev != null &amp;&amp; builtins.match &quot;[A-Z]&quot; curr != null) true &quot;fooBarBaz&quot;
=&gt; [ &quot;foo&quot; &quot;Bar&quot; &quot;Baz&quot; ]
</code></pre><p>Handle leading separators correctly:</p><pre><code class="programlisting nix">splitStringBy (prev: curr: builtins.elem curr [ &quot;.&quot; ]) false &quot;.foo.bar.baz&quot;
=&gt; [ &quot;&quot; &quot;foo&quot; &quot;bar&quot; &quot;baz&quot; ]
</code></pre><p>Handle trailing separators correctly:</p><pre><code class="programlisting nix">splitStringBy (prev: curr: builtins.elem curr [ &quot;.&quot; ]) false &quot;foo.bar.baz.&quot;
=&gt; [ &quot;foo&quot; &quot;bar&quot; &quot;baz&quot; &quot;&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1748"  target="_top">lib/strings.nix:1748</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.removePrefix" class="title" ><code class="literal">lib.strings.removePrefix</code>   </h4>  </div> </div></div><p>Return a string without the specified prefix, if the prefix matches.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.46.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">prefix</code></span></dt><dd><p>Prefix to remove if it matches</p></dd><dt><span class="term"><code class="literal">str</code></span></dt><dd><p>Input string</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.46.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">removePrefix :: string -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.46.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 96. <code class="literal">lib.strings.removePrefix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">removePrefix &quot;foo.&quot; &quot;foo.bar.baz&quot;
=&gt; &quot;bar.baz&quot;
removePrefix &quot;xxx&quot; &quot;foo.bar.baz&quot;
=&gt; &quot;foo.bar.baz&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1808"  target="_top">lib/strings.nix:1808</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.removeSuffix" class="title" ><code class="literal">lib.strings.removeSuffix</code>   </h4>  </div> </div></div><p>Return a string without the specified suffix, if the suffix matches.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.47.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">suffix</code></span></dt><dd><p>Suffix to remove if it matches</p></dd><dt><span class="term"><code class="literal">str</code></span></dt><dd><p>Input string</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.47.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">removeSuffix :: string -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.47.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 97. <code class="literal">lib.strings.removeSuffix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">removeSuffix &quot;front&quot; &quot;homefront&quot;
=&gt; &quot;home&quot;
removeSuffix &quot;xxx&quot; &quot;homefront&quot;
=&gt; &quot;homefront&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1859"  target="_top">lib/strings.nix:1859</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.versionOlder" class="title" ><code class="literal">lib.strings.versionOlder</code>   </h4>  </div> </div></div><p>Return true if string <code class="literal">v1</code> denotes a version older than <code class="literal">v2</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.48.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v1</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">v2</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.48.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">versionOlder :: String -&gt; String -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.48.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 98. <code class="literal">lib.strings.versionOlder</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">versionOlder &quot;1.1&quot; &quot;1.2&quot;
=&gt; true
versionOlder &quot;1.1&quot; &quot;1.1&quot;
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1910"  target="_top">lib/strings.nix:1910</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.versionAtLeast" class="title" ><code class="literal">lib.strings.versionAtLeast</code>   </h4>  </div> </div></div><p>Return true if string v1 denotes a version equal to or newer than v2.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.49.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v1</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">v2</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.49.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">versionAtLeast :: String -&gt; String -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.49.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 99. <code class="literal">lib.strings.versionAtLeast</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">versionAtLeast &quot;1.1&quot; &quot;1.0&quot;
=&gt; true
versionAtLeast &quot;1.1&quot; &quot;1.1&quot;
=&gt; true
versionAtLeast &quot;1.1&quot; &quot;1.2&quot;
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1944"  target="_top">lib/strings.nix:1944</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.getName" class="title" ><code class="literal">lib.strings.getName</code>   </h4>  </div> </div></div><p>This function takes an argument <code class="literal">x</code> that’s either a derivation or a
derivation’s “name” attribute and extracts the name part from that
argument.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.50.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.50.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getName :: String | Derivation -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.50.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 100. <code class="literal">lib.strings.getName</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">getName &quot;youtube-dl-2016.01.01&quot;
=&gt; &quot;youtube-dl&quot;
getName pkgs.youtube-dl
=&gt; &quot;youtube-dl&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L1975"  target="_top">lib/strings.nix:1975</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.getVersion" class="title" ><code class="literal">lib.strings.getVersion</code>   </h4>  </div> </div></div><p>This function takes an argument <code class="literal">x</code> that’s either a derivation or a
derivation’s “name” attribute and extracts the version part from that
argument.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.51.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.51.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getVersion :: String | Derivation -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.51.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 101. <code class="literal">lib.strings.getVersion</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">getVersion &quot;youtube-dl-2016.01.01&quot;
=&gt; &quot;2016.01.01&quot;
getVersion pkgs.youtube-dl
=&gt; &quot;2016.01.01&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2010"  target="_top">lib/strings.nix:2010</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.nameFromURL" class="title" ><code class="literal">lib.strings.nameFromURL</code>   </h4>  </div> </div></div><p>Extract name and version from a URL as shown in the examples.</p><p>Separator <code class="literal">sep</code> is used to determine the end of the extension.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.52.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">url</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">sep</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.52.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">nameFromURL :: String -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.52.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 102. <code class="literal">lib.strings.nameFromURL</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">nameFromURL &quot;https://nixos.org/releases/nix/nix-1.7/nix-1.7-x86_64-linux.tar.bz2&quot; &quot;-&quot;
=&gt; &quot;nix&quot;
nameFromURL &quot;https://nixos.org/releases/nix/nix-1.7/nix-1.7-x86_64-linux.tar.bz2&quot; &quot;_&quot;
=&gt; &quot;nix-1.7-x86&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2048"  target="_top">lib/strings.nix:2048</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.cmakeOptionType" class="title" ><code class="literal">lib.strings.cmakeOptionType</code>   </h4>  </div> </div></div><p>Create a <code class="literal">&quot;-D&lt;feature&gt;:&lt;type&gt;=&lt;value&gt;&quot;</code> string that can be passed to typical
CMake invocations.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.53.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">feature</code></span></dt><dd><p>The feature to be set</p></dd><dt><span class="term"><code class="literal">type</code></span></dt><dd><p>The type of the feature to be set, as described in
https://cmake.org/cmake/help/latest/command/set.html
the possible values (case insensitive) are:
BOOL FILEPATH PATH STRING INTERNAL LIST</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>The desired value</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.53.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">cmakeOptionType :: string -&gt; string -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.53.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 103. <code class="literal">lib.strings.cmakeOptionType</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">cmakeOptionType &quot;string&quot; &quot;ENGINE&quot; &quot;sdl2&quot;
=&gt; &quot;-DENGINE:STRING=sdl2&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2093"  target="_top">lib/strings.nix:2093</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.cmakeBool" class="title" ><code class="literal">lib.strings.cmakeBool</code>   </h4>  </div> </div></div><p>Create a -D&lt;condition&gt;={TRUE,FALSE} string that can be passed to typical
CMake invocations.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.54.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">condition</code></span></dt><dd><p>The condition to be made true or false</p></dd><dt><span class="term"><code class="literal">flag</code></span></dt><dd><p>The controlling flag of the condition</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.54.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">cmakeBool :: string -&gt; bool -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.54.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 104. <code class="literal">lib.strings.cmakeBool</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">cmakeBool &quot;ENABLE_STATIC_LIBS&quot; false
=&gt; &quot;-DENABLESTATIC_LIBS:BOOL=FALSE&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2139"  target="_top">lib/strings.nix:2139</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.cmakeFeature" class="title" ><code class="literal">lib.strings.cmakeFeature</code>   </h4>  </div> </div></div><p>Create a -D&lt;feature&gt;:STRING=&lt;value&gt; string that can be passed to typical
CMake invocations.
This is the most typical usage, so it deserves a special case.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.55.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">feature</code></span></dt><dd><p>The feature to be set</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>The desired value</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.55.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">cmakeFeature :: string -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.55.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 105. <code class="literal">lib.strings.cmakeFeature</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">cmakeFeature &quot;MODULES&quot; &quot;badblock&quot;
=&gt; &quot;-DMODULES:STRING=badblock&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2175"  target="_top">lib/strings.nix:2175</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.mesonOption" class="title" ><code class="literal">lib.strings.mesonOption</code>   </h4>  </div> </div></div><p>Create a -D&lt;feature&gt;=&lt;value&gt; string that can be passed to typical Meson
invocations.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.56.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">feature</code></span></dt><dd><p>The feature to be set</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>The desired value</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.56.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mesonOption :: string -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.56.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 106. <code class="literal">lib.strings.mesonOption</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mesonOption &quot;engine&quot; &quot;opengl&quot;
=&gt; &quot;-Dengine=opengl&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2210"  target="_top">lib/strings.nix:2210</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.mesonBool" class="title" ><code class="literal">lib.strings.mesonBool</code>   </h4>  </div> </div></div><p>Create a -D&lt;condition&gt;={true,false} string that can be passed to typical
Meson invocations.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.57.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">condition</code></span></dt><dd><p>The condition to be made true or false</p></dd><dt><span class="term"><code class="literal">flag</code></span></dt><dd><p>The controlling flag of the condition</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.57.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mesonBool :: string -&gt; bool -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.57.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 107. <code class="literal">lib.strings.mesonBool</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mesonBool &quot;hardened&quot; true
=&gt; &quot;-Dhardened=true&quot;
mesonBool &quot;static&quot; false
=&gt; &quot;-Dstatic=false&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2247"  target="_top">lib/strings.nix:2247</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.mesonEnable" class="title" ><code class="literal">lib.strings.mesonEnable</code>   </h4>  </div> </div></div><p>Create a -D&lt;feature&gt;={enabled,disabled} string that can be passed to
typical Meson invocations.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.58.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">feature</code></span></dt><dd><p>The feature to be enabled or disabled</p></dd><dt><span class="term"><code class="literal">flag</code></span></dt><dd><p>The controlling flag</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.58.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mesonEnable :: string -&gt; bool -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.58.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 108. <code class="literal">lib.strings.mesonEnable</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mesonEnable &quot;docs&quot; true
=&gt; &quot;-Ddocs=enabled&quot;
mesonEnable &quot;savage&quot; false
=&gt; &quot;-Dsavage=disabled&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2284"  target="_top">lib/strings.nix:2284</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.enableFeature" class="title" ><code class="literal">lib.strings.enableFeature</code>   </h4>  </div> </div></div><p>Create an --{enable,disable}-&lt;feature&gt; string that can be passed to
standard GNU Autoconf scripts.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.59.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">flag</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">feature</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.59.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">enableFeature :: bool -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.59.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 109. <code class="literal">lib.strings.enableFeature</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">enableFeature true &quot;shared&quot;
=&gt; &quot;--enable-shared&quot;
enableFeature false &quot;shared&quot;
=&gt; &quot;--disable-shared&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2321"  target="_top">lib/strings.nix:2321</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.enableFeatureAs" class="title" ><code class="literal">lib.strings.enableFeatureAs</code>   </h4>  </div> </div></div><p>Create an --{enable-&lt;feature&gt;=&lt;value&gt;,disable-&lt;feature&gt;} string that can be passed to
standard GNU Autoconf scripts.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.60.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">flag</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">feature</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.60.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">enableFeatureAs :: bool -&gt; string -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.60.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 110. <code class="literal">lib.strings.enableFeatureAs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">enableFeatureAs true &quot;shared&quot; &quot;foo&quot;
=&gt; &quot;--enable-shared=foo&quot;
enableFeatureAs false &quot;shared&quot; (throw &quot;ignored&quot;)
=&gt; &quot;--disable-shared&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2361"  target="_top">lib/strings.nix:2361</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.withFeature" class="title" ><code class="literal">lib.strings.withFeature</code>   </h4>  </div> </div></div><p>Create an --{with,without}-&lt;feature&gt; string that can be passed to
standard GNU Autoconf scripts.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.61.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">flag</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">feature</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.61.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">withFeature :: bool -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.61.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 111. <code class="literal">lib.strings.withFeature</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">withFeature true &quot;shared&quot;
=&gt; &quot;--with-shared&quot;
withFeature false &quot;shared&quot;
=&gt; &quot;--without-shared&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2396"  target="_top">lib/strings.nix:2396</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.withFeatureAs" class="title" ><code class="literal">lib.strings.withFeatureAs</code>   </h4>  </div> </div></div><p>Create an --{with-&lt;feature&gt;=&lt;value&gt;,without-&lt;feature&gt;} string that can be passed to
standard GNU Autoconf scripts.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.62.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">flag</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">feature</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.62.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">withFeatureAs :: bool -&gt; string -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.62.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 112. <code class="literal">lib.strings.withFeatureAs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">withFeatureAs true &quot;shared&quot; &quot;foo&quot;
=&gt; &quot;--with-shared=foo&quot;
withFeatureAs false &quot;shared&quot; (throw &quot;ignored&quot;)
=&gt; &quot;--without-shared&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2435"  target="_top">lib/strings.nix:2435</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.fixedWidthString" class="title" ><code class="literal">lib.strings.fixedWidthString</code>   </h4>  </div> </div></div><p>Create a fixed width string with additional prefix to match
required width.</p><p>This function will fail if the input string is longer than the
requested length.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.63.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">width</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">filler</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">str</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.63.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">fixedWidthString :: int -&gt; string -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.63.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 113. <code class="literal">lib.strings.fixedWidthString</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">fixedWidthString 5 &quot;0&quot; (toString 15)
=&gt; &quot;00015&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2474"  target="_top">lib/strings.nix:2474</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.fixedWidthNumber" class="title" ><code class="literal">lib.strings.fixedWidthNumber</code>   </h4>  </div> </div></div><p>Format a number adding leading zeroes up to fixed width.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.64.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">width</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">n</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.64.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">fixedWidthNumber :: int -&gt; int -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.64.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 114. <code class="literal">lib.strings.fixedWidthNumber</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">fixedWidthNumber 5 15
=&gt; &quot;00015&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2512"  target="_top">lib/strings.nix:2512</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.floatToString" class="title" ><code class="literal">lib.strings.floatToString</code>   </h4>  </div> </div></div><p>Convert a float to a string, but emit a warning when precision is lost
during the conversion</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.65.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">float</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.65.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">floatToString :: float -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.65.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 115. <code class="literal">lib.strings.floatToString</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">floatToString 0.000001
=&gt; &quot;0.000001&quot;
floatToString 0.0000001
=&gt; trace: warning: Imprecise conversion from float to string 0.000000
   &quot;0.000000&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2543"  target="_top">lib/strings.nix:2543</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.isCoercibleToString" class="title" ><code class="literal">lib.strings.isCoercibleToString</code>   </h4>  </div> </div></div><p>Check whether a value <code class="literal">val</code> can be coerced to a string.</p><div class="warning"><h3 class="title">Warning</h3><p>Soft-deprecated function. While the original implementation is available as
<code class="literal">isConvertibleWithToString</code>, consider using <code class="literal">isStringLike</code> instead, if suitable.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.66.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">val</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.66.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">isCoercibleToString :: a -&gt; bool
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2570"  target="_top">lib/strings.nix:2570</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.isConvertibleWithToString" class="title" ><code class="literal">lib.strings.isConvertibleWithToString</code>   </h4>  </div> </div></div><p>Check whether a list or other value <code class="literal">x</code> can be passed to toString.</p><p>Many types of value are coercible to string this way, including <code class="literal">int</code>, <code class="literal">float</code>,
<code class="literal">null</code>, <code class="literal">bool</code>, <code class="literal">list</code> of similarly coercible values.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.67.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">val</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.67.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">isConvertibleWithToString :: a -&gt; bool
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2592"  target="_top">lib/strings.nix:2592</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.isStringLike" class="title" ><code class="literal">lib.strings.isStringLike</code>   </h4>  </div> </div></div><p>Check whether a value can be coerced to a string.
The value must be a string, path, or attribute set.</p><p>String-like values can be used without explicit conversion in
string interpolations and in most functions that expect a string.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.68.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.68.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">isStringLike :: a -&gt; bool
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2621"  target="_top">lib/strings.nix:2621</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.isStorePath" class="title" ><code class="literal">lib.strings.isStorePath</code>   </h4>  </div> </div></div><p>Check whether a value <code class="literal">x</code> is a store path.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.69.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.69.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">isStorePath :: a -&gt; bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.69.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 116. <code class="literal">lib.strings.isStorePath</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">isStorePath &quot;/nix/store/d945ibfx9x185xf04b890y4f9g3cbb63-python-2.7.11/bin/python&quot;
=&gt; false
isStorePath &quot;/nix/store/d945ibfx9x185xf04b890y4f9g3cbb63-python-2.7.11&quot;
=&gt; true
isStorePath pkgs.python
=&gt; true
isStorePath [] || isStorePath 42 || isStorePath {} || …
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2654"  target="_top">lib/strings.nix:2654</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.toInt" class="title" ><code class="literal">lib.strings.toInt</code>   </h4>  </div> </div></div><p>Parse a string as an int. Does not support parsing of integers with preceding zero due to
ambiguity between zero-padded and octal numbers. See toIntBase10.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.70.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">str</code></span></dt><dd><p>A string to be interpreted as an int.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.70.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toInt :: string -&gt; int
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.70.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 117. <code class="literal">lib.strings.toInt</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">toInt &quot;1337&quot;
=&gt; 1337

toInt &quot;-4&quot;
=&gt; -4

toInt &quot; 123 &quot;
=&gt; 123

toInt &quot;00024&quot;
=&gt; error: Ambiguity in interpretation of 00024 between octal and zero padded integer.

toInt &quot;3.14&quot;
=&gt; error: floating point JSON numbers are not supported
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2711"  target="_top">lib/strings.nix:2711</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.toIntBase10" class="title" ><code class="literal">lib.strings.toIntBase10</code>   </h4>  </div> </div></div><p>Parse a string as a base 10 int. This supports parsing of zero-padded integers.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.71.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">str</code></span></dt><dd><p>A string to be interpreted as an int.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.71.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toIntBase10 :: string -&gt; int
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.71.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 118. <code class="literal">lib.strings.toIntBase10</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">toIntBase10 &quot;1337&quot;
=&gt; 1337

toIntBase10 &quot;-4&quot;
=&gt; -4

toIntBase10 &quot; 123 &quot;
=&gt; 123

toIntBase10 &quot;00024&quot;
=&gt; 24

toIntBase10 &quot;3.14&quot;
=&gt; error: floating point JSON numbers are not supported
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2781"  target="_top">lib/strings.nix:2781</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.readPathsFromFile" class="title" ><code class="literal">lib.strings.readPathsFromFile</code>   </h4>  </div> </div></div><p>Read a list of paths from <code class="literal">file</code>, relative to the <code class="literal">rootPath</code>.
Lines beginning with <code class="literal">#</code> are treated as comments and ignored.
Whitespace is significant.</p><div class="warning"><h3 class="title">Warning</h3><p>This function is deprecated and should be avoided.</p></div><div class="note"><h3 class="title">Note</h3><p>This function is not performant and should be avoided.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.72.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">rootPath</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">file</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.72.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">readPathsFromFile :: string -&gt; string -&gt; [string]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.72.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 119. <code class="literal">lib.strings.readPathsFromFile</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">readPathsFromFile /prefix
  ./pkgs/development/libraries/qt-5/5.4/qtbase/series
=&gt; [ &quot;/prefix/dlopen-resolv.patch&quot; &quot;/prefix/tzdir.patch&quot;
     &quot;/prefix/dlopen-libXcursor.patch&quot; &quot;/prefix/dlopen-openssl.patch&quot;
     &quot;/prefix/dlopen-dbus.patch&quot; &quot;/prefix/xdg-config-dirs.patch&quot;
     &quot;/prefix/nix-profiles-library-paths.patch&quot;
     &quot;/prefix/compose-search-path.patch&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2858"  target="_top">lib/strings.nix:2858</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.fileContents" class="title" ><code class="literal">lib.strings.fileContents</code>   </h4>  </div> </div></div><p>Read the contents of a file removing the trailing \n</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.73.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">file</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.73.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">fileContents :: path -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.73.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 120. <code class="literal">lib.strings.fileContents</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">$ echo &quot;1.0&quot; &gt; ./version

fileContents ./version
=&gt; &quot;1.0&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2896"  target="_top">lib/strings.nix:2896</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.sanitizeDerivationName" class="title" ><code class="literal">lib.strings.sanitizeDerivationName</code>   </h4>  </div> </div></div><p>Creates a valid derivation name from a potentially invalid one.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.74.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">string</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.74.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">sanitizeDerivationName :: String -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.74.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 121. <code class="literal">lib.strings.sanitizeDerivationName</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">sanitizeDerivationName &quot;../hello.bar # foo&quot;
=&gt; &quot;-hello.bar-foo&quot;
sanitizeDerivationName &quot;&quot;
=&gt; &quot;unknown&quot;
sanitizeDerivationName pkgs.hello
=&gt; &quot;-nix-store-2g75chlbpxlrqn15zlby2dfh8hr9qwbk-hello-2.10&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2927"  target="_top">lib/strings.nix:2927</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.levenshtein" class="title" ><code class="literal">lib.strings.levenshtein</code>   </h4>  </div> </div></div><p>Computes the Levenshtein distance between two strings <code class="literal">a</code> and <code class="literal">b</code>.</p><p>Complexity O(n*m) where n and m are the lengths of the strings.
Algorithm adjusted from https://stackoverflow.com/a/9750974/6605742</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.75.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">a</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">b</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.75.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">levenshtein :: string -&gt; string -&gt; int
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.75.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 122. <code class="literal">lib.strings.levenshtein</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">levenshtein &quot;foo&quot; &quot;foo&quot;
=&gt; 0
levenshtein &quot;book&quot; &quot;hook&quot;
=&gt; 1
levenshtein &quot;hello&quot; &quot;Heyo&quot;
=&gt; 3
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L2989"  target="_top">lib/strings.nix:2989</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.commonPrefixLength" class="title" ><code class="literal">lib.strings.commonPrefixLength</code>   </h4>  </div> </div></div><p>Returns the length of the prefix that appears in both strings <code class="literal">a</code> and <code class="literal">b</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.76.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">a</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">b</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.76.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">commonPrefixLength :: string -&gt; string -&gt; int
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L3026"  target="_top">lib/strings.nix:3026</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.commonSuffixLength" class="title" ><code class="literal">lib.strings.commonSuffixLength</code>   </h4>  </div> </div></div><p>Returns the length of the suffix common to both strings <code class="literal">a</code> and <code class="literal">b</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.77.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">a</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">b</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.77.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">commonSuffixLength :: string -&gt; string -&gt; int
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L3058"  target="_top">lib/strings.nix:3058</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.strings.levenshteinAtMost" class="title" ><code class="literal">lib.strings.levenshteinAtMost</code>   </h4>  </div> </div></div><p>Returns whether the levenshtein distance between two strings <code class="literal">a</code> and <code class="literal">b</code> is at most some value <code class="literal">k</code>.</p><p>Complexity is O(min(n,m)) for k &lt;= 2 and O(n*m) otherwise</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.78.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">k</code></span></dt><dd><p>Distance threshold</p></dd><dt><span class="term"><code class="literal">a</code></span></dt><dd><p>String <code class="literal">a</code></p></dd><dt><span class="term"><code class="literal">b</code></span></dt><dd><p>String <code class="literal">b</code></p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.78.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">levenshteinAtMost :: int -&gt; string -&gt; string -&gt; bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-8-1.78.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 123. <code class="literal">lib.strings.levenshteinAtMost</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">levenshteinAtMost 0 &quot;foo&quot; &quot;foo&quot;
=&gt; true
levenshteinAtMost 1 &quot;foo&quot; &quot;boa&quot;
=&gt; false
levenshteinAtMost 2 &quot;foo&quot; &quot;boa&quot;
=&gt; true
levenshteinAtMost 2 &quot;This is a sentence&quot; &quot;this is a sentense.&quot;
=&gt; false
levenshteinAtMost 3 &quot;This is a sentence&quot; &quot;this is a sentense.&quot;
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/strings.nix#L3114"  target="_top">lib/strings.nix:3114</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-versions" class="title" >lib.versions: version string functions   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.versions.splitVersion" class="title" ><code class="literal">lib.versions.splitVersion</code>   </h4>  </div> </div></div><p>Break a version string into its component parts.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-9-1.1.1" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 124. <code class="literal">splitVersion</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">splitVersion &quot;1.2.3&quot;
=&gt; [&quot;1&quot; &quot;2&quot; &quot;3&quot;]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/versions.nix#L20"  target="_top">lib/versions.nix:20</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.versions.major" class="title" ><code class="literal">lib.versions.major</code>   </h4>  </div> </div></div><p>Get the major version string from a string.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-9-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-9-1.2.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 125. <code class="literal">major</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">major &quot;1.2.3&quot;
=&gt; &quot;1&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/versions.nix#L42"  target="_top">lib/versions.nix:42</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.versions.minor" class="title" ><code class="literal">lib.versions.minor</code>   </h4>  </div> </div></div><p>Get the minor version string from a string.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-9-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-9-1.3.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 126. <code class="literal">minor</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">minor &quot;1.2.3&quot;
=&gt; &quot;2&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/versions.nix#L64"  target="_top">lib/versions.nix:64</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.versions.patch" class="title" ><code class="literal">lib.versions.patch</code>   </h4>  </div> </div></div><p>Get the patch version string from a string.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-9-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-9-1.4.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 127. <code class="literal">patch</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">patch &quot;1.2.3&quot;
=&gt; &quot;3&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/versions.nix#L86"  target="_top">lib/versions.nix:86</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.versions.majorMinor" class="title" ><code class="literal">lib.versions.majorMinor</code>   </h4>  </div> </div></div><p>Get string of the first two parts (major and minor)
of a version string.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-9-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-9-1.5.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 128. <code class="literal">majorMinor</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">majorMinor &quot;1.2.3&quot;
=&gt; &quot;1.2&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/versions.nix#L109"  target="_top">lib/versions.nix:109</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.versions.pad" class="title" ><code class="literal">lib.versions.pad</code>   </h4>  </div> </div></div><p>Pad a version string with zeros to match the given number of components.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-9-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">n</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">version</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-9-1.6.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 129. <code class="literal">pad</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">pad 3 &quot;1.2&quot;
=&gt; &quot;1.2.0&quot;
pad 3 &quot;1.3-rc1&quot;
=&gt; &quot;1.3.0-rc1&quot;
pad 3 &quot;1.2.3.4&quot;
=&gt; &quot;1.2.3&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/versions.nix#L139"  target="_top">lib/versions.nix:139</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-trivial" class="title" >lib.trivial: miscellaneous functions   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.id" class="title" ><code class="literal">lib.trivial.id</code>   </h4>  </div> </div></div><p>The identity function
For when you need a function that does “nothing”.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>The value to return</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.1.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">id :: a -&gt; a
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L40"  target="_top">lib/trivial.nix:40</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.const" class="title" ><code class="literal">lib.trivial.const</code>   </h4>  </div> </div></div><p>The constant function</p><p>Ignores the second argument. If called with only one argument,
constructs a function that always returns a static value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>Value to return</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>Value to ignore</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">const :: a -&gt; b -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.2.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 130. <code class="literal">lib.trivial.const</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">let f = const 5; in f 10
=&gt; 5
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L75"  target="_top">lib/trivial.nix:75</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.pipe" class="title" ><code class="literal">lib.trivial.pipe</code>   </h4>  </div> </div></div><p>Pipes a value through a list of functions, left to right.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>Value to start piping.</p></dd><dt><span class="term"><code class="literal">fns</code></span></dt><dd><p>List of functions to apply sequentially.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">pipe :: a -&gt; [&lt;functions&gt;] -&gt; &lt;return type of last function&gt;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.3.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 131. <code class="literal">lib.trivial.pipe</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">pipe 2 [
    (x: x + 2)  # 2 + 2 = 4
    (x: x * 2)  # 4 * 2 = 8
  ]
=&gt; 8

# ideal to do text transformations
pipe [ &quot;a/b&quot; &quot;a/c&quot; ] [

  # create the cp command
  (map (file: &#x27;&#x27;cp &quot;${src}/${file}&quot; $out\n&#x27;&#x27;))

  # concatenate all commands into one string
  lib.concatStrings

  # make that string into a nix derivation
  (pkgs.runCommand &quot;copy-to-out&quot; {})

]
=&gt; &lt;drv which copies all files to $out&gt;

The output type of each function has to be the input type
of the next function, and the last function returns the
final value.
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L129"  target="_top">lib/trivial.nix:129</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.concat" class="title" ><code class="literal">lib.trivial.concat</code>   </h4>  </div> </div></div><p>Concatenate two lists</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">concat :: [a] -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.4.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 132. <code class="literal">lib.trivial.concat</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concat [ 1 2 ] [ 3 4 ]
=&gt; [ 1 2 3 4 ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L168"  target="_top">lib/trivial.nix:168</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.or" class="title" ><code class="literal">lib.trivial.or</code>   </h4>  </div> </div></div><p>boolean “or”</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L183"  target="_top">lib/trivial.nix:183</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.and" class="title" ><code class="literal">lib.trivial.and</code>   </h4>  </div> </div></div><p>boolean “and”</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L198"  target="_top">lib/trivial.nix:198</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.xor" class="title" ><code class="literal">lib.trivial.xor</code>   </h4>  </div> </div></div><p>boolean “exclusive or”</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.7.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L215"  target="_top">lib/trivial.nix:215</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.bitNot" class="title" ><code class="literal">lib.trivial.bitNot</code>   </h4>  </div> </div></div><p>bitwise “not”</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L220"  target="_top">lib/trivial.nix:220</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.boolToString" class="title" ><code class="literal">lib.trivial.boolToString</code>   </h4>  </div> </div></div><p>Convert a boolean to a string.</p><p>This function uses the strings “true” and “false” to represent
boolean values. Calling <code class="literal">toString</code> on a bool instead returns “1”
and “” (sic!).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.9.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">b</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.9.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">boolToString :: bool -&gt; string
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L241"  target="_top">lib/trivial.nix:241</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.mergeAttrs" class="title" ><code class="literal">lib.trivial.mergeAttrs</code>   </h4>  </div> </div></div><p>Merge two attribute sets shallowly, right side trumps left</p><p>mergeAttrs :: attrs -&gt; attrs -&gt; attrs</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.10.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>Left attribute set</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>Right attribute set (higher precedence for equal keys)</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.10.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 133. <code class="literal">lib.trivial.mergeAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mergeAttrs { a = 1; b = 2; } { b = 3; c = 4; }
=&gt; { a = 1; b = 3; c = 4; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L269"  target="_top">lib/trivial.nix:269</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.flip" class="title" ><code class="literal">lib.trivial.flip</code>   </h4>  </div> </div></div><p>Flip the order of the arguments of a binary function.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.11.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">a</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">b</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.11.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">flip :: (a -&gt; b -&gt; c) -&gt; (b -&gt; a -&gt; c)
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.11.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 134. <code class="literal">lib.trivial.flip</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">flip concat [1] [2]
=&gt; [ 2 1 ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L305"  target="_top">lib/trivial.nix:305</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.defaultTo" class="title" ><code class="literal">lib.trivial.defaultTo</code>   </h4>  </div> </div></div><p>Return <code class="literal">maybeValue</code> if not null, otherwise return <code class="literal">default</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.12.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">default</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">maybeValue</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.12.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 135. <code class="literal">lib.trivial.defaultTo</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">defaultTo &quot;default&quot; null
=&gt; &quot;default&quot;
defaultTo &quot;default&quot; &quot;foo&quot;
=&gt; &quot;foo&quot;
defaultTo &quot;default&quot; false
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L337"  target="_top">lib/trivial.nix:337</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.mapNullable" class="title" ><code class="literal">lib.trivial.mapNullable</code>   </h4>  </div> </div></div><p>Apply function if the supplied argument is non-null.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.13.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>Function to call</p></dd><dt><span class="term"><code class="literal">a</code></span></dt><dd><p>Argument to check for null before passing it to <code class="literal">f</code></p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.13.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 136. <code class="literal">lib.trivial.mapNullable</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mapNullable (x: x+1) null
=&gt; null
mapNullable (x: x+1) 22
=&gt; 23
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L365"  target="_top">lib/trivial.nix:365</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.version" class="title" ><code class="literal">lib.trivial.version</code>   </h4>  </div> </div></div><p>Returns the current full nixpkgs version number.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L390"  target="_top">lib/trivial.nix:390</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.release" class="title" ><code class="literal">lib.trivial.release</code>   </h4>  </div> </div></div><p>Returns the current nixpkgs release number as string.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L395"  target="_top">lib/trivial.nix:395</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.oldestSupportedRelease" class="title" ><code class="literal">lib.trivial.oldestSupportedRelease</code>   </h4>  </div> </div></div><p>The latest release that is supported, at the time of release branch-off,
if applicable.</p><p>Ideally, out-of-tree modules should be able to evaluate cleanly with all
supported Nixpkgs versions (master, release and old release until EOL).
So if possible, deprecation warnings should take effect only when all
out-of-tree expressions/libs/modules can upgrade to the new way without
losing support for supported Nixpkgs versions.</p><p>This release number allows deprecation warnings to be implemented such that
they take effect as soon as the oldest release reaches end of life.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L410"  target="_top">lib/trivial.nix:410</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.isInOldestRelease" class="title" ><code class="literal">lib.trivial.isInOldestRelease</code>   </h4>  </div> </div></div><p>Whether a feature is supported in all supported releases (at the time of
release branch-off, if applicable). See <code class="literal">oldestSupportedRelease</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.17.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">release</code></span></dt><dd><p>Release number of feature introduction as an integer, e.g. 2111 for 21.11.
Set it to the upcoming release, matching the nixpkgs/.version file.</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L425"  target="_top">lib/trivial.nix:425</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.oldestSupportedReleaseIsAtLeast" class="title" ><code class="literal">lib.trivial.oldestSupportedReleaseIsAtLeast</code>   </h4>  </div> </div></div><p>Alias for <code class="literal">isInOldestRelease</code> introduced in 24.11.
Use <code class="literal">isInOldestRelease</code> in expressions outside of Nixpkgs for greater compatibility.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L434"  target="_top">lib/trivial.nix:434</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.codeName" class="title" ><code class="literal">lib.trivial.codeName</code>   </h4>  </div> </div></div><p>Returns the current nixpkgs release code name.</p><p>On each release the first letter is bumped and a new animal is chosen
starting with that new letter.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L442"  target="_top">lib/trivial.nix:442</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.versionSuffix" class="title" ><code class="literal">lib.trivial.versionSuffix</code>   </h4>  </div> </div></div><p>Returns the current nixpkgs version suffix as string.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L447"  target="_top">lib/trivial.nix:447</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.revisionWithDefault" class="title" ><code class="literal">lib.trivial.revisionWithDefault</code>   </h4>  </div> </div></div><p>Attempts to return the the current revision of nixpkgs and
returns the supplied default value otherwise.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.21.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">default</code></span></dt><dd><p>Default value to return if revision can not be determined</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.21.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">revisionWithDefault :: string -&gt; string
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L469"  target="_top">lib/trivial.nix:469</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.inNixShell" class="title" ><code class="literal">lib.trivial.inNixShell</code>   </h4>  </div> </div></div><p>Determine whether the function is being called from inside a Nix
shell.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.22.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">inNixShell :: bool
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L494"  target="_top">lib/trivial.nix:494</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.inPureEvalMode" class="title" ><code class="literal">lib.trivial.inPureEvalMode</code>   </h4>  </div> </div></div><p>Determine whether the function is being called from inside pure-eval mode
by seeing whether <code class="literal">builtins</code> contains <code class="literal">currentSystem</code>. If not, we must be in
pure-eval mode.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.23.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">inPureEvalMode :: bool
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L507"  target="_top">lib/trivial.nix:507</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.min" class="title" ><code class="literal">lib.trivial.min</code>   </h4>  </div> </div></div><p>Return minimum of two numbers.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.24.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L524"  target="_top">lib/trivial.nix:524</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.max" class="title" ><code class="literal">lib.trivial.max</code>   </h4>  </div> </div></div><p>Return maximum of two numbers.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.25.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L539"  target="_top">lib/trivial.nix:539</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.mod" class="title" ><code class="literal">lib.trivial.mod</code>   </h4>  </div> </div></div><p>Integer modulus</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.26.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">base</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">int</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.26.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 137. <code class="literal">lib.trivial.mod</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mod 11 10
=&gt; 1
mod 1 10
=&gt; 1
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L567"  target="_top">lib/trivial.nix:567</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.compare" class="title" ><code class="literal">lib.trivial.compare</code>   </h4>  </div> </div></div><p>C-style comparisons</p><p>a &lt; b,  compare a b =&gt; -1
a == b, compare a b =&gt; 0
a &gt; b,  compare a b =&gt; 1</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.27.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">a</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">b</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L588"  target="_top">lib/trivial.nix:588</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.splitByAndCompare" class="title" ><code class="literal">lib.trivial.splitByAndCompare</code>   </h4>  </div> </div></div><p>Split type into two subtypes by predicate <code class="literal">p</code>, take all elements
of the first subtype to be less than all the elements of the
second subtype, compare elements of a single subtype with <code class="literal">yes</code>
and <code class="literal">no</code> respectively.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.28.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">p</code></span></dt><dd><p>Predicate</p></dd><dt><span class="term"><code class="literal">yes</code></span></dt><dd><p>Comparison function if predicate holds for both values</p></dd><dt><span class="term"><code class="literal">no</code></span></dt><dd><p>Comparison function if predicate holds for neither value</p></dd><dt><span class="term"><code class="literal">a</code></span></dt><dd><p>First value to compare</p></dd><dt><span class="term"><code class="literal">b</code></span></dt><dd><p>Second value to compare</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.28.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">(a -&gt; bool) -&gt; (a -&gt; a -&gt; int) -&gt; (a -&gt; a -&gt; int) -&gt; (a -&gt; a -&gt; int)
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.28.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 138. <code class="literal">lib.trivial.splitByAndCompare</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">let cmp = splitByAndCompare (hasPrefix &quot;foo&quot;) compare compare; in

cmp &quot;a&quot; &quot;z&quot; =&gt; -1
cmp &quot;fooa&quot; &quot;fooz&quot; =&gt; -1

cmp &quot;f&quot; &quot;a&quot; =&gt; 1
cmp &quot;fooa&quot; &quot;a&quot; =&gt; -1
# while
compare &quot;fooa&quot; &quot;a&quot; =&gt; 1
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L649"  target="_top">lib/trivial.nix:649</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.importJSON" class="title" ><code class="literal">lib.trivial.importJSON</code>   </h4>  </div> </div></div><p>Reads a JSON file.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.29.1" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 139. <code class="literal">lib.trivial.importJSON</code> usage example</strong></span></summary><div class="example-contents"><p>example.json</p><pre><code class="programlisting json">{
  &quot;title&quot;: &quot;Example JSON&quot;,
  &quot;hello&quot;: {
    &quot;world&quot;: &quot;foo&quot;,
    &quot;bar&quot;: {
      &quot;foobar&quot;: true
    }
  }
}
</code></pre><pre><code class="programlisting nix">importJSON ./example.json
=&gt; {
  title = &quot;Example JSON&quot;;
  hello = {
    world = &quot;foo&quot;;
    bar = {
      foobar = true;
    };
  };
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.29.2" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.29.3" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">importJSON :: path -&gt; any
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L705"  target="_top">lib/trivial.nix:705</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.importTOML" class="title" ><code class="literal">lib.trivial.importTOML</code>   </h4>  </div> </div></div><p>Reads a TOML file.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.30.1" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 140. <code class="literal">lib.trivial.importTOML</code> usage example</strong></span></summary><div class="example-contents"><p>example.toml</p><pre><code class="programlisting toml">title = &quot;TOML Example&quot;

[hello]
world = &quot;foo&quot;

[hello.bar]
foobar = true
</code></pre><pre><code class="programlisting nix">importTOML ./example.toml
=&gt; {
  title = &quot;TOML Example&quot;;
  hello = {
    world = &quot;foo&quot;;
    bar = {
      foobar = true;
    };
  };
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.30.2" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.30.3" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">importTOML :: path -&gt; any
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L752"  target="_top">lib/trivial.nix:752</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.warn" class="title" ><code class="literal">lib.trivial.warn</code>   </h4>  </div> </div></div><p><code class="literal">warn</code> <span class="emphasis"><em><code class="literal">message</code></em></span> <span class="emphasis"><em><code class="literal">value</code></em></span></p><p>Print a warning before returning the second argument.</p><p>See <a class="link" href="https://nix.dev/manual/nix/latest/language/builtins.html#builtins-warn"  target="_top"><code class="literal">builtins.warn</code></a> (Nix &gt;= 2.23).
On older versions, the Nix 2.23 behavior is emulated with <a class="link" href="https://nix.dev/manual/nix/latest/language/builtins.html#builtins-warn"  target="_top"><code class="literal">builtins.trace</code></a>, including the <a class="link" href="https://nix.dev/manual/nix/latest/command-ref/conf-file#conf-abort-on-warn"  target="_top"><code class="literal">NIX_ABORT_ON_WARN</code></a> behavior, but not the <code class="literal">nix.conf</code> setting or command line option.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.31.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em><code class="literal">message</code></em></span> (String)</span></dt><dd><p>Warning message to print before evaluating <span class="emphasis"><em><code class="literal">value</code></em></span>.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">value</code></em></span> (any value)</span></dt><dd><p>Value to return as-is.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.31.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">String -&gt; a -&gt; a
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L778"  target="_top">lib/trivial.nix:778</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.warnIf" class="title" ><code class="literal">lib.trivial.warnIf</code>   </h4>  </div> </div></div><p><code class="literal">warnIf</code> <span class="emphasis"><em><code class="literal">condition</code></em></span> <span class="emphasis"><em><code class="literal">message</code></em></span> <span class="emphasis"><em><code class="literal">value</code></em></span></p><p>Like <code class="literal">warn</code>, but only warn when the first argument is <code class="literal">true</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.32.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em><code class="literal">condition</code></em></span> (Boolean)</span></dt><dd><p><code class="literal">true</code> to trigger the warning before continuing with <span class="emphasis"><em><code class="literal">value</code></em></span>.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">message</code></em></span> (String)</span></dt><dd><p>Warning message to print before evaluating</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">value</code></em></span> (any value)</span></dt><dd><p>Value to return as-is.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.32.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">Bool -&gt; String -&gt; a -&gt; a
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L825"  target="_top">lib/trivial.nix:825</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.warnIfNot" class="title" ><code class="literal">lib.trivial.warnIfNot</code>   </h4>  </div> </div></div><p><code class="literal">warnIfNot</code> <span class="emphasis"><em><code class="literal">condition</code></em></span> <span class="emphasis"><em><code class="literal">message</code></em></span> <span class="emphasis"><em><code class="literal">value</code></em></span></p><p>Like <code class="literal">warnIf</code>, but negated: warn if the first argument is <code class="literal">false</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.33.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em><code class="literal">condition</code></em></span></span></dt><dd><p><code class="literal">false</code> to trigger the warning before continuing with <code class="literal">val</code>.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">message</code></em></span></span></dt><dd><p>Warning message to print before evaluating <span class="emphasis"><em><code class="literal">value</code></em></span>.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">value</code></em></span></span></dt><dd><p>Value to return as-is.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.33.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">Boolean -&gt; String -&gt; a -&gt; a
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L852"  target="_top">lib/trivial.nix:852</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.throwIfNot" class="title" ><code class="literal">lib.trivial.throwIfNot</code>   </h4>  </div> </div></div><p>Like the <code class="literal">assert b; e</code> expression, but with a custom error message and
without the semicolon.</p><p>If true, return the identity function, <code class="literal">r: r</code>.</p><p>If false, throw the error message.</p><p>Calls can be juxtaposed using function application, as <code class="literal">(r: r) a = a</code>, so
<code class="literal">(r: r) (r: r) a = a</code>, and so forth.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.34.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">cond</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">msg</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.34.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">bool -&gt; string -&gt; a -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.34.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 141. <code class="literal">lib.trivial.throwIfNot</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">throwIfNot (lib.isList overlays) &quot;The overlays argument to nixpkgs must be a list.&quot;
lib.foldr (x: throwIfNot (lib.isFunction x) &quot;All overlays passed to nixpkgs must be functions.&quot;) (r: r) overlays
pkgs
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L893"  target="_top">lib/trivial.nix:893</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.throwIf" class="title" ><code class="literal">lib.trivial.throwIf</code>   </h4>  </div> </div></div><p>Like throwIfNot, but negated (throw if the first argument is <code class="literal">true</code>).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.35.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">cond</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">msg</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.35.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">bool -&gt; string -&gt; a -&gt; a
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L914"  target="_top">lib/trivial.nix:914</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.checkListOfEnum" class="title" ><code class="literal">lib.trivial.checkListOfEnum</code>   </h4>  </div> </div></div><p>Check if the elements in a list are valid values from a enum, returning the identity function, or throwing an error message otherwise.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.36.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">msg</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">valid</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">given</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.36.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">String -&gt; List ComparableVal -&gt; List ComparableVal -&gt; a -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.36.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 142. <code class="literal">lib.trivial.checkListOfEnum</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">let colorVariants = [&quot;bright&quot; &quot;dark&quot; &quot;black&quot;]
in checkListOfEnum &quot;color variants&quot; [ &quot;standard&quot; &quot;light&quot; &quot;dark&quot; ] colorVariants;
=&gt;
error: color variants: bright, black unexpected; valid ones: standard, light, dark
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L952"  target="_top">lib/trivial.nix:952</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.setFunctionArgs" class="title" ><code class="literal">lib.trivial.setFunctionArgs</code>   </h4>  </div> </div></div><p>Add metadata about expected function arguments to a function.
The metadata should match the format given by
builtins.functionArgs, i.e. a set from expected argument to a bool
representing whether that argument has a default or not.
setFunctionArgs : (a → b) → Map String Bool → (a → b)</p><p>This function is necessary because you can’t dynamically create a
function of the { a, b ? foo, … }: format, but some facilities
like callPackage expect to be able to query expected arguments.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.37.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">args</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L987"  target="_top">lib/trivial.nix:987</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.functionArgs" class="title" ><code class="literal">lib.trivial.functionArgs</code>   </h4>  </div> </div></div><p>Extract the expected function arguments from a function.
This works both with nix-native { a, b ? foo, … }: style
functions and functions with args set with ‘setFunctionArgs’. It
has the same return type and semantics as builtins.functionArgs.
setFunctionArgs : (a → b) → Map String Bool.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.38.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L1006"  target="_top">lib/trivial.nix:1006</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.isFunction" class="title" ><code class="literal">lib.trivial.isFunction</code>   </h4>  </div> </div></div><p>Check whether something is a function or something
annotated with function args.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.39.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L1023"  target="_top">lib/trivial.nix:1023</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.mirrorFunctionArgs" class="title" ><code class="literal">lib.trivial.mirrorFunctionArgs</code>   </h4>  </div> </div></div><p><code class="literal">mirrorFunctionArgs f g</code> creates a new function <code class="literal">g&#x27;</code> with the same behavior as <code class="literal">g</code> (<code class="literal">g&#x27; x == g x</code>)
but its function arguments mirroring <code class="literal">f</code> (<code class="literal">lib.functionArgs g&#x27; == lib.functionArgs f</code>).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.40.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>Function to provide the argument metadata</p></dd><dt><span class="term"><code class="literal">g</code></span></dt><dd><p>Function to set the argument metadata to</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.40.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mirrorFunctionArgs :: (a -&gt; b) -&gt; (a -&gt; c) -&gt; (a -&gt; c)
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.40.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 143. <code class="literal">lib.trivial.mirrorFunctionArgs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">addab = {a, b}: a + b
addab { a = 2; b = 4; }
=&gt; 6
lib.functionArgs addab
=&gt; { a = false; b = false; }
addab1 = attrs: addab attrs + 1
addab1 { a = 2; b = 4; }
=&gt; 7
lib.functionArgs addab1
=&gt; { }
addab1&#x27; = lib.mirrorFunctionArgs addab addab1
addab1&#x27; { a = 2; b = 4; }
=&gt; 7
lib.functionArgs addab1&#x27;
=&gt; { a = false; b = false; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L1069"  target="_top">lib/trivial.nix:1069</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.toFunction" class="title" ><code class="literal">lib.trivial.toFunction</code>   </h4>  </div> </div></div><p>Turns any non-callable values into constant functions.
Returns callable values as is.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.41.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>Any value</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.41.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 144. <code class="literal">lib.trivial.toFunction</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">nix-repl&gt; lib.toFunction 1 2
1

nix-repl&gt; lib.toFunction (x: x + 1) 2
3
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L1100"  target="_top">lib/trivial.nix:1100</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.fromHexString" class="title" ><code class="literal">lib.trivial.fromHexString</code>   </h4>  </div> </div></div><p>Convert a hexadecimal string to it’s integer representation.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.42.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">fromHexString :: String -&gt; [ String ]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.42.2" class="title" >Examples   </h5>  </div> </div></div><pre><code class="programlisting nix">fromHexString &quot;FF&quot;
=&gt; 255

fromHexString (builtins.hashString &quot;sha256&quot; &quot;test&quot;)
=&gt; 9223372036854775807
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L1121"  target="_top">lib/trivial.nix:1121</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.toHexString" class="title" ><code class="literal">lib.trivial.toHexString</code>   </h4>  </div> </div></div><p>Convert the given positive integer to a string of its hexadecimal
representation. For example:</p><p>toHexString 0 =&gt; “0”</p><p>toHexString 16 =&gt; “10”</p><p>toHexString 250 =&gt; “FA”</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L1141"  target="_top">lib/trivial.nix:1141</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.trivial.toBaseDigits" class="title" ><code class="literal">lib.trivial.toBaseDigits</code>   </h4>  </div> </div></div><p><code class="literal">toBaseDigits base i</code> converts the positive integer i to a list of its
digits in the given base. For example:</p><p>toBaseDigits 10 123 =&gt; [ 1 2 3 ]</p><p>toBaseDigits 2 6 =&gt; [ 1 1 0 ]</p><p>toBaseDigits 16 250 =&gt; [ 15 10 ]</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-10-1.44.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">base</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">i</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/trivial.nix#L1175"  target="_top">lib/trivial.nix:1175</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-fixedPoints" class="title" >lib.fixedPoints: explicit recursion functions   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fixedPoints.fix" class="title" ><code class="literal">lib.fixedPoints.fix</code>   </h4>  </div> </div></div><p><code class="literal">fix f</code> computes the fixed point of the given function <code class="literal">f</code>. In other words, the return value is <code class="literal">x</code> in <code class="literal">x = f x</code>.</p><p><code class="literal">f</code> must be a lazy function.
This means that <code class="literal">x</code> must be a value that can be partially evaluated,
such as an attribute set, a list, or a function.
This way, <code class="literal">f</code> can use one part of <code class="literal">x</code> to compute another part.</p><p><span class="strong"><strong>Relation to syntactic recursion</strong></span></p><p>This section explains <code class="literal">fix</code> by refactoring from syntactic recursion to a call of <code class="literal">fix</code> instead.</p><p>For context, Nix lets you define attributes in terms of other attributes syntactically using the <a class="link" href="https://nixos.org/manual/nix/stable/language/constructs.html#recursive-sets"  target="_top"><code class="literal">rec { }</code> syntax</a>.</p><pre><code class="programlisting nix">nix-repl&gt; rec {
  foo = &quot;foo&quot;;
  bar = &quot;bar&quot;;
  foobar = foo + bar;
}
{ bar = &quot;bar&quot;; foo = &quot;foo&quot;; foobar = &quot;foobar&quot;; }
</code></pre><p>This is convenient when constructing a value to pass to a function for example,
but an equivalent effect can be achieved with the <code class="literal">let</code> binding syntax:</p><pre><code class="programlisting nix">nix-repl&gt; let self = {
  foo = &quot;foo&quot;;
  bar = &quot;bar&quot;;
  foobar = self.foo + self.bar;
}; in self
{ bar = &quot;bar&quot;; foo = &quot;foo&quot;; foobar = &quot;foobar&quot;; }
</code></pre><p>But in general you can get more reuse out of <code class="literal">let</code> bindings by refactoring them to a function.</p><pre><code class="programlisting nix">nix-repl&gt; f = self: {
  foo = &quot;foo&quot;;
  bar = &quot;bar&quot;;
  foobar = self.foo + self.bar;
}
</code></pre><p>This is where <code class="literal">fix</code> comes in, it contains the syntactic recursion that’s not in <code class="literal">f</code> anymore.</p><pre><code class="programlisting nix">nix-repl&gt; fix = f:
  let self = f self; in self;
</code></pre><p>By applying <code class="literal">fix</code> we get the final result.</p><pre><code class="programlisting nix">nix-repl&gt; fix f
{ bar = &quot;bar&quot;; foo = &quot;foo&quot;; foobar = &quot;foobar&quot;; }
</code></pre><p>Such a refactored <code class="literal">f</code> using <code class="literal">fix</code> is not useful by itself.
See <a class="link" href="index.html#function-library-lib.fixedPoints.extends" title="lib.fixedPoints.extends" ><code class="literal">extends</code></a> for an example use case.
There <code class="literal">self</code> is also often called <code class="literal">final</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.1.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">fix :: (a -&gt; a) -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.1.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 145. <code class="literal">lib.fixedPoints.fix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">fix (self: { foo = &quot;foo&quot;; bar = &quot;bar&quot;; foobar = self.foo + self.bar; })
=&gt; { bar = &quot;bar&quot;; foo = &quot;foo&quot;; foobar = &quot;foobar&quot;; }

fix (self: [ 1 2 (elemAt self 0 + elemAt self 1) ])
=&gt; [ 1 2 3 ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fixed-points.nix#L92"  target="_top">lib/fixed-points.nix:92</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fixedPoints.fix-prime" class="title" ><code class="literal">lib.fixedPoints.fix&#x27;</code>   </h4>  </div> </div></div><p>A variant of <code class="literal">fix</code> that records the original recursive attribute set in the
result, in an attribute named <code class="literal">__unfix__</code>.</p><p>This is useful in combination with the <code class="literal">extends</code> function to
implement deep overriding.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fixed-points.nix#L112"  target="_top">lib/fixed-points.nix:112</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fixedPoints.converge" class="title" ><code class="literal">lib.fixedPoints.converge</code>   </h4>  </div> </div></div><p>Return the fixpoint that <code class="literal">f</code> converges to when called iteratively, starting
with the input <code class="literal">x</code>.</p><pre><code class="programlisting">nix-repl&gt; converge (x: x / 2) 16
0
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">(a -&gt; a) -&gt; a -&gt; a
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fixed-points.nix#L146"  target="_top">lib/fixed-points.nix:146</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fixedPoints.extends" class="title" ><code class="literal">lib.fixedPoints.extends</code>   </h4>  </div> </div></div><p>Extend a function using an overlay.</p><p>Overlays allow modifying and extending fixed-point functions, specifically ones returning attribute sets.
A fixed-point function is a function which is intended to be evaluated by passing the result of itself as the argument.
This is possible due to Nix’s lazy evaluation.</p><p>A fixed-point function returning an attribute set has the form</p><pre><code class="programlisting nix">final: {
  # attributes
}
</code></pre><p>where <code class="literal">final</code> refers to the lazily evaluated attribute set returned by the fixed-point function.</p><p>An overlay to such a fixed-point function has the form</p><pre><code class="programlisting nix">final: prev: {
  # attributes
}
</code></pre><p>where <code class="literal">prev</code> refers to the result of the original function to <code class="literal">final</code>, and <code class="literal">final</code> is the result of the composition of the overlay and the original function.</p><p>Applying an overlay is done with <code class="literal">extends</code>:</p><pre><code class="programlisting nix">let
  f = final: {
    # attributes
  };
  overlay = final: prev: {
    # attributes
  };
in extends overlay f;
</code></pre><p>To get the value of <code class="literal">final</code>, use <code class="literal">lib.fix</code>:</p><pre><code class="programlisting nix">let
  f = final: {
    # attributes
  };
  overlay = final: prev: {
    # attributes
  };
  g = extends overlay f;
in fix g
</code></pre><div class="note"><h3 class="title">Note</h3><p>The argument to the given fixed-point function after applying an overlay will <span class="emphasis"><em>not</em></span> refer to its own return value, but rather to the value after evaluating the overlay function.</p><p>The given fixed-point function is called with a separate argument than if it was evaluated with <code class="literal">lib.fix</code>.</p></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 146. Extend a fixed-point function with an overlay</strong></span></summary><div class="example-contents"><p>Define a fixed-point function <code class="literal">f</code> that expects its own output as the argument <code class="literal">final</code>:</p><pre><code class="programlisting nix-repl">f = final: {
  # Constant value a
  a = 1;

  # b depends on the final value of a, available as final.a
  b = final.a + 2;
}
</code></pre><p>Evaluate this using <a class="link" href="index.html#function-library-lib.fixedPoints.fix" title="lib.fixedPoints.fix" ><code class="literal">lib.fix</code></a> to get the final result:</p><pre><code class="programlisting nix-repl">fix f
=&gt; { a = 1; b = 3; }
</code></pre><p>An overlay represents a modification or extension of such a fixed-point function.
Here’s an example of an overlay:</p><pre><code class="programlisting nix-repl">overlay = final: prev: {
  # Modify the previous value of a, available as prev.a
  a = prev.a + 10;

  # Extend the attribute set with c, letting it depend on the final values of a and b
  c = final.a + final.b;
}
</code></pre><p>Use <code class="literal">extends overlay f</code> to apply the overlay to the fixed-point function <code class="literal">f</code>.
This produces a new fixed-point function <code class="literal">g</code> with the combined behavior of <code class="literal">f</code> and <code class="literal">overlay</code>:</p><pre><code class="programlisting nix-repl">g = extends overlay f
</code></pre><p>The result is a function, so we can’t print it directly, but it’s the same as:</p><pre><code class="programlisting nix-repl">g&#x27; = final: {
  # The constant from f, but changed with the overlay
  a = 1 + 10;

  # Unchanged from f
  b = final.a + 2;

  # Extended in the overlay
  c = final.a + final.b;
}
</code></pre><p>Evaluate this using <a class="link" href="index.html#function-library-lib.fixedPoints.fix" title="lib.fixedPoints.fix" ><code class="literal">lib.fix</code></a> again to get the final result:</p><pre><code class="programlisting nix-repl">fix g
=&gt; { a = 11; b = 13; c = 24; }
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">overlay</code></span></dt><dd><p>The overlay to apply to the fixed-point function</p></dd><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>The fixed-point function</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">extends :: (Attrs -&gt; Attrs -&gt; Attrs) # The overlay to apply to the fixed-point function
        -&gt; (Attrs -&gt; Attrs) # A fixed-point function
        -&gt; (Attrs -&gt; Attrs) # The resulting fixed-point function
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.4.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 147. <code class="literal">lib.fixedPoints.extends</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">f = final: { a = 1; b = final.a + 2; }

fix f
=&gt; { a = 1; b = 3; }

fix (extends (final: prev: { a = prev.a + 10; }) f)
=&gt; { a = 11; b = 13; }

fix (extends (final: prev: { b = final.a + 5; }) f)
=&gt; { a = 1; b = 6; }

fix (extends (final: prev: { c = final.a + final.b; }) f)
=&gt; { a = 1; b = 3; c = 4; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fixed-points.nix#L319"  target="_top">lib/fixed-points.nix:319</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fixedPoints.composeExtensions" class="title" ><code class="literal">lib.fixedPoints.composeExtensions</code>   </h4>  </div> </div></div><p>Compose two overlay functions and return a single overlay function that combines them.
For more details see: <a class="link" href="index.html#function-library-lib.fixedPoints.composeManyExtensions" title="lib.fixedPoints.composeManyExtensions" >composeManyExtensions</a>.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fixed-points.nix#L334"  target="_top">lib/fixed-points.nix:334</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fixedPoints.composeManyExtensions" class="title" ><code class="literal">lib.fixedPoints.composeManyExtensions</code>   </h4>  </div> </div></div><p>Composes a list of <a class="link" href="index.html#chap-overlays" title="Overlays" ><code class="literal">overlays</code></a> and returns a single overlay function that combines them.</p><div class="note"><h3 class="title">Note</h3><p>The result is produced by using the update operator <code class="literal">//</code>.
This means nested values of previous overlays are not merged recursively.
In other words, previously defined attributes are replaced, ignoring the previous value, unless referenced by the overlay; for example <code class="literal">final: prev: { foo = final.foo + 1; }</code>.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">extensions</code></span></dt><dd><p>A list of overlay functions</p><div class="note"><h3 class="title">Note</h3><p>The order of the overlays in the list is important.</p></div></dd><dd><p>Each overlay function takes two arguments, by convention <code class="literal">final</code> and <code class="literal">prev</code>, and returns an attribute set.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">final</code> is the result of the fixed-point function, with all overlays applied.</p></li><li class="listitem"><p><code class="literal">prev</code> is the result of the previous overlay function(s).</p></li></ul></div></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.6.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting"># Pseudo code
let
  #               final      prev
  #                 ↓          ↓
  OverlayFn = { ... } -&gt; { ... } -&gt; { ... };
in
  composeManyExtensions :: ListOf OverlayFn -&gt; OverlayFn
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.6.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 148. <code class="literal">lib.fixedPoints.composeManyExtensions</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">let
  # The &quot;original function&quot; that is extended by the overlays.
  # Note that it doesn&#x27;t have prev: as argument since no overlay function precedes it.
  original = final: { a = 1; };

  # Each overlay function has &#x27;final&#x27; and &#x27;prev&#x27; as arguments.
  overlayA = final: prev: { b = final.c; c = 3; };
  overlayB = final: prev: { c = 10; x = prev.c or 5; };

  extensions = composeManyExtensions [ overlayA overlayB ];

  # Calculate the fixed point of all composed overlays.
  fixedpoint = lib.fix (lib.extends extensions original );

in fixedpoint
=&gt;
{
  a = 1;
  b = 10;
  c = 10;
  x = 3;
}
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fixed-points.nix#L406"  target="_top">lib/fixed-points.nix:406</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fixedPoints.makeExtensible" class="title" ><code class="literal">lib.fixedPoints.makeExtensible</code>   </h4>  </div> </div></div><p>Create an overridable, recursive attribute set. For example:</p><pre><code class="programlisting">nix-repl&gt; obj = makeExtensible (final: { })

nix-repl&gt; obj
{ __unfix__ = «lambda»; extend = «lambda»; }

nix-repl&gt; obj = obj.extend (final: prev: { foo = &quot;foo&quot;; })

nix-repl&gt; obj
{ __unfix__ = «lambda»; extend = «lambda»; foo = &quot;foo&quot;; }

nix-repl&gt; obj = obj.extend (final: prev: { foo = prev.foo + &quot; + &quot;; bar = &quot;bar&quot;; foobar = final.foo + final.bar; })

nix-repl&gt; obj
{ __unfix__ = «lambda»; bar = &quot;bar&quot;; extend = «lambda»; foo = &quot;foo + &quot;; foobar = &quot;foo + bar&quot;; }
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fixed-points.nix#L428"  target="_top">lib/fixed-points.nix:428</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fixedPoints.makeExtensibleWithCustomName" class="title" ><code class="literal">lib.fixedPoints.makeExtensibleWithCustomName</code>   </h4>  </div> </div></div><p>Same as <code class="literal">makeExtensible</code> but the name of the extending attribute is
customized.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.8.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">extenderName</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">rattrs</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fixed-points.nix#L444"  target="_top">lib/fixed-points.nix:444</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fixedPoints.toExtension" class="title" ><code class="literal">lib.fixedPoints.toExtension</code>   </h4>  </div> </div></div><p>Convert to an extending function (overlay).</p><p><code class="literal">toExtension</code> is the <code class="literal">toFunction</code> for extending functions (a.k.a. extensions or overlays).
It converts a non-function or a single-argument function to an extending function,
while returning a two-argument function as-is.</p><p>That is, it takes a value of the shape <code class="literal">x</code>, <code class="literal">prev: x</code>, or <code class="literal">final: prev: x</code>,
and returns <code class="literal">final: prev: x</code>, assuming <code class="literal">x</code> is not a function.</p><p>This function takes care of the input to <code class="literal">stdenv.mkDerivation</code>’s
<code class="literal">overrideAttrs</code> function.
It bridges the gap between <code class="literal">&lt;pkg&gt;.overrideAttrs</code>
before and after the overlay-style support.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.9.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>The function or value to convert to an extending function.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.9.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toExtension ::
  b&#x27; -&gt; Any -&gt; Any -&gt; b&#x27;
or
toExtension ::
  (a -&gt; b&#x27;) -&gt; Any -&gt; a -&gt; b&#x27;
or
toExtension ::
  (a -&gt; a -&gt; b) -&gt; a -&gt; a -&gt; b
where b&#x27; = ! Callable

Set a = b = b&#x27; = AttrSet &amp; ! Callable to make toExtension return an extending function.
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-11-1.9.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 149. <code class="literal">lib.fixedPoints.toExtension</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">fix (final: { a = 0; c = final.a; })
=&gt; { a = 0; c = 0; };

fix (extends (toExtension { a = 1; b = 2; }) (final: { a = 0; c = final.a; }))
=&gt; { a = 1; b = 2; c = 1; };

fix (extends (toExtension (prev: { a = 1; b = prev.a; })) (final: { a = 0; c = final.a; }))
=&gt; { a = 1; b = 0; c = 1; };

fix (extends (toExtension (final: prev: { a = 1; b = prev.a; c = final.a + 1 })) (final: { a = 0; c = final.a; }))
=&gt; { a = 1; b = 0; c = 2; };
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fixed-points.nix#L509"  target="_top">lib/fixed-points.nix:509</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-lists" class="title" >lib.lists: list manipulation functions   </h3>  </div> </div></div><p>General list operations.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.singleton" class="title" ><code class="literal">lib.lists.singleton</code>   </h4>  </div> </div></div><p>Create a list consisting of a single element. <code class="literal">singleton x</code> is
sometimes more convenient with respect to indentation than <code class="literal">[x]</code>
when x spans multiple lines.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.1.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">singleton :: a -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.1.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 150. <code class="literal">lib.lists.singleton</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">singleton &quot;foo&quot;
=&gt; [ &quot;foo&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L60"  target="_top">lib/lists.nix:60</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.forEach" class="title" ><code class="literal">lib.lists.forEach</code>   </h4>  </div> </div></div><p>Apply the function to each element in the list.
Same as <code class="literal">map</code>, but arguments flipped.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">xs</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">forEach :: [a] -&gt; (a -&gt; b) -&gt; [b]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.2.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 151. <code class="literal">lib.lists.forEach</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">forEach [ 1 2 ] (x:
  toString x
)
=&gt; [ &quot;1&quot; &quot;2&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L95"  target="_top">lib/lists.nix:95</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.foldr" class="title" ><code class="literal">lib.lists.foldr</code>   </h4>  </div> </div></div><p>“right fold” a binary function <code class="literal">op</code> between successive elements of
<code class="literal">list</code> with <code class="literal">nul</code> as the starting value, i.e.,
<code class="literal">foldr op nul [x_1 x_2 ... x_n] == op x_1 (op x_2 ... (op x_n nul))</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">op</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">nul</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">foldr :: (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.3.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 152. <code class="literal">lib.lists.foldr</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concat = foldr (a: b: a + b) &quot;z&quot;
concat [ &quot;a&quot; &quot;b&quot; &quot;c&quot; ]
=&gt; &quot;abcz&quot;
# different types
strange = foldr (int: str: toString (int + 1) + str) &quot;a&quot;
strange [ 1 2 3 4 ]
=&gt; &quot;2345a&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L138"  target="_top">lib/lists.nix:138</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.fold" class="title" ><code class="literal">lib.lists.fold</code>   </h4>  </div> </div></div><p><code class="literal">fold</code> is an alias of <code class="literal">foldr</code> for historic reasons</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L150"  target="_top">lib/lists.nix:150</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.foldl" class="title" ><code class="literal">lib.lists.foldl</code>   </h4>  </div> </div></div><p>“left fold”, like <code class="literal">foldr</code>, but from the left:</p><p><code class="literal">foldl op nul [x_1 x_2 ... x_n] == op (... (op (op nul x_1) x_2) ... x_n)</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">op</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">nul</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.5.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">foldl :: (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.5.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 153. <code class="literal">lib.lists.foldl</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">lconcat = foldl (a: b: a + b) &quot;z&quot;
lconcat [ &quot;a&quot; &quot;b&quot; &quot;c&quot; ]
=&gt; &quot;zabc&quot;
# different types
lstrange = foldl (str: int: str + toString (int + 1)) &quot;a&quot;
lstrange [ 1 2 3 4 ]
=&gt; &quot;a2345&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L193"  target="_top">lib/lists.nix:193</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.foldl-prime" class="title" ><code class="literal">lib.lists.foldl&#x27;</code>   </h4>  </div> </div></div><p>Reduce a list by applying a binary operator from left to right,
starting with an initial accumulator.</p><p>Before each application of the operator, the accumulator value is evaluated.
This behavior makes this function stricter than <a class="link" href="index.html#function-library-lib.lists.foldl" title="lib.lists.foldl" ><code class="literal">foldl</code></a>.</p><p>Unlike <a class="link" href="https://nixos.org/manual/nix/unstable/language/builtins.html#builtins-foldl&#x27;"  target="_top"><code class="literal">builtins.foldl&#x27;</code></a>,
the initial accumulator argument is evaluated before the first iteration.</p><p>A call like</p><pre><code class="programlisting nix">foldl&#x27; op acc₀ [ x₀ x₁ x₂ ... xₙ₋₁ xₙ ]
</code></pre><p>is (denotationally) equivalent to the following,
but with the added benefit that <code class="literal">foldl&#x27;</code> itself will never overflow the stack.</p><pre><code class="programlisting nix">let
  acc₁   = builtins.seq acc₀   (op acc₀   x₀  );
  acc₂   = builtins.seq acc₁   (op acc₁   x₁  );
  acc₃   = builtins.seq acc₂   (op acc₂   x₂  );
  ...
  accₙ   = builtins.seq accₙ₋₁ (op accₙ₋₁ xₙ₋₁);
  accₙ₊₁ = builtins.seq accₙ   (op accₙ   xₙ  );
in
accₙ₊₁

# Or ignoring builtins.seq
op (op (... (op (op (op acc₀ x₀) x₁) x₂) ...) xₙ₋₁) xₙ
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">op</code></span></dt><dd><p>The binary operation to run, where the two arguments are:</p></dd></dl></div><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p><code class="literal">acc</code>: The current accumulator value: Either the initial one for the first iteration, or the result of the previous iteration</p></li><li class="listitem"><p><code class="literal">x</code>: The corresponding list element for this iteration</p></li></ol></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">acc</code></span></dt><dd><p>The initial accumulator value.</p><p>The accumulator value is evaluated in any case before the first iteration starts.</p><p>To avoid evaluation even before the <code class="literal">list</code> argument is given an eta expansion can be used:</p><pre><code class="programlisting nix">list: lib.foldl&#x27; op acc list
</code></pre></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>The list to fold</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.6.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">foldl&#x27; :: (acc -&gt; x -&gt; acc) -&gt; acc -&gt; [x] -&gt; acc
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.6.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 154. <code class="literal">lib.lists.foldl&#x27;</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">foldl&#x27; (acc: x: acc + x) 0 [1 2 3]
=&gt; 6
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L276"  target="_top">lib/lists.nix:276</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.imap0" class="title" ><code class="literal">lib.lists.imap0</code>   </h4>  </div> </div></div><p>Map with index starting from 0</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.7.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.7.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">imap0 :: (int -&gt; a -&gt; b) -&gt; [a] -&gt; [b]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.7.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 155. <code class="literal">lib.lists.imap0</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">imap0 (i: v: &quot;${v}-${toString i}&quot;) [&quot;a&quot; &quot;b&quot;]
=&gt; [ &quot;a-0&quot; &quot;b-1&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L313"  target="_top">lib/lists.nix:313</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.imap1" class="title" ><code class="literal">lib.lists.imap1</code>   </h4>  </div> </div></div><p>Map with index starting from 1</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.8.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.8.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">imap1 :: (int -&gt; a -&gt; b) -&gt; [a] -&gt; [b]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.8.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 156. <code class="literal">lib.lists.imap1</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">imap1 (i: v: &quot;${v}-${toString i}&quot;) [&quot;a&quot; &quot;b&quot;]
=&gt; [ &quot;a-1&quot; &quot;b-2&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L345"  target="_top">lib/lists.nix:345</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.ifilter0" class="title" ><code class="literal">lib.lists.ifilter0</code>   </h4>  </div> </div></div><p>Filter a list for elements that satisfy a predicate function.
The predicate function is called with both the index and value for each element.
It must return <code class="literal">true</code>/<code class="literal">false</code> to include/exclude a given element in the result.
This function is strict in the result of the predicate function for each element.
This function has O(n) complexity.</p><p>Also see <a class="link" href="https://nixos.org/manual/nix/stable/language/builtins.html#builtins-filter"  target="_top"><code class="literal">builtins.filter</code></a> (available as <code class="literal">lib.lists.filter</code>),
which can be used instead when the index isn’t needed.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.9.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">ipred</code></span></dt><dd><p>The predicate function, it takes two arguments:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>(int): the index of the element.</p></li></ol></div></li><li class="listitem"><div class="orderedlist"><ol class="orderedlist compact" start="2" type="1"><li class="listitem"><p>(a): the value of the element.</p></li></ol></div></li></ul></div><p>It must return <code class="literal">true</code>/<code class="literal">false</code> to include/exclude a given element from the result.</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>The list to filter using the predicate.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.9.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">ifilter0 :: (int -&gt; a -&gt; bool) -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.9.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 157. <code class="literal">lib.lists.ifilter0</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">ifilter0 (i: v: i == 0 || v &gt; 2) [ 1 2 3 ]
=&gt; [ 1 3 ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L386"  target="_top">lib/lists.nix:386</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.concatMap" class="title" ><code class="literal">lib.lists.concatMap</code>   </h4>  </div> </div></div><p>Map and concatenate the result.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.10.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">concatMap :: (a -&gt; [b]) -&gt; [a] -&gt; [b]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.10.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 158. <code class="literal">lib.lists.concatMap</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">concatMap (x: [x] ++ [&quot;z&quot;]) [&quot;a&quot; &quot;b&quot;]
=&gt; [ &quot;a&quot; &quot;z&quot; &quot;b&quot; &quot;z&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L412"  target="_top">lib/lists.nix:412</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.flatten" class="title" ><code class="literal">lib.lists.flatten</code>   </h4>  </div> </div></div><p>Flatten the argument into a single list; that is, nested lists are
spliced into the top-level lists.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.11.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.11.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 159. <code class="literal">lib.lists.flatten</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">flatten [1 [2 [3] 4] 5]
=&gt; [1 2 3 4 5]
flatten 1
=&gt; [1]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L437"  target="_top">lib/lists.nix:437</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.remove" class="title" ><code class="literal">lib.lists.remove</code>   </h4>  </div> </div></div><p>Remove elements equal to ‘e’ from a list.  Useful for buildInputs.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.12.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">e</code></span></dt><dd><p>Element to remove from <code class="literal">list</code></p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>The list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.12.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">remove :: a -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.12.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 160. <code class="literal">lib.lists.remove</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">remove 3 [ 1 3 4 3 ]
=&gt; [ 1 4 ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L469"  target="_top">lib/lists.nix:469</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.findSingle" class="title" ><code class="literal">lib.lists.findSingle</code>   </h4>  </div> </div></div><p>Find the sole element in the list matching the specified
predicate.</p><p>Returns <code class="literal">default</code> if no such element exists, or
<code class="literal">multiple</code> if there are multiple matching elements.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.13.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate</p></dd><dt><span class="term"><code class="literal">default</code></span></dt><dd><p>Default value to return if element was not found.</p></dd><dt><span class="term"><code class="literal">multiple</code></span></dt><dd><p>Default value to return if more than one element was found</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.13.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">findSingle :: (a -&gt; bool) -&gt; a -&gt; a -&gt; [a] -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.13.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 161. <code class="literal">lib.lists.findSingle</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">findSingle (x: x == 3) &quot;none&quot; &quot;multiple&quot; [ 1 3 3 ]
=&gt; &quot;multiple&quot;
findSingle (x: x == 3) &quot;none&quot; &quot;multiple&quot; [ 1 3 ]
=&gt; 3
findSingle (x: x == 3) &quot;none&quot; &quot;multiple&quot; [ 1 9 ]
=&gt; &quot;none&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L517"  target="_top">lib/lists.nix:517</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.findFirstIndex" class="title" ><code class="literal">lib.lists.findFirstIndex</code>   </h4>  </div> </div></div><p>Find the first index in the list matching the specified
predicate or return <code class="literal">default</code> if no such element exists.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.14.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate</p></dd><dt><span class="term"><code class="literal">default</code></span></dt><dd><p>Default value to return</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.14.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">findFirstIndex :: (a -&gt; Bool) -&gt; b -&gt; [a] -&gt; (Int | b)
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.14.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 162. <code class="literal">lib.lists.findFirstIndex</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">findFirstIndex (x: x &gt; 3) null [ 0 6 4 ]
=&gt; 1
findFirstIndex (x: x &gt; 9) null [ 0 6 4 ]
=&gt; null
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L567"  target="_top">lib/lists.nix:567</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.findFirst" class="title" ><code class="literal">lib.lists.findFirst</code>   </h4>  </div> </div></div><p>Find the first element in the list matching the specified
predicate or return <code class="literal">default</code> if no such element exists.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.15.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate</p></dd><dt><span class="term"><code class="literal">default</code></span></dt><dd><p>Default value to return</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.15.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">findFirst :: (a -&gt; bool) -&gt; a -&gt; [a] -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.15.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 163. <code class="literal">lib.lists.findFirst</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">findFirst (x: x &gt; 3) 7 [ 1 6 4 ]
=&gt; 6
findFirst (x: x &gt; 9) 7 [ 1 6 4 ]
=&gt; 7
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L637"  target="_top">lib/lists.nix:637</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.any" class="title" ><code class="literal">lib.lists.any</code>   </h4>  </div> </div></div><p>Return true if function <code class="literal">pred</code> returns true for at least one
element of <code class="literal">list</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.16.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.16.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">any :: (a -&gt; bool) -&gt; [a] -&gt; bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.16.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 164. <code class="literal">lib.lists.any</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">any isString [ 1 &quot;a&quot; { } ]
=&gt; true
any isString [ 1 { } ]
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L677"  target="_top">lib/lists.nix:677</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.all" class="title" ><code class="literal">lib.lists.all</code>   </h4>  </div> </div></div><p>Return true if function <code class="literal">pred</code> returns true for all elements of
<code class="literal">list</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.17.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.17.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">all :: (a -&gt; bool) -&gt; [a] -&gt; bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.17.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 165. <code class="literal">lib.lists.all</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">all (x: x &lt; 3) [ 1 2 ]
=&gt; true
all (x: x &lt; 3) [ 1 2 3 ]
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L712"  target="_top">lib/lists.nix:712</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.count" class="title" ><code class="literal">lib.lists.count</code>   </h4>  </div> </div></div><p>Count how many elements of <code class="literal">list</code> match the supplied predicate
function.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.18.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.18.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">count :: (a -&gt; bool) -&gt; [a] -&gt; int
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.18.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 166. <code class="literal">lib.lists.count</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">count (x: x == 3) [ 3 2 3 4 6 ]
=&gt; 2
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L741"  target="_top">lib/lists.nix:741</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.optional" class="title" ><code class="literal">lib.lists.optional</code>   </h4>  </div> </div></div><p>Return a singleton list or an empty list, depending on a boolean
value.  Useful when building lists with optional elements
(e.g. <code class="literal">++ optional (system == &quot;i686-linux&quot;) firefox</code>).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.19.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">cond</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">elem</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.19.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">optional :: bool -&gt; a -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.19.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 167. <code class="literal">lib.lists.optional</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">optional true &quot;foo&quot;
=&gt; [ &quot;foo&quot; ]
optional false &quot;foo&quot;
=&gt; [ ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L777"  target="_top">lib/lists.nix:777</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.optionals" class="title" ><code class="literal">lib.lists.optionals</code>   </h4>  </div> </div></div><p>Return a list or an empty list, depending on a boolean value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.20.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">cond</code></span></dt><dd><p>Condition</p></dd><dt><span class="term"><code class="literal">elems</code></span></dt><dd><p>List to return if condition is true</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.20.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">optionals :: bool -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.20.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 168. <code class="literal">lib.lists.optionals</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">optionals true [ 2 3 ]
=&gt; [ 2 3 ]
optionals false [ 2 3 ]
=&gt; [ ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L811"  target="_top">lib/lists.nix:811</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.toList" class="title" ><code class="literal">lib.lists.toList</code>   </h4>  </div> </div></div><p>If argument is a list, return it; else, wrap it in a singleton
list. If you’re using this, you should almost certainly
reconsider if there isn’t a more “well-typed” approach.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.21.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.21.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 169. <code class="literal">lib.lists.toList</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">toList [ 1 2 ]
=&gt; [ 1 2 ]
toList &quot;hi&quot;
=&gt; [ &quot;hi &quot;]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L837"  target="_top">lib/lists.nix:837</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.range" class="title" ><code class="literal">lib.lists.range</code>   </h4>  </div> </div></div><p>Return a list of integers from <code class="literal">first</code> up to and including <code class="literal">last</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.22.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">first</code></span></dt><dd><p>First integer in the range</p></dd><dt><span class="term"><code class="literal">last</code></span></dt><dd><p>Last integer in the range</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.22.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">range :: int -&gt; int -&gt; [int]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.22.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 170. <code class="literal">lib.lists.range</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">range 2 4
=&gt; [ 2 3 4 ]
range 3 2
=&gt; [ ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L871"  target="_top">lib/lists.nix:871</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.replicate" class="title" ><code class="literal">lib.lists.replicate</code>   </h4>  </div> </div></div><p>Return a list with <code class="literal">n</code> copies of an element.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.23.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">n</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">elem</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.23.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">replicate :: int -&gt; a -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.23.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 171. <code class="literal">lib.lists.replicate</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">replicate 3 &quot;a&quot;
=&gt; [ &quot;a&quot; &quot;a&quot; &quot;a&quot; ]
replicate 2 true
=&gt; [ true true ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L905"  target="_top">lib/lists.nix:905</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.partition" class="title" ><code class="literal">lib.lists.partition</code>   </h4>  </div> </div></div><p>Splits the elements of a list in two lists, <code class="literal">right</code> and
<code class="literal">wrong</code>, depending on the evaluation of a predicate.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.24.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.24.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">(a -&gt; bool) -&gt; [a] -&gt; { right :: [a]; wrong :: [a]; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.24.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 172. <code class="literal">lib.lists.partition</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">partition (x: x &gt; 2) [ 5 1 2 3 4 ]
=&gt; { right = [ 5 3 4 ]; wrong = [ 1 2 ]; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L938"  target="_top">lib/lists.nix:938</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.groupBy-prime" class="title" ><code class="literal">lib.lists.groupBy&#x27;</code>   </h4>  </div> </div></div><p>Splits the elements of a list into many lists, using the return value of a predicate.
Predicate should return a string which becomes keys of attrset <code class="literal">groupBy</code> returns.
<code class="literal">groupBy&#x27;</code> allows to customise the combining function and initial value</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.25.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">op</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">nul</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>3. Function argument</p></dd><dt><span class="term"><code class="literal">lst</code></span></dt><dd><p>4. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.25.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 173. <code class="literal">lib.lists.groupBy&#x27;</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">groupBy (x: boolToString (x &gt; 2)) [ 5 1 2 3 4 ]
=&gt; { true = [ 5 3 4 ]; false = [ 1 2 ]; }
groupBy (x: x.name) [ {name = &quot;icewm&quot;; script = &quot;icewm &amp;&quot;;}
                      {name = &quot;xfce&quot;;  script = &quot;xfce4-session &amp;&quot;;}
                      {name = &quot;icewm&quot;; script = &quot;icewmbg &amp;&quot;;}
                      {name = &quot;mate&quot;;  script = &quot;gnome-session &amp;&quot;;}
                    ]
=&gt; { icewm = [ { name = &quot;icewm&quot;; script = &quot;icewm &amp;&quot;; }
               { name = &quot;icewm&quot;; script = &quot;icewmbg &amp;&quot;; } ];
     mate  = [ { name = &quot;mate&quot;;  script = &quot;gnome-session &amp;&quot;; } ];
     xfce  = [ { name = &quot;xfce&quot;;  script = &quot;xfce4-session &amp;&quot;; } ];
   }

groupBy&#x27; builtins.add 0 (x: boolToString (x &gt; 2)) [ 5 1 2 3 4 ]
=&gt; { true = 12; false = 3; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L987"  target="_top">lib/lists.nix:987</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.zipListsWith" class="title" ><code class="literal">lib.lists.zipListsWith</code>   </h4>  </div> </div></div><p>Merges two lists of the same size together. If the sizes aren’t the same
the merging stops at the shortest. How both lists are merged is defined
by the first argument.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.26.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>Function to zip elements of both lists</p></dd><dt><span class="term"><code class="literal">fst</code></span></dt><dd><p>First list</p></dd><dt><span class="term"><code class="literal">snd</code></span></dt><dd><p>Second list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.26.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">zipListsWith :: (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.26.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 174. <code class="literal">lib.lists.zipListsWith</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">zipListsWith (a: b: a + b) [&quot;h&quot; &quot;l&quot;] [&quot;e&quot; &quot;o&quot;]
=&gt; [&quot;he&quot; &quot;lo&quot;]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1039"  target="_top">lib/lists.nix:1039</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.zipLists" class="title" ><code class="literal">lib.lists.zipLists</code>   </h4>  </div> </div></div><p>Merges two lists of the same size together. If the sizes aren’t the same
the merging stops at the shortest.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.27.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">fst</code></span></dt><dd><p>First list</p></dd><dt><span class="term"><code class="literal">snd</code></span></dt><dd><p>Second list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.27.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">zipLists :: [a] -&gt; [b] -&gt; [{ fst :: a; snd :: b; }]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.27.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 175. <code class="literal">lib.lists.zipLists</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">zipLists [ 1 2 ] [ &quot;a&quot; &quot;b&quot; ]
=&gt; [ { fst = 1; snd = &quot;a&quot;; } { fst = 2; snd = &quot;b&quot;; } ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1074"  target="_top">lib/lists.nix:1074</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.reverseList" class="title" ><code class="literal">lib.lists.reverseList</code>   </h4>  </div> </div></div><p>Reverse the order of the elements of a list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.28.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">xs</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.28.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">reverseList :: [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.28.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 176. <code class="literal">lib.lists.reverseList</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">reverseList [ &quot;b&quot; &quot;o&quot; &quot;j&quot; ]
=&gt; [ &quot;j&quot; &quot;o&quot; &quot;b&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1102"  target="_top">lib/lists.nix:1102</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.listDfs" class="title" ><code class="literal">lib.lists.listDfs</code>   </h4>  </div> </div></div><p>Depth-First Search (DFS) for lists <code class="literal">list != []</code>.</p><p><code class="literal">before a b == true</code> means that <code class="literal">b</code> depends on <code class="literal">a</code> (there’s an
edge from <code class="literal">b</code> to <code class="literal">a</code>).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.29.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">stopOnCycles</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">before</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.29.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 177. <code class="literal">lib.lists.listDfs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">listDfs true hasPrefix [ &quot;/home/user&quot; &quot;other&quot; &quot;/&quot; &quot;/home&quot; ]
  == { minimal = &quot;/&quot;;                  # minimal element
       visited = [ &quot;/home/user&quot; ];     # seen elements (in reverse order)
       rest    = [ &quot;/home&quot; &quot;other&quot; ];  # everything else
     }

listDfs true hasPrefix [ &quot;/home/user&quot; &quot;other&quot; &quot;/&quot; &quot;/home&quot; &quot;/&quot; ]
  == { cycle   = &quot;/&quot;;                  # cycle encountered at this element
       loops   = [ &quot;/&quot; ];              # and continues to these elements
       visited = [ &quot;/&quot; &quot;/home/user&quot; ]; # elements leading to the cycle (in reverse order)
       rest    = [ &quot;/home&quot; &quot;other&quot; ];  # everything else
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1149"  target="_top">lib/lists.nix:1149</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.toposort" class="title" ><code class="literal">lib.lists.toposort</code>   </h4>  </div> </div></div><p>Sort a list based on a partial ordering using DFS. This
implementation is O(N^2), if your ordering is linear, use <code class="literal">sort</code>
instead.</p><p><code class="literal">before a b == true</code> means that <code class="literal">b</code> should be after <code class="literal">a</code>
in the result.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.30.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">before</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.30.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 178. <code class="literal">lib.lists.toposort</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">toposort hasPrefix [ &quot;/home/user&quot; &quot;other&quot; &quot;/&quot; &quot;/home&quot; ]
  == { result = [ &quot;/&quot; &quot;/home&quot; &quot;/home/user&quot; &quot;other&quot; ]; }

toposort hasPrefix [ &quot;/home/user&quot; &quot;other&quot; &quot;/&quot; &quot;/home&quot; &quot;/&quot; ]
  == { cycle = [ &quot;/home/user&quot; &quot;/&quot; &quot;/&quot; ]; # path leading to a cycle
       loops = [ &quot;/&quot; ]; }                # loops back to these elements

toposort hasPrefix [ &quot;other&quot; &quot;/home/user&quot; &quot;/home&quot; &quot;/&quot; ]
  == { result = [ &quot;other&quot; &quot;/&quot; &quot;/home&quot; &quot;/home/user&quot; ]; }

toposort (a: b: a &lt; b) [ 3 2 1 ] == { result = [ 1 2 3 ]; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1214"  target="_top">lib/lists.nix:1214</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.sort" class="title" ><code class="literal">lib.lists.sort</code>   </h4>  </div> </div></div><p>Sort a list based on a comparator function which compares two
elements and returns true if the first argument is strictly below
the second argument.  The returned list is sorted in an increasing
order.  The implementation does a quick-sort.</p><p>See also <a class="link" href="index.html#function-library-lib.lists.sortOn" title="lib.lists.sortOn" ><code class="literal">sortOn</code></a>, which applies the
default comparison on a function-derived property, and may be more efficient.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.31.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">comparator</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.31.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">sort :: (a -&gt; a -&gt; Bool) -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.31.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 179. <code class="literal">lib.lists.sort</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">sort (p: q: p &lt; q) [ 5 3 7 ]
=&gt; [ 3 5 7 ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1273"  target="_top">lib/lists.nix:1273</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.sortOn" class="title" ><code class="literal">lib.lists.sortOn</code>   </h4>  </div> </div></div><p>Sort a list based on the default comparison of a derived property <code class="literal">b</code>.</p><p>The items are returned in <code class="literal">b</code>-increasing order.</p><p><span class="strong"><strong>Performance</strong></span>:</p><p>The passed function <code class="literal">f</code> is only evaluated once per item,
unlike an unprepared <a class="link" href="index.html#function-library-lib.lists.sort" title="lib.lists.sort" ><code class="literal">sort</code></a> using
<code class="literal">f p &lt; f q</code>.</p><p><span class="strong"><strong>Laws</strong></span>:</p><pre><code class="programlisting nix">sortOn f == sort (p: q: f p &lt; f q)
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.32.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.32.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">sortOn :: (a -&gt; b) -&gt; [a] -&gt; [a], for comparable b
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.32.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 180. <code class="literal">lib.lists.sortOn</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">sortOn stringLength [ &quot;aa&quot; &quot;b&quot; &quot;cccc&quot; ]
=&gt; [ &quot;b&quot; &quot;aa&quot; &quot;cccc&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1318"  target="_top">lib/lists.nix:1318</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.compareLists" class="title" ><code class="literal">lib.lists.compareLists</code>   </h4>  </div> </div></div><p>Compare two lists element-by-element with a comparison function <code class="literal">cmp</code>.</p><p>List elements are compared pairwise in order by the provided comparison function <code class="literal">cmp</code>,
the first non-equal pair of elements determines the result.</p><div class="note"><h3 class="title">Note</h3><p>The <code class="literal">&lt;</code> operator can also be used to compare lists using a boolean condition. (e.g. <code class="literal">[1 2] &lt; [1 3]</code> is <code class="literal">true</code>).
See also <a class="link" href="https://nix.dev/manual/nix/stable/language/operators#comparison"  target="_top">language operators</a> for more information.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.33.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">cmp</code></span></dt><dd><p>The comparison function <code class="literal">a: b: ...</code> must return:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">0</code> if <code class="literal">a</code> and <code class="literal">b</code> are equal</p></li><li class="listitem"><p><code class="literal">1</code> if <code class="literal">a</code> is greater than <code class="literal">b</code></p></li><li class="listitem"><p><code class="literal">-1</code> if <code class="literal">a</code> is less than <code class="literal">b</code></p></li></ul></div><p>See <a class="link" href="index.html#function-library-lib.trivial.compare" title="lib.trivial.compare" >lib.compare</a> for a an example implementation.</p></dd><dt><span class="term"><code class="literal">a</code></span></dt><dd><p>The first list</p></dd><dt><span class="term"><code class="literal">b</code></span></dt><dd><p>The second list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.33.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 181. <code class="literal">lib.lists.compareLists</code> usage examples</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">compareLists lib.compare [] []
=&gt; 0
compareLists lib.compare [] [ &quot;a&quot; ]
=&gt; -1
compareLists lib.compare [ &quot;a&quot; ] []
=&gt; 1
compareLists lib.compare [ &quot;a&quot; &quot;b&quot; ] [ &quot;a&quot; &quot;c&quot; ]
=&gt; -1
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1382"  target="_top">lib/lists.nix:1382</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.naturalSort" class="title" ><code class="literal">lib.lists.naturalSort</code>   </h4>  </div> </div></div><p>Sort list using “Natural sorting”.
Numeric portions of strings are sorted in numeric order.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.34.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">lst</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.34.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 182. <code class="literal">lib.lists.naturalSort</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">naturalSort [&quot;disk11&quot; &quot;disk8&quot; &quot;disk100&quot; &quot;disk9&quot;]
=&gt; [&quot;disk8&quot; &quot;disk9&quot; &quot;disk11&quot; &quot;disk100&quot;]
naturalSort [&quot;10.46.133.149&quot; &quot;10.5.16.62&quot; &quot;10.54.16.25&quot;]
=&gt; [&quot;10.5.16.62&quot; &quot;10.46.133.149&quot; &quot;10.54.16.25&quot;]
naturalSort [&quot;v0.2&quot; &quot;v0.15&quot; &quot;v0.0.9&quot;]
=&gt; [ &quot;v0.0.9&quot; &quot;v0.2&quot; &quot;v0.15&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1419"  target="_top">lib/lists.nix:1419</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.take" class="title" ><code class="literal">lib.lists.take</code>   </h4>  </div> </div></div><p>Return the first (at most) N elements of a list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.35.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">count</code></span></dt><dd><p>Number of elements to take</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.35.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">take :: int -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.35.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 183. <code class="literal">lib.lists.take</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">take 2 [ &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; ]
=&gt; [ &quot;a&quot; &quot;b&quot; ]
take 2 [ ]
=&gt; [ ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1463"  target="_top">lib/lists.nix:1463</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.takeEnd" class="title" ><code class="literal">lib.lists.takeEnd</code>   </h4>  </div> </div></div><p>Return the last (at most) N elements of a list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.36.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">count</code></span></dt><dd><p>Maximum number of elements to pick</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.36.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">takeEnd :: int -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.36.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 184. <code class="literal">lib.lists.takeEnd</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">takeEnd 2 [ &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; ]
=&gt; [ &quot;c&quot; &quot;d&quot; ]
takeEnd 2 [ ]
=&gt; [ ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1497"  target="_top">lib/lists.nix:1497</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.drop" class="title" ><code class="literal">lib.lists.drop</code>   </h4>  </div> </div></div><p>Remove the first (at most) N elements of a list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.37.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">count</code></span></dt><dd><p>Number of elements to drop</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.37.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">drop :: int -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.37.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 185. <code class="literal">lib.lists.drop</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">drop 2 [ &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; ]
=&gt; [ &quot;c&quot; &quot;d&quot; ]
drop 2 [ ]
=&gt; [ ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1531"  target="_top">lib/lists.nix:1531</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.dropEnd" class="title" ><code class="literal">lib.lists.dropEnd</code>   </h4>  </div> </div></div><p>Remove the last (at most) N elements of a list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.38.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">count</code></span></dt><dd><p>Number of elements to drop</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.38.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">dropEnd :: Int -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.38.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 186. <code class="literal">lib.lists.dropEnd</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">  dropEnd 2 [ &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; ]
  =&gt; [ &quot;a&quot; &quot;b&quot; ]
  dropEnd 2 [ ]
  =&gt; [ ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1565"  target="_top">lib/lists.nix:1565</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.hasPrefix" class="title" ><code class="literal">lib.lists.hasPrefix</code>   </h4>  </div> </div></div><p>Whether the first list is a prefix of the second list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.39.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list1</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">list2</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.39.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">hasPrefix :: [a] -&gt; [a] -&gt; bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.39.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 187. <code class="literal">lib.lists.hasPrefix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">hasPrefix [ 1 2 ] [ 1 2 3 4 ]
=&gt; true
hasPrefix [ 0 1 ] [ 1 2 3 4 ]
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1599"  target="_top">lib/lists.nix:1599</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.removePrefix" class="title" ><code class="literal">lib.lists.removePrefix</code>   </h4>  </div> </div></div><p>Remove the first list as a prefix from the second list.
Error if the first list isn’t a prefix of the second list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.40.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list1</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">list2</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.40.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">removePrefix :: [a] -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.40.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 188. <code class="literal">lib.lists.removePrefix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">removePrefix [ 1 2 ] [ 1 2 3 4 ]
=&gt; [ 3 4 ]
removePrefix [ 0 1 ] [ 1 2 3 4 ]
=&gt; &lt;error&gt;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1634"  target="_top">lib/lists.nix:1634</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.sublist" class="title" ><code class="literal">lib.lists.sublist</code>   </h4>  </div> </div></div><p>Return a list consisting of at most <code class="literal">count</code> elements of <code class="literal">list</code>,
starting at index <code class="literal">start</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.41.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">start</code></span></dt><dd><p>Index at which to start the sublist</p></dd><dt><span class="term"><code class="literal">count</code></span></dt><dd><p>Number of elements to take</p></dd><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.41.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">sublist :: int -&gt; int -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.41.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 189. <code class="literal">lib.lists.sublist</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">sublist 1 3 [ &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; &quot;e&quot; ]
=&gt; [ &quot;b&quot; &quot;c&quot; &quot;d&quot; ]
sublist 1 3 [ ]
=&gt; [ ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1678"  target="_top">lib/lists.nix:1678</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.commonPrefix" class="title" ><code class="literal">lib.lists.commonPrefix</code>   </h4>  </div> </div></div><p>The common prefix of two lists.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.42.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list1</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">list2</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.42.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">commonPrefix :: [a] -&gt; [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.42.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 190. <code class="literal">lib.lists.commonPrefix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">commonPrefix [ 1 2 3 4 5 6 ] [ 1 2 4 8 ]
=&gt; [ 1 2 ]
commonPrefix [ 1 2 3 ] [ 1 2 3 4 5 ]
=&gt; [ 1 2 3 ]
commonPrefix [ 1 2 3 ] [ 4 5 6 ]
=&gt; [ ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1726"  target="_top">lib/lists.nix:1726</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.last" class="title" ><code class="literal">lib.lists.last</code>   </h4>  </div> </div></div><p>Return the last element of a list.</p><p>This function throws an error if the list is empty.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.43.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.43.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">last :: [a] -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.43.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 191. <code class="literal">lib.lists.last</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">last [ 1 2 3 ]
=&gt; 3
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1767"  target="_top">lib/lists.nix:1767</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.init" class="title" ><code class="literal">lib.lists.init</code>   </h4>  </div> </div></div><p>Return all elements but the last.</p><p>This function throws an error if the list is empty.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.44.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.44.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">init :: [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.44.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 192. <code class="literal">lib.lists.init</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">init [ 1 2 3 ]
=&gt; [ 1 2 ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1800"  target="_top">lib/lists.nix:1800</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.crossLists" class="title" ><code class="literal">lib.lists.crossLists</code>   </h4>  </div> </div></div><p>Return the image of the cross product of some lists by a function.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.45.1" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 193. <code class="literal">lib.lists.crossLists</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">crossLists (x: y: &quot;${toString x}${toString y}&quot;) [[1 2] [3 4]]
=&gt; [ &quot;13&quot; &quot;14&quot; &quot;23&quot; &quot;24&quot; ]
</code></pre><p>The following function call is equivalent to the one deprecated above:</p><pre><code class="programlisting nix">mapCartesianProduct (x: &quot;${toString x.a}${toString x.b}&quot;) { a = [1 2]; b = [3 4]; }
=&gt; [ &quot;13&quot; &quot;14&quot; &quot;23&quot; &quot;24&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1825"  target="_top">lib/lists.nix:1825</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.unique" class="title" ><code class="literal">lib.lists.unique</code>   </h4>  </div> </div></div><p>Remove duplicate elements from the <code class="literal">list</code>. O(n^2) complexity.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.46.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>Input list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.46.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">unique :: [a] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.46.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 194. <code class="literal">lib.lists.unique</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">unique [ 3 2 3 4 ]
=&gt; [ 3 2 4 ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1865"  target="_top">lib/lists.nix:1865</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.allUnique" class="title" ><code class="literal">lib.lists.allUnique</code>   </h4>  </div> </div></div><p>Check if list contains only unique elements. O(n^2) complexity.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.47.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.47.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">allUnique :: [a] -&gt; bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.47.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 195. <code class="literal">lib.lists.allUnique</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">allUnique [ 3 2 3 4 ]
=&gt; false
allUnique [ 3 2 4 1 ]
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1895"  target="_top">lib/lists.nix:1895</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.intersectLists" class="title" ><code class="literal">lib.lists.intersectLists</code>   </h4>  </div> </div></div><p>Intersects list ‘list1’ and another list (<code class="literal">list2</code>).</p><p>O(nm) complexity.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.48.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">list1</code></span></dt><dd><p>First list</p></dd><dt><span class="term"><code class="literal">list2</code></span></dt><dd><p>Second list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.48.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 196. <code class="literal">lib.lists.intersectLists</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">intersectLists [ 1 2 3 ] [ 6 3 2 ]
=&gt; [ 3 2 ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1923"  target="_top">lib/lists.nix:1923</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.subtractLists" class="title" ><code class="literal">lib.lists.subtractLists</code>   </h4>  </div> </div></div><p>Subtracts list ‘e’ from another list (<code class="literal">list2</code>).</p><p>O(nm) complexity.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.49.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">e</code></span></dt><dd><p>First list</p></dd><dt><span class="term"><code class="literal">list2</code></span></dt><dd><p>Second list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.49.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 197. <code class="literal">lib.lists.subtractLists</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">subtractLists [ 3 2 ] [ 1 2 3 4 5 3 ]
=&gt; [ 1 4 5 ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1951"  target="_top">lib/lists.nix:1951</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.lists.mutuallyExclusive" class="title" ><code class="literal">lib.lists.mutuallyExclusive</code>   </h4>  </div> </div></div><p>Test if two lists have no common element.
It should be slightly more efficient than (intersectLists a b == [])</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-12-1.50.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">a</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">b</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/lists.nix#L1967"  target="_top">lib/lists.nix:1967</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-debug" class="title" >lib.debug: debugging functions   </h3>  </div> </div></div><p>Collection of functions useful for debugging
broken nix expressions.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">trace</code>-like functions take two values, print
the first to stderr and return the second.</p></li><li class="listitem"><p><code class="literal">traceVal</code>-like functions take one argument
which both printed and returned.</p></li><li class="listitem"><p><code class="literal">traceSeq</code>-like functions fully evaluate their
traced value before printing (not just to “weak
head normal form” like trace does by default).</p></li><li class="listitem"><p>Functions that end in <code class="literal">-Fn</code> take an additional
function as their first argument, which is applied
to the traced value before it is printed.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.traceIf" class="title" ><code class="literal">lib.debug.traceIf</code>   </h4>  </div> </div></div><p>Conditionally trace the supplied message, based on a predicate.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pred</code></span></dt><dd><p>Predicate to check</p></dd><dt><span class="term"><code class="literal">msg</code></span></dt><dd><p>Message that should be traced</p></dd><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>Value to return</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.1.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">traceIf :: bool -&gt; string -&gt; a -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.1.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 198. <code class="literal">lib.debug.traceIf</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">traceIf true &quot;hello&quot; 3
trace: hello
=&gt; 3
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L72"  target="_top">lib/debug.nix:72</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.traceValFn" class="title" ><code class="literal">lib.debug.traceValFn</code>   </h4>  </div> </div></div><p>Trace the supplied value after applying a function to it, and
return the original value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>Function to apply</p></dd><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>Value to trace and return</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">traceValFn :: (a -&gt; b) -&gt; a -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.2.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 199. <code class="literal">lib.debug.traceValFn</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">traceValFn (v: &quot;mystring ${v}&quot;) &quot;foo&quot;
trace: mystring foo
=&gt; &quot;foo&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L108"  target="_top">lib/debug.nix:108</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.traceVal" class="title" ><code class="literal">lib.debug.traceVal</code>   </h4>  </div> </div></div><p>Trace the supplied value and return it.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>Value to trace and return</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">traceVal :: a -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.3.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 200. <code class="literal">lib.debug.traceVal</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">traceVal 42
# trace: 42
=&gt; 42
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L137"  target="_top">lib/debug.nix:137</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.traceSeq" class="title" ><code class="literal">lib.debug.traceSeq</code>   </h4>  </div> </div></div><p><code class="literal">builtins.trace</code>, but the value is <code class="literal">builtins.deepSeq</code>ed first.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>The value to trace</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>The value to return</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">traceSeq :: a -&gt; b -&gt; b
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.4.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 201. <code class="literal">lib.debug.traceSeq</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">trace { a.b.c = 3; } null
trace: { a = &lt;CODE&gt;; }
=&gt; null
traceSeq { a.b.c = 3; } null
trace: { a = { b = { c = 3; }; }; }
=&gt; null
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L173"  target="_top">lib/debug.nix:173</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.traceSeqN" class="title" ><code class="literal">lib.debug.traceSeqN</code>   </h4>  </div> </div></div><p>Like <code class="literal">traceSeq</code>, but only evaluate down to depth n.
This is very useful because lots of <code class="literal">traceSeq</code> usages
lead to an infinite recursion.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">depth</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.5.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">traceSeqN :: Int -&gt; a -&gt; b -&gt; b
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.5.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 202. <code class="literal">lib.debug.traceSeqN</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">traceSeqN 2 { a.b.c = 3; } null
trace: { a = { b = {…}; }; }
=&gt; null
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L212"  target="_top">lib/debug.nix:212</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.traceValSeqFn" class="title" ><code class="literal">lib.debug.traceValSeqFn</code>   </h4>  </div> </div></div><p>A combination of <code class="literal">traceVal</code> and <code class="literal">traceSeq</code> that applies a
provided function to the value to be traced after <code class="literal">deepSeq</code>ing
it.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>Function to apply</p></dd><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>Value to trace</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L255"  target="_top">lib/debug.nix:255</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.traceValSeq" class="title" ><code class="literal">lib.debug.traceValSeq</code>   </h4>  </div> </div></div><p>A combination of <code class="literal">traceVal</code> and <code class="literal">traceSeq</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.7.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>Value to trace</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L266"  target="_top">lib/debug.nix:266</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.traceValSeqNFn" class="title" ><code class="literal">lib.debug.traceValSeqNFn</code>   </h4>  </div> </div></div><p>A combination of <code class="literal">traceVal</code> and <code class="literal">traceSeqN</code> that applies a
provided function to the value to be traced.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.8.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>Function to apply</p></dd><dt><span class="term"><code class="literal">depth</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>Value to trace</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L286"  target="_top">lib/debug.nix:286</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.traceValSeqN" class="title" ><code class="literal">lib.debug.traceValSeqN</code>   </h4>  </div> </div></div><p>A combination of <code class="literal">traceVal</code> and <code class="literal">traceSeqN</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.9.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">depth</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>Value to trace</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L303"  target="_top">lib/debug.nix:303</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.traceFnSeqN" class="title" ><code class="literal">lib.debug.traceFnSeqN</code>   </h4>  </div> </div></div><p>Trace the input and output of a function <code class="literal">f</code> named <code class="literal">name</code>,
both down to <code class="literal">depth</code>.</p><p>This is useful for adding around a function call,
to see the before/after of values as they are transformed.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.10.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">depth</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>3. Function argument</p></dd><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>4. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.10.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 203. <code class="literal">lib.debug.traceFnSeqN</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">traceFnSeqN 2 &quot;id&quot; (x: x) { a.b.c = 3; }
trace: { fn = &quot;id&quot;; from = { a.b = {…}; }; to = { a.b = {…}; }; }
=&gt; { a.b.c = 3; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L342"  target="_top">lib/debug.nix:342</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.runTests" class="title" ><code class="literal">lib.debug.runTests</code>   </h4>  </div> </div></div><p>Evaluates a set of tests.</p><p>A test is an attribute set <code class="literal">{expr, expected}</code>,
denoting an expression and its expected result.</p><p>The result is a <code class="literal">list</code> of <span class="strong"><strong>failed tests</strong></span>, each represented as
<code class="literal">{name, expected, result}</code>,</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>expected</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>What was passed as <code class="literal">expected</code></p></li></ul></div></li><li class="listitem"><p>result</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>The actual <code class="literal">result</code> of the test</p></li></ul></div></li></ul></div><p>Used for regression testing of the functions in lib; see
tests.nix for more examples.</p><p>Important: Only attributes that start with <code class="literal">test</code> are executed.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>If you want to run only a subset of the tests add the attribute <code class="literal">tests = [&quot;testName&quot;];</code></p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.11.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">tests</code></span></dt><dd><p>Tests to run</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.11.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">runTests :: {
  tests = [ String ];
  ${testName} :: {
    expr :: a;
    expected :: a;
  };
}
-&gt;
[
  {
    name :: String;
    expected :: a;
    result :: a;
  }
]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.11.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 204. <code class="literal">lib.debug.runTests</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">runTests {
  testAndOk = {
    expr = lib.and true false;
    expected = false;
  };
  testAndFail = {
    expr = lib.and true false;
    expected = true;
  };
}
-&gt;
[
  {
    name = &quot;testAndFail&quot;;
    expected = true;
    result = false;
  }
]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L429"  target="_top">lib/debug.nix:429</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.debug.testAllTrue" class="title" ><code class="literal">lib.debug.testAllTrue</code>   </h4>  </div> </div></div><p>Create a test assuming that list elements are <code class="literal">true</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.12.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">expr</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-13-1.12.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 205. <code class="literal">lib.debug.testAllTrue</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ testX = allTrue [ true ]; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/debug.nix#L476"  target="_top">lib/debug.nix:476</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-options" class="title" >lib.options: NixOS / nixpkgs option handling   </h3>  </div> </div></div><p>Module System option handling.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.isOption" class="title" ><code class="literal">lib.options.isOption</code>   </h4>  </div> </div></div><p>Returns true when the given argument <code class="literal">a</code> is an option</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">a</code></span></dt><dd><p>Any value to check whether it is an option</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.1.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 206. <code class="literal">lib.options.isOption</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">isOption 1             // =&gt; false
isOption (mkOption {}) // =&gt; true
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.1.3" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">isOption :: a -&gt; Bool
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L77"  target="_top">lib/options.nix:77</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.mkOption" class="title" ><code class="literal">lib.options.mkOption</code>   </h4>  </div> </div></div><p>Creates an Option attribute set. mkOption accepts an attribute set with the following keys:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Structured attribute set</span></dt><dd><p>Attribute set containing none or some of the following attributes.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">default</code></span></dt><dd><p>Optional default value used when no definition is given in the configuration.</p></dd><dt><span class="term"><code class="literal">defaultText</code></span></dt><dd><p>Substitute for documenting the <code class="literal">default</code>, if evaluating the default value during documentation rendering is not possible.</p></dd><dd><p>Can be any nix value that evaluates.</p></dd><dd><p>Usage with <code class="literal">lib.literalMD</code> or <code class="literal">lib.literalExpression</code> is supported</p></dd><dt><span class="term"><code class="literal">example</code></span></dt><dd><p>Optional example value used in the manual.</p></dd><dd><p>Can be any nix value that evaluates.</p></dd><dd><p>Usage with <code class="literal">lib.literalMD</code> or <code class="literal">lib.literalExpression</code> is supported</p></dd><dt><span class="term"><code class="literal">description</code></span></dt><dd><p>Optional string describing the option. This is required if option documentation is generated.</p></dd><dt><span class="term"><code class="literal">relatedPackages</code></span></dt><dd><p>Optional related packages used in the manual (see <code class="literal">genRelatedPackages</code> in <code class="literal">../nixos/lib/make-options-doc/default.nix</code>).</p></dd><dt><span class="term"><code class="literal">type</code></span></dt><dd><p>Optional option type, providing type-checking and value merging.</p></dd><dt><span class="term"><code class="literal">apply</code></span></dt><dd><p>Optional function that converts the option value to something else.</p></dd><dt><span class="term"><code class="literal">internal</code></span></dt><dd><p>Optional boolean indicating whether the option is for NixOS developers only.</p></dd><dt><span class="term"><code class="literal">visible</code></span></dt><dd><p>Optional boolean indicating whether the option shows up in the manual. Default: true. Use false to hide the option and any sub-options from submodules. Use “shallow” to hide only sub-options.</p></dd><dt><span class="term"><code class="literal">readOnly</code></span></dt><dd><p>Optional boolean indicating whether the option can be set only once.</p></dd><dt><span class="term"><code class="literal">...</code> (any other attribute)</span></dt><dd><p>Any other attribute is passed through to the resulting option attribute set.</p></dd></dl></div></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.2.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 207. <code class="literal">lib.options.mkOption</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mkOption { }  // =&gt; { _type = &quot;option&quot;; }
mkOption { default = &quot;foo&quot;; } // =&gt; { _type = &quot;option&quot;; default = &quot;foo&quot;; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L135"  target="_top">lib/options.nix:135</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.mkEnableOption" class="title" ><code class="literal">lib.options.mkEnableOption</code>   </h4>  </div> </div></div><p>Creates an option declaration with a default value of ´false´, and can be defined to ´true´.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>Name for the created option</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.3.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 208. <code class="literal">lib.options.mkEnableOption</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># module
let
  eval = lib.evalModules {
    modules = [
      {
        options.foo.enable = mkEnableOption &quot;foo&quot;;

        config.foo.enable = true;
      }
    ];
  };
in
eval.config
=&gt; { foo.enable = true; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L182"  target="_top">lib/options.nix:182</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.mkPackageOption" class="title" ><code class="literal">lib.options.mkPackageOption</code>   </h4>  </div> </div></div><p>Creates an Option attribute set for an option that specifies the
package a module should use for some purpose.</p><p>The package is specified in the third argument under <code class="literal">default</code> as a list of strings
representing its attribute path in nixpkgs (or another package set).
Because of this, you need to pass nixpkgs itself (usually <code class="literal">pkgs</code> in a module;
alternatively to nixpkgs itself, another package set) as the first argument.</p><p>If you pass another package set you should set the <code class="literal">pkgsText</code> option.
This option is used to display the expression for the package set. It is <code class="literal">&quot;pkgs&quot;</code> by default.
If your expression is complex you should parenthesize it, as the <code class="literal">pkgsText</code> argument
is usually immediately followed by an attribute lookup (<code class="literal">.</code>).</p><p>The second argument may be either a string or a list of strings.
It provides the display name of the package in the description of the generated option
(using only the last element if the passed value is a list)
and serves as the fallback value for the <code class="literal">default</code> argument.</p><p>To include extra information in the description, pass <code class="literal">extraDescription</code> to
append arbitrary text to the generated description.</p><p>You can also pass an <code class="literal">example</code> value, either a literal string or an attribute path.</p><p>The <code class="literal">default</code> argument can be omitted if the provided name is
an attribute of pkgs (if <code class="literal">name</code> is a string) or a valid attribute path in pkgs (if <code class="literal">name</code> is a list).
You can also set <code class="literal">default</code> to just a string in which case it is interpreted as an attribute name
(a singleton attribute path, if you will).</p><p>If you wish to explicitly provide no default, pass <code class="literal">null</code> as <code class="literal">default</code>.</p><p>If you want users to be able to set no package, pass <code class="literal">nullable = true</code>.
In this mode a <code class="literal">default = null</code> will not be interpreted as no default and is interpreted literally.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pkgs</code></span></dt><dd><p>Package set (an instantiation of nixpkgs such as pkgs in modules or another package set)</p></dd><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>Name for the package, shown in option description</p></dd><dt><span class="term">Structured function argument</span></dt><dd><p>Attribute set containing the following attributes.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">nullable</code></span></dt><dd><p>Optional whether the package can be null, for example to disable installing a package altogether. Default: <code class="literal">false</code></p></dd><dt><span class="term"><code class="literal">default</code></span></dt><dd><p>Optional attribute path where the default package is located. Default: <code class="literal">name</code>
If omitted will be copied from <code class="literal">name</code></p></dd><dt><span class="term"><code class="literal">example</code></span></dt><dd><p>Optional string or an attribute path to use as an example. Default: <code class="literal">null</code></p></dd><dt><span class="term"><code class="literal">extraDescription</code></span></dt><dd><p>Optional additional text to include in the option description. Default: <code class="literal">&quot;&quot;</code></p></dd><dt><span class="term"><code class="literal">pkgsText</code></span></dt><dd><p>Optional representation of the package set passed as pkgs. Default: <code class="literal">&quot;pkgs&quot;</code></p></dd></dl></div></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkPackageOption :: pkgs -&gt; (string|[string]) -&gt; { nullable? :: bool, default? :: string|[string], example? :: null|string|[string], extraDescription? :: string, pkgsText? :: string } -&gt; option
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.4.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 209. <code class="literal">lib.options.mkPackageOption</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mkPackageOption pkgs &quot;hello&quot; { }
=&gt; { ...; default = pkgs.hello; defaultText = literalExpression &quot;pkgs.hello&quot;; description = &quot;The hello package to use.&quot;; type = package; }

mkPackageOption pkgs &quot;GHC&quot; {
  default = [ &quot;ghc&quot; ];
  example = &quot;pkgs.haskell.packages.ghc92.ghc.withPackages (hkgs: [ hkgs.primes ])&quot;;
}
=&gt; { ...; default = pkgs.ghc; defaultText = literalExpression &quot;pkgs.ghc&quot;; description = &quot;The GHC package to use.&quot;; example = literalExpression &quot;pkgs.haskell.packages.ghc92.ghc.withPackages (hkgs: [ hkgs.primes ])&quot;; type = package; }

mkPackageOption pkgs [ &quot;python3Packages&quot; &quot;pytorch&quot; ] {
  extraDescription = &quot;This is an example and doesn&#x27;t actually do anything.&quot;;
}
=&gt; { ...; default = pkgs.python3Packages.pytorch; defaultText = literalExpression &quot;pkgs.python3Packages.pytorch&quot;; description = &quot;The pytorch package to use. This is an example and doesn&#x27;t actually do anything.&quot;; type = package; }

mkPackageOption pkgs &quot;nushell&quot; {
  nullable = true;
}
=&gt; { ...; default = pkgs.nushell; defaultText = literalExpression &quot;pkgs.nushell&quot;; description = &quot;The nushell package to use.&quot;; type = nullOr package; }

mkPackageOption pkgs &quot;coreutils&quot; {
  default = null;
}
=&gt; { ...; description = &quot;The coreutils package to use.&quot;; type = package; }

mkPackageOption pkgs &quot;dbus&quot; {
  nullable = true;
  default = null;
}
=&gt; { ...; default = null; description = &quot;The dbus package to use.&quot;; type = nullOr package; }

mkPackageOption pkgs.javaPackages &quot;OpenJFX&quot; {
  default = &quot;openjfx20&quot;;
  pkgsText = &quot;pkgs.javaPackages&quot;;
}
=&gt; { ...; default = pkgs.javaPackages.openjfx20; defaultText = literalExpression &quot;pkgs.javaPackages.openjfx20&quot;; description = &quot;The OpenJFX package to use.&quot;; type = package; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L304"  target="_top">lib/options.nix:304</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.mkPackageOptionMD" class="title" ><code class="literal">lib.options.mkPackageOptionMD</code>   </h4>  </div> </div></div><p>Deprecated alias of mkPackageOption, to be removed in 25.05.</p><p>Previously used to create options with markdown documentation, which is no longer required.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L348"  target="_top">lib/options.nix:348</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.mkSinkUndeclaredOptions" class="title" ><code class="literal">lib.options.mkSinkUndeclaredOptions</code>   </h4>  </div> </div></div><p>This option accepts arbitrary definitions, but it does not produce an option value.</p><p>This is useful for sharing a module across different module sets
without having to implement similar features as long as the
values of the options are not accessed.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">attrs</code></span></dt><dd><p>Attribute set whose attributes override the argument to <code class="literal">mkOption</code>.</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L363"  target="_top">lib/options.nix:363</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.mergeDefaultOption" class="title" ><code class="literal">lib.options.mergeDefaultOption</code>   </h4>  </div> </div></div><p>A merge function that merges multiple definitions of an option into a single value</p><div class="caution"><h3 class="title">Caution</h3><p>This function is used as the default merge operation in <code class="literal">lib.types.mkOptionType</code>. In most cases, explicit usage of this function is unnecessary.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.7.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">loc</code></span></dt><dd><p>location of the option in the configuration as a list of strings.</p><p>e.g. <code class="literal">[&quot;boot&quot; &quot;loader &quot;grub&quot; &quot;enable&quot;]</code></p></dd><dt><span class="term"><code class="literal">defs</code></span></dt><dd><p>list of definition values and locations.</p><p>e.g. <code class="literal">[ { file = &quot;/foo.nix&quot;; value = 1; } { file = &quot;/bar.nix&quot;; value = 2 } ]</code></p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.7.2" class="title" >Example   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 210. <code class="literal">lib.options.mergeDefaultOption</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">myType = mkOptionType {
  name = &quot;myType&quot;;
  merge = mergeDefaultOption; # &lt;- This line is redundant. It is the default already.
};
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.7.3" class="title" >Merge behavior   </h5>  </div> </div></div><p>Merging requires all definition values to have the same type.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>If all definitions are booleans, the result of a <code class="literal">foldl&#x27;</code> with the <code class="literal">or</code> operation is returned.</p></li><li class="listitem"><p>If all definitions are strings, they are concatenated. (<code class="literal">lib.concatStrings</code>)</p></li><li class="listitem"><p>If all definitions are integers and all are equal, the first one is returned.</p></li><li class="listitem"><p>If all definitions are lists, they are concatenated. (<code class="literal">++</code>)</p></li><li class="listitem"><p>If all definitions are attribute sets, they are merged. (<code class="literal">lib.mergeAttrs</code>)</p></li><li class="listitem"><p>If all definitions are functions, the first function is applied to the result of the second function. (<code class="literal">f -&gt; x: f x</code>)</p></li><li class="listitem"><p>Otherwise, an error is thrown.</p></li></ul></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L425"  target="_top">lib/options.nix:425</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.mergeOneOption" class="title" ><code class="literal">lib.options.mergeOneOption</code>   </h4>  </div> </div></div><p>Require a single definition.</p><p>WARNING: Does not perform nested checks, as this does not run the merge function!</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L452"  target="_top">lib/options.nix:452</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.mergeUniqueOption" class="title" ><code class="literal">lib.options.mergeUniqueOption</code>   </h4>  </div> </div></div><p>Require a single definition.</p><p>NOTE: When the type is not checked completely by check, pass a merge function for further checking (of sub-attributes, etc).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.9.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">loc</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">defs</code></span></dt><dd><p>3. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L469"  target="_top">lib/options.nix:469</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.mergeEqualOption" class="title" ><code class="literal">lib.options.mergeEqualOption</code>   </h4>  </div> </div></div><p>“Merge” option definitions by checking that they all have the same value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.10.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">loc</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">defs</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L498"  target="_top">lib/options.nix:498</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.getValues" class="title" ><code class="literal">lib.options.getValues</code>   </h4>  </div> </div></div><p>Extracts values of all “value” keys of the given list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.11.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getValues :: [ { value :: a; } ] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.11.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 211. <code class="literal">getValues</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">getValues [ { value = 1; } { value = 2; } ] // =&gt; [ 1 2 ]
getValues [ ]                               // =&gt; [ ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L541"  target="_top">lib/options.nix:541</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.getFiles" class="title" ><code class="literal">lib.options.getFiles</code>   </h4>  </div> </div></div><p>Extracts values of all “file” keys of the given list</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.12.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getFiles :: [ { file :: a; } ] -&gt; [a]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.12.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 212. <code class="literal">getFiles</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">getFiles [ { file = &quot;file1&quot;; } { file = &quot;file2&quot;; } ] // =&gt; [ &quot;file1&quot; &quot;file2&quot; ]
getFiles [ ]                                         // =&gt; [ ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L563"  target="_top">lib/options.nix:563</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.scrubOptionValue" class="title" ><code class="literal">lib.options.scrubOptionValue</code>   </h4>  </div> </div></div><p>This function recursively removes all derivation attributes from
<code class="literal">x</code> except for the <code class="literal">name</code> attribute.</p><p>This is to make the generation of <code class="literal">options.xml</code> much more
efficient: the XML representation of derivations is very large
(on the order of megabytes) and is not actually used by the
manual generator.</p><p>This function was made obsolete by renderOptionValue and is kept for
compatibility with out-of-tree code.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.13.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L629"  target="_top">lib/options.nix:629</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.renderOptionValue" class="title" ><code class="literal">lib.options.renderOptionValue</code>   </h4>  </div> </div></div><p>Ensures that the given option value (default or example) is a <code class="literal">_type</code>d string
by rendering Nix values to <code class="literal">literalExpression</code>s.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.14.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L655"  target="_top">lib/options.nix:655</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.literalExpression" class="title" ><code class="literal">lib.options.literalExpression</code>   </h4>  </div> </div></div><p>For use in the <code class="literal">defaultText</code> and <code class="literal">example</code> option attributes. Causes the
given string to be rendered verbatim in the documentation as Nix code. This
is necessary for complex values, e.g. functions, or values that depend on
other values or packages.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.15.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">text</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L679"  target="_top">lib/options.nix:679</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.literalMD" class="title" ><code class="literal">lib.options.literalMD</code>   </h4>  </div> </div></div><p>For use in the <code class="literal">defaultText</code> and <code class="literal">example</code> option attributes. Causes the
given MD text to be inserted verbatim in the documentation, for when
a <code class="literal">literalExpression</code> would be too hard to read.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.16.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">text</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L702"  target="_top">lib/options.nix:702</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.showOption" class="title" ><code class="literal">lib.options.showOption</code>   </h4>  </div> </div></div><p>Convert an option, described as a list of the option parts to a
human-readable version.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.17.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">parts</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.17.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 213. <code class="literal">showOption</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">(showOption [&quot;foo&quot; &quot;bar&quot; &quot;baz&quot;]) == &quot;foo.bar.baz&quot;
  (showOption [&quot;foo&quot; &quot;bar.baz&quot; &quot;tux&quot;]) == &quot;foo.\&quot;bar.baz\&quot;.tux&quot;
  (showOption [&quot;windowManager&quot; &quot;2bwm&quot; &quot;enable&quot;]) == &quot;windowManager.\&quot;2bwm\&quot;.enable&quot;

Placeholders will not be quoted as they are not actual values:
  (showOption [&quot;foo&quot; &quot;*&quot; &quot;bar&quot;]) == &quot;foo.*.bar&quot;
  (showOption [&quot;foo&quot; &quot;&lt;name&gt;&quot; &quot;bar&quot;]) == &quot;foo.&lt;name&gt;.bar&quot;
  (showOption [&quot;foo&quot; &quot;&lt;myPlaceholder&gt;&quot; &quot;bar&quot;]) == &quot;foo.&lt;myPlaceholder&gt;.bar&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L741"  target="_top">lib/options.nix:741</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.options.showOptionWithDefLocs" class="title" ><code class="literal">lib.options.showOptionWithDefLocs</code>   </h4>  </div> </div></div><p>Pretty prints all option definition locations</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.18.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">option</code></span></dt><dd><p>The option to pretty print</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.18.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 214. <code class="literal">lib.options.showOptionWithDefLocs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">showOptionWithDefLocs { loc = [&quot;x&quot; &quot;y&quot; ]; files = [ &quot;foo.nix&quot; &quot;bar.nix&quot; ];  }
&quot;x.y, with values defined in:\n  - foo.nix\n  - bar.nix\n&quot;
</code></pre><pre><code class="programlisting nix">nix-repl&gt; eval = lib.evalModules {
    modules = [
      {
        options = {
          foo = lib.mkEnableOption &quot;foo&quot;;
        };
      }
    ];
  }

nix-repl&gt; lib.options.showOptionWithDefLocs eval.options.foo
&quot;foo, with values defined in:\n  - &lt;unknown-file&gt;\n&quot;
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-14-1.18.3" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">showDefsSep :: { files :: [ String ]; loc :: [ String ]; ... } -&gt; string
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/options.nix#L829"  target="_top">lib/options.nix:829</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-path" class="title" >lib.path: path functions   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.path.append" class="title" ><code class="literal">lib.path.append</code>   </h4>  </div> </div></div><p>Append a subpath string to a path.</p><p>Like <code class="literal">path + (&quot;/&quot; + string)</code> but safer, because it errors instead of returning potentially surprising results.
More specifically, it checks that the first argument is a <a class="link" href="https://nixos.org/manual/nix/stable/language/values.html#type-path%22"  target="_top">path value type</a>,
and that the second argument is a <a class="link" href="index.html#function-library-lib.path.subpath.isValid" title="lib.path.subpath.isValid" >valid subpath string</a>.</p><p>Laws:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Not influenced by subpath <a class="link" href="index.html#function-library-lib.path.subpath.normalise" title="lib.path.subpath.normalise" >normalisation</a>:</p><pre><code class="programlisting">append p s == append p (subpath.normalise s)
</code></pre></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>The absolute path to append to</p></dd><dt><span class="term"><code class="literal">subpath</code></span></dt><dd><p>The subpath string to append</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.1.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">append :: Path -&gt; String -&gt; Path
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.1.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 215. <code class="literal">append</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">append /foo &quot;bar/baz&quot;
=&gt; /foo/bar/baz

# subpaths don&#x27;t need to be normalised
append /foo &quot;./bar//baz/./&quot;
=&gt; /foo/bar/baz

# can append to root directory
append /. &quot;foo/bar&quot;
=&gt; /foo/bar

# first argument needs to be a path value type
append &quot;/foo&quot; &quot;bar&quot;
=&gt; &lt;error&gt;

# second argument needs to be a valid subpath string
append /foo /bar
=&gt; &lt;error&gt;
append /foo &quot;&quot;
=&gt; &lt;error&gt;
append /foo &quot;/bar&quot;
=&gt; &lt;error&gt;
append /foo &quot;../bar&quot;
=&gt; &lt;error&gt;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/path/default.nix#L236"  target="_top">lib/path/default.nix:236</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.path.hasPrefix" class="title" ><code class="literal">lib.path.hasPrefix</code>   </h4>  </div> </div></div><p>Whether the first path is a component-wise prefix of the second path.</p><p>Laws:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">hasPrefix p q</code> is only true if <a class="link" href="index.html#function-library-lib.path.append" title="lib.path.append" ><code class="literal">q == append p s</code></a> for some <a class="link" href="index.html#function-library-lib.path.subpath.isValid" title="lib.path.subpath.isValid" >subpath</a> <code class="literal">s</code>.</p></li><li class="listitem"><p><code class="literal">hasPrefix</code> is a <a class="link" href="https://en.wikipedia.org/wiki/Partially_ordered_set#Non-strict_partial_order"  target="_top">non-strict partial order</a> over the set of all path values.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path1</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">hasPrefix :: Path -&gt; Path -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.2.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 216. <code class="literal">hasPrefix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">hasPrefix /foo /foo/bar
=&gt; true
hasPrefix /foo /foo
=&gt; true
hasPrefix /foo/bar /foo
=&gt; false
hasPrefix /. /foo
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/path/default.nix#L286"  target="_top">lib/path/default.nix:286</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.path.removePrefix" class="title" ><code class="literal">lib.path.removePrefix</code>   </h4>  </div> </div></div><p>Remove the first path as a component-wise prefix from the second path.
The result is a <a class="link" href="index.html#function-library-lib.path.subpath.normalise" title="lib.path.subpath.normalise" >normalised subpath string</a>.</p><p>Laws:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Inverts <a class="link" href="index.html#function-library-lib.path.append" title="lib.path.append" ><code class="literal">append</code></a> for <a class="link" href="index.html#function-library-lib.path.subpath.normalise" title="lib.path.subpath.normalise" >normalised subpath string</a>:</p><pre><code class="programlisting">removePrefix p (append p s) == subpath.normalise s
</code></pre></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path1</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">removePrefix :: Path -&gt; Path -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.3.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 217. <code class="literal">removePrefix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">removePrefix /foo /foo/bar/baz
=&gt; &quot;./bar/baz&quot;
removePrefix /foo /foo
=&gt; &quot;./.&quot;
removePrefix /foo/bar /foo
=&gt; &lt;error&gt;
removePrefix /. /foo
=&gt; &quot;./foo&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/path/default.nix#L345"  target="_top">lib/path/default.nix:345</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.path.splitRoot" class="title" ><code class="literal">lib.path.splitRoot</code>   </h4>  </div> </div></div><p>Split the filesystem root from a <a class="link" href="https://nixos.org/manual/nix/stable/language/values.html#type-path"  target="_top">path</a>.
The result is an attribute set with these attributes:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">root</code>: The filesystem root of the path, meaning that this directory has no parent directory.</p></li><li class="listitem"><p><code class="literal">subpath</code>: The <a class="link" href="index.html#function-library-lib.path.subpath.normalise" title="lib.path.subpath.normalise" >normalised subpath string</a> that when <a class="link" href="index.html#function-library-lib.path.append" title="lib.path.append" >appended</a> to <code class="literal">root</code> returns the original path.</p></li></ul></div><p>Laws:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="index.html#function-library-lib.path.append" title="lib.path.append" >Appending</a> the <code class="literal">root</code> and <code class="literal">subpath</code> gives the original path:</p><pre><code class="programlisting">p ==
  append
    (splitRoot p).root
    (splitRoot p).subpath
</code></pre></li><li class="listitem"><p>Trying to get the parent directory of <code class="literal">root</code> using <a class="link" href="https://nixos.org/manual/nix/stable/language/builtins.html#builtins-dirOf"  target="_top"><code class="literal">dirOf</code></a> returns <code class="literal">root</code> itself:</p><pre><code class="programlisting">dirOf (splitRoot p).root == (splitRoot p).root
</code></pre></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>The path to split the root off of</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">splitRoot :: Path -&gt; { root :: Path, subpath :: String }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.4.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 218. <code class="literal">splitRoot</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">splitRoot /foo/bar
=&gt; { root = /.; subpath = &quot;./foo/bar&quot;; }

splitRoot /.
=&gt; { root = /.; subpath = &quot;./.&quot;; }

# Nix neutralises `..` path components for all path values automatically
splitRoot /foo/../bar
=&gt; { root = /.; subpath = &quot;./bar&quot;; }

splitRoot &quot;/foo/bar&quot;
=&gt; &lt;error&gt;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/path/default.nix#L422"  target="_top">lib/path/default.nix:422</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.path.hasStorePathPrefix" class="title" ><code class="literal">lib.path.hasStorePathPrefix</code>   </h4>  </div> </div></div><p>Whether a <a class="link" href="https://nixos.org/manual/nix/stable/language/values.html#type-path"  target="_top">path</a>
has a <a class="link" href="https://nixos.org/manual/nix/stable/store/store-path.html#store-path"  target="_top">store path</a>
as a prefix.</p><div class="note"><h3 class="title">Note</h3><p>As with all functions of this <code class="literal">lib.path</code> library, it does not work on paths in strings,
which is how you’d typically get store paths.</p><p>Instead, this function only handles path values themselves,
which occur when Nix files in the store use relative path expressions.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.5.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">hasStorePathPrefix :: Path -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.5.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 219. <code class="literal">hasStorePathPrefix</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Subpaths of derivation outputs have a store path as a prefix
hasStorePathPrefix /nix/store/nvl9ic0pj1fpyln3zaqrf4cclbqdfn1j-foo/bar/baz
=&gt; true

# The store directory itself is not a store path
hasStorePathPrefix /nix/store
=&gt; false

# Derivation outputs are store paths themselves
hasStorePathPrefix /nix/store/nvl9ic0pj1fpyln3zaqrf4cclbqdfn1j-foo
=&gt; true

# Paths outside the Nix store don&#x27;t have a store path prefix
hasStorePathPrefix /home/user
=&gt; false

# Not all paths under the Nix store are store paths
hasStorePathPrefix /nix/store/.links/10gg8k3rmbw8p7gszarbk7qyd9jwxhcfq9i6s5i0qikx8alkk4hq
=&gt; false

# Store derivations are also store paths themselves
hasStorePathPrefix /nix/store/nvl9ic0pj1fpyln3zaqrf4cclbqdfn1j-foo.drv
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/path/default.nix#L492"  target="_top">lib/path/default.nix:492</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.path.subpath.isValid" class="title" ><code class="literal">lib.path.subpath.isValid</code>   </h4>  </div> </div></div><p>Whether a value is a valid subpath string.</p><p>A subpath string points to a specific file or directory within an absolute base directory.
It is a stricter form of a relative path that excludes <code class="literal">..</code> components, since those could escape the base directory.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>The value is a string.</p></li><li class="listitem"><p>The string is not empty.</p></li><li class="listitem"><p>The string doesn’t start with a <code class="literal">/</code>.</p></li><li class="listitem"><p>The string doesn’t contain any <code class="literal">..</code> path components.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>The value to check</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.6.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">subpath.isValid :: String -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.6.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 220. <code class="literal">subpath.isValid</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Not a string
subpath.isValid null
=&gt; false

# Empty string
subpath.isValid &quot;&quot;
=&gt; false

# Absolute path
subpath.isValid &quot;/foo&quot;
=&gt; false

# Contains a `..` path component
subpath.isValid &quot;../foo&quot;
=&gt; false

# Valid subpath
subpath.isValid &quot;foo/bar&quot;
=&gt; true

# Doesn&#x27;t need to be normalised
subpath.isValid &quot;./foo//bar/&quot;
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/path/default.nix#L565"  target="_top">lib/path/default.nix:565</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.path.subpath.join" class="title" ><code class="literal">lib.path.subpath.join</code>   </h4>  </div> </div></div><p>Join subpath strings together using <code class="literal">/</code>, returning a normalised subpath string.</p><p>Like <code class="literal">concatStringsSep &quot;/&quot;</code> but safer, specifically:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>All elements must be <a class="link" href="index.html#function-library-lib.path.subpath.isValid" title="lib.path.subpath.isValid" >valid subpath strings</a>.</p></li><li class="listitem"><p>The result gets <a class="link" href="index.html#function-library-lib.path.subpath.normalise" title="lib.path.subpath.normalise" >normalised</a>.</p></li><li class="listitem"><p>The edge case of an empty list gets properly handled by returning the neutral subpath <code class="literal">&quot;./.&quot;</code>.</p></li></ul></div><p>Laws:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Associativity:</p><pre><code class="programlisting">subpath.join [ x (subpath.join [ y z ]) ] == subpath.join [ (subpath.join [ x y ]) z ]
</code></pre></li><li class="listitem"><p>Identity - <code class="literal">&quot;./.&quot;</code> is the neutral element for normalised paths:</p><pre><code class="programlisting">subpath.join [ ] == &quot;./.&quot;
subpath.join [ (subpath.normalise p) &quot;./.&quot; ] == subpath.normalise p
subpath.join [ &quot;./.&quot; (subpath.normalise p) ] == subpath.normalise p
</code></pre></li><li class="listitem"><p>Normalisation - the result is <a class="link" href="index.html#function-library-lib.path.subpath.normalise" title="lib.path.subpath.normalise" >normalised</a>:</p><pre><code class="programlisting">subpath.join ps == subpath.normalise (subpath.join ps)
</code></pre></li><li class="listitem"><p>For non-empty lists, the implementation is equivalent to <a class="link" href="index.html#function-library-lib.path.subpath.normalise" title="lib.path.subpath.normalise" >normalising</a> the result of <code class="literal">concatStringsSep &quot;/&quot;</code>.
Note that the above laws can be derived from this one:</p><pre><code class="programlisting">ps != [] -&gt; subpath.join ps == subpath.normalise (concatStringsSep &quot;/&quot; ps)
</code></pre></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.7.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">subpaths</code></span></dt><dd><p>The list of subpaths to join together</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.7.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">subpath.join :: [ String ] -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.7.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 221. <code class="literal">subpath.join</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">subpath.join [ &quot;foo&quot; &quot;bar/baz&quot; ]
=&gt; &quot;./foo/bar/baz&quot;

# normalise the result
subpath.join [ &quot;./foo&quot; &quot;.&quot; &quot;bar//./baz/&quot; ]
=&gt; &quot;./foo/bar/baz&quot;

# passing an empty list results in the current directory
subpath.join [ ]
=&gt; &quot;./.&quot;

# elements must be valid subpath strings
subpath.join [ /foo ]
=&gt; &lt;error&gt;
subpath.join [ &quot;&quot; ]
=&gt; &lt;error&gt;
subpath.join [ &quot;/foo&quot; ]
=&gt; &lt;error&gt;
subpath.join [ &quot;../foo&quot; ]
=&gt; &lt;error&gt;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/path/default.nix#L642"  target="_top">lib/path/default.nix:642</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.path.subpath.components" class="title" ><code class="literal">lib.path.subpath.components</code>   </h4>  </div> </div></div><p>Split <a class="link" href="index.html#function-library-lib.path.subpath.isValid" title="lib.path.subpath.isValid" >a subpath</a> into its path component strings.
Throw an error if the subpath isn’t valid.
Note that the returned path components are also <a class="link" href="index.html#function-library-lib.path.subpath.isValid" title="lib.path.subpath.isValid" >valid subpath strings</a>, though they are intentionally not <a class="link" href="index.html#function-library-lib.path.subpath.normalise" title="lib.path.subpath.normalise" >normalised</a>.</p><p>Laws:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Splitting a subpath into components and <a class="link" href="index.html#function-library-lib.path.subpath.join" title="lib.path.subpath.join" >joining</a> the components gives the same subpath but <a class="link" href="index.html#function-library-lib.path.subpath.normalise" title="lib.path.subpath.normalise" >normalised</a>:</p><pre><code class="programlisting">subpath.join (subpath.components s) == subpath.normalise s
</code></pre></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.8.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">subpath</code></span></dt><dd><p>The subpath string to split into components</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.8.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">subpath.components :: String -&gt; [ String ]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.8.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 222. <code class="literal">subpath.components</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">subpath.components &quot;.&quot;
=&gt; [ ]

subpath.components &quot;./foo//bar/./baz/&quot;
=&gt; [ &quot;foo&quot; &quot;bar&quot; &quot;baz&quot; ]

subpath.components &quot;/foo&quot;
=&gt; &lt;error&gt;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/path/default.nix#L702"  target="_top">lib/path/default.nix:702</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.path.subpath.normalise" class="title" ><code class="literal">lib.path.subpath.normalise</code>   </h4>  </div> </div></div><p>Normalise a subpath. Throw an error if the subpath isn’t <a class="link" href="index.html#function-library-lib.path.subpath.isValid" title="lib.path.subpath.isValid" >valid</a>.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Limit repeating <code class="literal">/</code> to a single one.</p></li><li class="listitem"><p>Remove redundant <code class="literal">.</code> components.</p></li><li class="listitem"><p>Remove trailing <code class="literal">/</code> and <code class="literal">/.</code>.</p></li><li class="listitem"><p>Add leading <code class="literal">./</code>.</p></li></ul></div><p>Laws:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Idempotency - normalising multiple times gives the same result:</p><pre><code class="programlisting">subpath.normalise (subpath.normalise p) == subpath.normalise p
</code></pre></li><li class="listitem"><p>Uniqueness - there’s only a single normalisation for the paths that lead to the same file system node:</p><pre><code class="programlisting">subpath.normalise p != subpath.normalise q -&gt; $(realpath ${p}) != $(realpath ${q})
</code></pre></li><li class="listitem"><p>Don’t change the result when <a class="link" href="index.html#function-library-lib.path.append" title="lib.path.append" >appended</a> to a Nix path value:</p><pre><code class="programlisting">append base p == append base (subpath.normalise p)
</code></pre></li><li class="listitem"><p>Don’t change the path according to <code class="literal">realpath</code>:</p><pre><code class="programlisting">$(realpath ${p}) == $(realpath ${subpath.normalise p})
</code></pre></li><li class="listitem"><p>Only error on <a class="link" href="index.html#function-library-lib.path.subpath.isValid" title="lib.path.subpath.isValid" >invalid subpaths</a>:</p><pre><code class="programlisting">builtins.tryEval (subpath.normalise p)).success == subpath.isValid p
</code></pre></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.9.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">subpath</code></span></dt><dd><p>The subpath string to normalise</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.9.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">subpath.normalise :: String -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-15-1.9.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 223. <code class="literal">subpath.normalise</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># limit repeating `/` to a single one
subpath.normalise &quot;foo//bar&quot;
=&gt; &quot;./foo/bar&quot;

# remove redundant `.` components
subpath.normalise &quot;foo/./bar&quot;
=&gt; &quot;./foo/bar&quot;

# add leading `./`
subpath.normalise &quot;foo/bar&quot;
=&gt; &quot;./foo/bar&quot;

# remove trailing `/`
subpath.normalise &quot;foo/bar/&quot;
=&gt; &quot;./foo/bar&quot;

# remove trailing `/.`
subpath.normalise &quot;foo/bar/.&quot;
=&gt; &quot;./foo/bar&quot;

# Return the current directory as `./.`
subpath.normalise &quot;.&quot;
=&gt; &quot;./.&quot;

# error on `..` path components
subpath.normalise &quot;foo/../bar&quot;
=&gt; &lt;error&gt;

# error on empty string
subpath.normalise &quot;&quot;
=&gt; &lt;error&gt;

# error on absolute path
subpath.normalise &quot;/foo&quot;
=&gt; &lt;error&gt;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/path/default.nix#L799"  target="_top">lib/path/default.nix:799</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-fetchers" class="title" >lib.fetchers: functions which can be reused across fetchers   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fetchers.normalizeHash" class="title" ><code class="literal">lib.fetchers.normalizeHash</code>   </h4>  </div> </div></div><p>Converts an attrset containing one of <code class="literal">hash</code>, <code class="literal">sha256</code> or <code class="literal">sha512</code>,
into one containing <code class="literal">outputHash{,Algo}</code> as accepted by <code class="literal">mkDerivation</code>.</p><p>An appropriate “fake hash” is substituted when the hash value is <code class="literal">&quot;&quot;</code>,
as is the <a class="link" href="index.html#sec-pkgs-fetchers-updating-source-hashes-fakehash-method"  >convention for fetchers</a>.</p><p>All other attributes in the set remain as-is.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-16-1.1.1" class="title" >Example   </h5>  </div> </div></div><pre><code class="programlisting nix">normalizeHash { } { hash = &quot;&quot;; foo = &quot;bar&quot;; }
=&gt;
{
  outputHash = lib.fakeHash;
  outputHashAlgo = null;
  foo = &quot;bar&quot;;
}
</code></pre><pre><code class="programlisting nix">normalizeHash { } { sha256 = lib.fakeSha256; }
=&gt;
{
  outputHash = lib.fakeSha256;
  outputHashAlgo = &quot;sha256&quot;;
}
</code></pre><pre><code class="programlisting nix">normalizeHash { } { sha512 = lib.fakeSha512; }
=&gt;
{
  outputHash = lib.fakeSha512;
  outputHashAlgo = &quot;sha512&quot;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-16-1.1.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">normalizeHash :: { hashTypes :: List String, required :: Bool } -&gt; AttrSet -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-16-1.1.3" class="title" >Arguments   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">hashTypes</span></dt><dd><p>the set of attribute names accepted as hash inputs, in addition to <code class="literal">hash</code></p></dd><dt><span class="term">required</span></dt><dd><p>whether to throw if no hash was present in the input; otherwise returns the original input, unmodified</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fetchers.nix#L89"  target="_top">lib/fetchers.nix:89</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fetchers.withNormalizedHash" class="title" ><code class="literal">lib.fetchers.withNormalizedHash</code>   </h4>  </div> </div></div><p>Wraps a function which accepts <code class="literal">outputHash{,Algo}</code> into one which accepts <code class="literal">hash</code> or <code class="literal">sha{256,512}</code></p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-16-1.2.1" class="title" >Example   </h5>  </div> </div></div><pre><code class="programlisting nix">withNormalizedHash { hashTypes = [ &quot;sha256&quot; &quot;sha512&quot; ]; } (
  { outputHash, outputHashAlgo, ... }:
  ...
)
</code></pre><p>is a function which accepts one of <code class="literal">hash</code>, <code class="literal">sha256</code>, or <code class="literal">sha512</code> (or the original’s <code class="literal">outputHash</code> and <code class="literal">outputHashAlgo</code>).</p><p>Its <code class="literal">functionArgs</code> metadata only lists <code class="literal">hash</code> as a parameter, optional iff. <code class="literal">outputHash</code> was an optional parameter of
the original function.  <code class="literal">sha256</code>, <code class="literal">sha512</code>, <code class="literal">outputHash</code>, or <code class="literal">outputHashAlgo</code> are not mentioned in the <code class="literal">functionArgs</code>
metadata.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-16-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">withNormalizedHash :: { hashTypes :: List String } -&gt; (AttrSet -&gt; T) -&gt; (AttrSet -&gt; T)
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-16-1.2.3" class="title" >Arguments   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">hashTypes</span></dt><dd><p>the set of attribute names accepted as hash inputs, in addition to <code class="literal">hash</code></p></dd><dd><p>they must correspond to a valid value for <code class="literal">outputHashAlgo</code>, currently one of: <code class="literal">md5</code>, <code class="literal">sha1</code>, <code class="literal">sha256</code>, or <code class="literal">sha512</code>.</p></dd><dt><span class="term">f</span></dt><dd><p>the function to be wrapped</p></dd></dl></div><div class="note"><h3 class="title">Note</h3><p>In nixpkgs, <code class="literal">mkDerivation</code> rejects MD5 <code class="literal">outputHash</code>es, and SHA-1 is being deprecated.</p><p>As such, there is no reason to add <code class="literal">md5</code> to <code class="literal">hashTypes</code>, and
<code class="literal">sha1</code> should only ever be included for backwards compatibility.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-16-1.2.4" class="title" >Output   </h5>  </div> </div></div><p><code class="literal">withNormalizedHash { inherit hashTypes; } f</code> is functionally equivalent to</p><pre><code class="programlisting nix">args: f (normalizeHash {
  inherit hashTypes;
  required = !(lib.functionArgs f).outputHash;
} args)
</code></pre><p>However, <code class="literal">withNormalizedHash</code> preserves <code class="literal">functionArgs</code> metadata insofar as possible,
and is implemented somewhat more efficiently.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fetchers.nix#L190"  target="_top">lib/fetchers.nix:190</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-filesystem" class="title" >lib.filesystem: filesystem functions   </h3>  </div> </div></div><p>Functions for querying information about the filesystem
without copying any files to the Nix store.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.filesystem.pathType" class="title" ><code class="literal">lib.filesystem.pathType</code>   </h4>  </div> </div></div><p>The type of a path. The path needs to exist and be accessible.
The result is either “directory” for a directory, “regular” for a regular file, “symlink” for a symlink, or “unknown” for anything else.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">path</span></dt><dd><p>The path to query</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.1.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">pathType :: Path -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.1.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 224. <code class="literal">lib.filesystem.pathType</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">pathType /.
=&gt; &quot;directory&quot;

pathType /some/file.nix
=&gt; &quot;regular&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/filesystem.nix#L59"  target="_top">lib/filesystem.nix:59</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.filesystem.pathIsDirectory" class="title" ><code class="literal">lib.filesystem.pathIsDirectory</code>   </h4>  </div> </div></div><p>Whether a path exists and is a directory.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">pathIsDirectory :: Path -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.2.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 225. <code class="literal">lib.filesystem.pathIsDirectory</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">pathIsDirectory /.
=&gt; true

pathIsDirectory /this/does/not/exist
=&gt; false

pathIsDirectory /some/file.nix
=&gt; false
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/filesystem.nix#L111"  target="_top">lib/filesystem.nix:111</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.filesystem.pathIsRegularFile" class="title" ><code class="literal">lib.filesystem.pathIsRegularFile</code>   </h4>  </div> </div></div><p>Whether a path exists and is a regular file, meaning not a symlink or any other special file type.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">pathIsRegularFile :: Path -&gt; Bool
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.3.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 226. <code class="literal">lib.filesystem.pathIsRegularFile</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">pathIsRegularFile /.
=&gt; false

pathIsRegularFile /this/does/not/exist
=&gt; false

pathIsRegularFile /some/file.nix
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/filesystem.nix#L145"  target="_top">lib/filesystem.nix:145</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.filesystem.haskellPathsInDir" class="title" ><code class="literal">lib.filesystem.haskellPathsInDir</code>   </h4>  </div> </div></div><p>A map of all haskell packages defined in the given path,
identified by having a cabal file with the same name as the
directory itself.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">root</code></span></dt><dd><p>The directory within to search</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">Path -&gt; Map String Path
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/filesystem.nix#L164"  target="_top">lib/filesystem.nix:164</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.filesystem.locateDominatingFile" class="title" ><code class="literal">lib.filesystem.locateDominatingFile</code>   </h4>  </div> </div></div><p>Find the first directory containing a file matching ‘pattern’
upward from a given ‘file’.
Returns ‘null’ if no directories contain a file matching ‘pattern’.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pattern</code></span></dt><dd><p>The pattern to search for</p></dd><dt><span class="term"><code class="literal">file</code></span></dt><dd><p>The file to start searching upward from</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.5.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">RegExp -&gt; Path -&gt; Nullable { path : Path; matches : [ MatchResults ]; }
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/filesystem.nix#L201"  target="_top">lib/filesystem.nix:201</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.filesystem.listFilesRecursive" class="title" ><code class="literal">lib.filesystem.listFilesRecursive</code>   </h4>  </div> </div></div><p>Given a directory, return a flattened list of all files within it recursively.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">dir</code></span></dt><dd><p>The path to recursively list</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.6.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">Path -&gt; [ Path ]
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/filesystem.nix#L241"  target="_top">lib/filesystem.nix:241</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.filesystem.packagesFromDirectoryRecursive" class="title" ><code class="literal">lib.filesystem.packagesFromDirectoryRecursive</code>   </h4>  </div> </div></div><p>Transform a directory tree containing package files suitable for
<code class="literal">callPackage</code> into a matching nested attribute set of derivations.</p><p>For a directory tree like this:</p><pre><code class="programlisting">my-packages
├── a.nix
├── b.nix
├── c
│  ├── my-extra-feature.patch
│  ├── package.nix
│  └── support-definitions.nix
└── my-namespace
   ├── d.nix
   ├── e.nix
   └── f
      └── package.nix
</code></pre><p><code class="literal">packagesFromDirectoryRecursive</code> will produce an attribute set like this:</p><pre><code class="programlisting nix"># packagesFromDirectoryRecursive {
#   callPackage = pkgs.callPackage;
#   directory = ./my-packages;
# }
{
  a = pkgs.callPackage ./my-packages/a.nix { };
  b = pkgs.callPackage ./my-packages/b.nix { };
  c = pkgs.callPackage ./my-packages/c/package.nix { };
  my-namespace = {
    d = pkgs.callPackage ./my-packages/my-namespace/d.nix { };
    e = pkgs.callPackage ./my-packages/my-namespace/e.nix { };
    f = pkgs.callPackage ./my-packages/my-namespace/f/package.nix { };
  };
}
</code></pre><p>In particular:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>If the input directory contains a <code class="literal">package.nix</code> file, then
<code class="literal">callPackage &lt;directory&gt;/package.nix { }</code> is returned.</p></li><li class="listitem"><p>Otherwise, the input directory’s contents are listed and transformed into
an attribute set.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: circle;"><li class="listitem"><p>If a regular file’s name has the <code class="literal">.nix</code> extension, it is turned into attribute
where:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square;"><li class="listitem"><p>The attribute name is the file name without the <code class="literal">.nix</code> extension</p></li><li class="listitem"><p>The attribute value is <code class="literal">callPackage &lt;file path&gt; { }</code></p></li></ul></div></li><li class="listitem"><p>Directories are turned into an attribute where:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square;"><li class="listitem"><p>The attribute name is the name of the directory</p></li><li class="listitem"><p>The attribute value is the result of calling
<code class="literal">packagesFromDirectoryRecursive { ... }</code> on the directory.</p></li></ul></div><p>As a result, directories with no <code class="literal">.nix</code> files (including empty
directories) will be transformed into empty attribute sets.</p></li><li class="listitem"><p>Other files are ignored, including symbolic links to directories and to regular <code class="literal">.nix</code>
files; this is because nixlang code cannot distinguish the type of a link’s target.</p></li></ul></div></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.7.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">packagesFromDirectoryRecursive :: {
  callPackage :: Path -&gt; {} -&gt; a,
  newScope? :: AttrSet -&gt; scope,
  directory :: Path,
} -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.7.2" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">callPackage</code></span></dt><dd><p>The function used to convert a Nix file’s path into a leaf of the attribute set.
It is typically the <code class="literal">callPackage</code> function, taken from either <code class="literal">pkgs</code> or a new scope corresponding to the <code class="literal">directory</code>.</p></dd><dt><span class="term"><code class="literal">newScope</code></span></dt><dd><p>If present, this function is used when recursing into a directory, to generate a new scope.
The arguments are updated with the scope’s <code class="literal">callPackage</code> and <code class="literal">newScope</code> functions, so packages can require
anything in their scope, or in an ancestor of their scope.</p></dd><dt><span class="term"><code class="literal">directory</code></span></dt><dd><p>The directory to read package files from.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.7.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 227. Basic use of <code class="literal">lib.packagesFromDirectoryRecursive</code></strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">packagesFromDirectoryRecursive {
  inherit (pkgs) callPackage;
  directory = ./my-packages;
}
=&gt; { ... }
</code></pre><p>In this case, <code class="literal">callPackage</code> will only search <code class="literal">pkgs</code> for a file’s input parameters.
In other words, a file cannot refer to another file in the directory in its input parameters.</p></div></details></div><br class="example-break" /><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 228. Create a scope for the nix files found in a directory</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">packagesFromDirectoryRecursive {
  inherit (pkgs) callPackage newScope;
  directory = ./my-packages;
}
=&gt; { ... }
</code></pre><p>For example, take the following directory structure:</p><pre><code class="programlisting">my-packages
├── a.nix    → { b }: assert b ? b1; ...
└── b
   ├── b1.nix  → { a }: ...
   └── b2.nix
</code></pre><p>Here, <code class="literal">b1.nix</code> can specify <code class="literal">{ a }</code> as a parameter, which <code class="literal">callPackage</code> will resolve as expected.
Likewise, <code class="literal">a.nix</code> receive an attrset corresponding to the contents of the <code class="literal">b</code> directory.</p><div class="note"><h3 class="title">Note</h3><p><code class="literal">a.nix</code> cannot directly take as inputs packages defined in a child directory, such as <code class="literal">b1</code>.</p></div></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/filesystem.nix#L379"  target="_top">lib/filesystem.nix:379</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.filesystem.resolveDefaultNix" class="title" ><code class="literal">lib.filesystem.resolveDefaultNix</code>   </h4>  </div> </div></div><p>Append <code class="literal">/default.nix</code> if the passed path is a directory.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.8.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">resolveDefaultNix :: (Path | String) -&gt; (Path | String)
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.8.2" class="title" >Inputs   </h5>  </div> </div></div><p>A single argument which can be a <a class="link" href="https://nix.dev/manual/nix/stable/language/types#type-path"  target="_top">path</a> value or a string containing an absolute path.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.8.3" class="title" >Output   </h5>  </div> </div></div><p>If the input refers to a directory that exists, the output is that same path with <code class="literal">/default.nix</code> appended.
Furthermore, if the input is a string that ends with <code class="literal">/</code>, <code class="literal">default.nix</code> is appended to it.
Otherwise, the input is returned unchanged.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-17-1.8.4" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 229. <code class="literal">lib.filesystem.resolveDefaultNix</code> usage example</strong></span></summary><div class="example-contents"><p>This expression checks whether <code class="literal">a</code> and <code class="literal">b</code> refer to the same locally available Nix file path.</p><pre><code class="programlisting nix">resolveDefaultNix a == resolveDefaultNix b
</code></pre><p>For instance, if <code class="literal">a</code> is <code class="literal">/some/dir</code> and <code class="literal">b</code> is <code class="literal">/some/dir/default.nix</code>, and <code class="literal">/some/dir/</code> exists, the expression evaluates to <code class="literal">true</code>, despite <code class="literal">a</code> and <code class="literal">b</code> being different references to the same Nix file.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/filesystem.nix#L488"  target="_top">lib/filesystem.nix:488</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p></div></details></div><br class="example-break" />
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-fileset" class="title" >lib.fileset: file set functions   </h3>  </div> </div></div><p><span id="sec-fileset"></span></p><p>The <a class="link" href="index.html#sec-functions-library-fileset" title="lib.fileset: file set functions" ><code class="literal">lib.fileset</code></a> library allows you to work with <span class="emphasis"><em>file sets</em></span>.
A file set is a (mathematical) set of local files that can be added to the Nix store for use in Nix derivations.
File sets are easy and safe to use, providing obvious and composable semantics with good error messages to prevent mistakes.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-fileset-overview" class="title" >Overview   </h4>  </div> </div></div><p>Basics:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >Implicit coercion from paths to file sets</a></p></li><li class="listitem"><p><a class="link" href="index.html#function-library-lib.fileset.maybeMissing" title="lib.fileset.maybeMissing" ><code class="literal">lib.fileset.maybeMissing</code></a>:</p><p>Create a file set from a path that may be missing.</p></li><li class="listitem"><p><a class="link" href="index.html#function-library-lib.fileset.trace" title="lib.fileset.trace" ><code class="literal">lib.fileset.trace</code></a>/<a class="link" href="index.html#function-library-lib.fileset.trace" title="lib.fileset.trace" ><code class="literal">lib.fileset.traceVal</code></a>:</p><p>Pretty-print file sets for debugging.</p></li><li class="listitem"><p><a class="link" href="index.html#function-library-lib.fileset.toSource" title="lib.fileset.toSource" ><code class="literal">lib.fileset.toSource</code></a>:</p><p>Add files in file sets to the store to use as derivation sources.</p></li><li class="listitem"><p><a class="link" href="index.html#function-library-lib.fileset.toList" title="lib.fileset.toList" ><code class="literal">lib.fileset.toList</code></a>:</p><p>The list of files contained in a file set.</p></li></ul></div><p>Combinators:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="index.html#function-library-lib.fileset.union" title="lib.fileset.union" ><code class="literal">lib.fileset.union</code></a>/<a class="link" href="index.html#function-library-lib.fileset.unions" title="lib.fileset.unions" ><code class="literal">lib.fileset.unions</code></a>:</p><p>Create a larger file set from all the files in multiple file sets.</p></li><li class="listitem"><p><a class="link" href="index.html#function-library-lib.fileset.intersection" title="lib.fileset.intersection" ><code class="literal">lib.fileset.intersection</code></a>:</p><p>Create a smaller file set from only the files in both file sets.</p></li><li class="listitem"><p><a class="link" href="index.html#function-library-lib.fileset.difference" title="lib.fileset.difference" ><code class="literal">lib.fileset.difference</code></a>:</p><p>Create a smaller file set containing all files that are in one file set, but not another one.</p></li></ul></div><p>Filtering:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="index.html#function-library-lib.fileset.fileFilter" title="lib.fileset.fileFilter" ><code class="literal">lib.fileset.fileFilter</code></a>:</p><p>Create a file set from all files that satisisfy a predicate in a directory.</p></li></ul></div><p>Utilities:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="index.html#function-library-lib.fileset.fromSource" title="lib.fileset.fromSource" ><code class="literal">lib.fileset.fromSource</code></a>:</p><p>Create a file set from a <code class="literal">lib.sources</code>-based value.</p></li><li class="listitem"><p><a class="link" href="index.html#function-library-lib.fileset.gitTracked" title="lib.fileset.gitTracked" ><code class="literal">lib.fileset.gitTracked</code></a>/<a class="link" href="index.html#function-library-lib.fileset.gitTrackedWith" title="lib.fileset.gitTrackedWith" ><code class="literal">lib.fileset.gitTrackedWith</code></a>:</p><p>Create a file set from all tracked files in a local Git repository.</p></li></ul></div><p>If you need more file set functions,
see <a class="link" href="https://github.com/NixOS/nixpkgs/issues/266356"  target="_top">this issue</a> to request it.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-fileset-path-coercion" class="title" >Implicit coercion from paths to file sets   </h4>  </div> </div></div><p>All functions accepting file sets as arguments can also accept <a class="link" href="https://nixos.org/manual/nix/stable/language/values.html#type-path"  target="_top">paths</a> as arguments.
Such path arguments are implicitly coerced to file sets containing all files under that path:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>A path to a file turns into a file set containing that single file.</p></li><li class="listitem"><p>A path to a directory turns into a file set containing all files <span class="emphasis"><em>recursively</em></span> in that directory.</p></li></ul></div><p>If the path points to a non-existent location, an error is thrown.</p><div class="note"><h3 class="title">Note</h3><p>Just like in Git, file sets cannot represent empty directories.
Because of this, a path to a directory that contains no files (recursively) will turn into a file set containing no files.</p></div><div class="note"><h3 class="title">Note</h3><p>File set coercion does <span class="emphasis"><em>not</em></span> add any of the files under the coerced paths to the store.
Only the <a class="link" href="index.html#function-library-lib.fileset.toSource" title="lib.fileset.toSource" ><code class="literal">toSource</code></a> function adds files to the Nix store, and only those files contained in the <code class="literal">fileset</code> argument.
This is in contrast to using <a class="link" href="https://nixos.org/manual/nix/stable/language/values.html#type-path"  target="_top">paths in string interpolation</a>, which does add the entire referenced path to the store.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="sec-fileset-path-coercion-example" class="title" >Example   </h5>  </div> </div></div><p>Assume we are in a local directory with a file hierarchy like this:</p><pre><code class="programlisting">├─ a/
│  ├─ x (file)
│  └─ b/
│     └─ y (file)
└─ c/
   └─ d/
</code></pre><p>Here’s a listing of which files get included when different path expressions get coerced to file sets:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">./.</code> as a file set contains both <code class="literal">a/x</code> and <code class="literal">a/b/y</code> (<code class="literal">c/</code> does not contain any files and is therefore omitted).</p></li><li class="listitem"><p><code class="literal">./a</code> as a file set contains both <code class="literal">a/x</code> and <code class="literal">a/b/y</code>.</p></li><li class="listitem"><p><code class="literal">./a/x</code> as a file set contains only <code class="literal">a/x</code>.</p></li><li class="listitem"><p><code class="literal">./a/b</code> as a file set contains only <code class="literal">a/b/y</code>.</p></li><li class="listitem"><p><code class="literal">./c</code> as a file set is empty, since neither <code class="literal">c</code> nor <code class="literal">c/d</code> contain any files.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.maybeMissing" class="title" ><code class="literal">lib.fileset.maybeMissing</code>   </h4>  </div> </div></div><p>Create a file set from a path that may or may not exist:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>If the path does exist, the path is <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >coerced to a file set</a>.</p></li><li class="listitem"><p>If the path does not exist, a file set containing no files is returned.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">maybeMissing :: Path -&gt; FileSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.3.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 230. <code class="literal">lib.fileset.maybeMissing</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># All files in the current directory, but excluding main.o if it exists
difference ./. (maybeMissing ./main.o)
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L188"  target="_top">lib/fileset/default.nix:188</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.trace" class="title" ><code class="literal">lib.fileset.trace</code>   </h4>  </div> </div></div><p>Incrementally evaluate and trace a file set in a pretty way.
This function is only intended for debugging purposes.
The exact tracing format is unspecified and may change.</p><p>This function takes a final argument to return.
In comparison, <a class="link" href="index.html#function-library-lib.fileset.traceVal" title="lib.fileset.traceVal" ><code class="literal">traceVal</code></a> returns
the given file set argument.</p><p>This variant is useful for tracing file sets in the Nix repl.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">fileset</code></span></dt><dd><p>The file set to trace.</p><p>This argument can also be a path,
which gets <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >implicitly coerced to a file set</a>.</p></dd><dt><span class="term"><code class="literal">val</code></span></dt><dd><p>The value to return.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">trace :: FileSet -&gt; Any -&gt; Any
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.4.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 231. <code class="literal">lib.fileset.trace</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">trace (unions [ ./Makefile ./src ./tests/run.sh ]) null
=&gt;
trace: /home/user/src/myProject
trace: - Makefile (regular)
trace: - src (all files in directory)
trace: - tests
trace:   - run.sh (regular)
null
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L247"  target="_top">lib/fileset/default.nix:247</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.traceVal" class="title" ><code class="literal">lib.fileset.traceVal</code>   </h4>  </div> </div></div><p>Incrementally evaluate and trace a file set in a pretty way.
This function is only intended for debugging purposes.
The exact tracing format is unspecified and may change.</p><p>This function returns the given file set.
In comparison, <a class="link" href="index.html#function-library-lib.fileset.trace" title="lib.fileset.trace" ><code class="literal">trace</code></a> takes another argument to return.</p><p>This variant is useful for tracing file sets passed as arguments to other functions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">fileset</code></span></dt><dd><p>The file set to trace and return.</p><p>This argument can also be a path,
which gets <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >implicitly coerced to a file set</a>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.5.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">traceVal :: FileSet -&gt; FileSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.5.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 232. <code class="literal">lib.fileset.traceVal</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">toSource {
  root = ./.;
  fileset = traceVal (unions [
    ./Makefile
    ./src
    ./tests/run.sh
  ]);
}
=&gt;
trace: /home/user/src/myProject
trace: - Makefile (regular)
trace: - src (all files in directory)
trace: - tests
trace:   - run.sh (regular)
&quot;/nix/store/...-source&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L305"  target="_top">lib/fileset/default.nix:305</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.toSource" class="title" ><code class="literal">lib.fileset.toSource</code>   </h4>  </div> </div></div><p>Add the local files contained in <code class="literal">fileset</code> to the store as a single <a class="link" href="https://nixos.org/manual/nix/stable/glossary#gloss-store-path"  target="_top">store path</a> rooted at <code class="literal">root</code>.</p><p>The result is the store path as a string-like value, making it usable e.g. as the <code class="literal">src</code> of a derivation, or in string interpolation:</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  src = lib.fileset.toSource { ... };
  # ...
}
</code></pre><p>The name of the store path is always <code class="literal">source</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><p>Takes an attribute set with the following attributes</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">root</code> (Path; <span class="emphasis"><em>required</em></span>)</span></dt><dd><p>The local directory <a class="link" href="https://nixos.org/manual/nix/stable/language/values.html#type-path"  target="_top">path</a> that will correspond to the root of the resulting store path.
Paths in <a class="link" href="https://nixos.org/manual/nix/stable/language/values.html#type-string"  target="_top">strings</a>, including Nix store paths, cannot be passed as <code class="literal">root</code>.
<code class="literal">root</code> has to be a directory.</p><div class="note"><h3 class="title">Note</h3><p>Changing <code class="literal">root</code> only affects the directory structure of the resulting store path, it does not change which files are added to the store.
The only way to change which files get added to the store is by changing the <code class="literal">fileset</code> attribute.</p></div></dd><dt><span class="term"><code class="literal">fileset</code> (FileSet; <span class="emphasis"><em>required</em></span>)</span></dt><dd><p>The file set whose files to import into the store.
File sets can be created using other functions in this library.
This argument can also be a path,
which gets <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >implicitly coerced to a file set</a>.</p><div class="note"><h3 class="title">Note</h3><p>If a directory does not recursively contain any file, it is omitted from the store path contents.</p></div></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.6.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toSource :: {
  root :: Path,
  fileset :: FileSet,
} -&gt; SourceLike
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.6.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 233. <code class="literal">lib.fileset.toSource</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Import the current directory into the store
# but only include files under ./src
toSource {
  root = ./.;
  fileset = ./src;
}
=&gt; &quot;/nix/store/...-source&quot;

# Import the current directory into the store
# but only include ./Makefile and all files under ./src
toSource {
  root = ./.;
  fileset = union
    ./Makefile
    ./src;
}
=&gt; &quot;/nix/store/...-source&quot;

# Trying to include a file outside the root will fail
toSource {
  root = ./.;
  fileset = unions [
    ./Makefile
    ./src
    ../LICENSE
  ];
}
=&gt; &lt;error&gt;

# The root needs to point to a directory that contains all the files
toSource {
  root = ../.;
  fileset = unions [
    ./Makefile
    ./src
    ../LICENSE
  ];
}
=&gt; &quot;/nix/store/...-source&quot;

# The root has to be a local filesystem path
toSource {
  root = &quot;/nix/store/...-source&quot;;
  fileset = ./.;
}
=&gt; &lt;error&gt;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L420"  target="_top">lib/fileset/default.nix:420</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.toList" class="title" ><code class="literal">lib.fileset.toList</code>   </h4>  </div> </div></div><p>The list of file paths contained in the given file set.</p><div class="note"><h3 class="title">Note</h3><p>This function is strict in the entire file set.
This is in contrast with combinators <a class="link" href="index.html#function-library-lib.fileset.union" title="lib.fileset.union" ><code class="literal">lib.fileset.union</code></a>,
<a class="link" href="index.html#function-library-lib.fileset.intersection" title="lib.fileset.intersection" ><code class="literal">lib.fileset.intersection</code></a> and <a class="link" href="index.html#function-library-lib.fileset.difference" title="lib.fileset.difference" ><code class="literal">lib.fileset.difference</code></a>.</p><p>Thus it is recommended to call <code class="literal">toList</code> on file sets created using the combinators,
instead of doing list processing on the result of <code class="literal">toList</code>.</p></div><p>The resulting list of files can be turned back into a file set using <a class="link" href="index.html#function-library-lib.fileset.unions" title="lib.fileset.unions" ><code class="literal">lib.fileset.unions</code></a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.7.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">fileset</code></span></dt><dd><p>The file set whose file paths to return. This argument can also be a path, which gets <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >implicitly coerced to a file set</a>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.7.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toList :: FileSet -&gt; [ Path ]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.7.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 234. <code class="literal">lib.fileset.toList</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">toList ./.
[ ./README.md ./Makefile ./src/main.c ./src/main.h ]

toList (difference ./. ./src)
[ ./README.md ./Makefile ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L514"  target="_top">lib/fileset/default.nix:514</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.union" class="title" ><code class="literal">lib.fileset.union</code>   </h4>  </div> </div></div><p>The file set containing all files that are in either of two given file sets.
This is the same as <a class="link" href="index.html#function-library-lib.fileset.unions" title="lib.fileset.unions" ><code class="literal">unions</code></a>,
but takes just two file sets instead of a list.
See also <a class="link" href="https://en.wikipedia.org/wiki/Union_(set_theory)"  target="_top">Union (set theory)</a>.</p><p>The given file sets are evaluated as lazily as possible,
with the first argument being evaluated first if needed.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.8.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">fileset1</code></span></dt><dd><p>The first file set. This argument can also be a path, which gets <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >implicitly coerced to a file set</a>.</p></dd><dt><span class="term"><code class="literal">fileset2</code></span></dt><dd><p>The second file set. This argument can also be a path, which gets <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >implicitly coerced to a file set</a>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.8.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">union :: FileSet -&gt; FileSet -&gt; FileSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.8.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 235. <code class="literal">lib.fileset.union</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Create a file set containing the file `Makefile`
# and all files recursively in the `src` directory
union ./Makefile ./src

# Create a file set containing the file `Makefile`
# and the LICENSE file from the parent directory
union ./Makefile ../LICENSE
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L557"  target="_top">lib/fileset/default.nix:557</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.unions" class="title" ><code class="literal">lib.fileset.unions</code>   </h4>  </div> </div></div><p>The file set containing all files that are in any of the given file sets.
This is the same as <a class="link" href="index.html#function-library-lib.fileset.unions" title="lib.fileset.unions" ><code class="literal">union</code></a>,
but takes a list of file sets instead of just two.
See also <a class="link" href="https://en.wikipedia.org/wiki/Union_(set_theory)"  target="_top">Union (set theory)</a>.</p><p>The given file sets are evaluated as lazily as possible,
with earlier elements being evaluated first if needed.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.9.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">filesets</code></span></dt><dd><p>A list of file sets. The elements can also be paths, which get <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >implicitly coerced to file sets</a>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.9.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">unions :: [ FileSet ] -&gt; FileSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.9.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 236. <code class="literal">lib.fileset.unions</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Create a file set containing selected files
unions [
  # Include the single file `Makefile` in the current directory
  # This errors if the file doesn&#x27;t exist
  ./Makefile

  # Recursively include all files in the `src/code` directory
  # If this directory is empty this has no effect
  ./src/code

  # Include the files `run.sh` and `unit.c` from the `tests` directory
  ./tests/run.sh
  ./tests/unit.c

  # Include the `LICENSE` file from the parent directory
  ../LICENSE
]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L619"  target="_top">lib/fileset/default.nix:619</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.intersection" class="title" ><code class="literal">lib.fileset.intersection</code>   </h4>  </div> </div></div><p>The file set containing all files that are in both of two given file sets.
See also <a class="link" href="https://en.wikipedia.org/wiki/Intersection_(set_theory)"  target="_top">Intersection (set theory)</a>.</p><p>The given file sets are evaluated as lazily as possible,
with the first argument being evaluated first if needed.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.10.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">fileset1</code></span></dt><dd><p>The first file set. This argument can also be a path, which gets <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >implicitly coerced to a file set</a>.</p></dd><dt><span class="term"><code class="literal">fileset2</code></span></dt><dd><p>The second file set. This argument can also be a path, which gets <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >implicitly coerced to a file set</a>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.10.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">intersection :: FileSet -&gt; FileSet -&gt; FileSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.10.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 237. <code class="literal">lib.fileset.intersection</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Limit the selected files to the ones in ./., so only ./src and ./Makefile
intersection ./. (unions [ ../LICENSE ./src ./Makefile ])
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L670"  target="_top">lib/fileset/default.nix:670</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.difference" class="title" ><code class="literal">lib.fileset.difference</code>   </h4>  </div> </div></div><p>The file set containing all files from the first file set that are not in the second file set.
See also <a class="link" href="https://en.wikipedia.org/wiki/Complement_(set_theory)#Relative_complement"  target="_top">Difference (set theory)</a>.</p><p>The given file sets are evaluated as lazily as possible,
with the first argument being evaluated first if needed.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.11.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">positive</code></span></dt><dd><p>The positive file set. The result can only contain files that are also in this file set.  This argument can also be a path, which gets <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >implicitly coerced to a file set</a>.</p></dd><dt><span class="term"><code class="literal">negative</code></span></dt><dd><p>The negative file set. The result will never contain files that are also in this file set.  This argument can also be a path, which gets <a class="link" href="index.html#sec-fileset-path-coercion" title="Implicit coercion from paths to file sets" >implicitly coerced to a file set</a>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.11.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">difference :: FileSet -&gt; FileSet -&gt; FileSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.11.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 238. <code class="literal">lib.fileset.difference</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Create a file set containing all files from the current directory,
# except ones under ./tests
difference ./. ./tests

let
  # A set of Nix-related files
  nixFiles = unions [ ./default.nix ./nix ./tests/default.nix ];
in
# Create a file set containing all files under ./tests, except ones in `nixFiles`,
# meaning only without ./tests/default.nix
difference ./tests nixFiles
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L729"  target="_top">lib/fileset/default.nix:729</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.fileFilter" class="title" ><code class="literal">lib.fileset.fileFilter</code>   </h4>  </div> </div></div><p>Filter a file set to only contain files matching some predicate.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.12.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">predicate</code></span></dt><dd><p>The predicate function to call on all files contained in given file set.
A file is included in the resulting file set if this function returns true for it.</p><p>This function is called with an attribute set containing these attributes:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">name</code> (String): The name of the file</p></li><li class="listitem"><p><code class="literal">type</code> (String, one of <code class="literal">&quot;regular&quot;</code>, <code class="literal">&quot;symlink&quot;</code> or <code class="literal">&quot;unknown&quot;</code>): The type of the file.
This matches result of calling <a class="link" href="https://nixos.org/manual/nix/stable/language/builtins.html#builtins-readFileType"  target="_top"><code class="literal">builtins.readFileType</code></a> on the file’s path.</p></li><li class="listitem"><p><code class="literal">hasExt</code> (String -&gt; Bool): Whether the file has a certain file extension.
<code class="literal">hasExt ext</code> is true only if <code class="literal">hasSuffix &quot;.${ext}&quot; name</code>.</p><p>This also means that e.g. for a file with name <code class="literal">.gitignore</code>,
<code class="literal">hasExt &quot;gitignore&quot;</code> is true.</p></li></ul></div><p>Other attributes may be added in the future.</p></dd><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>The path whose files to filter</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.12.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">fileFilter ::
  ({
    name :: String,
    type :: String,
    hasExt :: String -&gt; Bool,
    ...
  } -&gt; Bool)
  -&gt; Path
  -&gt; FileSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.12.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 239. <code class="literal">lib.fileset.fileFilter</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Include all regular `default.nix` files in the current directory
fileFilter (file: file.name == &quot;default.nix&quot;) ./.

# Include all non-Nix files from the current directory
fileFilter (file: ! file.hasExt &quot;nix&quot;) ./.

# Include all files that start with a &quot;.&quot; in the current directory
fileFilter (file: hasPrefix &quot;.&quot; file.name) ./.

# Include all regular files (not symlinks or others) in the current directory
fileFilter (file: file.type == &quot;regular&quot;) ./.
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L808"  target="_top">lib/fileset/default.nix:808</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.fromSource" class="title" ><code class="literal">lib.fileset.fromSource</code>   </h4>  </div> </div></div><p>Create a file set with the same files as a <code class="literal">lib.sources</code>-based value.
This does not import any of the files into the store.</p><p>This can be used to gradually migrate from <code class="literal">lib.sources</code>-based filtering to <code class="literal">lib.fileset</code>.</p><p>A file set can be turned back into a source using <a class="link" href="index.html#function-library-lib.fileset.toSource" title="lib.fileset.toSource" ><code class="literal">toSource</code></a>.</p><div class="note"><h3 class="title">Note</h3><p>File sets cannot represent empty directories.
Turning the result of this function back into a source using <code class="literal">toSource</code> will therefore not preserve empty directories.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.13.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">source</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.13.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">fromSource :: SourceLike -&gt; FileSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.13.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 240. <code class="literal">lib.fileset.fromSource</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># There&#x27;s no cleanSource-like function for file sets yet,
# but we can just convert cleanSource to a file set and use it that way
toSource {
  root = ./.;
  fileset = fromSource (lib.sources.cleanSource ./.);
}

# Keeping a previous sourceByRegex (which could be migrated to `lib.fileset.unions`),
# but removing a subdirectory using file set functions
difference
  (fromSource (lib.sources.sourceByRegex ./. [
    &quot;^README\.md$&quot;
    # This regex includes everything in ./doc
    &quot;^doc(/.*)?$&quot;
  ])
  ./doc/generated

# Use cleanSource, but limit it to only include ./Makefile and files under ./src
intersection
  (fromSource (lib.sources.cleanSource ./.))
  (unions [
    ./Makefile
    ./src
  ]);
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L882"  target="_top">lib/fileset/default.nix:882</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.gitTracked" class="title" ><code class="literal">lib.fileset.gitTracked</code>   </h4>  </div> </div></div><p>Create a file set containing all <a class="link" href="https://git-scm.com/book/en/v2/Git-Basics-Recording-Changes-to-the-Repository"  target="_top">Git-tracked files</a> in a repository.</p><p>This function behaves like <a class="link" href="index.html#function-library-lib.fileset.gitTrackedWith" title="lib.fileset.gitTrackedWith" ><code class="literal">gitTrackedWith { }</code></a> - using the defaults.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.14.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>The <a class="link" href="https://nixos.org/manual/nix/stable/language/values#type-path"  target="_top">path</a> to the working directory of a local Git repository.
This directory must contain a <code class="literal">.git</code> file or subdirectory.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.14.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">gitTracked :: Path -&gt; FileSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.14.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 241. <code class="literal">lib.fileset.gitTracked</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Include all files tracked by the Git repository in the current directory
gitTracked ./.

# Include only files tracked by the Git repository in the parent directory
# that are also in the current directory
intersection ./. (gitTracked ../.)
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L941"  target="_top">lib/fileset/default.nix:941</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.fileset.gitTrackedWith" class="title" ><code class="literal">lib.fileset.gitTrackedWith</code>   </h4>  </div> </div></div><p>Create a file set containing all <a class="link" href="https://git-scm.com/book/en/v2/Git-Basics-Recording-Changes-to-the-Repository"  target="_top">Git-tracked files</a> in a repository.
The first argument allows configuration with an attribute set,
while the second argument is the path to the Git working tree.</p><p><code class="literal">gitTrackedWith</code> does not perform any filtering when the path is a <a class="link" href="https://nixos.org/manual/nix/stable/store/store-path.html#store-path"  target="_top">Nix store path</a> and not a repository.
In this way, it accommodates the use case where the expression that makes the <code class="literal">gitTracked</code> call does not reside in an actual git repository anymore,
and has presumably already been fetched in a way that excludes untracked files.
Fetchers with such equivalent behavior include <code class="literal">builtins.fetchGit</code>, <code class="literal">builtins.fetchTree</code> (experimental), and <code class="literal">pkgs.fetchgit</code> when used without <code class="literal">leaveDotGit</code>.</p><p>If you don’t need the configuration,
you can use <a class="link" href="index.html#function-library-lib.fileset.gitTracked" title="lib.fileset.gitTracked" ><code class="literal">gitTracked</code></a> instead.</p><p>This is equivalent to the result of <a class="link" href="index.html#function-library-lib.fileset.unions" title="lib.fileset.unions" ><code class="literal">unions</code></a> on all files returned by <a class="link" href="https://git-scm.com/docs/git-ls-files"  target="_top"><code class="literal">git ls-files</code></a>
(which uses <a class="link" href="https://git-scm.com/docs/git-ls-files#Documentation/git-ls-files.txt--c"  target="_top"><code class="literal">--cached</code></a> by default).</p><div class="warning"><h3 class="title">Warning</h3><p>Currently this function is based on <a class="link" href="https://nixos.org/manual/nix/stable/language/builtins.html#builtins-fetchGit"  target="_top"><code class="literal">builtins.fetchGit</code></a>
As such, this function causes all Git-tracked files to be unnecessarily added to the Nix store,
without being re-usable by <a class="link" href="index.html#function-library-lib.fileset.toSource" title="lib.fileset.toSource" ><code class="literal">toSource</code></a>.</p><p>This may change in the future.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.15.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">options</code> (attribute set)</span></dt><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">recurseSubmodules</code> (optional, default: <code class="literal">false</code>)</span></dt><dd><p>Whether to recurse into <a class="link" href="https://git-scm.com/book/en/v2/Git-Tools-Submodules"  target="_top">Git submodules</a> to also include their tracked files.
If <code class="literal">true</code>, this is equivalent to passing the <a class="link" href="https://git-scm.com/docs/git-ls-files#Documentation/git-ls-files.txt---recurse-submodules"  target="_top">–recurse-submodules</a> flag to <code class="literal">git ls-files</code>.</p></dd><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>The <a class="link" href="https://nixos.org/manual/nix/stable/language/values#type-path"  target="_top">path</a> to the working directory of a local Git repository.
This directory must contain a <code class="literal">.git</code> file or subdirectory.</p></dd></dl></div></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.15.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">gitTrackedWith :: { recurseSubmodules :: Bool ? false } -&gt; Path -&gt; FileSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-18-1.15.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 242. <code class="literal">lib.fileset.gitTrackedWith</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Include all files tracked by the Git repository in the current directory
# and any submodules under it
gitTracked { recurseSubmodules = true; } ./.
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/fileset/default.nix#L996"  target="_top">lib/fileset/default.nix:996</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-sources" class="title" >lib.sources: source filtering functions   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.sources.commitIdFromGitRepo" class="title" ><code class="literal">lib.sources.commitIdFromGitRepo</code>   </h4>  </div> </div></div><p>Get the commit id of a git repo.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.1.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 243. <code class="literal">commitIdFromGitRepo</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">commitIdFromGitRepo &lt;nixpkgs/.git&gt;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/sources.nix#L523"  target="_top">lib/sources.nix:523</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.sources.cleanSource" class="title" ><code class="literal">lib.sources.cleanSource</code>   </h4>  </div> </div></div><p>Filters a source tree removing version control files and directories using cleanSourceFilter.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">src</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.2.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 244. <code class="literal">cleanSource</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">cleanSource ./.
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/sources.nix#L525"  target="_top">lib/sources.nix:525</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.sources.cleanSourceWith" class="title" ><code class="literal">lib.sources.cleanSourceWith</code>   </h4>  </div> </div></div><p>Like <code class="literal">builtins.filterSource</code>, except it will compose with itself,
allowing you to chain multiple calls together without any
intermediate copies being put in the nix store.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.3.1" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 245. <code class="literal">cleanSourceWith</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">lib.cleanSourceWith {
  filter = f;
  src = lib.cleanSourceWith {
    filter = g;
    src = ./.;
  };
}
# Succeeds!

builtins.filterSource f (builtins.filterSource g ./.)
# Fails!
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/sources.nix#L526"  target="_top">lib/sources.nix:526</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.sources.cleanSourceFilter" class="title" ><code class="literal">lib.sources.cleanSourceFilter</code>   </h4>  </div> </div></div><p>A basic filter for <code class="literal">cleanSourceWith</code> that removes
directories of version control system, backup files (*~)
and some generated files.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">type</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/sources.nix#L527"  target="_top">lib/sources.nix:527</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.sources.sourceByRegex" class="title" ><code class="literal">lib.sources.sourceByRegex</code>   </h4>  </div> </div></div><p>Filter sources by a list of regular expressions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">src</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">regexes</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.5.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 246. <code class="literal">sourceByRegex</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">src = sourceByRegex ./my-subproject [&quot;.*\.py$&quot; &quot;^database.sql$&quot;]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/sources.nix#L536"  target="_top">lib/sources.nix:536</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.sources.sourceFilesBySuffices" class="title" ><code class="literal">lib.sources.sourceFilesBySuffices</code>   </h4>  </div> </div></div><p>Get all files ending with the specified suffices from the given
source directory or its descendants, omitting files that do not match
any suffix. The result of the example below will include files like
<code class="literal">./dir/module.c</code> and <code class="literal">./dir/subdir/doc.xml</code> if present.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">src</code></span></dt><dd><p>Path or source containing the files to be returned</p></dd><dt><span class="term"><code class="literal">exts</code></span></dt><dd><p>A list of file suffix strings</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.6.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">sourceLike -&gt; [String] -&gt; Source
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.6.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 247. <code class="literal">sourceFilesBySuffices</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">sourceFilesBySuffices ./. [ &quot;.xml&quot; &quot;.c&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/sources.nix#L537"  target="_top">lib/sources.nix:537</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.sources.trace" class="title" ><code class="literal">lib.sources.trace</code>   </h4>  </div> </div></div><p>Add logging to a source, for troubleshooting the filtering behavior.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.7.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">src</code></span></dt><dd><p>Source to debug. The returned source will behave like this source, but also log its filter invocations.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-19-1.7.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">sources.trace :: sourceLike -&gt; Source
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/sources.nix#L539"  target="_top">lib/sources.nix:539</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-cli" class="title" >lib.cli: command-line serialization functions   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.cli.toGNUCommandLineShell" class="title" ><code class="literal">lib.cli.toGNUCommandLineShell</code>   </h4>  </div> </div></div><p>Automatically convert an attribute set to command-line options.</p><p>This helps protect against malformed command lines and also to reduce
boilerplate related to command-line construction for simple use cases.</p><p><code class="literal">toGNUCommandLineShell</code> returns an escaped shell string.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-20-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">options</code></span></dt><dd><p>How to format the arguments, see <code class="literal">toGNUCommandLine</code></p></dd><dt><span class="term"><code class="literal">attrs</code></span></dt><dd><p>The attributes to transform into arguments.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-20-1.1.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 248. <code class="literal">lib.cli.toGNUCommandLineShell</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">cli.toGNUCommandLineShell {} {
  data = builtins.toJSON { id = 0; };
  X = &quot;PUT&quot;;
  retry = 3;
  retry-delay = null;
  url = [ &quot;https://example.com/foo&quot; &quot;https://example.com/bar&quot; ];
  silent = false;
  verbose = true;
}
=&gt; &quot;&#x27;-X&#x27; &#x27;PUT&#x27; &#x27;--data&#x27; &#x27;{\&quot;id\&quot;:0}&#x27; &#x27;--retry&#x27; &#x27;3&#x27; &#x27;--url&#x27; &#x27;https://example.com/foo&#x27; &#x27;--url&#x27; &#x27;https://example.com/bar&#x27; &#x27;--verbose&#x27;&quot;;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/cli.nix#L41"  target="_top">lib/cli.nix:41</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.cli.toGNUCommandLine" class="title" ><code class="literal">lib.cli.toGNUCommandLine</code>   </h4>  </div> </div></div><p>Automatically convert an attribute set to a list of command-line options.</p><p><code class="literal">toGNUCommandLine</code> returns a list of string arguments.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-20-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">options</code></span></dt><dd><p>How to format the arguments, see below.</p></dd><dt><span class="term"><code class="literal">attrs</code></span></dt><dd><p>The attributes to transform into arguments.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-20-1.2.2" class="title" >Options   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">mkOptionName</code></span></dt><dd><p>How to string-format the option name;
By default one character is a short option (<code class="literal">-</code>), more than one characters a long option (<code class="literal">--</code>).</p></dd><dt><span class="term"><code class="literal">mkBool</code></span></dt><dd><p>How to format a boolean value to a command list;
By default it’s a flag option (only the option name if true, left out completely if false).</p></dd><dt><span class="term"><code class="literal">mkList</code></span></dt><dd><p>How to format a list value to a command list;
By default the option name is repeated for each value and <code class="literal">mkOption</code> is applied to the values themselves.</p></dd><dt><span class="term"><code class="literal">mkOption</code></span></dt><dd><p>How to format any remaining value to a command list;
On the toplevel, booleans and lists are handled by <code class="literal">mkBool</code> and <code class="literal">mkList</code>, though they can still appear as values of a list.
By default, everything is printed verbatim and complex types are forbidden (lists, attrsets, functions). <code class="literal">null</code> values are omitted.</p></dd><dt><span class="term"><code class="literal">optionValueSeparator</code></span></dt><dd><p>How to separate an option from its flag;
By default, there is no separator, so option <code class="literal">-c</code> and value <code class="literal">5</code> would become [“-c” “5”].
This is useful if the command requires equals, for example, <code class="literal">-c=5</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-20-1.2.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 249. <code class="literal">lib.cli.toGNUCommandLine</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">cli.toGNUCommandLine {} {
  data = builtins.toJSON { id = 0; };
  X = &quot;PUT&quot;;
  retry = 3;
  retry-delay = null;
  url = [ &quot;https://example.com/foo&quot; &quot;https://example.com/bar&quot; ];
  silent = false;
  verbose = true;
}
=&gt; [
  &quot;-X&quot; &quot;PUT&quot;
  &quot;--data&quot; &quot;{\&quot;id\&quot;:0}&quot;
  &quot;--retry&quot; &quot;3&quot;
  &quot;--url&quot; &quot;https://example.com/foo&quot;
  &quot;--url&quot; &quot;https://example.com/bar&quot;
  &quot;--verbose&quot;
]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/cli.nix#L113"  target="_top">lib/cli.nix:113</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-generators" class="title" >lib.generators: functions that create file formats from nix data structures   </h3>  </div> </div></div><p>Functions that generate widespread file
formats from nix data structures.</p><p>They all follow a similar interface:</p><pre><code class="programlisting nix">generator { config-attrs } data
</code></pre><p><code class="literal">config-attrs</code> are “holes” in the generators
with sensible default implementations that
can be overwritten. The default implementations
are mostly generators themselves, called with
their respective default values; they can be reused.</p><p>Tests can be found in ./tests/misc.nix</p><p>Further Documentation can be found <a class="link" href="index.html#sec-generators" title="Generators" >here</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.mkValueStringDefault" class="title" ><code class="literal">lib.generators.mkValueStringDefault</code>   </h4>  </div> </div></div><p>Convert a value to a sensible default string representation.
The builtin <code class="literal">toString</code> function has some strange defaults,
suitable for bash scripts but not much else.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Options</span></dt><dd><p>Empty set, there may be configuration options in the future</p></dd><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L92"  target="_top">lib/generators.nix:92</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.mkKeyValueDefault" class="title" ><code class="literal">lib.generators.mkKeyValueDefault</code>   </h4>  </div> </div></div><p>Generate a line of key k and value v, separated by
character sep. If sep appears in k, it is escaped.
Helper for synaxes with different separators.</p><p>mkValueString specifies how values should be formatted.</p><pre><code class="programlisting nix">mkKeyValueDefault {} &quot;:&quot; &quot;f:oo&quot; &quot;bar&quot;
&gt; &quot;f\:oo:bar&quot;
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Structured function argument</span></dt><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">mkValueString (optional, default: <code class="literal">mkValueStringDefault {}</code>)</span></dt><dd><p>Function to convert values to strings</p></dd></dl></div></dd><dt><span class="term"><code class="literal">sep</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">k</code></span></dt><dd><p>3. Function argument</p></dd><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>4. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L161"  target="_top">lib/generators.nix:161</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.toKeyValue" class="title" ><code class="literal">lib.generators.toKeyValue</code>   </h4>  </div> </div></div><p>Generate a key-value-style config file from an attrset.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Structured function argument</span></dt><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">mkKeyValue (optional, default: <code class="literal">mkKeyValueDefault {} &quot;=&quot;</code>)</span></dt><dd><p>format a setting line from key and value</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">listsAsDuplicateKeys (optional, default: <code class="literal">false</code>)</span></dt><dd><p>allow lists as values for duplicate keys</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">indent (optional, default: <code class="literal">&quot;&quot;</code>)</span></dt><dd><p>Initial indentation level</p></dd></dl></div></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L186"  target="_top">lib/generators.nix:186</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.toINI" class="title" ><code class="literal">lib.generators.toINI</code>   </h4>  </div> </div></div><p>Generate an INI-style config file from an
attrset of sections to an attrset of key-value pairs.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Structured function argument</span></dt><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">mkSectionName (optional, default: <code class="literal">(name: escape [ &quot;[&quot; &quot;]&quot; ] name)</code>)</span></dt><dd><p>apply transformations (e.g. escapes) to section names</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">mkKeyValue (optional, default: <code class="literal">{} &quot;=&quot;</code>)</span></dt><dd><p>format a setting line from key and value</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">listsAsDuplicateKeys (optional, default: <code class="literal">false</code>)</span></dt><dd><p>allow lists as values for duplicate keys</p></dd></dl></div></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.4.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 250. <code class="literal">lib.generators.toINI</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">generators.toINI {} {
  foo = { hi = &quot;${pkgs.hello}&quot;; ciao = &quot;bar&quot;; };
  baz = { &quot;also, integers&quot; = 42; };
}

&gt; [baz]
&gt; also, integers=42
&gt;
&gt; [foo]
&gt; ciao=bar
&gt; hi=/nix/store/y93qql1p5ggfnaqjjqhxcw0vqw95rlz0-hello-2.10
</code></pre><p>The mk* configuration attributes can generically change
the way sections and key-value strings are generated.</p><p>For more examples see the test cases in ./tests/misc.nix.</p></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L244"  target="_top">lib/generators.nix:244</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.toINIWithGlobalSection" class="title" ><code class="literal">lib.generators.toINIWithGlobalSection</code>   </h4>  </div> </div></div><p>Generate an INI-style config file from an attrset
specifying the global section (no header), and an
attrset of sections to an attrset of key-value pairs.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">1. Structured function argument</span></dt><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">mkSectionName (optional, default: <code class="literal">(name: escape [ &quot;[&quot; &quot;]&quot; ] name)</code>)</span></dt><dd><p>apply transformations (e.g. escapes) to section names</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">mkKeyValue (optional, default: <code class="literal">{} &quot;=&quot;</code>)</span></dt><dd><p>format a setting line from key and value</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">listsAsDuplicateKeys (optional, default: <code class="literal">false</code>)</span></dt><dd><p>allow lists as values for duplicate keys</p></dd></dl></div></dd><dt><span class="term">2. Structured function argument</span></dt><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">globalSection (required)</span></dt><dd><p>global section key-value pairs</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">sections (optional, default: <code class="literal">{}</code>)</span></dt><dd><p>attrset of sections to key-value pairs</p></dd></dl></div></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.5.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 251. <code class="literal">lib.generators.toINIWithGlobalSection</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">generators.toINIWithGlobalSection {} {
  globalSection = {
    someGlobalKey = &quot;hi&quot;;
  };
  sections = {
    foo = { hi = &quot;${pkgs.hello}&quot;; ciao = &quot;bar&quot;; };
    baz = { &quot;also, integers&quot; = 42; };
}

&gt; someGlobalKey=hi
&gt;
&gt; [baz]
&gt; also, integers=42
&gt;
&gt; [foo]
&gt; ciao=bar
&gt; hi=/nix/store/y93qql1p5ggfnaqjjqhxcw0vqw95rlz0-hello-2.10
</code></pre><p>The mk* configuration attributes can generically change
the way sections and key-value strings are generated.</p><p>For more examples see the test cases in ./tests/misc.nix.</p></div></details></div><br class="example-break" /><p>If you don’t need a global section, you can also use
<code class="literal">generators.toINI</code> directly, which only takes
the part in <code class="literal">sections</code>.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L327"  target="_top">lib/generators.nix:327</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.toGitINI" class="title" ><code class="literal">lib.generators.toGitINI</code>   </h4>  </div> </div></div><p>Generate a git-config file from an attrset.</p><p>It has two major differences from the regular INI format:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>values are indented with tabs</p></li><li class="listitem"><p>sections can have sub-sections</p></li></ol></div><p>Further: https://git-scm.com/docs/git-config#EXAMPLES</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.6.1" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 252. <code class="literal">lib.generators.toGitINI</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">generators.toGitINI {
  url.&quot;ssh://git@github.com/&quot;.insteadOf = &quot;https://github.com&quot;;
  user.name = &quot;edolstra&quot;;
}

&gt; [url &quot;ssh://git@github.com/&quot;]
&gt;   insteadOf = &quot;https://github.com&quot;
&gt;
&gt; [user]
&gt;   name = &quot;edolstra&quot;
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.6.2" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">attrs</code></span></dt><dd><p>Key-value pairs to be converted to a git-config file.
See: https://git-scm.com/docs/git-config#_variables for possible values.</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L381"  target="_top">lib/generators.nix:381</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.mkDconfKeyValue" class="title" ><code class="literal">lib.generators.mkDconfKeyValue</code>   </h4>  </div> </div></div><p>mkKeyValueDefault wrapper that handles dconf INI quirks.
The main differences of the format is that it requires strings to be quoted.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L436"  target="_top">lib/generators.nix:436</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.toDconfINI" class="title" ><code class="literal">lib.generators.toDconfINI</code>   </h4>  </div> </div></div><p>Generates INI in dconf keyfile style. See https://help.gnome.org/admin/system-admin-guide/stable/dconf-keyfiles.html.en
for details.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L442"  target="_top">lib/generators.nix:442</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.withRecursion" class="title" ><code class="literal">lib.generators.withRecursion</code>   </h4>  </div> </div></div><p>Recurses through a <code class="literal">Value</code> limited to a certain depth. (<code class="literal">depthLimit</code>)</p><p>If the depth is exceeded, an error is thrown, unless <code class="literal">throwOnDepthLimit</code> is set to <code class="literal">false</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.9.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Structured function argument</span></dt><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">depthLimit (required)</span></dt><dd><p>If this option is not null, the given value will stop evaluating at a certain depth</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">throwOnDepthLimit (optional, default: <code class="literal">true</code>)</span></dt><dd><p>If this option is true, an error will be thrown, if a certain given depth is exceeded</p></dd></dl></div></dd><dt><span class="term">Value</span></dt><dd><p>The value to be evaluated recursively</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L462"  target="_top">lib/generators.nix:462</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.toPretty" class="title" ><code class="literal">lib.generators.toPretty</code>   </h4>  </div> </div></div><p>Pretty print a value, akin to <code class="literal">builtins.trace</code>.</p><p>Should probably be a builtin as well.</p><p>The pretty-printed string should be suitable for rendering default values
in the NixOS manual. In particular, it should be as close to a valid Nix expression
as possible.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.10.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Structured function argument</span></dt><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">allowPrettyValues</span></dt><dd><p>If this option is true, attrsets like { __pretty = fn; val = …; }
will use fn to convert val to a pretty printed representation.
(This means fn is type Val -&gt; String.)</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">multiline</span></dt><dd><p>If this option is true, the output is indented with newlines for attribute sets and lists</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">indent</span></dt><dd><p>Initial indentation level</p></dd></dl></div></dd><dt><span class="term">Value</span></dt><dd><p>The value to be pretty printed</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L523"  target="_top">lib/generators.nix:523</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.toPlist" class="title" ><code class="literal">lib.generators.toPlist</code>   </h4>  </div> </div></div><p>Translate a simple Nix expression to <a class="link" href="https://en.wikipedia.org/wiki/Property_list"  target="_top">Plist notation</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.11.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Structured function argument</span></dt><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">escape (optional, default: <code class="literal">false</code>)</span></dt><dd><p>If this option is true, XML special characters are escaped in string values and keys</p></dd></dl></div></dd><dt><span class="term">Value</span></dt><dd><p>The value to be converted to Plist</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L627"  target="_top">lib/generators.nix:627</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.toDhall" class="title" ><code class="literal">lib.generators.toDhall</code>   </h4>  </div> </div></div><p>Translate a simple Nix expression to Dhall notation.</p><p>Note that integers are translated to Integer and never
the Natural type.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.12.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Options</span></dt><dd><p>Empty set, there may be configuration options in the future</p></dd><dt><span class="term">Value</span></dt><dd><p>The value to be converted to Dhall</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L728"  target="_top">lib/generators.nix:728</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.toLua" class="title" ><code class="literal">lib.generators.toLua</code>   </h4>  </div> </div></div><p>Translate a simple Nix expression to Lua representation with occasional
Lua-inlines that can be constructed by mkLuaInline function.</p><p>Configuration:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>multiline - by default is true which results in indented block-like view.</p></li><li class="listitem"><p>indent - initial indent.</p></li><li class="listitem"><p>asBindings - by default generate single value, but with this use attrset to set global vars.</p></li></ul></div><p>Attention:</p><p>Regardless of multiline parameter there is no trailing newline.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.13.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term">Structured function argument</span></dt><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">multiline (optional, default: <code class="literal">true</code>)</span></dt><dd><p>If this option is true, the output is indented with newlines for attribute sets and lists</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">indent (optional, default: <code class="literal">&quot;&quot;</code>)</span></dt><dd><p>Initial indentation level</p></dd></dl></div></dd><dd><div class="variablelist"><dl class="variablelist"><dt><span class="term">asBindings (optional, default: <code class="literal">false</code>)</span></dt><dd><p>Interpret as variable bindings</p></dd></dl></div></dd><dt><span class="term">Value</span></dt><dd><p>The value to be converted to Lua</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.13.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">toLua :: AttrSet -&gt; Any -&gt; String
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.13.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 253. <code class="literal">lib.generators.toLua</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">generators.toLua {}
  {
    cmd = [ &quot;typescript-language-server&quot; &quot;--stdio&quot; ];
    settings.workspace.library = mkLuaInline &#x27;&#x27;vim.api.nvim_get_runtime_file(&quot;&quot;, true)&#x27;&#x27;;
  }
-&gt;
 {
   [&quot;cmd&quot;] = {
     &quot;typescript-language-server&quot;,
     &quot;--stdio&quot;
   },
   [&quot;settings&quot;] = {
     [&quot;workspace&quot;] = {
       [&quot;library&quot;] = (vim.api.nvim_get_runtime_file(&quot;&quot;, true))
     }
   }
 }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L810"  target="_top">lib/generators.nix:810</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.generators.mkLuaInline" class="title" ><code class="literal">lib.generators.mkLuaInline</code>   </h4>  </div> </div></div><p>Mark string as Lua expression to be inlined when processed by toLua.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.14.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">expr</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-21-1.14.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkLuaInline :: String -&gt; AttrSet
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/generators.nix#L885"  target="_top">lib/generators.nix:885</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-gvariant" class="title" >lib.gvariant: GVariant formatted string serialization functions   </h3>  </div> </div></div><p>A partial and basic implementation of GVariant formatted strings.
See <a class="link" href="https://docs.gtk.org/glib/gvariant-format-strings.html"  target="_top">GVariant Format Strings</a> for details.</p><div class="warning"><h3 class="title">Warning</h3><p>This API is not considered fully stable and it might therefore
change in backwards incompatible ways without prior notice.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.isGVariant" class="title" ><code class="literal">lib.gvariant.isGVariant</code>   </h4>  </div> </div></div><p>Check if a value is a GVariant value</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>value to check</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.1.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">isGVariant :: Any -&gt; Bool
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L69"  target="_top">lib/gvariant.nix:69</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkValue" class="title" ><code class="literal">lib.gvariant.mkValue</code>   </h4>  </div> </div></div><p>Returns the GVariant value that most closely matches the given Nix value.
If no GVariant value can be found unambiguously then error is thrown.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkValue :: Any -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L134"  target="_top">lib/gvariant.nix:134</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkArray" class="title" ><code class="literal">lib.gvariant.mkArray</code>   </h4>  </div> </div></div><p>Returns the GVariant array from the given type of the elements and a Nix list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">elems</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkArray :: [Any] -&gt; gvariant
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.3.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 254. <code class="literal">lib.gvariant.mkArray</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Creating a string array
lib.gvariant.mkArray [ &quot;a&quot; &quot;b&quot; &quot;c&quot; ]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L191"  target="_top">lib/gvariant.nix:191</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkEmptyArray" class="title" ><code class="literal">lib.gvariant.mkEmptyArray</code>   </h4>  </div> </div></div><p>Returns the GVariant array from the given empty Nix list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">elemType</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkEmptyArray :: gvariant.type -&gt; gvariant
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.4.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 255. <code class="literal">lib.gvariant.mkEmptyArray</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># Creating an empty string array
lib.gvariant.mkEmptyArray (lib.gvariant.type.string)
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L230"  target="_top">lib/gvariant.nix:230</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkVariant" class="title" ><code class="literal">lib.gvariant.mkVariant</code>   </h4>  </div> </div></div><p>Returns the GVariant variant from the given Nix value. Variants are containers
of different GVariant type.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">elem</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.5.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkVariant :: Any -&gt; gvariant
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.5.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 256. <code class="literal">lib.gvariant.mkVariant</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">lib.gvariant.mkArray [
  (lib.gvariant.mkVariant &quot;a string&quot;)
  (lib.gvariant.mkVariant (lib.gvariant.mkInt32 1))
]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L266"  target="_top">lib/gvariant.nix:266</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkDictionaryEntry" class="title" ><code class="literal">lib.gvariant.mkDictionaryEntry</code>   </h4>  </div> </div></div><p>Returns the GVariant dictionary entry from the given key and value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>The key of the entry</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>The value of the entry</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.6.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkDictionaryEntry :: String -&gt; Any -&gt; gvariant
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.6.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 257. <code class="literal">lib.gvariant.mkDictionaryEntry</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix"># A dictionary describing an Epiphany’s search provider
[
  (lib.gvariant.mkDictionaryEntry &quot;url&quot; (lib.gvariant.mkVariant &quot;https://duckduckgo.com/?q=%s&amp;t=epiphany&quot;))
  (lib.gvariant.mkDictionaryEntry &quot;bang&quot; (lib.gvariant.mkVariant &quot;!d&quot;))
  (lib.gvariant.mkDictionaryEntry &quot;name&quot; (lib.gvariant.mkVariant &quot;DuckDuckGo&quot;))
]
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L310"  target="_top">lib/gvariant.nix:310</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkMaybe" class="title" ><code class="literal">lib.gvariant.mkMaybe</code>   </h4>  </div> </div></div><p>Returns the GVariant maybe from the given element type.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.7.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">elemType</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">elem</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.7.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkMaybe :: gvariant.type -&gt; Any -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L341"  target="_top">lib/gvariant.nix:341</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkNothing" class="title" ><code class="literal">lib.gvariant.mkNothing</code>   </h4>  </div> </div></div><p>Returns the GVariant nothing from the given element type.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.8.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">elemType</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.8.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkNothing :: gvariant.type -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L364"  target="_top">lib/gvariant.nix:364</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkJust" class="title" ><code class="literal">lib.gvariant.mkJust</code>   </h4>  </div> </div></div><p>Returns the GVariant just from the given Nix value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.9.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">elem</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.9.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkJust :: Any -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L381"  target="_top">lib/gvariant.nix:381</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkTuple" class="title" ><code class="literal">lib.gvariant.mkTuple</code>   </h4>  </div> </div></div><p>Returns the GVariant tuple from the given Nix list.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.10.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">elems</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.10.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkTuple :: [Any] -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L403"  target="_top">lib/gvariant.nix:403</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkBoolean" class="title" ><code class="literal">lib.gvariant.mkBoolean</code>   </h4>  </div> </div></div><p>Returns the GVariant boolean from the given Nix bool value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.11.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.11.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkBoolean :: Bool -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L429"  target="_top">lib/gvariant.nix:429</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkString" class="title" ><code class="literal">lib.gvariant.mkString</code>   </h4>  </div> </div></div><p>Returns the GVariant string from the given Nix string value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.12.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.12.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkString :: String -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L451"  target="_top">lib/gvariant.nix:451</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkObjectpath" class="title" ><code class="literal">lib.gvariant.mkObjectpath</code>   </h4>  </div> </div></div><p>Returns the GVariant object path from the given Nix string value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.13.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.13.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkObjectpath :: String -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L476"  target="_top">lib/gvariant.nix:476</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkUchar" class="title" ><code class="literal">lib.gvariant.mkUchar</code>   </h4>  </div> </div></div><p>Returns the GVariant uchar from the given Nix int value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.14.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkUchar :: Int -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L492"  target="_top">lib/gvariant.nix:492</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkInt16" class="title" ><code class="literal">lib.gvariant.mkInt16</code>   </h4>  </div> </div></div><p>Returns the GVariant int16 from the given Nix int value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.15.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkInt16 :: Int -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L503"  target="_top">lib/gvariant.nix:503</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkUint16" class="title" ><code class="literal">lib.gvariant.mkUint16</code>   </h4>  </div> </div></div><p>Returns the GVariant uint16 from the given Nix int value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.16.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkUint16 :: Int -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L514"  target="_top">lib/gvariant.nix:514</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkInt32" class="title" ><code class="literal">lib.gvariant.mkInt32</code>   </h4>  </div> </div></div><p>Returns the GVariant int32 from the given Nix int value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.17.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.17.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkInt32 :: Int -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L531"  target="_top">lib/gvariant.nix:531</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkUint32" class="title" ><code class="literal">lib.gvariant.mkUint32</code>   </h4>  </div> </div></div><p>Returns the GVariant uint32 from the given Nix int value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.18.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkUint32 :: Int -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L547"  target="_top">lib/gvariant.nix:547</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkInt64" class="title" ><code class="literal">lib.gvariant.mkInt64</code>   </h4>  </div> </div></div><p>Returns the GVariant int64 from the given Nix int value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.19.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkInt64 :: Int -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L558"  target="_top">lib/gvariant.nix:558</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkUint64" class="title" ><code class="literal">lib.gvariant.mkUint64</code>   </h4>  </div> </div></div><p>Returns the GVariant uint64 from the given Nix int value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.20.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkUint64 :: Int -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L569"  target="_top">lib/gvariant.nix:569</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.gvariant.mkDouble" class="title" ><code class="literal">lib.gvariant.mkDouble</code>   </h4>  </div> </div></div><p>Returns the GVariant double from the given Nix float value.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.21.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">v</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-22-1.21.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">mkDouble :: Float -&gt; gvariant
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/gvariant.nix#L586"  target="_top">lib/gvariant.nix:586</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-customisation" class="title" >lib.customisation: Functions to customise (derivation-related) functions, derivations, or attribute sets   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.customisation.overrideDerivation" class="title" ><code class="literal">lib.customisation.overrideDerivation</code>   </h4>  </div> </div></div><p><code class="literal">overrideDerivation drv f</code> takes a derivation (i.e., the result
of a call to the builtin function <code class="literal">derivation</code>) and returns a new
derivation in which the attributes of the original are overridden
according to the function <code class="literal">f</code>.  The function <code class="literal">f</code> is called with
the original derivation attributes.</p><p><code class="literal">overrideDerivation</code> allows certain “ad-hoc” customisation
scenarios (e.g. in ~/.config/nixpkgs/config.nix).  For instance,
if you want to “patch” the derivation returned by a package
function in Nixpkgs to build another version than what the
function itself provides.</p><p>For another application, see build-support/vm, where this
function is used to build arbitrary derivations inside a QEMU
virtual machine.</p><p>Note that in order to preserve evaluation errors, the new derivation’s
outPath depends on the old one’s, which means that this function cannot
be used in circular situations when the old derivation also depends on the
new one.</p><p>You should in general prefer <code class="literal">drv.overrideAttrs</code> over this function;
see the nixpkgs manual for more information on overriding.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">drv</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.1.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">overrideDerivation :: Derivation -&gt; ( Derivation -&gt; AttrSet ) -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.1.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 258. <code class="literal">lib.customisation.overrideDerivation</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">mySed = overrideDerivation pkgs.gnused (oldAttrs: {
  name = &quot;sed-4.2.2-pre&quot;;
  src = fetchurl {
    url = ftp://alpha.gnu.org/gnu/sed/sed-4.2.2-pre.tar.bz2;
    hash = &quot;sha256-MxBJRcM2rYzQYwJ5XKxhXTQByvSg5jZc5cSHEZoB2IY=&quot;;
  };
  patches = [];
});
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/customisation.nix#L100"  target="_top">lib/customisation.nix:100</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.customisation.makeOverridable" class="title" ><code class="literal">lib.customisation.makeOverridable</code>   </h4>  </div> </div></div><p><code class="literal">makeOverridable</code> takes a function from attribute set to attribute set and
injects <code class="literal">override</code> attribute which can be used to override arguments of
the function.</p><p>Please refer to  documentation on <a class="link" href="index.html#sec-pkg-overrideDerivation" title="&lt;pkg&gt;.overrideDerivation" ><code class="literal">&lt;pkg&gt;.overrideDerivation</code></a> to learn about <code class="literal">overrideDerivation</code> and caveats
related to its use.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">makeOverridable :: (AttrSet -&gt; a) -&gt; AttrSet -&gt; a
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.2.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 259. <code class="literal">lib.customisation.makeOverridable</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">nix-repl&gt; x = {a, b}: { result = a + b; }

nix-repl&gt; y = lib.makeOverridable x { a = 1; b = 2; }

nix-repl&gt; y
{ override = «lambda»; overrideDerivation = «lambda»; result = 3; }

nix-repl&gt; y.override { a = 10; }
{ override = «lambda»; overrideDerivation = «lambda»; result = 12; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/customisation.nix#L154"  target="_top">lib/customisation.nix:154</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.customisation.callPackageWith" class="title" ><code class="literal">lib.customisation.callPackageWith</code>   </h4>  </div> </div></div><p>Call the package function in the file <code class="literal">fn</code> with the required
arguments automatically.  The function is called with the
arguments <code class="literal">args</code>, but any missing arguments are obtained from
<code class="literal">autoArgs</code>.  This function is intended to be partially
parameterised, e.g.,</p><pre><code class="programlisting nix">callPackage = callPackageWith pkgs;
pkgs = {
  libfoo = callPackage ./foo.nix { };
  libbar = callPackage ./bar.nix { };
};
</code></pre><p>If the <code class="literal">libbar</code> function expects an argument named <code class="literal">libfoo</code>, it is
automatically passed as an argument.  Overrides or missing
arguments can be supplied in <code class="literal">args</code>, e.g.</p><pre><code class="programlisting nix">libbar = callPackage ./bar.nix {
  libfoo = null;
  enableX11 = true;
};
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">autoArgs</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">fn</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">args</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.3.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">callPackageWith :: AttrSet -&gt; ((AttrSet -&gt; a) | Path) -&gt; AttrSet -&gt; a
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/customisation.nix#L239"  target="_top">lib/customisation.nix:239</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.customisation.callPackagesWith" class="title" ><code class="literal">lib.customisation.callPackagesWith</code>   </h4>  </div> </div></div><p>Like callPackage, but for a function that returns an attribute
set of derivations. The override function is added to the
individual attributes.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">autoArgs</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">fn</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">args</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.4.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">callPackagesWith :: AttrSet -&gt; ((AttrSet -&gt; AttrSet) | Path) -&gt; AttrSet -&gt; AttrSet
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/customisation.nix#L339"  target="_top">lib/customisation.nix:339</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.customisation.extendDerivation" class="title" ><code class="literal">lib.customisation.extendDerivation</code>   </h4>  </div> </div></div><p>Add attributes to each output of a derivation without changing
the derivation itself and check a given condition when evaluating.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">condition</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">passthru</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">drv</code></span></dt><dd><p>3. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.5.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">extendDerivation :: Bool -&gt; Any -&gt; Derivation -&gt; Derivation
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/customisation.nix#L382"  target="_top">lib/customisation.nix:382</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.customisation.hydraJob" class="title" ><code class="literal">lib.customisation.hydraJob</code>   </h4>  </div> </div></div><p>Strip a derivation of all non-essential attributes, returning
only those needed by hydra-eval-jobs. Also strictly evaluate the
result to ensure that there are no thunks kept alive to prevent
garbage collection.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">drv</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.6.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">hydraJob :: (Derivation | Null) -&gt; (Derivation | Null)
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/customisation.nix#L444"  target="_top">lib/customisation.nix:444</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.customisation.makeScope" class="title" ><code class="literal">lib.customisation.makeScope</code>   </h4>  </div> </div></div><p>Make an attribute set (a “scope”) from functions that take arguments from that same attribute set.
See <a class="xref" href="index.html#ex-makeScope" title="Example 260. Create an interdependent package set on top of pkgs" >Example 260</a> for how to use it.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.7.1" class="title" >Inputs   </h5>  </div> </div></div><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p><code class="literal">newScope</code> (<code class="literal">AttrSet -&gt; ((AttrSet -&gt; a) | Path) -&gt; AttrSet -&gt; a</code>)</p><p>A function that takes an attribute set <code class="literal">attrs</code> and returns what ends up as <code class="literal">callPackage</code> in the output.</p><p>Typical values are <code class="literal">callPackageWith</code> or the output attribute <code class="literal">newScope</code>.</p></li><li class="listitem"><p><code class="literal">f</code> (<code class="literal">AttrSet -&gt; AttrSet</code>)</p><p>A function that takes an attribute set as returned by <code class="literal">makeScope newScope f</code> (a “scope”) and returns any attribute set.</p><p>This function is used to compute the fixpoint of the resulting scope using <code class="literal">callPackage</code>.
Its argument is the lazily evaluated reference to the value of that fixpoint, and is typically called <code class="literal">self</code> or <code class="literal">final</code>.</p><p>See <a class="xref" href="index.html#ex-makeScope" title="Example 260. Create an interdependent package set on top of pkgs" >Example 260</a> for how to use it.
See <a class="xref" href="index.html#sec-functions-library-fixedPoints" title="lib.fixedPoints: explicit recursion functions" >the section called “lib.fixedPoints: explicit recursion functions”</a> for details on fixpoint computation.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.7.2" class="title" >Output   </h5>  </div> </div></div><p><code class="literal">makeScope</code> returns an attribute set of a form called <code class="literal">scope</code>, which also contains the final attributes produced by <code class="literal">f</code>:</p><pre><code class="programlisting">scope :: {
  callPackage :: ((AttrSet -&gt; a) | Path) -&gt; AttrSet -&gt; a
  newScope = AttrSet -&gt; scope
  overrideScope = (scope -&gt; scope -&gt; AttrSet) -&gt; scope
  packages :: AttrSet -&gt; AttrSet
}
</code></pre><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">callPackage</code> (<code class="literal">((AttrSet -&gt; a) | Path) -&gt; AttrSet -&gt; a</code>)</p><p>A function that</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Takes a function <code class="literal">p</code>, or a path to a Nix file that contains a function <code class="literal">p</code>, which takes an attribute set and returns value of arbitrary type <code class="literal">a</code>,</p></li><li class="listitem"><p>Takes an attribute set <code class="literal">args</code> with explicit attributes to pass to <code class="literal">p</code>,</p></li><li class="listitem"><p>Calls <code class="literal">f</code> with attributes from the original attribute set <code class="literal">attrs</code> passed to <code class="literal">newScope</code> updated with <code class="literal">args</code>, i.e. <code class="literal">attrs // args</code>, if they match the attributes in the argument of <code class="literal">p</code>.</p></li></ol></div><p>All such functions <code class="literal">p</code> will be called with the same value for <code class="literal">attrs</code>.</p><p>See <a class="xref" href="index.html#ex-makeScope-callPackage" title="Example 261. Using callPackage from a scope" >Example 261</a> for how to use it.</p></li><li class="listitem"><p><code class="literal">newScope</code> (<code class="literal">AttrSet -&gt; scope</code>)</p><p>Takes an attribute set <code class="literal">attrs</code> and returns a scope that extends the original scope.</p></li><li class="listitem"><p><code class="literal">overrideScope</code> (<code class="literal">(scope -&gt; scope -&gt; AttrSet) -&gt; scope</code>)</p><p>Takes a function <code class="literal">g</code> of the form <code class="literal">final: prev: { # attributes }</code> to act as an overlay on <code class="literal">f</code>, and returns a new scope with values determined by <code class="literal">extends g f</code>.
See <a class="link" href="https://nixos.org/manual/nixpkgs/unstable/#function-library-lib.fixedPoints.extends"  target="_top"></a> for details.</p><p>This allows subsequent modification of the final attribute set in a consistent way, i.e. all functions <code class="literal">p</code> invoked with <code class="literal">callPackage</code> will be called with the modified values.</p></li><li class="listitem"><p><code class="literal">packages</code> (<code class="literal">AttrSet -&gt; AttrSet</code>)</p><p>The value of the argument <code class="literal">f</code> to <code class="literal">makeScope</code>.</p></li><li class="listitem"><p>final attributes</p><p>The final values returned by <code class="literal">f</code>.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.7.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span id="ex-makeScope" ></span><details><summary><span class="title"><strong>Example 260. Create an interdependent package set on top of <code class="literal">pkgs</code></strong></span></summary><div class="example-contents"><p>The functions in <code class="literal">foo.nix</code> and <code class="literal">bar.nix</code> can depend on each other, in the sense that <code class="literal">foo.nix</code> can contain a function that expects <code class="literal">bar</code> as an attribute in its argument.</p><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };
in
pkgs.lib.makeScope pkgs.newScope (self: {
  foo = self.callPackage ./foo.nix { };
  bar = self.callPackage ./bar.nix { };
})
</code></pre><p>evaluates to</p><pre><code class="programlisting nix">{
  callPackage = «lambda»;
  newScope = «lambda»;
  overrideScope = «lambda»;
  packages = «lambda»;
  foo = «derivation»;
  bar = «derivation»;
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-makeScope-callPackage" ></span><details><summary><span class="title"><strong>Example 261. Using <code class="literal">callPackage</code> from a scope</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };
  inherit (pkgs) lib;
  scope = lib.makeScope lib.callPackageWith (self: { a = 1; b = 2; });
  three = scope.callPackage ({ a, b }: a + b) { };
  four = scope.callPackage ({ a, b }: a + b) { a = 2; };
in
[ three four ]
</code></pre><p>evaluates to</p><pre><code class="programlisting nix">[ 3 4 ]
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.7.4" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">makeScope :: (AttrSet -&gt; ((AttrSet -&gt; a) | Path) -&gt; AttrSet -&gt; a) -&gt; (AttrSet -&gt; AttrSet) -&gt; scope
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/customisation.nix#L604"  target="_top">lib/customisation.nix:604</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.customisation.makeScopeWithSplicing" class="title" ><code class="literal">lib.customisation.makeScopeWithSplicing</code>   </h4>  </div> </div></div><p>backward compatibility with old uncurried form; deprecated</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.8.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">splicePackages</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">newScope</code></span></dt><dd><p>2. Function argument</p></dd><dt><span class="term"><code class="literal">otherSplices</code></span></dt><dd><p>3. Function argument</p></dd><dt><span class="term"><code class="literal">keep</code></span></dt><dd><p>4. Function argument</p></dd><dt><span class="term"><code class="literal">extra</code></span></dt><dd><p>5. Function argument</p></dd><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>6. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/customisation.nix#L645"  target="_top">lib/customisation.nix:645</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.customisation.makeScopeWithSplicing-prime" class="title" ><code class="literal">lib.customisation.makeScopeWithSplicing&#x27;</code>   </h4>  </div> </div></div><p>Like makeScope, but aims to support cross compilation. It’s still ugly, but
hopefully it helps a little bit.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.9.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">makeScopeWithSplicing&#x27; ::
  { splicePackages :: Splice -&gt; AttrSet
  , newScope :: AttrSet -&gt; ((AttrSet -&gt; a) | Path) -&gt; AttrSet -&gt; a
  }
  -&gt; { otherSplices :: Splice, keep :: AttrSet -&gt; AttrSet, extra :: AttrSet -&gt; AttrSet }
  -&gt; AttrSet

Splice ::
  { pkgsBuildBuild :: AttrSet
  , pkgsBuildHost :: AttrSet
  , pkgsBuildTarget :: AttrSet
  , pkgsHostHost :: AttrSet
  , pkgsHostTarget :: AttrSet
  , pkgsTargetTarget :: AttrSet
  }
</code></pre><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/customisation.nix#L680"  target="_top">lib/customisation.nix:680</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.customisation.extendMkDerivation" class="title" ><code class="literal">lib.customisation.extendMkDerivation</code>   </h4>  </div> </div></div><p>Define a <code class="literal">mkDerivation</code>-like function based on another <code class="literal">mkDerivation</code>-like function.</p><p><a class="link" href="index.html#part-stdenv" title="Standard environment" ><code class="literal">stdenv.mkDerivation</code></a> gives access to
its final set of derivation attributes when it is passed a function,
or when it is passed an overlay-style function in <code class="literal">overrideAttrs</code>.</p><p>Instead of composing new <code class="literal">stdenv.mkDerivation</code>-like build helpers
using normal function composition,
<code class="literal">extendMkDerivation</code> makes sure that the returned build helper
supports such first class recursion like <code class="literal">mkDerivation</code> does.</p><p><code class="literal">extendMkDerivation</code> takes an extra attribute set to configure its behaviour.
One can optionally specify
<code class="literal">transformDrv</code> to specify a function to apply to the result derivation,
or <code class="literal">inheritFunctionArgs</code> to decide whether to inherit the <code class="literal">__functionArgs</code>
from the base build helper.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.10.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">extendMkDerivation</code>-specific configurations</span></dt><dd><p><code class="literal">constructDrv</code>: Base build helper, the <code class="literal">mkDerivation</code>-like build helper to extend.</p></dd><dd><p><code class="literal">excludeDrvArgNames</code>: Argument names not to pass from the input fixed-point arguments to <code class="literal">constructDrv</code>. Note: It doesn’t apply to the updating arguments returned by <code class="literal">extendDrvArgs</code>.</p></dd><dd><p><code class="literal">extendDrvArgs</code> : An extension (overlay) of the argument set, like the one taken by <a class="link" href="index.html#sec-pkg-overrideAttrs" title="&lt;pkg&gt;.overrideAttrs" >overrideAttrs</a> but applied before passing to <code class="literal">constructDrv</code>.</p></dd><dd><p><code class="literal">inheritFunctionArgs</code>: Whether to inherit <code class="literal">__functionArgs</code> from the base build helper (default to <code class="literal">true</code>).</p></dd><dd><p><code class="literal">transformDrv</code>: Function to apply to the result derivation (default to <code class="literal">lib.id</code>).</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.10.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">extendMkDerivation ::
  {
    constructDrv :: ((FixedPointArgs | AttrSet) -&gt; a)
    excludeDrvArgNames :: [ String ],
    extendDrvArgs :: (AttrSet -&gt; AttrSet -&gt; AttrSet)
    inheritFunctionArgs :: Bool,
    transformDrv :: a -&gt; a,
  }
  -&gt; (FixedPointArgs | AttrSet) -&gt; a

FixedPointArgs = AttrSet -&gt; AttrSet
a = Derivation when defining a build helper
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-23-1.10.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 262. <code class="literal">lib.customisation.extendMkDerivation</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix-repl">mkLocalDerivation = lib.extendMkDerivation {
  constructDrv = pkgs.stdenv.mkDerivation;
  excludeDrvArgNames = [ &quot;specialArg&quot; ];
  extendDrvArgs =
    finalAttrs: args@{ preferLocalBuild ? true, allowSubstitute ? false, specialArg ? (_: false), ... }:
    { inherit preferLocalBuild allowSubstitute; passthru = { inherit specialArg; } // args.passthru or { }; };
}

mkLocalDerivation.__functionArgs
=&gt; { allowSubstitute = true; preferLocalBuild = true; specialArg = true; }

mkLocalDerivation { inherit (pkgs.hello) pname version src; specialArg = _: false; }
=&gt; «derivation /nix/store/xirl67m60ahg6jmzicx43a81g635g8z8-hello-2.12.1.drv»

mkLocalDerivation (finalAttrs: { inherit (pkgs.hello) pname version src; specialArg = _: false; })
=&gt; «derivation /nix/store/xirl67m60ahg6jmzicx43a81g635g8z8-hello-2.12.1.drv»

(mkLocalDerivation (finalAttrs: { inherit (pkgs.hello) pname version src; passthru = { foo = &quot;a&quot;; bar = &quot;${finalAttrs.passthru.foo}b&quot;; }; })).bar
=&gt; &quot;ab&quot;
</code></pre></div></details></div><br class="example-break" /><div class="note"><h3 class="title">Note</h3><p>If <code class="literal">transformDrv</code> is specified,
it should take care of existing attributes that perform overriding
(e.g., <a class="link" href="index.html#sec-pkg-overrideAttrs" title="&lt;pkg&gt;.overrideAttrs" ><code class="literal">overrideAttrs</code></a>)
to ensure that the overriding functionality of the result derivation
work as expected.
Modifications that breaks the overriding include
direct <a class="link" href="https://nixos.org/manual/nix/stable/language/operators#update"  target="_top">attribute set update</a>
and <a class="link" href="index.html#function-library-lib.customisation.extendDerivation" title="lib.customisation.extendDerivation" ><code class="literal">lib.extendDerivation</code></a>.</p></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/customisation.nix#L816"  target="_top">lib/customisation.nix:816</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-meta" class="title" >lib.meta: functions for derivation metadata   </h3>  </div> </div></div><p>Some functions for manipulating meta attributes, as well as the
name attribute.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.addMetaAttrs" class="title" ><code class="literal">lib.meta.addMetaAttrs</code>   </h4>  </div> </div></div><p>Add to or override the meta attributes of the given
derivation.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">newAttrs</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">drv</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.1.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 263. <code class="literal">lib.meta.addMetaAttrs</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">addMetaAttrs {description = &quot;Bla blah&quot;;} somePkg
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L47"  target="_top">lib/meta.nix:47</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.dontDistribute" class="title" ><code class="literal">lib.meta.dontDistribute</code>   </h4>  </div> </div></div><p>Disable Hydra builds of given derivation.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">drv</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L58"  target="_top">lib/meta.nix:58</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.setName" class="title" ><code class="literal">lib.meta.setName</code>   </h4>  </div> </div></div><p>Change the <a class="link" href="https://nixos.org/manual/nix/stable/language/derivations.html#attr-name"  target="_top">symbolic name of a derivation</a>.</p><div class="warning"><h3 class="title">Warning</h3><p>Dependent derivations will be rebuilt when the symbolic name is changed.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">drv</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L77"  target="_top">lib/meta.nix:77</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.updateName" class="title" ><code class="literal">lib.meta.updateName</code>   </h4>  </div> </div></div><p>Like <code class="literal">setName</code>, but takes the previous name as an argument.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.4.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">updater</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">drv</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.4.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 264. <code class="literal">lib.meta.updateName</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">updateName (oldName: oldName + &quot;-experimental&quot;) somePkg
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L102"  target="_top">lib/meta.nix:102</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.appendToName" class="title" ><code class="literal">lib.meta.appendToName</code>   </h4>  </div> </div></div><p>Append a suffix to the name of a package (before the version
part).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.5.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">suffix</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L114"  target="_top">lib/meta.nix:114</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.mapDerivationAttrset" class="title" ><code class="literal">lib.meta.mapDerivationAttrset</code>   </h4>  </div> </div></div><p>Apply a function to each derivation and only to derivations in an attrset.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.6.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">f</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">set</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L137"  target="_top">lib/meta.nix:137</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.defaultPriority" class="title" ><code class="literal">lib.meta.defaultPriority</code>   </h4>  </div> </div></div><p>The default priority of packages in Nix. See <code class="literal">defaultPriority</code> in <a class="link" href="https://github.com/NixOS/nix/blob/master/src/nix/profile.cc#L47"  target="_top"><code class="literal">src/nix/profile.cc</code></a>.</p><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L143"  target="_top">lib/meta.nix:143</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.setPrio" class="title" ><code class="literal">lib.meta.setPrio</code>   </h4>  </div> </div></div><p>Set the nix-env priority of the package. Note that higher values are lower priority, and vice versa.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.8.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">priority</code></span></dt><dd><p>1. The priority to set.</p></dd><dt><span class="term"><code class="literal">drv</code></span></dt><dd><p>2. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L156"  target="_top">lib/meta.nix:156</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.lowPrio" class="title" ><code class="literal">lib.meta.lowPrio</code>   </h4>  </div> </div></div><p>Decrease the nix-env priority of the package, i.e., other
versions/variants of the package will be preferred.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.9.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">drv</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L168"  target="_top">lib/meta.nix:168</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.lowPrioSet" class="title" ><code class="literal">lib.meta.lowPrioSet</code>   </h4>  </div> </div></div><p>Apply lowPrio to an attrset with derivations.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.10.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">set</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L179"  target="_top">lib/meta.nix:179</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.hiPrio" class="title" ><code class="literal">lib.meta.hiPrio</code>   </h4>  </div> </div></div><p>Increase the nix-env priority of the package, i.e., this
version/variant of the package will be preferred.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.11.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">drv</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L191"  target="_top">lib/meta.nix:191</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.hiPrioSet" class="title" ><code class="literal">lib.meta.hiPrioSet</code>   </h4>  </div> </div></div><p>Apply hiPrio to an attrset with derivations.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.12.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">set</code></span></dt><dd><p>1. Function argument</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L202"  target="_top">lib/meta.nix:202</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.platformMatch" class="title" ><code class="literal">lib.meta.platformMatch</code>   </h4>  </div> </div></div><p>Check to see if a platform is matched by the given <code class="literal">meta.platforms</code>
element.</p><p>A <code class="literal">meta.platform</code> pattern is either</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>(legacy) a system string.</p></li><li class="listitem"><p>(modern) a pattern for the entire platform structure (see <code class="literal">lib.systems.inspect.platformPatterns</code>).</p></li><li class="listitem"><p>(modern) a pattern for the platform <code class="literal">parsed</code> field (see <code class="literal">lib.systems.inspect.patterns</code>).</p></li></ol></div><p>We can inject these into a pattern for the whole of a structured platform,
and then match that.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.13.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">platform</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">elem</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.13.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 265. <code class="literal">lib.meta.platformMatch</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">lib.meta.platformMatch { system = &quot;aarch64-darwin&quot;; } &quot;aarch64-darwin&quot;
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L240"  target="_top">lib/meta.nix:240</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.availableOn" class="title" ><code class="literal">lib.meta.availableOn</code>   </h4>  </div> </div></div><p>Check if a package is available on a given platform.</p><p>A package is available on a platform if both</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>One of <code class="literal">meta.platforms</code> pattern matches the given
platform, or <code class="literal">meta.platforms</code> is not present.</p></li><li class="listitem"><p>None of <code class="literal">meta.badPlatforms</code> pattern matches the given platform.</p></li></ol></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.14.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">platform</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">pkg</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.14.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 266. <code class="literal">lib.meta.availableOn</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">lib.meta.availableOn { system = &quot;aarch64-darwin&quot;; } pkg.zsh
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L290"  target="_top">lib/meta.nix:290</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.licensesSpdx" class="title" ><code class="literal">lib.meta.licensesSpdx</code>   </h4>  </div> </div></div><p>Mapping of SPDX ID to the attributes in lib.licenses.</p><p>For SPDX IDs, see https://spdx.org/licenses.
Note that some SPDX licenses might be missing.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.15.1" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 267. <code class="literal">lib.meta.licensesSpdx</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">lib.licensesSpdx.MIT == lib.licenses.mit
=&gt; true
lib.licensesSpdx.&quot;MY LICENSE&quot;
=&gt; error: attribute &#x27;MY LICENSE&#x27; missing
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L314"  target="_top">lib/meta.nix:314</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.getLicenseFromSpdxId" class="title" ><code class="literal">lib.meta.getLicenseFromSpdxId</code>   </h4>  </div> </div></div><p>Get the corresponding attribute in lib.licenses from the SPDX ID
or warn and fallback to <code class="literal">{ shortName = &lt;license string&gt;; }</code>.</p><p>For SPDX IDs, see https://spdx.org/licenses.
Note that some SPDX licenses might be missing.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.16.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getLicenseFromSpdxId :: str -&gt; AttrSet
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.16.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 268. <code class="literal">lib.meta.getLicenseFromSpdxId</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">lib.getLicenseFromSpdxId &quot;MIT&quot; == lib.licenses.mit
=&gt; true
lib.getLicenseFromSpdxId &quot;mIt&quot; == lib.licenses.mit
=&gt; true
lib.getLicenseFromSpdxId &quot;MY LICENSE&quot;
=&gt; trace: warning: getLicenseFromSpdxId: No license matches the given SPDX ID: MY LICENSE
=&gt; { shortName = &quot;MY LICENSE&quot;; }
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L348"  target="_top">lib/meta.nix:348</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.getLicenseFromSpdxIdOr" class="title" ><code class="literal">lib.meta.getLicenseFromSpdxIdOr</code>   </h4>  </div> </div></div><p>Get the corresponding attribute in lib.licenses from the SPDX ID
or fallback to the given default value.</p><p>For SPDX IDs, see https://spdx.org/licenses.
Note that some SPDX licenses might be missing.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.17.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">licstr</code></span></dt><dd><p>1. SPDX ID string to find a matching license</p></dd><dt><span class="term"><code class="literal">default</code></span></dt><dd><p>2. Fallback value when a match is not found</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.17.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getLicenseFromSpdxIdOr :: str -&gt; Any -&gt; Any
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.17.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 269. <code class="literal">lib.meta.getLicenseFromSpdxIdOr</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">lib.getLicenseFromSpdxIdOr &quot;MIT&quot; null == lib.licenses.mit
=&gt; true
lib.getLicenseFromSpdxId &quot;mIt&quot; null == lib.licenses.mit
=&gt; true
lib.getLicenseFromSpdxIdOr &quot;MY LICENSE&quot; lib.licenses.free == lib.licenses.free
=&gt; true
lib.getLicenseFromSpdxIdOr &quot;MY LICENSE&quot; null
=&gt; null
lib.getLicenseFromSpdxIdOr &quot;MY LICENSE&quot; (builtins.throw &quot;No SPDX ID matches MY LICENSE&quot;)
=&gt; error: No SPDX ID matches MY LICENSE
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L395"  target="_top">lib/meta.nix:395</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.getExe" class="title" ><code class="literal">lib.meta.getExe</code>   </h4>  </div> </div></div><p>Get the path to the main program of a package based on meta.mainProgram</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.18.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.18.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getExe :: package -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.18.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 270. <code class="literal">lib.meta.getExe</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">getExe pkgs.hello
=&gt; &quot;/nix/store/g124820p9hlv4lj8qplzxw1c44dxaw1k-hello-2.12/bin/hello&quot;
getExe pkgs.mustache-go
=&gt; &quot;/nix/store/am9ml4f4ywvivxnkiaqwr0hyxka1xjsf-mustache-go-1.3.0/bin/mustache&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L432"  target="_top">lib/meta.nix:432</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.meta.getExe-prime" class="title" ><code class="literal">lib.meta.getExe&#x27;</code>   </h4>  </div> </div></div><p>Get the path of a program of a derivation.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.19.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">x</code></span></dt><dd><p>1. Function argument</p></dd><dt><span class="term"><code class="literal">y</code></span></dt><dd><p>2. Function argument</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.19.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">getExe&#x27; :: derivation -&gt; string -&gt; string
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-24-1.19.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 271. <code class="literal">lib.meta.getExe&#x27;</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">getExe&#x27; pkgs.hello &quot;hello&quot;
=&gt; &quot;/nix/store/g124820p9hlv4lj8qplzxw1c44dxaw1k-hello-2.12/bin/hello&quot;
getExe&#x27; pkgs.imagemagick &quot;convert&quot;
=&gt; &quot;/nix/store/5rs48jamq7k6sal98ymj9l4k2bnwq515-imagemagick-7.1.1-15/bin/convert&quot;
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/meta.nix#L478"  target="_top">lib/meta.nix:478</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-derivations" class="title" >lib.derivations: miscellaneous derivation-specific functions   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.derivations.lazyDerivation" class="title" ><code class="literal">lib.derivations.lazyDerivation</code>   </h4>  </div> </div></div><p>Restrict a derivation to a predictable set of attribute names, so
that the returned attrset is not strict in the actual derivation,
saving a lot of computation when the derivation is non-trivial.</p><p>This is useful in situations where a derivation might only be used for its
passthru attributes, improving evaluation performance.</p><p>The returned attribute set is lazy in <code class="literal">derivation</code>. Specifically, this
means that the derivation will not be evaluated in at least the
situations below.</p><p>For illustration and/or testing, we define derivation such that its
evaluation is very noticeable.</p><pre><code class="programlisting">let derivation = throw &quot;This won&#x27;t be evaluated.&quot;;
</code></pre><p>In the following expressions, <code class="literal">derivation</code> will <span class="emphasis"><em>not</em></span> be evaluated:</p><pre><code class="programlisting">(lazyDerivation { inherit derivation; }).type

attrNames (lazyDerivation { inherit derivation; })

(lazyDerivation { inherit derivation; } // { foo = true; }).foo

(lazyDerivation { inherit derivation; meta.foo = true; }).meta
</code></pre><p>In these expressions, <code class="literal">derivation</code> <span class="emphasis"><em>will</em></span> be evaluated:</p><pre><code class="programlisting">&quot;${lazyDerivation { inherit derivation }}&quot;

(lazyDerivation { inherit derivation }).outPath

(lazyDerivation { inherit derivation }).meta
</code></pre><p>And the following expressions are not valid, because the refer to
implementation details and/or attributes that may not be present on
some derivations:</p><pre><code class="programlisting">(lazyDerivation { inherit derivation }).buildInputs

(lazyDerivation { inherit derivation }).passthru

(lazyDerivation { inherit derivation }).pythonPath
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-25-1.1.1" class="title" >Inputs   </h5>  </div> </div></div><p>Takes an attribute set with the following attributes</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">derivation</code></span></dt><dd><p>The derivation to be wrapped.</p></dd><dt><span class="term"><code class="literal">meta</code></span></dt><dd><p>Optional meta attribute.</p><p>While this function is primarily about derivations, it can improve
the <code class="literal">meta</code> package attribute, which is usually specified through
<code class="literal">mkDerivation</code>.</p></dd><dt><span class="term"><code class="literal">passthru</code></span></dt><dd><p>Optional extra values to add to the returned attrset.</p><p>This can be used for adding package attributes, such as <code class="literal">tests</code>.</p></dd><dt><span class="term"><code class="literal">outputs</code></span></dt><dd><p>Optional list of assumed outputs. Default: [“out”]</p><p>This must match the set of outputs that the returned derivation has.
You must use this when the derivation has multiple outputs.</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/derivations.nix#L94"  target="_top">lib/derivations.nix:94</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.derivations.optionalDrvAttr" class="title" ><code class="literal">lib.derivations.optionalDrvAttr</code>   </h4>  </div> </div></div><p>Conditionally set a derivation attribute.</p><p>Because <code class="literal">mkDerivation</code> sets <code class="literal">__ignoreNulls = true</code>, a derivation
attribute set to <code class="literal">null</code> will not impact the derivation output hash.
Thus, this function passes through its <code class="literal">value</code> argument if the <code class="literal">cond</code>
is <code class="literal">true</code>, but returns <code class="literal">null</code> if not.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-25-1.2.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">cond</code></span></dt><dd><p>Condition</p></dd><dt><span class="term"><code class="literal">value</code></span></dt><dd><p>Attribute value</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-25-1.2.2" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">optionalDrvAttr :: Bool -&gt; a -&gt; a | Null
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-25-1.2.3" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 272. <code class="literal">lib.derivations.optionalDrvAttr</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">(stdenv.mkDerivation {
  name = &quot;foo&quot;;
  x = optionalDrvAttr true 1;
  y = optionalDrvAttr false 1;
}).drvPath == (stdenv.mkDerivation {
  name = &quot;foo&quot;;
  x = 1;
}).drvPath
=&gt; true
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/derivations.nix#L214"  target="_top">lib/derivations.nix:214</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="function-library-lib.derivations.warnOnInstantiate" class="title" ><code class="literal">lib.derivations.warnOnInstantiate</code>   </h4>  </div> </div></div><p>Wrap a derivation such that instantiating it produces a warning.</p><p>All attributes will be wrapped with <code class="literal">lib.warn</code> except from <code class="literal">.meta</code>, <code class="literal">.name</code>,
and <code class="literal">.type</code> which are used by <code class="literal">nix search</code>, and <code class="literal">.outputName</code> which avoids
double warnings with <code class="literal">nix-instantiate</code> and <code class="literal">nix-build</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-25-1.3.1" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">msg</code></span></dt><dd><p>The warning message to emit (via <code class="literal">lib.warn</code>).</p></dd><dt><span class="term"><code class="literal">drv</code></span></dt><dd><p>The derivation to wrap.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-25-1.3.2" class="title" >Examples   </h5>  </div> </div></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 273. <code class="literal">lib.derivations.warnOnInstantiate</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  myPackage = warnOnInstantiate &quot;myPackage has been renamed to my-package&quot; my-package;
}
</code></pre></div></details></div><br class="example-break" /><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/94def634a20494ee057c76998843c015909d6311/lib/derivations.nix#L243"  target="_top">lib/derivations.nix:243</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-generators" class="title" style="clear: both">Generators   </h2>  </div> </div></div><p>Generators are functions that create file formats from nix data structures, e. g. for configuration files. There are generators available for: <code class="literal">INI</code>, <code class="literal">JSON</code> and <code class="literal">YAML</code></p><p>All generators follow a similar call interface: <code class="literal">generatorName configFunctions data</code>, where <code class="literal">configFunctions</code> is an attrset of user-defined functions that format nested parts of the content. They each have common defaults, so often they do not need to be set manually. An example is <code class="literal">mkSectionName ? (name: libStr.escape [ &quot;[&quot; &quot;]&quot; ] name)</code> from the <code class="literal">INI</code> generator. It receives the name of a section and sanitizes it. The default <code class="literal">mkSectionName</code> escapes <code class="literal">[</code> and <code class="literal">]</code> with a backslash.</p><p>Generators can be fine-tuned to produce exactly the file format required by your application/service. One example is an INI-file format which uses <code class="literal">: </code> as separator, the strings <code class="literal">&quot;yes&quot;</code>/<code class="literal">&quot;no&quot;</code> as boolean values and requires all string values to be quoted:</p><pre><code class="programlisting nix">let
  inherit (lib) generators isString;

  customToINI = generators.toINI {
    # specifies how to format a key/value pair
    mkKeyValue = generators.mkKeyValueDefault {
      # specifies the generated string for a subset of nix values
      mkValueString =
        v:
        if v == true then
          &#x27;&#x27;&quot;yes&quot;&#x27;&#x27;
        else if v == false then
          &#x27;&#x27;&quot;no&quot;&#x27;&#x27;
        else if isString v then
          &#x27;&#x27;&quot;${v}&quot;&#x27;&#x27;
        # and delegates all other values to the default generator
        else
          generators.mkValueStringDefault { } v;
    } &quot;:&quot;;
  };

  # the INI file can now be given as plain old nix values
in
customToINI {
  main = {
    pushinfo = true;
    autopush = false;
    host = &quot;localhost&quot;;
    port = 42;
  };
  mergetool = {
    merge = &quot;diff3&quot;;
  };
}
</code></pre><p>This will produce the following INI file as nix string:</p><pre><code class="programlisting INI">[main]
autopush:&quot;no&quot;
host:&quot;localhost&quot;
port:42
pushinfo:&quot;yes&quot;
str\:ange:&quot;very::strange&quot;

[mergetool]
merge:&quot;diff3&quot;
</code></pre><div class="note"><h3 class="title">Note</h3><p>Nix store paths can be converted to strings by enclosing a derivation attribute like so: <code class="literal">&quot;${drv}&quot;</code>.</p></div><p>Detailed documentation for each generator can be found <a class="link" href="index.html#sec-functions-library-generators" title="lib.generators: functions that create file formats from nix data structures" >here</a></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-debug" class="title" style="clear: both">Debugging Nix Expressions   </h2>  </div> </div></div><p>Nix is a unityped, dynamic language, this means every value can potentially appear anywhere. Since it is also non-strict, evaluation order and what ultimately is evaluated might surprise you. Therefore it is important to be able to debug nix expressions.</p><p>In the <code class="literal">lib/debug.nix</code> file you will find a number of functions that help (pretty-)printing values while evaluation is running. You can even specify how deep these values should be printed recursively, and transform them on the fly. Please consult the docstrings in <code class="literal">lib/debug.nix</code> for usage information.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-prefer-remote-fetch" class="title" style="clear: both">prefer-remote-fetch overlay   </h2>  </div> </div></div><p><code class="literal">prefer-remote-fetch</code> is an overlay that download sources on remote builder. This is useful when the evaluating machine has a slow upload while the builder can fetch faster directly from the source. To use it, put the following snippet as a new overlay:</p><pre><code class="programlisting nix">self: super: (super.prefer-remote-fetch self super)
</code></pre><p>A full configuration example for that sets the overlay up for your own account, could look like this</p><pre><code class="programlisting ShellSession">$ mkdir ~/.config/nixpkgs/overlays/
$ cat &gt; ~/.config/nixpkgs/overlays/prefer-remote-fetch.nix &lt;&lt;EOF
  self: super: super.prefer-remote-fetch self super
EOF
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-nix-gitignore" class="title" style="clear: both">pkgs.nix-gitignore   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-pkgs-nix-gitignore-usage">Usage</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-nix-gitignore-usage-recursive">gitignore files in subdirectories</a> </span></dt> </dl></div><p><code class="literal">pkgs.nix-gitignore</code> is a function that acts similarly to <code class="literal">builtins.filterSource</code> but also allows filtering with the help of the gitignore format.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs-nix-gitignore-usage" class="title" >Usage   </h3>  </div> </div></div><p><code class="literal">pkgs.nix-gitignore</code> exports a number of functions, but you’ll most likely need either <code class="literal">gitignoreSource</code> or <code class="literal">gitignoreSourcePure</code>. As their first argument, they both accept either 1. a file with gitignore lines or 2. a string with gitignore lines, or 3. a list of either of the two. They will be concatenated into a single big string.</p><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:
{

  src = nix-gitignore.gitignoreSource [ ] ./source;
  # Simplest version

  src = nix-gitignore.gitignoreSource &#x27;&#x27;
    supplemental-ignores
  &#x27;&#x27; ./source;
  # This one reads the ./source/.gitignore and concats the auxiliary ignores

  src = nix-gitignore.gitignoreSourcePure &#x27;&#x27;
    ignore-this
    ignore-that
  &#x27;&#x27; ./source;
  # Use this string as gitignore, don&#x27;t read ./source/.gitignore.

  src = nix-gitignore.gitignoreSourcePure [
    &#x27;&#x27;
      ignore-this
      ignore-that
    &#x27;&#x27;
    ~/.gitignore
  ] ./source;
  # It also accepts a list (of strings and paths) that will be concatenated
  # once the paths are turned to strings via readFile.
}
</code></pre><p>These functions are derived from the <code class="literal">Filter</code> functions by setting the first filter argument to <code class="literal">(_: _: true)</code>:</p><pre><code class="programlisting nix">{
  gitignoreSourcePure = gitignoreFilterSourcePure (_: _: true);
  gitignoreSource = gitignoreFilterSource (_: _: true);
}
</code></pre><p>Those filter functions accept the same arguments the <code class="literal">builtins.filterSource</code> function would pass to its filters, thus <code class="literal">fn: gitignoreFilterSourcePure fn &quot;&quot;</code> should be extensionally equivalent to <code class="literal">filterSource</code>. The file is blacklisted if it’s blacklisted by either your filter or the gitignoreFilter.</p><p>If you want to make your own filter from scratch, you may use</p><pre><code class="programlisting nix">{ gitignoreFilter = ign: root: filterPattern (gitignoreToPatterns ign) root; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs-nix-gitignore-usage-recursive" class="title" >gitignore files in subdirectories   </h3>  </div> </div></div><p>If you wish to use a filter that would search for .gitignore files in subdirectories, just like git does by default, use this function:</p><pre><code class="programlisting nix">{
  # gitignoreFilterRecursiveSource = filter: patterns: root:
  # OR
  gitignoreRecursiveSource = gitignoreFilterSourcePure (_: _: true);
}
</code></pre>
</div>

</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-system" class="title" >Module System   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-system-introduction">Introduction</a> </span></dt><dt> <span class="section">  <a href="index.html#module-system-lib-evalModules"><code class="literal">lib.evalModules</code></a> </span></dt><dt> <span class="section">  <a href="index.html#module-system-module-arguments">Module arguments</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-system-introduction" class="title" style="clear: both">Introduction   </h2>  </div> </div></div><p>The module system is a language for handling configuration, implemented as a Nix library.</p><p>Compared to plain Nix, it adds documentation, type checking and composition or extensibility.</p><div class="note"><h3 class="title">Note</h3><p>This chapter is new and not complete yet.</p><p>See also:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Introduction to the module system, in the context of NixOS, see <a class="link" href="https://nixos.org/manual/nixos/unstable/index.html#sec-writing-modules"  target="_top">Writing NixOS Modules</a> in the NixOS manual.</p></li><li class="listitem"><p>Generic guide to the module system on <a class="link" href="https://nix.dev/tutorials/module-system/index.html"  target="_top">nix.dev</a>.</p></li></ul></div></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-system-lib-evalModules" class="title" style="clear: both"><code class="literal">lib.evalModules</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#module-system-lib-evalModules-parameters">Parameters</a> </span></dt><dt> <span class="section">  <a href="index.html#module-system-lib-evalModules-return-value">Return value</a> </span></dt> </dl></div><p>Evaluate a set of modules. This function is typically only used once per application (e.g. once in NixOS, once in Home Manager, …).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-system-lib-evalModules-parameters" class="title" >Parameters   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-system-lib-evalModules-param-modules" class="title" ><code class="literal">modules</code>   </h4>  </div> </div></div><p>A list of modules. These are merged together to form the final configuration.
</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-system-lib-evalModules-param-specialArgs" class="title" ><code class="literal">specialArgs</code>   </h4>  </div> </div></div><p>An attribute set of module arguments that can be used in <code class="literal">imports</code>.</p><p>This is in contrast to <code class="literal">config._module.args</code>, which is only available after all <code class="literal">imports</code> have been resolved.</p><div class="warning"><h3 class="title">Warning</h3><p>You may be tempted to use <code class="literal">specialArgs.lib</code> to provide extra library functions. Doing so limits the interoperability of modules, as well as the interoperability of Module System applications.</p><p><code class="literal">lib</code> is reserved for the Nixpkgs library, and should not be used for custom functions.</p><p>Instead, you may create a new attribute in <code class="literal">specialArgs</code> to provide custom functions.
This clarifies their origin and avoids incompatibilities.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-system-lib-evalModules-param-class" class="title" ><code class="literal">class</code>   </h4>  </div> </div></div><p>If the <code class="literal">class</code> attribute is set and non-<code class="literal">null</code>, the module system will reject <code class="literal">imports</code> with a different <code class="literal">_class</code> declaration.</p><p>The <code class="literal">class</code> value should be a string in lower <a class="link" href="https://en.wikipedia.org/wiki/Camel_case"  target="_top">camel case</a>.</p><p>If applicable, the <code class="literal">class</code> should match the “prefix” of the attributes used in (experimental) <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-flake.html#description"  target="_top">flakes</a>. Some examples are:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">nixos</code> as in <code class="literal">flake.nixosModules</code></p></li><li class="listitem"><p><code class="literal">nixosTest</code>: modules that constitute a <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#sec-nixos-tests"  target="_top">NixOS VM test</a>
</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-system-lib-evalModules-param-prefix" class="title" ><code class="literal">prefix</code>   </h4>  </div> </div></div><p>A list of strings representing the location at or below which all options are evaluated. This is used by <code class="literal">types.submodule</code> to improve error reporting and find the implicit <code class="literal">name</code> module argument.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-system-lib-evalModules-return-value" class="title" >Return value   </h3>  </div> </div></div><p>The result is an attribute set with the following attributes:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-system-lib-evalModules-return-value-options" class="title" ><code class="literal">options</code>   </h4>  </div> </div></div><p>The nested attribute set of all option declarations.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-system-lib-evalModules-return-value-config" class="title" ><code class="literal">config</code>   </h4>  </div> </div></div><p>The nested attribute set of all option values.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-system-lib-evalModules-return-value-type" class="title" ><code class="literal">type</code>   </h4>  </div> </div></div><p>A module system type. This type is an instance of <code class="literal">types.submoduleWith</code> containing the current <a class="link" href="index.html#module-system-lib-evalModules-param-modules" title="modules" ><code class="literal">modules</code></a>.</p><p>The option definitions that are typed with this type will extend the current set of modules, like <a class="link" href="index.html#module-system-lib-evalModules-return-value-extendModules" title="extendModules" ><code class="literal">extendModules</code></a>.</p><p>However, the value returned from the type is just the <a class="link" href="index.html#module-system-lib-evalModules-return-value-config" title="config" ><code class="literal">config</code></a>, like any submodule.</p><p>If you’re familiar with prototype inheritance, you can think of this <code class="literal">evalModules</code> invocation as the prototype, and usages of this type as the instances.</p><p>This type is also available to the <a class="link" href="index.html#module-system-lib-evalModules-param-modules" title="modules" ><code class="literal">modules</code></a> as the module argument <code class="literal">moduleType</code>.
</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-system-lib-evalModules-return-value-extendModules" class="title" ><code class="literal">extendModules</code>   </h4>  </div> </div></div><p>A function similar to <code class="literal">evalModules</code> but building on top of the already passed <a class="link" href="index.html#module-system-lib-evalModules-param-modules" title="modules" ><code class="literal">modules</code></a>. Its arguments, <code class="literal">modules</code> and <code class="literal">specialArgs</code> are added to the existing values.</p><p>If you’re familiar with prototype inheritance, you can think of the current, actual <code class="literal">evalModules</code> invocation as the prototype, and the return value of <code class="literal">extendModules</code> as the instance.</p><p>This functionality is also available to modules as the <code class="literal">extendModules</code> module argument.</p><div class="note"><h3 class="title">Note</h3><p><span class="strong"><strong>Evaluation Performance</strong></span></p><p><code class="literal">extendModules</code> returns a configuration that shares very little with the original <code class="literal">evalModules</code> invocation, because the module arguments may be different.</p><p>So if you have a configuration that has been (or will be) largely evaluated, almost none of the computation is shared with the configuration returned by <code class="literal">extendModules</code>.</p><p>The real work of module evaluation happens while computing the values in <code class="literal">config</code> and <code class="literal">options</code>, so multiple invocations of <code class="literal">extendModules</code> have a particularly small cost, as long as only the final <code class="literal">config</code> and <code class="literal">options</code> are evaluated.</p><p>If you do reference multiple <code class="literal">config</code> (or <code class="literal">options</code>) from before and after <code class="literal">extendModules</code>, evaluation performance is the same as with multiple <code class="literal">evalModules</code> invocations, because the new modules’ ability to override existing configuration fundamentally requires constructing a new <code class="literal">config</code> and <code class="literal">options</code> fixpoint.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-system-lib-evalModules-return-value-_module" class="title" ><code class="literal">_module</code>   </h4>  </div> </div></div><p>A portion of the configuration tree which is elided from <code class="literal">config</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-system-lib-evalModules-return-value-_type" class="title" ><code class="literal">_type</code>   </h4>  </div> </div></div><p>A nominal type marker, always <code class="literal">&quot;configuration&quot;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-system-lib-evalModules-return-value-_configurationClass" class="title" ><code class="literal">class</code>   </h4>  </div> </div></div><p>The <a class="link" href="index.html#module-system-lib-evalModules-param-class" title="class" ><code class="literal">class</code> argument</a>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-system-module-arguments" class="title" style="clear: both">Module arguments   </h2>  </div> </div></div><p>Module arguments are the attribute values passed to modules when they are evaluated.</p><p>They originate from these sources:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Built-in arguments</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">lib</code>,</p></li><li class="listitem"><p><code class="literal">config</code>,</p></li><li class="listitem"><p><code class="literal">options</code>,</p></li><li class="listitem"><p><code class="literal">_class</code>,</p></li><li class="listitem"><p><code class="literal">_prefix</code>,</p></li></ul></div></li><li class="listitem"><p>Attributes from the <a class="link" href="index.html#module-system-lib-evalModules-param-specialArgs" title="specialArgs" ><code class="literal">specialArgs</code></a> argument passed to <a class="link" href="index.html#module-system-lib-evalModules" title="lib.evalModules" ><code class="literal">evalModules</code></a> or <code class="literal">submoduleWith</code>. These are application-specific.</p></li><li class="listitem"><p>Attributes from the <code class="literal">_module.args</code> option value. These are application-specific and can be provided by any module.</p></li></ol></div><p>The prior two categories are available while evaluating the <code class="literal">imports</code>, whereas
the last category is only available after the <code class="literal">imports</code> have been resolved.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span id="module-system-module-argument-lib"></span><code class="literal">lib</code> <a class="link" href="index.html#module-system-module-argument-lib"  >🔗</a></span></dt><dd><p>A reference to the Nixpkgs library.</p></dd><dt><span class="term"><span id="module-system-module-argument-config"></span><code class="literal">config</code> <a class="link" href="index.html#module-system-module-argument-config"  >🔗</a></span></dt><dd><p>All option values.
Unlike the <code class="literal">evalModules</code> <a class="link" href="index.html#module-system-lib-evalModules-return-value-config" title="config" ><code class="literal">config</code> return attribute</a>, this includes <code class="literal">_module</code>.</p></dd><dt><span class="term"><span id="module-system-module-argument-options"></span><code class="literal">options</code> <a class="link" href="index.html#module-system-module-argument-options"  >🔗</a></span></dt><dd><p>All evaluated option declarations.</p></dd><dt><span class="term"><span id="module-system-module-argument-_class"></span><code class="literal">_class</code> <a class="link" href="index.html#module-system-module-argument-_class"  >🔗</a></span></dt><dd><p>The <a class="link" href="index.html#module-system-lib-evalModules-param-class" title="class" >expected class</a> of the loaded modules.</p></dd><dt><span class="term"><span id="module-system-module-argument-_prefix"></span><code class="literal">_prefix</code> <a class="link" href="index.html#module-system-module-argument-_prefix"  >🔗</a></span></dt><dd><p>The location under which the module is evaluated.
This is used to improve error reporting and to find the implicit <code class="literal">name</code> module argument in submodules.
It is exposed as a module argument due to how the module system is implemented, which cannot be avoided without breaking compatibility.</p><p>It is a good practice not to rely on <code class="literal">_prefix</code>. A module should not make assumptions about its location in the configuration tree.
For example, the root of a NixOS configuration may have a non-empty prefix, for example when it is a specialisation, or when it is part of a larger, multi-host configuration such as a <a class="link" href="https://nixos.org/manual/nixos/unstable/#sec-nixos-tests"  target="_top">NixOS test</a>.
Instead of depending on <code class="literal">_prefix</code> use explicit options, whose default definitions can be provided by the module that imports them.</p></dd></dl></div>
</div>

</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="part-stdenv" class="title" >Standard environment   </h1>  </div> </div></div><div class="partintro"><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#chap-stdenv">The Standard Environment</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-meta">Meta-attributes</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-passthru">Passthru-attributes</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-multiple-output">Multiple-output packages</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-cross">Cross-compilation</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-platform-notes">Platform Notes</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-stdenv" class="title" >The Standard Environment   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-using-stdenv">Using <code class="literal">stdenv</code></a> </span></dt><dt> <span class="section">  <a href="index.html#sec-tools-of-stdenv">Tools provided by <code class="literal">stdenv</code></a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-stdenv-dependencies">Specifying dependencies</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-stdenv-attributes">Attributes</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-stdenv-phases">Phases</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-stdenv-functions">Shell functions and utilities</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-setup-hooks">Package setup hooks</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-purity-in-nixpkgs">Purity in Nixpkgs</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-hardening-in-nixpkgs">Hardening in Nixpkgs</a> </span></dt> </dl></div><p>The standard build environment in the Nix Packages collection provides an environment for building Unix packages that does a lot of common build tasks automatically. In fact, for Unix packages that use the standard <code class="literal">./configure; make; make install</code> build interface, you don’t need to write a build script at all; the standard environment does everything automatically. If <code class="literal">stdenv</code> doesn’t do what you need automatically, you can easily customise or override the various build phases.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-using-stdenv" class="title" style="clear: both">Using <code class="literal">stdenv</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-building-stdenv-package-in-nix-shell">Building a <code class="literal">stdenv</code> package in <code class="literal">nix-shell</code></a> </span></dt> </dl></div><p>To build a package with the standard environment, you use the function <code class="literal">stdenv.mkDerivation</code>, instead of the primitive built-in function <code class="literal">derivation</code>, e.g.</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  name = &quot;libfoo-1.2.3&quot;;
  src = fetchurl {
    url = &quot;http://example.org/libfoo-1.2.3.tar.bz2&quot;;
    hash = &quot;sha256-tWxU/LANbQE32my+9AXyt3nCT7NBVfJ45CX757EMT3Q=&quot;;
  };
}
</code></pre><p>(<code class="literal">stdenv</code> needs to be in scope, so if you write this in a separate Nix expression from <code class="literal">pkgs/all-packages.nix</code>, you need to pass it as a function argument.) Specifying a <code class="literal">name</code> and a <code class="literal">src</code> is the absolute minimum Nix requires. For convenience, you can also use <code class="literal">pname</code> and <code class="literal">version</code> attributes and <code class="literal">mkDerivation</code> will automatically set <code class="literal">name</code> to <code class="literal">&quot;${pname}-${version}&quot;</code> by default.
<span class="strong"><strong>Since <a class="link" href="https://github.com/NixOS/rfcs/pull/35"  target="_top">RFC 0035</a>, this is preferred for packages in Nixpkgs</strong></span>, as it allows us to reuse the version easily:</p><pre><code class="programlisting nix">stdenv.mkDerivation (finalAttrs: {
  pname = &quot;libfoo&quot;;
  version = &quot;1.2.3&quot;;
  src = fetchurl {
    url = &quot;http://example.org/libfoo-source-${finalAttrs.version}.tar.bz2&quot;;
    hash = &quot;sha256-tWxU/LANbQE32my+9AXyt3nCT7NBVfJ45CX757EMT3Q=&quot;;
  };
})
</code></pre><p>Many packages have dependencies that are not provided in the standard environment. It’s usually sufficient to specify those dependencies in the <code class="literal">buildInputs</code> attribute:</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  pname = &quot;libfoo&quot;;
  version = &quot;1.2.3&quot;;
  # ...
  buildInputs = [
    libbar
    perl
    ncurses
  ];
}
</code></pre><p>This attribute ensures that the <code class="literal">bin</code> subdirectories of these packages appear in the <code class="literal">PATH</code> environment variable during the build, that their <code class="literal">include</code> subdirectories are searched by the C compiler, and so on. (See <a class="xref" href="index.html#ssec-setup-hooks" title="Package setup hooks" >the section called “Package setup hooks”</a> for details.)</p><p>Often it is necessary to override or modify some aspect of the build. To make this easier, the standard environment breaks the package build into a number of <span class="emphasis"><em>phases</em></span>, all of which can be overridden or modified individually: unpacking the sources, applying patches, configuring, building, and installing. (There are some others; see <a class="xref" href="index.html#sec-stdenv-phases" title="Phases" >the section called “Phases”</a>.) For instance, a package that doesn’t supply a makefile but instead has to be compiled “manually” could be handled like this:</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  pname = &quot;fnord&quot;;
  version = &quot;4.5&quot;;

  # ...

  buildPhase = &#x27;&#x27;
    runHook preBuild

    gcc foo.c -o foo

    runHook postBuild
  &#x27;&#x27;;

  installPhase = &#x27;&#x27;
    runHook preInstall

    mkdir -p $out/bin
    cp foo $out/bin

    runHook postInstall
  &#x27;&#x27;;
}
</code></pre><p>(Note the use of <code class="literal">&#x27;&#x27;</code>-style string literals, which are very convenient for large multi-line script fragments because they don’t need escaping of <code class="literal">&quot;</code> and <code class="literal">\</code>, and because indentation is intelligently removed.)</p><p>There are many other attributes to customise the build. These are listed in <a class="xref" href="index.html#ssec-stdenv-attributes" title="Attributes" >the section called “Attributes”</a>.</p><p>While the standard environment provides a generic builder, you can still supply your own build script:</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  pname = &quot;libfoo&quot;;
  version = &quot;1.2.3&quot;;
  # ...
  builder = ./builder.sh;
}
</code></pre><p>where <code class="literal">stdenv</code> sets up the environment automatically (e.g. by resetting <code class="literal">PATH</code> and populating it from build inputs). If you want, you can use <code class="literal">stdenv</code>’s generic builder:</p><pre><code class="programlisting bash">buildPhase() {
  echo &quot;... this is my custom build phase ...&quot;
  gcc foo.c -o foo
}

installPhase() {
  mkdir -p $out/bin
  cp foo $out/bin
}

genericBuild
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-building-stdenv-package-in-nix-shell" class="title" >Building a <code class="literal">stdenv</code> package in <code class="literal">nix-shell</code>   </h3>  </div> </div></div><p>To build a <code class="literal">stdenv</code> package in a <a class="link" href="https://nixos.org/manual/nix/unstable/command-ref/nix-shell.html"  target="_top"><code class="literal">nix-shell</code></a>, enter a shell, find the <a class="link" href="index.html#sec-stdenv-phases" title="Phases" >phases</a> you wish to build, then invoke <code class="literal">genericBuild</code> manually:</p><p>Go to an empty directory, invoke <code class="literal">nix-shell</code> with the desired package, and from inside the shell, set the output variables to a writable directory:</p><pre><code class="programlisting bash">cd &quot;$(mktemp -d)&quot;
nix-shell &#x27;&lt;nixpkgs&gt;&#x27; -A some_package
export out=$(pwd)/out
</code></pre><p>Next, invoke the desired parts of the build.
First, run the phases that generate a working copy of the sources, which will change directory to the sources for you:</p><pre><code class="programlisting bash">phases=&quot;${prePhases[*]:-} unpackPhase patchPhase&quot; genericBuild
</code></pre><p>Then, run more phases up until the failure is reached.
If the failure is in the build or check phase, the following phases would be required:</p><pre><code class="programlisting bash">phases=&quot;${preConfigurePhases[*]:-} configurePhase ${preBuildPhases[*]:-} buildPhase checkPhase&quot; genericBuild
</code></pre><p>Use this command to run all install phases:</p><pre><code class="programlisting bash">phases=&quot;${preInstallPhases[*]:-} installPhase ${preFixupPhases[*]:-} fixupPhase installCheckPhase&quot; genericBuild
</code></pre><p>Single phase can be re-run as many times as necessary to examine the failure like so:</p><pre><code class="programlisting bash">phases=&quot;buildPhase&quot; genericBuild
</code></pre><p>To modify a <a class="link" href="index.html#sec-stdenv-phases" title="Phases" >phase</a>, first print it with</p><pre><code class="programlisting bash">echo &quot;$buildPhase&quot;
</code></pre><p>Or, if that is empty, for instance, if it is using a function:</p><pre><code class="programlisting bash">type buildPhase
</code></pre><p>then change it in a text editor, and paste it back to the terminal.</p><div class="note"><h3 class="title">Note</h3><p>This method may have some inconsistencies in environment variables and behaviour compared to a normal build within the <a class="link" href="https://nixos.org/manual/nix/unstable/language/derivations#builder-execution"  target="_top">Nix build sandbox</a>.
The following is a non-exhaustive list of such differences:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">TMP</code>, <code class="literal">TMPDIR</code>, and similar variables likely point to non-empty directories that the build might conflict with files in.</p></li><li class="listitem"><p>Output store paths are not writable, so the variables for outputs need to be overridden to writable paths.</p></li><li class="listitem"><p>Other environment variables may be inconsistent with a <code class="literal">nix-build</code> either due to <code class="literal">nix-shell</code>’s initialization script or due to the use of <code class="literal">nix-shell</code> without the <code class="literal">--pure</code> option.</p></li></ul></div><p>If the build fails differently inside the shell than in the sandbox, consider using <a class="link" href="index.html#breakpointhook" title="breakpointHook" ><code class="literal">breakpointHook</code></a> and invoking <code class="literal">nix-build</code> instead.
The <a class="link" href="https://nixos.org/manual/nix/unstable/command-ref/conf-file#opt--keep-failed"  target="_top"><code class="literal">--keep-failed</code></a> option for <code class="literal">nix-build</code> may also be useful to examine the build directory of a failed build.</p></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-tools-of-stdenv" class="title" style="clear: both">Tools provided by <code class="literal">stdenv</code>   </h2>  </div> </div></div><p>The standard environment provides the following packages:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>The GNU C Compiler, configured with C and C++ support.</p></li><li class="listitem"><p>GNU coreutils (contains a few dozen standard Unix commands).</p></li><li class="listitem"><p>GNU findutils (contains <code class="literal">find</code>).</p></li><li class="listitem"><p>GNU diffutils (contains <code class="literal">diff</code>, <code class="literal">cmp</code>).</p></li><li class="listitem"><p>GNU <code class="literal">sed</code>.</p></li><li class="listitem"><p>GNU <code class="literal">grep</code>.</p></li><li class="listitem"><p>GNU <code class="literal">awk</code>.</p></li><li class="listitem"><p>GNU <code class="literal">tar</code>.</p></li><li class="listitem"><p><code class="literal">gzip</code>, <code class="literal">bzip2</code> and <code class="literal">xz</code>.</p></li><li class="listitem"><p>GNU Make.</p></li><li class="listitem"><p>Bash. This is the shell used for all builders in the Nix Packages collection. Not using <code class="literal">/bin/sh</code> removes a large source of portability problems.</p></li><li class="listitem"><p>The <code class="literal">patch</code> command.</p></li></ul></div><p>On Linux, <code class="literal">stdenv</code> also includes the <code class="literal">patchelf</code> utility.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ssec-stdenv-dependencies" class="title" style="clear: both">Specifying dependencies   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-stdenv-dependencies-overview">Overview</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-stdenv-dependencies-reference">Reference</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-stdenv-dependencies-propagated">Dependency propagation</a> </span></dt> </dl></div><p>Build systems often require more dependencies than just what <code class="literal">stdenv</code> provides. This section describes attributes accepted by <code class="literal">stdenv.mkDerivation</code> that can be used to make these dependencies available to the build system.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-stdenv-dependencies-overview" class="title" >Overview   </h3>  </div> </div></div><p>A full reference of the different kinds of dependencies is provided in <a class="xref" href="index.html#ssec-stdenv-dependencies-reference" title="Reference" >the section called “Reference”</a>, but here is an overview of the most common ones.
It should cover most use cases.</p><p>Add dependencies to <code class="literal">nativeBuildInputs</code> if they are executed during the build:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>those which are needed on <code class="literal">$PATH</code> during the build, for example <code class="literal">cmake</code> and <code class="literal">pkg-config</code></p></li><li class="listitem"><p><a class="link" href="index.html#ssec-setup-hooks" title="Package setup hooks" >setup hooks</a>, for example <a class="link" href="index.html#fun-makeWrapper" title="makeWrapper &lt;executable&gt; &lt;wrapperfile&gt; &lt;args&gt;" ><code class="literal">makeWrapper</code></a></p></li><li class="listitem"><p>interpreters needed by <a class="link" href="index.html#patch-shebangs.sh" title="patch-shebangs.sh" ><code class="literal">patchShebangs</code></a> for build scripts (with the <code class="literal">--build</code> flag), which can be the case for e.g. <code class="literal">perl</code></p></li></ul></div><p>Add dependencies to <code class="literal">buildInputs</code> if they will end up copied or linked into the final output or otherwise used at runtime:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>libraries used by compilers, for example <code class="literal">zlib</code>,</p></li><li class="listitem"><p>interpreters needed by <a class="link" href="index.html#patch-shebangs.sh" title="patch-shebangs.sh" ><code class="literal">patchShebangs</code></a> for scripts which are installed, which can be the case for e.g. <code class="literal">perl</code></p></li></ul></div><div class="note"><h3 class="title">Note</h3><p>These criteria are independent.</p><p>For example, software using Wayland usually needs the <code class="literal">wayland</code> library at runtime, so <code class="literal">wayland</code> should be added to <code class="literal">buildInputs</code>.
But it also executes the <code class="literal">wayland-scanner</code> program as part of the build to generate code, so <code class="literal">wayland</code> should also be added to <code class="literal">nativeBuildInputs</code>.</p></div><p>Dependencies needed only to run tests are similarly classified between native (executed during build) and non-native (executed at runtime):</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">nativeCheckInputs</code> for test tools needed on <code class="literal">$PATH</code> (such as <code class="literal">ctest</code>) and <a class="link" href="index.html#ssec-setup-hooks" title="Package setup hooks" >setup hooks</a> (for example <a class="link" href="index.html#python" title="Python" ><code class="literal">pytestCheckHook</code></a>)</p></li><li class="listitem"><p><code class="literal">checkInputs</code> for libraries linked into test executables (for example the <code class="literal">qcheck</code> OCaml package)</p></li></ul></div><p>These dependencies are only injected when <a class="link" href="index.html#var-stdenv-doCheck" title="doCheck" ><code class="literal">doCheck</code></a> is set to <code class="literal">true</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-stdenv-dependencies-overview-example" class="title" >Example   </h4>  </div> </div></div><p>Consider for example this simplified derivation for <code class="literal">solo5</code>, a sandboxing tool:</p><pre><code class="programlisting nix">stdenv.mkDerivation (finalAttrs: {
  pname = &quot;solo5&quot;;
  version = &quot;0.7.5&quot;;

  src = fetchurl {
    url = &quot;https://github.com/Solo5/solo5/releases/download/v${finalAttrs.version}/solo5-v${finalAttrs.version}.tar.gz&quot;;
    hash = &quot;sha256-viwrS9lnaU8sTGuzK/+L/PlMM/xRRtgVuK5pixVeDEw=&quot;;
  };

  nativeBuildInputs = [
    makeWrapper
    pkg-config
  ];

  buildInputs = [ libseccomp ];

  postInstall = &#x27;&#x27;
    substituteInPlace $out/bin/solo5-virtio-mkimage \
      --replace-fail &quot;/usr/lib/syslinux&quot; &quot;${syslinux}/share/syslinux&quot; \
      --replace-fail &quot;/usr/share/syslinux&quot; &quot;${syslinux}/share/syslinux&quot; \
      --replace-fail &quot;cp &quot; &quot;cp --no-preserve=mode &quot;

    wrapProgram $out/bin/solo5-virtio-mkimage \
      --prefix PATH : ${
        lib.makeBinPath [
          dosfstools
          mtools
          parted
          syslinux
        ]
      }
  &#x27;&#x27;;

  doCheck = true;
  nativeCheckInputs = [
    util-linux
    qemu
  ];
  # `checkPhase` elided
})
</code></pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">makeWrapper</code> is a setup hook, i.e., a shell script sourced by the generic builder of <code class="literal">stdenv</code>.
It is thus executed during the build and must be added to <code class="literal">nativeBuildInputs</code>.</p></li><li class="listitem"><p><code class="literal">pkg-config</code> is a build tool which the configure script of <code class="literal">solo5</code> expects to be on <code class="literal">$PATH</code> during the build:
therefore, it must be added to <code class="literal">nativeBuildInputs</code>.</p></li><li class="listitem"><p><code class="literal">libseccomp</code> is a library linked into <code class="literal">$out/bin/solo5-elftool</code>.
As it is used at runtime, it must be added to <code class="literal">buildInputs</code>.</p></li><li class="listitem"><p>Tests need <code class="literal">qemu</code> and <code class="literal">getopt</code> (from <code class="literal">util-linux</code>) on <code class="literal">$PATH</code>, these must be added to <code class="literal">nativeCheckInputs</code>.</p></li><li class="listitem"><p>Some dependencies are injected directly in the shell code of phases: <code class="literal">syslinux</code>, <code class="literal">dosfstools</code>, <code class="literal">mtools</code>, and <code class="literal">parted</code>.
In this specific case, they will end up in the output of the derivation (<code class="literal">$out</code> here).
As Nix marks dependencies whose absolute path is present in the output as runtime dependencies, adding them to <code class="literal">buildInputs</code> is not required.</p></li></ul></div><p>For more complex cases, like libraries linked into an executable which is then executed as part of the build system, see <a class="xref" href="index.html#ssec-stdenv-dependencies-reference" title="Reference" >the section called “Reference”</a>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-stdenv-dependencies-reference" class="title" >Reference   </h3>  </div> </div></div><p>As described in the Nix manual, almost any <code class="literal">*.drv</code> store path in a derivation’s attribute set will induce a dependency on that derivation. <code class="literal">mkDerivation</code>, however, takes a few attributes intended to include all the dependencies of a package. This is done both for structure and consistency, but also so that certain other setup can take place. For example, certain dependencies need their bin directories added to the <code class="literal">PATH</code>. That is built-in, but other setup is done via a pluggable mechanism that works in conjunction with these dependency attributes. See <a class="xref" href="index.html#ssec-setup-hooks" title="Package setup hooks" >the section called “Package setup hooks”</a> for details.</p><p>Dependencies can be broken down along these axes: their host and target platforms relative to the new derivation’s. The platform distinctions are motivated by cross compilation; see <a class="xref" href="index.html#chap-cross" title="Cross-compilation" ><em>Cross-compilation</em></a> for exactly what each platform means. <a href="index.html#footnote-stdenv-ignored-build-platform" class="footnote" id="footnote-stdenv-ignored-build-platform.__back.0"><sup class="footnote">[1]</sup></a> But even if one is not cross compiling, the platforms imply whether a dependency is needed at run-time or build-time.</p><p>The extension of <code class="literal">PATH</code> with dependencies, alluded to above, proceeds according to the relative platforms alone. The process is carried out only for dependencies whose host platform matches the new derivation’s build platform i.e. dependencies which run on the platform where the new derivation will be built. <a href="index.html#footnote-stdenv-native-dependencies-in-path" class="footnote" id="footnote-stdenv-native-dependencies-in-path.__back.0"><sup class="footnote">[2]</sup></a> For each dependency &lt;dep&gt; of those dependencies, <code class="literal">dep/bin</code>, if present, is added to the <code class="literal">PATH</code> environment variable.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-stdenv-dependencies-propagated" class="title" >Dependency propagation   </h3>  </div> </div></div><p>Propagated dependencies are made available to all downstream dependencies.
This is particularly useful for interpreted languages, where all transitive dependencies have to be present in the same environment.
Therefore it is used for the Python infrastructure in Nixpkgs.</p><div class="note"><h3 class="title">Note</h3><p>Propagated dependencies should be used with care, because they obscure the actual build inputs of dependent derivations and cause side effects through setup hooks.
This can lead to conflicting dependencies that cannot easily be resolved.</p></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 274. A propagated dependency</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };
let
  bar = stdenv.mkDerivation {
    name = &quot;bar&quot;;
    dontUnpack = true;
    # `hello` is also made available to dependents, such as `foo`
    propagatedBuildInputs = [ hello ];
    postInstall = &quot;mkdir $out&quot;;
  };
  foo = stdenv.mkDerivation {
    name = &quot;foo&quot;;
    dontUnpack = true;
    # `bar` is a direct dependency, which implicitly includes the propagated `hello`
    buildInputs = [ bar ];
    # The `hello` binary is available!
    postInstall = &quot;hello &gt; $out&quot;;
  };
in
foo
</code></pre></div></details></div><br class="example-break" /><p>Dependency propagation takes cross compilation into account, meaning that dependencies that cross platform boundaries are properly adjusted.</p><p>To determine the exact rules for dependency propagation, we start by assigning to each dependency a couple of ternary numbers (<code class="literal">-1</code> for <code class="literal">build</code>, <code class="literal">0</code> for <code class="literal">host</code>, and <code class="literal">1</code> for <code class="literal">target</code>) representing its <a class="link" href="index.html#possible-dependency-types" title="Possible dependency types" >dependency type</a>, which captures how its host and target platforms are each “offset” from the depending derivation’s host and target platforms. The following table summarize the different combinations that can be obtained:</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left"><code class="literal">host → target</code></th><th align="left">attribute name</th><th align="left">offset</th><th align="left">typical purpose</th></tr></thead><tbody><tr><td align="left"><code class="literal">build --&gt; build</code></td><td align="left"><code class="literal">depsBuildBuild</code></td><td align="left"><code class="literal">-1, -1</code></td><td align="left">compilers for build helpers</td></tr><tr><td align="left"><code class="literal">build --&gt; host</code></td><td align="left"><code class="literal">nativeBuildInputs</code></td><td align="left"><code class="literal">-1, 0</code></td><td align="left">build tools, compilers, setup hooks</td></tr><tr><td align="left"><code class="literal">build --&gt; target</code></td><td align="left"><code class="literal">depsBuildTarget</code></td><td align="left"><code class="literal">-1, 1</code></td><td align="left">compilers to build stdlibs to run on target</td></tr><tr><td align="left"><code class="literal">host --&gt; host</code></td><td align="left"><code class="literal">depsHostHost</code></td><td align="left"><code class="literal">0, 0</code></td><td align="left">compilers to build C code at runtime (rare)</td></tr><tr><td align="left"><code class="literal">host --&gt; target</code></td><td align="left"><code class="literal">buildInputs</code></td><td align="left"><code class="literal">0, 1</code></td><td align="left">libraries</td></tr><tr><td align="left"><code class="literal">target --&gt; target</code></td><td align="left"><code class="literal">depsTargetTarget</code></td><td align="left"><code class="literal">1, 1</code></td><td align="left">stdlibs to run on target</td></tr></tbody></table></div><p>Algorithmically, we traverse propagated inputs, accumulating every propagated dependency’s propagated dependencies and adjusting them to account for the “shift in perspective” described by the current dependency’s platform offsets. This results is sort of a transitive closure of the dependency relation, with the offsets being approximately summed when two dependency links are combined. We also prune transitive dependencies whose combined offsets go out-of-bounds, which can be viewed as a filter over that transitive closure removing dependencies that are blatantly absurd.</p><p>We can define the process precisely with <a class="link" href="https://en.wikipedia.org/wiki/Natural_deduction"  target="_top">Natural Deduction</a> using the inference rules below. This probably seems a bit obtuse, but so is the bash code that actually implements it! <a href="index.html#footnote-stdenv-find-inputs-location" class="footnote" id="footnote-stdenv-find-inputs-location.__back.0"><sup class="footnote">[3]</sup></a> They’re confusing in very different ways so… hopefully if something doesn’t make sense in one presentation, it will in the other!</p><p><span class="strong"><strong>Definitions:</strong></span></p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">dep(h_offset, t_offset, X, Y)</code></span></dt><dd><p>Package X has a direct dependency on Y in a position with host offset <code class="literal">h_offset</code> and target offset <code class="literal">t_offset</code>.</p><p>For example, <code class="literal">nativeBuildInputs = [ Y ]</code> means <code class="literal">dep(-1, 0, X, Y)</code>.</p></dd><dt><span class="term"><code class="literal">propagated-dep(h_offset, t_offset, X, Y)</code></span></dt><dd><p>Package X has a propagated dependency on Y in a position with host offset <code class="literal">h_offset</code> and target offset <code class="literal">t_offset</code>.</p><p>For example, <code class="literal">depsBuildTargetPropagated = [ Y ]</code> means <code class="literal">propagated-dep(-1, 1, X, Y)</code>.</p></dd><dt><span class="term"><code class="literal">mapOffset(h, t, i) = offs</code></span></dt><dd><p>In a package X with a dependency on Y in a position with host offset <code class="literal">h</code> and target offset <code class="literal">t</code>, Y’s transitive dependency Z in a position with offset <code class="literal">i</code> is mapped to offset <code class="literal">offs</code> in X.</p></dd></dl></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 275. Truth table of <code class="literal">mapOffset(h, t, i)</code></strong></span></summary><div class="example-contents"><p><code class="literal">x</code> means that the dependency was discarded because <code class="literal">h + i ∉ {-1, 0, 1}</code>.</p><pre><code class="programlisting">  h |   t  || i=-1 |  i=0 |  i=1
----|------||------|------|-----
 -1 |  -1  ||   x  |  -1  |  -1
 -1 |   0  ||   x  |  -1  |   0
 -1 |   1  ||   x  |  -1  |   1
  0 |   0  ||  -1  |   0  |   0
  0 |   1  ||  -1  |   0  |   1
  1 |   1  ||   0  |   1  |   x
</code></pre></div></details></div><br class="example-break" /><pre><code class="programlisting">let mapOffset(h, t, i) = i + (if i &lt;= 0 then h else t - 1)

propagated-dep(h0, t0, A, B)
propagated-dep(h1, t1, B, C)
h0 + h1 in {-1, 0, 1}
h0 + t1 in {-1, 0, 1}
-------------------------------------- Transitive property
propagated-dep(mapOffset(h0, t0, h1),
               mapOffset(h0, t0, t1),
               A, C)
</code></pre><pre><code class="programlisting">let mapOffset(h, t, i) = i + (if i &lt;= 0 then h else t - 1)

dep(h0, t0, A, B)
propagated-dep(h1, t1, B, C)
h0 + h1 in {-1, 0, 1}
h0 + t1 in {-1, 0, 1}
----------------------------- Take immediate dependencies&#x27; propagated dependencies
propagated-dep(mapOffset(h0, t0, h1),
               mapOffset(h0, t0, t1),
               A, C)
</code></pre><pre><code class="programlisting">propagated-dep(h, t, A, B)
----------------------------- Propagated dependencies count as dependencies
dep(h, t, A, B)
</code></pre><p>Some explanation of this monstrosity is in order. In the common case of <code class="literal">nativeBuildInputs</code> or <code class="literal">buildInputs</code>, the target offset of a dependency is one greater than the host offset: <code class="literal">t = h + 1</code>. That means that:</p><pre><code class="programlisting">let f(h, t, i) = i + (if i &lt;= 0 then h else t - 1)
let f(h, h + 1, i) = i + (if i &lt;= 0 then h else (h + 1) - 1)
let f(h, h + 1, i) = i + (if i &lt;= 0 then h else h)
let f(h, h + 1, i) = i + h
</code></pre><p>This is where “sum-like” comes in from above: We can just sum all of the host offsets to get the host offset of the transitive dependency. The target offset is the transitive dependency is the host offset + 1, just as it was with the dependencies composed to make this transitive one; it can be ignored as it doesn’t add any new information.</p><p>Because of the bounds checks, the uncommon cases are <code class="literal">h = t</code> (<code class="literal">depsBuildBuild</code>, etc) and <code class="literal">h + 2 = t</code> (<code class="literal">depsBuildTarget</code>).</p><p>In the former case, the motivation for <code class="literal">mapOffset</code> is that since its host and target platforms are the same, no transitive dependency of it should be able to “discover” an offset greater than its reduced target offsets. <code class="literal">mapOffset</code> effectively “squashes” all its transitive dependencies’ offsets so that none will ever be greater than the target offset of the original <code class="literal">h = t</code> package.</p><p>In the other case, <code class="literal">h + 1</code> (0) is skipped over between the host (-1) and target (1) offsets. Instead of squashing the offsets, we need to “rip” them apart so no transitive dependency’s offset is 0.</p><p>Overall, the unifying theme here is that propagation shouldn’t be introducing transitive dependencies involving platforms the depending package is unaware of. [One can imagine the depending package asking for dependencies with the platforms it knows about; other platforms it doesn’t know how to ask for. The platform description in that scenario is a kind of unforgeable capability.] The offset bounds checking and definition of <code class="literal">mapOffset</code> together ensure that this is the case. Discovering a new offset is discovering a new platform, and since those platforms weren’t in the derivation “spec” of the needing package, they cannot be relevant. From a capability perspective, we can imagine that the host and target platforms of a package are the capabilities a package requires, and the depending package must provide the capability to the dependency.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="variables-specifying-dependencies" class="title" >Variables specifying dependencies   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-depsBuildBuild" class="title" ><code class="literal">depsBuildBuild</code>   </h5>  </div> </div></div><p>A list of dependencies whose host and target platforms are the new derivation’s build platform. These are programs and libraries used at build time that produce programs and libraries also used at build time. If the dependency doesn’t care about the target platform (i.e. isn’t a compiler or similar tool), put it in <code class="literal">nativeBuildInputs</code> instead. The most common use of this <code class="literal">buildPackages.stdenv.cc</code>, the default C compiler for this role. That example crops up more than one might think in old commonly used C libraries.</p><p>Since these packages are able to be run at build-time, they are always added to the <code class="literal">PATH</code>, as described above. But since these packages are only guaranteed to be able to run then, they shouldn’t persist as run-time dependencies. This isn’t currently enforced, but could be in the future.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-nativeBuildInputs" class="title" ><code class="literal">nativeBuildInputs</code>   </h5>  </div> </div></div><p>A list of dependencies whose host platform is the new derivation’s build platform, and target platform is the new derivation’s host platform. These are programs and libraries used at build-time that, if they are a compiler or similar tool, produce code to run at run-time—i.e. tools used to build the new derivation. If the dependency doesn’t care about the target platform (i.e. isn’t a compiler or similar tool), put it here, rather than in <code class="literal">depsBuildBuild</code> or <code class="literal">depsBuildTarget</code>. This could be called <code class="literal">depsBuildHost</code> but <code class="literal">nativeBuildInputs</code> is used for historical continuity.</p><p>Since these packages are able to be run at build-time, they are added to the <code class="literal">PATH</code>, as described above. But since these packages are only guaranteed to be able to run then, they shouldn’t persist as run-time dependencies. This isn’t currently enforced, but could be in the future.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-depsBuildTarget" class="title" ><code class="literal">depsBuildTarget</code>   </h5>  </div> </div></div><p>A list of dependencies whose host platform is the new derivation’s build platform, and target platform is the new derivation’s target platform. These are programs used at build time that produce code to run with code produced by the depending package. Most commonly, these are tools used to build the runtime or standard library that the currently-being-built compiler will inject into any code it compiles. In many cases, the currently-being-built-compiler is itself employed for that task, but when that compiler won’t run (i.e. its build and host platform differ) this is not possible. Other times, the compiler relies on some other tool, like binutils, that is always built separately so that the dependency is unconditional.</p><p>This is a somewhat confusing concept to wrap one’s head around, and for good reason. As the only dependency type where the platform offsets, <code class="literal">-1</code> and <code class="literal">1</code>, are not adjacent integers, it requires thinking of a bootstrapping stage <span class="emphasis"><em>two</em></span> away from the current one. It and its use-case go hand in hand and are both considered poor form: try to not need this sort of dependency, and try to avoid building standard libraries and runtimes in the same derivation as the compiler produces code using them. Instead strive to build those like a normal library, using the newly-built compiler just as a normal library would. In short, do not use this attribute unless you are packaging a compiler and are sure it is needed.</p><p>Since these packages are able to run at build time, they are added to the <code class="literal">PATH</code>, as described above. But since these packages are only guaranteed to be able to run then, they shouldn’t persist as run-time dependencies. This isn’t currently enforced, but could be in the future.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-depsHostHost" class="title" ><code class="literal">depsHostHost</code>   </h5>  </div> </div></div><p>A list of dependencies whose host and target platforms match the new derivation’s host platform. In practice, this would usually be tools used by compilers for macros or a metaprogramming system, or libraries used by the macros or metaprogramming code itself. It’s always preferable to use a <code class="literal">depsBuildBuild</code> dependency in the derivation being built over a <code class="literal">depsHostHost</code> on the tool doing the building for this purpose.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-buildInputs" class="title" ><code class="literal">buildInputs</code>   </h5>  </div> </div></div><p>A list of dependencies whose host platform and target platform match the new derivation’s. This would be called <code class="literal">depsHostTarget</code> but for historical continuity. If the dependency doesn’t care about the target platform (i.e. isn’t a compiler or similar tool), put it here, rather than in <code class="literal">depsBuildBuild</code>.</p><p>These are often programs and libraries used by the new derivation at <span class="emphasis"><em>run</em></span>-time, but that isn’t always the case. For example, the machine code in a statically-linked library is only used at run-time, but the derivation containing the library is only needed at build-time. Even in the dynamic case, the library may also be needed at build-time to appease the linker.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-depsTargetTarget" class="title" ><code class="literal">depsTargetTarget</code>   </h5>  </div> </div></div><p>A list of dependencies whose host platform matches the new derivation’s target platform. These are packages that run on the target platform, e.g. the standard library or run-time deps of standard library that a compiler insists on knowing about. It’s poor form in almost all cases for a package to depend on another from a future stage [future stage corresponding to positive offset]. Do not use this attribute unless you are packaging a compiler and are sure it is needed.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-depsBuildBuildPropagated" class="title" ><code class="literal">depsBuildBuildPropagated</code>   </h5>  </div> </div></div><p>The propagated equivalent of <code class="literal">depsBuildBuild</code>. This perhaps never ought to be used, but it is included for consistency [see below for the others].</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-propagatedNativeBuildInputs" class="title" ><code class="literal">propagatedNativeBuildInputs</code>   </h5>  </div> </div></div><p>The propagated equivalent of <code class="literal">nativeBuildInputs</code>. This would be called <code class="literal">depsBuildHostPropagated</code> but for historical continuity. For example, if package <code class="literal">Y</code> has <code class="literal">propagatedNativeBuildInputs = [X]</code>, and package <code class="literal">Z</code> has <code class="literal">buildInputs = [Y]</code>, then package <code class="literal">Z</code> will be built as if it included package <code class="literal">X</code> in its <code class="literal">nativeBuildInputs</code>. Note that if instead, package <code class="literal">Z</code> has <code class="literal">nativeBuildInputs = [Y]</code>, then <code class="literal">X</code> will not be included at all.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-depsBuildTargetPropagated" class="title" ><code class="literal">depsBuildTargetPropagated</code>   </h5>  </div> </div></div><p>The propagated equivalent of <code class="literal">depsBuildTarget</code>. This is prefixed for the same reason of alerting potential users.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-depsHostHostPropagated" class="title" ><code class="literal">depsHostHostPropagated</code>   </h5>  </div> </div></div><p>The propagated equivalent of <code class="literal">depsHostHost</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-propagatedBuildInputs" class="title" ><code class="literal">propagatedBuildInputs</code>   </h5>  </div> </div></div><p>The propagated equivalent of <code class="literal">buildInputs</code>. This would be called <code class="literal">depsHostTargetPropagated</code> but for historical continuity.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-depsTargetTargetPropagated" class="title" ><code class="literal">depsTargetTargetPropagated</code>   </h5>  </div> </div></div><p>The propagated equivalent of <code class="literal">depsTargetTarget</code>. This is prefixed for the same reason of alerting potential users.</p>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ssec-stdenv-attributes" class="title" style="clear: both">Attributes   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#variables-affecting-stdenv-initialisation">Variables affecting <code class="literal">stdenv</code> initialisation</a> </span></dt><dt> <span class="section">  <a href="index.html#attributes-affecting-build-properties">Attributes affecting build properties</a> </span></dt><dt> <span class="section">  <a href="index.html#mkderivation-recursive-attributes">Fixed-point arguments of <code class="literal">mkDerivation</code></a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="variables-affecting-stdenv-initialisation" class="title" >Variables affecting <code class="literal">stdenv</code> initialisation   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-stdenv-NIX_DEBUG" class="title" ><code class="literal">NIX_DEBUG</code>   </h4>  </div> </div></div><p>A number between 0 and 7 indicating how much information to log. If set to 1 or higher, <code class="literal">stdenv</code> will print moderate debugging information during the build. In particular, the <code class="literal">gcc</code> and <code class="literal">ld</code> wrapper scripts will print out the complete command line passed to the wrapped tools. If set to 6 or higher, the <code class="literal">stdenv</code> setup script will be run with <code class="literal">set -x</code> tracing. If set to 7 or higher, the <code class="literal">gcc</code> and <code class="literal">ld</code> wrapper scripts will also be run with <code class="literal">set -x</code> tracing.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="attributes-affecting-build-properties" class="title" >Attributes affecting build properties   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-stdenv-enableParallelBuilding" class="title" ><code class="literal">enableParallelBuilding</code>   </h4>  </div> </div></div><p>If set to <code class="literal">true</code>, <code class="literal">stdenv</code> will pass specific flags to <code class="literal">make</code> and other build tools to enable parallel building with up to <code class="literal">build-cores</code> workers.</p><p>Unless set to <code class="literal">false</code>, some build systems with good support for parallel building including <code class="literal">cmake</code>, <code class="literal">meson</code>, and <code class="literal">qmake</code> will set it to <code class="literal">true</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="mkderivation-recursive-attributes" class="title" >Fixed-point arguments of <code class="literal">mkDerivation</code>   </h3>  </div> </div></div><p>If you pass a function to <code class="literal">mkDerivation</code>, it will receive as its argument the final arguments, including the overrides when reinvoked via <code class="literal">overrideAttrs</code>. For example:</p><pre><code class="programlisting nix">mkDerivation (finalAttrs: {
  pname = &quot;hello&quot;;
  withFeature = true;
  configureFlags = lib.optionals finalAttrs.withFeature [ &quot;--with-feature&quot; ];
})
</code></pre><p>Note that this does not use the <code class="literal">rec</code> keyword to reuse <code class="literal">withFeature</code> in <code class="literal">configureFlags</code>.
The <code class="literal">rec</code> keyword works at the syntax level and is unaware of overriding.</p><p>Instead, the definition references <code class="literal">finalAttrs</code>, allowing users to change <code class="literal">withFeature</code>
consistently with <code class="literal">overrideAttrs</code>.</p><p><code class="literal">finalAttrs</code> also contains the attribute <code class="literal">finalPackage</code>, which includes the output paths, etc.</p><p>Let’s look at a more elaborate example to understand the differences between
various bindings:</p><pre><code class="programlisting nix"># `pkg` is the _original_ definition (for illustration purposes)
let
  pkg = mkDerivation (finalAttrs: {
    # ...

    # An example attribute
    packages = [ ];

    # `passthru.tests` is a commonly defined attribute.
    passthru.tests.simple = f finalAttrs.finalPackage;

    # An example of an attribute containing a function
    passthru.appendPackages =
      packages&#x27;:
      finalAttrs.finalPackage.overrideAttrs (newSelf: super: { packages = super.packages ++ packages&#x27;; });

    # For illustration purposes; referenced as
    # `(pkg.overrideAttrs(x)).finalAttrs` etc in the text below.
    passthru.finalAttrs = finalAttrs;
    passthru.original = pkg;
  });
in
pkg
</code></pre><p>Unlike the <code class="literal">pkg</code> binding in the above example, the <code class="literal">finalAttrs</code> parameter always references the final attributes. For instance <code class="literal">(pkg.overrideAttrs(x)).finalAttrs.finalPackage</code> is identical to <code class="literal">pkg.overrideAttrs(x)</code>, whereas <code class="literal">(pkg.overrideAttrs(x)).original</code> is the same as the original <code class="literal">pkg</code>.</p><p>See also the section about <a class="link" href="index.html#var-passthru-tests" title="passthru.tests" ><code class="literal">passthru.tests</code></a>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-stdenv-phases" class="title" style="clear: both">Phases   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-controlling-phases">Controlling phases</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-unpack-phase">The unpack phase</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-patch-phase">The patch phase</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-configure-phase">The configure phase</a> </span></dt><dt> <span class="section">  <a href="index.html#build-phase">The build phase</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-check-phase">The check phase</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-install-phase">The install phase</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-fixup-phase">The fixup phase</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-installCheck-phase">The installCheck phase</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-distribution-phase">The distribution phase</a> </span></dt> </dl></div><p><code class="literal">stdenv.mkDerivation</code> sets the Nix <a class="link" href="https://nixos.org/manual/nix/stable/expressions/derivations.html#derivations"  target="_top">derivation</a>’s builder to a script that loads the stdenv <code class="literal">setup.sh</code> bash library and calls <code class="literal">genericBuild</code>. Most packaging functions rely on this default builder.</p><p>This generic command either invokes a script at <span class="emphasis"><em>buildCommandPath</em></span>, or a <span class="emphasis"><em>buildCommand</em></span>, or a number of <span class="emphasis"><em>phases</em></span>. Package builds are split into phases to make it easier to override specific parts of the build (e.g., unpacking the sources or installing the binaries).</p><p>Each phase can be overridden in its entirety either by setting the environment variable <code class="literal">namePhase</code> to a string containing some shell commands to be executed, or by redefining the shell function <code class="literal">namePhase</code>. The former is convenient to override a phase from the derivation, while the latter is convenient from a build script. However, typically one only wants to <span class="emphasis"><em>add</em></span> some commands to a phase, e.g. by defining <code class="literal">postInstall</code> or <code class="literal">preFixup</code>, as skipping some of the default actions may have unexpected consequences. The default script for each phase is defined in the file <code class="literal">pkgs/stdenv/generic/setup.sh</code>.</p><p>When overriding a phase, for example <code class="literal">installPhase</code>, it is important to start with <code class="literal">runHook preInstall</code> and end it with <code class="literal">runHook postInstall</code>, otherwise <code class="literal">preInstall</code> and <code class="literal">postInstall</code> will not be run. Even if you don’t use them directly, it is good practice to do so anyways for downstream users who would want to add a <code class="literal">postInstall</code> by overriding your derivation.</p><p>While inside an interactive <code class="literal">nix-shell</code>, if you wanted to run all phases in the order they would be run in an actual build, you can invoke <code class="literal">genericBuild</code> yourself.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-controlling-phases" class="title" >Controlling phases   </h3>  </div> </div></div><p>There are a number of variables that control what phases are executed and in what order:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="variables-affecting-phase-control" class="title" >Variables affecting phase control   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-phases" class="title" ><code class="literal">phases</code>   </h5>  </div> </div></div><p>Specifies the phases. You can change the order in which phases are executed, or add new phases, by setting this variable. If it’s not set, the default value is used, which is <code class="literal">$prePhases unpackPhase patchPhase $preConfigurePhases configurePhase $preBuildPhases buildPhase checkPhase $preInstallPhases installPhase fixupPhase installCheckPhase $preDistPhases distPhase $postPhases</code>.</p><p>The elements of <code class="literal">phases</code> must not contain spaces. If <code class="literal">phases</code> is specified as a Nix Language attribute, it should be specified as lists instead of strings. The same rules apply to the <code class="literal">*Phases</code> variables.</p><p>It is discouraged to set this variable, as it is easy to miss some important functionality hidden in some of the less obviously needed phases (like <code class="literal">fixupPhase</code> which patches the shebang of scripts).
Usually, if you just want to add a few phases, it’s more convenient to set one of the <code class="literal">*Phases</code> variables below.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-prePhases" class="title" ><code class="literal">prePhases</code>   </h5>  </div> </div></div><p>Additional phases executed before any of the default phases.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preConfigurePhases" class="title" ><code class="literal">preConfigurePhases</code>   </h5>  </div> </div></div><p>Additional phases executed just before the configure phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preBuildPhases" class="title" ><code class="literal">preBuildPhases</code>   </h5>  </div> </div></div><p>Additional phases executed just before the build phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preInstallPhases" class="title" ><code class="literal">preInstallPhases</code>   </h5>  </div> </div></div><p>Additional phases executed just before the install phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preFixupPhases" class="title" ><code class="literal">preFixupPhases</code>   </h5>  </div> </div></div><p>Additional phases executed just before the fixup phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preDistPhases" class="title" ><code class="literal">preDistPhases</code>   </h5>  </div> </div></div><p>Additional phases executed just before the distribution phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-postPhases" class="title" ><code class="literal">postPhases</code>   </h5>  </div> </div></div><p>Additional phases executed after any of the default phases.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-unpack-phase" class="title" >The unpack phase   </h3>  </div> </div></div><p>The unpack phase is responsible for unpacking the source code of the package. The default implementation of <code class="literal">unpackPhase</code> unpacks the source files listed in the <code class="literal">src</code> environment variable to the current directory. It supports the following files by default:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="tar-files" class="title" >Tar files   </h4>  </div> </div></div><p>These can optionally be compressed using <code class="literal">gzip</code> (<code class="literal">.tar.gz</code>, <code class="literal">.tgz</code> or <code class="literal">.tar.Z</code>), <code class="literal">bzip2</code> (<code class="literal">.tar.bz2</code>, <code class="literal">.tbz2</code> or <code class="literal">.tbz</code>) or <code class="literal">xz</code> (<code class="literal">.tar.xz</code>, <code class="literal">.tar.lzma</code> or <code class="literal">.txz</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="zip-files" class="title" >Zip files   </h4>  </div> </div></div><p>Zip files are unpacked using <code class="literal">unzip</code>. However, <code class="literal">unzip</code> is not in the standard environment, so you should add it to <code class="literal">nativeBuildInputs</code> yourself.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="directories-in-the-nix-store" class="title" >Directories in the Nix store   </h4>  </div> </div></div><p>These are copied to the current directory. The hash part of the file name is stripped, e.g. <code class="literal">/nix/store/1wydxgby13cz...-my-sources</code> would be copied to <code class="literal">my-sources</code>.</p><p>Additional file types can be supported by setting the <code class="literal">unpackCmd</code> variable (see below).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="variables-controlling-the-unpack-phase" class="title" >Variables controlling the unpack phase   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-src" class="title" ><code class="literal">srcs</code> / <code class="literal">src</code>   </h5>  </div> </div></div><p>The list of source files or directories to be unpacked or copied. One of these must be set. Note that if you use <code class="literal">srcs</code>, you should also set <code class="literal">sourceRoot</code> or <code class="literal">setSourceRoot</code>.</p><p>These should ideally actually be sources and licensed under a FLOSS license.  If you have to use a binary upstream release or package non-free software, make sure you correctly mark your derivation as such in the <a class="link" href="index.html#var-meta-sourceProvenance" title="sourceProvenance" ><code class="literal">sourceProvenance</code></a> and <a class="link" href="index.html#sec-meta-license" title="Licenses" ><code class="literal">license</code></a> fields of the <a class="link" href="index.html#chap-meta" title="Meta-attributes" ><code class="literal">meta</code></a> section.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-sourceRoot" class="title" ><code class="literal">sourceRoot</code>   </h5>  </div> </div></div><p>After unpacking all of <code class="literal">src</code> and <code class="literal">srcs</code>, if neither of <code class="literal">sourceRoot</code> and <code class="literal">setSourceRoot</code> are set, <code class="literal">unpackPhase</code> of the generic builder checks that the unpacking produced a single directory and moves the current working directory into it.</p><p>If <code class="literal">unpackPhase</code> produces multiple source directories, you should set <code class="literal">sourceRoot</code> to the name of the intended directory.
You can also set <code class="literal">sourceRoot = &quot;.&quot;;</code> if you want to control it yourself in a later phase.</p><p>For example, if you want your build to start in a sub-directory inside your sources, and you are using <code class="literal">fetchzip</code>-derived <code class="literal">src</code> (like <code class="literal">fetchFromGitHub</code> or similar), you need to set <code class="literal">sourceRoot = &quot;${src.name}/my-sub-directory&quot;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-setSourceRoot" class="title" ><code class="literal">setSourceRoot</code>   </h5>  </div> </div></div><p>Alternatively to setting <code class="literal">sourceRoot</code>, you can set <code class="literal">setSourceRoot</code> to a shell command to be evaluated by the unpack phase after the sources have been unpacked. This command must set <code class="literal">sourceRoot</code>.</p><p>For example, if you are using <code class="literal">fetchurl</code> on an archive file that gets unpacked into a single directory the name of which changes between package versions, and you want your build to start in its sub-directory, you need to set <code class="literal">setSourceRoot = &quot;sourceRoot=$(echo */my-sub-directory)&quot;;</code>, or in the case of multiple sources, you could use something more specific, like <code class="literal">setSourceRoot = &quot;sourceRoot=$(echo ${pname}-*/my-sub-directory)&quot;;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preUnpack" class="title" ><code class="literal">preUnpack</code>   </h5>  </div> </div></div><p>Hook executed at the start of the unpack phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-postUnpack" class="title" ><code class="literal">postUnpack</code>   </h5>  </div> </div></div><p>Hook executed at the end of the unpack phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontUnpack" class="title" ><code class="literal">dontUnpack</code>   </h5>  </div> </div></div><p>Set to true to skip the unpack phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontMakeSourcesWritable" class="title" ><code class="literal">dontMakeSourcesWritable</code>   </h5>  </div> </div></div><p>If set to <code class="literal">1</code>, the unpacked sources are <span class="emphasis"><em>not</em></span> made writable. By default, they are made writable to prevent problems with read-only sources. For example, copied store directories would be read-only without this.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-unpackCmd" class="title" ><code class="literal">unpackCmd</code>   </h5>  </div> </div></div><p>The unpack phase evaluates the string <code class="literal">$unpackCmd</code> for any unrecognised file. The path to the current source file is contained in the <code class="literal">curSrc</code> variable.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-patch-phase" class="title" >The patch phase   </h3>  </div> </div></div><p>The patch phase applies the list of patches defined in the <code class="literal">patches</code> variable.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="variables-controlling-the-patch-phase" class="title" >Variables controlling the patch phase   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontPatch" class="title" ><code class="literal">dontPatch</code>   </h5>  </div> </div></div><p>Set to true to skip the patch phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-patches" class="title" ><code class="literal">patches</code>   </h5>  </div> </div></div><p>The list of patches. They must be in the format accepted by the <code class="literal">patch</code> command, and may optionally be compressed using <code class="literal">gzip</code> (<code class="literal">.gz</code>), <code class="literal">bzip2</code> (<code class="literal">.bz2</code>) or <code class="literal">xz</code> (<code class="literal">.xz</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-patchFlags" class="title" ><code class="literal">patchFlags</code>   </h5>  </div> </div></div><p>Flags to be passed to <code class="literal">patch</code>. If not set, the argument <code class="literal">-p1</code> is used, which causes the leading directory component to be stripped from the file names in each patch.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-prePatch" class="title" ><code class="literal">prePatch</code>   </h5>  </div> </div></div><p>Hook executed at the start of the patch phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-postPatch" class="title" ><code class="literal">postPatch</code>   </h5>  </div> </div></div><p>Hook executed at the end of the patch phase.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-configure-phase" class="title" >The configure phase   </h3>  </div> </div></div><p>The configure phase prepares the source tree for building. The default <code class="literal">configurePhase</code> runs <code class="literal">./configure</code> (typically an Autoconf-generated script) if it exists.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="variables-controlling-the-configure-phase" class="title" >Variables controlling the configure phase   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-configureScript" class="title" ><code class="literal">configureScript</code>   </h5>  </div> </div></div><p>The name of the configure script. It defaults to <code class="literal">./configure</code> if it exists; otherwise, the configure phase is skipped. This can actually be a command (like <code class="literal">perl ./Configure.pl</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-configureFlags" class="title" ><code class="literal">configureFlags</code>   </h5>  </div> </div></div><p>A list of strings passed as additional arguments to the configure script.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontConfigure" class="title" ><code class="literal">dontConfigure</code>   </h5>  </div> </div></div><p>Set to true to skip the configure phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-configureFlagsArray" class="title" ><code class="literal">configureFlagsArray</code>   </h5>  </div> </div></div><p>A shell array containing additional arguments passed to the configure script. You must use this instead of <code class="literal">configureFlags</code> if the arguments contain spaces.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontAddPrefix" class="title" ><code class="literal">dontAddPrefix</code>   </h5>  </div> </div></div><p>By default, <code class="literal">./configure</code> is passed the concatenation of <a class="link" href="index.html#var-stdenv-prefixKey" title="prefixKey" ><code class="literal">prefixKey</code></a> and <a class="link" href="index.html#var-stdenv-prefix" title="prefix" ><code class="literal">prefix</code></a> on the command line. Disable this by setting <code class="literal">dontAddPrefix</code> to <code class="literal">true</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-prefix" class="title" ><code class="literal">prefix</code>   </h5>  </div> </div></div><p>The prefix under which the package must be installed, passed via the <code class="literal">--prefix</code> option to the configure script. It defaults to <code class="literal">$out</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-prefixKey" class="title" ><code class="literal">prefixKey</code>   </h5>  </div> </div></div><p>The key to use when specifying the installation <a class="link" href="index.html#var-stdenv-prefix" title="prefix" ><code class="literal">prefix</code></a>. By default, this is set to <code class="literal">--prefix=</code> as that is used by the majority of packages. Other packages may need <code class="literal">--prefix </code> (with a trailing space) or <code class="literal">PREFIX=</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontAddStaticConfigureFlags" class="title" ><code class="literal">dontAddStaticConfigureFlags</code>   </h5>  </div> </div></div><p>By default, when building statically, stdenv will try to add build system appropriate configure flags to try to enable static builds.</p><p>If this is undesirable, set this variable to true.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontAddDisableDepTrack" class="title" ><code class="literal">dontAddDisableDepTrack</code>   </h5>  </div> </div></div><p>By default, the flag <code class="literal">--disable-dependency-tracking</code> is added to the configure flags to speed up Automake-based builds. If this is undesirable, set this variable to true.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontFixLibtool" class="title" ><code class="literal">dontFixLibtool</code>   </h5>  </div> </div></div><p>By default, the configure phase applies some special hackery to all files called <code class="literal">ltmain.sh</code> before running the configure script in order to improve the purity of Libtool-based packages <a href="index.html#footnote-stdenv-sys-lib-search-path" class="footnote" id="footnote-stdenv-sys-lib-search-path.__back.0"><sup class="footnote">[4]</sup></a> . If this is undesirable, set this variable to true.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontDisableStatic" class="title" ><code class="literal">dontDisableStatic</code>   </h5>  </div> </div></div><p>By default, when the configure script has <code class="literal">--enable-static</code>, the option <code class="literal">--disable-static</code> is added to the configure flags.</p><p>If this is undesirable, set this variable to true.  It is automatically set to true when building statically, for example through <code class="literal">pkgsStatic</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-configurePlatforms" class="title" ><code class="literal">configurePlatforms</code>   </h5>  </div> </div></div><p>By default, when cross compiling, the configure script has <code class="literal">--build=...</code> and <code class="literal">--host=...</code> passed. Packages can instead pass <code class="literal">[ &quot;build&quot; &quot;host&quot; &quot;target&quot; ]</code> or a subset to control exactly which platform flags are passed. Compilers and other tools can use this to also pass the target platform. <a href="index.html#footnote-stdenv-build-time-guessing-impurity" class="footnote" id="footnote-stdenv-build-time-guessing-impurity.__back.0"><sup class="footnote">[5]</sup></a></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preConfigure" class="title" ><code class="literal">preConfigure</code>   </h5>  </div> </div></div><p>Hook executed at the start of the configure phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-postConfigure" class="title" ><code class="literal">postConfigure</code>   </h5>  </div> </div></div><p>Hook executed at the end of the configure phase.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="build-phase" class="title" >The build phase   </h3>  </div> </div></div><p>The build phase is responsible for actually building the package (e.g. compiling it). The default <code class="literal">buildPhase</code> calls <code class="literal">make</code> if a file named <code class="literal">Makefile</code>, <code class="literal">makefile</code> or <code class="literal">GNUmakefile</code> exists in the current directory (or the <code class="literal">makefile</code> is explicitly set); otherwise it does nothing.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="variables-controlling-the-build-phase" class="title" >Variables controlling the build phase   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontBuild" class="title" ><code class="literal">dontBuild</code>   </h5>  </div> </div></div><p>Set to true to skip the build phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-makefile" class="title" ><code class="literal">makefile</code>   </h5>  </div> </div></div><p>The file name of the Makefile.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-makeFlags" class="title" ><code class="literal">makeFlags</code>   </h5>  </div> </div></div><p>A list of strings passed as additional flags to <code class="literal">make</code>. These flags are also used by the default install and check phase. For setting make flags specific to the build phase, use <code class="literal">buildFlags</code> (see below).</p><pre><code class="programlisting nix">{ makeFlags = [ &quot;PREFIX=$(out)&quot; ]; }
</code></pre><div class="note"><h3 class="title">Note</h3><p>The flags are quoted in bash, but environment variables can be specified by using the make syntax.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-makeFlagsArray" class="title" ><code class="literal">makeFlagsArray</code>   </h5>  </div> </div></div><p>A shell array containing additional arguments passed to <code class="literal">make</code>. You must use this instead of <code class="literal">makeFlags</code> if the arguments contain spaces, e.g.</p><pre><code class="programlisting nix">{
  preBuild = &#x27;&#x27;
    makeFlagsArray+=(CFLAGS=&quot;-O0 -g&quot; LDFLAGS=&quot;-lfoo -lbar&quot;)
  &#x27;&#x27;;
}
</code></pre><p>Note that shell arrays cannot be passed through environment variables, so you cannot set <code class="literal">makeFlagsArray</code> in a derivation attribute (because those are passed through environment variables): you have to define them in shell code.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-buildFlags" class="title" ><code class="literal">buildFlags</code> / <code class="literal">buildFlagsArray</code>   </h5>  </div> </div></div><p>A list of strings passed as additional flags to <code class="literal">make</code>. Like <code class="literal">makeFlags</code> and <code class="literal">makeFlagsArray</code>, but only used by the build phase. Any build targets should be specified as part of the <code class="literal">buildFlags</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preBuild" class="title" ><code class="literal">preBuild</code>   </h5>  </div> </div></div><p>Hook executed at the start of the build phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-postBuild" class="title" ><code class="literal">postBuild</code>   </h5>  </div> </div></div><p>Hook executed at the end of the build phase.</p><p>You can set flags for <code class="literal">make</code> through the <code class="literal">makeFlags</code> variable.</p><p>Before and after running <code class="literal">make</code>, the hooks <code class="literal">preBuild</code> and <code class="literal">postBuild</code> are called, respectively.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-check-phase" class="title" >The check phase   </h3>  </div> </div></div><p>The check phase checks whether the package was built correctly by running its test suite. The default <code class="literal">checkPhase</code> calls <code class="literal">make $checkTarget</code>, but only if the <a class="link" href="index.html#var-stdenv-doCheck" title="doCheck" ><code class="literal">doCheck</code> variable</a> is enabled.</p><p>It is highly recommended, for packages’ sources that are not distributed with any tests, to at least use <a class="link" href="index.html#versioncheckhook" title="versionCheckHook" ><code class="literal">versionCheckHook</code></a> to test that the resulting executable is basically functional.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="variables-controlling-the-check-phase" class="title" >Variables controlling the check phase   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-doCheck" class="title" ><code class="literal">doCheck</code>   </h5>  </div> </div></div><p>Controls whether the check phase is executed. By default it is skipped, but if <code class="literal">doCheck</code> is set to true, the check phase is usually executed. Thus you should set</p><pre><code class="programlisting nix">{ doCheck = true; }
</code></pre><p>in the derivation to enable checks. The exception is cross compilation. Cross compiled builds never run tests, no matter how <code class="literal">doCheck</code> is set, as the newly-built program won’t run on the platform used to build it.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="makeflags-makeflagsarray-makefile" class="title" ><code class="literal">makeFlags</code> / <code class="literal">makeFlagsArray</code> / <code class="literal">makefile</code>   </h5>  </div> </div></div><p>See the <a class="link" href="index.html#var-stdenv-makeFlags" title="makeFlags" >build phase</a> for details.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-checkTarget" class="title" ><code class="literal">checkTarget</code>   </h5>  </div> </div></div><p>The <code class="literal">make</code> target that runs the tests.
If unset, use <code class="literal">check</code> if it exists, otherwise <code class="literal">test</code>; if neither is found, do nothing.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-checkFlags" class="title" ><code class="literal">checkFlags</code> / <code class="literal">checkFlagsArray</code>   </h5>  </div> </div></div><p>A list of strings passed as additional flags to <code class="literal">make</code>. Like <code class="literal">makeFlags</code> and <code class="literal">makeFlagsArray</code>, but only used by the check phase. Unlike with <code class="literal">buildFlags</code>, the <code class="literal">checkTarget</code> is automatically added to the <code class="literal">make</code> invocation in addition to any <code class="literal">checkFlags</code> specified.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-checkInputs" class="title" ><code class="literal">checkInputs</code>   </h5>  </div> </div></div><p>A list of host dependencies used by the phase, usually libraries linked into executables built during tests. This gets included in <code class="literal">buildInputs</code> when <code class="literal">doCheck</code> is set.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-nativeCheckInputs" class="title" ><code class="literal">nativeCheckInputs</code>   </h5>  </div> </div></div><p>A list of native dependencies used by the phase, notably tools needed on <code class="literal">$PATH</code>. This gets included in <code class="literal">nativeBuildInputs</code> when <code class="literal">doCheck</code> is set.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preCheck" class="title" ><code class="literal">preCheck</code>   </h5>  </div> </div></div><p>Hook executed at the start of the check phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-postCheck" class="title" ><code class="literal">postCheck</code>   </h5>  </div> </div></div><p>Hook executed at the end of the check phase.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-install-phase" class="title" >The install phase   </h3>  </div> </div></div><p>The install phase is responsible for installing the package in the Nix store under <code class="literal">out</code>. The default <code class="literal">installPhase</code> creates the directory <code class="literal">$out</code> and calls <code class="literal">make install</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="variables-controlling-the-install-phase" class="title" >Variables controlling the install phase   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontInstall" class="title" ><code class="literal">dontInstall</code>   </h5>  </div> </div></div><p>Set to true to skip the install phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="makeflags-makeflagsarray-makefile-1" class="title" ><code class="literal">makeFlags</code> / <code class="literal">makeFlagsArray</code> / <code class="literal">makefile</code>   </h5>  </div> </div></div><p>See the <a class="link" href="index.html#var-stdenv-makeFlags" title="makeFlags" >build phase</a> for details.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-installTargets" class="title" ><code class="literal">installTargets</code>   </h5>  </div> </div></div><p>The make targets that perform the installation. Defaults to <code class="literal">install</code>. Example:</p><pre><code class="programlisting nix">{ installTargets = &quot;install-bin install-doc&quot;; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-installFlags" class="title" ><code class="literal">installFlags</code> / <code class="literal">installFlagsArray</code>   </h5>  </div> </div></div><p>A list of strings passed as additional flags to <code class="literal">make</code>. Like <code class="literal">makeFlags</code> and <code class="literal">makeFlagsArray</code>, but only used by the install phase. Unlike with <code class="literal">buildFlags</code>, the <code class="literal">installTargets</code> are automatically added to the <code class="literal">make</code> invocation in addition to any <code class="literal">installFlags</code> specified.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preInstall" class="title" ><code class="literal">preInstall</code>   </h5>  </div> </div></div><p>Hook executed at the start of the install phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-postInstall" class="title" ><code class="literal">postInstall</code>   </h5>  </div> </div></div><p>Hook executed at the end of the install phase.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-fixup-phase" class="title" >The fixup phase   </h3>  </div> </div></div><p>The fixup phase performs (Nix-specific) post-processing actions on the files installed under <code class="literal">$out</code> by the install phase. The default <code class="literal">fixupPhase</code> does the following:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>It moves the <code class="literal">man/</code>, <code class="literal">doc/</code> and <code class="literal">info/</code> subdirectories of <code class="literal">$out</code> to <code class="literal">share/</code>.</p></li><li class="listitem"><p>It strips libraries and executables of debug information.</p></li><li class="listitem"><p>On Linux, it applies the <code class="literal">patchelf</code> command to ELF executables and libraries to remove unused directories from the <code class="literal">RPATH</code> in order to prevent unnecessary runtime dependencies.</p></li><li class="listitem"><p>It rewrites the interpreter paths of shell scripts to paths found in <code class="literal">PATH</code>. E.g., <code class="literal">/usr/bin/perl</code> will be rewritten to <code class="literal">/nix/store/some-perl/bin/perl</code> found in <code class="literal">PATH</code>. See <a class="xref" href="index.html#patch-shebangs.sh" title="patch-shebangs.sh" >the section called “<code class="literal">patch-shebangs.sh</code>”</a> for details.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="variables-controlling-the-fixup-phase" class="title" >Variables controlling the fixup phase   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontFixup" class="title" ><code class="literal">dontFixup</code>   </h5>  </div> </div></div><p>Set to true to skip the fixup phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontStrip" class="title" ><code class="literal">dontStrip</code>   </h5>  </div> </div></div><p>If set, libraries and executables are not stripped. By default, they are.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontStripHost" class="title" ><code class="literal">dontStripHost</code>   </h5>  </div> </div></div><p>Like <code class="literal">dontStrip</code>, but only affects the <code class="literal">strip</code> command targeting the package’s host platform. Useful when supporting cross compilation, but otherwise feel free to ignore.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontStripTarget" class="title" ><code class="literal">dontStripTarget</code>   </h5>  </div> </div></div><p>Like <code class="literal">dontStrip</code>, but only affects the <code class="literal">strip</code> command targeting the packages’ target platform. Useful when supporting cross compilation, but otherwise feel free to ignore.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontMoveSbin" class="title" ><code class="literal">dontMoveSbin</code>   </h5>  </div> </div></div><p>If set, files in <code class="literal">$out/sbin</code> are not moved to <code class="literal">$out/bin</code>. By default, they are.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-stripAllList" class="title" ><code class="literal">stripAllList</code>   </h5>  </div> </div></div><p>List of directories to search for libraries and executables from which <span class="emphasis"><em>all</em></span> symbols should be stripped. By default, it’s empty. Stripping all symbols is risky, since it may remove not just debug symbols but also ELF information necessary for normal execution.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-stripAllListTarget" class="title" ><code class="literal">stripAllListTarget</code>   </h5>  </div> </div></div><p>Like <code class="literal">stripAllList</code>, but only applies to packages’ target platform. By default, it’s empty. Useful when supporting cross compilation.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-stripAllFlags" class="title" ><code class="literal">stripAllFlags</code>   </h5>  </div> </div></div><p>Flags passed to the <code class="literal">strip</code> command applied to the files in the directories listed in <code class="literal">stripAllList</code>. Defaults to <code class="literal">-s -p</code> (i.e. <code class="literal">--strip-all --preserve-dates</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-stripDebugList" class="title" ><code class="literal">stripDebugList</code>   </h5>  </div> </div></div><p>List of directories to search for libraries and executables from which only debugging-related symbols should be stripped. It defaults to <code class="literal">lib lib32 lib64 libexec bin sbin</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-stripDebugListTarget" class="title" ><code class="literal">stripDebugListTarget</code>   </h5>  </div> </div></div><p>Like <code class="literal">stripDebugList</code>, but only applies to packages’ target platform. By default, it’s empty. Useful when supporting cross compilation.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-stripDebugFlags" class="title" ><code class="literal">stripDebugFlags</code>   </h5>  </div> </div></div><p>Flags passed to the <code class="literal">strip</code> command applied to the files in the directories listed in <code class="literal">stripDebugList</code>. Defaults to <code class="literal">-S -p</code> (i.e. <code class="literal">--strip-debug --preserve-dates</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-stripExclude" class="title" ><code class="literal">stripExclude</code>   </h5>  </div> </div></div><p>A list of filenames or path patterns to avoid stripping. A file is excluded if its name <span class="emphasis"><em>or</em></span> path (from the derivation root) matches.</p><p>This example prevents all <code class="literal">*.rlib</code> files from being stripped:</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  # ...
  stripExclude = [ &quot;*.rlib&quot; ];
}
</code></pre><p>This example prevents files within certain paths from being stripped:</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  # ...
  stripExclude = [ &quot;lib/modules/*/build/*&quot; ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontPatchELF" class="title" ><code class="literal">dontPatchELF</code>   </h5>  </div> </div></div><p>If set, the <code class="literal">patchelf</code> command is not used to remove unnecessary <code class="literal">RPATH</code> entries. Only applies to Linux.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontPatchShebangs" class="title" ><code class="literal">dontPatchShebangs</code>   </h5>  </div> </div></div><p>If set, scripts starting with <code class="literal">#!</code> do not have their interpreter paths rewritten to paths in the Nix store. See <a class="xref" href="index.html#patch-shebangs.sh" title="patch-shebangs.sh" >the section called “<code class="literal">patch-shebangs.sh</code>”</a> on how patching shebangs works.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontPruneLibtoolFiles" class="title" ><code class="literal">dontPruneLibtoolFiles</code>   </h5>  </div> </div></div><p>If set, libtool <code class="literal">.la</code> files associated with shared libraries won’t have their <code class="literal">dependency_libs</code> field cleared.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-forceShare" class="title" ><code class="literal">forceShare</code>   </h5>  </div> </div></div><p>The list of directories that must be moved from <code class="literal">$out</code> to <code class="literal">$out/share</code>. Defaults to <code class="literal">man doc info</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-setupHook" class="title" ><code class="literal">setupHook</code>   </h5>  </div> </div></div><p>A package can export a <a class="link" href="index.html#ssec-setup-hooks" title="Package setup hooks" >setup hook</a> by setting this variable. The setup hook, if defined, is copied to <code class="literal">$out/nix-support/setup-hook</code>. Environment variables are then substituted in it using <code class="literal">substituteAll</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preFixup" class="title" ><code class="literal">preFixup</code>   </h5>  </div> </div></div><p>Hook executed at the start of the fixup phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-postFixup" class="title" ><code class="literal">postFixup</code>   </h5>  </div> </div></div><p>Hook executed at the end of the fixup phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="stdenv-separateDebugInfo" class="title" ><code class="literal">separateDebugInfo</code>   </h5>  </div> </div></div><p>If set to <code class="literal">true</code>, the standard environment will enable debug information in C/C++ builds. After installation, the debug information will be separated from the executables and stored in the output named <code class="literal">debug</code>. (This output is enabled automatically; you don’t need to set the <code class="literal">outputs</code> attribute explicitly.) To be precise, the debug information is stored in <code class="literal">debug/lib/debug/.build-id/XX/YYYY…</code>, where &lt;XXYYYY…&gt; is the &lt;build ID&gt; of the binary — a SHA-1 hash of the contents of the binary. Debuggers like GDB use the build ID to look up the separated debug information.</p><div class="example"><span id="ex-gdb-debug-symbols-socat" ></span><details><summary><span class="title"><strong>Example 276. Enable debug symbols for use with GDB</strong></span></summary><div class="example-contents"><p>To make GDB find debug information for the <code class="literal">socat</code> package and its dependencies, you can use the following <code class="literal">shell.nix</code>:</p><pre><code class="programlisting nix">let
  pkgs = import ./. {
    config = { };
    overlays = [
      (final: prev: {
        ncurses = prev.ncurses.overrideAttrs { separateDebugInfo = true; };
        readline = prev.readline.overrideAttrs { separateDebugInfo = true; };
      })
    ];
  };

  myDebugInfoDirs = pkgs.symlinkJoin {
    name = &quot;myDebugInfoDirs&quot;;
    paths = with pkgs; [
      glibc.debug
      ncurses.debug
      openssl.debug
      readline.debug
    ];
  };
in
pkgs.mkShell {

  NIX_DEBUG_INFO_DIRS = &quot;${pkgs.lib.getLib myDebugInfoDirs}/lib/debug&quot;;

  packages = [
    pkgs.gdb
    pkgs.socat
  ];

  shellHook = &#x27;&#x27;
    ${pkgs.lib.getBin pkgs.gdb}/bin/gdb ${pkgs.lib.getBin pkgs.socat}/bin/socat
  &#x27;&#x27;;
}
</code></pre><p>This setup works as follows:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Add <a class="link" href="index.html#chap-overlays" title="Overlays" ><code class="literal">overlays</code></a> to the package set, since debug symbols are disabled for <code class="literal">ncurses</code> and <code class="literal">readline</code> by default.</p></li><li class="listitem"><p>Create a derivation to combine all required debug symbols under one path with <a class="link" href="index.html#trivial-builder-symlinkJoin" title="symlinkJoin" ><code class="literal">symlinkJoin</code></a>.</p></li><li class="listitem"><p>Set the environment variable <code class="literal">NIX_DEBUG_INFO_DIRS</code> in the shell. Nixpkgs patches <code class="literal">gdb</code> to use it for looking up debug symbols.</p></li><li class="listitem"><p>Run <code class="literal">gdb</code> on the <code class="literal">socat</code> binary on shell startup in the <a class="link" href="index.html#sec-pkgs-mkShell" title="pkgs.mkShell" ><code class="literal">shellHook</code></a>. Here we use <a class="link" href="index.html#function-library-lib.attrsets.getBin" title="lib.attrsets.getBin" ><code class="literal">lib.getBin</code></a> to ensure that the correct derivation output is selected rather than the default one.</p></li></ul></div></div></details></div><br class="example-break" />
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-installCheck-phase" class="title" >The installCheck phase   </h3>  </div> </div></div><p>The installCheck phase checks whether the package was installed correctly by running its test suite against the installed directories. The default <code class="literal">installCheck</code> calls <code class="literal">make installcheck</code>.</p><p>It is often better to add tests that are not part of the source distribution to <code class="literal">passthru.tests</code> (see
<a class="xref" href="index.html#var-passthru-tests" title="passthru.tests" >the section called “<code class="literal">passthru.tests</code>”</a>). This avoids adding overhead to every build and enables us to run them independently.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="variables-controlling-the-installcheck-phase" class="title" >Variables controlling the installCheck phase   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-doInstallCheck" class="title" ><code class="literal">doInstallCheck</code>   </h5>  </div> </div></div><p>Controls whether the installCheck phase is executed. By default it is skipped, but if <code class="literal">doInstallCheck</code> is set to true, the installCheck phase is usually executed. Thus you should set</p><pre><code class="programlisting nix">{ doInstallCheck = true; }
</code></pre><p>in the derivation to enable install checks. The exception is cross compilation. Cross compiled builds never run tests, no matter how <code class="literal">doInstallCheck</code> is set, as the newly-built program won’t run on the platform used to build it.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-installCheckTarget" class="title" ><code class="literal">installCheckTarget</code>   </h5>  </div> </div></div><p>The make target that runs the install tests. Defaults to <code class="literal">installcheck</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-installCheckFlags" class="title" ><code class="literal">installCheckFlags</code> / <code class="literal">installCheckFlagsArray</code>   </h5>  </div> </div></div><p>A list of strings passed as additional flags to <code class="literal">make</code>. Like <code class="literal">makeFlags</code> and <code class="literal">makeFlagsArray</code>, but only used by the installCheck phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-installCheckInputs" class="title" ><code class="literal">installCheckInputs</code>   </h5>  </div> </div></div><p>A list of host dependencies used by the phase, usually libraries linked into executables built during tests. This gets included in <code class="literal">buildInputs</code> when <code class="literal">doInstallCheck</code> is set.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-nativeInstallCheckInputs" class="title" ><code class="literal">nativeInstallCheckInputs</code>   </h5>  </div> </div></div><p>A list of native dependencies used by the phase, notably tools needed on <code class="literal">$PATH</code>. This gets included in <code class="literal">nativeBuildInputs</code> when <code class="literal">doInstallCheck</code> is set.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preInstallCheck" class="title" ><code class="literal">preInstallCheck</code>   </h5>  </div> </div></div><p>Hook executed at the start of the installCheck phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-postInstallCheck" class="title" ><code class="literal">postInstallCheck</code>   </h5>  </div> </div></div><p>Hook executed at the end of the installCheck phase.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-distribution-phase" class="title" >The distribution phase   </h3>  </div> </div></div><p>The distribution phase is intended to produce a source distribution of the package. The default <code class="literal">distPhase</code> first calls <code class="literal">make dist</code>, then it copies the resulting source tarballs to <code class="literal">$out/tarballs/</code>. This phase is only executed if the attribute <code class="literal">doDist</code> is set.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="variables-controlling-the-distribution-phase" class="title" >Variables controlling the distribution phase   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-doDist" class="title" ><code class="literal">doDist</code>   </h5>  </div> </div></div><p>If set, the distribution phase is executed.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-distTarget" class="title" ><code class="literal">distTarget</code>   </h5>  </div> </div></div><p>The make target that produces the distribution. Defaults to <code class="literal">dist</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-distFlags" class="title" ><code class="literal">distFlags</code> / <code class="literal">distFlagsArray</code>   </h5>  </div> </div></div><p>Additional flags passed to <code class="literal">make</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-tarballs" class="title" ><code class="literal">tarballs</code>   </h5>  </div> </div></div><p>The names of the source distribution files to be copied to <code class="literal">$out/tarballs/</code>. It can contain shell wildcards. The default is <code class="literal">*.tar.gz</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-dontCopyDist" class="title" ><code class="literal">dontCopyDist</code>   </h5>  </div> </div></div><p>If set, no files are copied to <code class="literal">$out/tarballs/</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-preDist" class="title" ><code class="literal">preDist</code>   </h5>  </div> </div></div><p>Hook executed at the start of the distribution phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="var-stdenv-postDist" class="title" ><code class="literal">postDist</code>   </h5>  </div> </div></div><p>Hook executed at the end of the distribution phase.</p>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ssec-stdenv-functions" class="title" style="clear: both">Shell functions and utilities   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#fun-makeWrapper"><code class="literal">makeWrapper</code> &lt;executable&gt; &lt;wrapperfile&gt; &lt;args&gt;</a> </span></dt><dt> <span class="section">  <a href="index.html#fun-remove-references-to"><code class="literal">remove-references-to -t</code> &lt;storepath&gt; [ <code class="literal">-t</code> &lt;storepath&gt; … ] &lt;file&gt; …</a> </span></dt><dt> <span class="section">  <a href="index.html#fun-runHook"><code class="literal">runHook</code> &lt;hook&gt;</a> </span></dt><dt> <span class="section">  <a href="index.html#fun-substitute"><code class="literal">substitute</code> &lt;infile&gt; &lt;outfile&gt; &lt;subs&gt;</a> </span></dt><dt> <span class="section">  <a href="index.html#fun-substituteInPlace"><code class="literal">substituteInPlace</code> &lt;multiple files&gt; &lt;subs&gt;</a> </span></dt><dt> <span class="section">  <a href="index.html#fun-substituteAll"><code class="literal">substituteAll</code> &lt;infile&gt; &lt;outfile&gt;</a> </span></dt><dt> <span class="section">  <a href="index.html#fun-substituteAllInPlace"><code class="literal">substituteAllInPlace</code> &lt;file&gt;</a> </span></dt><dt> <span class="section">  <a href="index.html#fun-stripHash"><code class="literal">stripHash</code> &lt;path&gt;</a> </span></dt><dt> <span class="section">  <a href="index.html#fun-wrapProgram"><code class="literal">wrapProgram</code> &lt;executable&gt; &lt;makeWrapperArgs&gt;</a> </span></dt><dt> <span class="section">  <a href="index.html#fun-prependToVar"><code class="literal">prependToVar</code> &lt;variableName&gt; &lt;elements…&gt;</a> </span></dt><dt> <span class="section">  <a href="index.html#fun-appendToVar"><code class="literal">appendToVar</code> &lt;variableName&gt; &lt;elements…&gt;</a> </span></dt> </dl></div><p>The standard environment provides a number of useful functions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fun-makeWrapper" class="title" ><code class="literal">makeWrapper</code> &lt;executable&gt; &lt;wrapperfile&gt; &lt;args&gt;   </h3>  </div> </div></div><p>Constructs a wrapper for a program with various possible arguments. It is defined as part of 2 setup-hooks named <code class="literal">makeWrapper</code> and <code class="literal">makeBinaryWrapper</code> that implement the same bash functions. Hence, to use it you have to add <code class="literal">makeWrapper</code> to your <code class="literal">nativeBuildInputs</code>. Here’s an example usage:</p><pre><code class="programlisting bash"># adds `FOOBAR=baz` to `$out/bin/foo`’s environment
makeWrapper $out/bin/foo $wrapperfile --set FOOBAR baz

# Prefixes the binary paths of `hello` and `git`
# and suffixes the binary path of `xdg-utils`.
# Be advised that paths often should be patched in directly
# (via string replacements or in `configurePhase`).
makeWrapper $out/bin/foo $wrapperfile \
  --prefix PATH : ${lib.makeBinPath [ hello git ]} \
  --suffix PATH : ${lib.makeBinPath [ xdg-utils ]}
</code></pre><p>Packages may expect or require other utilities to be available at runtime.
<code class="literal">makeWrapper</code> can be used to add packages to a <code class="literal">PATH</code> environment variable local to a wrapper.</p><p>Use <code class="literal">--prefix</code> to explicitly set dependencies in <code class="literal">PATH</code>.</p><div class="note"><h3 class="title">Note</h3><p><code class="literal">--prefix</code> essentially hard-codes dependencies into the wrapper.
They cannot be overridden without rebuilding the package.</p></div><p>If dependencies should be resolved at runtime, use <code class="literal">--suffix</code> to append fallback values to <code class="literal">PATH</code>.</p><p>There’s many more kinds of arguments, they are documented in <code class="literal">nixpkgs/pkgs/build-support/setup-hooks/make-wrapper.sh</code> for the <code class="literal">makeWrapper</code> implementation and in <code class="literal">nixpkgs/pkgs/by-name/ma/makeBinaryWrapper/make-binary-wrapper.sh</code> for the <code class="literal">makeBinaryWrapper</code> implementation.</p><p><code class="literal">wrapProgram</code> is a convenience function you probably want to use most of the time, implemented by both <code class="literal">makeWrapper</code> and <code class="literal">makeBinaryWrapper</code>.</p><p>Using the <code class="literal">makeBinaryWrapper</code> implementation is usually preferred, as it creates a tiny <span class="emphasis"><em>compiled</em></span> wrapper executable, that can be used as a shebang interpreter. This is needed mostly on Darwin, where shebangs cannot point to scripts, <a class="link" href="https://stackoverflow.com/questions/67100831/macos-shebang-with-absolute-path-not-working"  target="_top">due to a limitation with the <code class="literal">execve</code>-syscall</a>. Compiled wrappers generated by <code class="literal">makeBinaryWrapper</code> can be inspected with <code class="literal">less &lt;path-to-wrapper&gt;</code> - by scrolling past the binary data you should be able to see the shell command that generated the executable and there see the environment variables that were injected into the wrapper.</p><p>However, <code class="literal">makeWrapper</code> is more flexible and implements more arguments.
Use <code class="literal">makeWrapper</code> if you need the wrapper to use shell features (e.g. look up environment variables) at runtime.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fun-remove-references-to" class="title" ><code class="literal">remove-references-to -t</code> &lt;storepath&gt; [ <code class="literal">-t</code> &lt;storepath&gt; … ] &lt;file&gt; …   </h3>  </div> </div></div><p>Removes the references of the specified files to the specified store files. This is done without changing the size of the file by replacing the hash by <code class="literal">eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee</code>, and should work on compiled executables. This is meant to be used to remove the dependency of the output on inputs that are known to be unnecessary at runtime. Of course, reckless usage will break the patched programs.
To use this, add <code class="literal">removeReferencesTo</code> to <code class="literal">nativeBuildInputs</code>.</p><p>As <code class="literal">remove-references-to</code> is an actual executable and not a shell function, it can be used with <code class="literal">find</code>.
Example removing all references to the compiler in the output:</p><pre><code class="programlisting nix">{
  postInstall = &#x27;&#x27;
    find &quot;$out&quot; -type f -exec remove-references-to -t ${stdenv.cc} &#x27;{}&#x27; +
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fun-runHook" class="title" ><code class="literal">runHook</code> &lt;hook&gt;   </h3>  </div> </div></div><p>Execute &lt;hook&gt; and the values in the array associated with it. The array’s name is determined by removing <code class="literal">Hook</code> from the end of &lt;hook&gt; and appending <code class="literal">Hooks</code>.</p><p>For example, <code class="literal">runHook postHook</code> would run the hook <code class="literal">postHook</code> and all of the values contained in the <code class="literal">postHooks</code> array, if it exists.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fun-substitute" class="title" ><code class="literal">substitute</code> &lt;infile&gt; &lt;outfile&gt; &lt;subs&gt;   </h3>  </div> </div></div><p>Performs string substitution on the contents of &lt;infile&gt;, writing the result to &lt;outfile&gt;. The substitutions in &lt;subs&gt; are of the following form:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="fun-substitute-replace-fail" class="title" ><code class="literal">--replace-fail</code> &lt;s1&gt; &lt;s2&gt;   </h4>  </div> </div></div><p>Replace every occurrence of the string &lt;s1&gt; by &lt;s2&gt;.
Will error if no change is made.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="fun-substitute-replace-warn" class="title" ><code class="literal">--replace-warn</code> &lt;s1&gt; &lt;s2&gt;   </h4>  </div> </div></div><p>Replace every occurrence of the string &lt;s1&gt; by &lt;s2&gt;.
Will print a warning if no change is made.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="fun-substitute-replace-quiet" class="title" ><code class="literal">--replace-quiet</code> &lt;s1&gt; &lt;s2&gt;   </h4>  </div> </div></div><p>Replace every occurrence of the string &lt;s1&gt; by &lt;s2&gt;.
Will do nothing if no change can be made.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="fun-substitute-subst-var" class="title" ><code class="literal">--subst-var</code> &lt;varName&gt;   </h4>  </div> </div></div><p>Replace every occurrence of <code class="literal">@varName@</code> by the contents of the environment variable &lt;varName&gt;. This is useful for generating files from templates, using <code class="literal">@...@</code> in the template as placeholders.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="fun-substitute-subst-var-by" class="title" ><code class="literal">--subst-var-by</code> &lt;varName&gt; &lt;s&gt;   </h4>  </div> </div></div><p>Replace every occurrence of <code class="literal">@varName@</code> by the string &lt;s&gt;.</p><p>Example:</p><pre><code class="programlisting shell">substitute ./foo.in ./foo.out \
    --replace-fail /usr/bin/bar $bar/bin/bar \
    --replace-fail &quot;a string containing spaces&quot; &quot;some other text&quot; \
    --subst-var someVar
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fun-substituteInPlace" class="title" ><code class="literal">substituteInPlace</code> &lt;multiple files&gt; &lt;subs&gt;   </h3>  </div> </div></div><p>Like <code class="literal">substitute</code>, but performs the substitutions in place on the files passed.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fun-substituteAll" class="title" ><code class="literal">substituteAll</code> &lt;infile&gt; &lt;outfile&gt;   </h3>  </div> </div></div><p>Replaces every occurrence of <code class="literal">@varName@</code>, where &lt;varName&gt; is any environment variable, in &lt;infile&gt;, writing the result to &lt;outfile&gt;. For instance, if &lt;infile&gt; has the contents</p><pre><code class="programlisting bash">#! @bash@/bin/sh
PATH=@coreutils@/bin
echo @foo@
</code></pre><p>and the environment contains <code class="literal">bash=/nix/store/bmwp0q28cf21...-bash-3.2-p39</code> and <code class="literal">coreutils=/nix/store/68afga4khv0w...-coreutils-6.12</code>, but does not contain the variable <code class="literal">foo</code>, then the output will be</p><pre><code class="programlisting bash">#! /nix/store/bmwp0q28cf21...-bash-3.2-p39/bin/sh
PATH=/nix/store/68afga4khv0w...-coreutils-6.12/bin
echo @foo@
</code></pre><p>That is, no substitution is performed for undefined variables.</p><p>Environment variables that start with an uppercase letter or an underscore are filtered out, to prevent global variables (like <code class="literal">HOME</code>) or private variables (like <code class="literal">__ETC_PROFILE_DONE</code>) from accidentally getting substituted. The variables also have to be valid bash “names”, as defined in the bash manpage (alphanumeric or <code class="literal">_</code>, must not start with a number).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fun-substituteAllInPlace" class="title" ><code class="literal">substituteAllInPlace</code> &lt;file&gt;   </h3>  </div> </div></div><p>Like <code class="literal">substituteAll</code>, but performs the substitutions in place on the file &lt;file&gt;.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fun-stripHash" class="title" ><code class="literal">stripHash</code> &lt;path&gt;   </h3>  </div> </div></div><p>Strips the directory and hash part of a store path, outputting the name part to <code class="literal">stdout</code>. For example:</p><pre><code class="programlisting bash"># prints coreutils-8.24
stripHash &quot;/nix/store/9s9r019176g7cvn2nvcw41gsp862y6b4-coreutils-8.24&quot;
</code></pre><p>If you wish to store the result in another variable, then the following idiom may be useful:</p><pre><code class="programlisting bash">name=&quot;/nix/store/9s9r019176g7cvn2nvcw41gsp862y6b4-coreutils-8.24&quot;
someVar=$(stripHash $name)
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fun-wrapProgram" class="title" ><code class="literal">wrapProgram</code> &lt;executable&gt; &lt;makeWrapperArgs&gt;   </h3>  </div> </div></div><p>Convenience function for <code class="literal">makeWrapper</code> that replaces <code class="literal">&lt;executable&gt;</code> with a wrapper that executes the original program. It takes all the same arguments as <code class="literal">makeWrapper</code>, except for <code class="literal">--inherit-argv0</code> (used by the <code class="literal">makeBinaryWrapper</code> implementation) and <code class="literal">--argv0</code> (used by both <code class="literal">makeWrapper</code> and <code class="literal">makeBinaryWrapper</code> wrapper implementations).</p><p>If you will apply it multiple times, it will overwrite the wrapper file and you will end up with double wrapping, which should be avoided.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fun-prependToVar" class="title" ><code class="literal">prependToVar</code> &lt;variableName&gt; &lt;elements…&gt;   </h3>  </div> </div></div><p>Prepend elements to a variable.</p><p>Example:</p><pre><code class="programlisting shellSession">$ configureFlags=&quot;--disable-static&quot;
$ prependToVar configureFlags --disable-dependency-tracking --enable-foo
$ echo $configureFlags
--disable-dependency-tracking --enable-foo --disable-static
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fun-appendToVar" class="title" ><code class="literal">appendToVar</code> &lt;variableName&gt; &lt;elements…&gt;   </h3>  </div> </div></div><p>Append elements to a variable.</p><p>Example:</p><pre><code class="programlisting shellSession">$ configureFlags=&quot;--disable-static&quot;
$ appendToVar configureFlags --disable-dependency-tracking --enable-foo
$ echo $configureFlags
--disable-static --disable-dependency-tracking --enable-foo
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ssec-setup-hooks" class="title" style="clear: both">Package setup hooks   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#move-docs.sh"><code class="literal">move-docs.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#compress-man-pages.sh"><code class="literal">compress-man-pages.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#strip.sh"><code class="literal">strip.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#patch-shebangs.sh"><code class="literal">patch-shebangs.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#audit-tmpdir.sh"><code class="literal">audit-tmpdir.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#multiple-outputs.sh"><code class="literal">multiple-outputs.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#move-sbin.sh"><code class="literal">move-sbin.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#move-lib64.sh"><code class="literal">move-lib64.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#move-systemd-user-units.sh"><code class="literal">move-systemd-user-units.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#no-broken-symlinks.sh"><code class="literal">no-broken-symlinks.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#set-source-date-epoch-to-latest.sh"><code class="literal">set-source-date-epoch-to-latest.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#add-bin-to-path.sh"><code class="literal">add-bin-to-path.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#writable-tmpdir-as-home.sh"><code class="literal">writable-tmpdir-as-home.sh</code></a> </span></dt><dt> <span class="section">  <a href="index.html#bintools-wrapper">Bintools Wrapper and hook</a> </span></dt><dt> <span class="section">  <a href="index.html#cc-wrapper">CC Wrapper and hook</a> </span></dt><dt> <span class="section">  <a href="index.html#stdenv-other-hooks">Other hooks</a> </span></dt><dt> <span class="section">  <a href="index.html#compiler-linker-wrapper-hooks">Compiler and Linker wrapper hooks</a> </span></dt> </dl></div><p>Nix itself considers a build-time dependency as merely something that should previously be built and accessible at build time—packages themselves are on their own to perform any additional setup. In most cases, that is fine, and the downstream derivation can deal with its own dependencies. But for a few common tasks, that would result in almost every package doing the same sort of setup work—depending not on the package itself, but entirely on which dependencies were used.</p><p>In order to alleviate this burden, the setup hook mechanism was written, where any package can include a shell script that [by convention rather than enforcement by Nix], any downstream reverse-dependency will source as part of its build process. That allows the downstream dependency to merely specify its dependencies, and lets those dependencies effectively initialize themselves. No boilerplate mirroring the list of dependencies is needed.</p><p>The setup hook mechanism is a bit of a sledgehammer though: a powerful feature with a broad and indiscriminate area of effect. The combination of its power and implicit use may be expedient, but isn’t without costs. Nix itself is unchanged, but the spirit of added dependencies being effect-free is violated even if the latter isn’t. For example, if a derivation path is mentioned more than once, Nix itself doesn’t care and makes sure the dependency derivation is already built just the same—depending is just needing something to exist, and needing is idempotent. However, a dependency specified twice will have its setup hook run twice, and that could easily change the build environment (though a well-written setup hook will therefore strive to be idempotent so this is in fact not observable). More broadly, setup hooks are anti-modular in that multiple dependencies, whether the same or different, should not interfere and yet their setup hooks may well do so.</p><p>The most typical use of the setup hook is actually to add other hooks which are then run (i.e. after all the setup hooks) on each dependency. For example, the C compiler wrapper’s setup hook feeds itself flags for each dependency that contains relevant libraries and headers. This is done by defining a bash function, and appending its name to one of <code class="literal">envBuildBuildHooks</code>, <code class="literal">envBuildHostHooks</code>, <code class="literal">envBuildTargetHooks</code>, <code class="literal">envHostHostHooks</code>, <code class="literal">envHostTargetHooks</code>, or <code class="literal">envTargetTargetHooks</code>. These 6 bash variables correspond to the 6 sorts of dependencies by platform (there’s 12 total but we ignore the propagated/non-propagated axis).</p><p>Packages adding a hook should not hard code a specific hook, but rather choose a variable <span class="emphasis"><em>relative</em></span> to how they are included. Returning to the C compiler wrapper example, if the wrapper itself is an <code class="literal">n</code> dependency, then it only wants to accumulate flags from <code class="literal">n + 1</code> dependencies, as only those ones match the compiler’s target platform. The <code class="literal">hostOffset</code> variable is defined with the current dependency’s host offset <code class="literal">targetOffset</code> with its target offset, before its setup hook is sourced. Additionally, since most environment hooks don’t care about the target platform, that means the setup hook can append to the right bash array by doing something like</p><pre><code class="programlisting bash">addEnvHooks &quot;$hostOffset&quot; myBashFunction
</code></pre><p>The <span class="emphasis"><em>existence</em></span> of setups hooks has long been documented and packages inside Nixpkgs are free to use this mechanism. Other packages, however, should not rely on these mechanisms not changing between Nixpkgs versions. Because of the existing issues with this system, there’s little benefit from mandating it be stable for any period of time.</p><p>First, let’s cover some setup hooks that are part of Nixpkgs default <code class="literal">stdenv</code>. This means that they are run for every package built using <code class="literal">stdenv.mkDerivation</code>, even with custom builders. Some of these are platform specific, so they may run on Linux but not Darwin or vice-versa.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="move-docs.sh" class="title" ><code class="literal">move-docs.sh</code>   </h3>  </div> </div></div><p>This setup hook moves any installed documentation to the <code class="literal">/share</code> subdirectory directory. This includes the man, doc and info directories. This is needed for legacy programs that do not know how to use the <code class="literal">share</code> subdirectory.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="compress-man-pages.sh" class="title" ><code class="literal">compress-man-pages.sh</code>   </h3>  </div> </div></div><p>This setup hook compresses any man pages that have been installed. The compression is done using the gzip program. This helps to reduce the installed size of packages.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="strip.sh" class="title" ><code class="literal">strip.sh</code>   </h3>  </div> </div></div><p>This runs the strip command on installed binaries and libraries. This removes unnecessary information like debug symbols when they are not needed. This also helps to reduce the installed size of packages.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="patch-shebangs.sh" class="title" ><code class="literal">patch-shebangs.sh</code>   </h3>  </div> </div></div><p>This setup hook patches installed scripts to add Nix store paths to their shebang interpreter as found in the build environment. The <a class="link" href="https://en.wikipedia.org/wiki/Shebang_(Unix)"  target="_top">shebang</a> line tells a Unix-like operating system which interpreter to use to execute the script’s contents.</p><div class="note"><h3 class="title">Note</h3><p>The <a class="link" href="https://github.com/NixOS/nixpkgs/blob/19d4f7dc485f74109bd66ef74231285ff797a823/pkgs/stdenv/generic/builder.sh"  target="_top">generic builder</a> populates <code class="literal">PATH</code> from inputs of the derivation.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="patch-shebangs.sh-invocation" class="title" >Invocation   </h4>  </div> </div></div><p>Multiple paths can be specified.</p><pre><code class="programlisting">patchShebangs [--build | --host] PATH...
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="patch-shebangs.sh-invocation-flags" class="title" >Flags   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">--build</code></span></dt><dd><p>Look up commands available at build time</p></dd><dt><span class="term"><code class="literal">--host</code></span></dt><dd><p>Look up commands available at run time</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="patch-shebangs.sh-invocation-examples" class="title" >Examples   </h5>  </div> </div></div><pre><code class="programlisting sh">patchShebangs --host /nix/store/&lt;hash&gt;-hello-1.0/bin
</code></pre><pre><code class="programlisting sh">patchShebangs --build configure
</code></pre><p><code class="literal">#!/bin/sh</code> will be rewritten to <code class="literal">#!/nix/store/&lt;hash&gt;-some-bash/bin/sh</code>.</p><p><code class="literal">#!/usr/bin/env</code> gets special treatment: <code class="literal">#!/usr/bin/env python</code> is rewritten to <code class="literal">/nix/store/&lt;hash&gt;/bin/python</code>.</p><p>Interpreter paths that point to a valid Nix store location are not changed.</p><div class="note"><h3 class="title">Note</h3><p>A script file must be marked as executable, otherwise it will not be
considered.</p></div><p>This mechanism ensures that the interpreter for a given script is always found and is exactly the one specified by the build.</p><p>It can be disabled by setting <a class="link" href="index.html#var-stdenv-dontPatchShebangs" title="dontPatchShebangs" ><code class="literal">dontPatchShebangs</code></a>:</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  # ...
  dontPatchShebangs = true;
  # ...
}
</code></pre><p>The file <a class="link" href="https://github.com/NixOS/nixpkgs/blob/19d4f7dc485f74109bd66ef74231285ff797a823/pkgs/build-support/setup-hooks/patch-shebangs.sh"  target="_top"><code class="literal">patch-shebangs.sh</code></a> defines the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/19d4f7dc485f74109bd66ef74231285ff797a823/pkgs/build-support/setup-hooks/patch-shebangs.sh#L24-L105"  target="_top"><code class="literal">patchShebangs</code></a> function. It is used to implement <a class="link" href="https://github.com/NixOS/nixpkgs/blob/19d4f7dc485f74109bd66ef74231285ff797a823/pkgs/build-support/setup-hooks/patch-shebangs.sh#L107-L119"  target="_top"><code class="literal">patchShebangsAuto</code></a>, the <a class="link" href="index.html#ssec-setup-hooks" title="Package setup hooks" >setup hook</a> that is registered to run during the <a class="link" href="index.html#ssec-fixup-phase" title="The fixup phase" >fixup phase</a> by default.</p><p>If you need to run <code class="literal">patchShebangs</code> at build time, it must be called explicitly within <a class="link" href="index.html#sec-stdenv-phases" title="Phases" >one of the build phases</a>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="audit-tmpdir.sh" class="title" ><code class="literal">audit-tmpdir.sh</code>   </h3>  </div> </div></div><p>This verifies that no references are left from the install binaries to the directory used to build those binaries. This ensures that the binaries do not need things outside the Nix store. This is currently supported in Linux only.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="multiple-outputs.sh" class="title" ><code class="literal">multiple-outputs.sh</code>   </h3>  </div> </div></div><p>This setup hook adds configure flags that tell packages to install files into any one of the proper outputs listed in <code class="literal">outputs</code>. This behavior can be turned off by setting <code class="literal">setOutputFlags</code> to false in the derivation environment. See <a class="xref" href="index.html#chap-multiple-output" title="Multiple-output packages" ><em>Multiple-output packages</em></a> for more information.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="move-sbin.sh" class="title" ><code class="literal">move-sbin.sh</code>   </h3>  </div> </div></div><p>This setup hook moves any binaries installed in the <code class="literal">sbin/</code> subdirectory into <code class="literal">bin/</code>. In addition, a link is provided from <code class="literal">sbin/</code> to <code class="literal">bin/</code> for compatibility.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="move-lib64.sh" class="title" ><code class="literal">move-lib64.sh</code>   </h3>  </div> </div></div><p>This setup hook moves any libraries installed in the <code class="literal">lib64/</code> subdirectory into <code class="literal">lib/</code>. In addition, a link is provided from <code class="literal">lib64/</code> to <code class="literal">lib/</code> for compatibility.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="move-systemd-user-units.sh" class="title" ><code class="literal">move-systemd-user-units.sh</code>   </h3>  </div> </div></div><p>This setup hook moves any systemd user units installed in the <code class="literal">lib/</code> subdirectory into <code class="literal">share/</code>. In addition, a link is provided from <code class="literal">share/</code> to <code class="literal">lib/</code> for compatibility. This is needed for systemd to find user services when installed into the user profile.</p><p>This hook only runs when compiling for Linux.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="no-broken-symlinks.sh" class="title" ><code class="literal">no-broken-symlinks.sh</code>   </h3>  </div> </div></div><p>This setup hook checks for, reports, and (by default) fails builds when “broken” symlinks are found. A symlink is considered “broken” if it’s dangling (the target doesn’t exist) or reflexive (it refers to itself).</p><p>This hook can be disabled by setting <code class="literal">dontCheckForBrokenSymlinks</code>.</p><div class="note"><h3 class="title">Note</h3><p>The hook only considers symlinks with targets inside the Nix store or $TMPDIR directory (typically /nix/store and /build in the builder environment, the later being where build is executed).</p></div><div class="note"><h3 class="title">Note</h3><p>The check for reflexivity is direct and does not account for transitivity, so this hook will not prevent cycles in symlinks.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="set-source-date-epoch-to-latest.sh" class="title" ><code class="literal">set-source-date-epoch-to-latest.sh</code>   </h3>  </div> </div></div><p>This sets <code class="literal">SOURCE_DATE_EPOCH</code> to the modification time of the most recent file.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="add-bin-to-path.sh" class="title" ><code class="literal">add-bin-to-path.sh</code>   </h3>  </div> </div></div><p>This setup hook checks if the <code class="literal">bin/</code> directory exists in the <code class="literal">$out</code> output path
and, if so, adds it to the <code class="literal">PATH</code> environment variable. This ensures that
executables located in <code class="literal">$out/bin</code> are accessible.</p><p>This hook is particularly useful during testing, as it allows packages to locate their executables without requiring manual modifications to the <code class="literal">PATH</code>.</p><p><span class="strong"><strong>Note</strong></span>: This hook is specifically designed for the <code class="literal">$out/bin</code> directory only
and does not handle and support other paths like <code class="literal">$sourceRoot/bin</code>. It may not
work as intended in cases with multiple outputs or when binaries are located in
directories like <code class="literal">sbin/</code>. These caveats should be considered when using this
hook, as they might introduce unexpected behavior in some specific cases.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="writable-tmpdir-as-home.sh" class="title" ><code class="literal">writable-tmpdir-as-home.sh</code>   </h3>  </div> </div></div><p>This setup hook ensures that the directory specified by the <code class="literal">HOME</code> environment
variable is writable. If it is not, the hook assigns <code class="literal">HOME</code> to a writable
directory (in <code class="literal">.home</code> in <code class="literal">$NIX_BUILD_TOP</code>). This adjustment is necessary for
certain packages that require write access to a home directory.</p><p>By setting <code class="literal">HOME</code> to a writable directory, this setup hook prevents failures in
packages that attempt to write to the home directory.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="bintools-wrapper" class="title" >Bintools Wrapper and hook   </h3>  </div> </div></div><p>The Bintools Wrapper wraps the binary utilities for a bunch of miscellaneous purposes. These are GNU Binutils when targeting Linux, and a mix of cctools and GNU binutils for Darwin. [The “Bintools” name is supposed to be a compromise between “Binutils” and “cctools” not denoting any specific implementation.] Specifically, the underlying bintools package, and a C standard library (glibc or Darwin’s libSystem, just for the dynamic loader) are all fed in, and dependency finding, hardening (see below), and purity checks for each are handled by the Bintools Wrapper. Packages typically depend on CC Wrapper, which in turn (at run time) depends on the Bintools Wrapper.</p><p>The Bintools Wrapper was only just recently split off from CC Wrapper, so the division of labor is still being worked out. For example, it shouldn’t care about the C standard library, but just take a derivation with the dynamic loader (which happens to be the glibc on linux). Dependency finding however is a task both wrappers will continue to need to share, and probably the most important to understand. It is currently accomplished by collecting directories of host-platform dependencies (i.e. <code class="literal">buildInputs</code> and <code class="literal">nativeBuildInputs</code>) in environment variables. The Bintools Wrapper’s setup hook causes any <code class="literal">lib</code> and <code class="literal">lib64</code> subdirectories to be added to <code class="literal">NIX_LDFLAGS</code>. Since the CC Wrapper and the Bintools Wrapper use the same strategy, most of the Bintools Wrapper code is sparsely commented and refers to the CC Wrapper. But the CC Wrapper’s code, by contrast, has quite lengthy comments. The Bintools Wrapper merely cites those, rather than repeating them, to avoid falling out of sync.</p><p>A final task of the setup hook is defining a number of standard environment variables to tell build systems which executables fulfill which purpose. They are defined to just be the base name of the tools, under the assumption that the Bintools Wrapper’s binaries will be on the path. Firstly, this helps poorly-written packages, e.g. ones that look for just <code class="literal">gcc</code> when <code class="literal">CC</code> isn’t defined yet <code class="literal">clang</code> is to be used. Secondly, this helps packages not get confused when cross-compiling, in which case multiple Bintools Wrappers may simultaneously be in use. <a href="index.html#footnote-stdenv-per-platform-wrapper" class="footnote" id="footnote-stdenv-per-platform-wrapper.__back.0"><sup class="footnote">[6]</sup></a> <code class="literal">BUILD_</code>- and <code class="literal">TARGET_</code>-prefixed versions of the normal environment variable are defined for additional Bintools Wrappers, properly disambiguating them.</p><p>A problem with this final task is that the Bintools Wrapper is honest and defines <code class="literal">LD</code> as <code class="literal">ld</code>. Most packages, however, firstly use the C compiler for linking, secondly use <code class="literal">LD</code> anyways, defining it as the C compiler, and thirdly, only so define <code class="literal">LD</code> when it is undefined as a fallback. This triple-threat means Bintools Wrapper will break those packages, as LD is already defined as the actual linker which the package won’t override yet doesn’t want to use. The workaround is to define, just for the problematic package, <code class="literal">LD</code> as the C compiler. A good way to do this would be <code class="literal">preConfigure = &quot;LD=$CC&quot;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="cc-wrapper" class="title" >CC Wrapper and hook   </h3>  </div> </div></div><p>The CC Wrapper wraps a C toolchain for a bunch of miscellaneous purposes. Specifically, a C compiler (GCC or Clang), wrapped binary tools, and a C standard library (glibc or Darwin’s libSystem, just for the dynamic loader) are all fed in, and dependency finding, hardening (see below), and purity checks for each are handled by the CC Wrapper. Packages typically depend on the CC Wrapper, which in turn (at run-time) depends on the Bintools Wrapper.</p><p>Dependency finding is undoubtedly the main task of the CC Wrapper. This works just like the Bintools Wrapper, except that any <code class="literal">include</code> subdirectory of any relevant dependency is added to <code class="literal">NIX_CFLAGS_COMPILE</code>. The setup hook itself contains elaborate comments describing the exact mechanism by which this is accomplished.</p><p>Similarly, the CC Wrapper follows the Bintools Wrapper in defining standard environment variables with the names of the tools it wraps, for the same reasons described above. Importantly, while it includes a <code class="literal">cc</code> symlink to the c compiler for portability, the <code class="literal">CC</code> will be defined using the compiler’s “real name” (i.e. <code class="literal">gcc</code> or <code class="literal">clang</code>). This helps lousy build systems that inspect on the name of the compiler rather than run it.</p><p>Here are some more packages that provide a setup hook. Since the list of hooks is extensible, this is not an exhaustive list. The mechanism is only to be used as a last resort, so it might cover most uses.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="stdenv-other-hooks" class="title" >Other hooks   </h3>  </div> </div></div><p>Many other packages provide hooks, that are not part of <code class="literal">stdenv</code>. You can find
these in the <a class="link" href="index.html#chap-hooks" title="Hooks reference" >Hooks Reference</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="compiler-linker-wrapper-hooks" class="title" >Compiler and Linker wrapper hooks   </h3>  </div> </div></div><p>If the file <code class="literal">${cc}/nix-support/cc-wrapper-hook</code> exists, it will be run at the end of the <a class="link" href="index.html#cc-wrapper" title="CC Wrapper and hook" >compiler wrapper</a>.
If the file <code class="literal">${binutils}/nix-support/ld-wrapper-hook</code> exists, it will be run at the end of the linker wrapper, before the linker runs.
If the file <code class="literal">${binutils}/nix-support/post-link-hook</code> exists, it will be run at the end of the linker wrapper.
These hooks allow a user to inject code into the wrappers.
As an example, these hooks can be used to extract <code class="literal">extraBefore</code>, <code class="literal">params</code> and <code class="literal">extraAfter</code> which store all the command line arguments passed to the compiler and linker respectively.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-purity-in-nixpkgs" class="title" style="clear: both">Purity in Nixpkgs   </h2>  </div> </div></div><p><span class="emphasis"><em>Measures taken to prevent dependencies on packages outside the store, and what you can do to prevent them.</em></span></p><p>GCC doesn’t search in locations such as <code class="literal">/usr/include</code>. In fact, attempts to add such directories through the <code class="literal">-I</code> flag are filtered out. Likewise, the linker (from GNU binutils) doesn’t search in standard locations such as <code class="literal">/usr/lib</code>. Programs built on Linux are linked against a GNU C Library that likewise doesn’t search in the default system locations.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-hardening-in-nixpkgs" class="title" style="clear: both">Hardening in Nixpkgs   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-hardening-flags-enabled-by-default">Hardening flags enabled by default</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-hardening-flags-disabled-by-default">Hardening flags disabled by default</a> </span></dt> </dl></div><p>There are flags available to harden packages at compile or link-time. These can be toggled using the <code class="literal">stdenv.mkDerivation</code> parameters <code class="literal">hardeningDisable</code> and <code class="literal">hardeningEnable</code>.</p><p>Both parameters take a list of flags as strings. The special <code class="literal">&quot;all&quot;</code> flag can be passed to <code class="literal">hardeningDisable</code> to turn off all hardening. These flags can also be used as environment variables for testing or development purposes.</p><p>For more in-depth information on these hardening flags and hardening in general, refer to the <a class="link" href="https://wiki.debian.org/Hardening"  target="_top">Debian Wiki</a>, <a class="link" href="https://wiki.ubuntu.com/Security/Features"  target="_top">Ubuntu Wiki</a>, <a class="link" href="https://wiki.gentoo.org/wiki/Project:Hardened"  target="_top">Gentoo Wiki</a>, and the <a class="link" href="https://wiki.archlinux.org/title/Security"  target="_top">Arch Wiki</a>.</p><p>Note that support for some hardening flags varies by compiler, CPU architecture, target OS and libc. Combinations of these that don’t support a particular hardening flag will silently ignore attempts to enable it. To see exactly which hardening flags are being employed in any invocation, the <code class="literal">NIX_DEBUG</code> environment variable can be used.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-hardening-flags-enabled-by-default" class="title" >Hardening flags enabled by default   </h3>  </div> </div></div><p>The following flags are enabled by default and might require disabling with <code class="literal">hardeningDisable</code> if the program to package is incompatible.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="format" class="title" ><code class="literal">format</code>   </h4>  </div> </div></div><p>Adds the <code class="literal">-Wformat -Wformat-security -Werror=format-security</code> compiler options. At present, this warns about calls to <code class="literal">printf</code> and <code class="literal">scanf</code> functions where the format string is not a string literal and there are no format arguments, as in <code class="literal">printf(foo);</code>. This may be a security hole if the format string came from untrusted input and contains <code class="literal">%n</code>.</p><p>This needs to be turned off or fixed for errors similar to:</p><pre><code class="programlisting">/tmp/nix-build-zynaddsubfx-2.5.2.drv-0/zynaddsubfx-2.5.2/src/UI/guimain.cpp:571:28: error: format not a string literal and no format arguments [-Werror=format-security]
         printf(help_message);
                            ^
cc1plus: some warnings being treated as errors
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="stackprotector" class="title" ><code class="literal">stackprotector</code>   </h4>  </div> </div></div><p>Adds the <code class="literal">-fstack-protector-strong --param ssp-buffer-size=4</code> compiler options. This adds safety checks against stack overwrites rendering many potential code injection attacks into aborting situations. In the best case this turns code injection vulnerabilities into denial of service or into non-issues (depending on the application).</p><p>This needs to be turned off or fixed for errors similar to:</p><pre><code class="programlisting">bin/blib.a(bios_console.o): In function `bios_handle_cup&#x27;:
/tmp/nix-build-ipxe-20141124-5cbdc41.drv-0/ipxe-5cbdc41/src/arch/i386/firmware/pcbios/bios_console.c:86: undefined reference to `__stack_chk_fail&#x27;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="fortify" class="title" ><code class="literal">fortify</code>   </h4>  </div> </div></div><p>Adds the <code class="literal">-O2 -D_FORTIFY_SOURCE=2</code> compiler options. During code generation the compiler knows a great deal of information about buffer sizes (where possible), and attempts to replace insecure unlimited length buffer function calls with length-limited ones. This is especially useful for old, crufty code. Additionally, format strings in writable memory that contain <code class="literal">%n</code> are blocked. If an application depends on such a format string, it will need to be worked around.</p><p>Additionally, some warnings are enabled which might trigger build failures if compiler warnings are treated as errors in the package build. In this case, set <code class="literal">env.NIX_CFLAGS_COMPILE</code> to <code class="literal">-Wno-error=warning-type</code>.</p><p>This needs to be turned off or fixed for errors similar to:</p><pre><code class="programlisting">malloc.c:404:15: error: return type is an incomplete type
malloc.c:410:19: error: storage size of &#x27;ms&#x27; isn&#x27;t known

strdup.h:22:1: error: expected identifier or &#x27;(&#x27; before &#x27;__extension__&#x27;

strsep.c:65:23: error: register name not specified for &#x27;delim&#x27;

installwatch.c:3751:5: error: conflicting types for &#x27;__open_2&#x27;

fcntl2.h:50:4: error: call to &#x27;__open_missing_mode&#x27; declared with attribute error: open with O_CREAT or O_TMPFILE in second argument needs 3 arguments
</code></pre><p>Disabling <code class="literal">fortify</code> implies disablement of <code class="literal">fortify3</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="fortify3" class="title" ><code class="literal">fortify3</code>   </h4>  </div> </div></div><p>Adds the <code class="literal">-O2 -D_FORTIFY_SOURCE=3</code> compiler options. This expands the cases that can be protected by fortify-checks to include some situations with dynamic-length buffers whose length can be inferred at runtime using compiler hints.</p><p>Enabling this flag implies enablement of <code class="literal">fortify</code>. Disabling this flag does not imply disablement of <code class="literal">fortify</code>.</p><p>This flag can sometimes conflict with a build-system’s own attempts at enabling fortify support and result in errors complaining about <code class="literal">redefinition of _FORTIFY_SOURCE</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="pic" class="title" ><code class="literal">pic</code>   </h4>  </div> </div></div><p>Adds the <code class="literal">-fPIC</code> compiler options. This options adds support for position independent code in shared libraries and thus making ASLR possible.</p><p>Most notably, the Linux kernel, kernel modules and other code not running in an operating system environment like boot loaders won’t build with PIC enabled. The compiler will is most cases complain that PIC is not supported for a specific build.</p><p>This needs to be turned off or fixed for assembler errors similar to:</p><pre><code class="programlisting">ccbLfRgg.s: Assembler messages:
ccbLfRgg.s:33: Error: missing or invalid displacement expression `private_key_len@GOTOFF&#x27;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="strictoverflow" class="title" ><code class="literal">strictoverflow</code>   </h4>  </div> </div></div><p>Signed integer overflow is undefined behaviour according to the C standard. If it happens, it is an error in the program as it should check for overflow before it can happen, not afterwards. GCC provides built-in functions to perform arithmetic with overflow checking, which are correct and faster than any custom implementation. As a workaround, the option <code class="literal">-fno-strict-overflow</code> makes gcc behave as if signed integer overflows were defined.</p><p>This flag should not trigger any build or runtime errors.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="relro" class="title" ><code class="literal">relro</code>   </h4>  </div> </div></div><p>Adds the <code class="literal">-z relro</code> linker option. During program load, several ELF memory sections need to be written to by the linker, but can be turned read-only before turning over control to the program. This prevents some GOT (and .dtors) overwrite attacks, but at least the part of the GOT used by the dynamic linker (.got.plt) is still vulnerable.</p><p>This flag can break dynamic shared object loading. For instance, the module systems of Xorg and OpenCV are incompatible with this flag. In almost all cases the <code class="literal">bindnow</code> flag must also be disabled and incompatible programs typically fail with similar errors at runtime.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="bindnow" class="title" ><code class="literal">bindnow</code>   </h4>  </div> </div></div><p>Adds the <code class="literal">-z now</code> linker option. During program load, all dynamic symbols are resolved, allowing for the complete GOT to be marked read-only (due to <code class="literal">relro</code>). This prevents GOT overwrite attacks. For very large applications, this can incur some performance loss during initial load while symbols are resolved, but this shouldn’t be an issue for daemons.</p><p>This flag can break dynamic shared object loading. For instance, the module systems of Xorg and PHP are incompatible with this flag. Programs incompatible with this flag often fail at runtime due to missing symbols, like:</p><pre><code class="programlisting">intel_drv.so: undefined symbol: vgaHWFreeHWRec
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="zerocallusedregs" class="title" ><code class="literal">zerocallusedregs</code>   </h4>  </div> </div></div><p>Adds the <code class="literal">-fzero-call-used-regs=used-gpr</code> compiler option. This causes the general-purpose registers that an architecture’s calling convention considers “call-used” to be zeroed on return from the function. This can make it harder for attackers to construct useful ROP gadgets and also reduces the chance of data leakage from a function call.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="stackclashprotection" class="title" ><code class="literal">stackclashprotection</code>   </h4>  </div> </div></div><p>This flag adds the <code class="literal">-fstack-clash-protection</code> compiler option, which causes growth of a program’s stack to access each successive page in order. This should force the guard page to be accessed and cause an attempt to “jump over” this guard page to crash.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-hardening-flags-disabled-by-default" class="title" >Hardening flags disabled by default   </h3>  </div> </div></div><p>The following flags are disabled by default and should be enabled with <code class="literal">hardeningEnable</code> for packages that take untrusted input like network services.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="nostrictaliasing" class="title" ><code class="literal">nostrictaliasing</code>   </h4>  </div> </div></div><p>This flag adds the <code class="literal">-fno-strict-aliasing</code> compiler option, which prevents the compiler from assuming code has been written strictly following the standard in regards to pointer aliasing and therefore performing optimizations that may be unsafe for code that has not followed these rules.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="pie" class="title" ><code class="literal">pie</code>   </h4>  </div> </div></div><p>This flag is disabled by default for normal <code class="literal">glibc</code> based NixOS package builds, but enabled by default for</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">musl</code>-based package builds, except on Aarch64 and Aarch32, where there are issues.</p></li><li class="listitem"><p>Statically-linked for OpenBSD builds, where it appears to be required to get a working binary.</p></li></ul></div><p>Adds the <code class="literal">-fPIE</code> compiler and <code class="literal">-pie</code> linker options. Position Independent Executables are needed to take advantage of Address Space Layout Randomization, supported by modern kernel versions. While ASLR can already be enforced for data areas in the stack and heap (brk and mmap), the code areas must be compiled as position-independent. Shared libraries already do this with the <code class="literal">pic</code> flag, so they gain ASLR automatically, but binary .text regions need to be build with <code class="literal">pie</code> to gain ASLR. When this happens, ROP attacks are much harder since there are no static locations to bounce off of during a memory corruption attack.</p><p>Static libraries need to be compiled with <code class="literal">-fPIE</code> so that executables can link them in with the <code class="literal">-pie</code> linker option.
If the libraries lack <code class="literal">-fPIE</code>, you will get the error <code class="literal">recompile with -fPIE</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="strictflexarrays1" class="title" ><code class="literal">strictflexarrays1</code>   </h4>  </div> </div></div><p>This flag adds the <code class="literal">-fstrict-flex-arrays=1</code> compiler option, which reduces the cases the compiler treats as “flexible arrays” to those declared with length <code class="literal">[1]</code>, <code class="literal">[0]</code> or (the correct) <code class="literal">[]</code>. This increases the coverage of fortify checks, because such arrays declared as the trailing element of a structure can normally not have their intended length determined by the compiler.</p><p>Enabling this flag on packages that still use length declarations of flexible arrays &gt;1 may cause the package to fail to compile citing accesses beyond the bounds of an array or even crash at runtime by detecting an array access as an “overrun”. Few projects still use length declarations of flexible arrays &gt;1.</p><p>Disabling <code class="literal">strictflexarrays1</code> implies disablement of <code class="literal">strictflexarrays3</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="strictflexarrays3" class="title" ><code class="literal">strictflexarrays3</code>   </h4>  </div> </div></div><p>This flag adds the <code class="literal">-fstrict-flex-arrays=3</code> compiler option, which reduces the cases the compiler treats as “flexible arrays” to only those declared with length as (the correct) <code class="literal">[]</code>. This increases the coverage of fortify checks, because such arrays declared as the trailing element of a structure can normally not have their intended length determined by the compiler.</p><p>Enabling this flag on packages that still use non-empty length declarations for flexible arrays may cause the package to fail to compile citing accesses beyond the bounds of an array or even crash at runtime by detecting an array access as an “overrun”. Many projects still use such non-empty length declarations for flexible arrays.</p><p>Enabling this flag implies enablement of <code class="literal">strictflexarrays1</code>. Disabling this flag does not imply disablement of <code class="literal">strictflexarrays1</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="shadowstack" class="title" ><code class="literal">shadowstack</code>   </h4>  </div> </div></div><p>Adds the <code class="literal">-fcf-protection=return</code> compiler option. This enables the Shadow Stack feature supported by some newer processors, which maintains a user-inaccessible copy of the program’s stack containing only return-addresses. When returning from a function, the processor compares the return-address value on the two stacks and throws an error if they do not match, considering it a sign of corruption and possible tampering. This should significantly increase the difficulty of ROP attacks.</p><p>For the Shadow Stack to be enabled at runtime, all code linked into a process must be built with Shadow Stack enabled, so this is probably only useful to enable on a wide scale, so that all of a packages dependencies also have the feature enabled.</p><p>This is currently only supported on some newer Intel and AMD processors as part of the Intel CET set of features. However, the generated code should continue to work on older processors which will simply omit any of this checking.</p><p>This breaks some code that does advanced stack management or exception handling. If enabling this hardening flag it is important to test the result on a system that has known working and enabled CET support, so that any such breakage can be discovered.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="trivialautovarinit" class="title" ><code class="literal">trivialautovarinit</code>   </h4>  </div> </div></div><p>Adds the <code class="literal">-ftrivial-auto-var-init=pattern</code> compiler option. Uninitialized variables generally take on their values based on fragments of previous program state, and attackers can carefully manipulate that state to craft malicious initial values for these variables. This flag causes “trivially-initializable” uninitialized stack variables to be forcibly initialized with a nonzero value that is likely to cause a crash (and therefore be noticed).</p><p>Use of this flag is controversial as it can prevent tools that detect uninitialized variable use (such as valgrind) from operating correctly.</p><p>This should be turned off or fixed for build errors such as:</p><pre><code class="programlisting">sorry, unimplemented: __builtin_clear_padding not supported for variable length aggregates
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="pacret" class="title" ><code class="literal">pacret</code>   </h4>  </div> </div></div><p>This flag adds the <code class="literal">-mbranch-protection=pac-ret</code> compiler option on aarch64-linux targets. This uses ARM v8.3’s Pointer Authentication feature to sign function return pointers before adding them to the stack. The pointer’s authenticity is then validated before returning to its destination. This dramatically increases the difficulty of ROP exploitation techniques.</p><p>This may cause problems with code that does advanced stack manipulation, and debugging/stack-unwinding tools need to be pac-ret aware to work correctly when these features are in operation.</p><p>Pre-ARM v8.3 processors will ignore Pointer Authentication instructions, so code built with this flag will continue to work on older processors, though without any of the intended protections. If enabling this flag, it is recommended to ensure the resultant packages are tested against an ARM v8.3+ linux system with known-working Pointer Authentication support so that any breakage caused by this feature is actually detected.</p><div class="footnotes"><br /><hr style="width:100; text-align:left;margin-left: 0" /><div id="footnote-stdenv-ignored-build-platform" class="footnote"><p>The build platform is ignored because it is a mere implementation detail of the package satisfying the dependency: As a general programming principle, dependencies are always <span class="emphasis"><em>specified</em></span> as interfaces, not concrete implementation.<a href="index.html#footnote-stdenv-ignored-build-platform.__back.0" class="para"><sup class="para">[1]</sup></a></p></div><div id="footnote-stdenv-native-dependencies-in-path" class="footnote"><p>Currently, this means for native builds all dependencies are put on the <code class="literal">PATH</code>. But in the future that may not be the case for sake of matching cross: the platforms would be assumed to be unique for native and cross builds alike, so only the <code class="literal">depsBuild*</code> and <code class="literal">nativeBuildInputs</code> would be added to the <code class="literal">PATH</code>.<a href="index.html#footnote-stdenv-native-dependencies-in-path.__back.0" class="para"><sup class="para">[2]</sup></a></p></div><div id="footnote-stdenv-find-inputs-location" class="footnote"><p>The <code class="literal">findInputs</code> function, currently residing in <code class="literal">pkgs/stdenv/generic/setup.sh</code>, implements the propagation logic.<a href="index.html#footnote-stdenv-find-inputs-location.__back.0" class="para"><sup class="para">[3]</sup></a></p></div><div id="footnote-stdenv-sys-lib-search-path" class="footnote"><p>It clears the <code class="literal">sys_lib_*search_path</code> variables in the Libtool script to prevent Libtool from using libraries in <code class="literal">/usr/lib</code> and such.<a href="index.html#footnote-stdenv-sys-lib-search-path.__back.0" class="para"><sup class="para">[4]</sup></a></p></div><div id="footnote-stdenv-build-time-guessing-impurity" class="footnote"><p>Eventually these will be passed building natively as well, to improve determinism: build-time guessing, as is done today, is a risk of impurity.<a href="index.html#footnote-stdenv-build-time-guessing-impurity.__back.0" class="para"><sup class="para">[5]</sup></a></p></div><div id="footnote-stdenv-per-platform-wrapper" class="footnote"><p>Each wrapper targets a single platform, so if binaries for multiple platforms are needed, the underlying binaries must be wrapped multiple times. As this is a property of the wrapper itself, the multiple wrappings are needed whether or not the same underlying binaries can target multiple platforms.<a href="index.html#footnote-stdenv-per-platform-wrapper.__back.0" class="para"><sup class="para">[6]</sup></a></p></div></div>
</div>

</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-meta" class="title" >Meta-attributes   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-standard-meta-attributes">Standard meta-attributes</a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-knownVulnerabilities"><code class="literal">knownVulnerabilities</code></a> </span></dt><dt> <span class="section">  <a href="index.html#sec-meta-license">Licenses</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-meta-sourceProvenance">Source provenance</a> </span></dt> </dl></div><p>Nix packages can declare <span class="emphasis"><em>meta-attributes</em></span> that contain information about a package such as a description, its homepage, its license, and so on. For instance, the GNU Hello package has a <code class="literal">meta</code> declaration like this:</p><pre><code class="programlisting nix">{
  meta = {
    description = &quot;Program that produces a familiar, friendly greeting&quot;;
    longDescription = &#x27;&#x27;
      GNU Hello is a program that prints &quot;Hello, world!&quot; when you run it.
      It is fully customizable.
    &#x27;&#x27;;
    homepage = &quot;https://www.gnu.org/software/hello/manual/&quot;;
    license = lib.licenses.gpl3Plus;
    maintainers = with lib.maintainers; [ eelco ];
    platforms = lib.platforms.all;
  };
}
</code></pre><p>Meta-attributes are not passed to the builder of the package. Thus, a change to a meta-attribute doesn’t trigger a recompilation of the package.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-standard-meta-attributes" class="title" style="clear: both">Standard meta-attributes   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#var-meta-description"><code class="literal">description</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-longDescription"><code class="literal">longDescription</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-branch"><code class="literal">branch</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-homepage"><code class="literal">homepage</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-downloadPage"><code class="literal">downloadPage</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-changelog"><code class="literal">changelog</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-license"><code class="literal">license</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-sourceProvenance"><code class="literal">sourceProvenance</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-maintainers"><code class="literal">maintainers</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-teams"><code class="literal">teams</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-mainProgram"><code class="literal">mainProgram</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-priority"><code class="literal">priority</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-platforms"><code class="literal">platforms</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-badPlatforms"><code class="literal">badPlatforms</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-timeout"><code class="literal">timeout</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-hydraPlatforms"><code class="literal">hydraPlatforms</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-meta-broken"><code class="literal">broken</code></a> </span></dt> </dl></div><p>If the package is to be submitted to Nixpkgs, please check out the
<a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/pkgs#meta-attributes"  target="_top">requirements for meta attributes</a>
in the contributing documentation.</p><p>It is expected that each meta-attribute is one of the following:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-description" class="title" ><code class="literal">description</code>   </h3>  </div> </div></div><p>A short (one-line) description of the package.
This is displayed on <a class="link" href="https://search.nixos.org/packages"  target="_top">search.nixos.org</a>.</p><p>The general requirements of a description are:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Be short, just one sentence.</p></li><li class="listitem"><p>Be capitalized.</p></li><li class="listitem"><p>Not start with definite (“The”) or indefinite (“A”/“An”) article.</p></li><li class="listitem"><p>Not start with the package name.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>More generally, it should not refer to the package name.</p></li></ul></div></li><li class="listitem"><p>Not end with a period (or any punctuation for that matter).</p></li><li class="listitem"><p>Provide factual information.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Avoid subjective language.</p></li></ul></div></li></ul></div><p>Wrong: <code class="literal">&quot;libpng is a library that allows you to decode PNG images.&quot;</code></p><p>Right: <code class="literal">&quot;Library for decoding PNG images&quot;</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-longDescription" class="title" ><code class="literal">longDescription</code>   </h3>  </div> </div></div><p>An arbitrarily long description of the package in <a class="link" href="https://commonmark.org"  target="_top">CommonMark</a> Markdown.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-branch" class="title" ><code class="literal">branch</code>   </h3>  </div> </div></div><p>Release branch. Used to specify that a package is not going to receive updates that are not in this branch; for example, Linux kernel 3.0 is supposed to be updated to 3.0.X, not 3.1.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-homepage" class="title" ><code class="literal">homepage</code>   </h3>  </div> </div></div><p>The package’s homepage. Example: <code class="literal">https://www.gnu.org/software/hello/manual/</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-downloadPage" class="title" ><code class="literal">downloadPage</code>   </h3>  </div> </div></div><p>The page where a link to the current version can be found. Example: <code class="literal">https://ftp.gnu.org/gnu/hello/</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-changelog" class="title" ><code class="literal">changelog</code>   </h3>  </div> </div></div><p>A link or a list of links to the location of Changelog for a package. A link may use expansion to refer to the correct changelog version. Example: <code class="literal">&quot;https://git.savannah.gnu.org/cgit/hello.git/plain/NEWS?h=v${version}&quot;</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-license" class="title" ><code class="literal">license</code>   </h3>  </div> </div></div><p>The license, or licenses, for the package. One from the attribute set defined in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/licenses.nix"  target="_top"><code class="literal">nixpkgs/lib/licenses.nix</code></a>. At this moment using both a list of licenses and a single license is valid. If the license field is in the form of a list representation, then it means that parts of the package are licensed differently. Each license should preferably be referenced by their attribute. The non-list attribute value can also be a space delimited string representation of the contained attribute <code class="literal">shortNames</code> or <code class="literal">spdxIds</code>. The following are all valid examples:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Single license referenced by attribute (preferred) <code class="literal">lib.licenses.gpl3Only</code>.</p></li><li class="listitem"><p>Single license referenced by its attribute shortName (frowned upon) <code class="literal">&quot;gpl3Only&quot;</code>.</p></li><li class="listitem"><p>Single license referenced by its attribute spdxId (frowned upon) <code class="literal">&quot;GPL-3.0-only&quot;</code>.</p></li><li class="listitem"><p>Multiple licenses referenced by attribute (preferred) <code class="literal">with lib.licenses; [ asl20 free ofl ]</code>.</p></li><li class="listitem"><p>Multiple licenses referenced as a space delimited string of attribute shortNames (frowned upon) <code class="literal">&quot;asl20 free ofl&quot;</code>.</p></li></ul></div><p>For details, see <a class="link" href="index.html#sec-meta-license" title="Licenses" >Licenses</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-sourceProvenance" class="title" ><code class="literal">sourceProvenance</code>   </h3>  </div> </div></div><p>A list containing the type or types of source inputs from which the package is built, e.g. original source code, pre-built binaries, etc.</p><p>For details, see <a class="link" href="index.html#sec-meta-sourceProvenance" title="Source provenance" >Source provenance</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-maintainers" class="title" ><code class="literal">maintainers</code>   </h3>  </div> </div></div><p>A list of the maintainers of this Nix expression. Maintainers are defined in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/maintainers/maintainer-list.nix"  target="_top"><code class="literal">nixpkgs/maintainers/maintainer-list.nix</code></a>. There is no restriction to becoming a maintainer, just add yourself to that list in a separate commit titled “maintainers: add alice” in the same pull request, and reference maintainers with <code class="literal">maintainers = with lib.maintainers; [ alice bob ]</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-teams" class="title" ><code class="literal">teams</code>   </h3>  </div> </div></div><p>A list of the teams of this Nix expression. Teams are defined in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/maintainers/team-list.nix"  target="_top"><code class="literal">nixpkgs/maintainers/team-list.nix</code></a>, and can be defined in a package with <code class="literal">meta.teams = with lib.teams; [ team1 team2 ]</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-mainProgram" class="title" ><code class="literal">mainProgram</code>   </h3>  </div> </div></div><p>The name of the main binary for the package. This affects the binary <code class="literal">nix run</code> executes. Example: <code class="literal">&quot;rg&quot;</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-priority" class="title" ><code class="literal">priority</code>   </h3>  </div> </div></div><p>The <span class="emphasis"><em>priority</em></span> of the package, used by <code class="literal">nix-env</code> to resolve file name conflicts between packages. See the <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/nix-env"  target="_top">manual page for <code class="literal">nix-env</code></a> for details. Example: <code class="literal">&quot;10&quot;</code> (a low-priority package).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-platforms" class="title" ><code class="literal">platforms</code>   </h3>  </div> </div></div><p>The list of Nix platform types on which the package is supported. Hydra builds packages according to the platform specified. If no platform is specified, the package does not have prebuilt binaries. An example is:</p><pre><code class="programlisting nix">{ meta.platforms = lib.platforms.linux; }
</code></pre><p>Attribute Set <code class="literal">lib.platforms</code> defines <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/systems/doubles.nix"  target="_top">various common lists</a> of platforms types.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-badPlatforms" class="title" ><code class="literal">badPlatforms</code>   </h3>  </div> </div></div><p>The list of Nix <a class="link" href="https://github.com/NixOS/nixpkgs/blob/b03ac42b0734da3e7be9bf8d94433a5195734b19/lib/meta.nix#L75-L81"  target="_top">platform types</a> on which the package is known not to be buildable.
Hydra will never create prebuilt binaries for these platform types, even if they are in <a class="link" href="index.html#var-meta-platforms" title="platforms" ><code class="literal">meta.platforms</code></a>.
In general it is preferable to set <code class="literal">meta.platforms = lib.platforms.all</code> and then exclude any platforms on which the package is known not to build.
For example, a package which requires dynamic linking and cannot be linked statically could use this:</p><pre><code class="programlisting nix">{
  meta.platforms = lib.platforms.all;
  meta.badPlatforms = [ lib.systems.inspect.platformPatterns.isStatic ];
}
</code></pre><p>The <a class="link" href="https://github.com/NixOS/nixpkgs/blob/b03ac42b0734da3e7be9bf8d94433a5195734b19/lib/meta.nix#L95-L106"  target="_top"><code class="literal">lib.meta.availableOn</code></a> function can be used to test whether or not a package is available (i.e. buildable) on a given platform.
Some packages use this to automatically detect the maximum set of features with which they can be built.
For example, <code class="literal">systemd</code> <a class="link" href="https://github.com/systemd/systemd/issues/20600#issuecomment-912338965"  target="_top">requires dynamic linking</a>, and <a class="link" href="https://github.com/NixOS/nixpkgs/blob/b03ac42b0734da3e7be9bf8d94433a5195734b19/pkgs/os-specific/linux/systemd/default.nix#L752"  target="_top">has a <code class="literal">meta.badPlatforms</code> setting</a> similar to the one above.
Packages which can be built with or without <code class="literal">systemd</code> support will use <code class="literal">lib.meta.availableOn</code> to detect whether or not <code class="literal">systemd</code> is available on the <a class="link" href="index.html#ssec-cross-platform-parameters" title="Platform parameters" ><code class="literal">hostPlatform</code></a> for which they are being built; if it is not available (e.g. due to a statically-linked host platform like <code class="literal">pkgsStatic</code>) this support will be disabled by default.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-timeout" class="title" ><code class="literal">timeout</code>   </h3>  </div> </div></div><p>A timeout (in seconds) for building the derivation. If the derivation takes longer than this time to build, Hydra will fail it due to breaking the timeout. However, all computers do not have the same computing power, hence some builders may decide to apply a multiplicative factor to this value. When filling this value in, try to keep it approximately consistent with other values already present in <code class="literal">nixpkgs</code>.</p><p><code class="literal">meta</code> attributes are not stored in the instantiated derivation.
Therefore, this setting may be lost when the package is used as a dependency.
To be effective, it must be presented directly to an evaluation process that handles the <code class="literal">meta.timeout</code> attribute.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-hydraPlatforms" class="title" ><code class="literal">hydraPlatforms</code>   </h3>  </div> </div></div><p>The list of Nix platform types for which the <a class="link" href="https://github.com/nixos/hydra"  target="_top">Hydra</a> <a class="link" href="https://nixos.org/hydra"  target="_top">instance at <code class="literal">hydra.nixos.org</code></a> will build the package. (Hydra is the Nix-based continuous build system.) It defaults to the value of <code class="literal">meta.platforms</code>. Thus, the only reason to set <code class="literal">meta.hydraPlatforms</code> is if you want <code class="literal">hydra.nixos.org</code> to build the package on a subset of <code class="literal">meta.platforms</code>, or not at all, e.g.</p><pre><code class="programlisting nix">{
  meta.platforms = lib.platforms.linux;
  meta.hydraPlatforms = [ ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-meta-broken" class="title" ><code class="literal">broken</code>   </h3>  </div> </div></div><p>If set to <code class="literal">true</code>, the package is marked as “broken”, meaning that it won’t show up in <a class="link" href="https://search.nixos.org/packages"  target="_top">search.nixos.org</a>, and cannot be built or installed unless the environment variable <a class="link" href="index.html#opt-allowBroken"  ><code class="literal">NIXPKGS_ALLOW_BROKEN</code></a> is set.
Such unconditionally-broken packages should be removed from Nixpkgs eventually unless they are fixed.</p><p>The value of this attribute can depend on a package’s arguments, including <code class="literal">stdenv</code>.
This means that <code class="literal">broken</code> can be used to express constraints, for example:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Does not cross compile</p><pre><code class="programlisting nix">{ meta.broken = !(stdenv.buildPlatform.canExecute stdenv.hostPlatform); }
</code></pre></li><li class="listitem"><p>Broken if all of a certain set of its dependencies are broken</p><pre><code class="programlisting nix">{
  meta.broken = lib.all (
    map (p: p.meta.broken) [
      glibc
      musl
    ]
  );
}
</code></pre></li></ul></div><p>This makes <code class="literal">broken</code> strictly more powerful than <code class="literal">meta.badPlatforms</code>.
However <code class="literal">meta.availableOn</code> currently examines only <code class="literal">meta.platforms</code> and <code class="literal">meta.badPlatforms</code>, so <code class="literal">meta.broken</code> does not influence the default values for optional dependencies.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="var-meta-knownVulnerabilities" class="title" style="clear: both"><code class="literal">knownVulnerabilities</code>   </h2>  </div> </div></div><p>A list of known vulnerabilities affecting the package, usually identified by CVE identifiers.</p><p>This metadata allows users and tools to be aware of unresolved security issues before using the package, for example:</p><pre><code class="programlisting nix">{
  meta.knownVulnerabilities = [
    &quot;CVE-2024-3094: Malicious backdoor allowing unauthorized remote code execution&quot;
  ];
}
</code></pre><p>If this list is not empty, the package is marked as “insecure”, meaning that it cannot be built or installed unless the environment variable <a class="link" href="index.html#sec-allow-insecure" title="Installing insecure packages" ><code class="literal">NIXPKGS_ALLOW_INSECURE</code></a> is set.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-meta-license" class="title" style="clear: both">Licenses   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#lib.licenses.free-free"><code class="literal">lib.licenses.free</code>, <code class="literal">&quot;free&quot;</code></a> </span></dt><dt> <span class="section">  <a href="index.html#lib.licenses.unfreeredistributable-unfree-redistributable"><code class="literal">lib.licenses.unfreeRedistributable</code>, <code class="literal">&quot;unfree-redistributable&quot;</code></a> </span></dt><dt> <span class="section">  <a href="index.html#lib.licenses.unfree-unfree"><code class="literal">lib.licenses.unfree</code>, <code class="literal">&quot;unfree&quot;</code></a> </span></dt><dt> <span class="section">  <a href="index.html#lib.licenses.unfreeredistributablefirmware-unfree-redistributable-firmware"><code class="literal">lib.licenses.unfreeRedistributableFirmware</code>, <code class="literal">&quot;unfree-redistributable-firmware&quot;</code></a> </span></dt> </dl></div><p>The <code class="literal">meta.license</code> attribute should preferably contain a value from <code class="literal">lib.licenses</code> defined in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/licenses.nix"  target="_top"><code class="literal">nixpkgs/lib/licenses.nix</code></a>, or in-place license description of the same format if the license is unlikely to be useful in another expression.</p><p>Although it’s typically better to indicate the specific license, a few generic options are available:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lib.licenses.free-free" class="title" ><code class="literal">lib.licenses.free</code>, <code class="literal">&quot;free&quot;</code>   </h3>  </div> </div></div><p>Catch-all for free software licenses not listed above.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lib.licenses.unfreeredistributable-unfree-redistributable" class="title" ><code class="literal">lib.licenses.unfreeRedistributable</code>, <code class="literal">&quot;unfree-redistributable&quot;</code>   </h3>  </div> </div></div><p>Unfree package that can be redistributed in binary form. That is, it’s legal to redistribute the <span class="emphasis"><em>output</em></span> of the derivation. This means that the package can be included in the Nixpkgs channel.</p><p>Sometimes proprietary software can only be redistributed unmodified. Make sure the builder doesn’t actually modify the original binaries; otherwise we’re breaking the license. For instance, the NVIDIA X11 drivers can be redistributed unmodified, but our builder applies <code class="literal">patchelf</code> to make them work. Thus, its license is <code class="literal">&quot;unfree&quot;</code> and it cannot be included in the Nixpkgs channel.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lib.licenses.unfree-unfree" class="title" ><code class="literal">lib.licenses.unfree</code>, <code class="literal">&quot;unfree&quot;</code>   </h3>  </div> </div></div><p>Unfree package that cannot be redistributed. You can build it yourself, but you cannot redistribute the output of the derivation. Thus it cannot be included in the Nixpkgs channel.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lib.licenses.unfreeredistributablefirmware-unfree-redistributable-firmware" class="title" ><code class="literal">lib.licenses.unfreeRedistributableFirmware</code>, <code class="literal">&quot;unfree-redistributable-firmware&quot;</code>   </h3>  </div> </div></div><p>This package supplies unfree, redistributable firmware. This is a separate value from <code class="literal">unfree-redistributable</code> because not everybody cares whether firmware is free.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-meta-sourceProvenance" class="title" style="clear: both">Source provenance   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#lib.sourceTypes.fromSource"><code class="literal">lib.sourceTypes.fromSource</code></a> </span></dt><dt> <span class="section">  <a href="index.html#lib.sourceTypes.binaryNativeCode"><code class="literal">lib.sourceTypes.binaryNativeCode</code></a> </span></dt><dt> <span class="section">  <a href="index.html#lib.sourceTypes.binaryFirmware"><code class="literal">lib.sourceTypes.binaryFirmware</code></a> </span></dt><dt> <span class="section">  <a href="index.html#lib.sourceTypes.binaryBytecode"><code class="literal">lib.sourceTypes.binaryBytecode</code></a> </span></dt> </dl></div><p>The value of a package’s <code class="literal">meta.sourceProvenance</code> attribute specifies the provenance of the package’s derivation outputs.</p><p>If a package contains elements that are not built from the original source by a nixpkgs derivation, the <code class="literal">meta.sourceProvenance</code> attribute should be a list containing one or more value from <code class="literal">lib.sourceTypes</code> defined in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/source-types.nix"  target="_top"><code class="literal">nixpkgs/lib/source-types.nix</code></a>.</p><p>Adding this information helps users who have needs related to build transparency and supply-chain security to gain some visibility into their installed software or set policy to allow or disallow installation based on source provenance.</p><p>The presence of a particular <code class="literal">sourceType</code> in a package’s <code class="literal">meta.sourceProvenance</code> list indicates that the package contains some components falling into that category, though the <span class="emphasis"><em>absence</em></span> of that <code class="literal">sourceType</code> does not <span class="emphasis"><em>guarantee</em></span> the absence of that category of <code class="literal">sourceType</code> in the package’s contents. A package with no <code class="literal">meta.sourceProvenance</code> set implies it has no <span class="emphasis"><em>known</em></span> <code class="literal">sourceType</code>s other than <code class="literal">fromSource</code>.</p><p>The meaning of the <code class="literal">meta.sourceProvenance</code> attribute does not depend on the value of the <code class="literal">meta.license</code> attribute.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lib.sourceTypes.fromSource" class="title" ><code class="literal">lib.sourceTypes.fromSource</code>   </h3>  </div> </div></div><p>Package elements which are produced by a nixpkgs derivation which builds them from source code.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lib.sourceTypes.binaryNativeCode" class="title" ><code class="literal">lib.sourceTypes.binaryNativeCode</code>   </h3>  </div> </div></div><p>Native code to be executed on the target system’s CPU, built by a third party. This includes packages which wrap a downloaded AppImage or Debian package.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lib.sourceTypes.binaryFirmware" class="title" ><code class="literal">lib.sourceTypes.binaryFirmware</code>   </h3>  </div> </div></div><p>Code to be executed on a peripheral device or embedded controller, built by a third party.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lib.sourceTypes.binaryBytecode" class="title" ><code class="literal">lib.sourceTypes.binaryBytecode</code>   </h3>  </div> </div></div><p>Code to run on a VM interpreter or JIT compiled into bytecode by a third party. This includes packages which download Java <code class="literal">.jar</code> files from another source.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-passthru" class="title" >Passthru-attributes   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-common-passthru-attributes">Common <code class="literal">passthru</code>-attributes</a> </span></dt> </dl></div><p><span id="var-stdenv-passthru"></span> <span id="special-variables"></span> </p><p>As opposed to most other <code class="literal">mkDerivation</code> input attributes, <code class="literal">passthru</code> is not passed to the derivation’s <a class="link" href="https://nixos.org/manual/nix/stable/expressions/derivations.html#attr-builder"  target="_top"><code class="literal">builder</code> executable</a>.
Changing it will not trigger a rebuild – it is “passed through”.
Its value can be accessed as if it was set inside a derivation.</p><div class="note"><h3 class="title">Note</h3><p><code class="literal">passthru</code> attributes follow no particular schema, but there are a few <a class="link" href="index.html#sec-common-passthru-attributes" title="Common passthru-attributes" >conventional patterns</a>.</p></div><div class="example"><span id="ex-accessing-passthru" ></span><details><summary><span class="title"><strong>Example 277. Setting and accessing <code class="literal">passthru</code> attributes</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ stdenv, fetchGit }:
let
  hello = stdenv.mkDerivation {
    pname = &quot;hello&quot;;
    src = fetchGit {
      # ...
    };

    passthru = {
      foo = &quot;bar&quot;;
      baz = {
        value1 = 4;
        value2 = 5;
      };
    };
  };
in
hello.baz.value1
</code></pre><pre><code class="programlisting">4
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-common-passthru-attributes" class="title" style="clear: both">Common <code class="literal">passthru</code>-attributes   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#var-passthru-tests"><code class="literal">passthru.tests</code></a> </span></dt><dt> <span class="section">  <a href="index.html#var-passthru-updateScript"><code class="literal">passthru.updateScript</code></a> </span></dt> </dl></div><p>Many <code class="literal">passthru</code> attributes are situational, so this section only lists recurring patterns.
They fall in one of these categories:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Global conventions, which are applied almost universally in Nixpkgs.</p><p>Generally these don’t entail any special support built into the derivation they belong to.
Common examples of this type are <a class="link" href="index.html#var-passthru-tests" title="passthru.tests" ><code class="literal">passthru.tests</code></a> and <a class="link" href="index.html#var-passthru-updateScript" title="passthru.updateScript" ><code class="literal">passthru.updateScript</code></a>.</p></li><li class="listitem"><p>Conventions for adding extra functionality to a derivation.</p><p>These tend to entail support from the derivation or the <code class="literal">passthru</code> attribute in question.
Common examples of this type are <code class="literal">passthru.optional-dependencies</code>, <code class="literal">passthru.withPlugins</code>, and <code class="literal">passthru.withPackages</code>.
All of those allow associating the package with a set of components built for that specific package, such as when building Python runtime environments using <a class="link" href="index.html#python.withpackages-function" title="python.withPackages function" ><code class="literal">python.withPackages</code></a>.</p></li></ul></div><p>Attributes that apply only to particular <a class="link" href="index.html#part-builders" title="Build helpers" >build helpers</a> or <a class="link" href="index.html#chap-language-support" title="Languages and frameworks" >language ecosystems</a> are documented there.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-passthru-tests" class="title" ><code class="literal">passthru.tests</code>   </h3>  </div> </div></div><p><span id="var-meta-tests"></span> </p><p>An attribute set with tests as values.
A test is a derivation that builds when the test passes and fails to build otherwise.</p><p>Run these tests with:</p><pre><code class="programlisting ShellSession">$ cd path/to/nixpkgs
$ nix-build -A your-package.tests
</code></pre><div class="note"><h3 class="title">Note</h3><p>The Nixpkgs systems for continuous integration <a class="link" href="https://hydra.nixos.org/"  target="_top">Hydra</a> and <a class="link" href="https://github.com/Mic92/nixpkgs-review"  target="_top"><code class="literal">nixpkgs-review</code></a> don’t build these derivations by default, and (<a class="link" href="https://github.com/NixOS/ofborg"  target="_top"><code class="literal">@ofborg</code></a>) only builds them when evaluating pull requests for that particular package, or when manually instructed.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-passthru-tests-packages" class="title" >Package tests   </h4>  </div> </div></div><p><span id="var-meta-tests-packages"></span> </p><p>Besides tests provided by upstream, that you run in the <a class="link" href="index.html#ssec-check-phase" title="The check phase" ><code class="literal">checkPhase</code></a>, you may want to define tests derivations in the <code class="literal">passthru.tests</code> attribute, which won’t change the build. <code class="literal">passthru.tests</code> have several advantages over running tests during any of the <a class="link" href="index.html#sec-stdenv-phases" title="Phases" >standard phases</a>:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>They access the package as consumers would, independently from the environment in which it was built</p></li><li class="listitem"><p>They can be run and debugged without rebuilding the package, which is useful if that takes a long time</p></li><li class="listitem"><p>They don’t add overhead to each build, as opposed checks added to the <a class="link" href="index.html#ssec-installCheck-phase" title="The installCheck phase" ><code class="literal">installCheckPhase</code></a>, such as <a class="link" href="index.html#versioncheckhook" title="versionCheckHook" ><code class="literal">versionCheckHook</code></a>.</p></li></ul></div><p>It is also possible to use <code class="literal">passthru.tests</code> to test the version with <a class="link" href="index.html#tester-testVersion" title="testVersion" ><code class="literal">testVersion</code></a>, but since that is pretty trivial and recommended thing to do, we recommend using <a class="link" href="index.html#versioncheckhook" title="versionCheckHook" ><code class="literal">versionCheckHook</code></a> for that, which has the following advantages over <code class="literal">passthru.tests</code>:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>If the <code class="literal">versionCheckPhase</code> (the phase defined by <a class="link" href="index.html#versioncheckhook" title="versionCheckHook" ><code class="literal">versionCheckHook</code></a>) fails, it triggers a failure which can’t be ignored if you use the package, or if you find out about it in a <a class="link" href="https://github.com/Mic92/nixpkgs-review"  target="_top"><code class="literal">nixpkgs-review</code></a> report.</p></li><li class="listitem"><p>Sometimes packages become silently broken - meaning they fail to launch but their build passes because they don’t perform any tests in the <code class="literal">checkPhase</code>. If you use this tool infrequently, such a silent breakage may rot in your system / profile configuration, and you will not notice the failure until you will want to use this package. Testing such basic functionality ensures you have to deal with the failure when you update your system / profile.</p></li><li class="listitem"><p>When you open a PR, <a class="link" href="https://github.com/NixOS/ofborg"  target="_top">ofborg</a>’s CI <span class="emphasis"><em>will</em></span> run <code class="literal">passthru.tests</code> of <a class="link" href="https://github.com/NixOS/ofborg?tab=readme-ov-file#automatic-building"  target="_top">packages that are directly changed by your PR (according to your commits’ messages)</a>, but if you’d want to use the <a class="link" href="https://github.com/NixOS/ofborg?tab=readme-ov-file#build"  target="_top"><code class="literal">@ofborg build</code></a> command for dependent packages, you won’t have to specify in addition the <code class="literal">.tests</code> attribute of the packages you want to build, and no body will be able to avoid these tests.</p></li></ul></div><p>For more on how to write and run package tests for Nixpkgs, see the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md#package-tests"  target="_top">testing section in the package contributor guide</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-passthru-tests-nixos" class="title" >NixOS tests   </h4>  </div> </div></div><p><span id="var-meta-tests-nixos"></span> </p><p>Tests written for NixOS are available as the <code class="literal">nixosTests</code> argument to package recipes.
For instance, the <a class="link" href="https://search.nixos.org/packages?show=opensmtpd"  target="_top">OpenSMTPD derivation</a> includes lines similar to:</p><pre><code class="programlisting nix">{ nixosTests, ... }:
{
  # ...
  passthru.tests = {
    basic-functionality-and-dovecot-integration = nixosTests.opensmtpd;
  };
}
</code></pre><p>NixOS tests run in a virtual machine (VM), so they are slower than regular package tests.
For more information see the NixOS manual on <a class="link" href="https://nixos.org/manual/nixos/stable/#sec-nixos-tests"  target="_top">NixOS module tests</a>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="var-passthru-updateScript" class="title" ><code class="literal">passthru.updateScript</code>   </h3>  </div> </div></div><p><span id="var-passthru-updateScript-command"></span>
<span id="var-passthru-updateScript-set-command"></span>
<span id="var-passthru-updateScript-set-attrPath"></span>
<span id="var-passthru-updateScript-set-supportedFeatures"></span>
<span id="var-passthru-updateScript-env-UPDATE_NIX_NAME"></span>
<span id="var-passthru-updateScript-env-UPDATE_NIX_PNAME"></span>
<span id="var-passthru-updateScript-env-UPDATE_NIX_OLD_VERSION"></span>
<span id="var-passthru-updateScript-env-UPDATE_NIX_ATTR_PATH"></span>
<span id="var-passthru-updateScript-execution"></span>
<span id="var-passthru-updateScript-supported-features"></span>
<span id="var-passthru-updateScript-commit"></span>
<span id="var-passthru-updateScript-commit-attrPath"></span>
<span id="var-passthru-updateScript-commit-oldVersion"></span>
<span id="var-passthru-updateScript-commit-newVersion"></span>
<span id="var-passthru-updateScript-commit-files"></span>
<span id="var-passthru-updateScript-commit-commitBody"></span>
<span id="var-passthru-updateScript-commit-commitMessage"></span>
<span id="var-passthru-updateScript-example-commit"></span></p><p>Nixpkgs tries to automatically update all packages that have an <code class="literal">passthru.updateScript</code> attribute.
See the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md#automatic-package-updates"  target="_top">section on automatic package updates in the package contributor guide</a> for details.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-multiple-output" class="title" >Multiple-output packages   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-multiple-outputs-using-split-packages">Using a split package</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-multiple-outputs-">Writing a split derivation</a> </span></dt> </dl></div><p>The Nix language allows a derivation to produce multiple outputs, which is similar to what is utilized by other Linux distribution packaging systems. The outputs reside in separate Nix store paths, so they can be mostly handled independently of each other, including passing to build inputs, garbage collection or binary substitution. The exception is that building from source always produces all the outputs.</p><p>The main motivation is to save disk space by reducing runtime closure sizes; consequently also sizes of substituted binaries get reduced. Splitting can be used to have more granular runtime dependencies, for example the typical reduction is to split away development-only files, as those are typically not needed during runtime. As a result, closure sizes of many packages can get reduced to a half or even much less.</p><div class="note"><h3 class="title">Note</h3><p>The reduction effects could be instead achieved by building the parts in completely separate derivations. That would often additionally reduce build-time closures, but it tends to be much harder to write such derivations, as build systems typically assume all parts are being built at once. This compromise approach of single source package producing multiple binary packages is also utilized often by rpm and deb.</p></div><p>A number of attributes can be used to work with a derivation with multiple outputs.
The attribute <code class="literal">outputs</code> is a list of strings, which are the names of the outputs.
For each of these names, an identically named attribute is created, corresponding to that output.</p><p>The attribute <code class="literal">meta.outputsToInstall</code> is used to determine the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/08c3198f1c6fd89a09f8f0ea09b425028a34de3e/pkgs/stdenv/generic/check-meta.nix#L411-L426"  target="_top">default set of outputs to install</a> when using the derivation name unqualified:
<code class="literal">bin</code>, or <code class="literal">out</code>, or the first specified output; as well as <code class="literal">man</code> if that is specified.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-multiple-outputs-using-split-packages" class="title" style="clear: both">Using a split package   </h2>  </div> </div></div><p>In the Nix language the individual outputs can be reached explicitly as attributes, e.g. <code class="literal">coreutils.info</code>, but the typical case is just using packages as build inputs.</p><p>When a multiple-output derivation gets into a build input of another derivation, the <code class="literal">dev</code> output is added if it exists, otherwise the first output is added. In addition to that, <code class="literal">propagatedBuildOutputs</code> of that package which by default contain <code class="literal">$outputBin</code> and <code class="literal">$outputLib</code> are also added. (See <a class="xref" href="index.html#multiple-output-file-type-groups" title="File type groups" >the section called “File type groups”</a>.)</p><p>In some cases it may be desirable to combine different outputs under a single store path. The <code class="literal">symlinkJoin</code> builder can be used to do this. (See <a class="xref" href="index.html#trivial-builder-symlinkJoin" title="symlinkJoin" >the section called “<code class="literal">symlinkJoin</code>”</a>). Note that this may negate some closure size benefits of using a multiple-output package.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-multiple-outputs-" class="title" style="clear: both">Writing a split derivation   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#multiple-output-file-binaries-first-convention">“Binaries first”</a> </span></dt><dt> <span class="section">  <a href="index.html#multiple-output-file-type-groups">File type groups</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-multiple-outputs-caveats">Common caveats</a> </span></dt> </dl></div><p>Here you find how to write a derivation that produces multiple outputs.</p><p>In nixpkgs there is a framework supporting multiple-output derivations. It tries to cover most cases by default behavior. You can find the source separated in <code class="literal">&lt;nixpkgs/pkgs/build-support/setup-hooks/multiple-outputs.sh&gt;</code>; it’s relatively well-readable. The whole machinery is triggered by defining the <code class="literal">outputs</code> attribute to contain the list of desired output names (strings).</p><pre><code class="programlisting nix">{
  outputs = [
    &quot;bin&quot;
    &quot;dev&quot;
    &quot;out&quot;
    &quot;doc&quot;
  ];
}
</code></pre><p>Often such a single line is enough. For each output an equally named environment variable is passed to the builder and contains the path in nix store for that output. Typically you also want to have the main <code class="literal">out</code> output, as it catches any files that didn’t get elsewhere.</p><div class="note"><h3 class="title">Note</h3><p>There is a special handling of the <code class="literal">debug</code> output, described at <a class="xref" href="index.html#stdenv-separateDebugInfo" title="separateDebugInfo" >the section called “<code class="literal">separateDebugInfo</code>”</a>.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="multiple-output-file-binaries-first-convention" class="title" >“Binaries first”   </h3>  </div> </div></div><p>A commonly adopted convention in <code class="literal">nixpkgs</code> is that executables provided by the package are contained within its first output. This convention allows the dependent packages to reference the executables provided by packages in a uniform manner. For instance, provided with the knowledge that the <code class="literal">perl</code> package contains a <code class="literal">perl</code> executable it can be referenced as <code class="literal">${pkgs.perl}/bin/perl</code> within a Nix derivation that needs to execute a Perl script.</p><p>The <code class="literal">glibc</code> package is a deliberate single exception to the “binaries first” convention. The <code class="literal">glibc</code> has <code class="literal">libs</code> as its first output allowing the libraries provided by <code class="literal">glibc</code> to be referenced directly (e.g. <code class="literal">${glibc}/lib/ld-linux-x86-64.so.2</code>). The executables provided by <code class="literal">glibc</code> can be accessed via its <code class="literal">bin</code> attribute (e.g. <code class="literal">${lib.getBin stdenv.cc.libc}/bin/ldd</code>).</p><p>The reason for why <code class="literal">glibc</code> deviates from the convention is because referencing a library provided by <code class="literal">glibc</code> is a very common operation among Nix packages. For instance, third-party executables packaged by Nix are typically patched and relinked with the relevant version of <code class="literal">glibc</code> libraries from Nix packages (please see the documentation on <a class="link" href="https://github.com/NixOS/patchelf"  target="_top">patchelf</a> for more details).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="multiple-output-file-type-groups" class="title" >File type groups   </h3>  </div> </div></div><p>The support code currently recognizes some particular kinds of outputs and either instructs the build system of the package to put files into their desired outputs or it moves the files during the fixup phase. Each group of file types has an <code class="literal">outputFoo</code> variable specifying the output name where they should go. If that variable isn’t defined by the derivation writer, it is guessed – a default output name is defined, falling back to other possibilities if the output isn’t defined.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="outputdev" class="title" ><code class="literal">$outputDev</code>   </h4>  </div> </div></div><p>is for development-only files. These include C(++) headers (<code class="literal">include/</code>), pkg-config (<code class="literal">lib/pkgconfig/</code>), cmake (<code class="literal">lib/cmake/</code>) and aclocal files (<code class="literal">share/aclocal/</code>). They go to <code class="literal">dev</code> or <code class="literal">out</code> by default.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="outputbin" class="title" ><code class="literal">$outputBin</code>   </h4>  </div> </div></div><p>is meant for user-facing binaries, typically residing in <code class="literal">bin/</code>. They go to <code class="literal">bin</code> or <code class="literal">out</code> by default.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="outputlib" class="title" ><code class="literal">$outputLib</code>   </h4>  </div> </div></div><p>is meant for libraries, typically residing in <code class="literal">lib/</code> and <code class="literal">libexec/</code>. They go to <code class="literal">lib</code> or <code class="literal">out</code> by default.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="outputdoc" class="title" ><code class="literal">$outputDoc</code>   </h4>  </div> </div></div><p>is for user documentation, typically residing in <code class="literal">share/doc/</code>. It goes to <code class="literal">doc</code> or <code class="literal">out</code> by default.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="outputdevdoc" class="title" ><code class="literal">$outputDevdoc</code>   </h4>  </div> </div></div><p>is for <span class="emphasis"><em>developer</em></span> documentation. Currently we count gtk-doc and devhelp books, typically residing in <code class="literal">share/gtk-doc/</code> and <code class="literal">share/devhelp/</code>, in there. It goes to <code class="literal">devdoc</code> or is removed (!) by default. This is because e.g. gtk-doc tends to be rather large and completely unused by nixpkgs users.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="outputman" class="title" ><code class="literal">$outputMan</code>   </h4>  </div> </div></div><p>is for man pages (except for section 3), typically residing in <code class="literal">share/man/man[0-9]/</code>. They go to <code class="literal">man</code> or <code class="literal">$outputBin</code> by default.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="outputdevman" class="title" ><code class="literal">$outputDevman</code>   </h4>  </div> </div></div><p>is for section 3 man pages, typically residing in <code class="literal">share/man/man[0-9]/</code>. They go to <code class="literal">devman</code> or <code class="literal">$outputMan</code> by default.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="outputinfo" class="title" ><code class="literal">$outputInfo</code>   </h4>  </div> </div></div><p>is for info pages, typically residing in <code class="literal">share/info/</code>. They go to <code class="literal">info</code> or <code class="literal">$outputBin</code> by default.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-multiple-outputs-caveats" class="title" >Common caveats   </h3>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Some configure scripts don’t like some of the parameters passed by default by the framework, e.g. <code class="literal">--docdir=/foo/bar</code>. You can disable this by setting <code class="literal">setOutputFlags = false;</code>.</p></li><li class="listitem"><p>The outputs of a single derivation can retain references to each other, but note that circular references are not allowed. (And each strongly-connected component would act as a single output anyway.)</p></li><li class="listitem"><p>Most of split packages contain their core functionality in libraries. These libraries tend to refer to various kind of data that typically gets into <code class="literal">out</code>, e.g. locale strings, so there is often no advantage in separating the libraries into <code class="literal">lib</code>, as keeping them in <code class="literal">out</code> is easier.</p></li><li class="listitem"><p>Some packages have hidden assumptions on install paths, which complicates splitting.</p></li></ul></div>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-cross" class="title" >Cross-compilation   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-cross-intro">Introduction</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-cross-packaging">Packaging in a cross-friendly manner</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-cross-usage">Cross-building packages</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-cross-infra">Cross-compilation infrastructure</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-cross-intro" class="title" style="clear: both">Introduction   </h2>  </div> </div></div><p>“Cross-compilation” means compiling a program on one machine for another type of machine. For example, a typical use of cross-compilation is to compile programs for embedded devices. These devices often don’t have the computing power and memory to compile their own programs. One might think that cross-compilation is a fairly niche concern. However, there are significant advantages to rigorously distinguishing between build-time and run-time environments! Significant, because the benefits apply even when one is developing and deploying on the same machine. Nixpkgs is increasingly adopting the opinion that packages should be written with cross-compilation in mind, and Nixpkgs should evaluate in a similar way (by minimizing cross-compilation-specific special cases) whether or not one is cross-compiling.</p><p>This chapter will be organized in three parts. First, it will describe the basics of how to package software in a way that supports cross-compilation. Second, it will describe how to use Nixpkgs when cross-compiling. Third, it will describe the internal infrastructure supporting cross-compilation.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-cross-packaging" class="title" style="clear: both">Packaging in a cross-friendly manner   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-cross-platform-parameters">Platform parameters</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-cross-dependency-categorization">Theory of dependency categorization</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-cross-cookbook">Cross packaging cookbook</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-cross-platform-parameters" class="title" >Platform parameters   </h3>  </div> </div></div><p>Nixpkgs follows the <a class="link" href="https://gcc.gnu.org/onlinedocs/gccint/Configure-Terms.html"  target="_top">conventions of GNU autoconf</a>. We distinguish between 3 types of platforms when building a derivation: <span class="emphasis"><em>build</em></span>, <span class="emphasis"><em>host</em></span>, and <span class="emphasis"><em>target</em></span>. In summary, <span class="emphasis"><em>build</em></span> is the platform on which a package is being built, <span class="emphasis"><em>host</em></span> is the platform on which it will run. The third attribute, <span class="emphasis"><em>target</em></span>, is relevant only for certain specific compilers and build tools.</p><p>In Nixpkgs, these three platforms are defined as attribute sets under the names <code class="literal">buildPlatform</code>, <code class="literal">hostPlatform</code>, and <code class="literal">targetPlatform</code>. They are always defined as attributes in the standard environment. That means one can access them like:</p><pre><code class="programlisting nix">{
  stdenv,
  fooDep,
  barDep,
  ...
}:
{
  # ...stdenv.buildPlatform...
}
</code></pre><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">buildPlatform</code></span></dt><dd><p>The “build platform” is the platform on which a package is built. Once someone has a built package, or pre-built binary package, the build platform should not matter and can be ignored.</p></dd><dt><span class="term"><code class="literal">hostPlatform</code></span></dt><dd><p>The “host platform” is the platform on which a package will be run. This is the simplest platform to understand, but also the one with the worst name.</p></dd><dt><span class="term"><code class="literal">targetPlatform</code></span></dt><dd><p>The “target platform” attribute is, unlike the other two attributes, not actually fundamental to the process of building software. Instead, it is only relevant for compatibility with building certain specific compilers and build tools. It can be safely ignored for all other packages.</p></dd><dd><p>The build process of certain compilers is written in such a way that the compiler resulting from a single build can itself only produce binaries for a single platform. The task of specifying this single “target platform” is thus pushed to build time of the compiler. The root cause of this is that the compiler (which will be run on the host) and the standard library/runtime (which will be run on the target) are built by a single build process.</p></dd><dd><p>There is no fundamental need to think about a single target ahead of time like this. If the tool supports modular or pluggable backends, both the need to specify the target at build time and the constraint of having only a single target disappear. An example of such a tool is LLVM.</p></dd><dd><p>Although the existence of a “target platform” is arguably a historical mistake, it is a common one: examples of tools that suffer from it are GCC, Binutils, GHC and Autoconf. Nixpkgs tries to avoid sharing in the mistake where possible. Still, because the concept of a target platform is so ingrained, it is best to support it as is.</p></dd></dl></div><p>The exact schema these fields follow is a bit ill-defined due to a long and convoluted evolution, but this is slowly being cleaned up. You can see examples of ones used in practice in <code class="literal">lib.systems.examples</code>; note how they are not all very consistent. For now, here are few fields can count on them containing:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">system</code></span></dt><dd><p>This is a two-component shorthand for the platform. Examples of this would be “x86_64-darwin” and “i686-linux”; see <code class="literal">lib.systems.doubles</code> for more. The first component corresponds to the CPU architecture of the platform and the second to the operating system of the platform (<code class="literal">[cpu]-[os]</code>). This format has built-in support in Nix, such as the <code class="literal">builtins.currentSystem</code> impure string.</p></dd><dt><span class="term"><code class="literal">config</code></span></dt><dd><p>This is a 3- or 4- component shorthand for the platform. Examples of this would be <code class="literal">x86_64-unknown-linux-gnu</code> and <code class="literal">aarch64-apple-darwin14</code>. This is a standard format called the “LLVM target triple”, as they are pioneered by LLVM. In the 4-part form, this corresponds to <code class="literal">[cpu]-[vendor]-[os]-[abi]</code>. This format is strictly more informative than the “Nix host double”, as the previous format could analogously be termed. This needs a better name than <code class="literal">config</code>!</p></dd><dt><span class="term"><code class="literal">parsed</code></span></dt><dd><p>This is a Nix representation of a parsed LLVM target triple with white-listed components. This can be specified directly, or actually parsed from the <code class="literal">config</code>. See <code class="literal">lib.systems.parse</code> for the exact representation.</p></dd><dt><span class="term"><code class="literal">libc</code></span></dt><dd><p>This is a string identifying the standard C library used. Valid identifiers include “glibc” for GNU libc, “libSystem” for Darwin’s Libsystem, and “uclibc” for µClibc. It should probably be refactored to use the module system, like <code class="literal">parse</code>.</p></dd><dt><span class="term"><code class="literal">is*</code></span></dt><dd><p>These predicates are defined in <code class="literal">lib.systems.inspect</code>, and slapped onto every platform. They are superior to the ones in <code class="literal">stdenv</code> as they force the user to be explicit about which platform they are inspecting. Please use these instead of those.</p></dd><dt><span class="term"><code class="literal">platform</code></span></dt><dd><p>This is, quite frankly, a dumping ground of ad-hoc settings (it’s an attribute set). See <code class="literal">lib.systems.platforms</code> for examples—there’s hopefully one in there that will work verbatim for each platform that is working. Please help us triage these flags and give them better homes!</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-cross-dependency-categorization" class="title" >Theory of dependency categorization   </h3>  </div> </div></div><div class="note"><h3 class="title">Note</h3><p>This is a rather philosophical description that isn’t very Nixpkgs-specific. For an overview of all the relevant attributes given to <code class="literal">mkDerivation</code>, see <a class="xref" href="index.html#ssec-stdenv-dependencies" title="Specifying dependencies" >the section called “Specifying dependencies”</a>. For a description of how everything is implemented, see <a class="xref" href="index.html#ssec-cross-dependency-implementation" title="Implementation of dependencies" >the section called “Implementation of dependencies”</a>.</p></div><p>In this section we explore the relationship between both runtime and build-time dependencies and the 3 Autoconf platforms.</p><p>A run time dependency between two packages requires that their host platforms match. This is directly implied by the meaning of “host platform” and “runtime dependency”: The package dependency exists while both packages are running on a single host platform.</p><p>A build time dependency, however, has a shift in platforms between the depending package and the depended-on package. “build time dependency” means that to build the depending package we need to be able to run the depended-on’s package. The depending package’s build platform is therefore equal to the depended-on package’s host platform.</p><p>If both the dependency and depending packages aren’t compilers or other machine-code-producing tools, we’re done. And indeed <code class="literal">buildInputs</code> and <code class="literal">nativeBuildInputs</code> have covered these simpler cases for many years. But if the dependency does produce machine code, we might need to worry about its target platform too. In principle, that target platform might be any of the depending package’s build, host, or target platforms, but we prohibit dependencies from a “later” platform to an earlier platform to limit confusion because we’ve never seen a legitimate use for them.</p><p>Finally, if the depending package is a compiler or other machine-code-producing tool, it might need dependencies that run at “emit time”. This is for compilers that (regrettably) insist on being built together with their source languages’ standard libraries. Assuming build != host != target, a run-time dependency of the standard library cannot be run at the compiler’s build time or run time, but only at the run time of code emitted by the compiler.</p><p>Putting this all together, that means that we have dependency types of the form “X→ E”, which means that the dependency executes on X and emits code for E; each of X and E can be <code class="literal">build</code>, <code class="literal">host</code>, or <code class="literal">target</code>, and E can be <code class="literal">*</code> to indicate that the dependency is not a compiler-like package.</p><p>Dependency types describe the relationships that a package has with each of its transitive dependencies.  You could think of attaching one or more dependency types to each of the formal parameters at the top of a package’s <code class="literal">.nix</code> file, as well as to all of <span class="emphasis"><em>their</em></span> formal parameters, and so on.   Triples like <code class="literal">(foo, bar, baz)</code>, on the other hand, are a property of an instantiated derivation – you could would attach a triple <code class="literal">(mips-linux, mips-linux, sparc-solaris)</code> to a <code class="literal">.drv</code> file in <code class="literal">/nix/store</code>.</p><p>Only nine dependency types matter in practice:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="possible-dependency-types" class="title" >Possible dependency types   </h4>  </div> </div></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">Dependency type</th><th align="left">Dependency’s host platform</th><th align="left">Dependency’s target platform</th></tr></thead><tbody><tr><td align="left">build → *</td><td align="left">build</td><td align="left">(none)</td></tr><tr><td align="left">build → build</td><td align="left">build</td><td align="left">build</td></tr><tr><td align="left">build → host</td><td align="left">build</td><td align="left">host</td></tr><tr><td align="left">build → target</td><td align="left">build</td><td align="left">target</td></tr><tr><td align="left">host → *</td><td align="left">host</td><td align="left">(none)</td></tr><tr><td align="left">host → host</td><td align="left">host</td><td align="left">host</td></tr><tr><td align="left">host → target</td><td align="left">host</td><td align="left">target</td></tr><tr><td align="left">target → *</td><td align="left">target</td><td align="left">(none)</td></tr><tr><td align="left">target → target</td><td align="left">target</td><td align="left">target</td></tr></tbody></table></div><p>Let’s use <code class="literal">g++</code> as an example to make this table clearer.  <code class="literal">g++</code> is a C++ compiler written in C.  Suppose we are building <code class="literal">g++</code> with a <code class="literal">(build, host, target)</code> platform triple of <code class="literal">(foo, bar, baz)</code>.  This means we are using a <code class="literal">foo</code>-machine to build a copy of <code class="literal">g++</code> which will run on a <code class="literal">bar</code>-machine and emit binaries for the <code class="literal">baz</code>-machine.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">g++</code> links against the host platform’s <code class="literal">glibc</code> C library, which is a “host→ *” dependency with a triple of <code class="literal">(bar, bar, *)</code>.  Since it is a library, not a compiler, it has no “target”.</p></li><li class="listitem"><p>Since <code class="literal">g++</code> is written in C, the <code class="literal">gcc</code> compiler used to compile it is a “build→ host” dependency of <code class="literal">g++</code> with a triple of <code class="literal">(foo, foo, bar)</code>.  This compiler runs on the build platform and emits code for the host platform.</p></li><li class="listitem"><p><code class="literal">gcc</code> links against the build platform’s <code class="literal">glibc</code> C library, which is a “build→ *” dependency with a triple of <code class="literal">(foo, foo, *)</code>.  Since it is a library, not a compiler, it has no “target”.</p></li><li class="listitem"><p>This <code class="literal">gcc</code> is itself compiled by an <span class="emphasis"><em>earlier</em></span> copy of <code class="literal">gcc</code>.  This earlier copy of <code class="literal">gcc</code> is a “build→ build” dependency of <code class="literal">g++</code> with a triple of <code class="literal">(foo, foo, foo)</code>.  This “early <code class="literal">gcc</code>” runs on the build platform and emits code for the build platform.</p></li><li class="listitem"><p><code class="literal">g++</code> is bundled with <code class="literal">libgcc</code>, which includes a collection of target-machine routines for exception handling and
software floating point emulation.  <code class="literal">libgcc</code> would be a “target→ *” dependency with triple <code class="literal">(foo, baz, *)</code>, because it consists of machine code which gets linked against the output of the compiler that we are building.  It is a library, not a compiler, so it has no target of its own.</p></li><li class="listitem"><p><code class="literal">libgcc</code> is written in C and compiled with <code class="literal">gcc</code>.  The <code class="literal">gcc</code> that compiles it will be a “build→ target” dependency with triple <code class="literal">(foo, foo, baz)</code>.  It gets compiled <span class="emphasis"><em>and run</em></span> at <code class="literal">g++</code>-build-time (on platform <code class="literal">foo</code>), but must emit code for the <code class="literal">baz</code>-platform.</p></li><li class="listitem"><p><code class="literal">g++</code> allows inline assembler code, so it depends on access to a copy of the <code class="literal">gas</code> assembler.  This would be a “host→ target” dependency with triple <code class="literal">(foo, bar, baz)</code>.</p></li><li class="listitem"><p><code class="literal">g++</code> (and <code class="literal">gcc</code>) include a library <code class="literal">libgccjit.so</code>, which wrap the compiler in a library to create a just-in-time compiler.  In nixpkgs, this library is in the <code class="literal">libgccjit</code> package; if C++ required that programs have access to a JIT, <code class="literal">g++</code> would need to add a “target→ target” dependency for <code class="literal">libgccjit</code> with triple <code class="literal">(foo, baz, baz)</code>.  This would ensure that the compiler ships with a copy of <code class="literal">libgccjit</code> which both executes on and generates code for the <code class="literal">baz</code>-platform.</p></li><li class="listitem"><p>If <code class="literal">g++</code> itself linked against <code class="literal">libgccjit.so</code> (for example, to allow compile-time-evaluated C++ expressions), then the <code class="literal">libgccjit</code> package used to provide this functionality would be a “host→ host” dependency of <code class="literal">g++</code>: it is code which runs on the <code class="literal">host</code> and emits code for execution on the <code class="literal">host</code>.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-cross-cookbook" class="title" >Cross packaging cookbook   </h3>  </div> </div></div><p>Some frequently encountered problems when packaging for cross-compilation should be answered here. Ideally, the information above is exhaustive, so this section cannot provide any new information, but it is ludicrous and cruel to expect everyone to spend effort working through the interaction of many features just to figure out the same answer to the same common problem. Feel free to add to this list!</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cross-qa-fails-to-find-binutils" class="title" >My package fails to find a binutils command (<code class="literal">cc</code>/<code class="literal">ar</code>/<code class="literal">ld</code> etc.)   </h4>  </div> </div></div><p>Many packages assume that an unprefixed binutils (<code class="literal">cc</code>/<code class="literal">ar</code>/<code class="literal">ld</code> etc.) is available, but Nix doesn’t provide one. It only provides a prefixed one, just as it only does for all the other binutils programs. It may be necessary to patch the package to fix the build system to use a prefix. For instance, instead of <code class="literal">cc</code>, use <code class="literal">${stdenv.cc.targetPrefix}cc</code>.</p><pre><code class="programlisting nix">{ makeFlags = [ &quot;CC=${stdenv.cc.targetPrefix}cc&quot; ]; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cross-qa-avoid-compiling-gcc-cross-compiler" class="title" >How do I avoid compiling a GCC cross-compiler from source?   </h4>  </div> </div></div><p>On less powerful machines, it can be inconvenient to cross-compile a package only to find out that GCC has to be compiled from source, which could take up to several hours. Nixpkgs maintains a limited <a class="link" href="https://hydra.nixos.org/jobset/nixpkgs/cross-trunk"  target="_top">cross-related jobset on Hydra</a>, which tests cross-compilation to various platforms from build platforms “x86_64-linux”, “aarch64-linux”, and “aarch64-darwin”.  See <code class="literal">pkgs/top-level/release-cross.nix</code> for the full list of target platforms and packages.  For instance, the following invocation fetches the pre-built cross-compiled GCC for <code class="literal">armv6l-unknown-linux-gnueabihf</code> and builds GNU Hello from source.</p><pre><code class="programlisting ShellSession">$ nix-build &#x27;&lt;nixpkgs&gt;&#x27; -A pkgsCross.raspberryPi.hello
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cross-qa-build-c-program-in-build-environment" class="title" >What if my package’s build system needs to build a C program to be run under the build environment?   </h4>  </div> </div></div><p>Add the following to your <code class="literal">mkDerivation</code> invocation.</p><pre><code class="programlisting nix">{ depsBuildBuild = [ buildPackages.stdenv.cc ]; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cross-testsuite-runs-host-code" class="title" >My package’s testsuite needs to run host platform code.   </h4>  </div> </div></div><p>Add the following to your <code class="literal">mkDerivation</code> invocation.</p><pre><code class="programlisting nix">{ doCheck = stdenv.buildPlatform.canExecute stdenv.hostPlatform; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cross-meson-runs-host-code" class="title" >Package using Meson needs to run binaries for the host platform during build.   </h4>  </div> </div></div><p>Add <code class="literal">mesonEmulatorHook</code> to <code class="literal">nativeBuildInputs</code> conditionally on if the target binaries can be executed.</p><p>e.g.</p><pre><code class="programlisting nix">{
  nativeBuildInputs = [
    meson
  ]
  ++ lib.optionals (!stdenv.buildPlatform.canExecute stdenv.hostPlatform) [ mesonEmulatorHook ];
}
</code></pre><p>Example of an error which this fixes.</p><p><code class="literal">[Errno 8] Exec format error: &#x27;./gdk3-scan&#x27;</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cross-static-on-non-static-platform" class="title" >Using <code class="literal">-static</code> outside a <code class="literal">isStatic</code> platform.   </h4>  </div> </div></div><p>Add <code class="literal">stdenv.cc.libc.static</code> (static output of glibc) to <code class="literal">buildInputs</code> conditionally on if <code class="literal">hostPlatform</code> uses <code class="literal">glibc</code>.</p><p>e.g.</p><pre><code class="programlisting nix">{
  buildInputs = lib.optionals (stdenv.hostPlatform.libc == &quot;glibc&quot;) [ stdenv.cc.libc.static ];
}
</code></pre><p>Examples of errors which this fixes.</p><p><code class="literal">cannot find -lm: No such file or directory</code></p><p><code class="literal">cannot find -lc: No such file or directory</code></p><div class="note"><h3 class="title">Note</h3><p>At the time of writing it is assumed the issue only happens on <code class="literal">glibc</code> because it splits the static libraries in to a different output.</p><div class="note"><h3 class="title">Note</h3><p>You may want to look in to using <code class="literal">stdenvAdapters.makeStatic</code> or <code class="literal">pkgsStatic</code> or a <code class="literal">isStatic = true</code> platform.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-cross-usage" class="title" style="clear: both">Cross-building packages   </h2>  </div> </div></div><p>Nixpkgs can be instantiated with <code class="literal">localSystem</code> alone, in which case there is no cross-compiling and everything is built by and for that system, or also with <code class="literal">crossSystem</code>, in which case packages run on the latter, but all building happens on the former. Both parameters take the same schema as the 3 (build, host, and target) platforms defined in the previous section. As mentioned above, <code class="literal">lib.systems.examples</code> has some platforms which are used as arguments for these parameters in practice. You can use them programmatically, or on the command line:</p><pre><code class="programlisting ShellSession">$ nix-build &#x27;&lt;nixpkgs&gt;&#x27; --arg crossSystem &#x27;(import &lt;nixpkgs/lib&gt;).systems.examples.fooBarBaz&#x27; -A whatever
</code></pre><div class="note"><h3 class="title">Note</h3><p>Eventually we would like to make these platform examples an unnecessary convenience so that</p><pre><code class="programlisting ShellSession">$ nix-build &#x27;&lt;nixpkgs&gt;&#x27; --arg crossSystem &#x27;{ config = &quot;&lt;arch&gt;-&lt;os&gt;-&lt;vendor&gt;-&lt;abi&gt;&quot;; }&#x27; -A whatever
</code></pre><p>works in the vast majority of cases. The problem today is dependencies on other sorts of configuration which aren’t given proper defaults. We rely on the examples to crudely to set those configuration parameters in some vaguely sane manner on the users behalf. Issue <a class="link" href="https://github.com/NixOS/nixpkgs/issues/34274"  target="_top">#34274</a> tracks this inconvenience along with its root cause in crufty configuration options.</p></div></div></div><p>While one is free to pass both parameters in full, there’s a lot of logic to fill in missing fields. As discussed in the previous section, only one of <code class="literal">system</code>, <code class="literal">config</code>, and <code class="literal">parsed</code> is needed to infer the other two. Additionally, <code class="literal">libc</code> will be inferred from <code class="literal">parse</code>. Finally, <code class="literal">localSystem.system</code> is also <span class="emphasis"><em>impurely</em></span> inferred based on the platform evaluation occurs. This means it is often not necessary to pass <code class="literal">localSystem</code> at all, as in the command-line example in the previous paragraph.</p><div class="note"><h3 class="title">Note</h3><p>Many sources (manual, wiki, etc) probably mention passing <code class="literal">system</code>, <code class="literal">platform</code>, along with the optional <code class="literal">crossSystem</code> to Nixpkgs: <code class="literal">import &lt;nixpkgs&gt; { system = ..; platform = ..; crossSystem = ..; }</code>. Passing those two instead of <code class="literal">localSystem</code> is still supported for compatibility, but is discouraged. Indeed, much of the inference we do for these parameters is motivated by compatibility as much as convenience.</p></div><p>One would think that <code class="literal">localSystem</code> and <code class="literal">crossSystem</code> overlap horribly with the three <code class="literal">*Platforms</code> (<code class="literal">buildPlatform</code>, <code class="literal">hostPlatform,</code> and <code class="literal">targetPlatform</code>; see <code class="literal">stage.nix</code> or the manual). Actually, those identifiers are purposefully not used here to draw a subtle but important distinction: While the granularity of having 3 platforms is necessary to properly <span class="emphasis"><em>build</em></span> packages, it is overkill for specifying the user’s <span class="emphasis"><em>intent</em></span> when making a build plan or package set. A simple “build vs deploy” dichotomy is adequate: the sliding window principle described in the previous section shows how to interpolate between the these two “end points” to get the 3 platform triple for each bootstrapping stage. That means for any package a given package set, even those not bound on the top level but only reachable via dependencies or <code class="literal">buildPackages</code>, the three platforms will be defined as one of <code class="literal">localSystem</code> or <code class="literal">crossSystem</code>, with the former replacing the latter as one traverses build-time dependencies. A last simple difference is that <code class="literal">crossSystem</code> should be null when one doesn’t want to cross-compile, while the <code class="literal">*Platform</code>s are always non-null. <code class="literal">localSystem</code> is always non-null.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-cross-infra" class="title" style="clear: both">Cross-compilation infrastructure   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-cross-dependency-implementation">Implementation of dependencies</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-bootstrapping">Bootstrapping</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-cross-dependency-implementation" class="title" >Implementation of dependencies   </h3>  </div> </div></div><p>The categories of dependencies developed in <a class="xref" href="index.html#ssec-cross-dependency-categorization" title="Theory of dependency categorization" >the section called “Theory of dependency categorization”</a> are specified as lists of derivations given to <code class="literal">mkDerivation</code>, as documented in <a class="xref" href="index.html#ssec-stdenv-dependencies" title="Specifying dependencies" >the section called “Specifying dependencies”</a>. In short, each list of dependencies for “host → target” is called <code class="literal">deps&lt;host&gt;&lt;target&gt;</code> (where <code class="literal">host</code>, and <code class="literal">target</code> values are either <code class="literal">build</code>, <code class="literal">host</code>, or <code class="literal">target</code>), with exceptions for backwards compatibility that <code class="literal">depsBuildHost</code> is instead called <code class="literal">nativeBuildInputs</code> and <code class="literal">depsHostTarget</code> is instead called <code class="literal">buildInputs</code>. Nixpkgs is now structured so that each <code class="literal">deps&lt;host&gt;&lt;target&gt;</code> is automatically taken from <code class="literal">pkgs&lt;host&gt;&lt;target&gt;</code>. (These <code class="literal">pkgs&lt;host&gt;&lt;target&gt;</code>s are quite new, so there is no special case for <code class="literal">nativeBuildInputs</code> and <code class="literal">buildInputs</code>.) For example, <code class="literal">pkgsBuildHost.gcc</code> should be used at build-time, while <code class="literal">pkgsHostTarget.gcc</code> should be used at run-time.</p><p>Now, for most of Nixpkgs’s history, there were no <code class="literal">pkgs&lt;host&gt;&lt;target&gt;</code> attributes, and most packages have not been refactored to use it explicitly. Prior to those, there were just <code class="literal">buildPackages</code>, <code class="literal">pkgs</code>, and <code class="literal">targetPackages</code>. Those are now redefined as aliases to <code class="literal">pkgsBuildHost</code>, <code class="literal">pkgsHostTarget</code>, and <code class="literal">pkgsTargetTarget</code>. It is acceptable, even recommended, to use them for libraries to show that the host platform is irrelevant.</p><p>But before that, there was just <code class="literal">pkgs</code>, even though both <code class="literal">buildInputs</code> and <code class="literal">nativeBuildInputs</code> existed. [Cross barely worked, and those were implemented with some hacks on <code class="literal">mkDerivation</code> to override dependencies.] What this means is the vast majority of packages do not use any explicit package set to populate their dependencies, just using whatever <code class="literal">callPackage</code> gives them even if they do correctly sort their dependencies into the multiple lists described above. And indeed, asking that users both sort their dependencies, <span class="emphasis"><em>and</em></span> take them from the right attribute set, is both too onerous and redundant, so the recommended approach (for now) is to continue just categorizing by list and not using an explicit package set.</p><p>To make this work, we “splice” together the six <code class="literal">pkgsFooBar</code> package sets and have <code class="literal">callPackage</code> actually take its arguments from that. This is currently implemented in <code class="literal">pkgs/top-level/splice.nix</code>. <code class="literal">mkDerivation</code> then, for each dependency attribute, pulls the right derivation out from the splice. This splicing can be skipped when not cross-compiling as the package sets are the same, but still is a bit slow for cross-compiling. We’d like to do something better, but haven’t come up with anything yet.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-bootstrapping" class="title" >Bootstrapping   </h3>  </div> </div></div><p>Each of the package sets described above come from a single bootstrapping stage. While <code class="literal">pkgs/top-level/default.nix</code>, coordinates the composition of stages at a high level, <code class="literal">pkgs/top-level/stage.nix</code> “ties the knot” (creates the fixed point) of each stage. The package sets are defined per-stage however, so they can be thought of as edges between stages (the nodes) in a graph. Compositions like <code class="literal">pkgsBuildTarget.targetPackages</code> can be thought of as paths to this graph.</p><p>While there are many package sets, and thus many edges, the stages can also be arranged in a linear chain. In other words, many of the edges are redundant as far as connectivity is concerned. This hinges on the type of bootstrapping we do. Currently for cross it is:</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p><code class="literal">(native, native, native)</code></p></li><li class="listitem"><p><code class="literal">(native, native, foreign)</code></p></li><li class="listitem"><p><code class="literal">(native, foreign, foreign)</code></p></li></ol></div><p>In each stage, <code class="literal">pkgsBuildHost</code> refers to the previous stage, <code class="literal">pkgsBuildBuild</code> refers to the one before that, and <code class="literal">pkgsHostTarget</code> refers to the current one, and <code class="literal">pkgsTargetTarget</code> refers to the next one. When there is no previous or next stage, they instead refer to the current stage. Note how all the invariants regarding the mapping between dependency and depending packages’ build host and target platforms are preserved. <code class="literal">pkgsBuildTarget</code> and <code class="literal">pkgsHostHost</code> are more complex in that the stage fitting the requirements isn’t always a fixed chain of “prevs” and “nexts” away (modulo the “saturating” self-references at the ends). We just special case each instead. All the primary edges are implemented is in <code class="literal">pkgs/stdenv/booter.nix</code>, and secondarily aliases in <code class="literal">pkgs/top-level/stage.nix</code>.</p><div class="note"><h3 class="title">Note</h3><p>The native stages are bootstrapped in legacy ways that predate the current cross implementation. This is why the bootstrapping stages leading up to the final stages are ignored in the previous paragraph.</p></div><p>If one looks at the 3 platform triples, one can see that they overlap such that one could put them together into a chain like:</p><pre><code class="programlisting">(native, native, native, foreign, foreign)
</code></pre><p>If one imagines the saturating self references at the end being replaced with infinite stages, and then overlays those platform triples, one ends up with the infinite tuple:</p><pre><code class="programlisting">(native..., native, native, native, foreign, foreign, foreign...)
</code></pre><p>One can then imagine any sequence of platforms such that there are bootstrap stages with their 3 platforms determined by “sliding a window” that is the 3 tuple through the sequence. This was the original model for bootstrapping. Without a target platform (assume a better world where all compilers are multi-target and all standard libraries are built in their own derivation), this is sufficient. Conversely if one wishes to cross compile “faster”, with a “Canadian Cross” bootstrapping stage where <code class="literal">build != host != target</code>, more bootstrapping stages are needed since no sliding window provides the pesky <code class="literal">pkgsBuildTarget</code> package set since it skips the Canadian cross stage’s “host”.</p><div class="note"><h3 class="title">Note</h3><p>It is much better to refer to <code class="literal">buildPackages</code> than <code class="literal">targetPackages</code>, or more broadly package sets that do not mention “target”. There are three reasons for this.</p><p>First, it is because bootstrapping stages do not have a unique <code class="literal">targetPackages</code>. For example a <code class="literal">(x86-linux, x86-linux, arm-linux)</code> and <code class="literal">(x86-linux, x86-linux, x86-windows)</code> package set both have a <code class="literal">(x86-linux, x86-linux, x86-linux)</code> package set. Because there is no canonical <code class="literal">targetPackages</code> for such a native (<code class="literal">build == host == target</code>) package set, we set their <code class="literal">targetPackages</code></p><p>Second, it is because this is a frequent source of hard-to-follow “infinite recursions” / cycles. When only package sets that don’t mention target are used, the package set forms a directed acyclic graph. This means that all cycles that exist are confined to one stage. This means they are a lot smaller, and easier to follow in the code or a backtrace. It also means they are present in native and cross builds alike, and so more likely to be caught by CI and other users.</p><p>Thirdly, it is because everything target-mentioning only exists to accommodate compilers with lousy build systems that insist on the compiler itself and standard library being built together. Of course that is bad because bigger derivations means longer rebuilds. It is also problematic because it tends to make the standard libraries less like other libraries than they could be, complicating code and build systems alike. Because of the other problems, and because of these innate disadvantages, compilers ought to be packaged another way where possible.</p></div><div class="note"><h3 class="title">Note</h3><p>If one explores Nixpkgs, they will see derivations with names like <code class="literal">gccCross</code>. Such <code class="literal">*Cross</code> derivations is a holdover from before we properly distinguished between the host and target platforms—the derivation with “Cross” in the name covered the <code class="literal">build = host != target</code> case, while the other covered the <code class="literal">host = target</code>, with build platform the same or not based on whether one was using its <code class="literal">.__spliced.buildHost</code> or <code class="literal">.__spliced.hostTarget</code>.</p></div>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-platform-notes" class="title" >Platform Notes   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-darwin">Darwin (macOS)</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-darwin" class="title" style="clear: both">Darwin (macOS)   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-darwin-troubleshooting">Darwin Issue Troubleshooting</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-darwin-legacy-frameworks">Dealing with <code class="literal">darwin.apple_sdk.frameworks</code></a> </span></dt><dt> <span class="section">  <a href="index.html#sec-darwin-legacy-cross-compilation">Darwin Cross-Compilation</a> </span></dt> </dl></div><p>The Darwin <code class="literal">stdenv</code> differs from most other ones in Nixpkgs in a few key ways.
These differences reflect the default assumptions for building software on that platform.
In many cases, you can ignore these differences because the software you are packaging is already written with them in mind.
When you do that, write your derivation as normal. You don’t have to include any Darwin-specific special cases.
The easiest way to know whether your derivation requires special handling for Darwin is to write it as if it doesn’t and see if it works.
If it does, you’re done; skip the rest of this.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Darwin uses Clang by default instead of GCC. Packages that refer to <code class="literal">$CC</code> or <code class="literal">cc</code> should just work in most cases.
Some packages may hardcode <code class="literal">gcc</code> or <code class="literal">g++</code>. You can usually fix that by setting <code class="literal">makeFlags = [ &quot;CC=cc&quot; &quot;CXX=C++&quot; ]</code>.
If that does not work, you will have to patch the build scripts yourself to use the correct compiler for Darwin.</p></li><li class="listitem"><p>Darwin needs an SDK to build software.
The SDK provides a default set of frameworks and libraries to build software, most of which are specific to Darwin.
There are multiple versions of the SDK packages in Nixpkgs, but one is included by default in the <code class="literal">stdenv</code>.
Usually, you don’t have to change or pick a different SDK. When in doubt, use the default.</p></li><li class="listitem"><p>The SDK used by your build can be found using the <code class="literal">DEVELOPER_DIR</code> environment variable.
There are also versions of this variable available when cross-compiling depending on the SDK’s role.
The <code class="literal">SDKROOT</code> variable is also set with the path to the SDK’s libraries and frameworks.
<code class="literal">SDKROOT</code> is always a sub-folder of <code class="literal">DEVELOPER_DIR</code>.</p></li><li class="listitem"><p>Darwin includes a platform-specific tool called <code class="literal">xcrun</code> to help builds locate binaries they need.
A version of <code class="literal">xcrun</code> is part of the <code class="literal">stdenv</code> on Darwin.
If your package invokes <code class="literal">xcrun</code> via an absolute path (such as <code class="literal">/usr/bin/xcrun</code>), you will need to patch the build scripts to use <code class="literal">xcrun</code> instead.</p></li></ul></div><p>To reiterate: you usually don’t have to worry about this stuff.
Start with writing your derivation as if everything is already set up for you (because in most cases it already is).
If you run into issues or failures, continue reading below for how to deal with the most common issues you may encounter.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-darwin-troubleshooting" class="title" >Darwin Issue Troubleshooting   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-darwin-troubleshooting-using-sdks" class="title" >Package requires a non-default SDK or fails to build due to missing frameworks or symbols   </h4>  </div> </div></div><p>In some cases, you may have to use a non-default SDK.
This can happen when a package requires APIs that are not present in the default SDK.
For example, Metal Performance Shaders were added in macOS 12.
If the default SDK is 11.3, then a package that requires Metal Performance Shaders will fail to build due to missing frameworks and symbols.</p><p>To use a non-default SDK, add it to your derivation’s <code class="literal">buildInputs</code>.
It is not necessary to override the SDK in the <code class="literal">stdenv</code> nor is it necessary to override the SDK used by your dependencies.
If your derivation needs a non-default SDK at build time (e.g., for a <code class="literal">depsBuildBuild</code> compiler), see the cross-compilation documentation for which input you should use.</p><p>When determining whether to use a non-default SDK, consider the following:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Try building your derivation with the default SDK. If it works, you’re done.</p></li><li class="listitem"><p>If the package specifies a specific version, use that. See below for how to map Xcode version to SDK version.</p></li><li class="listitem"><p>If the package’s documentation indicates it supports optional features on newer SDKs, consider using the SDK that enables those features.
If you’re not sure, use the default SDK.</p></li></ul></div><p>Note: It is possible to have multiple, different SDK versions in your inputs.
When that happens, the one with the highest version is always used.</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  name = &quot;libfoo-1.2.3&quot;;
  # ...
  buildInputs = [ apple-sdk_14 ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-darwin-troubleshooting-using-deployment-targets" class="title" >What is a “deployment target” (or minimum version)?   </h4>  </div> </div></div><p>The “deployment target” refers to the minimum version of macOS that is expected to run an application.
In most cases, the default is fine, and you don’t have to do anything else.
If you’re not sure, don’t do anything, and that will probably be fine.</p><p>Some packages require setting a non-default deployment target (or minimum version) to gain access to certain APIs.
You do that using the <code class="literal">darwinMinVersionHook</code>, which takes the deployment target version as a parameter.
There are primarily two ways to determine the deployment target.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>The upstream documentation will specify a deployment target or minimum version. Use that.</p></li><li class="listitem"><p>The build will fail because an API requires a certain version. Use that.</p></li><li class="listitem"><p>In all other cases, you probably don’t need to specify a minimum version. The default is usually good enough.</p></li></ul></div><pre><code class="programlisting nix">stdenv.mkDerivation {
  name = &quot;libfoo-1.2.3&quot;; # Upstream specifies the minimum supported version as 12.5.
  buildInputs = [ (darwinMinVersionHook &quot;12.5&quot;) ];
}
</code></pre><p>Note: It is possible to have multiple, different instances of <code class="literal">darwinMinVersionHook</code> in your inputs.
When that happens, the one with the  highest version is always used.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-darwin-troubleshooting-picking-sdk-version" class="title" >Picking an SDK version   </h4>  </div> </div></div><p>The following is a list of Xcode versions, the SDK version in Nixpkgs, and the attribute to use to add it.
Check your package’s documentation (platform support or installation instructions) to find which Xcode or SDK version to use.
Generally, only the last SDK release for a major version is packaged.</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">Xcode version</th><th align="left">SDK version</th><th align="left">Nixpkgs attribute</th></tr></thead><tbody><tr><td align="left">12.0–12.5.1</td><td align="left">11.3</td><td align="left"><code class="literal">apple-sdk_11</code> / <code class="literal">apple-sdk</code></td></tr><tr><td align="left">13.0–13.4.1</td><td align="left">12.3</td><td align="left"><code class="literal">apple-sdk_12</code></td></tr><tr><td align="left">14.0–14.3.1</td><td align="left">13.3</td><td align="left"><code class="literal">apple-sdk_13</code></td></tr><tr><td align="left">15.0–15.4</td><td align="left">14.4</td><td align="left"><code class="literal">apple-sdk_14</code></td></tr><tr><td align="left">16.0</td><td align="left">15.0</td><td align="left"><code class="literal">apple-sdk_15</code></td></tr></tbody></table></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-darwin-troubleshooting-darwin-defaults" class="title" >Darwin Default SDK versions   </h4>  </div> </div></div><p>The current default version of the SDK and deployment target (minimum supported version) are indicated by the Darwin-specific platform attributes <code class="literal">darwinSdkVersion</code> and <code class="literal">darwinMinVersion</code>.
Because of the ways that minimum version and SDK can be changed that are not visible to Nix, they should be treated as lower bounds.
If you need to parameterize over a specific version, create a function that takes the version as a parameter instead of relying on these attributes.</p><p>On macOS, the <code class="literal">darwinMinVersion</code> and <code class="literal">darwinSdkVersion</code> are always the same, and are currently set to 11.3.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-darwin-troubleshooting-xcrun" class="title" ><code class="literal">xcrun</code> cannot find a binary   </h4>  </div> </div></div><p><code class="literal">xcrun</code> searches <code class="literal">PATH</code> and the SDK’s toolchain for binaries to run.
If it cannot find a required binary, it will fail. When that happens, add the package for that binary to your derivation’s <code class="literal">nativeBuildInputs</code> (or <code class="literal">nativeCheckInputs</code> if the failure is happening when running tests).</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  name = &quot;libfoo-1.2.3&quot;;
  # ...
  nativeBuildInputs = [ bison ];
  buildCommand = &#x27;&#x27;
    xcrun bison foo.y # produces foo.tab.c
    # ...
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-darwin-troubleshooting-xcodebuild" class="title" >Package requires <code class="literal">xcodebuild</code>   </h4>  </div> </div></div><p>The xcbuild package provides an <code class="literal">xcodebuild</code> command for packages that really depend on Xcode.
This replacement is not 100% compatible and may run into some issues, but it is able to build many packages.
To use <code class="literal">xcodebuild</code>, add <code class="literal">xcbuildHook</code> to your package’s <code class="literal">nativeBuildInputs</code>.
It will provide a <code class="literal">buildPhase</code> for your derivation.
You can use <code class="literal">xcbuildFlags</code> to specify flags to <code class="literal">xcodebuild</code> such as the required schema.
If a schema has spaces in its name, you must set <code class="literal">__structuredAttrs</code> to <code class="literal">true</code>.
See MoltenVK for an example of setting up xcbuild.</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  name = &quot;libfoo-1.2.3&quot;;
  xcbuildFlags = [
    &quot;-configuration&quot;
    &quot;Release&quot;
    &quot;-project&quot;
    &quot;libfoo-project.xcodeproj&quot;
    &quot;-scheme&quot;
    &quot;libfoo Package (macOS only)&quot;
  ];
  __structuredAttrs = true;
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="sec-darwin-troubleshooting-xcodebuild-absolute-paths" class="title" >Fixing absolute paths to <code class="literal">xcodebuild</code>, <code class="literal">xcrun</code>, and <code class="literal">PlistBuddy</code>   </h5>  </div> </div></div><p>Many build systems hardcode the absolute paths to <code class="literal">xcodebuild</code>, <code class="literal">xcrun</code>, and <code class="literal">PlistBuddy</code> as <code class="literal">/usr/bin/xcodebuild</code>, <code class="literal">/usr/bin/xcrun</code>, and <code class="literal">/usr/libexec/PlistBuddy</code> respectively.
These paths will need to be replaced with relative paths and the xcbuild package if <code class="literal">xcodebuild</code> or <code class="literal">PListBuddy</code> are used.</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  name = &quot;libfoo-1.2.3&quot;;
  postPatch = &#x27;&#x27;
    substituteInPlace Makefile \
      --replace-fail &#x27;/usr/bin/xcodebuild&#x27; &#x27;xcodebuild&#x27; \
      --replace-fail &#x27;/usr/bin/xcrun&#x27; &#x27;xcrun&#x27; \
      --replace-fail &#x27;/usr/bin/PListBuddy&#x27; &#x27;PListBuddy&#x27;
  &#x27;&#x27;;
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-darwin-troubleshooting-libiconv" class="title" >How to use libiconv on Darwin   </h4>  </div> </div></div><p>The libiconv package is included in the SDK by default along with libresolv and libsbuf.
You do not need to do anything to use these packages. They are available automatically.
If your derivation needs the <code class="literal">iconv</code> binary, add the <code class="literal">libiconv</code> package to your <code class="literal">nativeBuildInputs</code> (or <code class="literal">nativeCheckInputs</code> for tests).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-darwin-troubleshooting-install-name" class="title" >Library install name issues   </h4>  </div> </div></div><p>Libraries on Darwin are usually linked with absolute paths.
This is determined by something called an “install name”, which is resolved at link time.
Sometimes packages will not set this correctly, causing binaries linking to it not to find their libraries at runtime.
This can be fixed by adding extra linker flags or by using <code class="literal">install_name_tool</code> to set it in <code class="literal">fixupPhase</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="sec-darwin-troubleshooting-install-name-linker-flags" class="title" >Setting the install name via linker flags   </h5>  </div> </div></div><pre><code class="programlisting nix">stdenv.mkDerivation {
  name = &quot;libfoo-1.2.3&quot;;
  # ...
  makeFlags = lib.optional stdenv.hostPlatform.isDarwin &quot;LDFLAGS=-Wl,-install_name,$(out)/lib/libfoo.dylib&quot;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="sec-darwin-troubleshooting-install-name-install_name_tool" class="title" >Setting the install name using <code class="literal">install_name_tool</code>   </h5>  </div> </div></div><pre><code class="programlisting nix">stdenv.mkDerivation {
  name = &quot;libfoo-1.2.3&quot;;
  # ...
  postFixup = &#x27;&#x27;
    # `-id &lt;install_name&gt;` takes the install name. The last parameter is the path to the library.
    ${stdenv.cc.targetPrefix}install_name_tool -id &quot;$out/lib/libfoo.dylib&quot; &quot;$out/lib/libfoo.dylib&quot;
  &#x27;&#x27;;
}
</code></pre><p>Even if libraries are linked using absolute paths and resolved via their install name correctly, tests in <code class="literal">checkPhase</code> can sometimes fail to run binaries because they are linked against libraries that have not yet been installed.
This can usually be solved by running the tests after the <code class="literal">installPhase</code> or by using <code class="literal">DYLD_LIBRARY_PATH</code> (see <span class="citerefentry"><span class="refentrytitle">dyld</span>(1)</span> for more on setting <code class="literal">DYLD_LIBRARY_PATH</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="sec-darwin-troubleshooting-install-name-fixDarwinDylibNames" class="title" >Setting the install name using <code class="literal">fixDarwinDylibNames</code> hook   </h5>  </div> </div></div><p>If your package has numerous dylibs needing fixed, while it is preferable to fix the issue in the package’s build, you can update them all by adding the <code class="literal">fixDarwinDylibNames</code> hook to your <code class="literal">nativeBuildInputs</code>.
This hook will scan your package’s outputs for dylibs and correct their install names.
Note that if any binaries in your outputs linked those dylibs, you may need to use <code class="literal">install_name_tool</code> to replace references to them with the correct paths.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-darwin-troubleshooting-propagating-sdks" class="title" >Propagating an SDK (advanced, compilers-only)   </h4>  </div> </div></div><p>The SDK is a package, and it can be propagated.
<code class="literal">darwinMinVersionHook</code> with a version specified can also be propagated.
However, most packages should <span class="emphasis"><em>not</em></span> do this.
The exception is compilers.
When you propagate an SDK, it becomes part of your derivation’s public API, and changing the SDK or removing it can be a breaking change.
That is why propagating it is only recommended for compilers.</p><p>When authoring a compiler derivation, propagate the SDK only for the ways you expect users to use your compiler.
Depending on your expected use cases, you may have to do one or all of these.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Put it in <code class="literal">depsTargetTargetPropagated</code> when your compiler is expected to be added to <code class="literal">nativeBuildInputs</code>.
That will ensure the SDK is effectively part of the target derivation’s <code class="literal">buildInputs</code>.</p></li><li class="listitem"><p>If your compiler uses a hook, put it in the hook’s <code class="literal">depsTargetTargetPropagated</code> instead.
The effect should be the same as the above.</p></li><li class="listitem"><p>If your package uses the builder pattern, update your builder to add the SDK to the derivation’s <code class="literal">buildInputs</code>.</p></li></ul></div><p>If you’re not sure whether to propagate an SDK, don’t.
If your package is a compiler or language, and you’re not sure, ask @NixOS/darwin-maintainers for help deciding.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-darwin-legacy-frameworks" class="title" >Dealing with <code class="literal">darwin.apple_sdk.frameworks</code>   </h3>  </div> </div></div><p>You may see references to <code class="literal">darwin.apple_sdk.frameworks</code>.
This is the legacy SDK pattern, and it is being phased out.
All packages in <code class="literal">darwin.apple_sdk</code>, <code class="literal">darwin.apple_sdk_11_0</code>, and <code class="literal">darwin.apple_sdk_12_3</code> are stubs that do nothing.
If your derivation references them, you can delete them. The default SDK should be enough to build your package.</p><p>Note: the new SDK pattern uses the name <code class="literal">apple-sdk</code> to better align with Nixpkgs naming conventions.
The legacy SDK pattern uses <code class="literal">apple_sdk</code>.
You always know you are using the old SDK pattern if the name is <code class="literal">apple_sdk</code>.</p><p>Some derivations may depend on the location of frameworks in those old packages.
To update your derivation to find them in the new SDK, use <code class="literal">$SDKROOT</code> instead in <code class="literal">preConfigure</code>.
For example, if you substitute <code class="literal">${darwin.apple_sdk.frameworks.OpenGL}/Library/Frameworks/OpenGL.framework</code> in <code class="literal">postPatch</code>, replace it with <code class="literal">$SDKROOT/System/Library/Frameworks/OpenGL.framework</code> in <code class="literal">preConfigure</code>.</p><p>Note that if your derivation is changing a system path (such as <code class="literal">/System/Library/Frameworks/OpenGL.framework</code>), you may be able to remove the path.
Compilers and binutils targeting Darwin look for system paths in the SDK sysroot.
Some of them (such as Zig or <code class="literal">bindgen</code> for Rust) depend on it.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-darwin-legacy-frameworks-overrides" class="title" >Updating legacy SDK overrides   </h4>  </div> </div></div><p>The legacy SDK provided two ways of overriding the default SDK.
These are both being phased out along with the legacy SDKs.
They have been updated to set up the new SDK for you, but you should replace them with doing that directly.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pkgs.darwin.apple_sdk_11_0.callPackage</code> - this pattern was used to provide frameworks from the macOS 11 SDK.
It is now the same as <code class="literal">callPackage</code>.</p></li><li class="listitem"><p><code class="literal">overrideSDK</code> - this stdenv adapter would try to replace the frameworks used by your derivation and its transitive dependencies.
It now adds the <code class="literal">apple-sdk_12</code> package for <code class="literal">12.3</code> and does nothing for <code class="literal">11.0</code>.
If <code class="literal">darwinMinVersion</code> is specified, it will add <code class="literal">darwinMinVersionHook</code> with the specified minimum version.
No other SDK versions are supported.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-darwin-legacy-cross-compilation" class="title" >Darwin Cross-Compilation   </h3>  </div> </div></div><p>Darwin supports cross-compilation between Darwin platforms.
Cross-compilation from Linux is not currently supported but may be supported in the future.
To cross-compile to Darwin, you can set <code class="literal">crossSystem</code> or use one of the Darwin systems in <code class="literal">pkgsCross</code>.
The <code class="literal">darwinMinVersionHook</code> and the SDKs support cross-compilation.
If you need to specify a different SDK version for a <code class="literal">depsBuildBuild</code> compiler, add it to your <code class="literal">nativeBuildInputs</code>.</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  name = &quot;libfoo-1.2.3&quot;;
  # ...
  depsBuildBuild = [ buildPackages.stdenv.cc ];
  nativeBuildInputs = [ apple-sdk_12 ];
  buildInputs = [ apple-sdk_13 ];
  depsTargetTargetPropagated = [ apple-sdk_14 ];
}
# The build-build `clang` will use the 12.3 SDK while the package build itself will use the 13.3 SDK.
# Derivations that add this package as an input will have the 14.4 SDK propagated to them.
</code></pre><p>The different target SDK and hooks are mangled based on role:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">DEVELOPER_DIR_FOR_BUILD</code> and <code class="literal">MACOSX_DEPLOYMENT_TARGET_FOR_BUILD</code> for the build platform;</p></li><li class="listitem"><p><code class="literal">DEVELOPER_DIR</code> and <code class="literal">MACOSX_DEPLOYMENT_TARGET</code> for the host platform; and</p></li><li class="listitem"><p><code class="literal">DEVELOPER_DIR_FOR_TARGET</code> and <code class="literal">MACOSX_DEPLOYMENT_TARGET_FOR_TARGET</code> for the build platform.</p></li></ul></div><p>In static compilation situations, it is possible for the build and host platform to be the same platform but have different SDKs with the same version (one dynamic and one static).
cc-wrapper and bintools-wrapper take care of handling this distinction.</p>
</div>

</div>

</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="part-toolchains" class="title" >Toolchains   </h1>  </div> </div></div><div class="partintro"><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#chap-toolchains">The LLVM Toolchain</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-toolchains" class="title" >The LLVM Toolchain   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-using-llvm">Using LLVM</a> </span></dt> </dl></div><p>LLVM is a target-independent optimizer and code generator and serves as the basis for many compilers such as Haskell’s GHC, rustc, Zig, and many others. It forms the base tools for Apple’s Darwin platform.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-using-llvm" class="title" style="clear: both">Using LLVM   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-building-packages-with-llvm">Building packages with LLVM</a> </span></dt> </dl></div><p>LLVM has two ways of being used. One is by using it across all of Nixpkgs and the other is to compile and build individual packages.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-building-packages-with-llvm" class="title" >Building packages with LLVM   </h3>  </div> </div></div><p>Nixpkgs supports two methods of compiling the world with LLVM. One is via setting <code class="literal">useLLVM</code> in <code class="literal">crossSystem</code> while importing. This is the recommended way when cross compiling as it is more expressive. An example of doing <code class="literal">aarch64-linux</code> cross compilation from <code class="literal">x86_64-linux</code> with LLVM on the target is the following:</p><pre><code class="programlisting nix">import &lt;nixpkgs&gt; {
  localSystem = {
    system = &quot;x86_64-linux&quot;;
  };
  crossSystem = {
    useLLVM = true;
    linker = &quot;lld&quot;;
  };
}
</code></pre><p>Note that we set <code class="literal">linker</code> to <code class="literal">lld</code>. This is because LLVM has its own linker called “lld”. By setting it, we utilize Clang and lld within this new instance of Nixpkgs. There is a shorthand method for building everything with LLVM: <code class="literal">pkgsLLVM</code>. This is easier to use with <code class="literal">nix-build</code> (or <code class="literal">nix build</code>):</p><pre><code class="programlisting bash">nix-build -A pkgsLLVM.hello
</code></pre><p>This will compile the GNU hello package with LLVM and the lld linker like previously mentioned.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-building-packages-with-llvm-using-clang-stdenv" class="title" >Using <code class="literal">clangStdenv</code>   </h4>  </div> </div></div><p>Another simple way is to override the stdenv with <code class="literal">clangStdenv</code>. This causes a single package to be built with Clang. However, this <code class="literal">stdenv</code> does not override platform defaults to use compiler-rt, libc++, and libunwind. This is the preferred way to make a single package in Nixpkgs build with Clang. There are cases where just Clang isn’t enough. For these situations, there is <code class="literal">libcxxStdenv</code>, which uses Clang with libc++ and compiler-rt.</p>
</div>

</div>

</div>

</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="part-builders" class="title" >Build helpers   </h1>  </div> </div></div><div class="partintro"><p>A build helper is a function that produces derivations.</p><div class="warning"><h3 class="title">Warning</h3><p>This is not to be confused with the <a class="link" href="https://nixos.org/manual/nix/unstable/language/derivations.html"  target="_top"><code class="literal">builder</code> argument of the Nix <code class="literal">derivation</code> primitive</a>, which refers to the executable that produces the build result, or <a class="link" href="https://nixos.org/manual/nix/stable/advanced-topics/distributed-builds.html"  target="_top">remote builder</a>, which refers to a remote  machine that could run such an executable.</p></div><p>Such a function is usually designed to abstract over a typical workflow for a given programming language or framework.
This allows declaring a build recipe by setting a limited number of options relevant to the particular use case instead of using the <code class="literal">derivation</code> function directly.</p><p><a class="link" href="index.html#part-stdenv" title="Standard environment" ><code class="literal">stdenv.mkDerivation</code></a> is the most widely used build helper, and serves as a basis for many others.
In addition, it offers various options to customize parts of the builds.</p><p>There is no uniform interface for build helpers.
<a class="link" href="index.html#chap-trivial-builders" title="Trivial build helpers" >Trivial build helpers</a> and <a class="link" href="index.html#chap-pkgs-fetchers" title="Fetchers" >fetchers</a> have various input types for convenience.
<a class="link" href="index.html#chap-language-support" title="Languages and frameworks" >Language- or framework-specific build helpers</a> usually follow the style of <code class="literal">stdenv.mkDerivation</code>, which accepts an attribute set or a fixed-point function taking an attribute set.</p><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#chap-build-helpers-finalAttrs">Fixed-point arguments of build helpers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-pkgs-fetchers">Fetchers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-trivial-builders">Trivial build helpers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-testers">Testers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-devShellTools">Development Shell helpers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-special">Special build helpers</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-images">Images</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-hooks">Hooks reference</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-language-support">Languages and frameworks</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-packages">Packages</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-build-helpers-finalAttrs" class="title" >Fixed-point arguments of build helpers   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-build-helper-extendMkDerivation">Defining a build helper with <code class="literal">lib.extendMkDerivation</code></a> </span></dt> </dl></div><p>As mentioned in the beginning of this part, <code class="literal">stdenv.mkDerivation</code> could alternatively accept a fixed-point function. The input of such function, typically named <code class="literal">finalAttrs</code>, is expected to be the final state of the attribute set.
A build helper like this is said to accept <span class="strong"><strong>fixed-point arguments</strong></span>.</p><p>Build helpers don’t always support fixed-point arguments yet, as support in <a class="link" href="index.html#mkderivation-recursive-attributes" title="Fixed-point arguments of mkDerivation" ><code class="literal">stdenv.mkDerivation</code></a> was first included in Nixpkgs 22.05.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-build-helper-extendMkDerivation" class="title" style="clear: both">Defining a build helper with <code class="literal">lib.extendMkDerivation</code>   </h2>  </div> </div></div><p>Developers can use the Nixpkgs library function <a class="link" href="index.html#function-library-lib.customisation.extendMkDerivation" title="lib.customisation.extendMkDerivation" ><code class="literal">lib.customisation.extendMkDerivation</code></a> to define a build helper supporting fixed-point arguments from an existing one with such support, with an attribute overlay similar to the one taken by <a class="link" href="index.html#sec-pkg-overrideAttrs" title="&lt;pkg&gt;.overrideAttrs" ><code class="literal">&lt;pkg&gt;.overrideAttrs</code></a>.</p><p>Beside overriding, <code class="literal">lib.extendMkDerivation</code> also supports <code class="literal">excludeDrvArgNames</code> to optionally exclude some arguments in the input fixed-point arguments from passing down the base build helper (specified as <code class="literal">constructDrv</code>).</p><div class="example"><span id="ex-build-helpers-extendMkDerivation" ></span><details><summary><span class="title"><strong>Example 278. Example definition of <code class="literal">mkLocalDerivation</code> extended from <code class="literal">stdenv.mkDerivation</code> with <code class="literal">lib.extendMkDerivation</code></strong></span></summary><div class="example-contents"><p>We want to define a build helper named <code class="literal">mkLocalDerivation</code> that builds locally without using substitutes by default.</p><p>Instead of taking a plain attribute set,</p><pre><code class="programlisting nix">{
  preferLocalBuild ? true,
  allowSubstitute ? false,
  specialArg ? (_: false),
  ...
}@args:

stdenv.mkDerivation (
  removeAttrs [
    # Don&#x27;t pass specialArg into mkDerivation.
    &quot;specialArg&quot;
  ] args
  // {
    # Arguments to pass
    inherit preferLocalBuild allowSubstitute;
    # Some expressions involving specialArg
    greeting = if specialArg &quot;hi&quot; then &quot;hi&quot; else &quot;hello&quot;;
  }
)
</code></pre><p>we could define with <code class="literal">lib.extendMkDerivation</code> an attribute overlay to make the result build helper also accepts the the attribute set’s fixed point passing to the underlying <code class="literal">stdenv.mkDerivation</code>, named <code class="literal">finalAttrs</code> here:</p><pre><code class="programlisting nix">lib.extendMkDerivation {
  constructDrv = stdenv.mkDerivation;
  excludeDrvArgNames = [
    # Don&#x27;t pass specialArg into mkDerivation.
    &quot;specialArg&quot;
  ];
  extendDrvArgs =
    finalAttrs:
    {
      preferLocalBuild ? true,
      allowSubstitute ? false,
      specialArg ? (_: false),
      ...
    }@args:
    {
      # Arguments to pass
      inherit preferLocalBuild allowSubstitute;
      # Some expressions involving specialArg
      greeting = if specialArg &quot;hi&quot; then &quot;hi&quot; else &quot;hello&quot;;
    };
}
</code></pre></div></details></div><br class="example-break" /><p>If one needs to apply extra changes to the result derivation, pass the derivation transformation function to <code class="literal">lib.extendMkDerivation</code> as <code class="literal">lib.customisation.extendMkDerivation { transformDrv = drv: ...; }</code>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-pkgs-fetchers" class="title" >Fetchers   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#chap-pkgs-fetchers-caveats">Caveats</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-fetchers-updating-source-hashes">Updating source hashes</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-fetchers-secure-hashes">Obtaining hashes securely</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-fetchers-proxy">Proxy usage</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-fetchers-fetchurl"><code class="literal">fetchurl</code></a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-fetchers-fetchzip"><code class="literal">fetchzip</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchpatch"><code class="literal">fetchpatch</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchdebianpatch"><code class="literal">fetchDebianPatch</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchsvn"><code class="literal">fetchsvn</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchgit"><code class="literal">fetchgit</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchfossil"><code class="literal">fetchfossil</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchcvs"><code class="literal">fetchcvs</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchhg"><code class="literal">fetchhg</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchfromgitea"><code class="literal">fetchFromGitea</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchfromgithub"><code class="literal">fetchFromGitHub</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchfromgitlab"><code class="literal">fetchFromGitLab</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchfromgitiles"><code class="literal">fetchFromGitiles</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchfrombitbucket"><code class="literal">fetchFromBitbucket</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchfromsavannah"><code class="literal">fetchFromSavannah</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchfromrepoorcz"><code class="literal">fetchFromRepoOrCz</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchfromsourcehut"><code class="literal">fetchFromSourcehut</code></a> </span></dt><dt> <span class="section">  <a href="index.html#requirefile"><code class="literal">requireFile</code></a> </span></dt><dt> <span class="section">  <a href="index.html#fetchtorrent"><code class="literal">fetchtorrent</code></a> </span></dt> </dl></div><p>Building software with Nix often requires downloading source code and other files from the internet.
To this end, we use functions that we call <span class="emphasis"><em>fetchers</em></span>, which obtain remote sources via various protocols and services.</p><p>Nix provides built-in fetchers such as <a class="link" href="https://nixos.org/manual/nix/stable/language/builtins.html#builtins-fetchTarball"  target="_top"><code class="literal">builtins.fetchTarball</code></a>.
Nixpkgs provides its own fetchers, which work differently:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>A built-in fetcher will download and cache files at evaluation time and produce a <a class="link" href="https://nixos.org/manual/nix/stable/glossary#gloss-store-path"  target="_top">store path</a>.
A Nixpkgs fetcher will create a (<a class="link" href="https://nixos.org/manual/nix/stable/glossary#gloss-fixed-output-derivation"  target="_top">fixed-output</a>) <a class="link" href="https://nixos.org/manual/nix/stable/glossary#gloss-derivation"  target="_top">derivation</a>, and files are downloaded at build time.</p></li><li class="listitem"><p>Built-in fetchers will invalidate their cache after <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/conf-file#conf-tarball-ttl"  target="_top"><code class="literal">tarball-ttl</code></a> expires, and will require network activity to check if the cache entry is up to date.
Nixpkgs fetchers only re-download if the specified hash changes or the store object is not available.</p></li><li class="listitem"><p>Built-in fetchers do not use <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/conf-file#conf-substituters"  target="_top">substituters</a>.
Derivations produced by Nixpkgs fetchers will use any configured binary cache transparently.</p></li></ul></div><p>This significantly reduces the time needed to evaluate Nixpkgs, and allows <a class="link" href="https://nixos.org/hydra"  target="_top">Hydra</a> to retain and re-distribute sources used by Nixpkgs in the <a class="link" href="https://cache.nixos.org"  target="_top">public binary cache</a>.
For these reasons, Nix’s built-in fetchers are not allowed in Nixpkgs.</p><p>The following table summarises the differences:</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /><col align="left" /><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">Fetchers</th><th align="left">Download</th><th align="left">Output</th><th align="left">Cache</th><th align="left">Re-download when</th></tr></thead><tbody><tr><td align="left"><code class="literal">builtins.fetch*</code></td><td align="left">evaluation time</td><td align="left">store path</td><td align="left"><code class="literal">/nix/store</code>, <code class="literal">~/.cache/nix</code></td><td align="left"><code class="literal">tarball-ttl</code> expires, cache miss in <code class="literal">~/.cache/nix</code>, output store object not in local store</td></tr><tr><td align="left"><code class="literal">pkgs.fetch*</code></td><td align="left">build time</td><td align="left">derivation</td><td align="left"><code class="literal">/nix/store</code>, substituters</td><td align="left">output store object not available</td></tr></tbody></table></div><div class="tip"><h3 class="title">Tip</h3><p><code class="literal">pkgs.fetchFrom*</code> helpers retrieve <span class="emphasis"><em>snapshots</em></span> of version-controlled sources, as opposed to the entire version history, which is more efficient.
<code class="literal">pkgs.fetchgit</code> by default also has the same behaviour, but can be changed through specific attributes given to it.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="chap-pkgs-fetchers-caveats" class="title" style="clear: both">Caveats   </h2>  </div> </div></div><p>Because Nixpkgs fetchers are fixed-output derivations, an <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes#adv-attr-outputHash"  target="_top">output hash</a> has to be specified, usually indirectly through a <code class="literal">hash</code> attribute.
This hash refers to the derivation output, which can be different from the remote source itself!</p><p>This has the following implications that you should be aware of:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Use Nix (or Nix-aware) tooling to produce the output hash.</p></li><li class="listitem"><p>When changing any fetcher parameters, always update the output hash.
Use one of the methods from <a class="xref" href="index.html#sec-pkgs-fetchers-updating-source-hashes" title="Updating source hashes" >the section called “Updating source hashes”</a>.
Otherwise, existing store objects that match the output hash will be re-used rather than fetching new content.</p><div class="note"><h3 class="title">Note</h3><p>A similar problem arises while testing changes to a fetcher’s implementation.
If the output of the derivation already exists in the Nix store, test failures can go undetected.
The <a class="link" href="index.html#tester-invalidateFetcherByDrvHash" title="invalidateFetcherByDrvHash" ><code class="literal">invalidateFetcherByDrvHash</code></a> function helps prevent reusing cached derivations.</p></div></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-fetchers-updating-source-hashes" class="title" style="clear: both">Updating source hashes   </h2>  </div> </div></div><p>There are several ways to obtain the hash corresponding to a remote source.
Unless you understand how the fetcher you’re using calculates the hash from the downloaded contents, you should use <a class="link" href="index.html#sec-pkgs-fetchers-updating-source-hashes-fakehash-method"  >the fake hash method</a>.</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p><span id="sec-pkgs-fetchers-updating-source-hashes-fakehash-method"></span> The fake hash method: In your package recipe, set the hash to one of</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">&quot;&quot;</code></p></li><li class="listitem"><p><code class="literal">lib.fakeHash</code></p></li><li class="listitem"><p><code class="literal">lib.fakeSha256</code></p></li><li class="listitem"><p><code class="literal">lib.fakeSha512</code></p></li></ul></div><p>Attempt to build, extract the calculated hashes from error messages, and put them into the recipe.</p><div class="warning"><h3 class="title">Warning</h3><p>You must use one of these four fake hashes and not some arbitrarily-chosen hash.
See <a class="xref" href="index.html#sec-pkgs-fetchers-secure-hashes" title="Obtaining hashes securely" >the section called “Obtaining hashes securely”</a> for details.</p></div><div class="example"><span id="ex-fetchers-update-fod-hash" ></span><details><summary><span class="title"><strong>Example 279. Update source hash with the fake hash method</strong></span></summary><div class="example-contents"><p>Consider the following recipe that produces a plain file:</p><pre><code class="programlisting nix">{ fetchurl }:
fetchurl {
  url = &quot;https://raw.githubusercontent.com/NixOS/nixpkgs/23.05/.version&quot;;
  hash = &quot;sha256-ZHl1emidXVojm83LCVrwULpwIzKE/mYwfztVkvpruOM=&quot;;
}
</code></pre><p>A common mistake is to update a fetcher parameter, such as <code class="literal">url</code>, without updating the hash:</p><pre><code class="programlisting nix">{ fetchurl }:
fetchurl {
  url = &quot;https://raw.githubusercontent.com/NixOS/nixpkgs/23.11/.version&quot;;
  hash = &quot;sha256-ZHl1emidXVojm83LCVrwULpwIzKE/mYwfztVkvpruOM=&quot;;
}
</code></pre><p><span class="strong"><strong>This will produce the same output as before!</strong></span>
Set the hash to an empty string:</p><pre><code class="programlisting nix">{ fetchurl }:
fetchurl {
  url = &quot;https://raw.githubusercontent.com/NixOS/nixpkgs/23.11/.version&quot;;
  hash = &quot;&quot;;
}
</code></pre><p>When building the package, use the error message to determine the correct hash:</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
error: hash mismatch in fixed-output derivation &#x27;/nix/store/7yynn53jpc93l76z9zdjj4xdxgynawcw-version.drv&#x27;:
        specified: sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
            got:    sha256-BZqI7r0MNP29yGH5+yW2tjU9OOpOCEvwWKrWCv5CQ0I=
error: build of &#x27;/nix/store/bqdjcw5ij5ymfbm41dq230chk9hdhqff-version.drv&#x27; failed
</code></pre></div></details></div><br class="example-break" /></li><li class="listitem"><p>Prefetch the source with <a class="link" href="https://search.nixos.org/packages?buckets=%7B%22package_attr_set%22%3A%5B%22No%20package%20set%22%5D%2C%22package_license_set%22%3A%5B%5D%2C%22package_maintainers_set%22%3A%5B%5D%2C%22package_platforms%22%3A%5B%5D%7D&amp;query=nix-prefetch"  target="_top"><code class="literal">nix-prefetch-&lt;type&gt; &lt;URL&gt;</code></a>, where <code class="literal">&lt;type&gt;</code> is one of</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">url</code></p></li><li class="listitem"><p><code class="literal">git</code></p></li><li class="listitem"><p><code class="literal">hg</code></p></li><li class="listitem"><p><code class="literal">cvs</code></p></li><li class="listitem"><p><code class="literal">bzr</code></p></li><li class="listitem"><p><code class="literal">svn</code></p></li></ul></div><p>The hash is printed to stdout.</p></li><li class="listitem"><p>Prefetch by package source (with <code class="literal">nix-prefetch-url &#x27;&lt;nixpkgs&gt;&#x27; -A &lt;package&gt;.src</code>, where <code class="literal">&lt;package&gt;</code> is package attribute name).
The hash is printed to stdout.</p><p>This works well when you’ve upgraded the existing package version and want to find out new hash, but is useless if the package can’t be accessed by attribute or the package has multiple sources (<code class="literal">.srcs</code>, architecture-dependent sources, etc).</p></li><li class="listitem"><p>Upstream hash: use it when upstream provides <code class="literal">sha256</code> or <code class="literal">sha512</code>.
Don’t use it when upstream provides <code class="literal">md5</code>, compute <code class="literal">sha256</code> instead.</p><p>A little nuance is that <code class="literal">nix-prefetch-*</code> tools produce hashes with the <code class="literal">nix32</code> encoding (a Nix-specific base32 adaptation), but upstream usually provides hexadecimal (<code class="literal">base16</code>) encoding.
Fetchers understand both formats.
Nixpkgs does not standardise on any one format.</p><p>You can convert between hash formats with <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/nix-hash"  target="_top"><code class="literal">nix-hash</code></a>.</p></li><li class="listitem"><p>Extract the hash from a local source archive with <code class="literal">sha256sum</code>.
Use <code class="literal">nix-prefetch-url file:///path/to/archive</code> if you want the custom Nix <code class="literal">base32</code> hash.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-fetchers-secure-hashes" class="title" style="clear: both">Obtaining hashes securely   </h2>  </div> </div></div><p>It’s always a good idea to avoid Man-in-the-Middle (MITM) attacks when downloading source contents.
Otherwise, you could unknowingly download malware instead of the intended source, and instead of the actual source hash, you’ll end up using the hash of malware.
Here are security considerations for this scenario:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">http://</code> URLs are not secure to prefetch hashes.</p></li><li class="listitem"><p>Upstream hashes should be obtained via a secure protocol.</p></li><li class="listitem"><p><code class="literal">https://</code> URLs give you more protections when using <code class="literal">nix-prefetch-*</code> or for upstream hashes.</p></li><li class="listitem"><p><code class="literal">https://</code> URLs are secure when using the <a class="link" href="index.html#sec-pkgs-fetchers-updating-source-hashes-fakehash-method"  >fake hash method</a> <span class="emphasis"><em>only if</em></span> you use one of the listed fake hashes.
If you use any other hash, the download will be exposed to MITM attacks even if you use HTTPS URLs.</p><p>In more concrete terms, if you use any other hash, the <a class="link" href="https://curl.se/docs/manpage.html#-k"  target="_top"><code class="literal">--insecure</code> flag</a> will be passed to the underlying call to <code class="literal">curl</code> when downloading content.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-fetchers-proxy" class="title" style="clear: both">Proxy usage   </h2>  </div> </div></div><p>Nixpkgs fetchers can make use of a http(s) proxy. Each fetcher will automatically inherit proxy-related environment variables (<code class="literal">http_proxy</code>, <code class="literal">https_proxy</code>, etc) via <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes#adv-attr-impureEnvVars"  target="_top">impureEnvVars</a>.</p><p>The environment variable <code class="literal">NIX_SSL_CERT_FILE</code> is also inherited in fetchers, and can be used to provide a custom certificate bundle to fetchers. This is usually required for a https proxy to work without certificate validation errors.</p><p>To use a temporary Tor instance as a proxy for fetching from <code class="literal">.onion</code> addresses, add <code class="literal">nativeBuildInputs = [ tor.proxyHook ];</code> to the fetcher parameters.</p><p><span id="fetchurl"></span></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-fetchers-fetchurl" class="title" style="clear: both"><code class="literal">fetchurl</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-pkgs-fetchers-fetchurl-inputs">Inputs</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-pkgs-fetchers-fetchurl-passthru-outputs">Passthru outputs</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-pkgs-fetchers-fetchurl-examples">Examples</a> </span></dt> </dl></div><p><code class="literal">fetchurl</code> returns a <a class="link" href="https://nixos.org/manual/nix/stable/glossary.html#gloss-fixed-output-derivation"  target="_top">fixed-output derivation</a> which downloads content from a given URL and stores the unaltered contents within the Nix store.</p><p>It uses <a class="link" href="https://curl.se/docs/manpage.html" target="_top"><span class="citerefentry"><span class="refentrytitle">curl</span>(1)</span></a> internally, and allows its behaviour to be modified by specifying a few attributes in the argument to <code class="literal">fetchurl</code> (see the documentation for attributes <code class="literal">curlOpts</code>, <code class="literal">curlOptsList</code>, and <code class="literal">netrcPhase</code>).</p><p>The resulting <a class="link" href="https://nixos.org/manual/nix/stable/store/store-path"  target="_top">store path</a> is determined by the hash given to <code class="literal">fetchurl</code>, and also the <code class="literal">name</code> (or <code class="literal">pname</code> and <code class="literal">version</code>) values.</p><p>If neither <code class="literal">name</code> nor <code class="literal">pname</code> and <code class="literal">version</code> are specified when calling <code class="literal">fetchurl</code>, it will default to using the <a class="link" href="https://nixos.org/manual/nix/stable/language/builtins.html#builtins-baseNameOf"  target="_top">basename</a> of <code class="literal">url</code> or the first element of <code class="literal">urls</code>.
If <code class="literal">pname</code> and <code class="literal">version</code> are specified, <code class="literal">fetchurl</code> will use those values and will ignore <code class="literal">name</code>, even if it is also specified.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs-fetchers-fetchurl-inputs" class="title" >Inputs   </h3>  </div> </div></div><p><code class="literal">fetchurl</code> requires an attribute set with the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">url</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The URL to download from.</p><div class="note"><h3 class="title">Note</h3><p>Either <code class="literal">url</code> or <code class="literal">urls</code> must be specified, but not both.</p></div><p>All URLs of the format <a class="link" href="https://curl.se/docs/url-syntax.html#rfc-3986-plus"  target="_top">specified here</a> are supported.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">urls</code> (List of String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A list of URLs, specifying download locations for the same content.
Each URL will be tried in order until one of them succeeds with some content or all of them fail.
See <a class="xref" href="index.html#ex-fetchers-fetchurl-nixpkgs-version-multiple-urls" title="Example 281. Using fetchurl to download a file with multiple possible URLs" >Example 281</a> to understand how this attribute affects the behaviour of <code class="literal">fetchurl</code>.</p><div class="note"><h3 class="title">Note</h3><p>Either <code class="literal">url</code> or <code class="literal">urls</code> must be specified, but not both.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">[]</code>.</p></dd><dt><span class="term"><code class="literal">hash</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Hash of the derivation output of <code class="literal">fetchurl</code>, following the format for integrity metadata as defined by <a class="link" href="https://www.w3.org/TR/SRI/"  target="_top">SRI</a>.
For more information, see <a class="xref" href="index.html#chap-pkgs-fetchers-caveats" title="Caveats" >the section called “Caveats”</a>.</p><div class="note"><h3 class="title">Note</h3><p>It is recommended that you use the <code class="literal">hash</code> attribute instead of the other hash-specific attributes that exist for backwards compatibility.</p><p>If <code class="literal">hash</code> is not specified, you must specify <code class="literal">outputHash</code> and <code class="literal">outputHashAlgo</code>, or one of <code class="literal">sha512</code>, <code class="literal">sha256</code>, or <code class="literal">sha1</code>.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">outputHash</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Hash of the derivation output of <code class="literal">fetchurl</code> in the format expected by Nix.
See <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes.html#adv-attr-outputHash"  target="_top">the documentation on the Nix manual</a> for more information about its format.</p><div class="note"><h3 class="title">Note</h3><p>It is recommended that you use the <code class="literal">hash</code> attribute instead.</p><p>If <code class="literal">outputHash</code> is specified, you must also specify <code class="literal">outputHashAlgo</code>.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">outputHashAlgo</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Algorithm used to generate the value specified in <code class="literal">outputHash</code>.
See <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes.html#adv-attr-outputHashAlgo"  target="_top">the documentation on the Nix manual</a> for more information about the values it supports.</p><div class="note"><h3 class="title">Note</h3><p>It is recommended that you use the <code class="literal">hash</code> attribute instead.</p><p>The value specified in <code class="literal">outputHashAlgo</code> will be ignored if <code class="literal">outputHash</code> isn’t also specified.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">sha1</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>SHA-1 hash of the derivation output of <code class="literal">fetchurl</code> in the format expected by Nix.
See <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes.html#adv-attr-outputHash"  target="_top">the documentation on the Nix manual</a> for more information about its format.</p><div class="note"><h3 class="title">Note</h3><p>It is recommended that you use the <code class="literal">hash</code> attribute instead.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">sha256</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>SHA-256 hash of the derivation output of <code class="literal">fetchurl</code> in the format expected by Nix.
See <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes.html#adv-attr-outputHash"  target="_top">the documentation on the Nix manual</a> for more information about its format.</p><div class="note"><h3 class="title">Note</h3><p>It is recommended that you use the <code class="literal">hash</code> attribute instead.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">sha512</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>SHA-512 hash of the derivation output of <code class="literal">fetchurl</code> in the format expected by Nix.
See <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes.html#adv-attr-outputHash"  target="_top">the documentation on the Nix manual</a> for more information about its format.</p><div class="note"><h3 class="title">Note</h3><p>It is recommended that you use the <code class="literal">hash</code> attribute instead.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">name</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The symbolic name of the downloaded file when saved in the Nix store.
See <a class="link" href="index.html#sec-pkgs-fetchers-fetchurl" title="fetchurl" >the <code class="literal">fetchurl</code> overview</a> for details on how the name of the file is decided.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">pname</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A base name, which will be combined with <code class="literal">version</code> to form the symbolic name of the downloaded file when saved in the Nix store.
See <a class="link" href="index.html#sec-pkgs-fetchers-fetchurl" title="fetchurl" >the <code class="literal">fetchurl</code> overview</a> for details on how the name of the file is decided.</p><div class="note"><h3 class="title">Note</h3><p>If <code class="literal">pname</code> is specified, you must also specify <code class="literal">version</code>, otherwise <code class="literal">fetchurl</code> will ignore the value of <code class="literal">pname</code>.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">version</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A version, which will be combined with <code class="literal">pname</code> to form the symbolic name of the downloaded file when saved in the Nix store.
See <a class="link" href="index.html#sec-pkgs-fetchers-fetchurl" title="fetchurl" >the <code class="literal">fetchurl</code> overview</a> for details on how the name of the file is decided.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">recursiveHash</code> (Boolean; <span class="emphasis"><em>optional</em></span>) <span id="sec-pkgs-fetchers-fetchurl-inputs-recursiveHash"></span></span></dt><dd><p>If set to <code class="literal">true</code>, will signal to Nix that the hash given to <code class="literal">fetchurl</code> was calculated using the <code class="literal">&quot;recursive&quot;</code> mode.
See <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes.html#adv-attr-outputHashMode"  target="_top">the documentation on the Nix manual</a> for more information about the existing modes.</p><p>By default, <code class="literal">fetchurl</code> uses <code class="literal">&quot;recursive&quot;</code> mode when the <code class="literal">executable</code> attribute is set to <code class="literal">true</code>, so you don’t need to specify <code class="literal">recursiveHash</code> in this case.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">executable</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>If <code class="literal">true</code>, sets the executable bit on the downloaded file.</p><p><span class="emphasis"><em>Default value</em></span>: <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">downloadToTemp</code> (Boolean; <span class="emphasis"><em>optional</em></span>) <span id="sec-pkgs-fetchers-fetchurl-inputs-downloadToTemp"></span></span></dt><dd><p>If <code class="literal">true</code>, saves the downloaded file to a temporary location instead of the expected Nix store location.
This is useful when used in conjunction with <code class="literal">postFetch</code> attribute, otherwise <code class="literal">fetchurl</code> will not produce any meaningful output.</p><p>The location of the downloaded file will be set in the <code class="literal">$downloadedFile</code> variable, which should be used by the script in the <code class="literal">postFetch</code> attribute.
See <a class="xref" href="index.html#ex-fetchers-fetchurl-nixpkgs-version-postfetch" title="Example 282. Manipulating the content downloaded by fetchurl" >Example 282</a> to understand how to work with this attribute.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">postFetch</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Script executed after the file has been downloaded successfully, and before <code class="literal">fetchurl</code> finishes running.
Useful for post-processing, to check or transform the file in some way.
See <a class="xref" href="index.html#ex-fetchers-fetchurl-nixpkgs-version-postfetch" title="Example 282. Manipulating the content downloaded by fetchurl" >Example 282</a> to understand how to work with this attribute.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">netrcPhase</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Script executed to create a <a class="link" href="https://man.cx/netrc" target="_top"><span class="citerefentry"><span class="refentrytitle">netrc</span>(5)</span></a> file to be used with <a class="link" href="https://curl.se/docs/manpage.html" target="_top"><span class="citerefentry"><span class="refentrytitle">curl</span>(1)</span></a>.
The script should create the <code class="literal">netrc</code> file (note that it does not begin with a “.”) in the directory it’s currently running in (<code class="literal">$PWD</code>).</p><p>The script is executed during the setup done by <code class="literal">fetchurl</code> before it runs any of its code to download the specified content.</p><div class="note"><h3 class="title">Note</h3><p>If specified, <code class="literal">fetchurl</code> will automatically alter its invocation of <a class="link" href="https://curl.se/docs/manpage.html" target="_top"><span class="citerefentry"><span class="refentrytitle">curl</span>(1)</span></a> to use the <code class="literal">netrc</code> file, so you don’t need to add anything to <code class="literal">curlOpts</code> or <code class="literal">curlOptsList</code>.</p></div><div class="caution"><h3 class="title">Caution</h3><p>Since <code class="literal">netrcPhase</code> needs to be specified in your source Nix code, any secrets that you put directly in it will be world-readable by design (both in your source code, and when the derivation gets created in the Nix store).</p><p>If you want to avoid this behaviour, see the documentation of <code class="literal">netrcImpureEnvVars</code> for an alternative way of dealing with these secrets.</p></div><p><span class="emphasis"><em>Default value</em></span>: <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">netrcImpureEnvVars</code> (List of String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>If specified, <code class="literal">fetchurl</code> will add these environment variable names to the list of <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes.html#adv-attr-impureEnvVars"  target="_top">impure environment variables</a>, which will be passed from the environment of the calling user to the builder running the <code class="literal">fetchurl</code> code.</p><p>This is useful when used with <code class="literal">netrcPhase</code> to hide any secrets that are used in it, because the script in <code class="literal">netrcPhase</code> only needs to reference the environment variables with the secrets in them instead.
However, note that these are called <span class="emphasis"><em>impure</em></span> variables for a reason:
the environment that starts the build needs to have these variables declared for everything to work properly, which means that additional setup is required outside what Nix controls.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">[]</code>.</p></dd><dt><span class="term"><code class="literal">curlOpts</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>If specified, this value will be appended to the invocation of <a class="link" href="https://curl.se/docs/manpage.html" target="_top"><span class="citerefentry"><span class="refentrytitle">curl</span>(1)</span></a> when downloading the URL(s) given to <code class="literal">fetchurl</code>.
Multiple arguments can be separated by spaces normally, but values with whitespaces will be interpreted as multiple arguments (instead of a single value), even if the value is escaped.
See <code class="literal">curlOptsList</code> for a way to pass values with whitespaces in them.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">curlOptsList</code> (List of String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>If specified, each element of this list will be passed as an argument to the invocation of <a class="link" href="https://curl.se/docs/manpage.html" target="_top"><span class="citerefentry"><span class="refentrytitle">curl</span>(1)</span></a> when downloading the URL(s) given to <code class="literal">fetchurl</code>.
This allows passing values that contain spaces, with no escaping needed.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">[]</code>.</p></dd><dt><span class="term"><code class="literal">showURLs</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>If set to <code class="literal">true</code>, this will stop <code class="literal">fetchurl</code> from downloading anything at all.
Instead, it will output a list of all the URLs it would’ve used to download the content (after resolving <code class="literal">mirror://</code> URLs, for example).
This is useful for debugging.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">meta</code> (Attribute Set; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Specifies any <a class="link" href="index.html#chap-meta" title="Meta-attributes" >meta-attributes</a> for the derivation returned by <code class="literal">fetchurl</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">{}</code>.</p></dd><dt><span class="term"><code class="literal">passthru</code> (Attribute Set; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Specifies any extra <a class="link" href="index.html#chap-passthru" title="Passthru-attributes" ><code class="literal">passthru</code></a> attributes for the derivation returned by <code class="literal">fetchurl</code>.
Note that <code class="literal">fetchurl</code> defines <a class="link" href="index.html#ssec-pkgs-fetchers-fetchurl-passthru-outputs" title="Passthru outputs" ><code class="literal">passthru</code> attributes of its own</a>.
Attributes specified in <code class="literal">passthru</code> can override the default attributes returned by <code class="literal">fetchurl</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">{}</code>.</p></dd><dt><span class="term"><code class="literal">preferLocalBuild</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>This is the same attribute as <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes.html#adv-attr-preferLocalBuild"  target="_top">defined in the Nix manual</a>.
It is <code class="literal">true</code> by default because making a remote machine download the content just duplicates network traffic (since the local machine might download the results from the derivation anyway), but this could be useful in cases where network access is restricted on local machines.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">true</code>.</p></dd><dt><span class="term"><code class="literal">nativeBuildInputs</code> (List of Attribute Set; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Additional packages needed to download the content.
This is useful if you need extra packages for <code class="literal">postFetch</code> or <code class="literal">netrcPhase</code>, for example.
Has the same semantics as in <a class="xref" href="index.html#var-stdenv-nativeBuildInputs" title="nativeBuildInputs" >the section called “<code class="literal">nativeBuildInputs</code>”</a>.
See <a class="xref" href="index.html#ex-fetchers-fetchurl-nixpkgs-version-postfetch" title="Example 282. Manipulating the content downloaded by fetchurl" >Example 282</a> to understand how this can be used with <code class="literal">postFetch</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">[]</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-fetchers-fetchurl-passthru-outputs" class="title" >Passthru outputs   </h3>  </div> </div></div><p><code class="literal">fetchurl</code> also defines its own <a class="link" href="index.html#chap-passthru" title="Passthru-attributes" ><code class="literal">passthru</code></a> attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">url</code> (String)</span></dt><dd><p>The same <code class="literal">url</code> attribute passed in the argument to <code class="literal">fetchurl</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-fetchers-fetchurl-examples" class="title" >Examples   </h3>  </div> </div></div><div class="example"><span id="ex-fetchers-fetchurl-nixpkgs-version" ></span><details><summary><span class="title"><strong>Example 280. Using <code class="literal">fetchurl</code> to download a file</strong></span></summary><div class="example-contents"><p>The following package downloads a small file from a URL and shows the most common way to use <code class="literal">fetchurl</code>:</p><pre><code class="programlisting nix">{ fetchurl }:
fetchurl {
  url = &quot;https://raw.githubusercontent.com/NixOS/nixpkgs/23.11/.version&quot;;
  hash = &quot;sha256-BZqI7r0MNP29yGH5+yW2tjU9OOpOCEvwWKrWCv5CQ0I=&quot;;
}
</code></pre><p>After building the package, the file will be downloaded and place into the Nix store:</p><pre><code class="programlisting shell">$ nix-build
(output removed for clarity)
/nix/store/4g9y3x851wqrvim4zcz5x2v3zivmsq8n-version

$ cat /nix/store/4g9y3x851wqrvim4zcz5x2v3zivmsq8n-version
23.11
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-fetchers-fetchurl-nixpkgs-version-multiple-urls" ></span><details><summary><span class="title"><strong>Example 281. Using <code class="literal">fetchurl</code> to download a file with multiple possible URLs</strong></span></summary><div class="example-contents"><p>The following package adapts <a class="xref" href="index.html#ex-fetchers-fetchurl-nixpkgs-version" title="Example 280. Using fetchurl to download a file" >Example 280</a> to use multiple URLs.
The first URL was crafted to intentionally return an error to illustrate how <code class="literal">fetchurl</code> will try multiple URLs until it finds one that works (or all URLs fail).</p><pre><code class="programlisting nix">{ fetchurl }:
fetchurl {
  urls = [
    &quot;https://raw.githubusercontent.com/NixOS/nixpkgs/23.11/does-not-exist&quot;
    &quot;https://raw.githubusercontent.com/NixOS/nixpkgs/23.11/.version&quot;
  ];
  hash = &quot;sha256-BZqI7r0MNP29yGH5+yW2tjU9OOpOCEvwWKrWCv5CQ0I=&quot;;
}
</code></pre><p>After building the package, both URLs will be used to download the file:</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
trying https://raw.githubusercontent.com/NixOS/nixpkgs/23.11/does-not-exist
(some output removed for clarity)
curl: (22) The requested URL returned error: 404

trying https://raw.githubusercontent.com/NixOS/nixpkgs/23.11/.version
(some output removed for clarity)
/nix/store/n9asny31z32q7sdw6a8r1gllrsfy53kl-does-not-exist

$ cat /nix/store/n9asny31z32q7sdw6a8r1gllrsfy53kl-does-not-exist
23.11
</code></pre><p>However, note that the name of the file was derived from the first URL (this is further explained in <a class="link" href="index.html#sec-pkgs-fetchers-fetchurl" title="fetchurl" >the <code class="literal">fetchurl</code> overview</a>).
To ensure the result will have the same name regardless of which URLs are used, we can modify the package:</p><pre><code class="programlisting nix">{ fetchurl }:
fetchurl {
  name = &quot;nixpkgs-version&quot;;
  urls = [
    &quot;https://raw.githubusercontent.com/NixOS/nixpkgs/23.11/does-not-exist&quot;
    &quot;https://raw.githubusercontent.com/NixOS/nixpkgs/23.11/.version&quot;
  ];
  hash = &quot;sha256-BZqI7r0MNP29yGH5+yW2tjU9OOpOCEvwWKrWCv5CQ0I=&quot;;
}
</code></pre><p>After building the package, the result will have the name we specified:</p><pre><code class="programlisting shell">$ nix-build
(output removed for clarity)
/nix/store/zczb6wl3al6jm9sm5h3pr6nqn0i5ji9z-nixpkgs-version
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-fetchers-fetchurl-nixpkgs-version-postfetch" ></span><details><summary><span class="title"><strong>Example 282. Manipulating the content downloaded by <code class="literal">fetchurl</code></strong></span></summary><div class="example-contents"><p>It might be useful to manipulate the content downloaded by <code class="literal">fetchurl</code> directly in its derivation.
In this example, we’ll adapt <a class="xref" href="index.html#ex-fetchers-fetchurl-nixpkgs-version" title="Example 280. Using fetchurl to download a file" >Example 280</a> to append the result of running the <code class="literal">hello</code> package to the contents we download, purely to illustrate how to manipulate the content.</p><pre><code class="programlisting nix">{
  fetchurl,
  hello,
  lib,
}:
fetchurl {
  url = &quot;https://raw.githubusercontent.com/NixOS/nixpkgs/23.11/.version&quot;;

  nativeBuildInputs = [ hello ];

  downloadToTemp = true;
  postFetch = &#x27;&#x27;
    ${lib.getExe hello} &gt;&gt; $downloadedFile
    mv $downloadedFile $out
  &#x27;&#x27;;

  hash = &quot;sha256-ceooQQYmDx5+0nfg40uU3NNI2yKrixP7HZ/xLZUNv+w=&quot;;
}
</code></pre><p>After building the package, the resulting file will have “Hello, world!” appended to it:</p><pre><code class="programlisting shell">$ nix-build
(output removed for clarity)
/nix/store/ifi6pp7q0ag5h7c5v9h1c1c7bhd10c7f-version

$ cat /nix/store/ifi6pp7q0ag5h7c5v9h1c1c7bhd10c7f-version
23.11
Hello, world!
</code></pre><p>Note that the <code class="literal">hash</code> specified in the package is different than the hash specified in <a class="xref" href="index.html#ex-fetchers-fetchurl-nixpkgs-version" title="Example 280. Using fetchurl to download a file" >Example 280</a>, because the contents of the output have changed (even though the actual file that was downloaded is the same).
See <a class="xref" href="index.html#chap-pkgs-fetchers-caveats" title="Caveats" >the section called “Caveats”</a> for more details on how to work with the <code class="literal">hash</code> attribute when the output changes.</p></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-fetchers-fetchzip" class="title" style="clear: both"><code class="literal">fetchzip</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-pkgs-fetchers-fetchzip-inputs">Inputs</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-fetchers-fetchzip-examples">Examples</a> </span></dt> </dl></div><p>Returns a <a class="link" href="https://nixos.org/manual/nix/stable/glossary.html#gloss-fixed-output-derivation"  target="_top">fixed-output derivation</a> which downloads an archive from a given URL and decompresses it.</p><p>Despite its name, <code class="literal">fetchzip</code> is not limited to <code class="literal">.zip</code> files but can also be used with <a class="link" href="index.html#tar-files" title="Tar files" >various compressed tarball formats</a> by default.
This can extended by specifying additional attributes, see <a class="xref" href="index.html#ex-fetchers-fetchzip-rar-archive" title="Example 284. Using fetchzip to decompress a .rar file" >Example 284</a> to understand how to do that.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs-fetchers-fetchzip-inputs" class="title" >Inputs   </h3>  </div> </div></div><p><code class="literal">fetchzip</code> requires an attribute set, and most attributes are passed to the underlying call to <a class="link" href="index.html#sec-pkgs-fetchers-fetchurl" title="fetchurl" ><code class="literal">fetchurl</code></a>.</p><p>The attributes below are treated differently by <code class="literal">fetchzip</code> when compared to what <code class="literal">fetchurl</code> expects:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Works as defined in <code class="literal">fetchurl</code>, but has a different default value than <code class="literal">fetchurl</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;source&quot;</code>.</p></dd><dt><span class="term"><code class="literal">nativeBuildInputs</code> (List of Attribute Set; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Works as defined in <code class="literal">fetchurl</code>, but it is also augmented by <code class="literal">fetchzip</code> to include packages to deal with additional archives (such as <code class="literal">.zip</code>).</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">[]</code>.</p></dd><dt><span class="term"><code class="literal">postFetch</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Works as defined in <code class="literal">fetchurl</code>, but it is also augmented with the code needed to make <code class="literal">fetchzip</code> work.</p><div class="caution"><h3 class="title">Caution</h3><p>It is only safe to modify files in <code class="literal">$out</code> in <code class="literal">postFetch</code>.
Consult the implementation of <code class="literal">fetchzip</code> for anything more involved.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">stripRoot</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>If <code class="literal">true</code>, the decompressed contents are moved one level up the directory tree.</p><p>This is useful for archives that decompress into a single directory which commonly includes some values that change with time, such as version numbers.
When this is the case (and <code class="literal">stripRoot</code> is <code class="literal">true</code>), <code class="literal">fetchzip</code> will remove this directory and make the decompressed contents available in the top-level directory.</p><p><a class="xref" href="index.html#ex-fetchers-fetchzip-simple-striproot" title="Example 283. Using fetchzip to output contents directly" >Example 283</a> shows what this attribute does.</p><p>This attribute is <span class="strong"><strong>not</strong></span> passed through to <code class="literal">fetchurl</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">true</code>.</p></dd><dt><span class="term"><code class="literal">extension</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>If set, the archive downloaded by <code class="literal">fetchzip</code> will be renamed to a filename with the extension specified in this attribute.</p><p>This is useful when making <code class="literal">fetchzip</code> support additional types of archives, because the implementation may use the extension of an archive to determine whether they can decompress it.
If the URL you’re using to download the contents doesn’t end with the extension associated with the archive, use this attribute to fix the filename of the archive.</p><p>This attribute is <span class="strong"><strong>not</strong></span> passed through to <code class="literal">fetchurl</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">recursiveHash</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Works <a class="link" href="index.html#sec-pkgs-fetchers-fetchurl-inputs-recursiveHash"  >as defined in <code class="literal">fetchurl</code></a>, but its default value is different than for <code class="literal">fetchurl</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">true</code>.</p></dd><dt><span class="term"><code class="literal">downloadToTemp</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Works <a class="link" href="index.html#sec-pkgs-fetchers-fetchurl-inputs-downloadToTemp"  >as defined in <code class="literal">fetchurl</code></a>, but its default value is different than for <code class="literal">fetchurl</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">true</code>.</p></dd><dt><span class="term"><code class="literal">extraPostFetch</code> <span class="strong"><strong>DEPRECATED</strong></span></span></dt><dd><p>This attribute is deprecated.
Please use <code class="literal">postFetch</code> instead.</p><p>This attribute is <span class="strong"><strong>not</strong></span> passed through to <code class="literal">fetchurl</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs-fetchers-fetchzip-examples" class="title" >Examples   </h3>  </div> </div></div><div class="example"><span id="ex-fetchers-fetchzip-simple-striproot" ></span><details><summary><span class="title"><strong>Example 283. Using <code class="literal">fetchzip</code> to output contents directly</strong></span></summary><div class="example-contents"><p>The following recipe shows how to use <code class="literal">fetchzip</code> to decompress a <code class="literal">.tar.gz</code> archive:</p><pre><code class="programlisting nix">{ fetchzip }:
fetchzip {
  url = &quot;https://github.com/NixOS/patchelf/releases/download/0.18.0/patchelf-0.18.0.tar.gz&quot;;
  hash = &quot;sha256-3ABYlME9R8klcpJ7MQpyFEFwHmxDDEzIYBqu/CpDYmg=&quot;;
}
</code></pre><p>This archive has all its contents in a directory named <code class="literal">patchelf-0.18.0</code>.
This means that after decompressing, you’d have to enter this directory to see the contents of the archive.
However, <code class="literal">fetchzip</code> makes this easier through the attribute <code class="literal">stripRoot</code> (enabled by default).</p><p>After building the recipe, the derivation output will show all the files in the archive at the top level:</p><pre><code class="programlisting shell">$ nix-build
(output removed for clarity)
/nix/store/1b7h3fvmgrcddvs0m299hnqxlgli1yjw-source

$ ls /nix/store/1b7h3fvmgrcddvs0m299hnqxlgli1yjw-source
aclocal.m4  completions  configure.ac  m4           Makefile.in  patchelf.spec     README.md  tests
build-aux   configure    COPYING       Makefile.am  patchelf.1   patchelf.spec.in  src        version
</code></pre><p>If <code class="literal">stripRoot</code> is set to <code class="literal">false</code>, the derivation output will be the decompressed archive as-is:</p><pre><code class="programlisting nix">{ fetchzip }:
fetchzip {
  url = &quot;https://github.com/NixOS/patchelf/releases/download/0.18.0/patchelf-0.18.0.tar.gz&quot;;
  hash = &quot;sha256-uv3FuKE4DqpHT3yfE0qcnq0gYjDNQNKZEZt2+PUAneg=&quot;;
  stripRoot = false;
}
</code></pre><div class="caution"><h3 class="title">Caution</h3><p>The hash changed!
Whenever changing attributes of a Nixpkgs fetcher, <a class="link" href="index.html#chap-pkgs-fetchers-caveats" title="Caveats" >remember to invalidate the hash</a>, otherwise you won’t get the results you’re expecting!</p></div><p>After building the recipe:</p><pre><code class="programlisting shell">$ nix-build
(output removed for clarity)
/nix/store/2hy5bxw7xgbgxkn0i4x6hjr8w3dbx16c-source

$ ls /nix/store/2hy5bxw7xgbgxkn0i4x6hjr8w3dbx16c-source
patchelf-0.18.0
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-fetchers-fetchzip-rar-archive" ></span><details><summary><span class="title"><strong>Example 284. Using <code class="literal">fetchzip</code> to decompress a <code class="literal">.rar</code> file</strong></span></summary><div class="example-contents"><p>The <code class="literal">unrar</code> package provides a <a class="link" href="index.html#ssec-setup-hooks" title="Package setup hooks" >setup hook</a> to decompress <code class="literal">.rar</code> archives during the <a class="link" href="index.html#ssec-unpack-phase" title="The unpack phase" >unpack phase</a>, which can be used with <code class="literal">fetchzip</code> to decompress those archives:</p><pre><code class="programlisting nix">{ fetchzip, unrar }:
fetchzip {
  url = &quot;https://archive.org/download/SpaceCadet_Plus95/Space_Cadet.rar&quot;;
  hash = &quot;sha256-fC+zsR8BY6vXpUkVd6i1jF0IZZxVKVvNi6VWCKT+pA4=&quot;;
  stripRoot = false;
  nativeBuildInputs = [ unrar ];
}
</code></pre><p>Since this particular <code class="literal">.rar</code> file doesn’t put its contents in a directory inside the archive, <code class="literal">stripRoot</code> must be set to <code class="literal">false</code>.</p><p>After building the recipe, the derivation output will show the decompressed files:</p><pre><code class="programlisting shell">$ nix-build
(output removed for clarity)
/nix/store/zpn7knxfva6rfjja2gbb4p3l9w1f0d36-source

$ ls /nix/store/zpn7knxfva6rfjja2gbb4p3l9w1f0d36-source
FONT.DAT      PINBALL.DAT  PINBALL.EXE	PINBALL2.MID  TABLE.BMP    WMCONFIG.EXE
MSCREATE.DIR  PINBALL.DOC  PINBALL.MID	Sounds	     WAVEMIX.INF
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchpatch" class="title" style="clear: both"><code class="literal">fetchpatch</code>   </h2>  </div> </div></div><p><code class="literal">fetchpatch</code> works very similarly to <code class="literal">fetchurl</code> with the same arguments expected. It expects patch files as a source and performs normalization on them before computing the checksum. For example, it will remove comments or other unstable parts that are sometimes added by version control systems and can change over time.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">relative</code>: Similar to using <code class="literal">git-diff</code>’s <code class="literal">--relative</code> flag, only keep changes inside the specified directory, making paths relative to it.</p></li><li class="listitem"><p><code class="literal">stripLen</code>: Remove the first <code class="literal">stripLen</code> components of pathnames in the patch.</p></li><li class="listitem"><p><code class="literal">decode</code>: Pipe the downloaded data through this command before processing it as a patch.</p></li><li class="listitem"><p><code class="literal">extraPrefix</code>: Prefix pathnames by this string.</p></li><li class="listitem"><p><code class="literal">excludes</code>: Exclude files matching these patterns (applies after the above arguments).</p></li><li class="listitem"><p><code class="literal">includes</code>: Include only files matching these patterns (applies after the above arguments).</p></li><li class="listitem"><p><code class="literal">revert</code>: Revert the patch.</p></li></ul></div><p>Note that because the checksum is computed after applying these effects, using or modifying these arguments will have no effect unless the <code class="literal">hash</code> argument is changed as well.</p><p>Most other fetchers return a directory rather than a single file.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchdebianpatch" class="title" style="clear: both"><code class="literal">fetchDebianPatch</code>   </h2>  </div> </div></div><p>A wrapper around <code class="literal">fetchpatch</code>, which takes:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">patch</code> and <code class="literal">hash</code>: the patch’s filename,
and its hash after normalization by <code class="literal">fetchpatch</code> ;</p></li><li class="listitem"><p><code class="literal">pname</code>: the Debian source package’s name ;</p></li><li class="listitem"><p><code class="literal">version</code>: the upstream version number ;</p></li><li class="listitem"><p><code class="literal">debianRevision</code>: the <a class="link" href="https://www.debian.org/doc/debian-policy/ch-controlfields.html#version"  target="_top">Debian revision number</a> if applicable ;</p></li><li class="listitem"><p>the <code class="literal">area</code> of the Debian archive: <code class="literal">main</code> (default), <code class="literal">contrib</code>, or <code class="literal">non-free</code>.</p></li></ul></div><p>Here is an example of <code class="literal">fetchDebianPatch</code> in action:</p><pre><code class="programlisting nix">{
  lib,
  fetchDebianPatch,
  buildPythonPackage,
}:

buildPythonPackage rec {
  pname = &quot;pysimplesoap&quot;;
  version = &quot;1.16.2&quot;;
  src = &lt;...&gt;;

  patches = [
    (fetchDebianPatch {
      inherit pname version;
      debianRevision = &quot;5&quot;;
      patch = &quot;Add-quotes-to-SOAPAction-header-in-SoapClient.patch&quot;;
      hash = &quot;sha256-xA8Wnrpr31H8wy3zHSNfezFNjUJt1HbSXn3qUMzeKc0=&quot;;
    })
  ];

  # ...
}
</code></pre><p>Patches are fetched from <code class="literal">sources.debian.org</code>, and so must come from a
package version that was uploaded to the Debian archive.  Packages may
be removed from there once that specific version isn’t in any suite
anymore (stable, testing, unstable, etc.), so maintainers should use
<code class="literal">copy-tarballs.pl</code> to archive the patch if it needs to be available
longer-term.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchsvn" class="title" style="clear: both"><code class="literal">fetchsvn</code>   </h2>  </div> </div></div><p>Used with Subversion. Expects <code class="literal">url</code> to a Subversion directory, <code class="literal">rev</code>, and <code class="literal">hash</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchgit" class="title" style="clear: both"><code class="literal">fetchgit</code>   </h2>  </div> </div></div><p>Used with Git. Expects <code class="literal">url</code> to a Git repo, <code class="literal">rev</code>, and <code class="literal">hash</code>. <code class="literal">rev</code> in this case can be full the git commit id (SHA1 hash) or a tag name like <code class="literal">refs/tags/v1.0</code>.</p><p>If you want to fetch a tag you should pass the <code class="literal">tag</code> parameter instead of <code class="literal">rev</code> which has the same effect as setting <code class="literal">rev = &quot;refs/tags&quot;/${version}&quot;</code>.
This is safer than just setting <code class="literal">rev = version</code> w.r.t. possible branch and tag name conflicts.</p><p>Additionally, the following optional arguments can be given:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em><code class="literal">fetchSubmodules</code></em></span> (Boolean)</span></dt><dd><p>Whether to also fetch the submodules of a repository.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">fetchLFS</code></em></span> (Boolean)</span></dt><dd><p>Whether to fetch LFS objects.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">preFetch</code></em></span> (String)</span></dt><dd><p>Shell code to be executed before the repository has been fetched, to allow
changing the environment the fetcher runs in.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">postFetch</code></em></span> (String)</span></dt><dd><p>Shell code executed after the repository has been fetched successfully.
This can do things like check or transform the file.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">leaveDotGit</code></em></span> (Boolean)</span></dt><dd><p>Whether the <code class="literal">.git</code> directory of the clone should <span class="emphasis"><em>not</em></span> be removed after checkout.</p><p>Be warned though that the git repository format is not stable and this flag is therefore not suitable for actual use by itself.
Only use this for testing purposes or in conjunction with removing the <code class="literal">.git</code> directory in <code class="literal">postFetch</code>.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">deepClone</code></em></span> (Boolean)</span></dt><dd><p>Clone the entire repository as opposing to just creating a shallow clone.
This implies <code class="literal">leaveDotGit</code>.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">fetchTags</code></em></span> (Boolean)</span></dt><dd><p>Whether to fetch all tags from the remote repository. This is useful when the build process needs to run <code class="literal">git describe</code> or other commands that require tag information to be available. This parameter implies <code class="literal">leaveDotGit</code>, as tags are stored in the <code class="literal">.git</code> directory.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">sparseCheckout</code></em></span> (List of String)</span></dt><dd><p>Prevent git from fetching unnecessary blobs from server.
This is useful if only parts of the repository are needed.</p><div class="example"><span id="ex-fetchgit-sparseCheckout" ></span><details><summary><span class="title"><strong>Example 285. Use <code class="literal">sparseCheckout</code> to only include some directories:</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ stdenv, fetchgit }:

stdenv.mkDerivation {
  name = &quot;hello&quot;;
  src = fetchgit {
    url = &quot;https://...&quot;;
    sparseCheckout = [
      &quot;directory/to/be/included&quot;
      &quot;another/directory&quot;
    ];
    hash = &quot;sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;;
  };
}
</code></pre></div></details></div><br class="example-break" /><p>See <a class="link" href="https://git-scm.com/docs/git-sparse-checkout"  target="_top">git sparse-checkout</a> for more information.</p></dd></dl></div><p>Some additional parameters for niche use-cases can be found listed in the function parameters in the declaration of <code class="literal">fetchgit</code>: <code class="literal">pkgs/build-support/fetchgit/default.nix</code>.
Future parameters additions might also happen without immediately being documented here.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchfossil" class="title" style="clear: both"><code class="literal">fetchfossil</code>   </h2>  </div> </div></div><p>Used with Fossil. Expects <code class="literal">url</code> to a Fossil archive, <code class="literal">rev</code>, and <code class="literal">hash</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchcvs" class="title" style="clear: both"><code class="literal">fetchcvs</code>   </h2>  </div> </div></div><p>Used with CVS. Expects <code class="literal">cvsRoot</code>, <code class="literal">tag</code>, and <code class="literal">hash</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchhg" class="title" style="clear: both"><code class="literal">fetchhg</code>   </h2>  </div> </div></div><p>Used with Mercurial. Expects <code class="literal">url</code>, <code class="literal">rev</code>, <code class="literal">hash</code>, overridable with <a class="link" href="index.html#sec-pkg-overrideAttrs" title="&lt;pkg&gt;.overrideAttrs" ><code class="literal">&lt;pkg&gt;.overrideAttrs</code></a>.</p><p>A number of fetcher functions wrap part of <code class="literal">fetchurl</code> and <code class="literal">fetchzip</code>. They are mainly convenience functions intended for commonly used destinations of source code in Nixpkgs. These wrapper fetchers are listed below.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchfromgitea" class="title" style="clear: both"><code class="literal">fetchFromGitea</code>   </h2>  </div> </div></div><p><code class="literal">fetchFromGitea</code> expects five arguments. <code class="literal">domain</code> is the gitea server name. <code class="literal">owner</code> is a string corresponding to the Gitea user or organization that controls this repository. <code class="literal">repo</code> corresponds to the name of the software repository. These are located at the top of every Gitea HTML page as <code class="literal">owner</code>/<code class="literal">repo</code>. <code class="literal">rev</code> corresponds to the Git commit hash or tag (e.g <code class="literal">v1.0</code>) that will be downloaded from Git. Finally, <code class="literal">hash</code> corresponds to the hash of the extracted directory. Again, other hash algorithms are also available but <code class="literal">hash</code> is currently preferred.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchfromgithub" class="title" style="clear: both"><code class="literal">fetchFromGitHub</code>   </h2>  </div> </div></div><p><code class="literal">fetchFromGitHub</code> expects four arguments. <code class="literal">owner</code> is a string corresponding to the GitHub user or organization that controls this repository. <code class="literal">repo</code> corresponds to the name of the software repository. These are located at the top of every GitHub HTML page as <code class="literal">owner</code>/<code class="literal">repo</code>. <code class="literal">rev</code> corresponds to the Git commit hash or tag (e.g <code class="literal">v1.0</code>) that will be downloaded from Git. If you need to fetch a tag however, you should prefer to use the <code class="literal">tag</code> parameter which achieves this in a safer way with less boilerplate. Finally, <code class="literal">hash</code> corresponds to the hash of the extracted directory. Again, other hash algorithms are also available, but <code class="literal">hash</code> is currently preferred.</p><p>To use a different GitHub instance, use <code class="literal">githubBase</code> (defaults to <code class="literal">&quot;github.com&quot;</code>).</p><p><code class="literal">fetchFromGitHub</code> uses <code class="literal">fetchzip</code> to download the source archive generated by GitHub for the specified revision. If <code class="literal">leaveDotGit</code>, <code class="literal">deepClone</code> or <code class="literal">fetchSubmodules</code> are set to <code class="literal">true</code>, <code class="literal">fetchFromGitHub</code> will use <code class="literal">fetchgit</code> instead. Refer to its section for documentation of these options.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchfromgitlab" class="title" style="clear: both"><code class="literal">fetchFromGitLab</code>   </h2>  </div> </div></div><p>This is used with GitLab repositories. It behaves similarly to <code class="literal">fetchFromGitHub</code>, and expects <code class="literal">owner</code>, <code class="literal">repo</code>, <code class="literal">rev</code>, and <code class="literal">hash</code>.</p><p>To use a specific GitLab instance, use <code class="literal">domain</code> (defaults to <code class="literal">&quot;gitlab.com&quot;</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchfromgitiles" class="title" style="clear: both"><code class="literal">fetchFromGitiles</code>   </h2>  </div> </div></div><p>This is used with Gitiles repositories. The arguments expected are similar to <code class="literal">fetchgit</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchfrombitbucket" class="title" style="clear: both"><code class="literal">fetchFromBitbucket</code>   </h2>  </div> </div></div><p>This is used with BitBucket repositories. The arguments expected are very similar to <code class="literal">fetchFromGitHub</code> above.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchfromsavannah" class="title" style="clear: both"><code class="literal">fetchFromSavannah</code>   </h2>  </div> </div></div><p>This is used with Savannah repositories. The arguments expected are very similar to <code class="literal">fetchFromGitHub</code> above.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchfromrepoorcz" class="title" style="clear: both"><code class="literal">fetchFromRepoOrCz</code>   </h2>  </div> </div></div><p>This is used with repo.or.cz repositories. The arguments expected are very similar to <code class="literal">fetchFromGitHub</code> above.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchfromsourcehut" class="title" style="clear: both"><code class="literal">fetchFromSourcehut</code>   </h2>  </div> </div></div><p>This is used with sourcehut repositories. Similar to <code class="literal">fetchFromGitHub</code> above,
it expects <code class="literal">owner</code>, <code class="literal">repo</code>, <code class="literal">rev</code> and <code class="literal">hash</code>, but don’t forget the tilde (~)
in front of the username! Expected arguments also include <code class="literal">vc</code> (“git” (default)
or “hg”), <code class="literal">domain</code> and <code class="literal">fetchSubmodules</code>.</p><p>If <code class="literal">fetchSubmodules</code> is <code class="literal">true</code>, <code class="literal">fetchFromSourcehut</code> uses <code class="literal">fetchgit</code>
or <code class="literal">fetchhg</code> with <code class="literal">fetchSubmodules</code> or <code class="literal">fetchSubrepos</code> set to <code class="literal">true</code>,
respectively. Otherwise, the fetcher uses <code class="literal">fetchzip</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="requirefile" class="title" style="clear: both"><code class="literal">requireFile</code>   </h2>  </div> </div></div><p><code class="literal">requireFile</code> allows requesting files that cannot be fetched automatically, but whose content is known.
This is a useful last-resort workaround for license restrictions that prohibit redistribution, or for downloads that are only accessible after authenticating interactively in a browser.
If the requested file is present in the Nix store, the resulting derivation will not be built, because its expected output is already available.
Otherwise, the builder will run, but fail with a message explaining to the user how to provide the file. The following code, for example:</p><pre><code class="programlisting nix">requireFile {
  name = &quot;jdk-${version}_linux-x64_bin.tar.gz&quot;;
  url = &quot;https://www.oracle.com/java/technologies/javase-jdk11-downloads.html&quot;;
  hash = &quot;sha256-lL00+F7jjT71nlKJ7HRQuUQ7kkxVYlZh//5msD8sjeI=&quot;;
}
</code></pre><p>results in this error message:</p><pre><code class="programlisting">***
Unfortunately, we cannot download file jdk-11.0.10_linux-x64_bin.tar.gz automatically.
Please go to https://www.oracle.com/java/technologies/javase-jdk11-downloads.html to download it yourself, and add it to the Nix store
using either
  nix-store --add-fixed sha256 jdk-11.0.10_linux-x64_bin.tar.gz
or
  nix-prefetch-url --type sha256 file:///path/to/jdk-11.0.10_linux-x64_bin.tar.gz

***
</code></pre><p>This function should only be used by non-redistributable software with an unfree license that we need to require the user to download manually.
It produces packages that cannot be built automatically.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="fetchtorrent" class="title" style="clear: both"><code class="literal">fetchtorrent</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#fetchtorrent-parameters">Parameters</a> </span></dt> </dl></div><p><code class="literal">fetchtorrent</code> expects two arguments. <code class="literal">url</code> which can either be a Magnet URI (Magnet Link) such as <code class="literal">magnet:?xt=urn:btih:dd8255ecdc7ca55fb0bbf81323d87062db1f6d1c</code> or an HTTP URL pointing to a <code class="literal">.torrent</code> file. It can also take a <code class="literal">config</code> argument which will craft a <code class="literal">settings.json</code> configuration file and give it to <code class="literal">transmission</code>, the underlying program that is performing the fetch. The available config options for <code class="literal">transmission</code> can be found <a class="link" href="https://github.com/transmission/transmission/blob/main/docs/Editing-Configuration-Files.md#options"  target="_top">here</a></p><pre><code class="programlisting nix">{ fetchtorrent }:

fetchtorrent {
  config = {
    peer-limit-global = 100;
  };
  url = &quot;magnet:?xt=urn:btih:dd8255ecdc7ca55fb0bbf81323d87062db1f6d1c&quot;;
  hash = &quot;&quot;;
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="fetchtorrent-parameters" class="title" >Parameters   </h3>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">url</code>: Magnet URI (Magnet Link) such as <code class="literal">magnet:?xt=urn:btih:dd8255ecdc7ca55fb0bbf81323d87062db1f6d1c</code> or an HTTP URL pointing to a <code class="literal">.torrent</code> file.</p></li><li class="listitem"><p><code class="literal">backend</code>: Which bittorrent program to use. Default: <code class="literal">&quot;transmission&quot;</code>. Valid values are <code class="literal">&quot;rqbit&quot;</code> or <code class="literal">&quot;transmission&quot;</code>. These are the two most suitable torrent clients for fetching in a fixed-output derivation at the time of writing, as they can be easily exited after usage. <code class="literal">rqbit</code> is written in Rust and has a smaller closure size than <code class="literal">transmission</code>, and the performance and peer discovery properties differs between these clients, requiring experimentation to decide upon which is the best.</p></li><li class="listitem"><p><code class="literal">config</code>: When using <code class="literal">transmission</code> as the <code class="literal">backend</code>, a json configuration can
be supplied to transmission. Refer to the <a class="link" href="https://github.com/transmission/transmission/blob/main/docs/Editing-Configuration-Files.md"  target="_top">upstream documentation</a> for information on how to configure.</p></li></ul></div>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-trivial-builders" class="title" >Trivial build helpers   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#trivial-builder-runCommandWith"><code class="literal">runCommandWith</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-runCommand"><code class="literal">runCommand</code> and <code class="literal">runCommandCC</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-text-writing">Writing text files</a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-concatText"><code class="literal">concatTextFile</code>, <code class="literal">concatText</code>, <code class="literal">concatScript</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-writeShellApplication"><code class="literal">writeShellApplication</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-symlinkJoin"><code class="literal">symlinkJoin</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-writeClosure"><code class="literal">writeClosure</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-writeDirectReferencesToFile"><code class="literal">writeDirectReferencesToFile</code></a> </span></dt> </dl></div><p>Nixpkgs provides a variety of wrapper functions that help build commonly useful derivations.
Like <a class="link" href="index.html#sec-using-stdenv" title="Using stdenv" ><code class="literal">stdenv.mkDerivation</code></a>, each of these build helpers creates a derivation, but the arguments passed are different (usually simpler) from those required by <code class="literal">stdenv.mkDerivation</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="trivial-builder-runCommandWith" class="title" style="clear: both"><code class="literal">runCommandWith</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#trivial-builder-runCommandWith-Type">Type</a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-runCommandWith-Inputs">Inputs</a> </span></dt> </dl></div><p>The function <code class="literal">runCommandWith</code> returns a derivation built using the specified command(s), in a specified environment.</p><p>It is the underlying base function of  all <a class="link" href="index.html#trivial-builder-runCommand" title="runCommand and runCommandCC" ><code class="literal">runCommand*</code> variants</a>.
The general behavior is controlled via a single attribute set passed
as the first argument, and allows specifying <code class="literal">stdenv</code> freely.</p><p>The following <a class="link" href="index.html#trivial-builder-runCommand" title="runCommand and runCommandCC" ><code class="literal">runCommand*</code> variants</a> exist: <code class="literal">runCommand</code>, <code class="literal">runCommandCC</code>, and <code class="literal">runCommandLocal</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-runCommandWith-Type" class="title" >Type   </h3>  </div> </div></div><pre><code class="programlisting">runCommandWith :: {
  name :: name;
  stdenv? :: Derivation;
  runLocal? :: Bool;
  derivationArgs? :: { ... };
} -&gt; String -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-runCommandWith-Inputs" class="title" >Inputs   </h3>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String)</span></dt><dd><p>The derivation’s name, which Nix will append to the store path; see <a class="link" href="index.html#sec-using-stdenv" title="Using stdenv" ><code class="literal">mkDerivation</code></a>.</p></dd><dt><span class="term"><code class="literal">runLocal</code> (Boolean)</span></dt><dd><p>If set to <code class="literal">true</code> this forces the derivation to be built locally, not using <a class="link" href="https://nix.dev/manual/nix/2.23/glossary#gloss-substitute"  target="_top">substitutes</a> nor remote builds.
This is intended for very cheap commands (&lt;1s execution time) which can be sped up by avoiding the network round-trip(s).
Its effect is to set <a class="link" href="https://nixos.org/nix/manual/#adv-attr-preferLocalBuild"  target="_top"><code class="literal">preferLocalBuild = true</code></a> and <a class="link" href="https://nixos.org/nix/manual/#adv-attr-allowSubstitutes"  target="_top"><code class="literal">allowSubstitutes = false</code></a>.</p><div class="note"><h3 class="title">Note</h3><p>This prevents the use of <a class="link" href="https://nix.dev/manual/nix/latest/glossary#gloss-substituter"  target="_top">substituters</a>, so only set <code class="literal">runLocal</code> (or use <code class="literal">runCommandLocal</code>) when certain the user will
always have a builder for the <code class="literal">system</code> of the derivation. This should be true for most trivial use cases
(e.g., just copying some files to a different location or adding symlinks) because there the <code class="literal">system</code>
is usually the same as <code class="literal">builtins.currentSystem</code>.</p></div></dd><dt><span class="term"><code class="literal">stdenv</code> (Derivation)</span></dt><dd><p>The <a class="link" href="index.html#chap-stdenv" title="The Standard Environment" >standard environment</a> to use, defaulting to <code class="literal">pkgs.stdenv</code></p></dd><dt><span class="term"><code class="literal">derivationArgs</code> (Attribute set)</span></dt><dd><p>Additional arguments for <a class="link" href="index.html#sec-using-stdenv" title="Using stdenv" ><code class="literal">mkDerivation</code></a>.</p></dd><dt><span class="term"><code class="literal">buildCommand</code> (String)</span></dt><dd><p>Shell commands to run in the derivation builder.</p><div class="note"><h3 class="title">Note</h3><p>You have to create a file or directory <code class="literal">$out</code> for Nix to be able to run the builder successfully.</p></div></dd></dl></div><div class="example"><span id="ex-runcommandwith" ></span><details><summary><span class="title"><strong>Example 286. Invocation of <code class="literal">runCommandWith</code></strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">runCommandWith
  {
    name = &quot;example&quot;;
    derivationArgs.nativeBuildInputs = [ cowsay ];
  }
  &#x27;&#x27;
    cowsay &gt; $out &lt;&lt;EOMOO
    &#x27;runCommandWith&#x27; is a bit cumbersome,
    so we have more ergonomic wrappers.
    EOMOO
  &#x27;&#x27;
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="trivial-builder-runCommand" class="title" style="clear: both"><code class="literal">runCommand</code> and <code class="literal">runCommandCC</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#trivial-builder-runCommand-Type">Type</a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-runCommand-Input">Input</a> </span></dt> </dl></div><p>The function <code class="literal">runCommand</code> returns a derivation built using the specified command(s), in the <code class="literal">stdenvNoCC</code> environment.</p><p><code class="literal">runCommandCC</code> is similar but uses the default compiler environment. To minimize dependencies, <code class="literal">runCommandCC</code>
should only be used when the build command needs a C compiler.</p><p><code class="literal">runCommandLocal</code> is also similar to <code class="literal">runCommand</code>, but forces the derivation to be built locally.
See the note on <a class="link" href="index.html#trivial-builder-runCommandWith" title="runCommandWith" ><code class="literal">runCommandWith</code></a> about <code class="literal">runLocal</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-runCommand-Type" class="title" >Type   </h3>  </div> </div></div><pre><code class="programlisting">runCommand      :: String -&gt; AttrSet -&gt; String -&gt; Derivation
runCommandCC    :: String -&gt; AttrSet -&gt; String -&gt; Derivation
runCommandLocal :: String -&gt; AttrSet -&gt; String -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-runCommand-Input" class="title" >Input   </h3>  </div> </div></div><p>While the type signature(s) differ from <a class="link" href="index.html#trivial-builder-runCommandWith" title="runCommandWith" ><code class="literal">runCommandWith</code></a>, individual arguments with the same name will have the same type and meaning:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String)</span></dt><dd><p>The derivation’s name</p></dd><dt><span class="term"><code class="literal">derivationArgs</code> (Attribute set)</span></dt><dd><p>Additional parameters passed to [<code class="literal">mkDerivation</code>]</p></dd><dt><span class="term"><code class="literal">buildCommand</code> (String)</span></dt><dd><p>The command(s) run to build the derivation.</p></dd></dl></div><div class="example"><span id="ex-runcommand-simple" ></span><details><summary><span class="title"><strong>Example 287. Invocation of <code class="literal">runCommand</code></strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">runCommand &quot;my-example&quot; { } &#x27;&#x27;
  echo My example command is running

  mkdir $out

  echo I can write data to the Nix store &gt; $out/message

  echo I can also run basic commands like:

  echo ls
  ls

  echo whoami
  whoami

  echo date
  date
&#x27;&#x27;
</code></pre></div></details></div><br class="example-break" /><div class="note"><h3 class="title">Note</h3><p><code class="literal">runCommand name derivationArgs buildCommand</code> is equivalent to</p><pre><code class="programlisting nix">runCommandWith {
  inherit name derivationArgs;
  stdenv = stdenvNoCC;
} buildCommand
</code></pre><p>Likewise, <code class="literal">runCommandCC name derivationArgs buildCommand</code> is equivalent to</p><pre><code class="programlisting nix">runCommandWith { inherit name derivationArgs; } buildCommand
</code></pre></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="trivial-builder-text-writing" class="title" style="clear: both">Writing text files   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#trivial-builder-makeDesktopItem"><code class="literal">makeDesktopItem</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-writeTextFile"><code class="literal">writeTextFile</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-writeText"><code class="literal">writeText</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-writeTextDir"><code class="literal">writeTextDir</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-writeScript"><code class="literal">writeScript</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-writeScriptBin"><code class="literal">writeScriptBin</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-writeShellScript"><code class="literal">writeShellScript</code></a> </span></dt><dt> <span class="section">  <a href="index.html#trivial-builder-writeShellScriptBin"><code class="literal">writeShellScriptBin</code></a> </span></dt> </dl></div><p>Nixpkgs provides the following functions for producing derivations which write text files or executable scripts into the Nix store.
They are useful for creating files from Nix expression, and are all implemented as convenience wrappers around <code class="literal">writeTextFile</code>.</p><p>Each of these functions will cause a derivation to be produced.
When you coerce the result of each of these functions to a string with <a class="link" href="https://nixos.org/manual/nix/stable/language/string-interpolation"  target="_top">string interpolation</a> or <a class="link" href="https://nixos.org/manual/nix/stable/language/builtins#builtins-toString"  target="_top"><code class="literal">builtins.toString</code></a>, it will evaluate to the <a class="link" href="https://nixos.org/manual/nix/stable/store/store-path"  target="_top">store path</a> of this derivation.</p><div class="note"><h3 class="title">Note</h3><p>Some of these functions will put the resulting files within a directory inside the <a class="link" href="https://nixos.org/manual/nix/stable/language/derivations#attr-outputs"  target="_top">derivation output</a>.
If you need to refer to the resulting files somewhere else in a Nix expression, append their path to the derivation’s store path.</p><p>For example, if the file destination is a directory:</p><pre><code class="programlisting nix">{
  my-file = writeTextFile {
    name = &quot;my-file&quot;;
    text = &#x27;&#x27;
      Contents of File
    &#x27;&#x27;;
    destination = &quot;/share/my-file&quot;;
  };
}
</code></pre><p>Remember to append “/share/my-file” to the resulting store path when using it elsewhere:</p><pre><code class="programlisting nix">writeShellScript &quot;evaluate-my-file.sh&quot; &#x27;&#x27;
  cat ${my-file}/share/my-file
&#x27;&#x27;
</code></pre></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-makeDesktopItem" class="title" ><code class="literal">makeDesktopItem</code>   </h3>  </div> </div></div><p>Write an <a class="link" href="https://specifications.freedesktop.org/desktop-entry-spec/1.4/"  target="_top">XDG desktop file</a> to the Nix store.</p><p>This function is usually used to add desktop items to a package through the <code class="literal">copyDesktopItems</code> hook.</p><p><code class="literal">makeDesktopItem</code> adheres to version 1.4 of the specification.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="trivial-builder-makeDesktopItem-inputs" class="title" >Inputs   </h4>  </div> </div></div><p><code class="literal">makeDesktopItem</code> takes an attribute set that accepts most values from the <a class="link" href="https://specifications.freedesktop.org/desktop-entry-spec/1.4/ar01s06.html"  target="_top">XDG specification</a>.</p><p>All recognised keys from the specification are supported with the exception of the “Hidden” field. The keys are converted into camelCase format, but correspond 1:1 to their equivalent in the specification: <code class="literal">genericName</code>, <code class="literal">noDisplay</code>, <code class="literal">comment</code>, <code class="literal">icon</code>, <code class="literal">onlyShowIn</code>, <code class="literal">notShowIn</code>, <code class="literal">dbusActivatable</code>, <code class="literal">tryExec</code>, <code class="literal">exec</code>, <code class="literal">path</code>, <code class="literal">terminal</code>, <code class="literal">mimeTypes</code>, <code class="literal">categories</code>, <code class="literal">implements</code>, <code class="literal">keywords</code>, <code class="literal">startupNotify</code>, <code class="literal">startupWMClass</code>, <code class="literal">url</code>, <code class="literal">prefersNonDefaultGPU</code>.</p><p>The “Version” field is hardcoded to the version <code class="literal">makeDesktopItem</code> currently adheres to.</p><p>The following fields are either required, are of a different type than in the specification, carry specific default values, or are additional fields supported by <code class="literal">makeDesktopItem</code>:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String)</span></dt><dd><p>The name of the desktop file in the Nix store.</p></dd><dt><span class="term"><code class="literal">type</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Default value: <code class="literal">&quot;Application&quot;</code></p></dd><dt><span class="term"><code class="literal">desktopName</code> (String)</span></dt><dd><p>Corresponds to the “Name” field of the specification.</p></dd><dt><span class="term"><code class="literal">actions</code> (List of Attribute set; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A list of attribute sets {name, exec?, icon?}</p></dd><dt><span class="term"><code class="literal">extraConfig</code> (Attribute set; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Additional key/value pairs to be added verbatim to the desktop file. Attributes need to be prefixed with ‘X-’.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="trivial-builder-makeDesktopItem-examples" class="title" >Examples   </h4>  </div> </div></div><div class="example"><span id="ex-makeDesktopItem" ></span><details><summary><span class="title"><strong>Example 288. Usage 1 of <code class="literal">makeDesktopItem</code></strong></span></summary><div class="example-contents"><p>Write a desktop file <code class="literal">/nix/store/&lt;store path&gt;/my-program.desktop</code> to the Nix store.</p><pre><code class="programlisting nix">{ makeDesktopItem }:
makeDesktopItem {
  name = &quot;my-program&quot;;
  desktopName = &quot;My Program&quot;;
  genericName = &quot;Video Player&quot;;
  noDisplay = false;
  comment = &quot;Cool video player&quot;;
  icon = &quot;/path/to/icon&quot;;
  onlyShowIn = [ &quot;KDE&quot; ];
  dbusActivatable = true;
  tryExec = &quot;my-program&quot;;
  exec = &quot;my-program --someflag&quot;;
  path = &quot;/some/working/path&quot;;
  terminal = false;
  actions.example = {
    name = &quot;New Window&quot;;
    exec = &quot;my-program --new-window&quot;;
    icon = &quot;/some/icon&quot;;
  };
  mimeTypes = [ &quot;video/mp4&quot; ];
  categories = [ &quot;Utility&quot; ];
  implements = [ &quot;org.my-program&quot; ];
  keywords = [
    &quot;Video&quot;
    &quot;Player&quot;
  ];
  startupNotify = false;
  startupWMClass = &quot;MyProgram&quot;;
  prefersNonDefaultGPU = false;
  extraConfig.X-SomeExtension = &quot;somevalue&quot;;
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex2-makeDesktopItem" ></span><details><summary><span class="title"><strong>Example 289. Usage 2 of <code class="literal">makeDesktopItem</code></strong></span></summary><div class="example-contents"><p>Override the <code class="literal">hello</code> package to add a desktop item.</p><pre><code class="programlisting nix">{
  copyDesktopItems,
  hello,
  makeDesktopItem,
}:

hello.overrideAttrs {
  nativeBuildInputs = [ copyDesktopItems ];

  desktopItems = [
    (makeDesktopItem {
      name = &quot;hello&quot;;
      desktopName = &quot;Hello&quot;;
      exec = &quot;hello&quot;;
    })
  ];
}
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-writeTextFile" class="title" ><code class="literal">writeTextFile</code>   </h3>  </div> </div></div><p>Write a text file to the Nix store.</p><p><code class="literal">writeTextFile</code> takes an attribute set with the following possible attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String)</span></dt><dd><p>Corresponds to the name used in the Nix store path identifier.</p></dd><dt><span class="term"><code class="literal">text</code> (String)</span></dt><dd><p>The contents of the file.</p></dd><dt><span class="term"><code class="literal">executable</code> (Bool, <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Make this file have the executable bit set.</p><p>Default: <code class="literal">false</code></p></dd><dt><span class="term"><code class="literal">destination</code> (String, <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A subpath under the derivation’s output path into which to put the file.
Subdirectories are created automatically when the derivation is realised.</p><p>By default, the store path itself will be a file containing the text contents.</p><p>Default: <code class="literal">&quot;&quot;</code></p></dd><dt><span class="term"><code class="literal">checkPhase</code> (String, <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Commands to run after generating the file.</p><p>Default: <code class="literal">&quot;&quot;</code></p></dd><dt><span class="term"><code class="literal">meta</code> (Attribute set, <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Additional metadata for the derivation.</p><p>Default: <code class="literal">{}</code></p></dd><dt><span class="term"><code class="literal">allowSubstitutes</code> (Bool, <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Whether to allow substituting from a binary cache.
Passed through to <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes#adv-attr-allowSubstitutes"  target="_top"><code class="literal">allowSubstitutes</code></a> of the underlying call to <code class="literal">builtins.derivation</code>.</p><p>It defaults to <code class="literal">false</code>, as running the derivation’s simple <code class="literal">builder</code> executable locally is assumed to be faster than network operations.
Set it to true if the <code class="literal">checkPhase</code> step is expensive.</p><p>Default: <code class="literal">false</code></p></dd><dt><span class="term"><code class="literal">preferLocalBuild</code> (Bool, <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Whether to prefer building locally, even if faster <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/conf-file#conf-substituters"  target="_top">remote build machines</a> are available.</p><p>Passed through to <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes#adv-attr-preferLocalBuild"  target="_top"><code class="literal">preferLocalBuild</code></a> of the underlying call to <code class="literal">builtins.derivation</code>.</p><p>It defaults to <code class="literal">true</code> for the same reason <code class="literal">allowSubstitutes</code> defaults to <code class="literal">false</code>.</p><p>Default: <code class="literal">true</code></p></dd><dt><span class="term"><code class="literal">derivationArgs</code> (Attribute set, <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Extra arguments to pass to the underlying call to <code class="literal">stdenv.mkDerivation</code>.</p><p>Default: <code class="literal">{}</code></p></dd></dl></div><p>The resulting store path will include some variation of the name, and it will be a file unless <code class="literal">destination</code> is used, in which case it will be a directory.</p><div class="example"><span id="ex-writeTextFile" ></span><details><summary><span class="title"><strong>Example 290. Usage 1 of <code class="literal">writeTextFile</code></strong></span></summary><div class="example-contents"><p>Write <code class="literal">my-file</code> to <code class="literal">/nix/store/&lt;store path&gt;/some/subpath/my-cool-script</code>, making it executable.
Also run a check on the resulting file in a <code class="literal">checkPhase</code>, and supply values for the less-used options.</p><pre><code class="programlisting nix">writeTextFile {
  name = &quot;my-cool-script&quot;;
  text = &#x27;&#x27;
    #!/bin/sh
    echo &quot;This is my cool script!&quot;
  &#x27;&#x27;;
  executable = true;
  destination = &quot;/some/subpath/my-cool-script&quot;;
  checkPhase = &#x27;&#x27;
    ${pkgs.shellcheck}/bin/shellcheck $out/some/subpath/my-cool-script
  &#x27;&#x27;;
  meta = {
    license = pkgs.lib.licenses.cc0;
  };
  allowSubstitutes = true;
  preferLocalBuild = false;
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex2-writeTextFile" ></span><details><summary><span class="title"><strong>Example 291. Usage 2 of <code class="literal">writeTextFile</code></strong></span></summary><div class="example-contents"><p>Write the string <code class="literal">Contents of File</code> to <code class="literal">/nix/store/&lt;store path&gt;</code>.
See also the <a class="xref" href="index.html#trivial-builder-writeText" title="writeText" >the section called “<code class="literal">writeText</code>”</a> helper function.</p><pre><code class="programlisting nix">writeTextFile {
  name = &quot;my-file&quot;;
  text = &#x27;&#x27;
    Contents of File
  &#x27;&#x27;;
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex3-writeTextFile" ></span><details><summary><span class="title"><strong>Example 292. Usage 3 of <code class="literal">writeTextFile</code></strong></span></summary><div class="example-contents"><p>Write an executable script <code class="literal">my-script</code> to <code class="literal">/nix/store/&lt;store path&gt;/bin/my-script</code>.
See also the <a class="xref" href="index.html#trivial-builder-writeScriptBin" title="writeScriptBin" >the section called “<code class="literal">writeScriptBin</code>”</a> helper function.</p><pre><code class="programlisting nix">writeTextFile {
  name = &quot;my-script&quot;;
  text = &#x27;&#x27;
    echo &quot;hi&quot;
  &#x27;&#x27;;
  executable = true;
  destination = &quot;/bin/my-script&quot;;
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-writeText" class="title" ><code class="literal">writeText</code>   </h3>  </div> </div></div><p>Write a text file to the Nix store</p><p><code class="literal">writeText</code> takes the following arguments:
a string.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String)</span></dt><dd><p>The name used in the Nix store path.</p></dd><dt><span class="term"><code class="literal">text</code> (String)</span></dt><dd><p>The contents of the file.</p></dd></dl></div><p>The store path will include the name, and it will be a file.</p><div class="example"><span id="ex-writeText" ></span><details><summary><span class="title"><strong>Example 293. Usage of <code class="literal">writeText</code></strong></span></summary><div class="example-contents"><p>Write the string <code class="literal">Contents of File</code> to <code class="literal">/nix/store/&lt;store path&gt;</code>:</p><pre><code class="programlisting nix">writeText &quot;my-file&quot; &#x27;&#x27;
  Contents of File
&#x27;&#x27;
</code></pre></div></details></div><br class="example-break" /><p>This is equivalent to:</p><pre><code class="programlisting nix">writeTextFile {
  name = &quot;my-file&quot;;
  text = &#x27;&#x27;
    Contents of File
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-writeTextDir" class="title" ><code class="literal">writeTextDir</code>   </h3>  </div> </div></div><p>Write a text file within a subdirectory of the Nix store.</p><p><code class="literal">writeTextDir</code> takes the following arguments:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">path</code> (String)</span></dt><dd><p>The destination within the Nix store path under which to create the file.</p></dd><dt><span class="term"><code class="literal">text</code> (String)</span></dt><dd><p>The contents of the file.</p></dd></dl></div><p>The store path will be a directory.</p><div class="example"><span id="ex-writeTextDir" ></span><details><summary><span class="title"><strong>Example 294. Usage of <code class="literal">writeTextDir</code></strong></span></summary><div class="example-contents"><p>Write the string <code class="literal">Contents of File</code> to <code class="literal">/nix/store/&lt;store path&gt;/share/my-file</code>:</p><pre><code class="programlisting nix">writeTextDir &quot;share/my-file&quot; &#x27;&#x27;
  Contents of File
&#x27;&#x27;
</code></pre></div></details></div><br class="example-break" /><p>This is equivalent to:</p><pre><code class="programlisting nix">writeTextFile {
  name = &quot;my-file&quot;;
  text = &#x27;&#x27;
    Contents of File
  &#x27;&#x27;;
  destination = &quot;/share/my-file&quot;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-writeScript" class="title" ><code class="literal">writeScript</code>   </h3>  </div> </div></div><p>Write an executable script file to the Nix store.</p><p><code class="literal">writeScript</code> takes the following arguments:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String)</span></dt><dd><p>The name used in the Nix store path.</p></dd><dt><span class="term"><code class="literal">text</code> (String)</span></dt><dd><p>The contents of the file.</p></dd></dl></div><p>The created file is marked as executable.
The store path will include the name, and it will be a file.</p><div class="example"><span id="ex-writeScript" ></span><details><summary><span class="title"><strong>Example 295. Usage of <code class="literal">writeScript</code></strong></span></summary><div class="example-contents"><p>Write the string <code class="literal">Contents of File</code> to <code class="literal">/nix/store/&lt;store path&gt;</code> and make the file executable.</p><pre><code class="programlisting nix">writeScript &quot;my-file&quot; &#x27;&#x27;
  Contents of File
&#x27;&#x27;
</code></pre><p>This is equivalent to:</p><pre><code class="programlisting nix">writeTextFile {
  name = &quot;my-file&quot;;
  text = &#x27;&#x27;
    Contents of File
  &#x27;&#x27;;
  executable = true;
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-writeScriptBin" class="title" ><code class="literal">writeScriptBin</code>   </h3>  </div> </div></div><p>Write a script within a <code class="literal">bin</code> subdirectory of a directory in the Nix store.
This is for consistency with the convention of software packages placing executables under <code class="literal">bin</code>.</p><p><code class="literal">writeScriptBin</code> takes the following arguments:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String)</span></dt><dd><p>The name used in the Nix store path and within the file created under the store path.</p></dd><dt><span class="term"><code class="literal">text</code> (String)</span></dt><dd><p>The contents of the file.</p></dd></dl></div><p>The created file is marked as executable.
The file’s contents will be put into <code class="literal">/nix/store/&lt;store path&gt;/bin/&lt;name&gt;</code>.
The store path will include the name, and it will be a directory.</p><div class="example"><span id="ex-writeScriptBin" ></span><details><summary><span class="title"><strong>Example 296. Usage of <code class="literal">writeScriptBin</code></strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">writeScriptBin &quot;my-script&quot; &#x27;&#x27;
  echo &quot;hi&quot;
&#x27;&#x27;
</code></pre></div></details></div><br class="example-break" /><p>This is equivalent to:</p><pre><code class="programlisting nix">writeTextFile {
  name = &quot;my-script&quot;;
  text = &#x27;&#x27;
    echo &quot;hi&quot;
  &#x27;&#x27;;
  executable = true;
  destination = &quot;/bin/my-script&quot;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-writeShellScript" class="title" ><code class="literal">writeShellScript</code>   </h3>  </div> </div></div><p>Write a Bash script to the store.</p><p><code class="literal">writeShellScript</code> takes the following arguments:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String)</span></dt><dd><p>The name used in the Nix store path.</p></dd><dt><span class="term"><code class="literal">text</code> (String)</span></dt><dd><p>The contents of the file.</p></dd></dl></div><p>The created file is marked as executable.
The store path will include the name, and it will be a file.</p><p>This function is almost exactly like <a class="xref" href="index.html#trivial-builder-writeScript" title="writeScript" >the section called “<code class="literal">writeScript</code>”</a>, except that it prepends to the file a <a class="link" href="https://en.wikipedia.org/wiki/Shebang_%28Unix%29"  target="_top">shebang</a> line that points to the version of Bash used in Nixpkgs.
</p><div class="example"><span id="ex-writeShellScript" ></span><details><summary><span class="title"><strong>Example 297. Usage of <code class="literal">writeShellScript</code></strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">writeShellScript &quot;my-script&quot; &#x27;&#x27;
  echo &quot;hi&quot;
&#x27;&#x27;
</code></pre></div></details></div><br class="example-break" /><p>This is equivalent to:</p><pre><code class="programlisting nix">writeTextFile {
  name = &quot;my-script&quot;;
  text = &#x27;&#x27;
    #! ${pkgs.runtimeShell}
    echo &quot;hi&quot;
  &#x27;&#x27;;
  executable = true;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="trivial-builder-writeShellScriptBin" class="title" ><code class="literal">writeShellScriptBin</code>   </h3>  </div> </div></div><p>Write a Bash script to a “bin” subdirectory of a directory in the Nix store.</p><p><code class="literal">writeShellScriptBin</code> takes the following arguments:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String)</span></dt><dd><p>The name used in the Nix store path and within the file generated under the store path.</p></dd><dt><span class="term"><code class="literal">text</code> (String)</span></dt><dd><p>The contents of the file.</p></dd></dl></div><p>The file’s contents will be put into <code class="literal">/nix/store/&lt;store path&gt;/bin/&lt;name&gt;</code>.
The store path will include the the name, and it will be a directory.</p><p>This function is a combination of <a class="xref" href="index.html#trivial-builder-writeShellScript" title="writeShellScript" >the section called “<code class="literal">writeShellScript</code>”</a> and <a class="xref" href="index.html#trivial-builder-writeScriptBin" title="writeScriptBin" >the section called “<code class="literal">writeScriptBin</code>”</a>.</p><div class="example"><span id="ex-writeShellScriptBin" ></span><details><summary><span class="title"><strong>Example 298. Usage of <code class="literal">writeShellScriptBin</code></strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">writeShellScriptBin &quot;my-script&quot; &#x27;&#x27;
  echo &quot;hi&quot;
&#x27;&#x27;
</code></pre></div></details></div><br class="example-break" /><p>This is equivalent to:</p><pre><code class="programlisting nix">writeTextFile {
  name = &quot;my-script&quot;;
  text = &#x27;&#x27;
    #! ${pkgs.runtimeShell}
    echo &quot;hi&quot;
  &#x27;&#x27;;
  executable = true;
  destination = &quot;/bin/my-script&quot;;
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="trivial-builder-concatText" class="title" style="clear: both"><code class="literal">concatTextFile</code>, <code class="literal">concatText</code>, <code class="literal">concatScript</code>   </h2>  </div> </div></div><p>These functions concatenate <code class="literal">files</code> to the Nix store in a single file. This is useful for configuration files structured in lines of text. <code class="literal">concatTextFile</code> takes an attribute set and expects two arguments, <code class="literal">name</code> and <code class="literal">files</code>. <code class="literal">name</code> corresponds to the name used in the Nix store path. <code class="literal">files</code> will be the files to be concatenated. You can also set <code class="literal">executable</code> to true to make this file have the executable bit set.
<code class="literal">concatText</code> and<code class="literal">concatScript</code> are simple wrappers over <code class="literal">concatTextFile</code>.</p><p>Here are a few examples:</p><pre><code class="programlisting nix"># Writes my-file to /nix/store/&lt;store path&gt;
concatTextFile
  {
    name = &quot;my-file&quot;;
    files = [
      drv1
      &quot;${drv2}/path/to/file&quot;
    ];
  }
  # See also the `concatText` helper function below.

  # Writes executable my-file to /nix/store/&lt;store path&gt;/bin/my-file
  concatTextFile
  {
    name = &quot;my-file&quot;;
    files = [
      drv1
      &quot;${drv2}/path/to/file&quot;
    ];
    executable = true;
    destination = &quot;/bin/my-file&quot;;
  }
  # Writes contents of files to /nix/store/&lt;store path&gt;
  concatText
  &quot;my-file&quot;
  [
    file1
    file2
  ]

  # Writes contents of files to /nix/store/&lt;store path&gt;
  concatScript
  &quot;my-file&quot;
  [
    file1
    file2
  ]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="trivial-builder-writeShellApplication" class="title" style="clear: both"><code class="literal">writeShellApplication</code>   </h2>  </div> </div></div><p><code class="literal">writeShellApplication</code> is similar to <code class="literal">writeShellScriptBin</code> and <code class="literal">writeScriptBin</code> but supports runtime dependencies with <code class="literal">runtimeInputs</code>.
Writes an executable shell script to <code class="literal">/nix/store/&lt;store path&gt;/bin/&lt;name&gt;</code> and checks its syntax with <a class="link" href="https://github.com/koalaman/shellcheck"  target="_top"><code class="literal">shellcheck</code></a> and the <code class="literal">bash</code>’s <code class="literal">-n</code> option.
Some basic Bash options are set by default (<code class="literal">errexit</code>, <code class="literal">nounset</code>, and <code class="literal">pipefail</code>), but can be overridden with <code class="literal">bashOptions</code>.</p><p>Extra arguments may be passed to <code class="literal">stdenv.mkDerivation</code> by setting <code class="literal">derivationArgs</code>; note that variables set in this manner will be set when the shell script is <span class="emphasis"><em>built,</em></span> not when it’s run.
Runtime environment variables can be set with the <code class="literal">runtimeEnv</code> argument.</p><p>For example, the following shell application can refer to <code class="literal">curl</code> directly, rather than needing to write <code class="literal">${curl}/bin/curl</code>:</p><pre><code class="programlisting nix">writeShellApplication {
  name = &quot;show-nixos-org&quot;;

  runtimeInputs = [
    curl
    w3m
  ];

  text = &#x27;&#x27;
    curl -s &#x27;https://nixos.org&#x27; | w3m -dump -T text/html
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="trivial-builder-symlinkJoin" class="title" style="clear: both"><code class="literal">symlinkJoin</code>   </h2>  </div> </div></div><p>This can be used to put many derivations into the same directory structure. It works by creating a new derivation and adding symlinks to each of the paths listed. It expects two arguments, <code class="literal">name</code>, and <code class="literal">paths</code>. <code class="literal">name</code> (or alternatively <code class="literal">pname</code> and <code class="literal">version</code>) is the name used in the Nix store path for the created derivation. <code class="literal">paths</code> is a list of paths that will be symlinked. These paths can be to Nix store derivations or any other subdirectory contained within.
Here is an example:</p><pre><code class="programlisting nix"># adds symlinks of hello and stack to current build and prints &quot;links added&quot;
symlinkJoin {
  name = &quot;myexample&quot;;
  paths = [
    pkgs.hello
    pkgs.stack
  ];
  postBuild = &quot;echo links added&quot;;
}
</code></pre><p>This creates a derivation with a directory structure like the following:</p><pre><code class="programlisting">/nix/store/sglsr5g079a5235hy29da3mq3hv8sjmm-myexample
|-- bin
|   |-- hello -&gt; /nix/store/qy93dp4a3rqyn2mz63fbxjg228hffwyw-hello-2.10/bin/hello
|   `-- stack -&gt; /nix/store/6lzdpxshx78281vy056lbk553ijsdr44-stack-2.1.3.1/bin/stack
`-- share
    |-- bash-completion
    |   `-- completions
    |       `-- stack -&gt; /nix/store/6lzdpxshx78281vy056lbk553ijsdr44-stack-2.1.3.1/share/bash-completion/completions/stack
    |-- fish
    |   `-- vendor_completions.d
    |       `-- stack.fish -&gt; /nix/store/6lzdpxshx78281vy056lbk553ijsdr44-stack-2.1.3.1/share/fish/vendor_completions.d/stack.fish
...
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="trivial-builder-writeClosure" class="title" style="clear: both"><code class="literal">writeClosure</code>   </h2>  </div> </div></div><p>Given a list of <a class="link" href="https://nixos.org/manual/nix/stable/glossary#gloss-store-path"  target="_top">store paths</a> (or string-like expressions coercible to store paths), write their collective <a class="link" href="https://nixos.org/manual/nix/stable/glossary#gloss-closure"  target="_top">closure</a> to a text file.</p><p>The result is equivalent to the output of <code class="literal">nix-store -q --requisites</code>.</p><p>For example,</p><pre><code class="programlisting nix">writeClosure [ (writeScriptBin &quot;hi&quot; &quot;${hello}/bin/hello&quot;) ]
</code></pre><p>produces an output path <code class="literal">/nix/store/&lt;hash&gt;-runtime-deps</code> containing</p><pre><code class="programlisting">/nix/store/&lt;hash&gt;-hello-2.10
/nix/store/&lt;hash&gt;-hi
/nix/store/&lt;hash&gt;-libidn2-2.3.0
/nix/store/&lt;hash&gt;-libunistring-0.9.10
/nix/store/&lt;hash&gt;-glibc-2.32-40
</code></pre><p>You can see that this includes <code class="literal">hi</code>, the original input path,
<code class="literal">hello</code>, which is a direct reference, but also
the other paths that are indirectly required to run <code class="literal">hello</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="trivial-builder-writeDirectReferencesToFile" class="title" style="clear: both"><code class="literal">writeDirectReferencesToFile</code>   </h2>  </div> </div></div><p>Writes the set of references to the output file, that is, their immediate dependencies.</p><p>This produces the equivalent of <code class="literal">nix-store -q --references</code>.</p><p>For example,</p><pre><code class="programlisting nix">writeDirectReferencesToFile (writeScriptBin &quot;hi&quot; &quot;${hello}/bin/hello&quot;)
</code></pre><p>produces an output path <code class="literal">/nix/store/&lt;hash&gt;-runtime-references</code> containing</p><pre><code class="programlisting">/nix/store/&lt;hash&gt;-hello-2.10
</code></pre><p>but none of <code class="literal">hello</code>’s dependencies because those are not referenced directly
by <code class="literal">hi</code>’s output.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-testers" class="title" >Testers   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#tester-hasPkgConfigModules"><code class="literal">hasPkgConfigModules</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-hasCmakeConfigModules"><code class="literal">hasCmakeConfigModules</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-lycheeLinkCheck"><code class="literal">lycheeLinkCheck</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-shellcheck"><code class="literal">shellcheck</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-shfmt"><code class="literal">shfmt</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-testVersion"><code class="literal">testVersion</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-testBuildFailure"><code class="literal">testBuildFailure</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-testBuildFailurePrime"><code class="literal">testBuildFailure&#x27;</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-testEqualContents"><code class="literal">testEqualContents</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-testEqualArrayOrMap"><code class="literal">testEqualArrayOrMap</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-testEqualDerivation"><code class="literal">testEqualDerivation</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-invalidateFetcherByDrvHash"><code class="literal">invalidateFetcherByDrvHash</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-runCommand"><code class="literal">runCommand</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-runNixOSTest"><code class="literal">runNixOSTest</code></a> </span></dt><dt> <span class="section">  <a href="index.html#tester-nixosTest"><code class="literal">nixosTest</code></a> </span></dt> </dl></div><p>This chapter describes several testing builders which are available in the <code class="literal">testers</code> namespace.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-hasPkgConfigModules" class="title" style="clear: both"><code class="literal">hasPkgConfigModules</code>   </h2>  </div> </div></div><p><span id="tester-hasPkgConfigModule"></span>
Checks whether a package exposes a given list of <code class="literal">pkg-config</code> modules.
If the <code class="literal">moduleNames</code> argument is omitted, <code class="literal">hasPkgConfigModules</code> will use <code class="literal">meta.pkgConfigModules</code>.</p><div class="example"><span id="ex-haspkgconfigmodules-defaultvalues" ></span><details><summary><span class="title"><strong>Example 299. Check that <code class="literal">pkg-config</code> modules are exposed using default values</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  passthru.tests.pkg-config = testers.hasPkgConfigModules { package = finalAttrs.finalPackage; };

  meta.pkgConfigModules = [ &quot;libfoo&quot; ];
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-haspkgconfigmodules-explicitmodules" ></span><details><summary><span class="title"><strong>Example 300. Check that <code class="literal">pkg-config</code> modules are exposed using explicit module names</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  passthru.tests.pkg-config = testers.hasPkgConfigModules {
    package = finalAttrs.finalPackage;
    moduleNames = [ &quot;libfoo&quot; ];
  };
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-hasCmakeConfigModules" class="title" style="clear: both"><code class="literal">hasCmakeConfigModules</code>   </h2>  </div> </div></div><p>Checks whether a package exposes a given list of <code class="literal">*config.cmake</code> modules.
Note the moduleNames used in cmake find_package are case sensitive.</p><div class="example"><span id="ex-hascmakeconfigmodules" ></span><details><summary><span class="title"><strong>Example 301. Check that <code class="literal">*config.cmake</code> modules are exposed using explicit module names</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  passthru.tests.cmake-config = testers.hasCmakeConfigModules {
    package = finalAttrs.finalPackage;
    moduleNames = [ &quot;Foo&quot; ];
  };
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-lycheeLinkCheck" class="title" style="clear: both"><code class="literal">lycheeLinkCheck</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#tester-lycheeLinkCheck-return">Return value</a> </span></dt><dt> <span class="section">  <a href="index.html#tester-lycheeLinkCheck-inputs">Inputs</a> </span></dt> </dl></div><p>Check a packaged static site’s links with the <a class="link" href="https://search.nixos.org/packages?show=lychee&amp;type=packages&amp;query=lychee"  target="_top"><code class="literal">lychee</code> package</a>.</p><p>You may use Nix to reproducibly build static websites, such as for software documentation.
Some packages will install documentation in their <code class="literal">out</code> or <code class="literal">doc</code> outputs, or maybe you have dedicated package where you’ve made your static site reproducible by running a generator, such as <a class="link" href="https://gohugo.io/"  target="_top">Hugo</a> or <a class="link" href="https://rust-lang.github.io/mdBook/"  target="_top">mdBook</a>, in a derivation.</p><p>If you have a static site that can be built with Nix, you can use <code class="literal">lycheeLinkCheck</code> to check that the hyperlinks in your site are correct, and do so as part of your Nix workflow and CI.</p><div class="example"><span id="ex-lycheelinkcheck" ></span><details><summary><span class="title"><strong>Example 302. Check hyperlinks in the <code class="literal">nix</code> documentation</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">testers.lycheeLinkCheck { site = nix.doc + &quot;/share/doc/nix/manual&quot;; }
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-lycheeLinkCheck-return" class="title" >Return value   </h3>  </div> </div></div><p>This tester produces a package that does not produce useful outputs, but only succeeds if the hyperlinks in your site are correct. The build log will list the broken links.</p><p>It has two modes:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Build the returned derivation; its build process will check that internal hyperlinks are correct. This runs in the sandbox, so it will not check external hyperlinks, but it is quick and reliable.</p></li><li class="listitem"><p>Invoke the <code class="literal">.online</code> attribute with <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-run"  target="_top"><code class="literal">nix run</code></a> (<a class="link" href="https://nixos.org/manual/nix/stable/contributing/experimental-features#xp-feature-nix-command"  target="_top">experimental</a>). This runs outside the sandbox, and checks that both internal and external hyperlinks are correct.
Example:</p><pre><code class="programlisting shell">nix run nixpkgs#lychee.tests.ok.online
</code></pre></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-lycheeLinkCheck-inputs" class="title" >Inputs   </h3>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">site</code> (path or derivation) {#tester-lycheeLinkCheck-param-site}</span></dt><dd><p>The path to the files to check.</p></dd><dt><span class="term"><code class="literal">remap</code> (attribe set, optional) {#tester-lycheeLinkCheck-param-remap}</span></dt><dd><p>An attribute set where the attribute names are regular expressions.
The values should be strings, derivations, or path values.</p><p>In the returned check’s default configuration, external URLs are only checked when you run the <code class="literal">.online</code> attribute.</p><p>By adding remappings, you can check offline that URLs to external resources are correct, by providing a stand-in from the file system.</p><p>Before checking the existence of a URL, the regular expressions are matched and replaced by their corresponding values.</p><p>Example:</p><pre><code class="programlisting nix">{
  &quot;https://nix\\.dev/manual/nix/[a-z0-9.-]*&quot; = &quot;${nix.doc}/share/doc/nix/manual&quot;;
  &quot;https://nixos\\.org/manual/nix/(un)?stable&quot; =
    &quot;${emptyDirectory}/placeholder-to-disallow-old-nix-docs-urls&quot;;
}
</code></pre><p>Store paths in the attribute values are automatically prefixed with <code class="literal">file://</code>, because lychee requires this for paths in the file system.
If this is a problem, or if you need to control the order in which replacements are performed, use <code class="literal">extraConfig.remap</code> instead.</p></dd><dt><span class="term"><code class="literal">extraConfig</code> (attribute set) {#tester-lycheeLinkCheck-param-extraConfig}</span></dt><dd><p>Extra configuration to pass to <code class="literal">lychee</code> in its <a class="link" href="https://github.com/lycheeverse/lychee/blob/master/lychee.example.toml"  target="_top">configuration file</a>.
It is automatically <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#sec-settings-nix-representable"  target="_top">translated</a> to TOML.</p><p>Example: <code class="literal">{ &quot;include_verbatim&quot; = true; }</code></p></dd><dt><span class="term"><code class="literal">lychee</code> (derivation, optional) {#tester-lycheeLinkCheck-param-lychee}</span></dt><dd><p>The <code class="literal">lychee</code> package to use.</p></dd></dl></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-shellcheck" class="title" style="clear: both"><code class="literal">shellcheck</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#tester-shellcheck-inputs">Inputs</a> </span></dt><dt> <span class="section">  <a href="index.html#tester-shellcheck-return">Return value</a> </span></dt> </dl></div><p>Run files through <code class="literal">shellcheck</code>, a static analysis tool for shell scripts, failing if there are any issues.</p><div class="example"><span id="ex-shellcheck" ></span><details><summary><span class="title"><strong>Example 303. Run <code class="literal">testers.shellcheck</code></strong></span></summary><div class="example-contents"><p>A single script</p><pre><code class="programlisting nix">testers.shellcheck {
  name = &quot;script&quot;;
  src = ./script.sh;
}
</code></pre><p>Multiple files</p><pre><code class="programlisting nix">let
  inherit (lib) fileset;
in
testers.shellcheck {
  name = &quot;nixbsd-activate&quot;;
  src = fileset.toSource {
    root = ./.;
    fileset = fileset.unions [
      ./lib.sh
      ./nixbsd-activate
    ];
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-shellcheck-inputs" class="title" >Inputs   </h3>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (string, optional)</span></dt><dd><p>The name of the test.
<code class="literal">name</code> will be required at a future point because it massively improves traceability of test failures, but is kept optional for now to avoid breaking existing usages.
Defaults to <code class="literal">run-shellcheck</code>.
The name of the derivation produced by the tester is <code class="literal">shellcheck-${name}</code> when <code class="literal">name</code> is supplied.</p></dd><dt><span class="term"><code class="literal">src</code> (path-like)</span></dt><dd><p>The path to the shell script(s) to check.
This can be a single file or a directory containing shell files.
All files in <code class="literal">src</code> will be checked, so you may want to provide <code class="literal">fileset</code>-based source instead of a whole directory.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-shellcheck-return" class="title" >Return value   </h3>  </div> </div></div><p>A derivation that runs <code class="literal">shellcheck</code> on the given script(s), producing an empty output if no issues are found.
The build will fail if <code class="literal">shellcheck</code> finds any issues.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-shfmt" class="title" style="clear: both"><code class="literal">shfmt</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#tester-shfmt-inputs">Inputs</a> </span></dt><dt> <span class="section">  <a href="index.html#tester-shfmt-return">Return value</a> </span></dt> </dl></div><p>Run files through <code class="literal">shfmt</code>, a shell script formatter, failing if any files are reformatted.</p><div class="example"><span id="ex-shfmt" ></span><details><summary><span class="title"><strong>Example 304. Run <code class="literal">testers.shfmt</code></strong></span></summary><div class="example-contents"><p>A single script</p><pre><code class="programlisting nix">testers.shfmt {
  name = &quot;script&quot;;
  src = ./script.sh;
}
</code></pre><p>Multiple files</p><pre><code class="programlisting nix">let
  inherit (lib) fileset;
in
testers.shfmt {
  name = &quot;nixbsd&quot;;
  src = fileset.toSource {
    root = ./.;
    fileset = fileset.unions [
      ./lib.sh
      ./nixbsd-activate
    ];
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-shfmt-inputs" class="title" >Inputs   </h3>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (string)</span></dt><dd><p>The name of the test.
<code class="literal">name</code> is required because it massively improves traceability of test failures.
The name of the derivation produced by the tester is <code class="literal">shfmt-${name}</code>.</p></dd><dt><span class="term"><code class="literal">src</code> (path-like)</span></dt><dd><p>The path to the shell script(s) to check.
This can be a single file or a directory containing shell files.
All files in <code class="literal">src</code> will be checked, so you may want to provide <code class="literal">fileset</code>-based source instead of a whole directory.</p></dd><dt><span class="term"><code class="literal">indent</code> (integer, optional)</span></dt><dd><p>The number of spaces to use for indentation.
Defaults to <code class="literal">2</code>.
A value of <code class="literal">0</code> indents with tabs.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-shfmt-return" class="title" >Return value   </h3>  </div> </div></div><p>A derivation that runs <code class="literal">shfmt</code> on the given script(s), producing an empty output upon success.
The build will fail if <code class="literal">shfmt</code> reformats anything.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-testVersion" class="title" style="clear: both"><code class="literal">testVersion</code>   </h2>  </div> </div></div><p>Checks that the output from running a command contains the specified version string in it as a whole word.</p><p>NOTE: This is a check you add to <code class="literal">passthru.tests</code> which is mainly run by OfBorg, but not in Hydra. If you want a version check failure to block the build altogether, then <a class="link" href="index.html#versioncheckhook" title="versionCheckHook" ><code class="literal">versionCheckHook</code></a> is the tool you’re looking for (and recommended for quick builds). The motivation for adding either of these checks would be:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Catch dynamic linking errors and such and missing environment variables that should be added by wrapping.</p></li><li class="listitem"><p>Probable protection against accidentally building the wrong version, for example when using an “old” hash in a fixed-output derivation.</p></li></ul></div><p>By default, the command to be run will be inferred from the given <code class="literal">package</code> attribute:
it will check <code class="literal">meta.mainProgram</code> first, and fall back to <code class="literal">pname</code> or <code class="literal">name</code>.
The default argument to the command is <code class="literal">--version</code>, and the version to be checked will be inferred from the given <code class="literal">package</code> attribute as well.</p><div class="example"><span id="ex-testversion-hello" ></span><details><summary><span class="title"><strong>Example 305. Check a program version using all the default values</strong></span></summary><div class="example-contents"><p>This example will run the command <code class="literal">hello --version</code>, and then check that the version of the <code class="literal">hello</code> package is in the output of the command.</p><pre><code class="programlisting nix">{ passthru.tests.version = testers.testVersion { package = hello; }; }
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-testversion-different-commandversion" ></span><details><summary><span class="title"><strong>Example 306. Check the program version using a specified command and expected version string</strong></span></summary><div class="example-contents"><p>This example will run the command <code class="literal">leetcode -V</code>, and then check that <code class="literal">leetcode 0.4.2</code> is in the output of the command as a whole word (separated by whitespaces).
This means that an output like “leetcode 0.4.21” would fail the tests, and an output like “You’re running leetcode 0.4.2” would pass the tests.</p><p>A common usage of the <code class="literal">version</code> attribute is to specify <code class="literal">version = &quot;v${version}&quot;</code>.</p><pre><code class="programlisting nix">{
  version = &quot;0.4.2&quot;;

  passthru.tests.version = testers.testVersion {
    package = leetcode-cli;
    command = &quot;leetcode -V&quot;;
    version = &quot;leetcode ${version}&quot;;
  };
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-testBuildFailure" class="title" style="clear: both"><code class="literal">testBuildFailure</code>   </h2>  </div> </div></div><p>Make sure that a build does not succeed. This is useful for testing testers.</p><p>This returns a derivation with an override on the builder, with the following effects:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Fail the build when the original builder succeeds</p></li><li class="listitem"><p>Move <code class="literal">$out</code> to <code class="literal">$out/result</code>, if it exists (assuming <code class="literal">out</code> is the default output)</p></li><li class="listitem"><p>Save the build log to <code class="literal">$out/testBuildFailure.log</code> (same)</p></li></ul></div><p>While <code class="literal">testBuildFailure</code> is designed to keep changes to the original builder’s environment to a minimum, some small changes are inevitable:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>The file <code class="literal">$TMPDIR/testBuildFailure.log</code> is present. It should not be deleted.</p></li><li class="listitem"><p><code class="literal">stdout</code> and <code class="literal">stderr</code> are a pipe instead of a tty. This could be improved.</p></li><li class="listitem"><p>One or two extra processes are present in the sandbox during the original builder’s execution.</p></li><li class="listitem"><p>The derivation and output hashes are different, but not unusual.</p></li><li class="listitem"><p>The derivation includes a dependency on <code class="literal">buildPackages.bash</code> and <code class="literal">expect-failure.sh</code>, which is built to include a transitive dependency on <code class="literal">buildPackages.coreutils</code> and possibly more.
These are not added to <code class="literal">PATH</code> or any other environment variable, so they should be hard to observe.</p></li></ul></div><div class="example"><span id="ex-testBuildFailure-showingenvironmentchanges" ></span><details><summary><span class="title"><strong>Example 307. Check that a build fails, and verify the changes made during build</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">runCommand &quot;example&quot;
  {
    failed = testers.testBuildFailure (
      runCommand &quot;fail&quot; { } &#x27;&#x27;
        echo ok-ish &gt;$out
        echo failing though
        exit 3
      &#x27;&#x27;
    );
  }
  &#x27;&#x27;
    grep -F &#x27;ok-ish&#x27; $failed/result
    grep -F &#x27;failing though&#x27; $failed/testBuildFailure.log
    [[ 3 = $(cat $failed/testBuildFailure.exit) ]]
    touch $out
  &#x27;&#x27;
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-testBuildFailurePrime" class="title" style="clear: both"><code class="literal">testBuildFailure&#x27;</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#tester-testBuildFailurePrime-inputs">Inputs</a> </span></dt><dt> <span class="section">  <a href="index.html#tester-testBuildFailurePrime-return">Return value</a> </span></dt> </dl></div><p>This tester wraps the functionality provided by <a class="link" href="index.html#tester-testBuildFailure" title="testBuildFailure" ><code class="literal">testers.testBuildFailure</code></a> to make writing checks easier by simplifying checking the exit code of the builder and asserting the existence of entries in the builder’s log.
Additionally, users may specify a script containing additional checks, accessing the result of applying <code class="literal">testers.testBuildFailure</code> through the variable <code class="literal">failed</code>.</p><p>NOTE: This tester will produce an empty output and exit with success if none of the checks fail; there is no need to <code class="literal">touch &quot;$out&quot;</code> in <code class="literal">script</code>.</p><div class="example"><span id="ex-testBuildFailurePrime-doc-example" ></span><details><summary><span class="title"><strong>Example 308. Check that a build fails, and verify the changes made during build</strong></span></summary><div class="example-contents"><p>Re-using the example from <a class="link" href="index.html#ex-testBuildFailure-showingenvironmentchanges" title="Example 307. Check that a build fails, and verify the changes made during build" ><code class="literal">testers.testBuildFailure</code></a>, we can see how common checks are made easier and remove the need for <code class="literal">runCommand</code>:</p><pre><code class="programlisting nix">testers.testBuildFailure&#x27; {
  drv = runCommand &quot;doc-example&quot; { } &#x27;&#x27;
    echo ok-ish &gt;&quot;$out&quot;
    echo failing though
    exit 3
  &#x27;&#x27;;
  expectedBuilderExitCode = 3;
  expectedBuilderLogEntries = [ &quot;failing though&quot; ];
  script = &#x27;&#x27;
    grep --silent -F &#x27;ok-ish&#x27; &quot;$failed/result&quot;
  &#x27;&#x27;;
}
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-testBuildFailurePrime-inputs" class="title" >Inputs   </h3>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">drv</code> (derivation)</span></dt><dd><p>The failing derivation to wrap with <code class="literal">testBuildFailure</code>.</p></dd><dt><span class="term"><code class="literal">name</code> (string, optional)</span></dt><dd><p>The name of the test.
When not provided, this value defaults to <code class="literal">testBuildFailure-${(testers.testBuildFailure drv).name}</code>.</p></dd><dt><span class="term"><code class="literal">expectedBuilderExitCode</code> (integer, optional)</span></dt><dd><p>The expected exit code of the builder of <code class="literal">drv</code>.
When not provided, this value defaults to <code class="literal">1</code>.</p></dd><dt><span class="term"><code class="literal">expectedBuilderLogEntries</code> (array of string-like values, optional)</span></dt><dd><p>A list of string-like values which must be found in the builder’s log by exact match.
When not provided, this value defaults to <code class="literal">[ ]</code>.</p><p>NOTE: Patterns and regular expressions are not supported.</p></dd><dt><span class="term"><code class="literal">script</code> (string, optional)</span></dt><dd><p>A string containing additional checks to run.
When not provided, this value defaults to <code class="literal">&quot;&quot;</code>.
The result of <code class="literal">testers.testBuildFailure drv</code> is available through the variable <code class="literal">failed</code>.
As an example, the builder’s log is at <code class="literal">&quot;$failed/testBuildFailure.log&quot;</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-testBuildFailurePrime-return" class="title" >Return value   </h3>  </div> </div></div><p>The tester produces an empty output and only succeeds when the checks using <code class="literal">expectedBuilderExitCode</code>, <code class="literal">expectedBuilderLogEntries</code>, and <code class="literal">script</code> succeed.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-testEqualContents" class="title" style="clear: both"><code class="literal">testEqualContents</code>   </h2>  </div> </div></div><p>Check that two paths have the same contents.</p><div class="example"><span id="ex-testEqualContents-toyexample" ></span><details><summary><span class="title"><strong>Example 309. Check that two paths have the same contents</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">testers.testEqualContents {
  assertion = &quot;sed -e performs replacement&quot;;
  expected = writeText &quot;expected&quot; &#x27;&#x27;
    foo baz baz
  &#x27;&#x27;;
  actual =
    runCommand &quot;actual&quot;
      {
        # not really necessary for a package that&#x27;s in stdenv
        nativeBuildInputs = [ gnused ];
        base = writeText &quot;base&quot; &#x27;&#x27;
          foo bar baz
        &#x27;&#x27;;
      }
      &#x27;&#x27;
        sed -e &#x27;s/bar/baz/g&#x27; $base &gt;$out
      &#x27;&#x27;;
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-testEqualArrayOrMap" class="title" style="clear: both"><code class="literal">testEqualArrayOrMap</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#tester-testEqualArrayOrMap-inputs">Inputs</a> </span></dt><dt> <span class="section">  <a href="index.html#tester-testEqualArrayOrMap-return">Return value</a> </span></dt> </dl></div><p>Check that bash arrays (including associative arrays, referred to as “maps”) are populated correctly.</p><p>This can be used to ensure setup hooks are registered in a certain order, or to write unit tests for shell functions which transform arrays.</p><div class="example"><span id="ex-testEqualArrayOrMap-test-function-add-cowbell" ></span><details><summary><span class="title"><strong>Example 310. Test a function which appends a value to an array</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">testers.testEqualArrayOrMap {
  name = &quot;test-function-add-cowbell&quot;;
  valuesArray = [
    &quot;cowbell&quot;
    &quot;cowbell&quot;
  ];
  expectedArray = [
    &quot;cowbell&quot;
    &quot;cowbell&quot;
    &quot;cowbell&quot;
  ];
  script = &#x27;&#x27;
    addCowbell() {
      local -rn arrayNameRef=&quot;$1&quot;
      arrayNameRef+=( &quot;cowbell&quot; )
    }

    nixLog &quot;appending all values in valuesArray to actualArray&quot;
    for value in &quot;&#x27;&#x27;${valuesArray[@]}&quot;; do
      actualArray+=( &quot;$value&quot; )
    done

    nixLog &quot;applying addCowbell&quot;
    addCowbell actualArray
  &#x27;&#x27;;
}
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-testEqualArrayOrMap-inputs" class="title" >Inputs   </h3>  </div> </div></div><p>NOTE: Internally, this tester uses <code class="literal">__structuredAttrs</code> to handle marshalling between Nix expressions and shell variables.
This imposes the restriction that arrays and “maps” have values which are string-like.</p><p>NOTE: At least one of <code class="literal">expectedArray</code> and <code class="literal">expectedMap</code> must be provided.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (string)</span></dt><dd><p>The name of the test.</p></dd><dt><span class="term"><code class="literal">script</code> (string)</span></dt><dd><p>The singular task of <code class="literal">script</code> is to populate <code class="literal">actualArray</code> or <code class="literal">actualMap</code> (it may populate both).
To do this, <code class="literal">script</code> may access the following shell variables:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">valuesArray</code> (available when <code class="literal">valuesArray</code> is provided to the tester)</p></li><li class="listitem"><p><code class="literal">valuesMap</code> (available when <code class="literal">valuesMap</code> is provided to the tester)</p></li><li class="listitem"><p><code class="literal">actualArray</code> (available when <code class="literal">expectedArray</code> is provided to the tester)</p></li><li class="listitem"><p><code class="literal">actualMap</code> (available when <code class="literal">expectedMap</code> is provided to the tester)</p></li></ul></div><p>While both <code class="literal">expectedArray</code> and <code class="literal">expectedMap</code> are in scope during the execution of <code class="literal">script</code>, they <span class="emphasis"><em>must not</em></span> be accessed or modified from within <code class="literal">script</code>.</p></dd><dt><span class="term"><code class="literal">valuesArray</code> (array of string-like values, optional)</span></dt><dd><p>An array of string-like values.
This array may be used within <code class="literal">script</code>.</p></dd><dt><span class="term"><code class="literal">valuesMap</code> (attribute set of string-like values, optional)</span></dt><dd><p>An attribute set of string-like values.
This attribute set may be used within <code class="literal">script</code>.</p></dd><dt><span class="term"><code class="literal">expectedArray</code> (array of string-like values, optional)</span></dt><dd><p>An array of string-like values.
This array <span class="emphasis"><em>must not</em></span> be accessed or modified from within <code class="literal">script</code>.
When provided, <code class="literal">script</code> is expected to populate <code class="literal">actualArray</code>.</p></dd><dt><span class="term"><code class="literal">expectedMap</code> (attribute set of string-like values, optional)</span></dt><dd><p>An attribute set of string-like values.
This attribute set <span class="emphasis"><em>must not</em></span> be accessed or modified from within <code class="literal">script</code>.
When provided, <code class="literal">script</code> is expected to populate <code class="literal">actualMap</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-testEqualArrayOrMap-return" class="title" >Return value   </h3>  </div> </div></div><p>The tester produces an empty output and only succeeds when <code class="literal">expectedArray</code> and <code class="literal">expectedMap</code> match <code class="literal">actualArray</code> and <code class="literal">actualMap</code>, respectively, when non-null.
The build log will contain differences encountered.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-testEqualDerivation" class="title" style="clear: both"><code class="literal">testEqualDerivation</code>   </h2>  </div> </div></div><p>Checks that two packages produce the exact same build instructions.</p><p>This can be used to make sure that a certain difference of configuration, such as the presence of an overlay does not cause a cache miss.</p><p>When the derivations are equal, the return value is an empty file.
Otherwise, the build log explains the difference via <code class="literal">nix-diff</code>.</p><div class="example"><span id="ex-testEqualDerivation-hello" ></span><details><summary><span class="title"><strong>Example 311. Check that two packages produce the same derivation</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">testers.testEqualDerivation &quot;The hello package must stay the same when enabling checks.&quot; hello (
  hello.overrideAttrs (o: {
    doCheck = true;
  })
)
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-invalidateFetcherByDrvHash" class="title" style="clear: both"><code class="literal">invalidateFetcherByDrvHash</code>   </h2>  </div> </div></div><p>Use the derivation hash to invalidate the output via name, for testing.</p><p>Type: <code class="literal">(a@{ name, ... } -&gt; Derivation) -&gt; a -&gt; Derivation</code></p><p>Normally, fixed output derivations can and should be cached by their output hash only, but for testing we want to re-fetch everytime the fetcher changes.</p><p>Changes to the fetcher become apparent in the drvPath, which is a hash of how to fetch, rather than a fixed store path.
By inserting this hash into the name, we can make sure to re-run the fetcher every time the fetcher changes.</p><p>This relies on the assumption that Nix isn’t clever enough to reuse its database of local store contents to optimize fetching.</p><p>You might notice that the “salted” name derives from the normal invocation, not the final derivation.
<code class="literal">invalidateFetcherByDrvHash</code> has to invoke the fetcher function twice:
once to get a derivation hash, and again to produce the final fixed output derivation.</p><div class="example"><span id="ex-invalidateFetcherByDrvHash-nix" ></span><details><summary><span class="title"><strong>Example 312. Prevent nix from reusing the output of a fetcher</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{
  tests.fetchgit = testers.invalidateFetcherByDrvHash fetchgit {
    name = &quot;nix-source&quot;;
    url = &quot;https://github.com/NixOS/nix&quot;;
    rev = &quot;9d9dbe6ed05854e03811c361a3380e09183f4f4a&quot;;
    hash = &quot;sha256-7DszvbCNTjpzGRmpIVAWXk20P0/XTrWZ79KSOGLrUWY=&quot;;
  };
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-runCommand" class="title" style="clear: both"><code class="literal">runCommand</code>   </h2>  </div> </div></div><p><code class="literal">runCommand :: { name, script, stdenv ? stdenvNoCC, hash ? &quot;...&quot;, ... } -&gt; Derivation</code></p><p>This is a wrapper around <code class="literal">pkgs.runCommandWith</code>, which</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>produces a fixed-output derivation, enabling the command(s) to access the network ;</p></li><li class="listitem"><p>salts the derivation’s name based on its inputs, ensuring the command is re-run whenever the inputs changes.</p></li></ul></div><p>It accepts the following attributes:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>the derivation’s <code class="literal">name</code> ;</p></li><li class="listitem"><p>the <code class="literal">script</code> to be executed ;</p></li><li class="listitem"><p><code class="literal">stdenv</code>, the environment to use, defaulting to <code class="literal">stdenvNoCC</code> ;</p></li><li class="listitem"><p>the derivation’s output <code class="literal">hash</code>, defaulting to the empty file’s.
The derivation’s <code class="literal">outputHashMode</code> is set by default to recursive, so the <code class="literal">script</code> can output a directory as well.</p></li></ul></div><p>All other attributes are passed through to <a class="link" href="index.html#sec-using-stdenv" title="Using stdenv" ><code class="literal">mkDerivation</code></a>,
including <code class="literal">nativeBuildInputs</code> to specify dependencies available to the <code class="literal">script</code>.</p><div class="example"><span id="ex-tester-runCommand-nix" ></span><details><summary><span class="title"><strong>Example 313. Run a command with network access</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">testers.runCommand {
  name = &quot;access-the-internet&quot;;
  script = &#x27;&#x27;
    curl -o /dev/null https://example.com
    touch $out
  &#x27;&#x27;;
  nativeBuildInputs = with pkgs; [
    cacert
    curl
  ];
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-runNixOSTest" class="title" style="clear: both"><code class="literal">runNixOSTest</code>   </h2>  </div> </div></div><p>A helper function that behaves exactly like the NixOS <code class="literal">runTest</code>, except it also assigns this Nixpkgs package set as the <code class="literal">pkgs</code> of the test and makes the <code class="literal">nixpkgs.*</code> options read-only.</p><p>If your test is part of the Nixpkgs repository, or if you need a more general entrypoint, see <a class="link" href="https://nixos.org/manual/nixos/stable/index.html#sec-calling-nixos-tests"  target="_top">“Calling a test” in the NixOS manual</a>.</p><div class="example"><span id="ex-runNixOSTest-hello" ></span><details><summary><span class="title"><strong>Example 314. Run a NixOS test using <code class="literal">runNixOSTest</code></strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">pkgs.testers.runNixOSTest (
  { lib, ... }:
  {
    name = &quot;hello&quot;;
    nodes.machine =
      { pkgs, ... }:
      {
        environment.systemPackages = [ pkgs.hello ];
      };
    testScript = &#x27;&#x27;
      machine.succeed(&quot;hello&quot;)
    &#x27;&#x27;;
  }
)
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tester-nixosTest" class="title" style="clear: both"><code class="literal">nixosTest</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#tester-nixosTest-parameter">Parameter</a> </span></dt><dt> <span class="section">  <a href="index.html#tester-nixosTest-result">Result</a> </span></dt> </dl></div><p>Run a NixOS VM network test using this evaluation of Nixpkgs.</p><p>NOTE: This function is primarily for external use. NixOS itself uses <code class="literal">make-test-python.nix</code> directly. Packages defined in Nixpkgs <a class="link" href="index.html#ssec-nixos-tests-linking" title="Linking NixOS module tests to a package" >reuse NixOS tests via <code class="literal">nixosTests</code>, plural</a>.</p><p>It is mostly equivalent to the function <code class="literal">import ./make-test-python.nix</code> from the <a class="link" href="https://nixos.org/nixos/manual/index.html#sec-nixos-tests"  target="_top">NixOS manual</a>, except that the current application of Nixpkgs (<code class="literal">pkgs</code>) will be used, instead of letting NixOS invoke Nixpkgs anew.</p><p>If a test machine needs to set NixOS options under <code class="literal">nixpkgs</code>, it must set only the <code class="literal">nixpkgs.pkgs</code> option.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-nixosTest-parameter" class="title" >Parameter   </h3>  </div> </div></div><p>A <a class="link" href="https://nixos.org/nixos/manual/index.html#sec-nixos-tests"  target="_top">NixOS VM test network</a>, or path to it. Example:</p><pre><code class="programlisting nix">{
  name = &quot;my-test&quot;;
  nodes = {
    machine1 =
      {
        lib,
        pkgs,
        nodes,
        ...
      }:
      {
        environment.systemPackages = [ pkgs.hello ];
        services.foo.enable = true;
      };
    # machine2 = ...;
  };
  testScript = &#x27;&#x27;
    start_all()
    machine1.wait_for_unit(&quot;foo.service&quot;)
    machine1.succeed(&quot;hello | foo-send&quot;)
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tester-nixosTest-result" class="title" >Result   </h3>  </div> </div></div><p>A derivation that runs the VM test.</p><p>Notable attributes:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">nodes</code>: the evaluated NixOS configurations. Useful for debugging and exploring the configuration.</p></li><li class="listitem"><p><code class="literal">driverInteractive</code>: a script that launches an interactive Python session in the context of the <code class="literal">testScript</code>.</p></li></ul></div>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-devShellTools" class="title" >Development Shell helpers   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-devShellTools-valueToString"><code class="literal">devShellTools.valueToString</code></a> </span></dt><dt> <span class="section">  <a href="index.html#sec-devShellTools-unstructuredDerivationInputEnv"><code class="literal">devShellTools.unstructuredDerivationInputEnv</code></a> </span></dt><dt> <span class="section">  <a href="index.html#sec-devShellTools-derivationOutputEnv"><code class="literal">devShellTools.derivationOutputEnv</code></a> </span></dt> </dl></div><p>The <code class="literal">nix-shell</code> command has popularized the concept of transient shell environments for development or testing purposes.

However, <code class="literal">nix-shell</code> is not the only way to create such environments, and even <code class="literal">nix-shell</code> itself can indirectly benefit from this library.</p><p>This library provides a set of functions that help create such environments.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-devShellTools-valueToString" class="title" style="clear: both"><code class="literal">devShellTools.valueToString</code>   </h2>  </div> </div></div><p>Converts Nix values to strings in the way the <a class="link" href="https://nix.dev/manual/nix/2.23/language/derivations"  target="_top"><code class="literal">derivation</code> built-in function</a> does.</p><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 315. <code class="literal">valueToString</code> usage examples</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">devShellTools.valueToString (builtins.toFile &quot;foo&quot; &quot;bar&quot;)
# =&gt; &quot;/nix/store/...-foo&quot;
</code></pre><pre><code class="programlisting nix">devShellTools.valueToString false
# =&gt; &quot;&quot;
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-devShellTools-unstructuredDerivationInputEnv" class="title" style="clear: both"><code class="literal">devShellTools.unstructuredDerivationInputEnv</code>   </h2>  </div> </div></div><p>Convert a set of derivation attributes (as would be passed to [<code class="literal">derivation</code>]) to a set of environment variables that can be used in a shell script.
This function does not support <code class="literal">__structuredAttrs</code>, but does support <code class="literal">passAsFile</code>.</p><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 316. <code class="literal">unstructuredDerivationInputEnv</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">devShellTools.unstructuredDerivationInputEnv {
  drvAttrs = {
    name = &quot;foo&quot;;
    buildInputs = [
      hello
      figlet
    ];
    builder = bash;
    args = [
      &quot;-c&quot;
      &quot;${./builder.sh}&quot;
    ];
  };
}
# =&gt; {
#  name = &quot;foo&quot;;
#  buildInputs = &quot;/nix/store/...-hello /nix/store/...-figlet&quot;;
#  builder = &quot;/nix/store/...-bash&quot;;
#}
</code></pre><p>Note that <code class="literal">args</code> is not included, because Nix does not added it to the builder process environment.</p></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-devShellTools-derivationOutputEnv" class="title" style="clear: both"><code class="literal">devShellTools.derivationOutputEnv</code>   </h2>  </div> </div></div><p>Takes the relevant parts of a derivation and returns a set of environment variables, that would be present in the derivation.</p><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 317. <code class="literal">derivationOutputEnv</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">let
  pkg = hello;
in
devShellTools.derivationOutputEnv {
  outputList = pkg.outputs;
  outputMap = pkg;
}
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-special" class="title" >Special build helpers   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-fakeNss">fakeNss</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-fhs-environments">buildFHSEnv</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs.makeSetupHook">pkgs.makeSetupHook</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-mkShell">pkgs.mkShell</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-vm-tools">vmTools</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-checkpoint-build">pkgs.checkpointBuildTools</a> </span></dt> </dl></div><p>This chapter describes several special build helpers.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-fakeNss" class="title" style="clear: both">fakeNss   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-fakeNss-inputs">Inputs</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-fakeNss-examples">Examples</a> </span></dt> </dl></div><p>Provides <code class="literal">/etc/passwd</code> and <code class="literal">/etc/group</code> files that contain <code class="literal">root</code> and <code class="literal">nobody</code>, allowing user/group lookups to work in binaries that insist on doing those.
This might be a better choice than a custom script running <code class="literal">useradd</code> and related utilities if you only need those files to exist with some entries.</p><p><code class="literal">fakeNss</code> also provides <code class="literal">/etc/nsswitch.conf</code>, configuring NSS host resolution to first check <code class="literal">/etc/hosts</code> before checking DNS, since the default in the absence of a config file (<code class="literal">dns [!UNAVAIL=return] files</code>) is quite unexpected.</p><p>It also creates an empty directory at <code class="literal">/var/empty</code> because it uses that as the home directory for the <code class="literal">root</code> and <code class="literal">nobody</code> users.
The <code class="literal">/var/empty</code> directory can also be used as a <code class="literal">chroot</code> target to prevent file access in processes that do not need to access files, if your container runs such processes.</p><p>The user entries created by <code class="literal">fakeNss</code> use the <code class="literal">/bin/sh</code> shell, which is not provided by <code class="literal">fakeNss</code> because in most cases it won’t be used.
If you need that to be available, see <a class="link" href="index.html#sssec-pkgs-dockerTools-helpers-binSh" title="binSh" ><code class="literal">dockerTools.binSh</code></a> or provide your own.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-fakeNss-inputs" class="title" >Inputs   </h3>  </div> </div></div><p><code class="literal">fakeNss</code> is made available in Nixpkgs as a package rather than a function, but it has two attributes that can be overridden and might be useful in particular cases.
For more details on how overriding works, see <a class="xref" href="index.html#ex-fakeNss-overriding" title="Example 319. Using fakeNss with an override to add extra lines" >Example 319</a> and <a class="xref" href="index.html#sec-pkg-override" title="&lt;pkg&gt;.override" >the section called “&lt;pkg&gt;.override”</a>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">extraPasswdLines</code> (List of Strings; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A list of lines that will be added to <code class="literal">/etc/passwd</code>.
Useful if extra users need to exist in the output of <code class="literal">fakeNss</code>.
If <code class="literal">extraPasswdLines</code> is specified, it will <span class="strong"><strong>not</strong></span> override the <code class="literal">root</code> and <code class="literal">nobody</code> entries created by <code class="literal">fakeNss</code>.
Those entries will always exist.</p><p>Lines specified here must follow the format in <a class="link" href="https://man.archlinux.org/man/passwd.5" target="_top"><span class="citerefentry"><span class="refentrytitle">passwd</span>(5)</span></a>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">[]</code>.</p></dd><dt><span class="term"><code class="literal">extraGroupLines</code> (List of Strings; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A list of lines that will be added to <code class="literal">/etc/group</code>.
Useful if extra groups need to exist in the output of <code class="literal">fakeNss</code>.
If <code class="literal">extraGroupLines</code> is specified, it will <span class="strong"><strong>not</strong></span> override the <code class="literal">root</code> and <code class="literal">nobody</code> entries created by <code class="literal">fakeNss</code>.
Those entries will always exist.</p><p>Lines specified here must follow the format in <a class="link" href="https://man.archlinux.org/man/group.5" target="_top"><span class="citerefentry"><span class="refentrytitle">group</span>(5)</span></a>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">[]</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-fakeNss-examples" class="title" >Examples   </h3>  </div> </div></div><div class="example"><span id="ex-fakeNss-dockerTools-buildImage" ></span><details><summary><span class="title"><strong>Example 318. Using <code class="literal">fakeNss</code> with <code class="literal">dockerTools.buildImage</code></strong></span></summary><div class="example-contents"><p>This example shows how to use <code class="literal">fakeNss</code> as-is.
It is useful with functions in <code class="literal">dockerTools</code> to allow building Docker images that have the <code class="literal">/etc/passwd</code> and <code class="literal">/etc/group</code> files.
This example includes the <code class="literal">hello</code> binary in the image so it can do something besides just have the extra files.</p><pre><code class="programlisting nix">{
  dockerTools,
  fakeNss,
  hello,
}:
dockerTools.buildImage {
  name = &quot;image-with-passwd&quot;;
  tag = &quot;latest&quot;;

  copyToRoot = [
    fakeNss
    hello
  ];

  config = {
    Cmd = [ &quot;/bin/hello&quot; ];
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-fakeNss-overriding" ></span><details><summary><span class="title"><strong>Example 319. Using <code class="literal">fakeNss</code> with an override to add extra lines</strong></span></summary><div class="example-contents"><p>The following code uses <code class="literal">override</code> to add extra lines to <code class="literal">/etc/passwd</code> and <code class="literal">/etc/group</code> to create another user and group entry.</p><pre><code class="programlisting nix">{ fakeNss }:
fakeNss.override {
  extraPasswdLines = [ &quot;newuser:x:9001:9001:new user:/var/empty:/bin/sh&quot; ];
  extraGroupLines = [ &quot;newuser:x:9001:&quot; ];
}
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-fhs-environments" class="title" style="clear: both">buildFHSEnv   </h2>  </div> </div></div><p><code class="literal">buildFHSEnv</code> provides a way to build and run FHS-compatible lightweight sandboxes. It creates an isolated root filesystem with the host’s <code class="literal">/nix/store</code>, so its footprint in terms of disk space is quite small. This allows you to run software which is hard or unfeasible to patch for NixOS; 3rd-party source trees with FHS assumptions, games distributed as tarballs, software with integrity checking and/or external self-updated binaries for instance.
It uses Linux’ namespaces feature to create temporary lightweight environments which are destroyed after all child processes exit, without requiring elevated privileges. It works similar to containerisation technology such as Docker or FlatPak but provides no security-relevant separation from the host system.</p><p>Accepted arguments are:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">name</code>
The name of the environment.</p></li><li class="listitem"><p><code class="literal">pname</code>
The pname of the environment.</p></li><li class="listitem"><p><code class="literal">version</code>
The version of the environment.</p></li><li class="listitem"><p><code class="literal">executableName</code>
The name of the wrapper executable. Defaults to <code class="literal">pname</code> if set, or <code class="literal">name</code> otherwise.</p></li><li class="listitem"><p><code class="literal">targetPkgs</code>
Packages to be installed for the main host’s architecture (i.e. x86_64 on x86_64 installations). Along with libraries binaries are also installed.</p></li><li class="listitem"><p><code class="literal">multiPkgs</code>
Packages to be installed for all architectures supported by a host (i.e. i686 and x86_64 on x86_64 installations). Only libraries are installed by default.</p></li><li class="listitem"><p><code class="literal">multiArch</code>
Whether to install 32bit multiPkgs into the FHSEnv in 64bit environments</p></li><li class="listitem"><p><code class="literal">extraBuildCommands</code>
Additional commands to be executed for finalizing the directory structure.</p></li><li class="listitem"><p><code class="literal">extraBuildCommandsMulti</code>
Like <code class="literal">extraBuildCommands</code>, but executed only on multilib architectures.</p></li><li class="listitem"><p><code class="literal">extraOutputsToInstall</code>
Additional derivation outputs to be linked for both target and multi-architecture packages.</p></li><li class="listitem"><p><code class="literal">extraInstallCommands</code>
Additional commands to be executed for finalizing the derivation with runner script.</p></li><li class="listitem"><p><code class="literal">runScript</code>
A shell command to be executed inside the sandbox. It defaults to <code class="literal">bash</code>. Command line arguments passed to the resulting wrapper are appended to this command by default.
This command must be escaped; i.e. <code class="literal">&quot;foo app&quot; --do-stuff --with &quot;some file&quot;</code>. See <code class="literal">lib.escapeShellArgs</code>.</p></li><li class="listitem"><p><code class="literal">profile</code>
Optional script for <code class="literal">/etc/profile</code> within the sandbox.</p></li></ul></div><p>You can create a simple environment using a <code class="literal">shell.nix</code> like this:</p><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:

(pkgs.buildFHSEnv {
  name = &quot;simple-x11-env&quot;;
  targetPkgs =
    pkgs:
    (with pkgs; [
      udev
      alsa-lib
    ])
    ++ (with pkgs.xorg; [
      libX11
      libXcursor
      libXrandr
    ]);
  multiPkgs =
    pkgs:
    (with pkgs; [
      udev
      alsa-lib
    ]);
  runScript = &quot;bash&quot;;
}).env
</code></pre><p>Running <code class="literal">nix-shell</code> on it would drop you into a shell inside an FHS env where those libraries and binaries are available in FHS-compliant paths. Applications that expect an FHS structure (i.e. proprietary binaries) can run inside this environment without modification.
You can build a wrapper by running your binary in <code class="literal">runScript</code>, e.g. <code class="literal">./bin/start.sh</code>. Relative paths work as expected.</p><p>Additionally, the FHS builder links all relocated gsettings-schemas (the glib setup-hook moves them to <code class="literal">share/gsettings-schemas/${name}/glib-2.0/schemas</code>) to their standard FHS location. This means you don’t need to wrap binaries with <code class="literal">wrapGApps*</code> hook.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs.makeSetupHook" class="title" style="clear: both">pkgs.makeSetupHook   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-pkgs.makeSetupHook-usage">Usage</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs.makeSetupHook-attributes">Attributes</a> </span></dt> </dl></div><p><code class="literal">pkgs.makeSetupHook</code> is a build helper that produces hooks that go in to <code class="literal">nativeBuildInputs</code></p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs.makeSetupHook-usage" class="title" >Usage   </h3>  </div> </div></div><pre><code class="programlisting nix">pkgs.makeSetupHook {
  name = &quot;something-hook&quot;;
  propagatedBuildInputs = [ pkgs.commandsomething ];
  depsTargetTargetPropagated = [ pkgs.libsomething ];
} ./script.sh
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-pkgs.makeSetupHook-usage-example" class="title" >setup hook that depends on the hello package and runs hello and @shell@ is substituted with path to bash   </h4>  </div> </div></div><pre><code class="programlisting nix">pkgs.makeSetupHook
  {
    name = &quot;run-hello-hook&quot;;
    # Put dependencies here if they have hooks or necessary dependencies propagated
    # otherwise prefer direct paths to executables.
    propagatedBuildInputs = [
      pkgs.hello
      pkgs.cowsay
    ];
    substitutions = {
      shell = &quot;${pkgs.bash}/bin/bash&quot;;
      cowsay = &quot;${pkgs.cowsay}/bin/cowsay&quot;;
    };
  }
  (
    writeScript &quot;run-hello-hook.sh&quot; &#x27;&#x27;
      #!@shell@
      # the direct path to the executable has to be here because
      # this will be run when the file is sourced
      # at which point &#x27;$PATH&#x27; has not yet been populated with inputs
      @cowsay@ cow

      _printHelloHook() {
        hello
      }
      preConfigureHooks+=(_printHelloHook)
    &#x27;&#x27;
  )
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs.makeSetupHook-attributes" class="title" >Attributes   </h3>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">name</code> Set the name of the hook.</p></li><li class="listitem"><p><code class="literal">propagatedBuildInputs</code> Runtime dependencies (such as binaries) of the hook.</p></li><li class="listitem"><p><code class="literal">depsTargetTargetPropagated</code> Non-binary dependencies.</p></li><li class="listitem"><p><code class="literal">meta</code></p></li><li class="listitem"><p><code class="literal">passthru</code></p></li><li class="listitem"><p><code class="literal">substitutions</code> Variables for <code class="literal">substituteAll</code></p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-mkShell" class="title" style="clear: both">pkgs.mkShell   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-pkgs-mkShell-usage">Usage</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-mkShell-attributes">Attributes</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-mkShell-variants">Variants</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-mkShell-building">Building the shell</a> </span></dt> </dl></div><p><code class="literal">pkgs.mkShell</code> is a specialized <code class="literal">stdenv.mkDerivation</code> that removes some
repetition when using it with <code class="literal">nix-shell</code> (or <code class="literal">nix develop</code>).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs-mkShell-usage" class="title" >Usage   </h3>  </div> </div></div><p>Here is a common usage example:</p><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:
pkgs.mkShell {
  packages = [ pkgs.gnumake ];

  inputsFrom = [
    pkgs.hello
    pkgs.gnutar
  ];

  shellHook = &#x27;&#x27;
    export DEBUG=1
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs-mkShell-attributes" class="title" >Attributes   </h3>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">name</code> (default: <code class="literal">nix-shell</code>). Set the name of the derivation.</p></li><li class="listitem"><p><code class="literal">packages</code> (default: <code class="literal">[]</code>). Add executable packages to the <code class="literal">nix-shell</code> environment.</p></li><li class="listitem"><p><code class="literal">inputsFrom</code> (default: <code class="literal">[]</code>). Add build dependencies of the listed derivations to the <code class="literal">nix-shell</code> environment.</p></li><li class="listitem"><p><code class="literal">shellHook</code> (default: <code class="literal">&quot;&quot;</code>). Bash statements that are executed by <code class="literal">nix-shell</code>.</p></li></ul></div><p>… all the attributes of <code class="literal">stdenv.mkDerivation</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs-mkShell-variants" class="title" >Variants   </h3>  </div> </div></div><p><code class="literal">pkgs.mkShellNoCC</code> is a variant that uses <code class="literal">stdenvNoCC</code> instead of <code class="literal">stdenv</code> as base environment. This is useful if no C compiler is needed in the shell environment.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs-mkShell-building" class="title" >Building the shell   </h3>  </div> </div></div><p>This derivation output will contain a text file that contains a reference to
all the build inputs. This is useful in CI where we want to make sure that
every derivation, and its dependencies, build properly. Or when creating a GC
root so that the build dependencies don’t get garbage-collected.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-vm-tools" class="title" style="clear: both">vmTools   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#vm-tools-createEmptyImage"><code class="literal">vmTools.createEmptyImage</code></a> </span></dt><dt> <span class="section">  <a href="index.html#vm-tools-runInLinuxVM"><code class="literal">vmTools.runInLinuxVM</code></a> </span></dt><dt> <span class="section">  <a href="index.html#vm-tools-extractFs"><code class="literal">vmTools.extractFs</code></a> </span></dt><dt> <span class="section">  <a href="index.html#vm-tools-extractMTDfs"><code class="literal">vmTools.extractMTDfs</code></a> </span></dt><dt> <span class="section">  <a href="index.html#vm-tools-runInLinuxImage"><code class="literal">vmTools.runInLinuxImage</code></a> </span></dt><dt> <span class="section">  <a href="index.html#vm-tools-makeImageTestScript"><code class="literal">vmTools.makeImageTestScript</code></a> </span></dt><dt> <span class="section">  <a href="index.html#vm-tools-diskImageFuns"><code class="literal">vmTools.diskImageFuns</code></a> </span></dt><dt> <span class="section">  <a href="index.html#vm-tools-diskImageExtraFuns"><code class="literal">vmTools.diskImageExtraFuns</code></a> </span></dt><dt> <span class="section">  <a href="index.html#vm-tools-diskImages"><code class="literal">vmTools.diskImages</code></a> </span></dt> </dl></div><p>A set of VM related utilities, that help in building some packages in more advanced scenarios.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="vm-tools-createEmptyImage" class="title" ><code class="literal">vmTools.createEmptyImage</code>   </h3>  </div> </div></div><p>A bash script fragment that produces a disk image at <code class="literal">destination</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="vm-tools-createEmptyImage-attributes" class="title" >Attributes   </h4>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">size</code>. The disk size, in MiB.</p></li><li class="listitem"><p><code class="literal">fullName</code>. Name that will be written to <code class="literal">${destination}/nix-support/full-name</code>.</p></li><li class="listitem"><p><code class="literal">destination</code> (optional, default <code class="literal">$out</code>). Where to write the image files.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="vm-tools-runInLinuxVM" class="title" ><code class="literal">vmTools.runInLinuxVM</code>   </h3>  </div> </div></div><p>Run a derivation in a Linux virtual machine (using Qemu/KVM).
By default, there is no disk image; the root filesystem is a <code class="literal">tmpfs</code>, and the Nix store is shared with the host (via the <a class="link" href="https://wiki.qemu.org/Documentation/9p#9p_Protocol"  target="_top">9P protocol</a>).
Thus, any pure Nix derivation should run unmodified.</p><p>If the build fails and Nix is run with the <code class="literal">-K/--keep-failed</code> option, a script <code class="literal">run-vm</code> will be left behind in the temporary build directory that allows you to boot into the VM and debug it interactively.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="vm-tools-runInLinuxVM-attributes" class="title" >Attributes   </h4>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">preVM</code> (optional). Shell command to be evaluated <span class="emphasis"><em>before</em></span> the VM is started (i.e., on the host).</p></li><li class="listitem"><p><code class="literal">memSize</code> (optional, default <code class="literal">512</code>). The memory size of the VM in MiB (1024×1024 bytes).</p></li><li class="listitem"><p><code class="literal">diskImage</code> (optional). A file system image to be attached to <code class="literal">/dev/sda</code>.
Note that currently we expect the image to contain a filesystem, not a full disk image with a partition table etc.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="vm-tools-runInLinuxVM-examples" class="title" >Examples   </h4>  </div> </div></div><p>Build the derivation hello inside a VM:</p><pre><code class="programlisting nix">{ pkgs }: with pkgs; with vmTools; runInLinuxVM hello
</code></pre><p>Build inside a VM with extra memory:</p><pre><code class="programlisting nix">{ pkgs }:
with pkgs;
with vmTools;
runInLinuxVM (
  hello.overrideAttrs (_: {
    memSize = 1024;
  })
)
</code></pre><p>Use VM with a disk image (implicitly sets <code class="literal">diskImage</code>, see <a class="link" href="index.html#vm-tools-createEmptyImage" title="vmTools.createEmptyImage" ><code class="literal">vmTools.createEmptyImage</code></a>):</p><pre><code class="programlisting nix">{ pkgs }:
with pkgs;
with vmTools;
runInLinuxVM (
  hello.overrideAttrs (_: {
    preVM = createEmptyImage {
      size = 1024;
      fullName = &quot;vm-image&quot;;
    };
  })
)
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="vm-tools-extractFs" class="title" ><code class="literal">vmTools.extractFs</code>   </h3>  </div> </div></div><p>Takes a file, such as an ISO, and extracts its contents into the store.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="vm-tools-extractFs-attributes" class="title" >Attributes   </h4>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">file</code>. Path to the file to be extracted.
Note that currently we expect the image to contain a filesystem, not a full disk image with a partition table etc.</p></li><li class="listitem"><p><code class="literal">fs</code> (optional). Filesystem of the contents of the file.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="vm-tools-extractFs-examples" class="title" >Examples   </h4>  </div> </div></div><p>Extract the contents of an ISO file:</p><pre><code class="programlisting nix">{ pkgs }: with pkgs; with vmTools; extractFs { file = ./image.iso; }
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="vm-tools-extractMTDfs" class="title" ><code class="literal">vmTools.extractMTDfs</code>   </h3>  </div> </div></div><p>Like <a class="xref" href="index.html#vm-tools-extractFs" title="vmTools.extractFs" >the section called “<code class="literal">vmTools.extractFs</code>”</a>, but it makes use of a <a class="link" href="https://en.wikipedia.org/wiki/Memory_Technology_Device"  target="_top">Memory Technology Device (MTD)</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="vm-tools-runInLinuxImage" class="title" ><code class="literal">vmTools.runInLinuxImage</code>   </h3>  </div> </div></div><p>Like <a class="xref" href="index.html#vm-tools-runInLinuxVM" title="vmTools.runInLinuxVM" >the section called “<code class="literal">vmTools.runInLinuxVM</code>”</a>, but instead of using <code class="literal">stdenv</code> from the Nix store, run the build using the tools provided by <code class="literal">/bin</code>, <code class="literal">/usr/bin</code>, etc. from the specified filesystem image, which typically is a filesystem containing a <a class="link" href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard"  target="_top">FHS</a>-based Linux distribution.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="vm-tools-makeImageTestScript" class="title" ><code class="literal">vmTools.makeImageTestScript</code>   </h3>  </div> </div></div><p>Generate a script that can be used to run an interactive session in the given image.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="vm-tools-makeImageTestScript-examples" class="title" >Examples   </h4>  </div> </div></div><p>Create a script for running a Fedora 27 VM:</p><pre><code class="programlisting nix">{ pkgs }: with pkgs; with vmTools; makeImageTestScript diskImages.fedora27x86_64
</code></pre><p>Create a script for running an Ubuntu 20.04 VM:</p><pre><code class="programlisting nix">{ pkgs }: with pkgs; with vmTools; makeImageTestScript diskImages.ubuntu2004x86_64
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="vm-tools-diskImageFuns" class="title" ><code class="literal">vmTools.diskImageFuns</code>   </h3>  </div> </div></div><p>A set of functions that build a predefined set of minimal Linux distributions images.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="vm-tools-diskImageFuns-images" class="title" >Images   </h4>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Fedora</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><code class="literal">fedora26x86_64</code></p></li><li class="listitem"><p><code class="literal">fedora27x86_64</code></p></li></ul></div></li><li class="listitem"><p>CentOS</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><code class="literal">centos6i386</code></p></li><li class="listitem"><p><code class="literal">centos6x86_64</code></p></li><li class="listitem"><p><code class="literal">centos7x86_64</code></p></li></ul></div></li><li class="listitem"><p>Ubuntu</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><code class="literal">ubuntu1404i386</code></p></li><li class="listitem"><p><code class="literal">ubuntu1404x86_64</code></p></li><li class="listitem"><p><code class="literal">ubuntu1604i386</code></p></li><li class="listitem"><p><code class="literal">ubuntu1604x86_64</code></p></li><li class="listitem"><p><code class="literal">ubuntu1804i386</code></p></li><li class="listitem"><p><code class="literal">ubuntu1804x86_64</code></p></li><li class="listitem"><p><code class="literal">ubuntu2004i386</code></p></li><li class="listitem"><p><code class="literal">ubuntu2004x86_64</code></p></li><li class="listitem"><p><code class="literal">ubuntu2204i386</code></p></li><li class="listitem"><p><code class="literal">ubuntu2204x86_64</code></p></li></ul></div></li><li class="listitem"><p>Debian</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><code class="literal">debian10i386</code></p></li><li class="listitem"><p><code class="literal">debian10x86_64</code></p></li><li class="listitem"><p><code class="literal">debian11i386</code></p></li><li class="listitem"><p><code class="literal">debian11x86_64</code></p></li><li class="listitem"><p><code class="literal">debian12i386</code></p></li><li class="listitem"><p><code class="literal">debian12x86_64</code></p></li></ul></div></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="vm-tools-diskImageFuns-attributes" class="title" >Attributes   </h4>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">size</code> (optional, defaults to <code class="literal">4096</code>). The size of the image, in MiB.</p></li><li class="listitem"><p><code class="literal">extraPackages</code> (optional). A list names of additional packages from the distribution that should be included in the image.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="vm-tools-diskImageFuns-examples" class="title" >Examples   </h4>  </div> </div></div><p>8GiB image containing Firefox in addition to the default packages:</p><pre><code class="programlisting nix">{ pkgs }:
with pkgs;
with vmTools;
diskImageFuns.ubuntu2004x86_64 {
  extraPackages = [ &quot;firefox&quot; ];
  size = 8192;
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="vm-tools-diskImageExtraFuns" class="title" ><code class="literal">vmTools.diskImageExtraFuns</code>   </h3>  </div> </div></div><p>Shorthand for <code class="literal">vmTools.diskImageFuns.&lt;attr&gt; { extraPackages = ... }</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="vm-tools-diskImages" class="title" ><code class="literal">vmTools.diskImages</code>   </h3>  </div> </div></div><p>Shorthand for <code class="literal">vmTools.diskImageFuns.&lt;attr&gt; { }</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-checkpoint-build" class="title" style="clear: both">pkgs.checkpointBuildTools   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-checkpoint-build-example">Example</a> </span></dt> </dl></div><p><code class="literal">pkgs.checkpointBuildTools</code> provides a way to build derivations incrementally. It consists of two functions to make checkpoint builds using Nix possible.</p><p>For hermeticity, Nix derivations do not allow any state to be carried over between builds, making a transparent incremental build within a derivation impossible.</p><p>However, we can tell Nix explicitly what the previous build state was, by representing that previous state as a derivation output. This allows the passed build state to be used for an incremental build.</p><p>To change a normal derivation to a checkpoint based build, these steps must be taken:</p><pre><code class="programlisting nix">{
  checkpointArtifacts = (pkgs.checkpointBuildTools.prepareCheckpointBuild pkgs.virtualbox);
}
</code></pre><pre><code class="programlisting nix">{
  changedVBox = pkgs.virtualbox.overrideAttrs (old: {
    src = path/to/vbox/sources;
  });
}
</code></pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>use <code class="literal">mkCheckpointBuild changedVBox checkpointArtifacts</code></p></li><li class="listitem"><p>enjoy shorter build times</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-checkpoint-build-example" class="title" >Example   </h3>  </div> </div></div><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:
let
  inherit (pkgs.checkpointBuildTools) prepareCheckpointBuild mkCheckpointBuild;
  helloCheckpoint = prepareCheckpointBuild pkgs.hello;
  changedHello = pkgs.hello.overrideAttrs (_: {
    doCheck = false;
    postPatch = &#x27;&#x27;
      sed -i &#x27;s/Hello, world!/Hello, Nix!/g&#x27; src/hello.c
    &#x27;&#x27;;
  });
in
mkCheckpointBuild changedHello helloCheckpoint
</code></pre>
</div>

</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-images" class="title" >Images   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-pkgs-appimageTools">pkgs.appimageTools</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-dockerTools">pkgs.dockerTools</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-ociTools">pkgs.ociTools</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-portableService">pkgs.portableService</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-make-disk-image"><code class="literal">&lt;nixpkgs/nixos/lib/make-disk-image.nix&gt;</code></a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkgs-binary-cache">pkgs.mkBinaryCache</a> </span></dt> </dl></div><p>This chapter describes tools for creating various types of images.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-appimageTools" class="title" style="clear: both">pkgs.appimageTools   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-pkgs-appimageTools-wrapping">Wrapping</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-pkgs-appimageTools-extracting">Extracting</a> </span></dt> </dl></div><p><code class="literal">pkgs.appimageTools</code> is a set of functions for extracting and wrapping <a class="link" href="https://appimage.org/"  target="_top">AppImage</a> files.
They are meant to be used if traditional packaging from source is infeasible, or if it would take too long.
To quickly run an AppImage file, <code class="literal">pkgs.appimage-run</code> can be used as well.</p><div class="warning"><h3 class="title">Warning</h3><p>The <code class="literal">appimageTools</code> API is unstable and may be subject to backwards-incompatible changes in the future.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-appimageTools-wrapping" class="title" >Wrapping   </h3>  </div> </div></div><p>Use <code class="literal">wrapType2</code> to wrap any AppImage.
This will create a FHS environment with many packages <a class="link" href="https://github.com/AppImage/pkg2appimage/blob/master/excludelist"  target="_top">expected to exist</a> for the AppImage to work.
<code class="literal">wrapType2</code> expects an argument with the <code class="literal">src</code> attribute, and either a <code class="literal">name</code> attribute or <code class="literal">pname</code> and <code class="literal">version</code> attributes.</p><p>It will eventually call into <a class="link" href="index.html#sec-fhs-environments" title="buildFHSEnv" ><code class="literal">buildFHSEnv</code></a>, and any extra attributes in the argument to <code class="literal">wrapType2</code> will be passed through to it.
This means that you can pass the <code class="literal">extraInstallCommands</code> attribute, for example, and it will have the same effect as described in <a class="link" href="index.html#sec-fhs-environments" title="buildFHSEnv" ><code class="literal">buildFHSEnv</code></a>.</p><div class="note"><h3 class="title">Note</h3><p>In the past, <code class="literal">appimageTools</code> provided both <code class="literal">wrapType1</code> and <code class="literal">wrapType2</code>, to be used depending on the type of AppImage that was being wrapped.
However, <a class="link" href="https://github.com/NixOS/nixpkgs/pull/81833"  target="_top">those were unified early 2020</a>, meaning that both <code class="literal">wrapType1</code> and <code class="literal">wrapType2</code> have the same behaviour now.</p></div><div class="example"><span id="ex-wrapping-appimage-from-github" ></span><details><summary><span class="title"><strong>Example 320. Wrapping an AppImage from GitHub</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ appimageTools, fetchurl }:
let
  pname = &quot;nuclear&quot;;
  version = &quot;0.6.30&quot;;

  src = fetchurl {
    url = &quot;https://github.com/nukeop/nuclear/releases/download/v${version}/nuclear-v${version}.AppImage&quot;;
    hash = &quot;sha256-he1uGC1M/nFcKpMM9JKY4oeexJcnzV0ZRxhTjtJz6xw=&quot;;
  };
in
appimageTools.wrapType2 { inherit pname version src; }
</code></pre></div></details></div><br class="example-break" /><p>The argument passed to <code class="literal">wrapType2</code> can also contain an <code class="literal">extraPkgs</code> attribute, which allows you to include additional packages inside the FHS environment your AppImage is going to run in.
<code class="literal">extraPkgs</code> must be a function that returns a list of packages.
There are a few ways to learn which dependencies an application needs:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Looking through the extracted AppImage files, reading its scripts and running <code class="literal">patchelf</code> and <code class="literal">ldd</code> on its executables.
This can also be done in <code class="literal">appimage-run</code>, by setting <code class="literal">APPIMAGE_DEBUG_EXEC=bash</code>.</p></li><li class="listitem"><p>Running <code class="literal">strace -vfefile</code> on the wrapped executable, looking for libraries that can’t be found.</p></li></ul></div><div class="example"><span id="ex-wrapping-appimage-with-extrapkgs" ></span><details><summary><span class="title"><strong>Example 321. Wrapping an AppImage with extra packages</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ appimageTools, fetchurl }:
let
  pname = &quot;irccloud&quot;;
  version = &quot;0.16.0&quot;;

  src = fetchurl {
    url = &quot;https://github.com/irccloud/irccloud-desktop/releases/download/v${version}/IRCCloud-${version}-linux-x86_64.AppImage&quot;;
    hash = &quot;sha256-/hMPvYdnVB1XjKgU2v47HnVvW4+uC3rhRjbucqin4iI=&quot;;
  };
in
appimageTools.wrapType2 {
  inherit pname version src;
  extraPkgs = pkgs: [ pkgs.at-spi2-core ];
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-appimageTools-extracting" class="title" >Extracting   </h3>  </div> </div></div><p>Use <code class="literal">extract</code> if you need to extract the contents of an AppImage.
This is usually used in Nixpkgs to install extra files in addition to <a class="link" href="index.html#ssec-pkgs-appimageTools-wrapping" title="Wrapping" >wrapping</a> the AppImage.
<code class="literal">extract</code> expects an argument with the <code class="literal">src</code> attribute, and either a <code class="literal">name</code> attribute or <code class="literal">pname</code> and <code class="literal">version</code> attributes.</p><div class="note"><h3 class="title">Note</h3><p>In the past, <code class="literal">appimageTools</code> provided both <code class="literal">extractType1</code> and <code class="literal">extractType2</code>, to be used depending on the type of AppImage that was being extracted.
However, <a class="link" href="https://github.com/NixOS/nixpkgs/pull/81572"  target="_top">those were unified early 2020</a>, meaning that both <code class="literal">extractType1</code> and <code class="literal">extractType2</code> have the same behaviour as <code class="literal">extract</code> now.</p></div><div class="example"><span id="ex-extracting-appimage" ></span><details><summary><span class="title"><strong>Example 322. Extracting an AppImage to install extra files</strong></span></summary><div class="example-contents"><p>This example was adapted from a real package in Nixpkgs to show how <code class="literal">extract</code> is usually used in combination with <code class="literal">wrapType2</code>.
Note how <code class="literal">appimageContents</code> is used in <code class="literal">extraInstallCommands</code> to install additional files that were extracted from the AppImage.</p><pre><code class="programlisting nix">{ appimageTools, fetchurl }:
let
  pname = &quot;irccloud&quot;;
  version = &quot;0.16.0&quot;;

  src = fetchurl {
    url = &quot;https://github.com/irccloud/irccloud-desktop/releases/download/v${version}/IRCCloud-${version}-linux-x86_64.AppImage&quot;;
    hash = &quot;sha256-/hMPvYdnVB1XjKgU2v47HnVvW4+uC3rhRjbucqin4iI=&quot;;
  };

  appimageContents = appimageTools.extract { inherit pname version src; };
in
appimageTools.wrapType2 {
  inherit pname version src;

  extraPkgs = pkgs: [ pkgs.at-spi2-core ];

  extraInstallCommands = &#x27;&#x27;
    mv $out/bin/${pname}-${version} $out/bin/${pname}
    install -m 444 -D ${appimageContents}/irccloud.desktop $out/share/applications/irccloud.desktop
    install -m 444 -D ${appimageContents}/usr/share/icons/hicolor/512x512/apps/irccloud.png \
      $out/share/icons/hicolor/512x512/apps/irccloud.png
    substituteInPlace $out/share/applications/irccloud.desktop \
      --replace-fail &#x27;Exec=AppRun&#x27; &#x27;Exec=${pname}&#x27;
  &#x27;&#x27;;
}
</code></pre></div></details></div><br class="example-break" /><p>The argument passed to <code class="literal">extract</code> can also contain a <code class="literal">postExtract</code> attribute, which allows you to execute additional commands after the files are extracted from the AppImage.
<code class="literal">postExtract</code> must be a string with commands to run.</p><div class="example"><span id="ex-extracting-appimage-with-postextract" ></span><details><summary><span class="title"><strong>Example 323. Extracting an AppImage to install extra files, using <code class="literal">postExtract</code></strong></span></summary><div class="example-contents"><p>This is a rewrite of <a class="xref" href="index.html#ex-extracting-appimage" title="Example 322. Extracting an AppImage to install extra files" >Example 322</a> to use <code class="literal">postExtract</code>.</p><pre><code class="programlisting nix">{ appimageTools, fetchurl }:
let
  pname = &quot;irccloud&quot;;
  version = &quot;0.16.0&quot;;

  src = fetchurl {
    url = &quot;https://github.com/irccloud/irccloud-desktop/releases/download/v${version}/IRCCloud-${version}-linux-x86_64.AppImage&quot;;
    hash = &quot;sha256-/hMPvYdnVB1XjKgU2v47HnVvW4+uC3rhRjbucqin4iI=&quot;;
  };

  appimageContents = appimageTools.extract {
    inherit pname version src;
    postExtract = &#x27;&#x27;
      substituteInPlace $out/irccloud.desktop --replace-fail &#x27;Exec=AppRun&#x27; &#x27;Exec=${pname}&#x27;
    &#x27;&#x27;;
  };
in
appimageTools.wrapType2 {
  inherit pname version src;

  extraPkgs = pkgs: [ pkgs.at-spi2-core ];

  extraInstallCommands = &#x27;&#x27;
    mv $out/bin/${pname}-${version} $out/bin/${pname}
    install -m 444 -D ${appimageContents}/irccloud.desktop $out/share/applications/irccloud.desktop
    install -m 444 -D ${appimageContents}/usr/share/icons/hicolor/512x512/apps/irccloud.png \
      $out/share/icons/hicolor/512x512/apps/irccloud.png
  &#x27;&#x27;;
}
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-dockerTools" class="title" style="clear: both">pkgs.dockerTools   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-pkgs-dockerTools-buildImage">buildImage</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-pkgs-dockerTools-buildLayeredImage">buildLayeredImage</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-pkgs-dockerTools-streamLayeredImage">streamLayeredImage</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-pkgs-dockerTools-pullImage">pullImage</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-pkgs-dockerTools-exportImage">exportImage</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-pkgs-dockerTools-helpers">Environment Helpers</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-pkgs-dockerTools-buildNixShellImage">buildNixShellImage</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-pkgs-dockerTools-streamNixShellImage">streamNixShellImage</a> </span></dt> </dl></div><p><code class="literal">pkgs.dockerTools</code> is a set of functions for creating and manipulating Docker images according to the <a class="link" href="https://github.com/moby/moby/blob/46f7ab808b9504d735d600e259ca0723f76fb164/image/spec/spec.md#image-json-field-descriptions"  target="_top">Docker Image Specification v1.3.0</a>.
Docker itself is not used to perform any of the operations done by these functions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-dockerTools-buildImage" class="title" >buildImage   </h3>  </div> </div></div><p>This function builds a Docker-compatible repository tarball containing a single image.
As such, the result is suitable for being loaded in Docker with <code class="literal">docker image load</code> (see <a class="xref" href="index.html#ex-dockerTools-buildImage" title="Example 324. Building a Docker image" >Example 324</a> for how to do this).</p><p>This function will create a single layer for all files (and dependencies) that are specified in its argument.
Only new dependencies that are not already in the existing layers will be copied.
If you prefer to create multiple layers for the files and dependencies you want to add to the image, see <a class="xref" href="index.html#ssec-pkgs-dockerTools-buildLayeredImage" title="buildLayeredImage" >the section called “buildLayeredImage”</a> or <a class="xref" href="index.html#ssec-pkgs-dockerTools-streamLayeredImage" title="streamLayeredImage" >the section called “streamLayeredImage”</a> instead.</p><p>This function allows a script to be run during the layer generation process, allowing custom behaviour to affect the final results of the image (see the documentation of the <code class="literal">runAsRoot</code> and <code class="literal">extraCommands</code> attributes).</p><p>The resulting repository tarball will list a single image as specified by the <code class="literal">name</code> and <code class="literal">tag</code> attributes.
By default, that image will use a static creation date (see documentation for the <code class="literal">created</code> attribute).
This allows <code class="literal">buildImage</code> to produce reproducible images.</p><div class="tip"><h3 class="title">Tip</h3><p>When running an image built with <code class="literal">buildImage</code>, you might encounter certain errors depending on what you included in the image, especially if you did not start with any base image.</p><p>If you encounter errors similar to <code class="literal">getProtocolByName: does not exist (no such protocol name: tcp)</code>, you may need to add the contents of <code class="literal">pkgs.iana-etc</code> in the <code class="literal">copyToRoot</code> attribute.
Similarly, if you encounter errors similar to <code class="literal">Error_Protocol (&quot;certificate has unknown CA&quot;,True,UnknownCa)</code>, you may need to add the contents of <code class="literal">pkgs.cacert</code> in the <code class="literal">copyToRoot</code> attribute.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-buildImage-inputs" class="title" >Inputs   </h4>  </div> </div></div><p><code class="literal">buildImage</code> expects an argument with the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String)</span></dt><dd><p>The name of the generated image.</p></dd><dt><span class="term"><code class="literal">tag</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Tag of the generated image.
If <code class="literal">null</code>, the hash of the nix derivation will be used as the tag.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">fromImage</code> (Path or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The repository tarball of an image to be used as the base for the generated image.
It must be a valid Docker image, such as one exported by <code class="literal">docker image save</code>, or another image built with the <code class="literal">dockerTools</code> utility functions.
This can be seen as an equivalent of <code class="literal">FROM fromImage</code> in a <code class="literal">Dockerfile</code>.
A value of <code class="literal">null</code> can be seen as an equivalent of <code class="literal">FROM scratch</code>.</p><p>If specified, the layer created by <code class="literal">buildImage</code> will be appended to the layers defined in the base image, resulting in an image with at least two layers (one or more layers from the base image, and the layer created by <code class="literal">buildImage</code>).
Otherwise, the resulting image with contain the single layer created by <code class="literal">buildImage</code>.</p><div class="note"><h3 class="title">Note</h3><p>Only <span class="strong"><strong>Env</strong></span> configuration is inherited from the base image.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">fromImageName</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Used to specify the image within the repository tarball in case it contains multiple images.
A value of <code class="literal">null</code> means that <code class="literal">buildImage</code> will use the first image available in the repository.</p><div class="note"><h3 class="title">Note</h3><p>This must be used with <code class="literal">fromImageTag</code>. Using only <code class="literal">fromImageName</code> without <code class="literal">fromImageTag</code> will make <code class="literal">buildImage</code> use the first image available in the repository.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">fromImageTag</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Used to specify the image within the repository tarball in case it contains multiple images.
A value of <code class="literal">null</code> means that <code class="literal">buildImage</code> will use the first image available in the repository.</p><div class="note"><h3 class="title">Note</h3><p>This must be used with <code class="literal">fromImageName</code>. Using only <code class="literal">fromImageTag</code> without <code class="literal">fromImageName</code> will make <code class="literal">buildImage</code> use the first image available in the repository</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">copyToRoot</code> (Path, List of Paths, or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Files to add to the generated image.
Anything that coerces to a path (e.g. a derivation) can also be used.
This can be seen as an equivalent of <code class="literal">ADD contents/ /</code> in a <code class="literal">Dockerfile</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">keepContentsDirlinks</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>When adding files to the generated image (as specified by <code class="literal">copyToRoot</code>), this attribute controls whether to preserve symlinks to directories.
If <code class="literal">false</code>, the symlinks will be transformed into directories.
This behaves the same as <code class="literal">rsync -k</code> when <code class="literal">keepContentsDirlinks</code> is <code class="literal">false</code>, and the same as <code class="literal">rsync -K</code> when <code class="literal">keepContentsDirlinks</code> is <code class="literal">true</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">runAsRoot</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A bash script that will run as root inside a VM that contains the existing layers of the base image and the new generated layer (including the files from <code class="literal">copyToRoot</code>).
The script will be run with a working directory of <code class="literal">/</code>.
This can be seen as an equivalent of <code class="literal">RUN ...</code> in a <code class="literal">Dockerfile</code>.
A value of <code class="literal">null</code> means that this step in the image generation process will be skipped.</p><p>See <a class="xref" href="index.html#ex-dockerTools-buildImage-runAsRoot" title="Example 325. Building a Docker image with runAsRoot" >Example 325</a> for how to work with this attribute.</p><div class="caution"><h3 class="title">Caution</h3><p>Using this attribute requires the <code class="literal">kvm</code> device to be available, see <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/conf-file.html#conf-system-features"  target="_top"><code class="literal">system-features</code></a>.
If the <code class="literal">kvm</code> device isn’t available, you should consider using <a class="link" href="index.html#ssec-pkgs-dockerTools-buildLayeredImage" title="buildLayeredImage" ><code class="literal">buildLayeredImage</code></a> or <a class="link" href="index.html#ssec-pkgs-dockerTools-streamLayeredImage" title="streamLayeredImage" ><code class="literal">streamLayeredImage</code></a> instead.
Those functions allow scripts to be run as root without access to the <code class="literal">kvm</code> device.</p></div><div class="note"><h3 class="title">Note</h3><p>At the time the script in <code class="literal">runAsRoot</code> is run, the files specified directly in <code class="literal">copyToRoot</code> will be present in the VM, but their dependencies might not be there yet.
Copying their dependencies into the generated image is a step that happens after <code class="literal">runAsRoot</code> finishes running.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">extraCommands</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A bash script that will run before the layer created by <code class="literal">buildImage</code> is finalised.
The script will be run on some (opaque) working directory which will become <code class="literal">/</code> once the layer is created.
This is similar to <code class="literal">runAsRoot</code>, but the script specified in <code class="literal">extraCommands</code> is <span class="strong"><strong>not</strong></span> run as root, and does not involve creating a VM.
It is simply run as part of building the derivation that outputs the layer created by <code class="literal">buildImage</code>.</p><p>See <a class="xref" href="index.html#ex-dockerTools-buildImage-extraCommands" title="Example 326. Building a Docker image with extraCommands" >Example 326</a> for how to work with this attribute, and subtle differences compared to <code class="literal">runAsRoot</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">config</code> (Attribute Set or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Used to specify the configuration of the containers that will be started off the generated image.
Must be an attribute set, with each attribute as listed in the <a class="link" href="https://github.com/moby/moby/blob/46f7ab808b9504d735d600e259ca0723f76fb164/image/spec/spec.md#image-json-field-descriptions"  target="_top">Docker Image Specification v1.3.0</a>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">architecture</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Used to specify the image architecture.
This is useful for multi-architecture builds that don’t need cross compiling.
If specified, its value should follow the <a class="link" href="https://github.com/opencontainers/image-spec/blob/main/config.md#properties"  target="_top">OCI Image Configuration Specification</a>, which should still be compatible with Docker.
According to the linked specification, all possible values for <code class="literal">$GOARCH</code> in <a class="link" href="https://go.dev/doc/install/source#environment"  target="_top">the Go docs</a> should be valid, but will commonly be one of <code class="literal">386</code>, <code class="literal">amd64</code>, <code class="literal">arm</code>, or <code class="literal">arm64</code>.</p><p><span class="emphasis"><em>Default value:</em></span> the same value from <code class="literal">pkgs.go.GOARCH</code>.</p></dd><dt><span class="term"><code class="literal">diskSize</code> (Number; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Controls the disk size in MiB (1024x1024 bytes) of the VM used to run the script specified in <code class="literal">runAsRoot</code>.
This attribute is ignored if <code class="literal">runAsRoot</code> is <code class="literal">null</code>.</p><p><span class="emphasis"><em>Default value:</em></span> 1024.</p></dd><dt><span class="term"><code class="literal">buildVMMemorySize</code> (Number; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Controls the amount of memory in MiB (1024x1024 bytes) provisioned for the VM used to run the script specified in <code class="literal">runAsRoot</code>.
This attribute is ignored if <code class="literal">runAsRoot</code> is <code class="literal">null</code>.</p><p><span class="emphasis"><em>Default value:</em></span> 512.</p></dd><dt><span class="term"><code class="literal">created</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Specifies the time of creation of the generated image.
This should be either a date and time formatted according to <a class="link" href="https://en.wikipedia.org/wiki/ISO_8601"  target="_top">ISO-8601</a> or <code class="literal">&quot;now&quot;</code>, in which case <code class="literal">buildImage</code> will use the current date.</p><p>See <a class="xref" href="index.html#ex-dockerTools-buildImage-creatednow" title="Example 327. Building a Docker image with a creation date set to the current time" >Example 327</a> for how to use <code class="literal">&quot;now&quot;</code>.</p><div class="caution"><h3 class="title">Caution</h3><p>Using <code class="literal">&quot;now&quot;</code> means that the generated image will not be reproducible anymore (because the date will always change whenever it’s built).</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;1970-01-01T00:00:01Z&quot;</code>.</p></dd><dt><span class="term"><code class="literal">uid</code> (Number; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The uid of the user that will own the files packed in the new layer built by <code class="literal">buildImage</code>.</p><p><span class="emphasis"><em>Default value:</em></span> 0.</p></dd><dt><span class="term"><code class="literal">gid</code> (Number; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The gid of the group that will own the files packed in the new layer built by <code class="literal">buildImage</code>.</p><p><span class="emphasis"><em>Default value:</em></span> 0.</p></dd><dt><span class="term"><code class="literal">compressor</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Selects the algorithm used to compress the image.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;gz&quot;</code>.<br /><span class="emphasis"><em>Possible values:</em></span> <code class="literal">&quot;none&quot;</code>, <code class="literal">&quot;gz&quot;</code>, <code class="literal">&quot;zstd&quot;</code>.</p></dd><dt><span class="term"><code class="literal">includeNixDB</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Populate the nix database in the image with the dependencies of <code class="literal">copyToRoot</code>.
The main purpose is to be able to use nix commands in the container.</p><div class="caution"><h3 class="title">Caution</h3><p>Be careful since this doesn’t work well in combination with <code class="literal">fromImage</code>. In particular, in a multi-layered image, only the Nix paths from the lower image will be in the database.</p><p>This also neglects to register the store paths that are pulled into the image as a dependency of one of the other values, but aren’t a dependency of <code class="literal">copyToRoot</code>.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">contents</code> <span class="strong"><strong>DEPRECATED</strong></span></span></dt><dd><p>This attribute is deprecated, and users are encouraged to use <code class="literal">copyToRoot</code> instead.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-buildImage-passthru-outputs" class="title" >Passthru outputs   </h4>  </div> </div></div><p><code class="literal">buildImage</code> defines a few <a class="link" href="index.html#chap-passthru" title="Passthru-attributes" ><code class="literal">passthru</code></a> attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">buildArgs</code> (Attribute Set)</span></dt><dd><p>The argument passed to <code class="literal">buildImage</code> itself.
This allows you to inspect all attributes specified in the argument, as described above.</p></dd><dt><span class="term"><code class="literal">layer</code> (Attribute Set)</span></dt><dd><p>The derivation with the layer created by <code class="literal">buildImage</code>.
This allows easier inspection of the contents added by <code class="literal">buildImage</code> in the generated image.</p></dd><dt><span class="term"><code class="literal">imageTag</code> (String)</span></dt><dd><p>The tag of the generated image.
This is useful if no tag was specified in the attributes of the argument to <code class="literal">buildImage</code>, because an automatic tag will be used instead.
<code class="literal">imageTag</code> allows you to retrieve the value of the tag used in this case.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-buildImage-examples" class="title" >Examples   </h4>  </div> </div></div><div class="example"><span id="ex-dockerTools-buildImage" ></span><details><summary><span class="title"><strong>Example 324. Building a Docker image</strong></span></summary><div class="example-contents"><p>The following package builds a Docker image that runs the <code class="literal">redis-server</code> executable from the <code class="literal">redis</code> package.
The Docker image will have name <code class="literal">redis</code> and tag <code class="literal">latest</code>.</p><pre><code class="programlisting nix">{
  dockerTools,
  buildEnv,
  redis,
}:
dockerTools.buildImage {
  name = &quot;redis&quot;;
  tag = &quot;latest&quot;;

  copyToRoot = buildEnv {
    name = &quot;image-root&quot;;
    paths = [ redis ];
    pathsToLink = [ &quot;/bin&quot; ];
  };

  runAsRoot = &#x27;&#x27;
    mkdir -p /data
  &#x27;&#x27;;

  config = {
    Cmd = [ &quot;/bin/redis-server&quot; ];
    WorkingDir = &quot;/data&quot;;
    Volumes = {
      &quot;/data&quot; = { };
    };
  };
}
</code></pre><p>The result of building this package is a <code class="literal">.tar.gz</code> file that can be loaded into Docker:</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
building &#x27;/nix/store/yw0adm4wpsw1w6j4fb5hy25b3arr9s1v-docker-image-redis.tar.gz.drv&#x27;...
Adding layer...
tar: Removing leading `/&#x27; from member names
Adding meta...
Cooking the image...
Finished.
/nix/store/p4dsg62inh9d2ksy3c7bv58xa851dasr-docker-image-redis.tar.gz

$ docker image load -i /nix/store/p4dsg62inh9d2ksy3c7bv58xa851dasr-docker-image-redis.tar.gz
(some output removed for clarity)
Loaded image: redis:latest
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-buildImage-runAsRoot" ></span><details><summary><span class="title"><strong>Example 325. Building a Docker image with <code class="literal">runAsRoot</code></strong></span></summary><div class="example-contents"><p>The following package builds a Docker image with the <code class="literal">hello</code> executable from the <code class="literal">hello</code> package.
It uses <code class="literal">runAsRoot</code> to create a directory and a file inside the image.</p><p>This works the same as <a class="xref" href="index.html#ex-dockerTools-buildImage-extraCommands" title="Example 326. Building a Docker image with extraCommands" >Example 326</a>, but uses <code class="literal">runAsRoot</code> instead of <code class="literal">extraCommands</code>.</p><pre><code class="programlisting nix">{
  dockerTools,
  buildEnv,
  hello,
}:
dockerTools.buildImage {
  name = &quot;hello&quot;;
  tag = &quot;latest&quot;;

  copyToRoot = buildEnv {
    name = &quot;image-root&quot;;
    paths = [ hello ];
    pathsToLink = [ &quot;/bin&quot; ];
  };

  runAsRoot = &#x27;&#x27;
    mkdir -p /data
    echo &quot;some content&quot; &gt; my-file
  &#x27;&#x27;;

  config = {
    Cmd = [ &quot;/bin/hello&quot; ];
    WorkingDir = &quot;/data&quot;;
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-buildImage-extraCommands" ></span><details><summary><span class="title"><strong>Example 326. Building a Docker image with <code class="literal">extraCommands</code></strong></span></summary><div class="example-contents"><p>The following package builds a Docker image with the <code class="literal">hello</code> executable from the <code class="literal">hello</code> package.
It uses <code class="literal">extraCommands</code> to create a directory and a file inside the image.</p><p>This works the same as <a class="xref" href="index.html#ex-dockerTools-buildImage-runAsRoot" title="Example 325. Building a Docker image with runAsRoot" >Example 325</a>, but uses <code class="literal">extraCommands</code> instead of <code class="literal">runAsRoot</code>.
Note that with <code class="literal">extraCommands</code>, we can’t directly reference <code class="literal">/</code> and must create files and directories as if we were already on <code class="literal">/</code>.</p><pre><code class="programlisting nix">{
  dockerTools,
  buildEnv,
  hello,
}:
dockerTools.buildImage {
  name = &quot;hello&quot;;
  tag = &quot;latest&quot;;

  copyToRoot = buildEnv {
    name = &quot;image-root&quot;;
    paths = [ hello ];
    pathsToLink = [ &quot;/bin&quot; ];
  };

  extraCommands = &#x27;&#x27;
    mkdir -p data
    echo &quot;some content&quot; &gt; my-file
  &#x27;&#x27;;

  config = {
    Cmd = [ &quot;/bin/hello&quot; ];
    WorkingDir = &quot;/data&quot;;
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-buildImage-creatednow" ></span><details><summary><span class="title"><strong>Example 327. Building a Docker image with a creation date set to the current time</strong></span></summary><div class="example-contents"><p>Note that using a value of <code class="literal">&quot;now&quot;</code> in the <code class="literal">created</code> attribute will break reproducibility.</p><pre><code class="programlisting nix">{
  dockerTools,
  buildEnv,
  hello,
}:
dockerTools.buildImage {
  name = &quot;hello&quot;;
  tag = &quot;latest&quot;;

  created = &quot;now&quot;;

  copyToRoot = buildEnv {
    name = &quot;image-root&quot;;
    paths = [ hello ];
    pathsToLink = [ &quot;/bin&quot; ];
  };

  config.Cmd = [ &quot;/bin/hello&quot; ];
}
</code></pre><p>After importing the generated repository tarball with Docker, its CLI will display a reasonable date and sort the images as expected:</p><pre><code class="programlisting shell">$ docker image ls
REPOSITORY   TAG      IMAGE ID       CREATED              SIZE
hello        latest   de2bf4786de6   About a minute ago   25.2MB
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-dockerTools-buildLayeredImage" class="title" >buildLayeredImage   </h3>  </div> </div></div><p><code class="literal">buildLayeredImage</code> uses <a class="link" href="index.html#ssec-pkgs-dockerTools-streamLayeredImage" title="streamLayeredImage" ><code class="literal">streamLayeredImage</code></a> underneath to build a compressed Docker-compatible repository tarball.
Basically, <code class="literal">buildLayeredImage</code> runs the script created by <code class="literal">streamLayeredImage</code> to save the compressed image in the Nix store.
<code class="literal">buildLayeredImage</code> supports the same options as <code class="literal">streamLayeredImage</code>, see <a class="link" href="index.html#ssec-pkgs-dockerTools-streamLayeredImage" title="streamLayeredImage" ><code class="literal">streamLayeredImage</code></a> for details.</p><div class="note"><h3 class="title">Note</h3><p>Despite the similar name, <a class="link" href="index.html#ssec-pkgs-dockerTools-buildImage" title="buildImage" ><code class="literal">buildImage</code></a> works completely differently from <code class="literal">buildLayeredImage</code> and <code class="literal">streamLayeredImage</code>.</p><p>Even though some of the arguments may seem related, they cannot be interchanged.</p></div><p>You can load the result of this function in Docker with <code class="literal">docker image load</code>.
See <a class="xref" href="index.html#ex-dockerTools-buildLayeredImage-hello" title="Example 328. Building a layered Docker image" >Example 328</a> to see how to do that.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-buildLayeredImage-examples" class="title" >Examples   </h4>  </div> </div></div><div class="example"><span id="ex-dockerTools-buildLayeredImage-hello" ></span><details><summary><span class="title"><strong>Example 328. Building a layered Docker image</strong></span></summary><div class="example-contents"><p>The following package builds a layered Docker image that runs the <code class="literal">hello</code> executable from the <code class="literal">hello</code> package.
The Docker image will have name <code class="literal">hello</code> and tag <code class="literal">latest</code>.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.buildLayeredImage {
  name = &quot;hello&quot;;
  tag = &quot;latest&quot;;

  contents = [ hello ];

  config.Cmd = [ &quot;/bin/hello&quot; ];
}
</code></pre><p>The result of building this package is a <code class="literal">.tar.gz</code> file that can be loaded into Docker:</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
building &#x27;/nix/store/bk8bnrbw10nq7p8pvcmdr0qf57y6scha-hello.tar.gz.drv&#x27;...
No &#x27;fromImage&#x27; provided
Creating layer 1 from paths: [&#x27;/nix/store/i93s7xxblavsacpy82zdbn4kplsyq48l-libunistring-1.1&#x27;]
Creating layer 2 from paths: [&#x27;/nix/store/ji01n9vinnj22nbrb86nx8a1ssgpilx8-libidn2-2.3.4&#x27;]
Creating layer 3 from paths: [&#x27;/nix/store/ldrslljw4rg026nw06gyrdwl78k77vyq-xgcc-12.3.0-libgcc&#x27;]
Creating layer 4 from paths: [&#x27;/nix/store/9y8pmvk8gdwwznmkzxa6pwyah52xy3nk-glibc-2.38-27&#x27;]
Creating layer 5 from paths: [&#x27;/nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1&#x27;]
Creating layer 6 with customisation...
Adding manifests...
Done.
/nix/store/hxcz7snvw7f8rzhbh6mv8jq39d992905-hello.tar.gz

$ docker image load -i /nix/store/hxcz7snvw7f8rzhbh6mv8jq39d992905-hello.tar.gz
(some output removed for clarity)
Loaded image: hello:latest
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-dockerTools-streamLayeredImage" class="title" >streamLayeredImage   </h3>  </div> </div></div><p><code class="literal">streamLayeredImage</code> builds a <span class="strong"><strong>script</strong></span> which, when run, will stream to stdout a Docker-compatible repository tarball containing a single image, using multiple layers to improve sharing between images.
This means that <code class="literal">streamLayeredImage</code> does not output an image into the Nix store, but only a script that builds the image, saving on IO and disk/cache space, particularly with large images.</p><p>You can load the result of this function in Docker with <code class="literal">docker image load</code>.
See <a class="xref" href="index.html#ex-dockerTools-streamLayeredImage-hello" title="Example 329. Streaming a layered Docker image" >Example 329</a> to see how to do that.</p><p>For this function, you specify a <a class="link" href="https://nixos.org/manual/nix/stable/store/store-path"  target="_top">store path</a> or a list of store paths to be added to the image, and the functions will automatically include any dependencies of those paths in the image.
The function will attempt to create one layer per object in the Nix store that needs to be added to the image.
In case there are more objects to include than available layers, the function will put the most <a class="link" href="https://github.com/NixOS/nixpkgs/tree/release-23.11/pkgs/build-support/references-by-popularity"  target="_top">“popular”</a> objects in their own layers, and group all remaining objects into a single layer.</p><p>An additional layer will be created with symlinks to the store paths you specified to be included in the image.
These symlinks are built with <a class="link" href="index.html#trivial-builder-symlinkJoin" title="symlinkJoin" ><code class="literal">symlinkJoin</code></a>, so they will be included in the root of the image.
See <a class="xref" href="index.html#ex-dockerTools-streamLayeredImage-exploringlayers" title="Example 330. Exploring the layers in an image built with streamLayeredImage" >Example 330</a> to understand how these symlinks are laid out in the generated image.</p><p><code class="literal">streamLayeredImage</code> allows scripts to be run when creating the additional layer with symlinks, allowing custom behaviour to affect the final results of the image (see the documentation of the <code class="literal">extraCommands</code> and <code class="literal">fakeRootCommands</code> attributes).</p><p>The resulting repository tarball will list a single image as specified by the <code class="literal">name</code> and <code class="literal">tag</code> attributes.
By default, that image will use a static creation date (see documentation for the <code class="literal">created</code> and <code class="literal">mtime</code> attributes).
This allows the function to produce reproducible images.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-streamLayeredImage-inputs" class="title" >Inputs   </h4>  </div> </div></div><p><code class="literal">streamLayeredImage</code> expects one argument with the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code> (String)</span></dt><dd><p>The name of the generated image.</p></dd><dt><span class="term"><code class="literal">tag</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Tag of the generated image.
If <code class="literal">null</code>, the hash of the nix derivation will be used as the tag.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">fromImage</code>(Path or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The repository tarball of an image to be used as the base for the generated image.
It must be a valid Docker image, such as one exported by <code class="literal">docker image save</code>, or another image built with the <code class="literal">dockerTools</code> utility functions.
This can be seen as an equivalent of <code class="literal">FROM fromImage</code> in a <code class="literal">Dockerfile</code>.
A value of <code class="literal">null</code> can be seen as an equivalent of <code class="literal">FROM scratch</code>.</p><p>If specified, the created layers will be appended to the layers defined in the base image.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">contents</code> (Path or List of Paths; <span class="emphasis"><em>optional</em></span>) <span id="dockerTools-buildLayeredImage-arg-contents"></span></span></dt><dd><p>Directories whose contents will be added to the generated image.
Things that coerce to paths (e.g. a derivation) can also be used.
This can be seen as an equivalent of <code class="literal">ADD contents/ /</code> in a <code class="literal">Dockerfile</code>.</p><p>All the contents specified by <code class="literal">contents</code> will be added as a final layer in the generated image.
They will be added as links to the actual files (e.g. links to the store paths).
The actual files will be added in previous layers.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">[]</code></p></dd><dt><span class="term"><code class="literal">config</code> (Attribute Set or Null; <span class="emphasis"><em>optional</em></span>) <span id="dockerTools-buildLayeredImage-arg-config"></span></span></dt><dd><p>Used to specify the configuration of the containers that will be started off the generated image.
Must be an attribute set, with each attribute as listed in the <a class="link" href="https://github.com/moby/moby/blob/46f7ab808b9504d735d600e259ca0723f76fb164/image/spec/spec.md#image-json-field-descriptions"  target="_top">Docker Image Specification v1.3.0</a>.</p><p>If any packages are used directly in <code class="literal">config</code>, they will be automatically included in the generated image.
See <a class="xref" href="index.html#ex-dockerTools-streamLayeredImage-configclosure" title="Example 331. Building a layered Docker image with packages directly in config" >Example 331</a> for an example.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">architecture</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Used to specify the image architecture.
This is useful for multi-architecture builds that don’t need cross compiling.
If specified, its value should follow the <a class="link" href="https://github.com/opencontainers/image-spec/blob/main/config.md#properties"  target="_top">OCI Image Configuration Specification</a>, which should still be compatible with Docker.
According to the linked specification, all possible values for <code class="literal">$GOARCH</code> in <a class="link" href="https://go.dev/doc/install/source#environment"  target="_top">the Go docs</a> should be valid, but will commonly be one of <code class="literal">386</code>, <code class="literal">amd64</code>, <code class="literal">arm</code>, or <code class="literal">arm64</code>.</p><p><span class="emphasis"><em>Default value:</em></span> the same value from <code class="literal">pkgs.go.GOARCH</code>.</p></dd><dt><span class="term"><code class="literal">created</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Specifies the time of creation of the generated image.
This date will be used for the image metadata.
This should be either a date and time formatted according to <a class="link" href="https://en.wikipedia.org/wiki/ISO_8601"  target="_top">ISO-8601</a> or <code class="literal">&quot;now&quot;</code>, in which case the current date will be used.</p><div class="caution"><h3 class="title">Caution</h3><p>Using <code class="literal">&quot;now&quot;</code> means that the generated image will not be reproducible anymore (because the date will always change whenever it’s built).</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;1970-01-01T00:00:01Z&quot;</code>.</p></dd><dt><span class="term"><code class="literal">mtime</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Specifies the time used for the modification timestamp of files within the layers of the generated image.
This should be either a date and time formatted according to <a class="link" href="https://en.wikipedia.org/wiki/ISO_8601"  target="_top">ISO-8601</a> or <code class="literal">&quot;now&quot;</code>, in which case the current date will be used.</p><div class="caution"><h3 class="title">Caution</h3><p>Using a non-constant date will cause built layers to have a different hash each time, preventing deduplication.
Using <code class="literal">&quot;now&quot;</code> also means that the generated image will not be reproducible anymore (because the date will always change whenever it’s built).</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;1970-01-01T00:00:01Z&quot;</code>.</p></dd></dl></div><p><code class="literal">uid</code> (Number; <span class="emphasis"><em>optional</em></span>) <span id="dockerTools-buildLayeredImage-arg-uid"></span>
<code class="literal">gid</code> (Number; <span class="emphasis"><em>optional</em></span>) <span id="dockerTools-buildLayeredImage-arg-gid"></span>
<code class="literal">uname</code> (String; <span class="emphasis"><em>optional</em></span>) <span id="dockerTools-buildLayeredImage-arg-uname"></span>
<code class="literal">gname</code> (String; <span class="emphasis"><em>optional</em></span>) <span id="dockerTools-buildLayeredImage-arg-gname"></span></p><p>: Credentials for Nix store ownership.
Can be overridden to e.g. <code class="literal">1000</code> / <code class="literal">1000</code> / <code class="literal">&quot;user&quot;</code> / <code class="literal">&quot;user&quot;</code> to enable building a container where Nix can be used as an unprivileged user in single-user mode.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">0</code> / <code class="literal">0</code> / <code class="literal">&quot;root&quot;</code> / <code class="literal">&quot;root&quot;</code></p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">maxLayers</code> (Number; <span class="emphasis"><em>optional</em></span>) <span id="dockerTools-buildLayeredImage-arg-maxLayers"></span></span></dt><dd><p>The maximum number of layers that will be used by the generated image.
If a <code class="literal">fromImage</code> was specified, the number of layers used by <code class="literal">fromImage</code> will be subtracted from <code class="literal">maxLayers</code> to ensure that the image generated will have at most <code class="literal">maxLayers</code>.</p><div class="caution"><h3 class="title">Caution</h3><p>Depending on the tool/runtime where the image will be used, there might be a limit to the number of layers that an image can have.
For Docker, see <a class="link" href="https://github.com/docker/docs/issues/8230"  target="_top">this issue on GitHub</a>.</p></div><p><span class="emphasis"><em>Default value:</em></span> 100.</p></dd><dt><span class="term"><code class="literal">extraCommands</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A bash script that will run in the context of the layer created with the contents specified by <code class="literal">contents</code>.
At the moment this script runs, only the contents directly specified by <code class="literal">contents</code> will be available as links.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">fakeRootCommands</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A bash script that will run in the context of the layer created with the contents specified by <code class="literal">contents</code>.
During the process to generate that layer, the script in <code class="literal">extraCommands</code> will be run first, if specified.
After that, a <span class="citerefentry"><span class="refentrytitle">fakeroot</span>(1)</span> environment will be entered.
The script specified in <code class="literal">fakeRootCommands</code> runs inside the fakeroot environment, and the layer is then generated from the view of the files inside the fakeroot environment.</p><p>This is useful to change the owners of the files in the layer (by running <code class="literal">chown</code>, for example), or performing any other privileged operations related to file manipulation (by default, all files in the layer will be owned by root, and the build environment doesn’t have enough privileges to directly perform privileged operations on these files).</p><p>For more details, see the manpage for <span class="citerefentry"><span class="refentrytitle">fakeroot</span>(1)</span>.</p><div class="caution"><h3 class="title">Caution</h3><p>Due to how fakeroot works, static binaries cannot perform privileged file operations in <code class="literal">fakeRootCommands</code>, unless <code class="literal">enableFakechroot</code> is set to <code class="literal">true</code>.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;&quot;</code>.</p></dd><dt><span class="term"><code class="literal">enableFakechroot</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>By default, the script specified in <code class="literal">fakeRootCommands</code> only runs inside a fakeroot environment.
If <code class="literal">enableFakechroot</code> is <code class="literal">true</code>, a more complete chroot environment will be created using <a class="link" href="https://proot-me.github.io/"  target="_top"><code class="literal">proot</code></a> before running the script in <code class="literal">fakeRootCommands</code>.
Files in the Nix store will be available.
This allows scripts that perform installation in <code class="literal">/</code> to work as expected.
This can be seen as an equivalent of <code class="literal">RUN ...</code> in a <code class="literal">Dockerfile</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">false</code></p></dd><dt><span class="term"><code class="literal">includeStorePaths</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The files specified in <code class="literal">contents</code> are put into layers in the generated image.
If <code class="literal">includeStorePaths</code> is <code class="literal">false</code>, the actual files will not be included in the generated image, and only links to them will be added instead.
It is <span class="strong"><strong>not recommended</strong></span> to set this to <code class="literal">false</code> unless you have other tooling to insert the store paths via other means (such as bind mounting the host store) when running containers with the generated image.
If you don’t provide any extra tooling, the generated image won’t run properly.</p><p>See <a class="xref" href="index.html#ex-dockerTools-streamLayeredImage-exploringlayers" title="Example 330. Exploring the layers in an image built with streamLayeredImage" >Example 330</a> to understand the impact of setting <code class="literal">includeStorePaths</code> to <code class="literal">false</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">true</code></p></dd><dt><span class="term"><code class="literal">includeNixDB</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Populate the nix database in the image with the dependencies of <code class="literal">copyToRoot</code>.
The main purpose is to be able to use nix commands in the container.</p><div class="caution"><h3 class="title">Caution</h3><p>Be careful since this doesn’t work well in combination with <code class="literal">fromImage</code>. In particular, in a multi-layered image, only the Nix paths from the lower image will be in the database.</p><p>This also neglects to register the store paths that are pulled into the image as a dependency of one of the other values, but aren’t a dependency of <code class="literal">copyToRoot</code>.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">passthru</code> (Attribute Set; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Use this to pass any attributes as <a class="link" href="index.html#chap-passthru" title="Passthru-attributes" ><code class="literal">passthru</code></a> for the resulting derivation.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">{}</code></p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-streamLayeredImage-passthru-outputs" class="title" >Passthru outputs   </h4>  </div> </div></div><p><code class="literal">streamLayeredImage</code> also defines its own <a class="link" href="index.html#chap-passthru" title="Passthru-attributes" ><code class="literal">passthru</code></a> attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">imageTag</code> (String)</span></dt><dd><p>The tag of the generated image.
This is useful if no tag was specified in the attributes of the argument to the function, because an automatic tag will be used instead.
<code class="literal">imageTag</code> allows you to retrieve the value of the tag used in this case.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-streamLayeredImage-examples" class="title" >Examples   </h4>  </div> </div></div><div class="example"><span id="ex-dockerTools-streamLayeredImage-hello" ></span><details><summary><span class="title"><strong>Example 329. Streaming a layered Docker image</strong></span></summary><div class="example-contents"><p>The following package builds a <span class="strong"><strong>script</strong></span> which, when run, will stream a layered Docker image that runs the <code class="literal">hello</code> executable from the <code class="literal">hello</code> package.
The Docker image will have name <code class="literal">hello</code> and tag <code class="literal">latest</code>.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.streamLayeredImage {
  name = &quot;hello&quot;;
  tag = &quot;latest&quot;;

  contents = [ hello ];

  config.Cmd = [ &quot;/bin/hello&quot; ];
}
</code></pre><p>The result of building this package is a script.
Running this script and piping it into <code class="literal">docker image load</code> gives you the same image that was built in <a class="xref" href="index.html#ex-dockerTools-buildLayeredImage-hello" title="Example 328. Building a layered Docker image" >Example 328</a>.
Note that in this case, the image is never added to the Nix store, but instead streamed directly into Docker.</p><pre><code class="programlisting shell">$ nix-build
(output removed for clarity)
/nix/store/wsz2xl8ckxnlb769irvq6jv1280dfvxd-stream-hello

$ /nix/store/wsz2xl8ckxnlb769irvq6jv1280dfvxd-stream-hello | docker image load
No &#x27;fromImage&#x27; provided
Creating layer 1 from paths: [&#x27;/nix/store/i93s7xxblavsacpy82zdbn4kplsyq48l-libunistring-1.1&#x27;]
Creating layer 2 from paths: [&#x27;/nix/store/ji01n9vinnj22nbrb86nx8a1ssgpilx8-libidn2-2.3.4&#x27;]
Creating layer 3 from paths: [&#x27;/nix/store/ldrslljw4rg026nw06gyrdwl78k77vyq-xgcc-12.3.0-libgcc&#x27;]
Creating layer 4 from paths: [&#x27;/nix/store/9y8pmvk8gdwwznmkzxa6pwyah52xy3nk-glibc-2.38-27&#x27;]
Creating layer 5 from paths: [&#x27;/nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1&#x27;]
Creating layer 6 with customisation...
Adding manifests...
Done.
(some output removed for clarity)
Loaded image: hello:latest
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-streamLayeredImage-exploringlayers" ></span><details><summary><span class="title"><strong>Example 330. Exploring the layers in an image built with <code class="literal">streamLayeredImage</code></strong></span></summary><div class="example-contents"><p>Assume the following package, which builds a layered Docker image with the <code class="literal">hello</code> package.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.streamLayeredImage {
  name = &quot;hello&quot;;
  contents = [ hello ];
}
</code></pre><p>The <code class="literal">hello</code> package depends on 4 other packages:</p><pre><code class="programlisting shell">$ nix-store --query -R $(nix-build -A hello)
/nix/store/i93s7xxblavsacpy82zdbn4kplsyq48l-libunistring-1.1
/nix/store/ji01n9vinnj22nbrb86nx8a1ssgpilx8-libidn2-2.3.4
/nix/store/ldrslljw4rg026nw06gyrdwl78k77vyq-xgcc-12.3.0-libgcc
/nix/store/9y8pmvk8gdwwznmkzxa6pwyah52xy3nk-glibc-2.38-27
/nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1
</code></pre><p>This means that all these packages will be included in the image generated by <code class="literal">streamLayeredImage</code>.
It will put each package in its own layer, for a total of 5 layers with actual files in them.
A final layer will be created only with symlinks for the <code class="literal">hello</code> package.</p><p>The image generated will have the following directory structure (some directories were collapsed for readability):</p><pre><code class="programlisting">├── bin
│   └── hello → /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/bin/hello
├── nix
│   └── store
│       ├─⊕ 9y8pmvk8gdwwznmkzxa6pwyah52xy3nk-glibc-2.38-27
│       ├─⊕ i93s7xxblavsacpy82zdbn4kplsyq48l-libunistring-1.1
│       ├─⊕ ji01n9vinnj22nbrb86nx8a1ssgpilx8-libidn2-2.3.4
│       ├─⊕ ldrslljw4rg026nw06gyrdwl78k77vyq-xgcc-12.3.0-libgcc
│       └─⊕ zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1
└── share
    ├── info
    │   └── hello.info → /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/share/info/hello.info
    ├─⊕ locale
    └── man
        └── man1
            └── hello.1.gz → /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/share/man/man1/hello.1.gz
</code></pre><p>Each of the packages in <code class="literal">/nix/store</code> comes from a layer in the image.
The final layer adds the <code class="literal">/bin</code> and <code class="literal">/share</code> directories, but they only contain links to the actual files in <code class="literal">/nix/store</code>.</p><p>If our package sets <code class="literal">includeStorePaths</code> to <code class="literal">false</code>, we’ll end up with only the final layer with the links, but the actual files won’t exist in the image:</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.streamLayeredImage {
  name = &quot;hello&quot;;
  contents = [ hello ];
  includeStorePaths = false;
}
</code></pre><p>After building this package, the image will have the following directory structure:</p><pre><code class="programlisting">├── bin
│   └── hello → /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/bin/hello
└── share
    ├── info
    │   └── hello.info → /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/share/info/hello.info
    ├─⊕ locale
    └── man
        └── man1
            └── hello.1.gz → /nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1/share/man/man1/hello.1.gz
</code></pre><p>Note how the links point to paths in <code class="literal">/nix/store</code>, but they’re not included in the image itself.
This is why you need extra tooling when using <code class="literal">includeStorePaths</code>:
a container created from such image won’t find any of the files it needs to run otherwise.</p></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-streamLayeredImage-configclosure" ></span><details><summary><span class="title"><strong>Example 331. Building a layered Docker image with packages directly in <code class="literal">config</code></strong></span></summary><div class="example-contents"><p>The closure of <code class="literal">config</code> is automatically included in the generated image.
The following package shows a more compact way to create the same output generated in <a class="xref" href="index.html#ex-dockerTools-streamLayeredImage-hello" title="Example 329. Streaming a layered Docker image" >Example 329</a>.</p><pre><code class="programlisting nix">{
  dockerTools,
  hello,
  lib,
}:
dockerTools.streamLayeredImage {
  name = &quot;hello&quot;;
  tag = &quot;latest&quot;;
  config.Cmd = [ &quot;${lib.getExe hello}&quot; ];
}
</code></pre></div></details></div><br class="example-break" /><p><span id="ssec-pkgs-dockerTools-fetchFromRegistry"></span></p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-dockerTools-pullImage" class="title" >pullImage   </h3>  </div> </div></div><p>This function is similar to the <code class="literal">docker image pull</code> command, which means it can be used to pull a Docker image from a registry that implements the <a class="link" href="https://distribution.github.io/distribution/spec/api/"  target="_top">Docker Registry HTTP API V2</a>.
By default, the <code class="literal">docker.io</code> registry is used.</p><p>The image will be downloaded as an uncompressed Docker-compatible repository tarball, which is suitable for use with other <code class="literal">dockerTools</code> functions such as <a class="link" href="index.html#ssec-pkgs-dockerTools-buildImage" title="buildImage" ><code class="literal">buildImage</code></a>, <a class="link" href="index.html#ssec-pkgs-dockerTools-buildLayeredImage" title="buildLayeredImage" ><code class="literal">buildLayeredImage</code></a>, and <a class="link" href="index.html#ssec-pkgs-dockerTools-streamLayeredImage" title="streamLayeredImage" ><code class="literal">streamLayeredImage</code></a>.</p><p>This function requires two different types of hashes/digests to be specified:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>One of them is used to identify a unique image within the registry (see the documentation for the <code class="literal">imageDigest</code> attribute).</p></li><li class="listitem"><p>The other is used by Nix to ensure the contents of the output haven’t changed (see the documentation for the <code class="literal">sha256</code> attribute).</p></li></ul></div><p>Both hashes are required because they must uniquely identify some content in two completely different systems (the Docker registry and the Nix store), but their values will not be the same.
See <a class="xref" href="index.html#ex-dockerTools-pullImage-nixprefetchdocker" title="Example 334. Finding the digest and hash values to use for dockerTools.pullImage" >Example 334</a> for a tool that can help gather these values.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-pullImage-inputs" class="title" >Inputs   </h4>  </div> </div></div><p><code class="literal">pullImage</code> expects a single argument with the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">imageName</code> (String)</span></dt><dd><p>Specifies the name of the image to be downloaded, as well as the registry endpoint.
By default, the <code class="literal">docker.io</code> registry is used.
To specify a different registry, prepend the endpoint to <code class="literal">imageName</code>, separated by a slash (<code class="literal">/</code>).
See <a class="xref" href="index.html#ex-dockerTools-pullImage-differentregistry" title="Example 333. Pulling the nixos/nix Docker image from a specific registry" >Example 333</a> for how to do that.</p></dd><dt><span class="term"><code class="literal">imageDigest</code> (String)</span></dt><dd><p>Specifies the digest of the image to be downloaded.</p><div class="tip"><h3 class="title">Tip</h3><p><span class="strong"><strong>Why can’t I specify a tag to pull from, and have to use a digest instead?</strong></span></p><p>Tags are often updated to point to different image contents.
The most common example is the <code class="literal">latest</code> tag, which is usually updated whenever a newer image version is available.</p><p>An image tag isn’t enough to guarantee the contents of an image won’t change, but a digest guarantees this.
Providing a digest helps ensure that you will still be able to build the same Nix code and get the same output even if newer versions of an image are released.</p></div></dd><dt><span class="term"><code class="literal">sha256</code> (String)</span></dt><dd><p>The hash of the image after it is downloaded.
Internally, this is passed to the <a class="link" href="https://nixos.org/manual/nix/stable/language/advanced-attributes#adv-attr-outputHash"  target="_top"><code class="literal">outputHash</code></a> attribute of the resulting derivation.
This is needed to provide a guarantee to Nix that the contents of the image haven’t changed, because Nix doesn’t support the value in <code class="literal">imageDigest</code>.</p></dd><dt><span class="term"><code class="literal">finalImageName</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Specifies the name that will be used for the image after it has been downloaded.
This only applies after the image is downloaded, and is not used to identify the image to be downloaded in the registry.
Use <code class="literal">imageName</code> for that instead.</p><p><span class="emphasis"><em>Default value:</em></span> the same value specified in <code class="literal">imageName</code>.</p></dd><dt><span class="term"><code class="literal">finalImageTag</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Specifies the tag that will be used for the image after it has been downloaded.
This only applies after the image is downloaded, and is not used to identify the image to be downloaded in the registry.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;latest&quot;</code>.</p></dd><dt><span class="term"><code class="literal">os</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Specifies the operating system of the image to pull.
If specified, its value should follow the <a class="link" href="https://github.com/opencontainers/image-spec/blob/main/config.md#properties"  target="_top">OCI Image Configuration Specification</a>, which should still be compatible with Docker.
According to the linked specification, all possible values for <code class="literal">$GOOS</code> in <a class="link" href="https://go.dev/doc/install/source#environment"  target="_top">the Go docs</a> should be valid, but will commonly be one of <code class="literal">darwin</code> or <code class="literal">linux</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;linux&quot;</code>.</p></dd><dt><span class="term"><code class="literal">arch</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Specifies the architecture of the image to pull.
If specified, its value should follow the <a class="link" href="https://github.com/opencontainers/image-spec/blob/main/config.md#properties"  target="_top">OCI Image Configuration Specification</a>, which should still be compatible with Docker.
According to the linked specification, all possible values for <code class="literal">$GOARCH</code> in <a class="link" href="https://go.dev/doc/install/source#environment"  target="_top">the Go docs</a> should be valid, but will commonly be one of <code class="literal">386</code>, <code class="literal">amd64</code>, <code class="literal">arm</code>, or <code class="literal">arm64</code>.</p><p><span class="emphasis"><em>Default value:</em></span> the same value from <code class="literal">pkgs.go.GOARCH</code>.</p></dd><dt><span class="term"><code class="literal">tlsVerify</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Used to enable or disable HTTPS and TLS certificate verification when communicating with the chosen Docker registry.
Setting this to <code class="literal">false</code> will make <code class="literal">pullImage</code> connect to the registry through HTTP.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">true</code>.</p></dd><dt><span class="term"><code class="literal">name</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The name used for the output in the Nix store path.</p><p><span class="emphasis"><em>Default value:</em></span> a value derived from <code class="literal">finalImageName</code> and <code class="literal">finalImageTag</code>, with some symbols replaced.
It is recommended to treat the default as an opaque value.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-pullImage-examples" class="title" >Examples   </h4>  </div> </div></div><div class="example"><span id="ex-dockerTools-pullImage-niximage" ></span><details><summary><span class="title"><strong>Example 332. Pulling the nixos/nix Docker image from the default registry</strong></span></summary><div class="example-contents"><p>This example pulls the <a class="link" href="https://hub.docker.com/r/nixos/nix"  target="_top"><code class="literal">nixos/nix</code> image</a> and saves it in the Nix store.</p><pre><code class="programlisting nix">{ dockerTools }:
dockerTools.pullImage {
  imageName = &quot;nixos/nix&quot;;
  imageDigest = &quot;sha256:b8ea88f763f33dfda2317b55eeda3b1a4006692ee29e60ee54ccf6d07348c598&quot;;
  finalImageName = &quot;nix&quot;;
  finalImageTag = &quot;2.19.3&quot;;
  hash = &quot;sha256-zRwlQs1FiKrvHPaf8vWOR/Tlp1C5eLn1d9pE4BZg3oA=&quot;;
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-pullImage-differentregistry" ></span><details><summary><span class="title"><strong>Example 333. Pulling the nixos/nix Docker image from a specific registry</strong></span></summary><div class="example-contents"><p>This example pulls the <a class="link" href="https://quay.io/repository/coreos/etcd"  target="_top"><code class="literal">coreos/etcd</code> image</a> from the <code class="literal">quay.io</code> registry.</p><pre><code class="programlisting nix">{ dockerTools }:
dockerTools.pullImage {
  imageName = &quot;quay.io/coreos/etcd&quot;;
  imageDigest = &quot;sha256:24a23053f29266fb2731ebea27f915bb0fb2ae1ea87d42d890fe4e44f2e27c5d&quot;;
  finalImageName = &quot;etcd&quot;;
  finalImageTag = &quot;v3.5.11&quot;;
  hash = &quot;sha256-Myw+85f2/EVRyMB3axECdmQ5eh9p1q77FWYKy8YpRWU=&quot;;
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-pullImage-nixprefetchdocker" ></span><details><summary><span class="title"><strong>Example 334. Finding the digest and hash values to use for <code class="literal">dockerTools.pullImage</code></strong></span></summary><div class="example-contents"><p>Since <a class="link" href="index.html#ssec-pkgs-dockerTools-pullImage" title="pullImage" ><code class="literal">dockerTools.pullImage</code></a> requires two different hashes, one can run the <code class="literal">nix-prefetch-docker</code> tool to find out the values for the hashes.
The tool outputs some text for an attribute set which you can pass directly to <code class="literal">pullImage</code>.</p><pre><code class="programlisting shell">$ nix run nixpkgs#nix-prefetch-docker -- --image-name nixos/nix --image-tag 2.19.3 --arch amd64 --os linux
(some output removed for clarity)
Writing manifest to image destination
-&gt; ImageName: nixos/nix
-&gt; ImageDigest: sha256:498fa2d7f2b5cb3891a4edf20f3a8f8496e70865099ba72540494cd3e2942634
-&gt; FinalImageName: nixos/nix
-&gt; FinalImageTag: latest
-&gt; ImagePath: /nix/store/4mxy9mn6978zkvlc670g5703nijsqc95-docker-image-nixos-nix-latest.tar
-&gt; ImageHash: 1q6cf2pdrasa34zz0jw7pbs6lvv52rq2aibgxccbwcagwkg2qj1q
{
  imageName = &quot;nixos/nix&quot;;
  imageDigest = &quot;sha256:498fa2d7f2b5cb3891a4edf20f3a8f8496e70865099ba72540494cd3e2942634&quot;;
  hash = &quot;sha256-OEgs3uRPMb4Y629FJXAWZW9q9LqHS/A/GUqr3K5wzOA=&quot;;
  finalImageName = &quot;nixos/nix&quot;;
  finalImageTag = &quot;latest&quot;;
}
</code></pre><p>It is important to supply the <code class="literal">--arch</code> and <code class="literal">--os</code> arguments to <code class="literal">nix-prefetch-docker</code> to filter to a single image, in case there are multiple architectures and/or operating systems supported by the image name and tags specified.
By default, <code class="literal">nix-prefetch-docker</code> will set <code class="literal">os</code> to <code class="literal">linux</code> and <code class="literal">arch</code> to <code class="literal">amd64</code>.</p><p>Run <code class="literal">nix-prefetch-docker --help</code> for a list of all supported arguments:</p><pre><code class="programlisting shell">$ nix run nixpkgs#nix-prefetch-docker -- --help
(output removed for clarity)
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-dockerTools-exportImage" class="title" >exportImage   </h3>  </div> </div></div><p>This function is similar to the <code class="literal">docker container export</code> command, which means it can be used to export an image’s filesystem as an uncompressed tarball archive.
The difference is that <code class="literal">docker container export</code> is applied to containers, but <code class="literal">dockerTools.exportImage</code> applies to Docker images.
The resulting archive will not contain any image metadata (such as command to run with <code class="literal">docker container run</code>), only the filesystem contents.</p><p>You can use this function to import an archive in Docker with <code class="literal">docker image import</code>.
See <a class="xref" href="index.html#ex-dockerTools-exportImage-importingDocker" title="Example 336. Importing an archive built with dockerTools.exportImage in Docker" >Example 336</a> to understand how to do that.</p><div class="caution"><h3 class="title">Caution</h3><p><code class="literal">exportImage</code> works by unpacking the given image inside a VM.
Because of this, using this function requires the <code class="literal">kvm</code> device to be available, see <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/conf-file.html#conf-system-features"  target="_top"><code class="literal">system-features</code></a>.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-exportImage-inputs" class="title" >Inputs   </h4>  </div> </div></div><p><code class="literal">exportImage</code> expects an argument with the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">fromImage</code> (Attribute Set or String)</span></dt><dd><p>The repository tarball of the image whose filesystem will be exported.
It must be a valid Docker image, such as one exported by <code class="literal">docker image save</code>, or another image built with the <code class="literal">dockerTools</code> utility functions.</p><p>If <code class="literal">name</code> is not specified, <code class="literal">fromImage</code> must be an Attribute Set corresponding to a derivation, i.e. it can’t be a path to a tarball.
If <code class="literal">name</code> is specified, <code class="literal">fromImage</code> can be either an Attribute Set corresponding to a derivation or simply a path to a tarball.</p><p>See <a class="xref" href="index.html#ex-dockerTools-exportImage-naming" title="Example 337. Exploring output naming with dockerTools.exportImage" >Example 337</a> and <a class="xref" href="index.html#ex-dockerTools-exportImage-fromImagePath" title="Example 338. Using dockerTools.exportImage with a path as fromImage" >Example 338</a> to understand the connection between <code class="literal">fromImage</code>, <code class="literal">name</code>, and the name used for the output of <code class="literal">exportImage</code>.</p></dd><dt><span class="term"><code class="literal">fromImageName</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Used to specify the image within the repository tarball in case it contains multiple images.
A value of <code class="literal">null</code> means that <code class="literal">exportImage</code> will use the first image available in the repository.</p><div class="note"><h3 class="title">Note</h3><p>This must be used with <code class="literal">fromImageTag</code>. Using only <code class="literal">fromImageName</code> without <code class="literal">fromImageTag</code> will make <code class="literal">exportImage</code> use the first image available in the repository.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">fromImageTag</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Used to specify the image within the repository tarball in case it contains multiple images.
A value of <code class="literal">null</code> means that <code class="literal">exportImage</code> will use the first image available in the repository.</p><div class="note"><h3 class="title">Note</h3><p>This must be used with <code class="literal">fromImageName</code>. Using only <code class="literal">fromImageTag</code> without <code class="literal">fromImageName</code> will make <code class="literal">exportImage</code> use the first image available in the repository</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">diskSize</code> (Number; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Controls the disk size (in megabytes) of the VM used to unpack the image.</p><p><span class="emphasis"><em>Default value:</em></span> 1024.</p></dd><dt><span class="term"><code class="literal">name</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The name used for the output in the Nix store path.</p><p><span class="emphasis"><em>Default value:</em></span> the value of <code class="literal">fromImage.name</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-exportImage-examples" class="title" >Examples   </h4>  </div> </div></div><div class="example"><span id="ex-dockerTools-exportImage-hello" ></span><details><summary><span class="title"><strong>Example 335. Exporting a Docker image with <code class="literal">dockerTools.exportImage</code></strong></span></summary><div class="example-contents"><p>This example first builds a layered image with <a class="link" href="index.html#ssec-pkgs-dockerTools-buildLayeredImage" title="buildLayeredImage" ><code class="literal">dockerTools.buildLayeredImage</code></a>, and then exports its filesystem with <code class="literal">dockerTools.exportImage</code>.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.exportImage {
  name = &quot;hello&quot;;
  fromImage = dockerTools.buildLayeredImage {
    name = &quot;hello&quot;;
    contents = [ hello ];
  };
}
</code></pre><p>When building the package above, we can see the layers of the Docker image being unpacked to produce the final output:</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
Unpacking base image...
From-image name or tag wasn&#x27;t set. Reading the first ID.
Unpacking layer 5731199219418f175d1580dbca05677e69144425b2d9ecb60f416cd57ca3ca42/layer.tar
tar: Removing leading `/&#x27; from member names
Unpacking layer e2897bf34bb78c4a65736510204282d9f7ca258ba048c183d665bd0f3d24c5ec/layer.tar
tar: Removing leading `/&#x27; from member names
Unpacking layer 420aa5876dca4128cd5256da7dea0948e30ef5971712f82601718cdb0a6b4cda/layer.tar
tar: Removing leading `/&#x27; from member names
Unpacking layer ea5f4e620e7906c8ecbc506b5e6f46420e68d4b842c3303260d5eb621b5942e5/layer.tar
tar: Removing leading `/&#x27; from member names
Unpacking layer 65807b9abe8ab753fa97da8fb74a21fcd4725cc51e1b679c7973c97acd47ebcf/layer.tar
tar: Removing leading `/&#x27; from member names
Unpacking layer b7da2076b60ebc0ea6824ef641978332b8ac908d47b2d07ff31b9cc362245605/layer.tar
Executing post-mount steps...
Packing raw image...
[    1.660036] reboot: Power down
/nix/store/x6a5m7c6zdpqz1d8j7cnzpx9glzzvd2h-hello
</code></pre><p>The following command lists some of the contents of the output to verify that the structure of the archive is as expected:</p><pre><code class="programlisting shell">$ tar --exclude &#x27;*/share/*&#x27; --exclude &#x27;nix/store/*/*&#x27; -tvf /nix/store/x6a5m7c6zdpqz1d8j7cnzpx9glzzvd2h-hello
drwxr-xr-x root/0            0 1979-12-31 16:00 ./
drwxr-xr-x root/0            0 1979-12-31 16:00 ./bin/
lrwxrwxrwx root/0            0 1979-12-31 16:00 ./bin/hello -&gt; /nix/store/h92a9jd0lhhniv2q417hpwszd4jhys7q-hello-2.12.1/bin/hello
dr-xr-xr-x root/0            0 1979-12-31 16:00 ./nix/
dr-xr-xr-x root/0            0 1979-12-31 16:00 ./nix/store/
dr-xr-xr-x root/0            0 1979-12-31 16:00 ./nix/store/05zbwhz8a7i2v79r9j21pl6m6cj0xi8k-libunistring-1.1/
dr-xr-xr-x root/0            0 1979-12-31 16:00 ./nix/store/ayg5rhjhi9ic73hqw33mjqjxwv59ndym-xgcc-13.2.0-libgcc/
dr-xr-xr-x root/0            0 1979-12-31 16:00 ./nix/store/h92a9jd0lhhniv2q417hpwszd4jhys7q-hello-2.12.1/
dr-xr-xr-x root/0            0 1979-12-31 16:00 ./nix/store/m59xdgkgnjbk8kk6k6vbxmqnf82mk9s0-libidn2-2.3.4/
dr-xr-xr-x root/0            0 1979-12-31 16:00 ./nix/store/p3jshbwxiwifm1py0yq544fmdyy98j8a-glibc-2.38-27/
drwxr-xr-x root/0            0 1979-12-31 16:00 ./share/
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-exportImage-importingDocker" ></span><details><summary><span class="title"><strong>Example 336. Importing an archive built with <code class="literal">dockerTools.exportImage</code> in Docker</strong></span></summary><div class="example-contents"><p>We will use the same package from <a class="xref" href="index.html#ex-dockerTools-exportImage-hello" title="Example 335. Exporting a Docker image with dockerTools.exportImage" >Example 335</a> and import it into Docker.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.exportImage {
  name = &quot;hello&quot;;
  fromImage = dockerTools.buildLayeredImage {
    name = &quot;hello&quot;;
    contents = [ hello ];
  };
}
</code></pre><p>Building and importing it into Docker:</p><pre><code class="programlisting shell">$ nix-build
(output removed for clarity)
/nix/store/x6a5m7c6zdpqz1d8j7cnzpx9glzzvd2h-hello
$ docker image import /nix/store/x6a5m7c6zdpqz1d8j7cnzpx9glzzvd2h-hello
sha256:1d42dba415e9b298ea0decf6497fbce954de9b4fcb2984f91e307c8fedc1f52f
$ docker image ls
REPOSITORY                              TAG                IMAGE ID       CREATED         SIZE
&lt;none&gt;                                  &lt;none&gt;             1d42dba415e9   4 seconds ago   32.6MB
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-exportImage-naming" ></span><details><summary><span class="title"><strong>Example 337. Exploring output naming with <code class="literal">dockerTools.exportImage</code></strong></span></summary><div class="example-contents"><p><code class="literal">exportImage</code> does not require a <code class="literal">name</code> attribute if <code class="literal">fromImage</code> is a derivation, which means that the following works:</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.exportImage {
  fromImage = dockerTools.buildLayeredImage {
    name = &quot;hello&quot;;
    contents = [ hello ];
  };
}
</code></pre><p>However, since <a class="link" href="index.html#ssec-pkgs-dockerTools-buildLayeredImage" title="buildLayeredImage" ><code class="literal">dockerTools.buildLayeredImage</code></a>’s output ends with <code class="literal">.tar.gz</code>, the output of <code class="literal">exportImage</code> will also end with <code class="literal">.tar.gz</code>, even though the archive created with <code class="literal">exportImage</code> is uncompressed:</p><pre><code class="programlisting shell">$ nix-build
(output removed for clarity)
/nix/store/by3f40xvc4l6bkis74l0fj4zsy0djgkn-hello.tar.gz
$ file /nix/store/by3f40xvc4l6bkis74l0fj4zsy0djgkn-hello.tar.gz
/nix/store/by3f40xvc4l6bkis74l0fj4zsy0djgkn-hello.tar.gz: POSIX tar archive (GNU)
</code></pre><p>If the archive was actually compressed, the output of file would’ve mentioned that fact.
Because of this, it may be important to set a proper <code class="literal">name</code> attribute when using <code class="literal">exportImage</code> with other functions from <code class="literal">dockerTools</code>.</p></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-exportImage-fromImagePath" ></span><details><summary><span class="title"><strong>Example 338. Using <code class="literal">dockerTools.exportImage</code> with a path as <code class="literal">fromImage</code></strong></span></summary><div class="example-contents"><p>It is possible to use a path as the value of the <code class="literal">fromImage</code> attribute when calling <code class="literal">dockerTools.exportImage</code>.
However, when doing so, a <code class="literal">name</code> attribute <span class="strong"><strong>MUST</strong></span> be specified, or you’ll encounter an error when evaluating the Nix code.</p><p>For this example, we’ll assume a Docker tarball image named <code class="literal">image.tar.gz</code> exists in the same directory where our package is defined:</p><pre><code class="programlisting nix">{ dockerTools }:
dockerTools.exportImage {
  name = &quot;filesystem.tar&quot;;
  fromImage = ./image.tar.gz;
}
</code></pre><p>Building this will give us the expected output:</p><pre><code class="programlisting shell">$ nix-build
(output removed for clarity)
/nix/store/w13l8h3nlkg0zv56k7rj0ai0l2zlf7ss-filesystem.tar
</code></pre><p>If you don’t specify a <code class="literal">name</code> attribute, you’ll encounter an evaluation error and the package won’t build.</p></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-dockerTools-helpers" class="title" >Environment Helpers   </h3>  </div> </div></div><p>When building Docker images with Nix, you might also want to add certain files that are expected to be available globally by the software you’re packaging.
Simple examples are the <code class="literal">env</code> utility in <code class="literal">/usr/bin/env</code>, or trusted root TLS/SSL certificates.
Such files will most likely not be included if you’re building a Docker image from scratch with Nix, and they might also not be included if you’re starting from a Docker image that doesn’t include them.
The helpers in this section are packages that provide some of these commonly-needed global files.</p><p>Most of these helpers are packages, which means you have to add them to the list of contents to be included in the image (this changes depending on the function you’re using to build the image).
<a class="xref" href="index.html#ex-dockerTools-helpers-buildImage" title="Example 339. Using dockerTools’s environment helpers with buildImage" >Example 339</a> and <a class="xref" href="index.html#ex-dockerTools-helpers-buildLayeredImage" title="Example 340. Using dockerTools’s environment helpers with buildLayeredImage" >Example 340</a> show how to include these packages on <code class="literal">dockerTools</code> functions that build an image.
For more details on how that works, see the documentation for the function you’re using.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sssec-pkgs-dockerTools-helpers-usrBinEnv" class="title" >usrBinEnv   </h4>  </div> </div></div><p>This provides the <code class="literal">env</code> utility at <code class="literal">/usr/bin/env</code>.
This is currently implemented by linking to the <code class="literal">env</code> binary from the <code class="literal">coreutils</code> package, but is considered an implementation detail that could change in the future.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sssec-pkgs-dockerTools-helpers-binSh" class="title" >binSh   </h4>  </div> </div></div><p>This provides a <code class="literal">/bin/sh</code> link to the <code class="literal">bash</code> binary from the <code class="literal">bashInteractive</code> package.
Because of this, it supports cases such as running a command interactively in a container (for example by running <code class="literal">docker container run -it &lt;image_name&gt;</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sssec-pkgs-dockerTools-helpers-caCertificates" class="title" >caCertificates   </h4>  </div> </div></div><p>This adds trusted root TLS/SSL certificates from the <code class="literal">cacert</code> package in multiple locations in an attempt to be compatible with binaries built for multiple Linux distributions.
The locations currently used are:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">/etc/ssl/certs/ca-bundle.crt</code></p></li><li class="listitem"><p><code class="literal">/etc/ssl/certs/ca-certificates.crt</code></p></li><li class="listitem"><p><code class="literal">/etc/pki/tls/certs/ca-bundle.crt</code></p></li></ul></div><p><span id="ssec-pkgs-dockerTools-fakeNss"></span></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sssec-pkgs-dockerTools-helpers-fakeNss" class="title" >fakeNss   </h4>  </div> </div></div><p>This is a re-export of the <code class="literal">fakeNss</code> package from Nixpkgs.
See <a class="xref" href="index.html#sec-fakeNss" title="fakeNss" >the section called “fakeNss”</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-shadowSetup" class="title" >shadowSetup   </h4>  </div> </div></div><p>This is a string containing a script that sets up files needed for <a class="link" href="https://github.com/shadow-maint/shadow"  target="_top"><code class="literal">shadow</code></a> to work (using the <code class="literal">shadow</code> package from Nixpkgs), and alters <code class="literal">PATH</code> to make all its utilities available in the same script.
It is intended to be used with other dockerTools functions in attributes that expect scripts.
After the script in <code class="literal">shadowSetup</code> runs, you’ll then be able to add more commands that make use of the utilities in <code class="literal">shadow</code>, such as adding any extra users and/or groups.
See <a class="xref" href="index.html#ex-dockerTools-shadowSetup-buildImage" title="Example 341. Using dockerTools.shadowSetup with dockerTools.buildImage" >Example 341</a> and <a class="xref" href="index.html#ex-dockerTools-shadowSetup-buildLayeredImage" title="Example 342. Using dockerTools.shadowSetup with dockerTools.buildLayeredImage" >Example 342</a> to better understand how to use it.</p><p><code class="literal">shadowSetup</code> achieves a result similar to <a class="link" href="index.html#sssec-pkgs-dockerTools-helpers-fakeNss" title="fakeNss" ><code class="literal">fakeNss</code></a>, but only sets up a <code class="literal">root</code> user with different values for the home directory and the shell to use, in addition to setting up files for <a class="link" href="https://en.wikipedia.org/wiki/Linux_PAM"  target="_top">PAM</a> and a <a class="link" href="https://man.archlinux.org/man/login.defs.5" target="_top"><span class="citerefentry"><span class="refentrytitle">login.defs</span>(5)</span></a> file.</p><div class="caution"><h3 class="title">Caution</h3><p>Using both <code class="literal">fakeNss</code> and <code class="literal">shadowSetup</code> at the same time will either cause your build to break or produce unexpected results.
Use either <code class="literal">fakeNss</code> or <code class="literal">shadowSetup</code> depending on your use case, but avoid using both.</p></div><div class="note"><h3 class="title">Note</h3><p>When used with <a class="link" href="index.html#ssec-pkgs-dockerTools-buildLayeredImage" title="buildLayeredImage" ><code class="literal">buildLayeredImage</code></a> or <a class="link" href="index.html#ssec-pkgs-dockerTools-streamLayeredImage" title="streamLayeredImage" ><code class="literal">streamLayeredImage</code></a>, you will have to set the <code class="literal">enableFakechroot</code> attribute to <code class="literal">true</code>, or else the script in <code class="literal">shadowSetup</code> won’t run properly.
See <a class="xref" href="index.html#ex-dockerTools-shadowSetup-buildLayeredImage" title="Example 342. Using dockerTools.shadowSetup with dockerTools.buildLayeredImage" >Example 342</a>.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-helpers-examples" class="title" >Examples   </h4>  </div> </div></div><div class="example"><span id="ex-dockerTools-helpers-buildImage" ></span><details><summary><span class="title"><strong>Example 339. Using <code class="literal">dockerTools</code>’s environment helpers with <code class="literal">buildImage</code></strong></span></summary><div class="example-contents"><p>This example adds the <a class="link" href="index.html#sssec-pkgs-dockerTools-helpers-binSh" title="binSh" ><code class="literal">binSh</code></a> helper to a basic Docker image built with <a class="link" href="index.html#ssec-pkgs-dockerTools-buildImage" title="buildImage" ><code class="literal">dockerTools.buildImage</code></a>.
This helper makes it possible to enter a shell inside the container.
This is the <code class="literal">buildImage</code> equivalent of <a class="xref" href="index.html#ex-dockerTools-helpers-buildLayeredImage" title="Example 340. Using dockerTools’s environment helpers with buildLayeredImage" >Example 340</a>.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.buildImage {
  name = &quot;env-helpers&quot;;
  tag = &quot;latest&quot;;

  copyToRoot = [
    hello
    dockerTools.binSh
  ];
}
</code></pre><p>After building the image and loading it in Docker, we can create a container based on it and enter a shell inside the container.
This is made possible by <code class="literal">binSh</code>.</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
/nix/store/2p0i3i04cgjlk71hsn7ll4kxaxxiv4qg-docker-image-env-helpers.tar.gz
$ docker image load -i /nix/store/2p0i3i04cgjlk71hsn7ll4kxaxxiv4qg-docker-image-env-helpers.tar.gz
(output removed for clarity)
$ docker container run --rm -it env-helpers:latest /bin/sh
sh-5.2# help
GNU bash, version 5.2.21(1)-release (x86_64-pc-linux-gnu)
(rest of output removed for clarity)
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-helpers-buildLayeredImage" ></span><details><summary><span class="title"><strong>Example 340. Using <code class="literal">dockerTools</code>’s environment helpers with <code class="literal">buildLayeredImage</code></strong></span></summary><div class="example-contents"><p>This example adds the <a class="link" href="index.html#sssec-pkgs-dockerTools-helpers-binSh" title="binSh" ><code class="literal">binSh</code></a> helper to a basic Docker image built with <a class="link" href="index.html#ssec-pkgs-dockerTools-buildLayeredImage" title="buildLayeredImage" ><code class="literal">dockerTools.buildLayeredImage</code></a>.
This helper makes it possible to enter a shell inside the container.
This is the <code class="literal">buildLayeredImage</code> equivalent of <a class="xref" href="index.html#ex-dockerTools-helpers-buildImage" title="Example 339. Using dockerTools’s environment helpers with buildImage" >Example 339</a>.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.buildLayeredImage {
  name = &quot;env-helpers&quot;;
  tag = &quot;latest&quot;;

  contents = [
    hello
    dockerTools.binSh
  ];

  config = {
    Cmd = [ &quot;/bin/hello&quot; ];
  };
}
</code></pre><p>After building the image and loading it in Docker, we can create a container based on it and enter a shell inside the container.
This is made possible by <code class="literal">binSh</code>.</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
/nix/store/rpf47f4z5b9qr4db4ach9yr4b85hjhxq-env-helpers.tar.gz
$ docker image load -i /nix/store/rpf47f4z5b9qr4db4ach9yr4b85hjhxq-env-helpers.tar.gz
(output removed for clarity)
$ docker container run --rm -it env-helpers:latest /bin/sh
sh-5.2# help
GNU bash, version 5.2.21(1)-release (x86_64-pc-linux-gnu)
(rest of output removed for clarity)
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-shadowSetup-buildImage" ></span><details><summary><span class="title"><strong>Example 341. Using <code class="literal">dockerTools.shadowSetup</code> with <code class="literal">dockerTools.buildImage</code></strong></span></summary><div class="example-contents"><p>This is an example that shows how to use <code class="literal">shadowSetup</code> with <code class="literal">dockerTools.buildImage</code>.
Note that the extra script in <code class="literal">runAsRoot</code> uses <code class="literal">groupadd</code> and <code class="literal">useradd</code>, which are binaries provided by the <code class="literal">shadow</code> package.
These binaries are added to the <code class="literal">PATH</code> by the <code class="literal">shadowSetup</code> script, but only for the duration of <code class="literal">runAsRoot</code>.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.buildImage {
  name = &quot;shadow-basic&quot;;
  tag = &quot;latest&quot;;

  copyToRoot = [ hello ];

  runAsRoot = &#x27;&#x27;
    ${dockerTools.shadowSetup}
    groupadd -r hello
    useradd -r -g hello hello
    mkdir /data
    chown hello:hello /data
  &#x27;&#x27;;

  config = {
    Cmd = [ &quot;/bin/hello&quot; ];
    WorkingDir = &quot;/data&quot;;
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-shadowSetup-buildLayeredImage" ></span><details><summary><span class="title"><strong>Example 342. Using <code class="literal">dockerTools.shadowSetup</code> with <code class="literal">dockerTools.buildLayeredImage</code></strong></span></summary><div class="example-contents"><p>It accomplishes the same thing as <a class="xref" href="index.html#ex-dockerTools-shadowSetup-buildImage" title="Example 341. Using dockerTools.shadowSetup with dockerTools.buildImage" >Example 341</a>, but using <code class="literal">buildLayeredImage</code> instead.</p><p>Note that the extra script in <code class="literal">fakeRootCommands</code> uses <code class="literal">groupadd</code> and <code class="literal">useradd</code>, which are binaries provided by the <code class="literal">shadow</code> package.
These binaries are added to the <code class="literal">PATH</code> by the <code class="literal">shadowSetup</code> script, but only for the duration of <code class="literal">fakeRootCommands</code>.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.buildLayeredImage {
  name = &quot;shadow-basic&quot;;
  tag = &quot;latest&quot;;

  contents = [ hello ];

  fakeRootCommands = &#x27;&#x27;
    ${dockerTools.shadowSetup}
    groupadd -r hello
    useradd -r -g hello hello
    mkdir /data
    chown hello:hello /data
  &#x27;&#x27;;
  enableFakechroot = true;

  config = {
    Cmd = [ &quot;/bin/hello&quot; ];
    WorkingDir = &quot;/data&quot;;
  };
}
</code></pre></div></details></div><br class="example-break" /><p><span id="ssec-pkgs-dockerTools-buildNixShellImage-arguments"></span></p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-dockerTools-buildNixShellImage" class="title" >buildNixShellImage   </h3>  </div> </div></div><p><code class="literal">buildNixShellImage</code> uses <a class="link" href="index.html#ssec-pkgs-dockerTools-streamNixShellImage" title="streamNixShellImage" ><code class="literal">streamNixShellImage</code></a> underneath to build a compressed Docker-compatible repository tarball of an image that sets up an environment similar to that of running <code class="literal">nix-shell</code> on a derivation.
Basically, <code class="literal">buildNixShellImage</code> runs the script created by <code class="literal">streamNixShellImage</code> to save the compressed image in the Nix store.</p><p><code class="literal">buildNixShellImage</code> supports the same options as <code class="literal">streamNixShellImage</code>, see <a class="link" href="index.html#ssec-pkgs-dockerTools-streamNixShellImage" title="streamNixShellImage" ><code class="literal">streamNixShellImage</code></a> for details.</p><p><span id="ssec-pkgs-dockerTools-buildNixShellImage-example"></span></p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-buildNixShellImage-examples" class="title" >Examples   </h4>  </div> </div></div><div class="example"><span id="ex-dockerTools-buildNixShellImage-hello" ></span><details><summary><span class="title"><strong>Example 343. Building a Docker image with <code class="literal">buildNixShellImage</code> with the build environment for the <code class="literal">hello</code> package</strong></span></summary><div class="example-contents"><p>This example shows how to build the <code class="literal">hello</code> package inside a Docker container built with <code class="literal">buildNixShellImage</code>.
The Docker image generated will have a name like <code class="literal">hello-&lt;version&gt;-env</code> and tag <code class="literal">latest</code>.
This example is the <code class="literal">buildNixShellImage</code> equivalent of <a class="xref" href="index.html#ex-dockerTools-streamNixShellImage-hello" title="Example 344. Building a Docker image with streamNixShellImage with the build environment for the hello package" >Example 344</a>.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.buildNixShellImage {
  drv = hello;
  tag = &quot;latest&quot;;
}
</code></pre><p>The result of building this package is a <code class="literal">.tar.gz</code> file that can be loaded into Docker:</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
/nix/store/pkj1sgzaz31wl0pbvbg3yp5b3kxndqms-hello-2.12.1-env.tar.gz

$ docker image load -i /nix/store/pkj1sgzaz31wl0pbvbg3yp5b3kxndqms-hello-2.12.1-env.tar.gz
(some output removed for clarity)
Loaded image: hello-2.12.1-env:latest
</code></pre><p>After starting an interactive container, the derivation can be built by running <code class="literal">buildDerivation</code>, and the output can be executed as expected:</p><pre><code class="programlisting shell">$ docker container run -it hello-2.12.1-env:latest
[nix-shell:~]$ buildDerivation
Running phase: unpackPhase
unpacking source archive /nix/store/pa10z4ngm0g83kx9mssrqzz30s84vq7k-hello-2.12.1.tar.gz
source root is hello-2.12.1
(some output removed for clarity)
Running phase: fixupPhase
shrinking RPATHs of ELF executables and libraries in /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1
shrinking /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/bin/hello
checking for references to /build/ in /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1...
gzipping man pages under /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/share/man/
patching script interpreter paths in /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1
stripping (with command strip and flags -S -p) in  /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/bin

[nix-shell:~]$ $out/bin/hello
Hello, world!
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-dockerTools-streamNixShellImage" class="title" >streamNixShellImage   </h3>  </div> </div></div><p><code class="literal">streamNixShellImage</code> builds a <span class="strong"><strong>script</strong></span> which, when run, will stream to stdout a Docker-compatible repository tarball of an image that sets up an environment similar to that of running <code class="literal">nix-shell</code> on a derivation.
This means that <code class="literal">streamNixShellImage</code> does not output an image into the Nix store, but only a script that builds the image, saving on IO and disk/cache space, particularly with large images.
See <a class="xref" href="index.html#ex-dockerTools-streamNixShellImage-hello" title="Example 344. Building a Docker image with streamNixShellImage with the build environment for the hello package" >Example 344</a> to understand how to load in Docker the image generated by this script.</p><p>The environment set up by <code class="literal">streamNixShellImage</code> somewhat resembles the Nix sandbox typically used by <code class="literal">nix-build</code>, with a major difference being that access to the internet is allowed.
It also behaves like an interactive <code class="literal">nix-shell</code>, running things like <code class="literal">shellHook</code> (see <a class="xref" href="index.html#ex-dockerTools-streamNixShellImage-addingShellHook" title="Example 346. Adding a shellHook to a Docker image built with streamNixShellImage" >Example 346</a>) and setting an interactive prompt.
If the derivation is buildable (i.e. <code class="literal">nix-build</code> can be used on it), running <code class="literal">buildDerivation</code> in the container will build the derivation, with all its outputs being available in the correct <code class="literal">/nix/store</code> paths, pointed to by the respective environment variables (e.g. <code class="literal">$out</code>).</p><div class="caution"><h3 class="title">Caution</h3><p>The environment in the image doesn’t match <code class="literal">nix-shell</code> or <code class="literal">nix-build</code> exactly, and this function is known not to work correctly for fixed-output derivations, content-addressed derivations, impure derivations and other special types of derivations.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-streamNixShellImage-inputs" class="title" >Inputs   </h4>  </div> </div></div><p><code class="literal">streamNixShellImage</code> expects one argument with the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">drv</code> (Attribute Set)</span></dt><dd><p>The derivation for which the environment in the image will be set up.
Adding packages to the Docker image is possible by extending the list of <code class="literal">nativeBuildInputs</code> of this derivation.
See <a class="xref" href="index.html#ex-dockerTools-streamNixShellImage-extendingBuildInputs" title="Example 345. Adding extra packages to a Docker image built with streamNixShellImage" >Example 345</a> for how to do that.
Similarly, you can extend the image initialization script by extending <code class="literal">shellHook</code>.
<a class="xref" href="index.html#ex-dockerTools-streamNixShellImage-addingShellHook" title="Example 346. Adding a shellHook to a Docker image built with streamNixShellImage" >Example 346</a> shows how to do that.</p></dd><dt><span class="term"><code class="literal">name</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The name of the generated image.</p><p><span class="emphasis"><em>Default value:</em></span> the value of <code class="literal">drv.name + &quot;-env&quot;</code>.</p></dd><dt><span class="term"><code class="literal">tag</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Tag of the generated image.
If <code class="literal">null</code>, the hash of the nix derivation that builds the Docker image will be used as the tag.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">uid</code> (Number; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The user ID to run the container as.
This can be seen as a <code class="literal">nixbld</code> build user.</p><p><span class="emphasis"><em>Default value:</em></span> 1000.</p></dd><dt><span class="term"><code class="literal">gid</code> (Number; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The group ID to run the container as.
This can be seen as a <code class="literal">nixbld</code> build group.</p><p><span class="emphasis"><em>Default value:</em></span> 1000.</p></dd><dt><span class="term"><code class="literal">homeDirectory</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The home directory of the user the container is running as.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">/build</code>.</p></dd><dt><span class="term"><code class="literal">shell</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The path to the <code class="literal">bash</code> binary to use as the shell.
This shell is started when running the image.
This can be seen as an equivalent of the <code class="literal">NIX_BUILD_SHELL</code> <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/nix-shell.html#environment-variables"  target="_top">environment variable</a> for <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/nix-shell.html" target="_top"><span class="citerefentry"><span class="refentrytitle">nix-shell</span>(1)</span></a>.</p><p><span class="emphasis"><em>Default value:</em></span> the <code class="literal">bash</code> binary from the <code class="literal">bashInteractive</code> package.</p></dd><dt><span class="term"><code class="literal">command</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>If specified, this command will be run in the environment of the derivation in an interactive shell.
A call to <code class="literal">exit</code> will be added after the command if it is specified, so the shell will exit after it’s finished running.
This can be seen as an equivalent of the <code class="literal">--command</code> option in <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/nix-shell.html" target="_top"><span class="citerefentry"><span class="refentrytitle">nix-shell</span>(1)</span></a>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">run</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Similar to the <code class="literal">command</code> attribute, but runs the command in a non-interactive shell instead.
A call to <code class="literal">exit</code> will be added after the command if it is specified, so the shell will exit after it’s finished running.
This can be seen as an equivalent of the <code class="literal">--run</code> option in <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/nix-shell.html" target="_top"><span class="citerefentry"><span class="refentrytitle">nix-shell</span>(1)</span></a>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-dockerTools-streamNixShellImage-examples" class="title" >Examples   </h4>  </div> </div></div><div class="example"><span id="ex-dockerTools-streamNixShellImage-hello" ></span><details><summary><span class="title"><strong>Example 344. Building a Docker image with <code class="literal">streamNixShellImage</code> with the build environment for the <code class="literal">hello</code> package</strong></span></summary><div class="example-contents"><p>This example shows how to build the <code class="literal">hello</code> package inside a Docker container built with <code class="literal">streamNixShellImage</code>.
The Docker image generated will have a name like <code class="literal">hello-&lt;version&gt;-env</code> and tag <code class="literal">latest</code>.
This example is the <code class="literal">streamNixShellImage</code> equivalent of <a class="xref" href="index.html#ex-dockerTools-buildNixShellImage-hello" title="Example 343. Building a Docker image with buildNixShellImage with the build environment for the hello package" >Example 343</a>.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.streamNixShellImage {
  drv = hello;
  tag = &quot;latest&quot;;
}
</code></pre><p>The result of building this package is a script.
Running this script and piping it into <code class="literal">docker image load</code> gives you the same image that was built in <a class="xref" href="index.html#ex-dockerTools-buildNixShellImage-hello" title="Example 343. Building a Docker image with buildNixShellImage with the build environment for the hello package" >Example 343</a>.</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
/nix/store/8vhznpz2frqazxnd8pgdvf38jscdypax-stream-hello-2.12.1-env

$ /nix/store/8vhznpz2frqazxnd8pgdvf38jscdypax-stream-hello-2.12.1-env | docker image load
(some output removed for clarity)
Loaded image: hello-2.12.1-env:latest
</code></pre><p>After starting an interactive container, the derivation can be built by running <code class="literal">buildDerivation</code>, and the output can be executed as expected:</p><pre><code class="programlisting shell">$ docker container run -it hello-2.12.1-env:latest
[nix-shell:~]$ buildDerivation
Running phase: unpackPhase
unpacking source archive /nix/store/pa10z4ngm0g83kx9mssrqzz30s84vq7k-hello-2.12.1.tar.gz
source root is hello-2.12.1
(some output removed for clarity)
Running phase: fixupPhase
shrinking RPATHs of ELF executables and libraries in /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1
shrinking /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/bin/hello
checking for references to /build/ in /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1...
gzipping man pages under /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/share/man/
patching script interpreter paths in /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1
stripping (with command strip and flags -S -p) in  /nix/store/f2vs29jibd7lwxyj35r9h87h6brgdysz-hello-2.12.1/bin

[nix-shell:~]$ $out/bin/hello
Hello, world!
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-streamNixShellImage-extendingBuildInputs" ></span><details><summary><span class="title"><strong>Example 345. Adding extra packages to a Docker image built with <code class="literal">streamNixShellImage</code></strong></span></summary><div class="example-contents"><p>This example shows how to add extra packages to an image built with <code class="literal">streamNixShellImage</code>.
In this case, we’ll add the <code class="literal">cowsay</code> package.
The Docker image generated will have a name like <code class="literal">hello-&lt;version&gt;-env</code> and tag <code class="literal">latest</code>.
This example uses <a class="xref" href="index.html#ex-dockerTools-streamNixShellImage-hello" title="Example 344. Building a Docker image with streamNixShellImage with the build environment for the hello package" >Example 344</a> as a starting point.</p><pre><code class="programlisting nix">{
  dockerTools,
  cowsay,
  hello,
}:
dockerTools.streamNixShellImage {
  tag = &quot;latest&quot;;
  drv = hello.overrideAttrs (old: {
    nativeBuildInputs = old.nativeBuildInputs or [ ] ++ [ cowsay ];
  });
}
</code></pre><p>The result of building this package is a script which can be run and piped into <code class="literal">docker image load</code> to load the generated image.</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
/nix/store/h5abh0vljgzg381lna922gqknx6yc0v7-stream-hello-2.12.1-env

$ /nix/store/h5abh0vljgzg381lna922gqknx6yc0v7-stream-hello-2.12.1-env | docker image load
(some output removed for clarity)
Loaded image: hello-2.12.1-env:latest
</code></pre><p>After starting an interactive container, we can verify the extra package is available by running <code class="literal">cowsay</code>:</p><pre><code class="programlisting shell">$ docker container run -it hello-2.12.1-env:latest
[nix-shell:~]$ cowsay &quot;Hello, world!&quot;
 _______________
&lt; Hello, world! &gt;
 ---------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-dockerTools-streamNixShellImage-addingShellHook" ></span><details><summary><span class="title"><strong>Example 346. Adding a <code class="literal">shellHook</code> to a Docker image built with <code class="literal">streamNixShellImage</code></strong></span></summary><div class="example-contents"><p>This example shows how to add a <code class="literal">shellHook</code> command to an image built with <code class="literal">streamNixShellImage</code>.
In this case, we’ll simply output the string <code class="literal">Hello, world!</code>.
The Docker image generated will have a name like <code class="literal">hello-&lt;version&gt;-env</code> and tag <code class="literal">latest</code>.
This example uses <a class="xref" href="index.html#ex-dockerTools-streamNixShellImage-hello" title="Example 344. Building a Docker image with streamNixShellImage with the build environment for the hello package" >Example 344</a> as a starting point.</p><pre><code class="programlisting nix">{ dockerTools, hello }:
dockerTools.streamNixShellImage {
  tag = &quot;latest&quot;;
  drv = hello.overrideAttrs (old: {
    shellHook = &#x27;&#x27;
      ${old.shellHook or &quot;&quot;}
      echo &quot;Hello, world!&quot;
    &#x27;&#x27;;
  });
}
</code></pre><p>The result of building this package is a script which can be run and piped into <code class="literal">docker image load</code> to load the generated image.</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
/nix/store/iz4dhdvgzazl5vrgyz719iwjzjy6xlx1-stream-hello-2.12.1-env

$ /nix/store/iz4dhdvgzazl5vrgyz719iwjzjy6xlx1-stream-hello-2.12.1-env | docker image load
(some output removed for clarity)
Loaded image: hello-2.12.1-env:latest
</code></pre><p>After starting an interactive container, we can see the result of the <code class="literal">shellHook</code>:</p><pre><code class="programlisting shell">$ docker container run -it hello-2.12.1-env:latest
Hello, world!

[nix-shell:~]$
</code></pre></div></details></div><br class="example-break" />
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-ociTools" class="title" style="clear: both">pkgs.ociTools   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-pkgs-ociTools-buildContainer">buildContainer</a> </span></dt> </dl></div><p><code class="literal">pkgs.ociTools</code> is a set of functions for creating runtime container bundles according to the <a class="link" href="https://github.com/opencontainers/runtime-spec/blob/v1.0.0/spec.md"  target="_top">OCI runtime specification v1.0.0</a>.
It makes no assumptions about the container runner you choose to use to run the created container.</p><p>The set of functions in <code class="literal">pkgs.ociTools</code> currently does not handle the <a class="link" href="https://github.com/opencontainers/image-spec"  target="_top">OCI image specification</a>.</p><p>At a high-level an OCI implementation would download an OCI Image then unpack that image into an OCI Runtime filesystem bundle.
At this point the OCI Runtime Bundle would be run by an OCI Runtime.
<code class="literal">pkgs.ociTools</code> provides utilities to create OCI Runtime bundles.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-ociTools-buildContainer" class="title" >buildContainer   </h3>  </div> </div></div><p>This function creates an OCI runtime container (consisting of a <code class="literal">config.json</code> and a root filesystem directory) that runs a single command inside of it.
The nix store of the container will contain all referenced dependencies of the given command.</p><p>This function has an assumption that the container will run on POSIX platforms, and sets configurations (such as the user running the process or certain mounts) according to this assumption.
Because of this, a container built with <code class="literal">buildContainer</code> will not work on Windows or other non-POSIX platforms without modifications to the container configuration.
These modifications aren’t supported by <code class="literal">buildContainer</code>.</p><p>For <code class="literal">linux</code> platforms, <code class="literal">buildContainer</code> also configures the following namespaces (see <a class="link" href="https://man.archlinux.org/man/unshare.1.en" target="_top"><span class="citerefentry"><span class="refentrytitle">unshare</span>(1)</span></a>) to isolate the OCI container from the global namespace:
PID, network, mount, IPC, and UTS.</p><p>Note that no user namespace is created, which means that you won’t be able to run the container unless you are the <code class="literal">root</code> user.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-ociTools-buildContainer-inputs" class="title" >Inputs   </h4>  </div> </div></div><p><code class="literal">buildContainer</code> expects an argument with the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">args</code> (List of String)</span></dt><dd><p>Specifies a set of arguments to run inside the container.
Any packages referenced by <code class="literal">args</code> will be made available inside the container.</p></dd><dt><span class="term"><code class="literal">mounts</code> (Attribute Set; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Would specify additional mounts that the runtime must make available to the container.</p><div class="warning"><h3 class="title">Warning</h3><p>As explained in <a class="link" href="https://github.com/NixOS/nixpkgs/issues/290879"  target="_top">issue #290879</a>, this attribute is currently ignored.</p></div><div class="note"><h3 class="title">Note</h3><p><code class="literal">buildContainer</code> includes a minimal set of necessary filesystems to be mounted into the container, and this set can’t be changed with the <code class="literal">mounts</code> attribute.</p></div><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">{}</code>.</p></dd><dt><span class="term"><code class="literal">readonly</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>If <code class="literal">true</code>, sets the container’s root filesystem as read-only.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">os</code> <span class="strong"><strong>DEPRECATED</strong></span></span></dt><dd><p>Specifies the operating system on which the container filesystem is based on.
If specified, its value should follow the <a class="link" href="https://github.com/opencontainers/image-spec/blob/main/config.md#properties"  target="_top">OCI Image Configuration Specification</a>.
According to the linked specification, all possible values for <code class="literal">$GOOS</code> in <a class="link" href="https://go.dev/doc/install/source#environment"  target="_top">the Go docs</a> should be valid, but will commonly be one of <code class="literal">darwin</code> or <code class="literal">linux</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;linux&quot;</code>.</p></dd><dt><span class="term"><code class="literal">arch</code> <span class="strong"><strong>DEPRECATED</strong></span></span></dt><dd><p>Used to specify the architecture for which the binaries in the container filesystem have been compiled.
If specified, its value should follow the <a class="link" href="https://github.com/opencontainers/image-spec/blob/main/config.md#properties"  target="_top">OCI Image Configuration Specification</a>.
According to the linked specification, all possible values for <code class="literal">$GOARCH</code> in <a class="link" href="https://go.dev/doc/install/source#environment"  target="_top">the Go docs</a> should be valid, but will commonly be one of <code class="literal">386</code>, <code class="literal">amd64</code>, <code class="literal">arm</code>, or <code class="literal">arm64</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">x86_64</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-pkgs-ociTools-buildContainer-examples" class="title" >Examples   </h4>  </div> </div></div><div class="example"><span id="ex-ociTools-buildContainer-bash" ></span><details><summary><span class="title"><strong>Example 347. Creating an OCI runtime container that runs <code class="literal">bash</code></strong></span></summary><div class="example-contents"><p>This example uses <code class="literal">ociTools.buildContainer</code> to create a simple container that runs <code class="literal">bash</code>.</p><pre><code class="programlisting nix">{
  ociTools,
  lib,
  bash,
}:
ociTools.buildContainer {
  args = [ (lib.getExe bash) ];

  readonly = false;
}
</code></pre><p>As an example of how to run the container generated by this package, we’ll use <code class="literal">runc</code> to start the container.
Any other tool that supports OCI containers could be used instead.</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
/nix/store/7f9hgx0arvhzp2a3qphp28rxbn748l25-join

$ cd /nix/store/7f9hgx0arvhzp2a3qphp28rxbn748l25-join
$ nix-shell -p runc
[nix-shell:/nix/store/7f9hgx0arvhzp2a3qphp28rxbn748l25-join]$ sudo runc run ocitools-example
help
GNU bash, version 5.2.26(1)-release (x86_64-pc-linux-gnu)
(some output removed for clarity)
</code></pre></div></details></div><br class="example-break" />
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-portableService" class="title" style="clear: both">pkgs.portableService   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-pkgs-portableService-inputs">Inputs</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-pkgs-portableService-examples">Examples</a> </span></dt> </dl></div><p><code class="literal">pkgs.portableService</code> is a function to create <a class="link" href="https://systemd.io/PORTABLE_SERVICES/"  target="_top">Portable Services</a> in a read-only, immutable, <code class="literal">squashfs</code> raw disk image.
This lets you use Nix to build images which can be run on many recent Linux distributions.</p><div class="note"><h3 class="title">Note</h3><p>Portable services are supported starting with systemd 239 (released on 2018-06-22).</p></div><p>The generated image will contain the file system structure as required by the Portable Services specification, along with the packages given to <code class="literal">portableService</code> and all of their dependencies.
When generated, the image will exist in the Nix store with the <code class="literal">.raw</code> file extension, as required by the specification.
See <a class="xref" href="index.html#ex-portableService-hello" title="Example 348. Building a Portable Service image" >Example 348</a> to understand how to use the output of <code class="literal">portableService</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-portableService-inputs" class="title" >Inputs   </h3>  </div> </div></div><p><code class="literal">portableService</code> expects one argument with the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pname</code> (String)</span></dt><dd><p>The name of the portable service.
The generated image will be named according to the template <code class="literal">$pname_$version.raw</code>, which is supported by the Portable Services specification.</p></dd><dt><span class="term"><code class="literal">version</code> (String)</span></dt><dd><p>The version of the portable service.
The generated image will be named according to the template <code class="literal">$pname_$version.raw</code>, which is supported by the Portable Services specification.</p></dd><dt><span class="term"><code class="literal">units</code> (List of Attribute Set)</span></dt><dd><p>A list of derivations for systemd unit files.
Each derivation must produce a single file, and must have a name that starts with the value of <code class="literal">pname</code> and ends with the suffix of the unit type (e.g. “.service”, “.socket”, “.timer”, and so on).
See <a class="xref" href="index.html#ex-portableService-hello" title="Example 348. Building a Portable Service image" >Example 348</a> to better understand this naming constraint.</p></dd><dt><span class="term"><code class="literal">description</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>If specified, the value is added as <code class="literal">PORTABLE_PRETTY_NAME</code> to the <code class="literal">/etc/os-release</code> file in the generated image.
This could be used to provide more information to anyone inspecting the image.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">homepage</code> (String or Null; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>If specified, the value is added as <code class="literal">HOME_URL</code> to the <code class="literal">/etc/os-release</code> file in the generated image.
This could be used to provide more information to anyone inspecting the image.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">symlinks</code> (List of Attribute Set; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A list of attribute sets in the format <code class="literal">{object, symlink}</code>.
For each item in the list, <code class="literal">portableService</code> will create a symlink in the path specified by <code class="literal">symlink</code> (relative to the root of the image) that points to <code class="literal">object</code>.</p><p>All packages that <code class="literal">object</code> depends on and their dependencies are automatically copied into the image.</p><p>This can be used to create symlinks for applications that assume some files to exist globally (<code class="literal">/etc/ssl</code> or <code class="literal">/bin/bash</code>, for example).
See <a class="xref" href="index.html#ex-portableService-symlinks" title="Example 349. Specifying symlinks when building a Portable Service image" >Example 349</a> to understand how to do that.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">[]</code>.</p></dd><dt><span class="term"><code class="literal">contents</code> (List of Attribute Set; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>A list of additional derivations to be included as-is in the image.
These derivations will be included directly in a <code class="literal">/nix/store</code> directory inside the image.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">[]</code>.</p></dd><dt><span class="term"><code class="literal">squashfsTools</code> (Attribute Set; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Allows you to override the package that provides <a class="link" href="https://man.archlinux.org/man/extra/squashfs-tools/mksquashfs.1.en" target="_top"><span class="citerefentry"><span class="refentrytitle">mksquashfs</span>(1)</span></a>, which is used internally by <code class="literal">portableService</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">pkgs.squashfsTools</code>.</p></dd><dt><span class="term"><code class="literal">squash-compression</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Passed as the compression option to <a class="link" href="https://man.archlinux.org/man/extra/squashfs-tools/mksquashfs.1.en" target="_top"><span class="citerefentry"><span class="refentrytitle">mksquashfs</span>(1)</span></a>, which is used internally by <code class="literal">portableService</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;xz -Xdict-size 100%&quot;</code>.</p></dd><dt><span class="term"><code class="literal">squash-block-size</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>Passed as the block size option to <a class="link" href="https://man.archlinux.org/man/extra/squashfs-tools/mksquashfs.1.en" target="_top"><span class="citerefentry"><span class="refentrytitle">mksquashfs</span>(1)</span></a>, which is used internally by <code class="literal">portableService</code>.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">&quot;1M&quot;</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-pkgs-portableService-examples" class="title" >Examples   </h3>  </div> </div></div><p><span id="ex-pkgs-portableService"></span></p><div class="example"><span id="ex-portableService-hello" ></span><details><summary><span class="title"><strong>Example 348. Building a Portable Service image</strong></span></summary><div class="example-contents"><p>The following example builds a Portable Service image with the <code class="literal">hello</code> package, along with a service unit that runs it.</p><pre><code class="programlisting nix">{
  lib,
  writeText,
  portableService,
  hello,
}:
let
  hello-service = writeText &quot;hello.service&quot; &#x27;&#x27;
    [Unit]
    Description=Hello world service

    [Service]
    Type=oneshot
    ExecStart=${lib.getExe hello}
  &#x27;&#x27;;
in
portableService {
  pname = &quot;hello&quot;;
  inherit (hello) version;
  units = [ hello-service ];
}
</code></pre><p>After building the package, the generated image can be loaded into a system through <a class="link" href="https://www.freedesktop.org/software/systemd/man/portablectl.html" target="_top"><span class="citerefentry"><span class="refentrytitle">portablectl</span>(1)</span></a>:</p><pre><code class="programlisting shell">$ nix-build
(some output removed for clarity)
/nix/store/8c20z1vh7z8w8dwagl8w87b45dn5k6iq-hello-img-2.12.1

$ portablectl attach /nix/store/8c20z1vh7z8w8dwagl8w87b45dn5k6iq-hello-img-2.12.1/hello_2.12.1.raw
Created directory /etc/systemd/system.attached.
Created directory /etc/systemd/system.attached/hello.service.d.
Written /etc/systemd/system.attached/hello.service.d/20-portable.conf.
Created symlink /etc/systemd/system.attached/hello.service.d/10-profile.conf → /usr/lib/systemd/portable/profile/default/service.conf.
Copied /etc/systemd/system.attached/hello.service.
Created symlink /etc/portables/hello_2.12.1.raw → /nix/store/8c20z1vh7z8w8dwagl8w87b45dn5k6iq-hello-img-2.12.1/hello_2.12.1.raw.

$ systemctl start hello
$ journalctl -u hello
Feb 28 22:39:16 hostname systemd[1]: Starting Hello world service...
Feb 28 22:39:16 hostname hello[102887]: Hello, world!
Feb 28 22:39:16 hostname systemd[1]: hello.service: Deactivated successfully.
Feb 28 22:39:16 hostname systemd[1]: Finished Hello world service.

$ portablectl detach hello_2.12.1
Removed /etc/systemd/system.attached/hello.service.
Removed /etc/systemd/system.attached/hello.service.d/10-profile.conf.
Removed /etc/systemd/system.attached/hello.service.d/20-portable.conf.
Removed /etc/systemd/system.attached/hello.service.d.
Removed /etc/portables/hello_2.12.1.raw.
Removed /etc/systemd/system.attached.
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-portableService-symlinks" ></span><details><summary><span class="title"><strong>Example 349. Specifying symlinks when building a Portable Service image</strong></span></summary><div class="example-contents"><p>Some services may expect files or directories to be available globally.
An example is a service which expects all trusted SSL certificates to exist in a specific location by default.</p><p>To make things available globally, you must specify the <code class="literal">symlinks</code> attribute when using <code class="literal">portableService</code>.
The following package builds on the package from <a class="xref" href="index.html#ex-portableService-hello" title="Example 348. Building a Portable Service image" >Example 348</a> to make <code class="literal">/etc/ssl</code> available globally (this is only for illustrative purposes, because <code class="literal">hello</code> doesn’t use <code class="literal">/etc/ssl</code>).</p><pre><code class="programlisting nix">{
  lib,
  writeText,
  portableService,
  hello,
  cacert,
}:
let
  hello-service = writeText &quot;hello.service&quot; &#x27;&#x27;
    [Unit]
    Description=Hello world service

    [Service]
    Type=oneshot
    ExecStart=${lib.getExe hello}
  &#x27;&#x27;;
in
portableService {
  pname = &quot;hello&quot;;
  inherit (hello) version;
  units = [ hello-service ];
  symlinks = [
    {
      object = &quot;${cacert}/etc/ssl&quot;;
      symlink = &quot;/etc/ssl&quot;;
    }
  ];
}
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-make-disk-image" class="title" style="clear: both"><code class="literal">&lt;nixpkgs/nixos/lib/make-disk-image.nix&gt;</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-make-disk-image-features">Features</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-make-disk-image-usage">Usage</a> </span></dt> </dl></div><p><code class="literal">&lt;nixpkgs/nixos/lib/make-disk-image.nix&gt;</code> is a function to create <span class="emphasis"><em>disk images</em></span> in multiple formats: raw, QCOW2 (QEMU), QCOW2-Compressed (compressed version), VDI (VirtualBox), VPC (VirtualPC).</p><p>This function can create images in two ways:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>using <code class="literal">cptofs</code> without any virtual machine to create a Nix store disk image,</p></li><li class="listitem"><p>using a virtual machine to create a full NixOS installation.</p></li></ul></div><p>When testing early-boot or lifecycle parts of NixOS such as a bootloader or multiple generations, it is necessary to opt for a full NixOS system installation.
Whereas for many web servers, applications, it is possible to work with a Nix store only disk image and is faster to build.</p><p>NixOS tests also use this function when preparing the VM. The <code class="literal">cptofs</code> method is used when <code class="literal">virtualisation.useBootLoader</code> is false (the default). Otherwise the second method is used.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-make-disk-image-features" class="title" >Features   </h3>  </div> </div></div><p>For reference, read the function signature source code for documentation on arguments: <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/make-disk-image.nix"  target="_top">https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/make-disk-image.nix</a>.
Features are separated in various sections depending on if you opt for a Nix-store only image or a full NixOS image.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-make-disk-image-features-common" class="title" >Common   </h4>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>arbitrary NixOS configuration</p></li><li class="listitem"><p>automatic or bound disk size: <code class="literal">diskSize</code> parameter, <code class="literal">additionalSpace</code> can be set when <code class="literal">diskSize</code> is <code class="literal">auto</code> to add a constant of disk space</p></li><li class="listitem"><p>multiple partition table layouts: EFI, legacy, legacy + GPT, hybrid, none through <code class="literal">partitionTableType</code> parameter</p></li><li class="listitem"><p>OVMF or EFI firmwares and variables templates can be customized</p></li><li class="listitem"><p>root filesystem <code class="literal">fsType</code> can be customized to whatever <code class="literal">mkfs.${fsType}</code> exist during operations</p></li><li class="listitem"><p>root filesystem label can be customized, defaults to <code class="literal">nix-store</code> if it’s a Nix store image, otherwise <code class="literal">nixpkgs/nixos</code></p></li><li class="listitem"><p>arbitrary code can be executed after disk image was produced with <code class="literal">postVM</code></p></li><li class="listitem"><p>the current nixpkgs can be realized as a channel in the disk image, which will change the hash of the image when the sources are updated</p></li><li class="listitem"><p>additional store paths can be provided through <code class="literal">additionalPaths</code></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-make-disk-image-features-full-image" class="title" >Full NixOS image   </h4>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>arbitrary contents with permissions can be placed in the target filesystem using <code class="literal">contents</code></p></li><li class="listitem"><p>a <code class="literal">/etc/nixpkgs/nixos/configuration.nix</code> can be provided through <code class="literal">configFile</code></p></li><li class="listitem"><p>bootloaders are supported</p></li><li class="listitem"><p>EFI variables can be mutated during image production and the result is exposed in <code class="literal">$out</code></p></li><li class="listitem"><p>boot partition size when partition table is <code class="literal">efi</code> or <code class="literal">hybrid</code></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-make-disk-image-features-reproducibility" class="title" >On bit-to-bit reproducibility   </h4>  </div> </div></div><p>Images are <span class="strong"><strong>NOT</strong></span> deterministic, please do not hesitate to try to fix this, source of determinisms are (not exhaustive) :</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>bootloader installation have timestamps</p></li><li class="listitem"><p>SQLite Nix store database contain registration times</p></li><li class="listitem"><p><code class="literal">/etc/shadow</code> is in a non-deterministic order</p></li></ul></div><p>A <code class="literal">deterministic</code> flag is available for best efforts determinism.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-make-disk-image-usage" class="title" >Usage   </h3>  </div> </div></div><p>To produce a Nix-store only image:</p><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };
  lib = pkgs.lib;
  make-disk-image = import &lt;nixpkgs/nixos/lib/make-disk-image.nix&gt;;
in
make-disk-image {
  inherit pkgs lib;
  config = { };
  additionalPaths = [ ];
  format = &quot;qcow2&quot;;
  onlyNixStore = true;
  partitionTableType = &quot;none&quot;;
  installBootLoader = false;
  touchEFIVars = false;
  diskSize = &quot;auto&quot;;
  additionalSpace = &quot;0M&quot;; # Defaults to 512M.
  copyChannel = false;
}
</code></pre><p>Some arguments can be left out, they are shown explicitly for the sake of the example.</p><p>Building this derivation will provide a QCOW2 disk image containing only the Nix store and its registration information.</p><p>To produce a NixOS installation image disk with UEFI and bootloader installed:</p><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };
  lib = pkgs.lib;
  make-disk-image = import &lt;nixpkgs/nixos/lib/make-disk-image.nix&gt;;
  evalConfig = import &lt;nixpkgs/nixos/lib/eval-config.nix&gt;;
in
make-disk-image {
  inherit pkgs lib;
  inherit
    (evalConfig {
      modules = [
        {
          fileSystems.&quot;/&quot; = {
            device = &quot;/dev/vda&quot;;
            fsType = &quot;ext4&quot;;
            autoFormat = true;
          };
          boot.grub.device = &quot;/dev/vda&quot;;
        }
      ];
    })
    config
    ;
  format = &quot;qcow2&quot;;
  onlyNixStore = false;
  partitionTableType = &quot;legacy+gpt&quot;;
  installBootLoader = true;
  touchEFIVars = true;
  diskSize = &quot;auto&quot;;
  additionalSpace = &quot;0M&quot;; # Defaults to 512M.
  copyChannel = false;
  memSize = 2048; # Qemu VM memory size in MiB (1024*1024 bytes). Defaults to 1024M.
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkgs-binary-cache" class="title" style="clear: both">pkgs.mkBinaryCache   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-pkgs-binary-cache-arguments">Optional arguments</a> </span></dt> </dl></div><p><code class="literal">pkgs.mkBinaryCache</code> is a function for creating Nix flat-file binary caches.
Such a cache exists as a directory on disk, and can be used as a Nix substituter by passing <code class="literal">--substituter file:///path/to/cache</code> to Nix commands.</p><p>Nix packages are most commonly shared between machines using <a class="link" href="https://nixos.org/manual/nix/stable/package-management/sharing-packages.html"  target="_top">HTTP, SSH, or S3</a>, but a flat-file binary cache can still be useful in some situations.
For example, you can copy it directly to another machine, or make it available on a network file system.
It can also be a convenient way to make some Nix packages available inside a container via bind-mounting.</p><p><code class="literal">mkBinaryCache</code> expects an argument with the <code class="literal">rootPaths</code> attribute.
<code class="literal">rootPaths</code> must be a list of derivations.
The transitive closure of these derivations’ outputs will be copied into the cache.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkgs-binary-cache-arguments" class="title" >Optional arguments   </h3>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">compression</code> (<code class="literal">&quot;none&quot;</code> or <code class="literal">&quot;xz&quot;</code> or <code class="literal">&quot;zstd&quot;</code>; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>The compression algorithm to use.</p><p><span class="emphasis"><em>Default value:</em></span> <code class="literal">zstd</code>.</p></dd></dl></div><div class="note"><h3 class="title">Note</h3><p>This function is meant for advanced use cases.
The more idiomatic way to work with flat-file binary caches is via the <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/nix-copy-closure.html"  target="_top">nix-copy-closure</a> command.
You may also want to consider <a class="link" href="index.html#sec-pkgs-dockerTools" title="pkgs.dockerTools" >dockerTools</a> for your containerization needs.</p></div><p><span id="sec-pkgs-binary-cache-example"></span></p><div class="example"><span id="ex-mkbinarycache-copying-package-closure" ></span><details><summary><span class="title"><strong>Example 350. Copying a package and its closure to another machine with <code class="literal">mkBinaryCache</code></strong></span></summary><div class="example-contents"><p>The following derivation will construct a flat-file binary cache containing the closure of <code class="literal">hello</code>.</p><pre><code class="programlisting nix">{ mkBinaryCache, hello }: mkBinaryCache { rootPaths = [ hello ]; }
</code></pre><p>Build the cache on a machine.
Note that the command still builds the exact nix package above, but adds some boilerplate to build it directly from an expression.</p><pre><code class="programlisting shellSession">$ nix-build -E &#x27;let pkgs = import &lt;nixpkgs&gt; {}; in pkgs.callPackage ({ mkBinaryCache, hello }: mkBinaryCache { rootPaths = [hello]; }) {}&#x27;
/nix/store/azf7xay5xxdnia4h9fyjiv59wsjdxl0g-binary-cache
</code></pre><p>Copy the resulting directory to another machine, which we’ll call <code class="literal">host2</code>:</p><pre><code class="programlisting shellSession">$ scp result host2:/tmp/hello-cache
</code></pre><p>At this point, the cache can be used as a substituter when building derivations on <code class="literal">host2</code>:</p><pre><code class="programlisting shellSession">$ nix-build -A hello &#x27;&lt;nixpkgs&gt;&#x27; \
  --option require-sigs false \
  --option trusted-substituters file:///tmp/hello-cache \
  --option substituters file:///tmp/hello-cache
/nix/store/zhl06z4lrfrkw5rp0hnjjfrgsclzvxpm-hello-2.12.1
</code></pre></div></details></div><br class="example-break" />
</div>

</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-hooks" class="title" >Hooks reference   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#setup-hook-autoconf">Autoconf</a> </span></dt><dt> <span class="section">  <a href="index.html#setup-hook-automake">Automake</a> </span></dt><dt> <span class="section">  <a href="index.html#setup-hook-autopatchcilhook">autoPatchcilHook</a> </span></dt><dt> <span class="section">  <a href="index.html#setup-hook-autopatchelfhook">autoPatchelfHook</a> </span></dt><dt> <span class="section">  <a href="index.html#aws-c-common"><code class="literal">aws-c-common</code></a> </span></dt><dt> <span class="section">  <a href="index.html#bmake-hook">bmake</a> </span></dt><dt> <span class="section">  <a href="index.html#breakpointhook">breakpointHook</a> </span></dt><dt> <span class="section">  <a href="index.html#cernlib-hook">CERNLIB</a> </span></dt><dt> <span class="section">  <a href="index.html#cmake">cmake</a> </span></dt><dt> <span class="section">  <a href="index.html#desktop-file-utils">desktop-file-utils</a> </span></dt><dt> <span class="section">  <a href="index.html#setup-hook-gdk-pixbuf">gdk-pixbuf</a> </span></dt><dt> <span class="section">  <a href="index.html#ghc">GHC</a> </span></dt><dt> <span class="section">  <a href="index.html#gnome-platform">GNOME platform</a> </span></dt><dt> <span class="section">  <a href="index.html#haredo-hook"><code class="literal">haredo</code></a> </span></dt><dt> <span class="section">  <a href="index.html#installshellfiles"><code class="literal">installShellFiles</code></a> </span></dt><dt> <span class="section">  <a href="index.html#just-hook"><code class="literal">just</code></a> </span></dt><dt> <span class="section">  <a href="index.html#libiconv-libintl">libiconv, libintl</a> </span></dt><dt> <span class="section">  <a href="index.html#setup-hook-libxml2">libxml2</a> </span></dt><dt> <span class="section">  <a href="index.html#meson">Meson</a> </span></dt><dt> <span class="section">  <a href="index.html#setup-hook-mpi-check">mpiCheckPhaseHook</a> </span></dt><dt> <span class="section">  <a href="index.html#ninja">ninja</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-patchRcPathHooks"><code class="literal">patchRcPath</code> hooks</a> </span></dt><dt> <span class="section">  <a href="index.html#setup-hook-perl">Perl</a> </span></dt><dt> <span class="section">  <a href="index.html#setup-hook-pkg-config">pkg-config</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-postgresqlTestHook"><code class="literal">postgresqlTestHook</code></a> </span></dt><dt> <span class="section">  <a href="index.html#premake-hook">Premake</a> </span></dt><dt> <span class="section">  <a href="index.html#setup-hook-python">Python</a> </span></dt><dt> <span class="section">  <a href="index.html#scons">scons</a> </span></dt><dt> <span class="section">  <a href="index.html#tauri-hook">cargo-tauri.hook</a> </span></dt><dt> <span class="section">  <a href="index.html#tetex-tex-live">teTeX / TeX Live</a> </span></dt><dt> <span class="section">  <a href="index.html#udevcheckhook">udevCheckHook</a> </span></dt><dt> <span class="section">  <a href="index.html#unzip">unzip</a> </span></dt><dt> <span class="section">  <a href="index.html#validatepkgconfig">validatePkgConfig</a> </span></dt><dt> <span class="section">  <a href="index.html#versioncheckhook">versionCheckHook</a> </span></dt><dt> <span class="section">  <a href="index.html#waf-hook">wafHook</a> </span></dt><dt> <span class="section">  <a href="index.html#zig-hook">zig.hook</a> </span></dt><dt> <span class="section">  <a href="index.html#xcbuildhook">xcbuildHook</a> </span></dt><dt> <span class="section">  <a href="index.html#xfce4-dev-tools"><code class="literal">xfce.xfce4-dev-tools</code></a> </span></dt> </dl></div><p>Nixpkgs has several hook packages that augment the stdenv phases.</p><p>The stdenv built-in hooks are documented in <a class="xref" href="index.html#ssec-setup-hooks" title="Package setup hooks" >the section called “Package setup hooks”</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="setup-hook-autoconf" class="title" style="clear: both">Autoconf   </h2>  </div> </div></div><p>The <code class="literal">autoreconfHook</code> derivation adds <code class="literal">autoreconfPhase</code>, which runs autoreconf, libtoolize and automake, essentially preparing the configure script in autotools-based builds. Most autotools-based packages come with the configure script pre-generated, but this hook is necessary for a few packages and when you need to patch the package’s configure scripts.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="setup-hook-automake" class="title" style="clear: both">Automake   </h2>  </div> </div></div><p>Adds the <code class="literal">share/aclocal</code> subdirectory of each build input to the <code class="literal">ACLOCAL_PATH</code> environment variable.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="setup-hook-autopatchcilhook" class="title" style="clear: both">autoPatchcilHook   </h2>  </div> </div></div><p>This is a special setup hook which helps in packaging .NET assemblies/programs in that it automatically tries to find missing shared library dependencies of .NET assemblies based on the given <code class="literal">buildInputs</code> and <code class="literal">nativeBuildInputs</code>.</p><p>As the hook needs information for the host where the package will be run on, there’s a required environment variable called <code class="literal">autoPatchcilRuntimeId</code> which should be filled in with the RID (Runtime Identifier) of the machine where the output will be run on. If you’re using <code class="literal">buildDotnetModule</code>, it will fall back to <code class="literal">dotnetRuntimeIds</code> (which is set to <code class="literal">lib.singleton (if runtimeId != null then runtimeId else systemToDotnetRid stdenvNoCC.hostPlatform.system)</code>) for you if not provided.</p><p>In certain situations you may want to run the main command (<code class="literal">autoPatchcil</code>) of the setup hook on a file or a set of directories instead of unconditionally patching all outputs. This can be done by setting the <code class="literal">dontAutoPatchcil</code> environment variable to a non-empty value.</p><p>By default, <code class="literal">autoPatchcil</code> will fail as soon as any .NET assembly requires a dependency which cannot be resolved via the given build inputs. In some situations you might prefer to just leave missing dependencies unpatched and continue to patch the rest. This can be achieved by setting the <code class="literal">autoPatchcilIgnoreMissingDeps</code> environment variable to a non-empty value. <code class="literal">autoPatchcilIgnoreMissingDeps</code> can be set to a list like <code class="literal">autoPatchcilIgnoreMissingDeps = [ &quot;libcuda.so.1&quot; &quot;libcudart.so.1&quot; ];</code> or to <code class="literal">[ &quot;*&quot; ]</code> to ignore all missing dependencies.</p><p>The <code class="literal">autoPatchcil</code> command requires the <code class="literal">--rid</code> command line flag, informing the RID (Runtime Identifier) it should assume the assemblies will be executed on, and also recognizes a <code class="literal">--no-recurse</code> command line flag, which prevents it from recursing into subdirectories.</p><div class="note"><h3 class="title">Note</h3><p>Since, unlike most native binaries, .NET assemblies are compiled once to run on any platform, many assemblies may have PInvoke stubs for libraries that might not be available on the platform that the package will effectively run on. A few examples are assemblies that call native Windows APIs through PInvoke targeting <code class="literal">kernel32</code>, <code class="literal">gdi32</code>, <code class="literal">user32</code>, <code class="literal">shell32</code> or <code class="literal">ntdll</code>.</p><p><code class="literal">autoPatchcil</code> does its best to ignore dependencies from other platforms by checking the requested file extensions, however not all PInvoke stubs provide an extension so in those cases it will be necessary to list those in <code class="literal">autoPatchcilIgnoreMissingDeps</code> manually.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="setup-hook-autopatchelfhook" class="title" style="clear: both">autoPatchelfHook   </h2>  </div> </div></div><p>This is a special setup hook which helps in packaging proprietary software in that it automatically tries to find missing shared library dependencies of ELF files based on the given <code class="literal">buildInputs</code> and <code class="literal">nativeBuildInputs</code>.</p><p>You can also specify a <code class="literal">runtimeDependencies</code> variable which lists dependencies to be unconditionally added to rpath of all executables. This is useful for programs that use dlopen 3 to load libraries at runtime.</p><p>In certain situations you may want to run the main command (<code class="literal">autoPatchelf</code>) of the setup hook on a file or a set of directories instead of unconditionally patching all outputs. This can be done by setting the <code class="literal">dontAutoPatchelf</code> environment variable to a non-empty value.</p><p>By default <code class="literal">autoPatchelf</code> will fail as soon as any ELF file requires a dependency which cannot be resolved via the given build inputs. In some situations you might prefer to just leave missing dependencies unpatched and continue to patch the rest. This can be achieved by setting the <code class="literal">autoPatchelfIgnoreMissingDeps</code> environment variable to a non-empty value. <code class="literal">autoPatchelfIgnoreMissingDeps</code> can be set to a list like <code class="literal">autoPatchelfIgnoreMissingDeps = [ &quot;libcuda.so.1&quot; &quot;libcudart.so.1&quot; ];</code> or to <code class="literal">[ &quot;*&quot; ]</code> to ignore all missing dependencies.</p><p>The <code class="literal">autoPatchelf</code> command also recognizes a <code class="literal">--no-recurse</code> command line flag, which prevents it from recursing into subdirectories.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="aws-c-common" class="title" style="clear: both"><code class="literal">aws-c-common</code>   </h2>  </div> </div></div><p>This hook exposes its own <a class="link" href="index.html#cmake" title="cmake" >CMake</a> modules by setting <a class="link" href="https://cmake.org/cmake/help/latest/variable/CMAKE_MODULE_PATH.html"  target="_top"><code class="literal">CMAKE_MODULE_PATH</code></a> through <a class="link" href="index.html#cmake-flags" title="cmakeFlags" >the <code class="literal">cmakeFlags</code> variable</a>
to the nonstandard <code class="literal">$out/lib/cmake</code> directory, as a workaround for <a class="link" href="https://github.com/awslabs/aws-c-common/issues/844"  target="_top">an upstream bug</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="bmake-hook" class="title" style="clear: both">bmake   </h2>  </div> </div></div><p><a class="link" href="https://www.crufty.net/help/sjg/bmake.html"  target="_top">bmake</a> is the portable variant of
NetBSD make utility.</p><p>In Nixpkgs, <code class="literal">bmake</code> comes with a hook that overrides the default build, check,
install and dist phases.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="breakpointhook" class="title" style="clear: both">breakpointHook   </h2>  </div> </div></div><p>This hook makes a build pause instead of stopping when a failure occurs. It prevents Nix from cleaning up the build environment immediately and allows the user to attach to the build environment. Upon a build error, it will print instructions that can be used to enter the environment for debugging. breakpointHook is only available on Linux. To use it, add <code class="literal">breakpointHook</code> to <code class="literal">nativeBuildInputs</code> in the package to be inspected.</p><pre><code class="programlisting nix">{ nativeBuildInputs = [ breakpointHook ]; }
</code></pre><p>When a build failure occurs, an instruction will be printed showing how to attach to the build sandbox.</p><div class="note"><h3 class="title">Note</h3><p>Caution with remote builds</p><p>For remote builds, the printed instructions need to be run on the remote machine, as the build sandbox is only accessible on the machine running the builds. Remote builds can be turned off by setting <code class="literal">--option builders &#x27;&#x27;</code> for <code class="literal">nix-build</code> or <code class="literal">--builders &#x27;&#x27;</code> for <code class="literal">nix build</code>. :::</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="cernlib-hook" class="title" style="clear: both">CERNLIB   </h2>  </div> </div></div><p>This hook sets the <code class="literal">CERN</code>, <code class="literal">CERN_LEVEL</code>, and <code class="literal">CERN_ROOT</code> environment variables. They are part of <a class="link" href="https://cernlib.web.cern.ch/install/install.html"  target="_top">CERNLIB’s build system</a>, and are are needed for some programs to compile correctly.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="cmake" class="title" style="clear: both">cmake   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#cmake-variables-controlling">Variables controlling CMake</a> </span></dt><dt> <span class="section">  <a href="index.html#cmake-ctest">Controlling CTest invocation</a> </span></dt> </dl></div><p>Overrides the default configure phase to run the CMake command.</p><p>By default, we use the Make generator of CMake.
But when Ninja is also available as a <code class="literal">nativeBuildInput</code>, this setup hook will detect that and use the ninja generator.</p><p>Dependencies are added automatically to <code class="literal">CMAKE_PREFIX_PATH</code> so that packages are correctly detected by CMake.
Some additional flags are passed in to give similar behavior to configure-based packages.</p><p>By default, parallel building is enabled as CMake supports parallel building almost everywhere.</p><p>You can disable this hook’s behavior by setting <code class="literal">configurePhase</code> to a custom value, or by setting <code class="literal">dontUseCmakeConfigure</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="cmake-variables-controlling" class="title" >Variables controlling CMake   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cmake-exclusive-variables" class="title" >CMake Exclusive Variables   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cmake-flags" class="title" ><code class="literal">cmakeFlags</code>   </h5>  </div> </div></div><p>Controls the flags passed to <code class="literal">cmake setup</code> during configure phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cmake-build-dir" class="title" ><code class="literal">cmakeBuildDir</code>   </h5>  </div> </div></div><p>Directory where CMake will put intermediate files.</p><p>Setting this can be useful for debugging multiple CMake builds while in the same source directory, for example, when building for different platforms.
Different values for each build will prevent build artefacts from interefering with each other.
This setting has no tangible effect when running the build in a sandboxed derivation.</p><p>The default value is <code class="literal">build</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-use-cmake-configure" class="title" ><code class="literal">dontUseCmakeConfigure</code>   </h5>  </div> </div></div><p>When set to true, don’t use the predefined <code class="literal">cmakeConfigurePhase</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="cmake-ctest" class="title" >Controlling CTest invocation   </h3>  </div> </div></div><p>By default tests are run by make in <a class="link" href="index.html#ssec-check-phase" title="The check phase" ><code class="literal">checkPhase</code></a> or by <a class="link" href="index.html#ninja" title="ninja" >ninja</a> if <code class="literal">ninja</code> is
available in <code class="literal">nativeBuildInputs</code>. Makefile and Ninja generators produce the <code class="literal">test</code> target, which invokes <code class="literal">ctest</code> under the hood.
This makes passing additional arguments to <code class="literal">ctest</code> difficult, so it’s possible to invoke it directly in <code class="literal">checkPhase</code>
by adding <code class="literal">ctestCheckHook</code> to <code class="literal">nativeCheckInputs</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cmake-ctest-variables" class="title" >CTest Variables   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cmake-ctest-disabled-tests" class="title" ><code class="literal">disabledTests</code>   </h5>  </div> </div></div><p>Allows to disable running a list of tests. Note that regular expressions are not supported by <code class="literal">disabledTests</code>, but
it can be combined with <code class="literal">--exclude-regex</code> option.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cmake-ctest-flags" class="title" ><code class="literal">ctestFlags</code>   </h5>  </div> </div></div><p>Additional options passed to <code class="literal">ctest</code> together with <code class="literal">checkFlags</code>.</p>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="desktop-file-utils" class="title" style="clear: both">desktop-file-utils   </h2>  </div> </div></div><p>This setup hook removes the MIME cache (located at <code class="literal">$out/share/applications/mimeinfo.cache</code>) in the <code class="literal">preFixupPhase</code>.</p><p>This hook is necessary because <code class="literal">mimeinfo.cache</code> can be created when a package uses <code class="literal">desktop-file-utils</code>, resulting in collisions if multiple packages are installed that contain this file (as in <a class="link" href="https://github.com/NixOS/nixpkgs/issues/48295"  target="_top">#48295</a>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="setup-hook-gdk-pixbuf" class="title" style="clear: both">gdk-pixbuf   </h2>  </div> </div></div><p>Exports <code class="literal">GDK_PIXBUF_MODULE_FILE</code> environment variable to the builder. Add librsvg package to <code class="literal">buildInputs</code> to get svg support. See also the <a class="link" href="index.html#ssec-gnome-hooks-gdk-pixbuf"  >setup hook description in GNOME platform docs</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ghc" class="title" style="clear: both">GHC   </h2>  </div> </div></div><p>Creates a temporary package database and registers every Haskell build input in it (TODO: how?).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="gnome-platform" class="title" style="clear: both">GNOME platform   </h2>  </div> </div></div><p>Hooks related to GNOME platform and related libraries like GLib, GTK and GStreamer are described in <a class="xref" href="index.html#sec-language-gnome" title="GNOME" >the section called “GNOME”</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="haredo-hook" class="title" style="clear: both"><code class="literal">haredo</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#haredo-hook-buildPhase"><code class="literal">buildPhase</code></a> </span></dt><dt> <span class="section">  <a href="index.html#haredo-hook-checkPhase"><code class="literal">checkPhase</code></a> </span></dt><dt> <span class="section">  <a href="index.html#haredo-hook-installPhase"><code class="literal">installPhase</code></a> </span></dt> </dl></div><p>This hook uses <a class="link" href="https://sr.ht/~autumnull/haredo/"  target="_top">the <code class="literal">haredo</code> command runner</a> to build, check, and install the package. It overrides <code class="literal">buildPhase</code>, <code class="literal">checkPhase</code>, and <code class="literal">installPhase</code> by default.</p><p>The hook builds its targets in parallel if <a class="link" href="index.html#var-stdenv-enableParallelBuilding" title="enableParallelBuilding" ><code class="literal">config.enableParallelBuilding</code></a> is set to <code class="literal">true</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="haredo-hook-buildPhase" class="title" ><code class="literal">buildPhase</code>   </h3>  </div> </div></div><p>This phase attempts to build the default target.</p><p><span id="haredo-hook-haredoBuildTargets"></span> Targets can be explicitly set by adding a string to the <code class="literal">haredoBuildTargets</code> list.</p><p><span id="haredo-hook-dontUseHaredoBuild"></span> This behavior can be disabled by setting <code class="literal">dontUseHaredoBuild</code> to <code class="literal">true</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="haredo-hook-checkPhase" class="title" ><code class="literal">checkPhase</code>   </h3>  </div> </div></div><p>This phase searches for the <code class="literal">check.do</code> or <code class="literal">test.do</code> targets, running them if they exist.</p><p><span id="haredo-hook-haredoCheckTargets"></span> Targets can be explicitly set by adding a string to the <code class="literal">haredoCheckTargets</code> list.</p><p><span id="haredo-hook-dontUseHaredoCheck"></span> This behavior can be disabled by setting <code class="literal">dontUseHaredoCheck</code> to <code class="literal">true</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="haredo-hook-installPhase" class="title" ><code class="literal">installPhase</code>   </h3>  </div> </div></div><p>This phase attempts to build the <code class="literal">install.do</code> target, if it exists.</p><p><span id="haredo-hook-haredoInstallTargets"></span> Targets can be explicitly set by adding a string to the <code class="literal">haredoInstallTargets</code> list.</p><p><span id="haredo-hook-dontUseHaredoInstall"></span> This behavior can be disabled by setting <code class="literal">dontUseHaredoInstall</code> to <code class="literal">true</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="installshellfiles" class="title" style="clear: both"><code class="literal">installShellFiles</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#installshellfiles-installbin"><code class="literal">installBin</code></a> </span></dt><dt> <span class="section">  <a href="index.html#installshellfiles-installmanpage"><code class="literal">installManPage</code></a> </span></dt><dt> <span class="section">  <a href="index.html#installshellfiles-installshellcompletion"><code class="literal">installShellCompletion</code></a> </span></dt> </dl></div><p>This hook adds helpers that install artifacts like executable files, manpages
and shell completions.</p><p>It exposes the following functions that can be used from your <code class="literal">postInstall</code>
hook:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="installshellfiles-installbin" class="title" ><code class="literal">installBin</code>   </h3>  </div> </div></div><p>The <code class="literal">installBin</code> function takes one or more paths to files to install as
executable files.</p><p>This function will place them into <a class="link" href="index.html#outputbin" title="$outputBin" ><code class="literal">outputBin</code></a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="installshellfiles-installbin-exampleusage" class="title" >Example Usage   </h4>  </div> </div></div><pre><code class="programlisting nix">{
  nativeBuildInputs = [ installShellFiles ];

  # Sometimes the file has an undersirable name. It should be renamed before
  # being installed via installBin
  postInstall = &#x27;&#x27;
    mv a.out delmar
    installBin foobar delmar
  &#x27;&#x27;;
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="installshellfiles-installmanpage" class="title" ><code class="literal">installManPage</code>   </h3>  </div> </div></div><p>The <code class="literal">installManPage</code> function takes one or more paths to manpages to install.</p><p>The manpages must have a section suffix, and may optionally be compressed (with
<code class="literal">.gz</code> suffix). This function will place them into the correct
<code class="literal">share/man/man&lt;section&gt;/</code> directory in <a class="link" href="index.html#outputman" title="$outputMan" ><code class="literal">outputMan</code></a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="installshellfiles-installmanpage-exampleusage" class="title" >Example Usage   </h4>  </div> </div></div><pre><code class="programlisting nix">{
  nativeBuildInputs = [ installShellFiles ];

  # Sometimes the manpage file has an undersirable name; e.g. it conflicts with
  # another software with an equal name. It should be renamed before being
  # installed via installManPage
  postInstall = &#x27;&#x27;
    mv fromsea.3 delmar.3
    installManPage foobar.1 delmar.3
  &#x27;&#x27;;
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="installshellfiles-installshellcompletion" class="title" ><code class="literal">installShellCompletion</code>   </h3>  </div> </div></div><p>The <code class="literal">installShellCompletion</code> function takes one or more paths to shell
completion files.</p><p>By default it will autodetect the shell type from the completion file extension,
but you may also specify it by passing one of <code class="literal">--bash</code>, <code class="literal">--fish</code>, or
<code class="literal">--zsh</code>. These flags apply to all paths listed after them (up until another
shell flag is given). Each path may also have a custom installation name
provided by providing a flag <code class="literal">--name NAME</code> before the path. If this flag is not
provided, zsh completions will be renamed automatically such that <code class="literal">foobar.zsh</code>
becomes <code class="literal">_foobar</code>. A root name may be provided for all paths using the flag
<code class="literal">--cmd NAME</code>; this synthesizes the appropriate name depending on the shell
(e.g. <code class="literal">--cmd foo</code> will synthesize the name <code class="literal">foo.bash</code> for bash and <code class="literal">_foo</code> for
zsh).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="installshellfiles-installshellcompletion-exampleusage" class="title" >Example Usage   </h4>  </div> </div></div><pre><code class="programlisting nix">{
  nativeBuildInputs = [ installShellFiles ];
  postInstall = &#x27;&#x27;
    # explicit behavior
    installShellCompletion --bash --name foobar.bash share/completions.bash
    installShellCompletion --fish --name foobar.fish share/completions.fish
    installShellCompletion --zsh --name _foobar share/completions.zsh
    # implicit behavior
    installShellCompletion share/completions/foobar.{bash,fish,zsh}
  &#x27;&#x27;;
}
</code></pre><p>The path may also be the result of process substitution (e.g. <code class="literal">&lt;(cmd)</code>), in which
case the shell and name must be provided (see below).</p><p>If the destination shell completion file is not actually present or consists of
zero bytes after calling <code class="literal">installShellCompletion</code> this is treated as a build
failure. In particular, if completion files are not vendored but are generated
by running an executable, this is likely to fail in cross compilation
scenarios. The result will be a zero byte completion file and hence a build
failure. To prevent this, guard the completion generation commands.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="installshellfiles-installshellcompletion-exampleusage-guarded" class="title" >Example Usage   </h4>  </div> </div></div><pre><code class="programlisting nix">{
  nativeBuildInputs = [ installShellFiles ];
  postInstall = lib.optionalString (stdenv.buildPlatform.canExecute stdenv.hostPlatform) &#x27;&#x27;
    # using process substitution
    installShellCompletion --cmd foobar \
      --bash &lt;($out/bin/foobar --bash-completion) \
      --fish &lt;($out/bin/foobar --fish-completion) \
      --zsh &lt;($out/bin/foobar --zsh-completion)
  &#x27;&#x27;;
}
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="just-hook" class="title" style="clear: both"><code class="literal">just</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#just-hook-buildPhase"><code class="literal">buildPhase</code></a> </span></dt><dt> <span class="section">  <a href="index.html#just-hook-checkPhase"><code class="literal">checkPhase</code></a> </span></dt><dt> <span class="section">  <a href="index.html#just-hook-installPhase"><code class="literal">installPhase</code></a> </span></dt> </dl></div><p>This setup hook attempts to use <a class="link" href="https://just.systems/man/en/"  target="_top">the <code class="literal">just</code> command runner</a> to build, check, and install the package. The hook overrides <code class="literal">buildPhase</code>, <code class="literal">checkPhase</code>, and <code class="literal">installPhase</code> by default.</p><p><span id="just-hook-justFlags"></span> The <code class="literal">justFlags</code> variable can be set to a list of strings to add additional flags passed to all invocations of <code class="literal">just</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="just-hook-buildPhase" class="title" ><code class="literal">buildPhase</code>   </h3>  </div> </div></div><p>This phase attempts to invoke <code class="literal">just</code> with <a class="link" href="https://just.systems/man/en/the-default-recipe.html"  target="_top">the default recipe</a>.</p><p><span id="just-hook-dontUseJustBuild"></span> This behavior can be disabled by setting <code class="literal">dontUseJustBuild</code> to <code class="literal">true</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="just-hook-checkPhase" class="title" ><code class="literal">checkPhase</code>   </h3>  </div> </div></div><p>This phase attempts to invoke the <code class="literal">just test</code> recipe, if it is available. This can be overrided by setting <code class="literal">checkTarget</code> to a string.</p><p><span id="just-hook-dontUseJustCheck"></span> This behavior can be disabled by setting <code class="literal">dontUseJustCheck</code> to <code class="literal">true</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="just-hook-installPhase" class="title" ><code class="literal">installPhase</code>   </h3>  </div> </div></div><p>This phase attempts to invoke the <code class="literal">just install</code> recipe.</p><p><span id="just-hook-dontUseJustInstall"></span> This behavior can be disabled by setting <code class="literal">dontUseJustInstall</code> to <code class="literal">true</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="libiconv-libintl" class="title" style="clear: both">libiconv, libintl   </h2>  </div> </div></div><p>A few libraries automatically add to <code class="literal">NIX_LDFLAGS</code> their library, making their symbols automatically available to the linker. This includes libiconv and libintl (gettext). This is done to provide compatibility between GNU Linux, where libiconv and libintl are bundled in, and other systems where that might not be the case. Sometimes, this behavior is not desired. To disable this behavior, set <code class="literal">dontAddExtraLibs</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="setup-hook-libxml2" class="title" style="clear: both">libxml2   </h2>  </div> </div></div><p>Adds every file named <code class="literal">catalog.xml</code> found under the <code class="literal">xml/dtd</code> and <code class="literal">xml/xsl</code> subdirectories of each build input to the <code class="literal">XML_CATALOG_FILES</code> environment variable.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="meson" class="title" style="clear: both">Meson   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#meson-variables-controlling">Variables controlling Meson</a> </span></dt> </dl></div><p><a class="link" href="https://mesonbuild.com/"  target="_top">Meson</a> is an open source meta build system meant to be
fast and user-friendly.</p><p>In Nixpkgs, meson comes with a setup hook that overrides the configure, check,
and install phases.</p><p>Being a meta build system, meson needs an accompanying backend. In the context
of Nixpkgs, the typical companion backend is <a class="link" href="index.html#ninja" title="ninja" >Ninja</a>, that provides a
setup hook registering ninja-based build and install phases.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="meson-variables-controlling" class="title" >Variables controlling Meson   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="meson-exclusive-variables" class="title" >Meson Exclusive Variables   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="meson-flags" class="title" ><code class="literal">mesonFlags</code>   </h5>  </div> </div></div><p>Controls the flags passed to <code class="literal">meson setup</code> during configure phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="meson-build-dir" class="title" ><code class="literal">mesonBuildDir</code>   </h5>  </div> </div></div><p>Directory where Meson will put intermediate files.</p><p>Setting this can be useful for debugging multiple Meson builds while in the same source directory, for example, when building for different platforms.
Different values for each build will prevent build artefacts from interefering with each other.
This setting has no tangible effect when running the build in a sandboxed derivation.</p><p>The default value is <code class="literal">build</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="meson-wrap-mode" class="title" ><code class="literal">mesonWrapMode</code>   </h5>  </div> </div></div><p>Which value is passed as
<a class="link" href="https://mesonbuild.com/Builtin-options.html#core-options"  target="_top"><code class="literal">-Dwrap_mode=</code></a>
to. In Nixpkgs the default value is <code class="literal">nodownload</code>, so that no subproject will be
downloaded (since network access is already disabled during deployment in
Nixpkgs).</p><p>Note: Meson allows pre-population of subprojects that would otherwise be
downloaded.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="meson-build-type" class="title" ><code class="literal">mesonBuildType</code>   </h5>  </div> </div></div><p>Which value is passed as
<a class="link" href="https://mesonbuild.com/Builtin-options.html#core-options"  target="_top"><code class="literal">--buildtype</code></a> to
<code class="literal">meson setup</code> during configure phase. In Nixpkgs the default value is <code class="literal">plain</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="meson-auto-features" class="title" ><code class="literal">mesonAutoFeatures</code>   </h5>  </div> </div></div><p>Which value is passed as
<a class="link" href="https://mesonbuild.com/Builtin-options.html#core-options"  target="_top"><code class="literal">-Dauto_features=</code></a>
to <code class="literal">meson setup</code> during configure phase. In Nixpkgs the default value is
<code class="literal">enabled</code>, meaning that every feature declared as “auto” by the meson scripts
will be enabled.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="meson-check-flags" class="title" ><code class="literal">mesonCheckFlags</code>   </h5>  </div> </div></div><p>Controls the flags passed to <code class="literal">meson test</code> during check phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="meson-install-flags" class="title" ><code class="literal">mesonInstallFlags</code>   </h5>  </div> </div></div><p>Controls the flags passed to <code class="literal">meson install</code> during install phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="meson-install-tags" class="title" ><code class="literal">mesonInstallTags</code>   </h5>  </div> </div></div><p>A list of installation tags passed to Meson’s commandline option
<a class="link" href="https://mesonbuild.com/Installing.html#installation-tags"  target="_top"><code class="literal">--tags</code></a> during
install phase.</p><p>Note: <code class="literal">mesonInstallTags</code> should be a list of strings, that will be converted to
a comma-separated string that is recognized to <code class="literal">--tags</code>.
Example: <code class="literal">mesonInstallTags = [ &quot;emulator&quot; &quot;assembler&quot; ];</code> will be converted to
<code class="literal">--tags emulator,assembler</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-use-meson-configure" class="title" ><code class="literal">dontUseMesonConfigure</code>   </h5>  </div> </div></div><p>When set to true, don’t use the predefined <code class="literal">mesonConfigurePhase</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-use-meson-check" class="title" ><code class="literal">dontUseMesonCheck</code>   </h5>  </div> </div></div><p>When set to true, don’t use the predefined <code class="literal">mesonCheckPhase</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-use-meson-install" class="title" ><code class="literal">dontUseMesonInstall</code>   </h5>  </div> </div></div><p>When set to true, don’t use the predefined <code class="literal">mesonInstallPhase</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="meson-honored-variables" class="title" >Honored variables   </h4>  </div> </div></div><p>The following variables commonly used by <code class="literal">stdenv.mkDerivation</code> are honored by
Meson setup hook.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">prefixKey</code></p></li><li class="listitem"><p><code class="literal">enableParallelBuilding</code></p></li><li class="listitem"><p><code class="literal">enableParallelChecking</code></p></li></ul></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="setup-hook-mpi-check" class="title" style="clear: both">mpiCheckPhaseHook   </h2>  </div> </div></div><p>This hook can be used to setup a check phase that
requires running a MPI application. It detects the
used present MPI implementation type and exports
the neceesary environment variables to use
<code class="literal">mpirun</code> and <code class="literal">mpiexec</code> in a Nix sandbox.</p><p>Example:</p><pre><code class="programlisting nix">{ mpiCheckPhaseHook, mpi, ... }:
{
  # ...

  nativeCheckInputs = [
    openssh
    mpiCheckPhaseHook
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ninja" class="title" style="clear: both">ninja   </h2>  </div> </div></div><p>Overrides the build, install, and check phase to run ninja instead of make. You can disable this behavior with the <code class="literal">dontUseNinjaBuild</code>, <code class="literal">dontUseNinjaInstall</code>, and <code class="literal">dontUseNinjaCheck</code>, respectively. Parallel building is enabled by default in Ninja.</p><p>Note that if the <a class="link" href="index.html#meson" title="Meson" >Meson setup hook</a> is also active, Ninja’s install and check phases will be disabled in favor of Meson’s.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-patchRcPathHooks" class="title" style="clear: both"><code class="literal">patchRcPath</code> hooks   </h2>  </div> </div></div><p>These hooks provide shell-specific utilities (with the same name as the hook) to patch shell scripts meant to be sourced by software users.</p><p>The typical usage is to patch initialisation or <a class="link" href="https://unix.stackexchange.com/questions/3467/what-does-rc-in-bashrc-stand-for"  target="_top">rc</a> scripts inside <code class="literal">$out/bin</code> or <code class="literal">$out/etc</code>.
Such scripts, when being sourced, would insert the binary locations of certain commands into <code class="literal">PATH</code>, modify other environment variables or run a series of start-up commands.
When shipped from the upstream, they sometimes use commands that might not be available in the environment they are getting sourced in.</p><p>The compatible shells for each hook are:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">patchRcPathBash</code>: <a class="link" href="https://www.gnu.org/software/bash/"  target="_top">Bash</a>, <a class="link" href="http://www.kornshell.org/"  target="_top">ksh</a>, <a class="link" href="https://www.zsh.org/"  target="_top">zsh</a> and other shells supporting the Bash-like parameter expansions.</p></li><li class="listitem"><p><code class="literal">patchRcPathCsh</code>: Csh scripts, such as those targeting <a class="link" href="https://www.tcsh.org/"  target="_top">tcsh</a>.</p></li><li class="listitem"><p><code class="literal">patchRcPathFish</code>: <a class="link" href="https://fishshell.com/"  target="_top">Fish</a> scripts.</p></li><li class="listitem"><p><code class="literal">patchRcPathPosix</code>: POSIX-conformant shells supporting the limited parameter expansions specified by the POSIX standard. Current implementation uses the parameter expansion <code class="literal">${foo-}</code> only.</p></li></ul></div><p>For each supported shell, it modifies the script with a <code class="literal">PATH</code> prefix that is later removed when the script ends.
It allows nested patching, which guarantees that a patched script may source another patched script.</p><p>Syntax to apply the utility to a script:</p><pre><code class="programlisting sh">patchRcPath&lt;shell&gt; &lt;file&gt; &lt;PATH-prefix&gt;
</code></pre><p>Example usage:</p><p>Given a package <code class="literal">foo</code> containing an init script <code class="literal">this-foo.fish</code> that depends on <code class="literal">coreutils</code>, <code class="literal">man</code> and <code class="literal">which</code>,
patch the init script for users to source without having the above dependencies in their <code class="literal">PATH</code>:</p><pre><code class="programlisting nix">{
  lib,
  stdenv,
  patchRcPathFish,
}:
stdenv.mkDerivation {

  # ...

  nativeBuildInputs = [ patchRcPathFish ];

  postFixup = &#x27;&#x27;
    patchRcPathFish $out/bin/this-foo.fish ${
      lib.makeBinPath [
        coreutils
        man
        which
      ]
    }
  &#x27;&#x27;;
}
</code></pre><div class="note"><h3 class="title">Note</h3><p><code class="literal">patchRcPathCsh</code> and <code class="literal">patchRcPathPosix</code> implementation depends on <code class="literal">sed</code> to do the string processing.
The others are in vanilla shell and have no third-party dependencies.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="setup-hook-perl" class="title" style="clear: both">Perl   </h2>  </div> </div></div><p>Adds the <code class="literal">lib/site_perl</code> subdirectory of each build input to the <code class="literal">PERL5LIB</code> environment variable. For instance, if <code class="literal">buildInputs</code> contains Perl, then the <code class="literal">lib/site_perl</code> subdirectory of each input is added to the <code class="literal">PERL5LIB</code> environment variable.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="setup-hook-pkg-config" class="title" style="clear: both">pkg-config   </h2>  </div> </div></div><p>Adds the <code class="literal">lib/pkgconfig</code> and <code class="literal">share/pkgconfig</code> subdirectories of each build input to the <code class="literal">PKG_CONFIG_PATH</code> environment variable.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-postgresqlTestHook" class="title" style="clear: both"><code class="literal">postgresqlTestHook</code>   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-postgresqlTestHook-variables">Variables</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-postgresqlTestHook-hooks">Hooks</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-postgresqlTestHook-tcp">TCP and the Nix sandbox</a> </span></dt> </dl></div><p>This hook starts a PostgreSQL server during the <code class="literal">checkPhase</code>. Example:</p><pre><code class="programlisting nix">{
  stdenv,
  postgresql,
  postgresqlTestHook,
}:
stdenv.mkDerivation {

  # ...

  nativeCheckInputs = [
    postgresql
    postgresqlTestHook
  ];
}
</code></pre><p>If you use a custom <code class="literal">checkPhase</code>, remember to add the <code class="literal">runHook</code> calls:</p><pre><code class="programlisting nix">checkPhase &#x27;&#x27;
  runHook preCheck

  # ... your tests

  runHook postCheck
&#x27;&#x27;
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-postgresqlTestHook-variables" class="title" >Variables   </h3>  </div> </div></div><p>The hook logic will read a number of variables and set them to a default value if unset or empty.</p><p>Exported variables:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">PGDATA</code>: location of server files.</p></li><li class="listitem"><p><code class="literal">PGHOST</code>: location of UNIX domain socket directory; the default <code class="literal">host</code> in a connection string.</p></li><li class="listitem"><p><code class="literal">PGUSER</code>: user to create / log in with, default: <code class="literal">test_user</code>.</p></li><li class="listitem"><p><code class="literal">PGDATABASE</code>: database name, default: <code class="literal">test_db</code>.</p></li></ul></div><p>Bash-only variables:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">postgresqlTestUserOptions</code>: SQL options to use when creating the <code class="literal">$PGUSER</code> role, default: <code class="literal">&quot;LOGIN&quot;</code>. Example: <code class="literal">&quot;LOGIN SUPERUSER&quot;</code></p></li><li class="listitem"><p><code class="literal">postgresqlTestSetupSQL</code>: SQL commands to run as database administrator after startup, default: statements that create <code class="literal">$PGUSER</code> and <code class="literal">$PGDATABASE</code>.</p></li><li class="listitem"><p><code class="literal">postgresqlTestSetupCommands</code>: bash commands to run after database start, defaults to running <code class="literal">$postgresqlTestSetupSQL</code> as database administrator.</p></li><li class="listitem"><p><code class="literal">postgresqlEnableTCP</code>: set to <code class="literal">1</code> to enable TCP listening. Flaky; not recommended.</p></li><li class="listitem"><p><code class="literal">postgresqlStartCommands</code>: defaults to <code class="literal">pg_ctl start</code>.</p></li><li class="listitem"><p><code class="literal">postgresqlExtraSettings</code>: Additional configuration to add to <code class="literal">postgresql.conf</code></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-postgresqlTestHook-hooks" class="title" >Hooks   </h3>  </div> </div></div><p>A number of additional hooks are ran in postgresqlTestHook</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">postgresqlTestSetupPost</code>: ran after postgresql has been set up.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-postgresqlTestHook-tcp" class="title" >TCP and the Nix sandbox   </h3>  </div> </div></div><p><code class="literal">postgresqlEnableTCP</code> relies on network sandboxing, which is not available on macOS and some custom Nix installations, resulting in flaky tests.
For this reason, it is disabled by default.</p><p>The preferred solution is to make the test suite use a UNIX domain socket connection. This is the default behavior when no <code class="literal">host</code> connection parameter is provided.
Some test suites hardcode a value for <code class="literal">host</code> though, so a patch may be required. If you can upstream the patch, you can make <code class="literal">host</code> default to the <code class="literal">PGHOST</code> environment variable when set. Otherwise, you can patch it locally to omit the <code class="literal">host</code> connection string parameter altogether.</p><div class="note"><h3 class="title">Note</h3><p>The error <code class="literal">libpq: failed (could not receive data from server: Connection refused</code> is generally an indication that the test suite is trying to connect through TCP.</p></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="premake-hook" class="title" style="clear: both">Premake   </h2>  </div> </div></div><p>This setup hook attempts to configure the package using <a class="link" href="https://premake.github.io/"  target="_top">the Premake build configuration system</a>. It overrides the <code class="literal">configurePhase</code> by default, if none exists.</p><p><span id="premake-hook-premakefile"></span> The Premakefile to use can be specified by setting <code class="literal">premakefile</code> in the derivation.</p><p><span id="premake-hook-premakeFlagsArray"></span> The flags passed to Premake can be configured by adding strings to the <code class="literal">premakeFlags</code> list.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="setup-hook-python" class="title" style="clear: both">Python   </h2>  </div> </div></div><p>Adds the <code class="literal">python.sitePackages</code> subdirectory (i.e. <code class="literal">lib/pythonX.Y/site-packages</code>) of each build input to the <code class="literal">PYTHONPATH</code> environment variable.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="scons" class="title" style="clear: both">scons   </h2>  </div> </div></div><p>Overrides the build, install, and check phases. This uses the scons build system as a replacement for make. scons does not provide a configure phase, so everything is managed at build and install time.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tauri-hook" class="title" style="clear: both">cargo-tauri.hook   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#tauri-hook-example-code-snippet">Example code snippet</a> </span></dt><dt> <span class="section">  <a href="index.html#tauri-hook-variables-controlling">Variables controlling cargo-tauri</a> </span></dt> </dl></div><p><a class="link" href="https://tauri.app/"  target="_top">Tauri</a> is a framework for building smaller, faster, and
more secure desktop applications with a web frontend.</p><p>In Nixpkgs, <code class="literal">cargo-tauri.hook</code> overrides the default build and install phases.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tauri-hook-example-code-snippet" class="title" >Example code snippet   </h3>  </div> </div></div><pre><code class="programlisting nix">{
  lib,
  stdenv,
  rustPlatform,
  fetchNpmDeps,
  cargo-tauri,
  glib-networking,
  nodejs,
  npmHooks,
  openssl,
  pkg-config,
  webkitgtk_4_1,
  wrapGAppsHook4,
}:

rustPlatform.buildRustPackage (finalAttrs: {
  # ...

  cargoHash = &quot;...&quot;;

  # Assuming our app&#x27;s frontend uses `npm` as a package manager
  npmDeps = fetchNpmDeps {
    name = &quot;${finalAttrs.pname}-${finalAttrs.version}-npm-deps&quot;;
    inherit (finalAttrs) src;
    hash = &quot;...&quot;;
  };

  nativeBuildInputs = [
    # Pull in our main hook
    cargo-tauri.hook

    # Setup npm
    nodejs
    npmHooks.npmConfigHook

    # Make sure we can find our libraries
    pkg-config
  ]
  ++ lib.optionals stdenv.hostPlatform.isLinux [ wrapGAppsHook4 ];

  buildInputs = lib.optionals stdenv.hostPlatform.isLinux [
    glib-networking # Most Tauri apps need networking
    openssl
    webkitgtk_4_1
  ];

  # Set our Tauri source directory
  cargoRoot = &quot;src-tauri&quot;;
  # And make sure we build there too
  buildAndTestSubdir = finalAttrs.cargoRoot;

  # ...
})
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="tauri-hook-variables-controlling" class="title" >Variables controlling cargo-tauri   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="tauri-hook-exclusive-variables" class="title" >Tauri Exclusive Variables   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="tauri-build-flags" class="title" ><code class="literal">tauriBuildFlags</code>   </h5>  </div> </div></div><p>Controls the flags passed to <code class="literal">cargo tauri build</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="tauri-bundle-type" class="title" ><code class="literal">tauriBundleType</code>   </h5>  </div> </div></div><p>The <a class="link" href="https://tauri.app/v1/guides/building/"  target="_top">bundle type</a> to build.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-tauri-build" class="title" ><code class="literal">dontTauriBuild</code>   </h5>  </div> </div></div><p>Disables using <code class="literal">tauriBuildHook</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-tauri-install" class="title" ><code class="literal">dontTauriInstall</code>   </h5>  </div> </div></div><p>Disables using <code class="literal">tauriInstallPostBuildHook</code> and <code class="literal">tauriInstallHook</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="tauri-hook-honored-variables" class="title" >Honored Variables   </h4>  </div> </div></div><p>Along with those found in <a class="xref" href="index.html#compiling-rust-applications-with-cargo" title="buildRustPackage: Compiling Rust applications with Cargo" >the section called “<code class="literal">buildRustPackage</code>: Compiling Rust applications with Cargo”</a>, the
following variables used by <code class="literal">cargoBuildHook</code> and <code class="literal">cargoInstallHook</code> are honored
by the cargo-tauri setup hook.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">buildAndTestSubdir</code></p></li><li class="listitem"><p><code class="literal">cargoBuildType</code></p></li><li class="listitem"><p><code class="literal">cargoBuildNoDefaultFeatures</code></p></li><li class="listitem"><p><code class="literal">cargoBuildFeatures</code></p></li></ul></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="tetex-tex-live" class="title" style="clear: both">teTeX / TeX Live   </h2>  </div> </div></div><p>Adds the <code class="literal">share/texmf-nix</code> subdirectory of each build input to the <code class="literal">TEXINPUTS</code> environment variable.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="udevcheckhook" class="title" style="clear: both">udevCheckHook   </h2>  </div> </div></div><p>The <code class="literal">udevCheckHook</code> derivation adds <code class="literal">udevCheckPhase</code> to the <a class="link" href="index.html#ssec-installCheck-phase" title="The installCheck phase" ><code class="literal">preInstallCheckHooks</code></a>,
which finds all udev rules in all outputs and verifies them using <code class="literal">udevadm verify --resolve-names=never --no-style</code>.
It should be used in any package that has udev rules outputs to ensure the rules are and stay valid.</p><p>The hook runs in <code class="literal">installCheckPhase</code>, requiring <code class="literal">doInstallCheck</code> is enabled for the hook to take effect:</p><pre><code class="programlisting nix">{
  lib,
  stdenv,
  udevCheckHook,
# ...
}:

stdenv.mkDerivation (finalAttrs: {
  # ...

  nativeInstallCheckInputs = [ udevCheckHook ];
  doInstallCheck = true;

  # ...
})
</code></pre><p>Note that for <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> and <a class="link" href="index.html#buildpythonapplication-function" title="buildPythonApplication function" ><code class="literal">buildPythonApplication</code></a>, <code class="literal">doInstallCheck</code> is enabled by default.</p><p>All outputs are scanned for their <code class="literal">/{etc,lib}/udev/rules.d</code> paths.
If no rule output is found, the hook is basically a no-op.</p><p>The <code class="literal">udevCheckHook</code> adds a dependency on <code class="literal">systemdMinimal</code>.
It is internally guarded behind <code class="literal">hostPlatform</code> supporting udev and <code class="literal">buildPlatform</code> being able to execute <code class="literal">udevadm</code>.
The hook does not need explicit platform checks in the places where it is used.</p><p>The hook can be disabled using <code class="literal">dontUdevCheck</code>, which is necessary if you want to run some different task in <code class="literal">installCheckPhase</code> on a package with broken udev rule outputs.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="unzip" class="title" style="clear: both">unzip   </h2>  </div> </div></div><p>This setup hook will allow you to unzip .zip files specified in <code class="literal">$src</code>. There are many similar packages like <code class="literal">unrar</code>, <code class="literal">undmg</code>, etc.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="validatepkgconfig" class="title" style="clear: both">validatePkgConfig   </h2>  </div> </div></div><p>The <code class="literal">validatePkgConfig</code> hook validates all pkg-config (<code class="literal">.pc</code>) files in a package. This helps catching some common errors in pkg-config files, such as undefined variables.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="versioncheckhook" class="title" style="clear: both">versionCheckHook   </h2>  </div> </div></div><p>This hook adds a <code class="literal">versionCheckPhase</code> to the <a class="link" href="index.html#ssec-installCheck-phase" title="The installCheck phase" ><code class="literal">preInstallCheckHooks</code></a> that runs the main program of the derivation with a <code class="literal">--help</code> or <code class="literal">--version</code> argument, and checks that the <code class="literal">${version}</code> string is found in that output. If this check fails then the whole build will fail. <span class="emphasis"><em>(A softer option is <a class="link" href="index.html#tester-testVersion" title="testVersion" ><code class="literal">testers.testVersion</code></a>.)</em></span></p><p>You use it like this:</p><pre><code class="programlisting nix">{
  lib,
  stdenv,
  versionCheckHook,
# ...
}:

stdenv.mkDerivation (finalAttrs: {
  # ...

  nativeInstallCheckInputs = [ versionCheckHook ];
  doInstallCheck = true;

  # ...
})
</code></pre><p>Note that for <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> and <a class="link" href="index.html#buildpythonapplication-function" title="buildPythonApplication function" ><code class="literal">buildPythonApplication</code></a>, <code class="literal">doInstallCheck</code> is enabled by default.</p><p>It does so in a clean environment (using <code class="literal">env --ignore-environment</code>), and it checks for the <code class="literal">${version}</code> string in both the <code class="literal">stdout</code> and the <code class="literal">stderr</code> of the command. It will report to you in the build log the output it received and it will fail the build if it failed to find <code class="literal">${version}</code>.</p><p>The variables that this phase control are:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">dontVersionCheck</code>: Disable adding this hook to the <a class="link" href="index.html#ssec-installCheck-phase" title="The installCheck phase" ><code class="literal">preInstallCheckHooks</code></a>. Useful if you do want to load the bash functions of the hook, but run them differently.</p></li><li class="listitem"><p><code class="literal">versionCheckProgram</code>: The full path to the program that should print the <code class="literal">${version}</code> string. Defaults to using the first non-empty value <code class="literal">$binary</code> out of <code class="literal">${NIX_MAIN_PROGRAM}</code> and <code class="literal">${pname}</code>, in that order, to build roughly <code class="literal">${placeholder &quot;out&quot;}/bin/$binary</code>. <code class="literal">${NIX_MAIN_PROGRAM}</code>&#x27;s value comes from <code class="literal">meta.mainProgram</code>, and does not normally need to be set explicitly. When setting <code class="literal">versionCheckProgram</code>, using <code class="literal">$out</code> directly won’t work, as environment variables from this variable are not expanded by the hook. Hence using <code class="literal">placeholder &quot;out&quot;</code> is unavoidable.</p></li><li class="listitem"><p><code class="literal">versionCheckProgramArg</code>: The argument that needs to be passed to <code class="literal">versionCheckProgram</code>. If undefined the hook tries first <code class="literal">--help</code> and then <code class="literal">--version</code>. Examples: <code class="literal">version</code>, <code class="literal">-V</code>, <code class="literal">-v</code>.</p></li><li class="listitem"><p><code class="literal">versionCheckKeepEnvironment</code>: A list of environment variables to keep and pass to the command. Only those variables should be added to this list that are actually required for the version command to work. If it is not feasible to explicitly list all these environment variables you can set this parameter to the special value <code class="literal">&quot;*&quot;</code> to disable the <code class="literal">--ignore-environment</code> flag and thus keep all environment variables.</p></li><li class="listitem"><p><code class="literal">preVersionCheck</code>: A hook to run before the check is done.</p></li><li class="listitem"><p><code class="literal">postVersionCheck</code>: A hook to run after the check is done.</p></li></ul></div><p>This check assumes the executable is <span class="emphasis"><em>hermetic</em></span>. If environment variables such as <code class="literal">PATH</code> or <code class="literal">HOME</code> are required for the program to function, then <a class="link" href="index.html#tester-testVersion" title="testVersion" ><code class="literal">testers.testVersion</code></a> is currently the better alternative.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="waf-hook" class="title" style="clear: both">wafHook   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#waf-hook-variables-controlling">Variables controlling wafHook</a> </span></dt> </dl></div><p><a class="link" href="https://waf.io"  target="_top">Waf</a> is a Python-based software building system.</p><p>In Nixpkgs, <code class="literal">wafHook</code> overrides the default configure, build, and install phases.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="waf-hook-variables-controlling" class="title" >Variables controlling wafHook   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="waf-hook-exclusive-variables" class="title" ><code class="literal">wafHook</code> Exclusive Variables   </h4>  </div> </div></div><p>The variables below are exclusive of <code class="literal">wafHook</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="waf-path" class="title" ><code class="literal">wafPath</code>   </h5>  </div> </div></div><p>Location of the <code class="literal">waf</code> tool. It defaults to <code class="literal">./waf</code>, to honor software projects that include it directly inside their source trees.</p><p>If the file pointed by <code class="literal">wafPath</code> doesn’t exist, then <code class="literal">waf</code> provided by Nixpkgs will be used.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="waf-flags" class="title" ><code class="literal">wafFlags</code>   </h5>  </div> </div></div><p>Controls the flags passed to waf tool during build and install phases. For settings specific to build or install phases, use <code class="literal">wafBuildFlags</code> or <code class="literal">wafInstallFlags</code> respectively.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-use-waf-configure" class="title" ><code class="literal">dontUseWafConfigure</code>   </h5>  </div> </div></div><p>When set to true, don’t use the predefined <code class="literal">wafConfigurePhase</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-use-waf-build" class="title" ><code class="literal">dontUseWafBuild</code>   </h5>  </div> </div></div><p>When set to true, don’t use the predefined <code class="literal">wafBuildPhase</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-use-waf-install" class="title" ><code class="literal">dontUseWafInstall</code>   </h5>  </div> </div></div><p>When set to true, don’t use the predefined <code class="literal">wafInstallPhase</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="waf-hook-similar-variables" class="title" >Similar variables   </h4>  </div> </div></div><p>The following variables are similar to their <code class="literal">stdenv.mkDerivation</code> counterparts.</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left"><code class="literal">wafHook</code> Variable</th><th align="left"><code class="literal">stdenv.mkDerivation</code> Counterpart</th></tr></thead><tbody><tr><td align="left"><code class="literal">wafConfigureFlags</code></td><td align="left"><code class="literal">configureFlags</code></td></tr><tr><td align="left"><code class="literal">wafConfigureTargets</code></td><td align="left"><code class="literal">configureTargets</code></td></tr><tr><td align="left"><code class="literal">wafBuildFlags</code></td><td align="left"><code class="literal">buildFlags</code></td></tr><tr><td align="left"><code class="literal">wafBuildTargets</code></td><td align="left"><code class="literal">buildTargets</code></td></tr><tr><td align="left"><code class="literal">wafInstallFlags</code></td><td align="left"><code class="literal">installFlags</code></td></tr><tr><td align="left"><code class="literal">wafInstallTargets</code></td><td align="left"><code class="literal">installTargets</code></td></tr></tbody></table></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="waf-hook-honored-variables" class="title" >Honored variables   </h4>  </div> </div></div><p>The following variables commonly used by <code class="literal">stdenv.mkDerivation</code> are honored by <code class="literal">wafHook</code>.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">prefixKey</code></p></li><li class="listitem"><p><code class="literal">enableParallelBuilding</code></p></li><li class="listitem"><p><code class="literal">enableParallelInstalling</code></p></li></ul></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="zig-hook" class="title" style="clear: both">zig.hook   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#zig-hook-example-code-snippet">Example code snippet</a> </span></dt><dt> <span class="section">  <a href="index.html#zig-hook-variables-controlling">Variables controlling zig.hook</a> </span></dt> </dl></div><p><a class="link" href="https://ziglang.org/"  target="_top">Zig</a> is a general-purpose programming language and toolchain for maintaining robust, optimal and reusable software.</p><p>In Nixpkgs, <code class="literal">zig.hook</code> overrides the default build, check and install phases.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="zig-hook-example-code-snippet" class="title" >Example code snippet   </h3>  </div> </div></div><pre><code class="programlisting nix">{
  lib,
  stdenv,
  zig,
}:

stdenv.mkDerivation {
  # . . .

  nativeBuildInputs = [ zig.hook ];

  zigBuildFlags = [ &quot;-Dman-pages=true&quot; ];

  dontUseZigCheck = true;

  # . . .
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="zig-hook-variables-controlling" class="title" >Variables controlling zig.hook   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="zig-hook-exclusive-variables" class="title" ><code class="literal">zig.hook</code> Exclusive Variables   </h4>  </div> </div></div><p>The variables below are exclusive to <code class="literal">zig.hook</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-use-zig-build" class="title" ><code class="literal">dontUseZigBuild</code>   </h5>  </div> </div></div><p>Disables using <code class="literal">zigBuildPhase</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-use-zig-check" class="title" ><code class="literal">dontUseZigCheck</code>   </h5>  </div> </div></div><p>Disables using <code class="literal">zigCheckPhase</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="dont-use-zig-install" class="title" ><code class="literal">dontUseZigInstall</code>   </h5>  </div> </div></div><p>Disables using <code class="literal">zigInstallPhase</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="zig-hook-similar-variables" class="title" >Similar variables   </h4>  </div> </div></div><p>The following variables are similar to their <code class="literal">stdenv.mkDerivation</code> counterparts.</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left"><code class="literal">zig.hook</code> Variable</th><th align="left"><code class="literal">stdenv.mkDerivation</code> Counterpart</th></tr></thead><tbody><tr><td align="left"><code class="literal">zigBuildFlags</code></td><td align="left"><code class="literal">buildFlags</code></td></tr><tr><td align="left"><code class="literal">zigCheckFlags</code></td><td align="left"><code class="literal">checkFlags</code></td></tr><tr><td align="left"><code class="literal">zigInstallFlags</code></td><td align="left"><code class="literal">installFlags</code></td></tr></tbody></table></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="zig-hook-variables-honored" class="title" >Variables honored by zig.hook   </h4>  </div> </div></div><p>The following variables commonly used by <code class="literal">stdenv.mkDerivation</code> are honored by <code class="literal">zig.hook</code>.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">prefixKey</code></p></li><li class="listitem"><p><code class="literal">dontAddPrefix</code></p></li></ul></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="xcbuildhook" class="title" style="clear: both">xcbuildHook   </h2>  </div> </div></div><p>Overrides the build and install phases to run the “xcbuild” command. This hook is needed when a project only comes with build files for the XCode build system. You can disable this behavior by setting buildPhase and configurePhase to a custom value. xcbuildFlags controls flags passed only to xcbuild.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="xfce4-dev-tools" class="title" style="clear: both"><code class="literal">xfce.xfce4-dev-tools</code>   </h2>  </div> </div></div><p>This setup hook attempts to run <code class="literal">xdt-autogen</code> in <code class="literal">xdtAutogenPhase</code>, which is part of <code class="literal">preConfigurePhases</code>.</p><p><span id="dontUseXdtAutogenPhase"></span> This behavior can be disabled by setting <code class="literal">dontUseXdtAutogenPhase</code> to <code class="literal">true</code>.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-language-support" class="title" >Languages and frameworks   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#agda">Agda</a> </span></dt><dt> <span class="section">  <a href="index.html#android">Android</a> </span></dt><dt> <span class="section">  <a href="index.html#astal">Astal</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-beam">BEAM Languages (Erlang, Elixir &amp; LFE)</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-bower">Bower</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-chicken">CHICKEN</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-coq">Coq and coq packages</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-cosmic">COSMIC</a> </span></dt><dt> <span class="section">  <a href="index.html#crystal">Crystal</a> </span></dt><dt> <span class="section">  <a href="index.html#cuda">CUDA</a> </span></dt><dt> <span class="section">  <a href="index.html#cuelang">Cue (Cuelang)</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-dart">Dart</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-dhall">Dhall</a> </span></dt><dt> <span class="section">  <a href="index.html#dlang">D (Dlang)</a> </span></dt><dt> <span class="section">  <a href="index.html#dotnet">Dotnet</a> </span></dt><dt> <span class="section">  <a href="index.html#emscripten">Emscripten</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-factor">Factor</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-gnome">GNOME</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-go">Go</a> </span></dt><dt> <span class="section">  <a href="index.html#gradle">Gradle</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-hare">Hare</a> </span></dt><dt> <span class="section">  <a href="index.html#haskell">Haskell</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-hy">Hy</a> </span></dt><dt> <span class="section">  <a href="index.html#idris">Idris</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-idris2">Idris2</a> </span></dt><dt> <span class="section">  <a href="index.html#ios">iOS</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-java">Java</a> </span></dt><dt> <span class="section">  <a href="index.html#language-javascript">Javascript</a> </span></dt><dt> <span class="section">  <a href="index.html#language-julia">Julia</a> </span></dt><dt> <span class="section">  <a href="index.html#lisp">lisp-modules</a> </span></dt><dt> <span class="section">  <a href="index.html#lua">Lua</a> </span></dt><dt> <span class="section">  <a href="index.html#maven">Maven</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-nim">Nim</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-ocaml">OCaml</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-octave">Octave</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-perl">Perl</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-php">PHP</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkg-config">pkg-config</a> </span></dt><dt> <span class="section">  <a href="index.html#python">Python</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-qt">Qt</a> </span></dt><dt> <span class="section">  <a href="index.html#r">R</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-ruby">Ruby</a> </span></dt><dt> <span class="section">  <a href="index.html#rust">Rust</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-scheme">Scheme</a> </span></dt><dt> <span class="section">  <a href="index.html#swift">Swift</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-tcl">Tcl</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-texlive">TeX Live</a> </span></dt><dt> <span class="section">  <a href="index.html#typst">Typst</a> </span></dt><dt> <span class="section">  <a href="index.html#vim">Vim</a> </span></dt><dt> <span class="section">  <a href="index.html#neovim">Neovim</a> </span></dt> </dl></div><p>The <a class="link" href="index.html#chap-stdenv" title="The Standard Environment" >standard build environment</a> makes it easy to build typical Autotools-based packages with very little code. Any other kind of package can be accommodated by overriding the appropriate phases of <code class="literal">stdenv</code>. However, there are specialised functions in Nixpkgs to easily build packages for other programming languages, such as Perl or Haskell. These are described in this chapter.</p><p>Each supported language or software ecosystem has its own package set named <code class="literal">&lt;language or ecosystem&gt;Packages</code>, which can be explored in various ways:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Search on <a class="link" href="https://search.nixos.org/packages"  target="_top">search.nixos.org</a></p><p>For example, search for <a class="link" href="https://search.nixos.org/packages?query=haskellPackages"  target="_top"><code class="literal">haskellPackages</code></a> or <a class="link" href="https://search.nixos.org/packages?query=rubyPackages"  target="_top"><code class="literal">rubyPackages</code></a>.</p></li><li class="listitem"><p>Navigate attribute sets with <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-repl"  target="_top"><code class="literal">nix repl</code></a>.</p><p>This technique is generally useful to inspect Nix language data structures.</p><div class="example"><span id="example-navigte-nix-repl" ></span><details><summary><span class="title"><strong>Example 351. Navigate Java compiler variants in <code class="literal">javaPackages</code> with <code class="literal">nix repl</code></strong></span></summary><div class="example-contents"><pre><code class="programlisting shell-session">$ nix repl &#x27;&lt;nixpkgs&gt;&#x27; -I nixpkgs=channel:nixpkgs-unstable
nix-repl&gt; javaPackages.&lt;tab&gt;
javaPackages.compiler               javaPackages.openjfx15              javaPackages.openjfx21              javaPackages.recurseForDerivations
javaPackages.jogl_2_4_0             javaPackages.openjfx17              javaPackages.openjfx22
javaPackages.mavenfod               javaPackages.openjfx19              javaPackages.override
javaPackages.openjfx11              javaPackages.openjfx20              javaPackages.overrideDerivation
</code></pre></div></details></div><br class="example-break" /></li><li class="listitem"><p>List all derivations on the command line with <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/nix-env/query"  target="_top"><code class="literal">nix-env --query</code></a>.</p><p><code class="literal">nix-env</code> is the only convenient way to do that, as it will skip attributes that fail <a class="link" href="https://nixos.org/manual/nix/stable/language/constructs#assertions"  target="_top">assertions</a>, such as when a package is <a class="link" href="index.html#var-meta-broken" title="broken" >marked as broken</a>, rather than failing the entire evaluation.</p><div class="example"><span id="example-list-haskellPackages" ></span><details><summary><span class="title"><strong>Example 352. List all Python packages in Nixpkgs</strong></span></summary><div class="example-contents"><p>The following command lists all <a class="link" href="https://nixos.org/manual/nix/stable/language/derivations#attr-name"  target="_top">derivations names</a> with their attribute path from the latest Nixpkgs rolling release (<code class="literal">nixpkgs-unstable</code>).</p><pre><code class="programlisting shell-session">$ nix-env -qaP -f &#x27;&lt;nixpkgs&gt;&#x27; -A pythonPackages -I nixpkgs=channel:nixpkgs-unstable
</code></pre><pre><code class="programlisting console">pythonPackages.avahi                                                  avahi-0.8
pythonPackages.boost                                                  boost-1.81.0
pythonPackages.caffe                                                  caffe-1.0
pythonPackages.caffeWithCuda                                          caffe-1.0
pythonPackages.cbeams                                                 cbeams-1.0.3
…
</code></pre></div></details></div><br class="example-break" /></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="agda" class="title" style="clear: both">Agda   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#how-to-use-agda">How to use Agda</a> </span></dt><dt> <span class="section">  <a href="index.html#compiling-agda">Compiling Agda</a> </span></dt><dt> <span class="section">  <a href="index.html#writing-agda-packages">Writing Agda packages</a> </span></dt><dt> <span class="section">  <a href="index.html#maintaining-the-agda-package-set-on-nixpkgs">Maintaining the Agda package set on Nixpkgs</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="how-to-use-agda" class="title" >How to use Agda   </h3>  </div> </div></div><p>Agda is available as the <a class="link" href="https://search.nixos.org/packages?channel=unstable&amp;show=agda&amp;from=0&amp;size=30&amp;sort=relevance&amp;query=agda"  target="_top">agda</a>
package.</p><p>The <code class="literal">agda</code> package installs an Agda-wrapper, which calls <code class="literal">agda</code> with <code class="literal">--library-file</code>
set to a generated library-file within the nix store, this means your library-file in
<code class="literal">$HOME/.agda/libraries</code> will be ignored. By default the agda package installs Agda
with no libraries, i.e. the generated library-file is empty. To use Agda with libraries,
the <code class="literal">agda.withPackages</code> function can be used. This function either takes:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>A list of packages,</p></li><li class="listitem"><p>or a function which returns a list of packages when given the <code class="literal">agdaPackages</code> attribute set,</p></li><li class="listitem"><p>or an attribute set containing a list of packages and a GHC derivation for compilation (see below).</p></li><li class="listitem"><p>or an attribute set containing a function which returns a list of packages when given the <code class="literal">agdaPackages</code> attribute set and a GHC derivation for compilation (see below).</p></li></ul></div><p>For example, suppose we wanted a version of Agda which has access to the standard library. This can be obtained with the expressions:</p><pre><code class="programlisting nix">agda.withPackages [ agdaPackages.standard-library ]
</code></pre><p>or</p><pre><code class="programlisting nix">agda.withPackages (p: [ p.standard-library ])
</code></pre><p>or can be called as in the <a class="link" href="index.html#compiling-agda" title="Compiling Agda" >Compiling Agda</a> section.</p><p>If you want to use a different version of a library (for instance a development version)
override the <code class="literal">src</code> attribute of the package to point to your local repository</p><pre><code class="programlisting nix">agda.withPackages (p: [
  (p.standard-library.overrideAttrs (oldAttrs: {
    version = &quot;local version&quot;;
    src = /path/to/local/repo/agda-stdlib;
  }))
])
</code></pre><p>You can also reference a GitHub repository</p><pre><code class="programlisting nix">agda.withPackages (p: [
  (p.standard-library.overrideAttrs (oldAttrs: {
    version = &quot;1.5&quot;;
    src = fetchFromGitHub {
      repo = &quot;agda-stdlib&quot;;
      owner = &quot;agda&quot;;
      rev = &quot;v1.5&quot;;
      hash = &quot;sha256-nEyxYGSWIDNJqBfGpRDLiOAnlHJKEKAOMnIaqfVZzJk=&quot;;
    };
  }))
])
</code></pre><p>If you want to use a library not added to Nixpkgs, you can add a
dependency to a local library by calling <code class="literal">agdaPackages.mkDerivation</code>.</p><pre><code class="programlisting nix">agda.withPackages (p: [
  (p.mkDerivation {
    pname = &quot;your-agda-lib&quot;;
    version = &quot;1.0.0&quot;;
    src = /path/to/your-agda-lib;
  })
])
</code></pre><p>Again you can reference GitHub</p><pre><code class="programlisting nix">agda.withPackages (p: [
  (p.mkDerivation {
    pname = &quot;your-agda-lib&quot;;
    version = &quot;1.0.0&quot;;
    src = fetchFromGitHub {
      repo = &quot;repo&quot;;
      owner = &quot;owner&quot;;
      version = &quot;...&quot;;
      rev = &quot;...&quot;;
      hash = &quot;...&quot;;
    };
  })
])
</code></pre><p>See <a class="link" href="index.html#building-agda-packages" title="Building Agda packages" >Building Agda Packages</a> for more information on <code class="literal">mkDerivation</code>.</p><p>Agda will not by default use these libraries. To tell Agda to use a library we have some options:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Call <code class="literal">agda</code> with the library flag:</p><pre><code class="programlisting ShellSession">$ agda -l standard-library -i . MyFile.agda
</code></pre></li><li class="listitem"><p>Write a <code class="literal">my-library.agda-lib</code> file for the project you are working on which may look like:</p><pre><code class="programlisting">name: my-library
include: .
depend: standard-library
</code></pre></li><li class="listitem"><p>Create the file <code class="literal">~/.agda/defaults</code> and add any libraries you want to use by default.</p></li></ul></div><p>More information can be found in the <a class="link" href="https://agda.readthedocs.io/en/v2.6.1/tools/package-system.html"  target="_top">official Agda documentation on library management</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="compiling-agda" class="title" >Compiling Agda   </h3>  </div> </div></div><p>Agda modules can be compiled using the GHC backend with the <code class="literal">--compile</code> flag. A version of <code class="literal">ghc</code> with <code class="literal">ieee754</code> is made available to the Agda program via the <code class="literal">--with-compiler</code> flag.
This can be overridden by a different version of <code class="literal">ghc</code> as follows:</p><pre><code class="programlisting nix">agda.withPackages {
  pkgs = [
    # ...
  ];
  ghc = haskell.compiler.ghcHEAD;
}
</code></pre><p>To install Agda without GHC, use <code class="literal">ghc = null;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="writing-agda-packages" class="title" >Writing Agda packages   </h3>  </div> </div></div><p>To write a nix derivation for an Agda library, first check that the library has a <code class="literal">*.agda-lib</code> file.</p><p>A derivation can then be written using <code class="literal">agdaPackages.mkDerivation</code>. This has similar arguments to <code class="literal">stdenv.mkDerivation</code> with the following additions:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">everythingFile</code> can be used to specify the location of the <code class="literal">Everything.agda</code> file, defaulting to <code class="literal">./Everything.agda</code>. If this file does not exist then either it should be patched in or the <code class="literal">buildPhase</code> should be overridden (see below).</p></li><li class="listitem"><p><code class="literal">libraryName</code> should be the name that appears in the <code class="literal">*.agda-lib</code> file, defaulting to <code class="literal">pname</code>.</p></li><li class="listitem"><p><code class="literal">libraryFile</code> should be the file name of the <code class="literal">*.agda-lib</code> file, defaulting to <code class="literal">${libraryName}.agda-lib</code>.</p></li></ul></div><p>Here is an example <code class="literal">default.nix</code></p><pre><code class="programlisting nix">{
  nixpkgs ? &lt;nixpkgs&gt;,
}:
with (import nixpkgs { });
agdaPackages.mkDerivation {
  version = &quot;1.0&quot;;
  pname = &quot;my-agda-lib&quot;;
  src = ./.;
  buildInputs = [ agdaPackages.standard-library ];
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="building-agda-packages" class="title" >Building Agda packages   </h4>  </div> </div></div><p>The default build phase for <code class="literal">agdaPackages.mkDerivation</code> runs <code class="literal">agda</code> on the <code class="literal">Everything.agda</code> file.
If something else is needed to build the package (e.g. <code class="literal">make</code>) then the <code class="literal">buildPhase</code> should be overridden.
Additionally, a <code class="literal">preBuild</code> or <code class="literal">configurePhase</code> can be used if there are steps that need to be done prior to checking the <code class="literal">Everything.agda</code> file.
<code class="literal">agda</code> and the Agda libraries contained in <code class="literal">buildInputs</code> are made available during the build phase.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="installing-agda-packages" class="title" >Installing Agda packages   </h4>  </div> </div></div><p>The default install phase copies Agda source files, Agda interface files (<code class="literal">*.agdai</code>) and <code class="literal">*.agda-lib</code> files to the output directory.
This can be overridden.</p><p>By default, Agda sources are files ending on <code class="literal">.agda</code>, or literate Agda files ending on <code class="literal">.lagda</code>, <code class="literal">.lagda.tex</code>, <code class="literal">.lagda.org</code>, <code class="literal">.lagda.md</code>, <code class="literal">.lagda.rst</code>. The list of recognised Agda source extensions can be extended by setting the <code class="literal">extraExtensions</code> config variable.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="maintaining-the-agda-package-set-on-nixpkgs" class="title" >Maintaining the Agda package set on Nixpkgs   </h3>  </div> </div></div><p>We are aiming at providing all common Agda libraries as packages on <code class="literal">nixpkgs</code>,
and keeping them up to date.
Contributions and maintenance help is always appreciated,
but the maintenance effort is typically low since the Agda ecosystem is quite small.</p><p>The <code class="literal">nixpkgs</code> Agda package set tries to take up a role similar to that of <a class="link" href="https://www.stackage.org/"  target="_top">Stackage</a> in the Haskell world.
It is a curated set of libraries that:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Always work together.</p></li><li class="listitem"><p>Are as up-to-date as possible.</p></li></ol></div><p>While the Haskell ecosystem is huge, and Stackage is highly automatised,
the Agda package set is small and can (still) be maintained by hand.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="adding-agda-packages-to-nixpkgs" class="title" >Adding Agda packages to Nixpkgs   </h4>  </div> </div></div><p>To add an Agda package to <code class="literal">nixpkgs</code>, the derivation should be written to <code class="literal">pkgs/development/libraries/agda/${library-name}/</code> and an entry should be added to <code class="literal">pkgs/top-level/agda-packages.nix</code>. Here it is called in a scope with access to all other Agda libraries, so the top line of the <code class="literal">default.nix</code> can look like:</p><pre><code class="programlisting nix">{
  mkDerivation,
  standard-library,
  fetchFromGitHub,
}:
{ }
</code></pre><p>Note that the derivation function is called with <code class="literal">mkDerivation</code> set to <code class="literal">agdaPackages.mkDerivation</code>, therefore you
could use a similar set as in your <code class="literal">default.nix</code> from <a class="link" href="index.html#writing-agda-packages" title="Writing Agda packages" >Writing Agda Packages</a> with
<code class="literal">agdaPackages.mkDerivation</code> replaced with <code class="literal">mkDerivation</code>.</p><p>Here is an example skeleton derivation for iowa-stdlib:</p><pre><code class="programlisting nix">mkDerivation {
  version = &quot;1.5.0&quot;;
  pname = &quot;iowa-stdlib&quot;;

  src = &lt;...&gt;;

  libraryFile = &quot;&quot;;
  libraryName = &quot;IAL-1.3&quot;;

  buildPhase = &#x27;&#x27;
    runHook preBuild

    patchShebangs find-deps.sh
    make

    runHook postBuild
  &#x27;&#x27;;
}
</code></pre><p>This library has a file called <code class="literal">.agda-lib</code>, and so we give an empty string to <code class="literal">libraryFile</code> as nothing precedes <code class="literal">.agda-lib</code> in the filename. This file contains <code class="literal">name: IAL-1.3</code>, and so we let <code class="literal">libraryName =  &quot;IAL-1.3&quot;</code>. This library does not use an <code class="literal">Everything.agda</code> file and instead has a Makefile, so there is no need to set <code class="literal">everythingFile</code> and we set a custom <code class="literal">buildPhase</code>.</p><p>When writing an Agda package it is essential to make sure that no <code class="literal">.agda-lib</code> file gets added to the store as a single file (for example by using <code class="literal">writeText</code>). This causes Agda to think that the nix store is a Agda library and it will attempt to write to it whenever it typechecks something. See <a class="link" href="https://github.com/agda/agda/issues/4613"  target="_top">https://github.com/agda/agda/issues/4613</a>.</p><p>In the pull request adding this library,
you can test whether it builds correctly by writing in a comment:</p><pre><code class="programlisting">@ofborg build agdaPackages.iowa-stdlib
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="agda-maintaining-packages" class="title" >Maintaining Agda packages   </h4>  </div> </div></div><p>As mentioned before, the aim is to have a compatible, and up-to-date package set.
These two conditions sometimes exclude each other:
For example, if we update <code class="literal">agdaPackages.standard-library</code> because there was an upstream release,
this will typically break many reverse dependencies,
i.e. downstream Agda libraries that depend on the standard library.
In <code class="literal">nixpkgs</code> we are typically among the first to notice this,
since we have build tests in place to check this.</p><p>In a pull request updating e.g. the standard library, you should write the following comment:</p><pre><code class="programlisting">@ofborg build agdaPackages.standard-library.passthru.tests
</code></pre><p>This will build all reverse dependencies of the standard library,
for example <code class="literal">agdaPackages.agda-categories</code>, or <code class="literal">agdaPackages.generic</code>.</p><p>In some cases it is useful to build <span class="emphasis"><em>all</em></span> Agda packages.
This can be done with the following Github comment:</p><pre><code class="programlisting">@ofborg build agda.passthru.tests.allPackages
</code></pre><p>Sometimes, the builds of the reverse dependencies fail because they have not yet been updated and released.
You should drop the maintainers a quick issue notifying them of the breakage,
citing the build error (which you can get from the ofborg logs).
If you are motivated, you might even send a pull request that fixes it.
Usually, the maintainers will answer within a week or two with a new release.
Bumping the version of that reverse dependency should be a further commit on your PR.</p><p>In the rare case that a new release is not to be expected within an acceptable time,
mark the broken package as broken by setting <code class="literal">meta.broken = true;</code>.
This will exclude it from the build test.
It can be added later when it is fixed,
and does not hinder the advancement of the whole package set in the meantime.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="android" class="title" style="clear: both">Android   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#using-androidenv-with-android-studio">Using androidenv with Android Studio</a> </span></dt><dt> <span class="section">  <a href="index.html#deploying-an-android-sdk-installation-with-plugins">Deploying an Android SDK installation with plugins</a> </span></dt><dt> <span class="section">  <a href="index.html#using-predefined-android-package-compositions">Using predefined Android package compositions</a> </span></dt><dt> <span class="section">  <a href="index.html#spawning-emulator-instances">Spawning emulator instances</a> </span></dt><dt> <span class="section">  <a href="index.html#notes-on-environment-variables-in-android-projects">Notes on environment variables in Android projects</a> </span></dt><dt> <span class="section">  <a href="index.html#notes-on-improving-build.gradle-compatibility">Notes on improving build.gradle compatibility</a> </span></dt><dt> <span class="section">  <a href="index.html#querying-the-available-versions-of-each-plugin">Querying the available versions of each plugin</a> </span></dt><dt> <span class="section">  <a href="index.html#updating-the-generated-expressions">Updating the generated expressions</a> </span></dt><dt> <span class="section">  <a href="index.html#building-an-android-application-with-ant">Building an Android application with Ant</a> </span></dt> </dl></div><p>The Android build environment provides three major features and a number of
supporting features.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="using-androidenv-with-android-studio" class="title" >Using androidenv with Android Studio   </h3>  </div> </div></div><p>Use the <code class="literal">android-studio-full</code> attribute for a very complete Android SDK, including system images:</p><pre><code class="programlisting nix">{ buildInputs = [ android-studio-full ]; }
</code></pre><p>This is identical to:</p><pre><code class="programlisting nix">{ buildInputs = [ androidStudioPackages.stable.full ]; }
</code></pre><p>Alternatively, you can pass composeAndroidPackages to the <code class="literal">withSdk</code> passthru:</p><pre><code class="programlisting nix">{
  buildInputs = [
    (android-studio.withSdk (androidenv.composeAndroidPackages { includeNDK = true; }).androidsdk)
  ];
}
</code></pre><p>These will export <code class="literal">ANDROID_SDK_ROOT</code> and <code class="literal">ANDROID_NDK_ROOT</code> to the SDK and NDK directories
in the specified Android build environment.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="deploying-an-android-sdk-installation-with-plugins" class="title" >Deploying an Android SDK installation with plugins   </h3>  </div> </div></div><p>Alternatively, you can deploy the SDK separately with a desired set of plugins, or subsets of an SDK.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

let
  androidComposition = androidenv.composeAndroidPackages {
    platformVersions = [
      &quot;34&quot;
      &quot;35&quot;
      &quot;latest&quot;
    ];
    systemImageTypes = [ &quot;google_apis_playstore&quot; ];
    abiVersions = [
      &quot;armeabi-v7a&quot;
      &quot;arm64-v8a&quot;
    ];
    includeNDK = true;
    includeExtras = [ &quot;extras;google;auto&quot; ];
  };
in
androidComposition.androidsdk
</code></pre><p>The above function invocation states that we want an Android SDK with the above
specified plugin versions. By default, most plugins are disabled. Notable
exceptions are the tools, platform-tools and build-tools sub packages.</p><p>The following parameters are supported:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">cmdLineToolsVersion</code> specifies the version of the <code class="literal">cmdline-tools</code> package to use.
It defaults to the latest.</p></li><li class="listitem"><p><code class="literal">toolsVersion</code>, specifies the version of the <code class="literal">tools</code> package. Notice <code class="literal">tools</code> is
obsolete, and currently only <code class="literal">26.1.1</code> is available, so there’s not a lot of
options here, however, you can set it as <code class="literal">null</code> if you don’t want it. It defaults
to the latest.</p></li><li class="listitem"><p><code class="literal">platformToolsVersion</code> specifies the version of the <code class="literal">platform-tools</code> plugin.
It defaults to the latest.</p></li><li class="listitem"><p><code class="literal">buildToolsVersions</code> specifies the versions of the <code class="literal">build-tools</code> plugins to
use. It defaults to the latest.</p></li><li class="listitem"><p><code class="literal">includeEmulator</code> specifies whether to deploy the emulator package (<code class="literal">false</code>
by default). When enabled, the version of the emulator to deploy can be
specified by setting the <code class="literal">emulatorVersion</code> parameter. If set to
<code class="literal">&quot;if-supported&quot;</code>, it will deploy the emulator if it’s supported by the system.</p></li><li class="listitem"><p><code class="literal">includeCmake</code> specifies whether CMake should be included. It defaults to true
on x86-64 and Darwin platforms, and also supports <code class="literal">&quot;if-supported&quot;</code>.</p></li><li class="listitem"><p><code class="literal">cmakeVersions</code> specifies which CMake versions should be deployed.
It defaults to the latest.</p></li><li class="listitem"><p><code class="literal">includeNDK</code> specifies that the Android NDK bundle should be included.
Defaults to <code class="literal">false</code> though can be set to <code class="literal">true</code> or <code class="literal">&quot;if-supported&quot;</code>.</p></li><li class="listitem"><p><code class="literal">ndkVersions</code> specifies the NDK versions that we want to use. These are linked
under the <code class="literal">ndk</code> directory of the SDK root, and the first is linked under the
<code class="literal">ndk-bundle</code> directory. It defaults to the latest.</p></li><li class="listitem"><p><code class="literal">ndkVersion</code> is equivalent to specifying one entry in <code class="literal">ndkVersions</code>, and
<code class="literal">ndkVersions</code> overrides this parameter if provided.</p></li><li class="listitem"><p><code class="literal">includeExtras</code> is an array of identifier strings referring to arbitrary
add-on packages that should be installed. Note that extras may not be compatible
with all platforms (for example, the Google TV head unit, which does not
have an aarch64-linux compile).</p></li><li class="listitem"><p><code class="literal">platformVersions</code> specifies which platform SDK versions should be included.
It defaults to including only the latest API level, though you can add more.</p></li><li class="listitem"><p><code class="literal">numLatestPlatformVersions</code> specifies how many of the latest API levels to include,
if you are using the default for <code class="literal">platformVersions</code>. It defaults to 1, though you can
increase this to, for example, 5 to get the last 5 years of Android API packages.</p></li><li class="listitem"><p><code class="literal">minPlatformVersion</code> and <code class="literal">maxPlatformVersion</code> take priority over <code class="literal">platformVersions</code>
if both are provided. Note that <code class="literal">maxPlatformVersion</code> always defaults to the latest
Android SDK platform version, allowing you to specify <code class="literal">minPlatformVersion</code> to describe
the minimum SDK version your Android composition supports.</p></li></ul></div><p>For each platform version that has been specified, we can apply the following
options:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">includeSystemImages</code> specifies whether a system image for each platform SDK
should be included.</p></li><li class="listitem"><p><code class="literal">includeSources</code> specifies whether the sources for each SDK version should be
included.</p></li><li class="listitem"><p><code class="literal">useGoogleAPIs</code> specifies that for each selected platform version the
Google API should be included.</p></li><li class="listitem"><p><code class="literal">useGoogleTVAddOns</code> specifies that for each selected platform version the
Google TV add-on should be included.</p></li></ul></div><p>For each requested system image we can specify the following options:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">systemImageTypes</code> specifies what kind of system images should be included.
Defaults to: <code class="literal">default</code>.</p></li><li class="listitem"><p><code class="literal">abiVersions</code> specifies what kind of ABI version of each system image should
be included. Defaults to <code class="literal">armeabi-v7a</code> and <code class="literal">arm64-v8a</code>.</p></li></ul></div><p>Most of the function arguments have reasonable default settings, preferring the latest
versions of tools when possible. You can additionally specify “latest” for any plugin version
that you do not care about, and just want the latest of.</p><p>You can specify license names:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">extraLicenses</code> is a list of license names.
You can get these names from repo.json or <code class="literal">querypackages.sh licenses</code>. The SDK
license (<code class="literal">android-sdk-license</code>) is accepted for you if you set accept_license
to true. If you are doing something like working with preview SDKs, you will
want to add <code class="literal">android-sdk-preview-license</code> or whichever license applies here.</p></li></ul></div><p>Additionally, you can override the repositories that composeAndroidPackages will
pull from:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">repoJson</code> specifies a path to a generated repo.json file. You can generate this
by running <code class="literal">generate.sh</code>, which in turn will call into <code class="literal">mkrepo.rb</code>.</p></li><li class="listitem"><p><code class="literal">repoXmls</code> is an attribute set containing paths to repo XML files. If specified,
it takes priority over <code class="literal">repoJson</code>, and will trigger a local build writing out a
repo.json to the Nix store based on the given repository XMLs. Note that this uses
import-from-derivation.</p></li></ul></div><pre><code class="programlisting nix">{
  repoXmls = {
    packages = [ ./xml/repository2-1.xml ];
    images = [
      ./xml/android-sys-img2-1.xml
      ./xml/android-tv-sys-img2-1.xml
      ./xml/android-wear-sys-img2-1.xml
      ./xml/android-wear-cn-sys-img2-1.xml
      ./xml/google_apis-sys-img2-1.xml
      ./xml/google_apis_playstore-sys-img2-1.xml
    ];
    addons = [ ./xml/addon2-1.xml ];
  };
}
</code></pre><p>When building the above expression with:</p><pre><code class="programlisting bash">$ nix-build
</code></pre><p>The Android SDK gets deployed with all desired plugin versions.</p><p>We can also deploy subsets of the Android SDK. For example, to only the
<code class="literal">platform-tools</code> package, you can evaluate the following expression:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

let
  androidComposition = androidenv.composeAndroidPackages {
    # ...
  };
in
androidComposition.platform-tools
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="using-predefined-android-package-compositions" class="title" >Using predefined Android package compositions   </h3>  </div> </div></div><p>In addition to composing an Android package set manually, it is also possible
to use a predefined composition that contains a fairly complete set of Android packages:</p><p>The following Nix expression can be used to deploy the entire SDK:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

androidenv.androidPkgs.androidsdk
</code></pre><p>It is also possible to use one plugin only:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

androidenv.androidPkgs.platform-tools
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="spawning-emulator-instances" class="title" >Spawning emulator instances   </h3>  </div> </div></div><p>For testing purposes, it can also be quite convenient to automatically generate
scripts that spawn emulator instances with all desired configuration settings.</p><p>An emulator spawn script can be configured by invoking the <code class="literal">emulateApp {}</code>
function:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

androidenv.emulateApp {
  name = &quot;emulate-MyAndroidApp&quot;;
  platformVersion = &quot;28&quot;;
  abiVersion = &quot;x86&quot;; # armeabi-v7a, mips, x86_64
  systemImageType = &quot;google_apis_playstore&quot;;
}
</code></pre><p>Additional flags may be applied to the Android SDK’s emulator through the runtime environment variable <code class="literal">$NIX_ANDROID_EMULATOR_FLAGS</code>.</p><p>It is also possible to specify an APK to deploy inside the emulator
and the package and activity names to launch it:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

androidenv.emulateApp {
  name = &quot;emulate-MyAndroidApp&quot;;
  platformVersion = &quot;24&quot;;
  abiVersion = &quot;armeabi-v7a&quot;; # mips, x86, x86_64
  systemImageType = &quot;default&quot;;
  app = ./MyApp.apk;
  package = &quot;MyApp&quot;;
  activity = &quot;MainActivity&quot;;
}
</code></pre><p>In addition to prebuilt APKs, you can also bind the APK parameter to a
<code class="literal">buildApp {}</code> function invocation shown in the previous example.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="notes-on-environment-variables-in-android-projects" class="title" >Notes on environment variables in Android projects   </h3>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">ANDROID_HOME</code> should point to the Android SDK. In your Nix expressions, this should be
<code class="literal">${androidComposition.androidsdk}/libexec/android-sdk</code>. Note that <code class="literal">ANDROID_SDK_ROOT</code> is deprecated,
but if you rely on tools that need it, you can export it too.</p></li><li class="listitem"><p><code class="literal">ANDROID_NDK_ROOT</code> should point to the Android NDK, if you’re doing NDK development.
In your Nix expressions, this should be <code class="literal">${ANDROID_HOME}/ndk-bundle</code>.</p></li></ul></div><p>If you are running the Android Gradle plugin, you need to export GRADLE_OPTS to override aapt2
to point to the aapt2 binary in the Nix store as well, or use a FHS environment so the packaged
aapt2 can run. If you don’t want to use a FHS environment, something like this should work:</p><pre><code class="programlisting nix">let
  buildToolsVersion = &quot;30.0.3&quot;;

  # Use buildToolsVersion when you define androidComposition
  androidComposition = &lt;...&gt;;
in
pkgs.mkShell rec {
  ANDROID_HOME = &quot;${androidComposition.androidsdk}/libexec/android-sdk&quot;;
  ANDROID_NDK_ROOT = &quot;${ANDROID_HOME}/ndk-bundle&quot;;

  # Use the same buildToolsVersion here
  GRADLE_OPTS = &quot;-Dorg.gradle.project.android.aapt2FromMavenOverride=${ANDROID_HOME}/build-tools/${buildToolsVersion}/aapt2&quot;;
}
</code></pre><p>If you are using cmake, you need to add it to PATH in a shell hook or FHS env profile.
The path is suffixed with a build number, but properly prefixed with the version.
So, something like this should suffice:</p><pre><code class="programlisting nix">let
  cmakeVersion = &quot;3.10.2&quot;;

  # Use cmakeVersion when you define androidComposition
  androidComposition = &lt;...&gt;;
in
pkgs.mkShell rec {
  ANDROID_HOME = &quot;${androidComposition.androidsdk}/libexec/android-sdk&quot;;
  ANDROID_NDK_ROOT = &quot;${ANDROID_HOME}/ndk-bundle&quot;;

  # Use the same cmakeVersion here
  shellHook = &#x27;&#x27;
    export PATH=&quot;$(echo &quot;$ANDROID_HOME/cmake/${cmakeVersion}&quot;.*/bin):$PATH&quot;
  &#x27;&#x27;;
}
</code></pre><p>Note that running Android Studio with ANDROID_HOME set will automatically write a
<code class="literal">local.properties</code> file with <code class="literal">sdk.dir</code> set to $ANDROID_HOME if one does not already
exist. If you are using the NDK as well, you may have to add <code class="literal">ndk.dir</code> to this file.</p><p>An example shell.nix that does all this for you is provided in examples/shell.nix.
This shell.nix includes a shell hook that overwrites local.properties with the correct
sdk.dir and ndk.dir values. This will ensure that the SDK and NDK directories will
both be correct when you run Android Studio inside nix-shell.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="notes-on-improving-build.gradle-compatibility" class="title" >Notes on improving build.gradle compatibility   </h3>  </div> </div></div><p>Ensure that your buildToolsVersion and ndkVersion match what is declared in androidenv.
If you are using cmake, make sure its declared version is correct too.</p><p>Otherwise, you may get cryptic errors from aapt2 and the Android Gradle plugin warning
that it cannot install the build tools because the SDK directory is not writeable.</p><pre><code class="programlisting gradle">android {
    buildToolsVersion &quot;30.0.3&quot;
    ndkVersion = &quot;22.0.7026061&quot;
    externalNativeBuild {
        cmake {
            version &quot;3.10.2&quot;
        }
    }
}

</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="querying-the-available-versions-of-each-plugin" class="title" >Querying the available versions of each plugin   </h3>  </div> </div></div><p>All androidenv packages are available on <a class="link" href="https://search.nixos.org"  target="_top">search.nixos.org</a>.
Note that <code class="literal">aarch64-linux</code> compatibility is currently spotty, though <code class="literal">x86_64-linux</code> and <code class="literal">aarch64-darwin</code>
are well supported. This is because Google’s repository definitions mark some packages for “all” architectures
that are really only for <code class="literal">x86_64</code> or <code class="literal">aarch64</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="updating-the-generated-expressions" class="title" >Updating the generated expressions   </h3>  </div> </div></div><p>repo.json is generated from XML files that the Android Studio package manager uses.
To update the expressions run the <code class="literal">update.sh</code> script that is stored in the
<code class="literal">pkgs/development/mobile/androidenv/</code> subdirectory:</p><pre><code class="programlisting bash">./update.sh
</code></pre><p>This is run automatically by the nixpkgs update script.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="building-an-android-application-with-ant" class="title" >Building an Android application with Ant   </h3>  </div> </div></div><p>In addition to the SDK, it is also possible to build an Ant-based Android
project and automatically deploy all the Android plugins that a project
requires. Most newer Android projects use Gradle, and this is included for historical
purposes.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

androidenv.buildApp {
  name = &quot;MyAndroidApp&quot;;
  src = ./myappsources;
  release = true;

  # If release is set to true, you need to specify the following parameters
  keyStore = ./keystore;
  keyAlias = &quot;myfirstapp&quot;;
  keyStorePassword = &quot;mykeystore&quot;;
  keyAliasPassword = &quot;myfirstapp&quot;;

  # Any Android SDK parameters that install all the relevant plugins that a
  # build requires
  platformVersions = [ &quot;24&quot; ];

  # When we include the NDK, then ndk-build is invoked before Ant gets invoked
  includeNDK = true;
}
</code></pre><p>Aside from the app-specific build parameters (<code class="literal">name</code>, <code class="literal">src</code>, <code class="literal">release</code> and
keystore parameters), the <code class="literal">buildApp {}</code> function supports all the function
parameters that the SDK composition function (the function shown in the
previous section) supports.</p><p>This build function is particularly useful when it is desired to use
<a class="link" href="https://nixos.org/hydra"  target="_top">Hydra</a>: the Nix-based continuous integration solution
to build Android apps. An Android APK gets exposed as a build product and can be
installed on any Android device with a web browser by navigating to the build
result page.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="astal" class="title" style="clear: both">Astal   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#astal-bundling">Bundling</a> </span></dt> </dl></div><p>Astal is a collection of building blocks for creating custom desktop shells.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="astal-bundling" class="title" >Bundling   </h3>  </div> </div></div><p>Bundling Astal application is done using <code class="literal">ags</code> tool, you can use it like this:</p><pre><code class="programlisting nix">ags.bundle {
  pname = &quot;hyprpanel&quot;;
  version = &quot;1.0.0&quot;;

  src = fetchFromGitHub {
    #...
  };

  # change your entry file (default is `app.ts`)
  entry = &quot;app.ts&quot;;

  dependencies = [
    # list here astal modules, that your package depends on
    # `astal3`, `astal4` and `astal.io` are automatically included
    astal.apps
    astal.battery
    astal.bluetooth

    # you can also list here other runtime dependencies
    hypridle
    hyprpicker
    hyprsunset
  ];

  # GTK 4 support is opt-in
  enableGtk4 = true;

  meta = {
    #...
  };
}
</code></pre><p>You can also pass all other arguments that are supported by <code class="literal">stdenv.mkDerivation</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-beam" class="title" style="clear: both">BEAM Languages (Erlang, Elixir &amp; LFE)   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#beam-introduction">Introduction</a> </span></dt><dt> <span class="section">  <a href="index.html#available-versions-and-deprecations-schedule">Available versions and deprecations schedule</a> </span></dt><dt> <span class="section">  <a href="index.html#beam-structure">Structure</a> </span></dt><dt> <span class="section">  <a href="index.html#build-tools">Build Tools</a> </span></dt><dt> <span class="section">  <a href="index.html#how-to-install-beam-packages">How to Install BEAM Packages</a> </span></dt><dt> <span class="section">  <a href="index.html#packaging-beam-applications">Packaging BEAM Applications</a> </span></dt><dt> <span class="section">  <a href="index.html#how-to-develop">How to Develop</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="beam-introduction" class="title" >Introduction   </h3>  </div> </div></div><p>In this document and related Nix expressions, we use the term, <span class="emphasis"><em>BEAM</em></span>, to describe the environment. BEAM is the name of the Erlang Virtual Machine and, as far as we’re concerned, from a packaging perspective, all languages that run on the BEAM are interchangeable. That which varies, like the build system, is transparent to users of any given BEAM package, so we make no distinction.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="available-versions-and-deprecations-schedule" class="title" >Available versions and deprecations schedule   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="elixir" class="title" >Elixir   </h4>  </div> </div></div><p>nixpkgs follows the <a class="link" href="https://hexdocs.pm/elixir/compatibility-and-deprecations.html"  target="_top">official elixir deprecation schedule</a> and keeps the last 5 released versions of Elixir available.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="beam-structure" class="title" >Structure   </h3>  </div> </div></div><p>All BEAM-related expressions are available via the top-level <code class="literal">beam</code> attribute, which includes:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">interpreters</code>: a set of compilers running on the BEAM, including multiple Erlang/OTP versions (<code class="literal">beam.interpreters.erlang_22</code>, etc), Elixir (<code class="literal">beam.interpreters.elixir</code>) and LFE (Lisp Flavoured Erlang) (<code class="literal">beam.interpreters.lfe</code>).</p></li><li class="listitem"><p><code class="literal">packages</code>: a set of package builders (Mix and rebar3), each compiled with a specific Erlang/OTP version, e.g. <code class="literal">beam.packages.erlang22</code>.</p></li></ul></div><p>The default Erlang compiler, defined by <code class="literal">beam.interpreters.erlang</code>, is aliased as <code class="literal">erlang</code>. The default BEAM package set is defined by <code class="literal">beam.packages.erlang</code> and aliased at the top level as <code class="literal">beamPackages</code>.</p><p>To create a package builder built with a custom Erlang version, use the lambda, <code class="literal">beam.packagesWith</code>, which accepts an Erlang/OTP derivation and produces a package builder similar to <code class="literal">beam.packages.erlang</code>.</p><p>Many Erlang/OTP distributions available in <code class="literal">beam.interpreters</code> have versions with ODBC and/or Java enabled or without wx (no observer support). For example, there’s <code class="literal">beam.interpreters.erlang_22_odbc_javac</code>, which corresponds to <code class="literal">beam.interpreters.erlang_22</code> and <code class="literal">beam.interpreters.erlang_22_nox</code>, which corresponds to <code class="literal">beam.interpreters.erlang_22</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="build-tools" class="title" >Build Tools   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="build-tools-rebar3" class="title" >Rebar3   </h4>  </div> </div></div><p>We provide a version of Rebar3, under <code class="literal">rebar3</code>. We also provide a helper to fetch Rebar3 dependencies from a lockfile under <code class="literal">fetchRebar3Deps</code>.</p><p>We also provide a version on Rebar3 with plugins included, under <code class="literal">rebar3WithPlugins</code>. This package is a function which takes two arguments: <code class="literal">plugins</code>, a list of nix derivations to include as plugins (loaded only when specified in <code class="literal">rebar.config</code>), and <code class="literal">globalPlugins</code>, which should always be loaded by rebar3. Example: <code class="literal">rebar3WithPlugins { globalPlugins = [beamPackages.pc]; }</code>.</p><p>When adding a new plugin it is important that the <code class="literal">packageName</code> attribute is the same as the atom used by rebar3 to refer to the plugin.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="build-tools-other" class="title" >Mix &amp; Erlang.mk   </h4>  </div> </div></div><p>Erlang.mk works exactly as expected. There is a bootstrap process that needs to be run, which is supported by the <code class="literal">buildErlangMk</code> derivation.</p><p>For Elixir applications use <code class="literal">mixRelease</code> to make a release. See examples for more details.</p><p>There is also a <code class="literal">buildMix</code> helper, whose behavior is closer to that of <code class="literal">buildErlangMk</code> and <code class="literal">buildRebar3</code>. The primary difference is that mixRelease makes a release, while buildMix only builds the package, making it useful for libraries and other dependencies.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="how-to-install-beam-packages" class="title" >How to Install BEAM Packages   </h3>  </div> </div></div><p>BEAM builders are not registered at the top level, because they are not relevant to the vast majority of Nix users.
To use any of those builders into your environment, refer to them by their attribute path under <code class="literal">beamPackages</code>, e.g. <code class="literal">beamPackages.rebar3</code>:</p><div class="example"><span id="ex-beam-ephemeral-shell" ></span><details><summary><span class="title"><strong>Example 353. Ephemeral shell</strong></span></summary><div class="example-contents"><pre><code class="programlisting ShellSession">$ nix-shell -p beamPackages.rebar3
</code></pre></div></details></div><br class="example-break" /><div class="example"><span id="ex-beam-declarative-shell" ></span><details><summary><span class="title"><strong>Example 354. Declarative shell</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; {
    config = { };
    overlays = [ ];
  };
in
pkgs.mkShell { packages = [ pkgs.beamPackages.rebar3 ]; }
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="packaging-beam-applications" class="title" >Packaging BEAM Applications   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="packaging-erlang-applications" class="title" >Erlang Applications   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="rebar3-packages" class="title" >Rebar3 Packages   </h5>  </div> </div></div><p>The Nix function, <code class="literal">buildRebar3</code>, defined in <code class="literal">beam.packages.erlang.buildRebar3</code> and aliased at the top level, can be used to build a derivation that understands how to build a Rebar3 project.</p><p>If a package needs to compile native code via Rebar3’s port compilation mechanism, add <code class="literal">compilePort = true;</code> to the derivation.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="erlang-mk-packages" class="title" >Erlang.mk Packages   </h5>  </div> </div></div><p>Erlang.mk functions similarly to Rebar3, except we use <code class="literal">buildErlangMk</code> instead of <code class="literal">buildRebar3</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="mix-packages" class="title" >Mix Packages   </h5>  </div> </div></div><p><code class="literal">mixRelease</code> is used to make a release in the mix sense. Dependencies will need to be fetched with <code class="literal">fetchMixDeps</code> and passed to it.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="mix-release-elixir-phoenix-example" class="title" >mixRelease - Elixir Phoenix example   </h5>  </div> </div></div><p>there are 3 steps, frontend dependencies (javascript), backend dependencies (elixir) and the final derivation that puts both of those together</p><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="mix-release-javascript-deps" class="title" >mixRelease - Frontend dependencies (javascript)   </h6>  </div> </div></div><p>For phoenix projects, inside of nixpkgs you can either use yarn2nix (mkYarnModule) or node2nix. An example with yarn2nix can be found <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/servers/web-apps/plausible/default.nix#L39"  target="_top">here</a>. An example with node2nix will follow. To package something outside of nixpkgs, you have alternatives like <a class="link" href="https://github.com/nix-community/npmlock2nix"  target="_top">npmlock2nix</a> or <a class="link" href="https://github.com/serokell/nix-npm-buildpackage"  target="_top">nix-npm-buildpackage</a></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="mix-release-mix-deps" class="title" >mixRelease - backend dependencies (mix)   </h6>  </div> </div></div><p>There are 2 ways to package backend dependencies. With mix2nix and with a fixed-output-derivation (FOD).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="mix2nix" class="title" >mix2nix   </h6>  </div> </div></div><p><code class="literal">mix2nix</code> is a cli tool available in nixpkgs. it will generate a nix expression from a mix.lock file. It is quite standard in the 2nix tool series.</p><p>Note that currently mix2nix can’t handle git dependencies inside the mix.lock file. If you have git dependencies, you can either add them manually (see <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/servers/pleroma/default.nix#L20"  target="_top">example</a>) or use the FOD method.</p><p>The advantage of using mix2nix is that nix will know your whole dependency graph. On a dependency update, this won’t trigger a full rebuild and download of all the dependencies, where FOD will do so.</p><p>Practical steps:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>run <code class="literal">mix2nix &gt; mix_deps.nix</code> in the upstream repo.</p></li><li class="listitem"><p>pass <code class="literal">mixNixDeps = with pkgs; import ./mix_deps.nix { inherit lib beamPackages; };</code> as an argument to mixRelease.</p></li></ul></div><p>If there are git dependencies.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>You’ll need to fix the version artificially in mix.exs and regenerate the mix.lock with fixed version (on upstream). This will enable you to run <code class="literal">mix2nix &gt; mix_deps.nix</code>.</p></li><li class="listitem"><p>From the mix_deps.nix file, remove the dependencies that had git versions and pass them as an override to the import function.</p></li></ul></div><pre><code class="programlisting nix">{
  mixNixDeps = import ./mix.nix {
    inherit beamPackages lib;
    overrides = (
      final: prev: {
        # mix2nix does not support git dependencies yet,
        # so we need to add them manually
        prometheus_ex = beamPackages.buildMix rec {
          name = &quot;prometheus_ex&quot;;
          version = &quot;3.0.5&quot;;

          # Change the argument src with the git src that you actually need
          src = fetchFromGitLab {
            domain = &quot;git.pleroma.social&quot;;
            group = &quot;pleroma&quot;;
            owner = &quot;elixir-libraries&quot;;
            repo = &quot;prometheus.ex&quot;;
            rev = &quot;a4e9beb3c1c479d14b352fd9d6dd7b1f6d7deee5&quot;;
            hash = &quot;sha256-U17LlN6aGUKUFnT4XyYXppRN+TvUBIBRHEUsfeIiGOw=&quot;;
          };
          # you can re-use the same beamDeps argument as generated
          beamDeps = with final; [ prometheus ];
        };
      }
    );
  };
}
</code></pre><p>You will need to run the build process once to fix the hash to correspond to your new git src.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="fixed-output-derivation" class="title" >FOD   </h6>  </div> </div></div><p>A fixed output derivation will download mix dependencies from the internet. To ensure reproducibility, a hash will be supplied. Note that mix is relatively reproducible. An FOD generating a different hash on each run hasn’t been observed (as opposed to npm where the chances are relatively high). See <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/beam-modules/elixir-ls/default.nix"  target="_top">elixir-ls</a> for a usage example of FOD.</p><p>Practical steps</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>start with the following argument to mixRelease</p></li></ul></div><pre><code class="programlisting nix">{
  mixFodDeps = fetchMixDeps {
    pname = &quot;mix-deps-${pname}&quot;;
    inherit src version;
    hash = lib.fakeHash;
  };
}
</code></pre><p>The first build will complain about the hash value, you can replace with the suggested value after that.</p><p>Note that if after you’ve replaced the value, nix suggests another hash, then mix is not fetching the dependencies reproducibly. An FOD will not work in that case and you will have to use mix2nix.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="mix-release-example" class="title" >mixRelease - example   </h6>  </div> </div></div><p>Here is how your <code class="literal">default.nix</code> file would look for a phoenix project.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

let
  # beam.interpreters.erlang_26 is available if you need a particular version
  packages = beam.packagesWith beam.interpreters.erlang;

  pname = &quot;your_project&quot;;
  version = &quot;0.0.1&quot;;

  src = builtins.fetchgit {
    url = &quot;ssh://git@github.com/your_id/your_repo&quot;;
    rev = &quot;replace_with_your_commit&quot;;
  };

  # if using mix2nix you can use the mixNixDeps attribute
  mixFodDeps = packages.fetchMixDeps {
    pname = &quot;mix-deps-${pname}&quot;;
    inherit src version;
    # nix will complain and tell you the right value to replace this with
    hash = lib.fakeHash;
    mixEnv = &quot;&quot;; # default is &quot;prod&quot;, when empty includes all dependencies, such as &quot;dev&quot;, &quot;test&quot;.
    # if you have build time environment variables add them here
    MY_ENV_VAR = &quot;my_value&quot;;
  };

  nodeDependencies = (pkgs.callPackage ./assets/default.nix { }).shell.nodeDependencies;

in
packages.mixRelease {
  inherit
    src
    pname
    version
    mixFodDeps
    ;
  # if you have build time environment variables add them here
  MY_ENV_VAR = &quot;my_value&quot;;

  postBuild = &#x27;&#x27;
    ln -sf ${nodeDependencies}/lib/node_modules assets/node_modules
    npm run deploy --prefix ./assets

    # for external task you need a workaround for the no deps check flag
    # https://github.com/phoenixframework/phoenix/issues/2690
    mix do deps.loadpaths --no-deps-check, phx.digest
    mix phx.digest --no-deps-check
  &#x27;&#x27;;
}
</code></pre><p>Setup will require the following steps:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Move your secrets to runtime environment variables. For more information refer to the <a class="link" href="https://hexdocs.pm/mix/Mix.Tasks.Release.html#module-runtime-configuration"  target="_top">runtime.exs docs</a>. On a fresh Phoenix build that would mean that both <code class="literal">DATABASE_URL</code> and <code class="literal">SECRET_KEY</code> need to be moved to <code class="literal">runtime.exs</code>.</p></li><li class="listitem"><p><code class="literal">cd assets</code> and <code class="literal">nix-shell -p node2nix --run &quot;node2nix --development&quot;</code> will generate a Nix expression containing your frontend dependencies</p></li><li class="listitem"><p>commit and push those changes</p></li><li class="listitem"><p>you can now <code class="literal">nix-build .</code></p></li><li class="listitem"><p>To run the release, set the <code class="literal">RELEASE_TMP</code> environment variable to a directory that your program has write access to. It will be used to store the BEAM settings.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="example-of-creating-a-service-for-an-elixir---phoenix-project" class="title" >Example of creating a service for an Elixir - Phoenix project   </h5>  </div> </div></div><p>In order to create a service with your release, you could add a <code class="literal">service.nix</code>
in your project with the following</p><pre><code class="programlisting nix">{
  config,
  pkgs,
  lib,
  ...
}:

let
  release = pkgs.callPackage ./default.nix;
  release_name = &quot;app&quot;;
  working_directory = &quot;/home/app&quot;;
in
{
  systemd.services.${release_name} = {
    wantedBy = [ &quot;multi-user.target&quot; ];
    after = [
      &quot;network.target&quot;
      &quot;postgresql.target&quot;
    ];
    # note that if you are connecting to a postgres instance on a different host
    # postgresql.target should not be included in the requires.
    requires = [
      &quot;network-online.target&quot;
      &quot;postgresql.target&quot;
    ];
    description = &quot;my app&quot;;
    environment = {
      # RELEASE_TMP is used to write the state of the
      # VM configuration when the system is running
      # it needs to be a writable directory
      RELEASE_TMP = working_directory;
      # can be generated in an elixir console with
      # Base.encode32(:crypto.strong_rand_bytes(32))
      RELEASE_COOKIE = &quot;my_cookie&quot;;
      MY_VAR = &quot;my_var&quot;;
    };
    serviceConfig = {
      Type = &quot;exec&quot;;
      DynamicUser = true;
      WorkingDirectory = working_directory;
      # Implied by DynamicUser, but just to emphasize due to RELEASE_TMP
      PrivateTmp = true;
      ExecStart = &#x27;&#x27;
        ${release}/bin/${release_name} start
      &#x27;&#x27;;
      ExecStop = &#x27;&#x27;
        ${release}/bin/${release_name} stop
      &#x27;&#x27;;
      ExecReload = &#x27;&#x27;
        ${release}/bin/${release_name} restart
      &#x27;&#x27;;
      Restart = &quot;on-failure&quot;;
      RestartSec = 5;
    };
    unitConfig = {
      StartLimitBurst = 3;
      StartLimitInterval = 10;
    };
    # disksup requires bash
    path = [ pkgs.bash ];
  };

  # in case you have migration scripts or you want to use a remote shell
  environment.systemPackages = [ release ];
}
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="how-to-develop" class="title" >How to Develop   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="creating-a-shell" class="title" >Creating a Shell   </h4>  </div> </div></div><p>Usually, we need to create a <code class="literal">shell.nix</code> file and do our development inside of the environment specified therein. Just install your version of Erlang and any other interpreters, and then use your normal build tools. As an example with Elixir:</p><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:

with pkgs;
let
  elixir = beam.packages.erlang_27.elixir_1_18;
in
mkShell { buildInputs = [ elixir ]; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="beam-using-overlays" class="title" >Using an overlay   </h4>  </div> </div></div><p>If you need to use an overlay to change some attributes of a derivation, e.g. if you need a bugfix from a version that is not yet available in nixpkgs, you can override attributes such as <code class="literal">version</code> (and the corresponding <code class="literal">hash</code>) and then use this overlay in your development environment:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="beam-using-overlays-shell.nix" class="title" ><code class="literal">shell.nix</code>   </h5>  </div> </div></div><pre><code class="programlisting nix">let
  elixir_1_18_1_overlay = (
    self: super: {
      elixir_1_18 = super.elixir_1_18.override {
        version = &quot;1.18.1&quot;;
        sha256 = &quot;sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;;
      };
    }
  );
  pkgs = import &lt;nixpkgs&gt; { overlays = [ elixir_1_18_1_overlay ]; };
in
with pkgs;
mkShell { buildInputs = [ elixir_1_18 ]; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="elixir---phoenix-project" class="title" >Elixir - Phoenix project   </h5>  </div> </div></div><p>Here is an example <code class="literal">shell.nix</code>.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

let
  # define packages to install
  basePackages = [
    git
    # replace with beam.packages.erlang.elixir_1_18 if you need
    beam.packages.erlang.elixir
    nodejs
    postgresql_14
    # only used for frontend dependencies
    # you are free to use yarn2nix as well
    nodePackages.node2nix
    # formatting js file
    nodePackages.prettier
  ];

  inputs = basePackages ++ lib.optionals stdenv.hostPlatform.isLinux [ inotify-tools ];

  # define shell startup command
  hooks = &#x27;&#x27;
    # this allows mix to work on the local directory
    mkdir -p .nix-mix .nix-hex
    export MIX_HOME=$PWD/.nix-mix
    export HEX_HOME=$PWD/.nix-mix
    # make hex from Nixpkgs available
    # `mix local.hex` will install hex into MIX_HOME and should take precedence
    export MIX_PATH=&quot;${beam.packages.erlang.hex}/lib/erlang/lib/hex/ebin&quot;
    export PATH=$MIX_HOME/bin:$HEX_HOME/bin:$PATH
    export LANG=C.UTF-8
    # keep your shell history in iex
    export ERL_AFLAGS=&quot;-kernel shell_history enabled&quot;

    # postges related
    # keep all your db data in a folder inside the project
    export PGDATA=&quot;$PWD/db&quot;

    # phoenix related env vars
    export POOL_SIZE=15
    export DB_URL=&quot;postgresql://postgres:postgres@localhost:5432/db&quot;
    export PORT=4000
    export MIX_ENV=dev
    # add your project env vars here, word readable in the nix store.
    export ENV_VAR=&quot;your_env_var&quot;
  &#x27;&#x27;;

in
mkShell {
  buildInputs = inputs;
  shellHook = hooks;
}
</code></pre><p>Initializing the project will require the following steps:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>create the db directory <code class="literal">initdb ./db</code> (inside your mix project folder)</p></li><li class="listitem"><p>create the postgres user <code class="literal">createuser postgres -ds</code></p></li><li class="listitem"><p>create the db <code class="literal">createdb db</code></p></li><li class="listitem"><p>start the postgres instance <code class="literal">pg_ctl -l &quot;$PGDATA/server.log&quot; start</code></p></li><li class="listitem"><p>add the <code class="literal">/db</code> folder to your <code class="literal">.gitignore</code></p></li><li class="listitem"><p>you can start your phoenix server and get a shell with <code class="literal">iex -S mix phx.server</code></p></li></ul></div>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-bower" class="title" style="clear: both">Bower   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-bower2nix-usage">bower2nix usage</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-build-bower-components">buildBowerComponents function</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-bower2nix-troubleshooting">Troubleshooting</a> </span></dt> </dl></div><p><a class="link" href="https://bower.io"  target="_top">Bower</a> is a package manager for web site front-end components. Bower packages (comprising of build artifacts and sometimes sources) are stored in <code class="literal">git</code> repositories, typically on Github. The package registry is run by the Bower team with package metadata coming from the <code class="literal">bower.json</code> file within each package.</p><p>The end result of running Bower is a <code class="literal">bower_components</code> directory which can be included in the web app’s build process.</p><p>Bower can be run interactively, by installing <code class="literal">nodePackages.bower</code>. More interestingly, the Bower components can be declared in a Nix derivation, with the help of <code class="literal">bower2nix</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-bower2nix-usage" class="title" >bower2nix usage   </h3>  </div> </div></div><p>Suppose you have a <code class="literal">bower.json</code> with the following contents:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ex-bowerJson" class="title" >Example bower.json   </h4>  </div> </div></div><pre><code class="programlisting json">  &quot;name&quot;: &quot;my-web-app&quot;,
  &quot;dependencies&quot;: {
    &quot;angular&quot;: &quot;~1.5.0&quot;,
    &quot;bootstrap&quot;: &quot;~3.3.6&quot;
  }
</code></pre><p>Running <code class="literal">bower2nix</code> will produce something like the following output:</p><pre><code class="programlisting nix">{ fetchbower, buildEnv }:
buildEnv {
  name = &quot;bower-env&quot;;
  ignoreCollisions = true;
  paths = [
    (fetchbower &quot;angular&quot; &quot;1.5.3&quot; &quot;~1.5.0&quot; &quot;1749xb0firxdra4rzadm4q9x90v6pzkbd7xmcyjk6qfza09ykk9y&quot;)
    (fetchbower &quot;bootstrap&quot; &quot;3.3.6&quot; &quot;~3.3.6&quot; &quot;1vvqlpbfcy0k5pncfjaiskj3y6scwifxygfqnw393sjfxiviwmbv&quot;)
    (fetchbower &quot;jquery&quot; &quot;2.2.2&quot; &quot;1.9.1 - 2&quot; &quot;10sp5h98sqwk90y4k6hbdviwqzvzwqf47r3r51pakch5ii2y7js1&quot;)
  ];
}
</code></pre><p>Using the <code class="literal">bower2nix</code> command line arguments, the output can be redirected to a file. A name like <code class="literal">bower-packages.nix</code> would be fine.</p><p>The resulting derivation is a union of all the downloaded Bower packages (and their dependencies). To use it, they still need to be linked together by Bower, which is where <code class="literal">buildBowerComponents</code> is useful.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-build-bower-components" class="title" >buildBowerComponents function   </h3>  </div> </div></div><p>The function is implemented in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/bower-modules/generic/default.nix"  target="_top">pkgs/development/bower-modules/generic/default.nix</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ex-buildBowerComponents" class="title" >Example buildBowerComponents   </h4>  </div> </div></div><pre><code class="programlisting nix">{
  bowerComponents = buildBowerComponents {
    name = &quot;my-web-app&quot;;
    generated = ./bower-packages.nix; # note 1
    src = myWebApp; # note 2
  };
}
</code></pre><p>In <a class="link" href="index.html#ex-buildBowerComponents" title="Example buildBowerComponents" >“buildBowerComponents” example</a> the following arguments are of special significance to the function:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p><code class="literal">generated</code> specifies the file which was created by <span class="command"><strong>bower2nix</strong></span>.</p></li><li class="listitem"><p><code class="literal">src</code> is your project’s sources. It needs to contain a <code class="filename">bower.json</code> file.</p></li></ol></div><p><code class="literal">buildBowerComponents</code> will run Bower to link together the output of <code class="literal">bower2nix</code>, resulting in a <code class="literal">bower_components</code> directory which can be used.</p><p>Here is an example of a web frontend build process using <code class="literal">gulp</code>. You might use <code class="literal">grunt</code>, or anything else.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ex-bowerGulpFile" class="title" >Example build script (gulpfile.js)   </h4>  </div> </div></div><pre><code class="programlisting javascript">var gulp = require(&#x27;gulp&#x27;);

gulp.task(&#x27;default&#x27;, [], function () {
  gulp.start(&#x27;build&#x27;);
});

gulp.task(&#x27;build&#x27;, [], function () {
  console.log(&quot;Just a dummy gulp build&quot;);
  gulp
    .src([&quot;./bower_components/**/*&quot;])
    .pipe(gulp.dest(&quot;./gulpdist/&quot;));
});
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ex-buildBowerComponentsDefaultNix" class="title" >Example Full example — default.nix   </h4>  </div> </div></div><pre><code class="programlisting nix">{
  myWebApp ? {
    outPath = ./.;
    name = &quot;myWebApp&quot;;
  },
  pkgs ? import &lt;nixpkgs&gt; { },
}:

pkgs.stdenv.mkDerivation {
  name = &quot;my-web-app-frontend&quot;;
  src = myWebApp;

  buildInputs = [ pkgs.nodePackages.gulp ];

  bowerComponents = pkgs.buildBowerComponents {
    # note 1
    name = &quot;my-web-app&quot;;
    generated = ./bower-packages.nix;
    src = myWebApp;
  };

  nativeBuildInputs = [
    writableTmpDirAsHomeHook # note 3
  ];

  buildPhase = &#x27;&#x27;
    runHook preBuild

    cp --reflink=auto --no-preserve=mode -R $bowerComponents/bower_components . # note 2
    ${pkgs.nodePackages.gulp}/bin/gulp build # note 4

    runHook postBuild
  &#x27;&#x27;;

  installPhase = &#x27;&#x27;
    runHook preInstall

    mv gulpdist $out

    runHook postInstall
  &#x27;&#x27;;
}
</code></pre><p>A few notes about <a class="link" href="index.html#ex-buildBowerComponentsDefaultNix" title="Example Full example — default.nix" >Full example — <code class="literal">default.nix</code></a>:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>The result of <code class="literal">buildBowerComponents</code> is an input to the frontend build.</p></li><li class="listitem"><p>Whether to symlink or copy the <code class="filename">bower_components</code> directory depends on the build tool in use.
In this case a copy is used to avoid <span class="command"><strong>gulp</strong></span> silliness with permissions.</p></li><li class="listitem"><p><span class="command"><strong>gulp</strong></span> requires <code class="literal">HOME</code> to refer to a writeable directory.</p></li><li class="listitem"><p>The actual build command in this example is <span class="command"><strong>gulp</strong></span>. Other tools could be used instead.</p></li></ol></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-bower2nix-troubleshooting" class="title" >Troubleshooting   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="enocache-errors-from-buildbowercomponents" class="title" >ENOCACHE errors from buildBowerComponents   </h4>  </div> </div></div><p>This means that Bower was looking for a package version which doesn’t exist in the generated <code class="literal">bower-packages.nix</code>.</p><p>If <code class="literal">bower.json</code> has been updated, then run <code class="literal">bower2nix</code> again.</p><p>It could also be a bug in <code class="literal">bower2nix</code> or <code class="literal">fetchbower</code>. If possible, try reformulating the version specification in <code class="literal">bower.json</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-chicken" class="title" style="clear: both">CHICKEN   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-chicken-using">Using Eggs</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-chicken-updating-eggs">Updating Eggs</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-chicken-adding-eggs">Adding Eggs</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-chicken-override-scope">Override Scope</a> </span></dt> </dl></div><p><a class="link" href="https://call-cc.org/"  target="_top">CHICKEN</a> is a
<a class="link" href="https://schemers.org/Documents/Standards/R5RS/HTML/"  target="_top">R⁵RS</a>-compliant Scheme
compiler. It includes an interactive mode and a custom package format, “eggs”.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-chicken-using" class="title" >Using Eggs   </h3>  </div> </div></div><p>Eggs described in nixpkgs are available inside the
<code class="literal">chickenPackages.chickenEggs</code> attrset. Including an egg as a build input is
done in the typical Nix fashion. For example, to include support for <a class="link" href="https://srfi.schemers.org/srfi-189/srfi-189.html"  target="_top">SRFI
189</a> in a derivation, one
might write:</p><pre><code class="programlisting nix">{
  buildInputs = [
    chicken
    chickenPackages.chickenEggs.srfi-189
  ];
}
</code></pre><p>Both <code class="literal">chicken</code> and its eggs have a setup hook which configures the environment
variables <code class="literal">CHICKEN_INCLUDE_PATH</code> and <code class="literal">CHICKEN_REPOSITORY_PATH</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-chicken-updating-eggs" class="title" >Updating Eggs   </h3>  </div> </div></div><p>nixpkgs only knows about a subset of all published eggs. It uses
<a class="link" href="https://github.com/the-kenny/egg2nix"  target="_top">egg2nix</a> to generate a
package set from a list of eggs to include.</p><p>The package set is regenerated by running the following shell commands:</p><pre><code class="programlisting">$ nix-shell -p chickenPackages.egg2nix
$ cd pkgs/development/compilers/chicken/5/
$ egg2nix eggs.scm &gt; eggs.nix
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-chicken-adding-eggs" class="title" >Adding Eggs   </h3>  </div> </div></div><p>When we run <code class="literal">egg2nix</code>, we obtain one collection of eggs with
mutually-compatible versions. This means that when we add new eggs, we may
need to update existing eggs. To keep those separate, follow the procedure for
updating eggs before including more eggs.</p><p>To include more eggs, edit <code class="literal">pkgs/development/compilers/chicken/5/eggs.scm</code>.
The first section of this file lists eggs which are required by <code class="literal">egg2nix</code>
itself; all other eggs go into the second section. After editing, follow the
procedure for updating eggs.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-chicken-override-scope" class="title" >Override Scope   </h3>  </div> </div></div><p>The chicken package and its eggs, respectively, reside in a scope. This means,
the scope can be overridden to effect other packages in it.</p><p>This example shows how to use a local copy of <code class="literal">srfi-180</code> and have it affect
all the other eggs:</p><pre><code class="programlisting nix">let
  myChickenPackages = pkgs.chickenPackages.overrideScope (
    self: super: {
      # The chicken package itself can be overridden to effect the whole ecosystem.
      # chicken = super.chicken.overrideAttrs {
      #   src = ...
      # };

      chickenEggs = super.chickenEggs.overrideScope (
        eggself: eggsuper: {
          srfi-180 = eggsuper.srfi-180.overrideAttrs {
            # path to a local copy of srfi-180
            src = &lt;...&gt;;
          };
        }
      );
    }
  );
  # Here, `myChickenPackages.chickenEggs.json-rpc`, which depends on `srfi-180` will use
  # the local copy of `srfi-180`.
in
&lt;...&gt;
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-coq" class="title" style="clear: both">Coq and coq packages   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#coq-derivation-coq">Coq derivation: <code class="literal">coq</code></a> </span></dt><dt> <span class="section">  <a href="index.html#coq-packages-attribute-sets-coqpackages">Coq packages attribute sets: <code class="literal">coqPackages</code></a> </span></dt><dt> <span class="section">  <a href="index.html#coq-overriding-packages">Three ways of overriding Coq packages</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="coq-derivation-coq" class="title" >Coq derivation: <code class="literal">coq</code>   </h3>  </div> </div></div><p>The Coq derivation is overridable through the <code class="literal">coq.override overrides</code>, where overrides is an attribute set which contains the arguments to override. We recommend overriding either of the following</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">version</code> (optional, defaults to the latest version of Coq selected for nixpkgs, see <code class="literal">pkgs/top-level/coq-packages</code> to witness this choice), which follows the conventions explained in the <code class="literal">coqPackages</code> section below,</p></li><li class="listitem"><p><code class="literal">customOCamlPackages</code> (optional, defaults to <code class="literal">null</code>, which lets Coq choose a version automatically), which can be set to any of the ocaml packages attribute of <code class="literal">ocaml-ng</code> (such as <code class="literal">ocaml-ng.ocamlPackages_4_10</code> which is the default for Coq 8.11 for example).</p></li><li class="listitem"><p><code class="literal">coq-version</code> (optional, defaults to the short version e.g. “8.10”), is a version number of the form “x.y” that indicates which Coq’s version build behavior to mimic when using a source which is not a release. E.g. <code class="literal">coq.override { version = &quot;d370a9d1328a4e1cdb9d02ee032f605a9d94ec7a&quot;; coq-version = &quot;8.10&quot;; }</code>.</p></li></ul></div><p>The associated package set can be obtained using <code class="literal">mkCoqPackages coq</code>, where <code class="literal">coq</code> is the derivation to use.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="coq-packages-attribute-sets-coqpackages" class="title" >Coq packages attribute sets: <code class="literal">coqPackages</code>   </h3>  </div> </div></div><p>The recommended way of defining a derivation for a Coq library, is to use the <code class="literal">coqPackages.mkCoqDerivation</code> function, which is essentially a specialization of <code class="literal">mkDerivation</code> taking into account most of the specifics of Coq libraries. The following attributes are supported:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pname</code> (required) is the name of the package,</p></li><li class="listitem"><p><code class="literal">version</code> (optional, defaults to <code class="literal">null</code>), is the version to fetch and build,
this attribute is interpreted in several ways depending on its type and pattern:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>if it is a known released version string, i.e. from the <code class="literal">release</code> attribute below, the according release is picked, and the <code class="literal">version</code> attribute of the resulting derivation is set to this release string,</p></li><li class="listitem"><p>if it is a majorMinor <code class="literal">&quot;x.y&quot;</code> prefix of a known released version (as defined above), then the latest <code class="literal">&quot;x.y.z&quot;</code> known released version is selected (for the ordering given by <code class="literal">versionAtLeast</code>),</p></li><li class="listitem"><p>if it is a path or a string representing an absolute path (i.e. starting with <code class="literal">&quot;/&quot;</code>), the provided path is selected as a source, and the <code class="literal">version</code> attribute of the resulting derivation is set to <code class="literal">&quot;dev&quot;</code>,</p></li><li class="listitem"><p>if it is a string of the form <code class="literal">owner:branch</code> then it tries to download the <code class="literal">branch</code> of owner <code class="literal">owner</code> for a project of the same name using the same vcs, and the <code class="literal">version</code> attribute of the resulting derivation is set to <code class="literal">&quot;dev&quot;</code>, additionally if the owner is not provided (i.e. if the <code class="literal">owner:</code> prefix is missing), it defaults to the original owner of the package (see below),</p></li><li class="listitem"><p>if it is a string of the form <code class="literal">&quot;#N&quot;</code>, and the domain is github, then it tries to download the current head of the pull request <code class="literal">#N</code> from github,</p></li></ul></div></li><li class="listitem"><p><code class="literal">defaultVersion</code> (optional). Coq libraries may be compatible with some specific versions of Coq only. The <code class="literal">defaultVersion</code> attribute is used when no <code class="literal">version</code> is provided (or if <code class="literal">version = null</code>) to select the version of the library to use by default, depending on the context. This selection will mainly depend on a <code class="literal">coq</code> version number but also possibly on other packages versions (e.g. <code class="literal">mathcomp</code>). If its value ends up to be <code class="literal">null</code>, the package is marked for removal in end-user <code class="literal">coqPackages</code> attribute set.</p></li><li class="listitem"><p><code class="literal">release</code> (optional, defaults to <code class="literal">{}</code>), lists all the known releases of the library and for each of them provides an attribute set with at least a <code class="literal">hash</code> attribute (you may put the empty string <code class="literal">&quot;&quot;</code> in order to automatically insert a fake hash, this will trigger an error which will allow you to find the correct hash), each attribute set of the list of releases also takes optional overloading arguments for the fetcher as below (i.e.<code class="literal">domain</code>, <code class="literal">owner</code>, <code class="literal">repo</code>, <code class="literal">rev</code>, <code class="literal">artifact</code> assuming the default fetcher is used) and optional overrides for the result of the fetcher (i.e. <code class="literal">version</code> and <code class="literal">src</code>).</p></li><li class="listitem"><p><code class="literal">fetcher</code> (optional, defaults to a generic fetching mechanism supporting github or gitlab based infrastructures), is a function that takes at least an <code class="literal">owner</code>, a <code class="literal">repo</code>, a <code class="literal">rev</code>, and a <code class="literal">hash</code> and returns an attribute set with a <code class="literal">version</code> and <code class="literal">src</code>.</p></li><li class="listitem"><p><code class="literal">repo</code> (optional, defaults to the value of <code class="literal">pname</code>),</p></li><li class="listitem"><p><code class="literal">owner</code> (optional, defaults to <code class="literal">&quot;coq-community&quot;</code>).</p></li><li class="listitem"><p><code class="literal">domain</code> (optional, defaults to <code class="literal">&quot;github.com&quot;</code>), domains including the strings <code class="literal">&quot;github&quot;</code> or <code class="literal">&quot;gitlab&quot;</code> in their names are automatically supported, otherwise, one must change the <code class="literal">fetcher</code> argument to support them (cf <code class="literal">pkgs/development/coq-modules/heq/default.nix</code> for an example),</p></li><li class="listitem"><p><code class="literal">releaseRev</code> (optional, defaults to <code class="literal">(v: v)</code>), provides a default mapping from release names to revision hashes/branch names/tags,</p></li><li class="listitem"><p><code class="literal">releaseArtifact</code> (optional, defaults to <code class="literal">(v: null)</code>), provides a default mapping from release names to artifact names (only works for github artifact for now),</p></li><li class="listitem"><p><code class="literal">displayVersion</code> (optional), provides a way to alter the computation of <code class="literal">name</code> from <code class="literal">pname</code>, by explaining how to display version numbers,</p></li><li class="listitem"><p><code class="literal">namePrefix</code> (optional, defaults to <code class="literal">[ &quot;coq&quot; ]</code>), provides a way to alter the computation of <code class="literal">name</code> from <code class="literal">pname</code>, by explaining which dependencies must occur in <code class="literal">name</code>,</p></li><li class="listitem"><p><code class="literal">nativeBuildInputs</code> (optional), is a list of executables that are required to build the current derivation, in addition to the default ones (namely <code class="literal">which</code>, <code class="literal">dune</code> and <code class="literal">ocaml</code> depending on whether <code class="literal">useDune</code>, <code class="literal">useDuneifVersion</code> and <code class="literal">mlPlugin</code> are set).</p></li><li class="listitem"><p><code class="literal">extraNativeBuildInputs</code> (optional, deprecated), an additional list of derivation to add to <code class="literal">nativeBuildInputs</code>,</p></li><li class="listitem"><p><code class="literal">overrideNativeBuildInputs</code> (optional) replaces the default list of derivation to which <code class="literal">nativeBuildInputs</code> and <code class="literal">extraNativeBuildInputs</code> adds extra elements,</p></li><li class="listitem"><p><code class="literal">buildInputs</code> (optional), is a list of libraries and dependencies that are required to build and run the current derivation, in addition to the default one <code class="literal">[ coq ]</code>,</p></li><li class="listitem"><p><code class="literal">extraBuildInputs</code> (optional, deprecated), an additional list of derivation to add to <code class="literal">buildInputs</code>,</p></li><li class="listitem"><p><code class="literal">overrideBuildInputs</code> (optional) replaces the default list of derivation to which <code class="literal">buildInputs</code> and <code class="literal">extraBuildInputs</code> adds extras elements,</p></li><li class="listitem"><p><code class="literal">propagatedBuildInputs</code> (optional) is passed as is to <code class="literal">mkDerivation</code>, we recommend to use this for Coq libraries and Coq plugin dependencies, as this makes sure the paths of the compiled libraries and plugins will always be added to the build environments of subsequent derivation, which is necessary for Coq packages to work correctly,</p></li><li class="listitem"><p><code class="literal">mlPlugin</code> (optional, defaults to <code class="literal">false</code>). Some extensions (plugins) might require OCaml and sometimes other OCaml packages. Standard dependencies can be added by setting the current option to <code class="literal">true</code>. For a finer grain control, the <code class="literal">coq.ocamlPackages</code> attribute can be used in <code class="literal">nativeBuildInputs</code>, <code class="literal">buildInputs</code>, and <code class="literal">propagatedBuildInputs</code> to depend on the same package set Coq was built against.</p></li><li class="listitem"><p><code class="literal">useDuneifVersion</code> (optional, default to <code class="literal">(x: false)</code> uses Dune to build the package if the provided predicate evaluates to true on the version, e.g. <code class="literal">useDuneifVersion = versions.isGe &quot;1.1&quot;</code>  will use dune if the version of the package is greater or equal to <code class="literal">&quot;1.1&quot;</code>,</p></li><li class="listitem"><p><code class="literal">useDune</code> (optional, defaults to <code class="literal">false</code>) uses Dune to build the package if set to true, the presence of this attribute overrides the behavior of the previous one.</p></li><li class="listitem"><p><code class="literal">opam-name</code> (optional, defaults to concatenating with a dash separator the components of <code class="literal">namePrefix</code> and <code class="literal">pname</code>), name of the Dune package to build.</p></li><li class="listitem"><p><code class="literal">enableParallelBuilding</code> (optional, defaults to <code class="literal">true</code>), since it is activated by default, we provide a way to disable it.</p></li><li class="listitem"><p><code class="literal">extraInstallFlags</code> (optional), allows to extend <code class="literal">installFlags</code> which initializes the variable <code class="literal">COQMF_COQLIB</code> so as to install in the proper subdirectory. Indeed Coq libraries should be installed in <code class="literal">$(out)/lib/coq/${coq.coq-version}/user-contrib/</code>. Such directories are automatically added to the <code class="literal">$COQPATH</code> environment variable by the hook defined in the Coq derivation.</p></li><li class="listitem"><p><code class="literal">setCOQBIN</code> (optional, defaults to <code class="literal">true</code>), by default, the environment variable <code class="literal">$COQBIN</code> is set to the current Coq’s binary, but one can disable this behavior by setting it to <code class="literal">false</code>,</p></li><li class="listitem"><p><code class="literal">useMelquiondRemake</code> (optional, default to <code class="literal">null</code>) is an attribute set, which, if given, overloads the <code class="literal">preConfigurePhases</code>, <code class="literal">configureFlags</code>, <code class="literal">buildPhase</code>, and <code class="literal">installPhase</code> attributes of the derivation for a specific use in libraries using <code class="literal">remake</code> as set up by Guillaume Melquiond for <code class="literal">flocq</code>, <code class="literal">gappalib</code>, <code class="literal">interval</code>, and <code class="literal">coquelicot</code> (see the corresponding derivation for concrete examples of use of this option). For backward compatibility, the attribute <code class="literal">useMelquiondRemake.logpath</code> must be set to the logical root of the library (otherwise, one can pass <code class="literal">useMelquiondRemake = {}</code> to activate this without backward compatibility).</p></li><li class="listitem"><p><code class="literal">dropAttrs</code>, <code class="literal">keepAttrs</code>, <code class="literal">dropDerivationAttrs</code> are all optional and allow to tune which attribute is added or removed from the final call to <code class="literal">mkDerivation</code>.</p></li></ul></div><p>It also takes other standard <code class="literal">mkDerivation</code> attributes, they are added as such, except for <code class="literal">meta</code> which extends an automatically computed <code class="literal">meta</code> (where the <code class="literal">platform</code> is the same as <code class="literal">coq</code> and the homepage is automatically computed).</p><p>Here is a simple package example. It is a pure Coq library, thus it depends on Coq. It builds on the Mathematical Components library, thus it also takes some <code class="literal">mathcomp</code> derivations as <code class="literal">extraBuildInputs</code>.</p><pre><code class="programlisting nix">{
  lib,
  mkCoqDerivation,
  version ? null,
  coq,
  mathcomp,
  mathcomp-finmap,
  mathcomp-bigenough,
}:

mkCoqDerivation {
  # namePrefix leads to e.g. `name = coq8.11-mathcomp1.11-multinomials-1.5.2`
  namePrefix = [
    &quot;coq&quot;
    &quot;mathcomp&quot;
  ];
  pname = &quot;multinomials&quot;;
  owner = &quot;math-comp&quot;;
  inherit version;
  defaultVersion =
    with lib.versions;
    lib.switch
      [ coq.version mathcomp.version ]
      [
        {
          cases = [
            (range &quot;8.7&quot; &quot;8.12&quot;)
            (isEq &quot;1.11&quot;)
          ];
          out = &quot;1.5.2&quot;;
        }
        {
          cases = [
            (range &quot;8.7&quot; &quot;8.11&quot;)
            (range &quot;1.8&quot; &quot;1.10&quot;)
          ];
          out = &quot;1.5.0&quot;;
        }
        {
          cases = [
            (range &quot;8.7&quot; &quot;8.10&quot;)
            (range &quot;1.8&quot; &quot;1.10&quot;)
          ];
          out = &quot;1.4&quot;;
        }
        {
          cases = [
            (isEq &quot;8.6&quot;)
            (range &quot;1.6&quot; &quot;1.7&quot;)
          ];
          out = &quot;1.1&quot;;
        }
      ]
      null;
  release = {
    &quot;1.5.2&quot;.hash = &quot;sha256-mjCx9XKa38Nz9E6wNK7YSqHdJ7YTua5fD3d6J4e7WpU=&quot;;
    &quot;1.5.1&quot;.hash = &quot;sha256-Q8tm0y2FQAt2V1kZYkDlHWRia/lTvXAMVjdmzEV11I4=&quot;;
    &quot;1.5.0&quot;.hash = &quot;sha256-HIK0f21G69oEW8JG46gSBde/Q2LR3GiBCv680gHbmRg=&quot;;
    &quot;1.5.0&quot;.rev = &quot;1.5&quot;;
    &quot;1.4&quot;.hash = &quot;sha256-F9g3MSIr3B6UZ3p8QWjz3/Jpw9sudJ+KRlvjiHSO024=&quot;;
    &quot;1.3&quot;.hash = &quot;sha256-BPJTlAL0ETHvLMBslE0KFVt3DNoaGuMrHt2SBGyJe1A=&quot;;
    &quot;1.2&quot;.hash = &quot;sha256-mHXBXSLYO4BN+jfN50y/+XCx0Qq5g4Ac2Y/qlsbgAdY=&quot;;
    &quot;1.1&quot;.hash = &quot;sha256-ejAsMQbB/LtU9j+g160VdGXULrCe9s0gBWzyhKqmCuE=&quot;;
    &quot;1.0&quot;.hash = &quot;sha256-tZTOltEBBKWciDxDMs/Ye4Jnq/33CANrHJ4FBMPtq+I=&quot;;
  };

  propagatedBuildInputs = [
    mathcomp.ssreflect
    mathcomp.algebra
    mathcomp-finmap
    mathcomp-bigenough
  ];

  meta = {
    description = &quot;Coq/SSReflect Library for Monoidal Rings and Multinomials&quot;;
    license = lib.licenses.cecill-c;
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="coq-overriding-packages" class="title" >Three ways of overriding Coq packages   </h3>  </div> </div></div><p>There are three distinct ways of changing a Coq package by overriding one of its values: <code class="literal">.override</code>, <code class="literal">overrideCoqDerivation</code>, and <code class="literal">.overrideAttrs</code>.  This section explains what sort of values can be overridden with each of these methods.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="coq-override" class="title" ><code class="literal">.override</code>   </h4>  </div> </div></div><p><code class="literal">.override</code> lets you change arguments to a Coq derivation.  In the case of the <code class="literal">multinomials</code> package above, <code class="literal">.override</code> would let you override arguments like <code class="literal">mkCoqDerivation</code>, <code class="literal">version</code>, <code class="literal">coq</code>, <code class="literal">mathcomp</code>, <code class="literal">mathcom-finmap</code>, etc.</p><p>For example, assuming you have a special <code class="literal">mathcomp</code> dependency you want to use, here is how you could override the <code class="literal">mathcomp</code> dependency:</p><pre><code class="programlisting nix">multinomials.override { mathcomp = my-special-mathcomp; }
</code></pre><p>In Nixpkgs, all Coq derivations take a <code class="literal">version</code> argument.  This can be overridden in order to easily use a different version:</p><pre><code class="programlisting nix">coqPackages.multinomials.override { version = &quot;1.5.1&quot;; }
</code></pre><p>Refer to <a class="xref" href="index.html#coq-packages-attribute-sets-coqpackages" title="Coq packages attribute sets: coqPackages" >the section called “Coq packages attribute sets: <code class="literal">coqPackages</code>”</a> for all the different formats that you can potentially pass to <code class="literal">version</code>, as well as the restrictions.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="coq-overrideCoqDerivation" class="title" ><code class="literal">overrideCoqDerivation</code>   </h4>  </div> </div></div><p>The <code class="literal">overrideCoqDerivation</code> function lets you easily change arguments to <code class="literal">mkCoqDerivation</code>.  These arguments are described in <a class="xref" href="index.html#coq-packages-attribute-sets-coqpackages" title="Coq packages attribute sets: coqPackages" >the section called “Coq packages attribute sets: <code class="literal">coqPackages</code>”</a>.</p><p>For example, here is how you could locally add a new release of the <code class="literal">multinomials</code> library, and set the <code class="literal">defaultVersion</code> to use this release:</p><pre><code class="programlisting nix">coqPackages.lib.overrideCoqDerivation {
  defaultVersion = &quot;2.0&quot;;
  release.&quot;2.0&quot;.hash = &quot;sha256-czoP11rtrIM7+OLdMisv2EF7n/IbGuwFxHiPtg3qCNM=&quot;;
} coqPackages.multinomials
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="coq-overrideAttrs" class="title" ><code class="literal">.overrideAttrs</code>   </h4>  </div> </div></div><p><code class="literal">.overrideAttrs</code> lets you override arguments to the underlying <code class="literal">stdenv.mkDerivation</code> call. Internally, <code class="literal">mkCoqDerivation</code> uses <code class="literal">stdenv.mkDerivation</code> to create derivations for Coq libraries.  You can override arguments to <code class="literal">stdenv.mkDerivation</code> with <code class="literal">.overrideAttrs</code>.</p><p>For instance, here is how you could add some code to be performed in the derivation after installation is complete:</p><pre><code class="programlisting nix">coqPackages.multinomials.overrideAttrs (oldAttrs: {
  postInstall = oldAttrs.postInstall or &quot;&quot; + &#x27;&#x27;
    echo &quot;you can do anything you want here&quot;
  &#x27;&#x27;;
})
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-cosmic" class="title" style="clear: both">COSMIC   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-cosmic-packaging">Packaging COSMIC applications</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-cosmic-common-issues">Frequently encountered issues</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-cosmic-packaging" class="title" >Packaging COSMIC applications   </h3>  </div> </div></div><p>COSMIC (Computer Operating System Main Interface Components) is a desktop environment developed by
System76, primarily for the Pop!_OS Linux distribution. Applications in the COSMIC ecosystem are
written in Rust and use libcosmic, which builds on the Iced GUI framework. This section explains
how to properly package and integrate COSMIC applications within Nix.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-cosmic-libcosmic-app-hook" class="title" >libcosmicAppHook   </h4>  </div> </div></div><p>The <code class="literal">libcosmicAppHook</code> is a setup hook that helps with this by automatically configuring
and wrapping applications based on libcosmic. It handles many common requirements like:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Setting up proper linking for libraries that may be dlopen’d by libcosmic/iced apps</p></li><li class="listitem"><p>Configuring XDG paths for settings schemas, icons, and other resources</p></li><li class="listitem"><p>Managing Vergen environment variables for build-time information</p></li><li class="listitem"><p>Setting up Rust linker flags for specific libraries</p></li></ul></div><p>To use the hook, simply add it to your package’s <code class="literal">nativeBuildInputs</code>:</p><pre><code class="programlisting nix">{
  lib,
  rustPlatform,
  libcosmicAppHook,
}:
rustPlatform.buildRustPackage {
  # ...
  nativeBuildInputs = [ libcosmicAppHook ];
  # ...
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-cosmic-settings-fallback" class="title" >Settings fallback   </h4>  </div> </div></div><p>COSMIC applications use libcosmic’s UI components, which may need access to theme settings. The
<code class="literal">cosmic-settings</code> package provides default theme settings as a fallback in its <code class="literal">share</code> directory.
By default, <code class="literal">libcosmicAppHook</code> includes this fallback path in <code class="literal">XDG_DATA_DIRS</code>, ensuring that COSMIC
applications will have access to theme settings even if they aren’t available elsewhere in the
system.</p><p>This fallback behavior can be disabled by setting <code class="literal">includeSettings = false</code> when including the hook:</p><pre><code class="programlisting nix">{
  lib,
  rustPlatform,
  libcosmicAppHook,
}:
let
  # Get build-time version of libcosmicAppHook
  libcosmicAppHook&#x27; = (libcosmicAppHook.__spliced.buildHost or libcosmicAppHook).override {
    includeSettings = false;
  };
in
rustPlatform.buildRustPackage {
  # ...
  nativeBuildInputs = [ libcosmicAppHook&#x27; ];
  # ...
}
</code></pre><p>Note that <code class="literal">cosmic-settings</code> is a separate application and not a part of the libcosmic settings
system itself. It’s included by default in <code class="literal">libcosmicAppHook</code> only to provide these fallback theme
settings.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-cosmic-icons" class="title" >Icons   </h4>  </div> </div></div><p>COSMIC applications can use icons from the COSMIC icon theme. While COSMIC applications can build
and run without these icons, they would be missing visual elements. The <code class="literal">libcosmicAppHook</code>
automatically includes <code class="literal">cosmic-icons</code> in the wrapped application’s <code class="literal">XDG_DATA_DIRS</code> as a fallback,
ensuring that the application has access to its required icons even if the system doesn’t have the
COSMIC icon theme installed globally.</p><p>Unlike the <code class="literal">cosmic-settings</code> fallback, the <code class="literal">cosmic-icons</code> fallback cannot be removed or disabled, as
it is essential for COSMIC applications to have access to these icons for proper visual rendering.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-cosmic-runtime-libraries" class="title" >Runtime Libraries   </h4>  </div> </div></div><p>COSMIC applications built on libcosmic and Iced require several runtime libraries that are dlopen’d
rather than linked directly. The <code class="literal">libcosmicAppHook</code> ensures that these libraries are correctly
linked by setting appropriate Rust linker flags. The libraries handled include:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Graphics libraries (EGL, Vulkan)</p></li><li class="listitem"><p>Input libraries (xkbcommon)</p></li><li class="listitem"><p>Display server protocols (Wayland, X11)</p></li></ul></div><p>This ensures that the applications will work correctly at runtime, even though they use dynamic
loading for these dependencies.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-cosmic-custom-wrapper-args" class="title" >Adding custom wrapper arguments   </h4>  </div> </div></div><p>You can pass additional arguments to the wrapper using <code class="literal">libcosmicAppWrapperArgs</code> in the <code class="literal">preFixup</code> hook:</p><pre><code class="programlisting nix">{
  lib,
  rustPlatform,
  libcosmicAppHook,
}:
rustPlatform.buildRustPackage {
  # ...
  preFixup = &#x27;&#x27;
    libcosmicAppWrapperArgs+=(--set-default ENVIRONMENT_VARIABLE VALUE)
  &#x27;&#x27;;
  # ...
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-cosmic-common-issues" class="title" >Frequently encountered issues   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-cosmic-common-issues-vergen" class="title" >Setting up Vergen environment variables   </h4>  </div> </div></div><p>Many COSMIC applications use the Vergen Rust crate for build-time information. The <code class="literal">libcosmicAppHook</code>
automatically sets up the <code class="literal">VERGEN_GIT_COMMIT_DATE</code> environment variable based on <code class="literal">SOURCE_DATE_EPOCH</code>
to ensure reproducible builds.</p><p>However, some applications may explicitly require additional Vergen environment variables.
Without these properly set, you may encounter build failures with errors like:</p><pre><code class="programlisting">&gt;   cargo:rerun-if-env-changed=VERGEN_GIT_COMMIT_DATE
&gt;   cargo:rerun-if-env-changed=VERGEN_GIT_SHA
&gt;
&gt;   --- stderr
&gt;   Error: no suitable &#x27;git&#x27; command found!
&gt; warning: build failed, waiting for other jobs to finish...
</code></pre><p>While <code class="literal">libcosmicAppHook</code> handles <code class="literal">VERGEN_GIT_COMMIT_DATE</code>, you may need to explicitly set other
variables. For applications that require these variables, you should set them directly in the
package definition:</p><pre><code class="programlisting nix">{
  lib,
  rustPlatform,
  libcosmicAppHook,
}:
rustPlatform.buildRustPackage {
  # ...
  env = {
    VERGEN_GIT_COMMIT_DATE = &quot;2025-01-01&quot;;
    VERGEN_GIT_SHA = &quot;0000000000000000000000000000000000000000&quot;; # SHA-1 hash of the commit
  };
  # ...
}
</code></pre><p>Not all COSMIC applications require these variables, but for those that do, setting them explicitly
will prevent build failures.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="crystal" class="title" style="clear: both">Crystal   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#building-a-crystal-package">Building a Crystal package</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="building-a-crystal-package" class="title" >Building a Crystal package   </h3>  </div> </div></div><p>This section uses <a class="link" href="https://github.com/mint-lang/mint"  target="_top">Mint</a> as an example for how to build a Crystal package.</p><p>If the Crystal project has any dependencies, the first step is to get a <code class="literal">shards.nix</code> file encoding those. Get a copy of the project and go to its root directory such that its <code class="literal">shard.lock</code> file is in the current directory. Executable projects should usually commit the <code class="literal">shard.lock</code> file, but sometimes that’s not the case, which means you need to generate it yourself. With an existing <code class="literal">shard.lock</code> file, <code class="literal">crystal2nix</code> can be run.</p><pre><code class="programlisting bash">$ git clone https://github.com/mint-lang/mint
$ cd mint
$ git checkout 0.5.0
$ if [ ! -f shard.lock ]; then nix-shell -p shards --run &quot;shards lock&quot;; fi
$ nix-shell -p crystal2nix --run crystal2nix
</code></pre><p>This should have generated a <code class="literal">shards.nix</code> file.</p><p>Next create a Nix file for your derivation and use <code class="literal">pkgs.crystal.buildCrystalPackage</code> as follows:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };
crystal.buildCrystalPackage rec {
  pname = &quot;mint&quot;;
  version = &quot;0.5.0&quot;;

  src = fetchFromGitHub {
    owner = &quot;mint-lang&quot;;
    repo = &quot;mint&quot;;
    rev = version;
    hash = &quot;sha256-dFN9l5fgrM/TtOPqlQvUYgixE4KPr629aBmkwdDoq28=&quot;;
  };

  # Insert the path to your shards.nix file here
  shardsFile = ./shards.nix;

  # ...
}
</code></pre><p>This won’t build anything yet, because we haven’t told it what files build. We can specify a mapping from binary names to source files with the <code class="literal">crystalBinaries</code> attribute. The project’s compilation instructions should show this. For Mint, the binary is called “mint”, which is compiled from the source file <code class="literal">src/mint.cr</code>, so we’ll specify this as follows:</p><pre><code class="programlisting nix">{
  crystalBinaries.mint.src = &quot;src/mint.cr&quot;;

  # ...
}
</code></pre><p>Additionally you can override the default <code class="literal">crystal build</code> options (which are currently <code class="literal">--release --progress --no-debug --verbose</code>) with</p><pre><code class="programlisting nix">{
  crystalBinaries.mint.options = [
    &quot;--release&quot;
    &quot;--verbose&quot;
  ];
}
</code></pre><p>Depending on the project, you might need additional steps to get it to compile successfully. In Mint’s case, we need to link against openssl, so in the end the Nix file looks as follows:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };
crystal.buildCrystalPackage rec {
  version = &quot;0.5.0&quot;;
  pname = &quot;mint&quot;;
  src = fetchFromGitHub {
    owner = &quot;mint-lang&quot;;
    repo = &quot;mint&quot;;
    rev = version;
    hash = &quot;sha256-dFN9l5fgrM/TtOPqlQvUYgixE4KPr629aBmkwdDoq28=&quot;;
  };

  shardsFile = ./shards.nix;
  crystalBinaries.mint.src = &quot;src/mint.cr&quot;;

  buildInputs = [ openssl ];
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="cuda" class="title" style="clear: both">CUDA   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#cuda-user-guide">User Guide</a> </span></dt><dt> <span class="section">  <a href="index.html#cuda-contributing">Contributing</a> </span></dt> </dl></div><p>Compute Unified Device Architecture (CUDA) is a parallel computing platform and application programming interface (API) model created by NVIDIA. It’s commonly used to accelerate computationally intensive problems and has been widely adopted for high-performance computing (HPC) and machine learning (ML) applications.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="cuda-user-guide" class="title" >User Guide   </h3>  </div> </div></div><p>Packages provided by NVIDIA which require CUDA are typically stored in CUDA package sets.</p><p>Nixpkgs provides a number of CUDA package sets, each based on a different CUDA release. Top-level attributes that provide access to CUDA package sets follow these naming conventions:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">cudaPackages_x_y</code>: A major-minor-versioned package set for a specific CUDA release, where <code class="literal">x</code> and <code class="literal">y</code> are the major and minor versions of the CUDA release.</p></li><li class="listitem"><p><code class="literal">cudaPackages_x</code>: A major-versioned alias to the major-minor-versioned CUDA package set with the latest widely supported major CUDA release.</p></li><li class="listitem"><p><code class="literal">cudaPackages</code>: An unversioned alias to the major-versioned alias for the latest widely supported CUDA release. The package set referenced by this alias is also referred to as the “default” CUDA package set.</p></li></ul></div><p>It is recommended to use the unversioned <code class="literal">cudaPackages</code> attribute. While versioned package sets are available (e.g., <code class="literal">cudaPackages_12_2</code>), they are periodically removed.</p><p>Here are two examples to illustrate the naming conventions:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>If <code class="literal">cudaPackages_12_8</code> is the latest release in the 12.x series, but core libraries like OpenCV or ONNX Runtime fail to build with it, <code class="literal">cudaPackages_12</code> may alias <code class="literal">cudaPackages_12_6</code> instead of <code class="literal">cudaPackages_12_8</code>.</p></li><li class="listitem"><p>If <code class="literal">cudaPackages_13_1</code> is the latest release, but core libraries like PyTorch or Torch Vision fail to build with it, <code class="literal">cudaPackages</code> may alias <code class="literal">cudaPackages_12</code> instead of <code class="literal">cudaPackages_13</code>.</p></li></ul></div><p>All CUDA package sets include common CUDA packages like <code class="literal">libcublas</code>, <code class="literal">cudnn</code>, <code class="literal">tensorrt</code>, and <code class="literal">nccl</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cuda-configuring-nixpkgs-for-cuda" class="title" >Configuring Nixpkgs for CUDA   </h4>  </div> </div></div><p>CUDA support is not enabled by default in Nixpkgs. To enable CUDA support, make sure Nixpkgs is imported with a configuration similar to the following:</p><pre><code class="programlisting nix">{
  allowUnfreePredicate =
    let
      ensureList = x: if builtins.isList x then x else [ x ];
    in
    package:
    builtins.all (
      license:
      license.free
      || builtins.elem license.shortName [
        &quot;CUDA EULA&quot;
        &quot;cuDNN EULA&quot;
        &quot;cuSPARSELt EULA&quot;
        &quot;cuTENSOR EULA&quot;
        &quot;NVidia OptiX EULA&quot;
      ]
    ) (ensureList package.meta.license);
  cudaCapabilities = [ &lt;target-architectures&gt; ];
  cudaForwardCompat = true;
  cudaSupport = true;
}
</code></pre><p>The majority of CUDA packages are unfree, so either <code class="literal">allowUnfreePredicate</code> or <code class="literal">allowUnfree</code> should be set.</p><p>The <code class="literal">cudaSupport</code> configuration option is used by packages to conditionally enable CUDA-specific functionality. This configuration option is commonly used by packages which can be built with or without CUDA support.</p><p>The <code class="literal">cudaCapabilities</code> configuration option specifies a list of CUDA capabilities. Packages may use this option to control device code generation to take advantage of architecture-specific functionality, speed up compile times by producing less device code, or slim package closures. For example, you can build for Ada Lovelace GPUs with <code class="literal">cudaCapabilities = [ &quot;8.9&quot; ];</code>. If <code class="literal">cudaCapabilities</code> is not provided, the default value is calculated per-package set, derived from a list of GPUs supported by that CUDA version. Please consult <a class="link" href="https://en.wikipedia.org/wiki/CUDA#GPUs_supported"  target="_top">supported GPUs</a> for specific cards. Library maintainers should consult <a class="link" href="https://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/"  target="_top">NVCC Docs</a> and its release notes.</p><div class="caution"><h3 class="title">Caution</h3><p>Certain CUDA capabilities are not targeted by default, including capabilities belonging to the Jetson family of devices (e.g. <code class="literal">8.7</code>, which corresponds to the Jetson Orin) or non-baseline feature-sets (e.g. <code class="literal">9.0a</code>, which corresponds to the Hopper exclusive feature set). If you need to target these capabilities, you must explicitly set <code class="literal">cudaCapabilities</code> to include them.</p></div><p>The <code class="literal">cudaForwardCompat</code> boolean configuration option determines whether PTX support for future hardware is enabled.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cuda-modifying-cuda-package-sets" class="title" >Modifying CUDA package sets   </h4>  </div> </div></div><p>CUDA package sets are created by using <code class="literal">callPackage</code> on <code class="literal">pkgs/top-level/cuda-packages.nix</code> with an explicit argument for <code class="literal">cudaMajorMinorVersion</code>, a string of the form <code class="literal">&quot;&lt;major&gt;.&lt;minor&gt;&quot;</code> (e.g., <code class="literal">&quot;12.2&quot;</code>), which informs the CUDA package set tooling which version of CUDA to use. The majority of the CUDA package set tooling is available through the top-level attribute set <code class="literal">_cuda</code>, a fixed-point defined outside the CUDA package sets.</p><div class="caution"><h3 class="title">Caution</h3><p>The <code class="literal">cudaMajorMinorVersion</code> and <code class="literal">_cuda</code> attributes are not part of the CUDA package set fixed-point, but are instead provided by <code class="literal">callPackage</code> from the top-level in the construction of the package set. As such, they must be modified via the package set’s <code class="literal">override</code> attribute.</p></div><div class="caution"><h3 class="title">Caution</h3><p>As indicated by the underscore prefix, <code class="literal">_cuda</code> is an implementation detail and no guarantees are provided with respect to its stability or API. The <code class="literal">_cuda</code> attribute set is exposed only to ease creation or modification of CUDA package sets by expert, out-of-tree users.</p></div><div class="note"><h3 class="title">Note</h3><p>The <code class="literal">_cuda</code> attribute set fixed-point should be modified through its <code class="literal">extend</code> attribute.</p></div><p>The <code class="literal">_cuda.fixups</code> attribute set is a mapping from package name (<code class="literal">pname</code>) to a <code class="literal">callPackage</code>-compatible expression which will be provided to <code class="literal">overrideAttrs</code> on the result of our generic builder.</p><div class="caution"><h3 class="title">Caution</h3><p>Fixups are chosen from <code class="literal">_cuda.fixups</code> by <code class="literal">pname</code>. As a result, packages with multiple versions (e.g., <code class="literal">cudnn</code>, <code class="literal">cudnn_8_9</code>, etc.) all share a single fixup function (i.e., <code class="literal">_cuda.fixups.cudnn</code>, which is <code class="literal">pkgs/development/cuda-modules/fixups/cudnn.nix</code>).</p></div><p>As an example, you can change the fixup function used for cuDNN for only the default CUDA package set with this overlay:</p><pre><code class="programlisting nix">final: prev: {
  cudaPackages = prev.cudaPackages.override (prevArgs: {
    _cuda = prevArgs._cuda.extend (
      _: prevAttrs: {
        fixups = prevAttrs.fixups // {
          cudnn = &lt;your-fixup-function&gt;;
        };
      }
    );
  });
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cuda-extending-cuda-package-sets" class="title" >Extending CUDA package sets   </h4>  </div> </div></div><p>CUDA package sets are scopes and provide the usual <code class="literal">overrideScope</code> attribute for overriding package attributes (see the note about <code class="literal">cudaMajorMinorVersion</code> and <code class="literal">_cuda</code> in <a class="link" href="index.html#cuda-modifying-cuda-package-sets" title="Modifying CUDA package sets" >Configuring CUDA package sets</a>).</p><p>Inspired by <code class="literal">pythonPackagesExtensions</code>, the <code class="literal">_cuda.extensions</code> attribute is a list of extensions applied to every version of the CUDA package set, allowing modification of all versions of the CUDA package set without needing to know their names or explicitly enumerate and modify them. As an example, disabling <code class="literal">cuda_compat</code> across all CUDA package sets can be accomplished with this overlay:</p><pre><code class="programlisting nix">final: prev: {
  _cuda = prev._cuda.extend (
    _: prevAttrs: {
      extensions = prevAttrs.extensions ++ [ (_: _: { cuda_compat = null; }) ];
    }
  );
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cuda-using-cudapackages" class="title" >Using <code class="literal">cudaPackages</code>   </h4>  </div> </div></div><div class="caution"><h3 class="title">Caution</h3><p>A non-trivial amount of CUDA package discoverability and usability relies on the various setup hooks used by a CUDA package set. As a result, users will likely encounter issues trying to perform builds within a <code class="literal">devShell</code> without manually invoking phases.</p></div><p>To use one or more CUDA packages in an expression, give the expression a <code class="literal">cudaPackages</code> parameter, and in case CUDA support is optional, add a <code class="literal">config</code> and <code class="literal">cudaSupport</code> parameter:</p><pre><code class="programlisting nix">{
  config,
  cudaSupport ? config.cudaSupport,
  cudaPackages,
}:
&lt;package-expression&gt;
</code></pre><p>In your package’s derivation arguments, it is <span class="emphasis"><em>strongly</em></span> recommended that the following are set:</p><pre><code class="programlisting nix">{
  __structuredAttrs = true;
  strictDeps = true;
}
</code></pre><p>These settings ensure that the CUDA setup hooks function as intended.</p><p>When using <code class="literal">callPackage</code>, you can choose to pass in a different variant, e.g. when a package requires a specific version of CUDA:</p><pre><code class="programlisting nix">{ mypkg = callPackage { cudaPackages = cudaPackages_12_2; }; }
</code></pre><div class="caution"><h3 class="title">Caution</h3><p>Overriding the CUDA package set for a package may cause inconsistencies, because the override does not affect its direct or transitive dependencies. As a result, it is easy to end up with a package that use a different CUDA package set than its dependencies. If possible, it is recommended that you change the default CUDA package set globally, to ensure a consistent environment.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cuda-nixpkgs-cuda-variants" class="title" >Nixpkgs CUDA variants   </h4>  </div> </div></div><p>Nixpkgs CUDA variants are provided primarily for the convenience of selecting CUDA-enabled packages by attribute path. As an example, the <code class="literal">pkgsForCudaArch</code> collection of CUDA Nixpkgs variants allows you to access an instantiation of OpenCV with CUDA support for an Ada Lovelace GPU with the attribute path <code class="literal">pkgsForCudaArch.sm_89.opencv</code>, without needing to modify the <code class="literal">config</code> provided when importing Nixpkgs.</p><div class="caution"><h3 class="title">Caution</h3><p>Nixpkgs variants are not free: they require re-evaluating Nixpkgs. Where possible, import Nixpkgs once, with the desired configuration.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-using-cudapackages-pkgs" class="title" >Using <code class="literal">cudaPackages.pkgs</code>   </h5>  </div> </div></div><p>Each CUDA package set has a <code class="literal">pkgs</code> attribute, which is a variant of Nixpkgs in which the enclosing CUDA package set becomes the default. This was done primarily to avoid package set leakage, wherein a member of a non-default CUDA package set has a (potentially transitive) dependency on a member of the default CUDA package set.</p><div class="note"><h3 class="title">Note</h3><p>Package set leakage is a common problem in Nixpkgs and is not limited to CUDA package sets.</p></div><p>As an added benefit of <code class="literal">pkgs</code> being configured this way, building a package with a non-default version of CUDA is as simple as accessing an attribute. As an example, <code class="literal">cudaPackages_12_8.pkgs.opencv</code> provides OpenCV built against CUDA 12.8.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-using-pkgscuda" class="title" >Using <code class="literal">pkgsCuda</code>   </h5>  </div> </div></div><p>The <code class="literal">pkgsCuda</code> attribute set is a variant of Nixpkgs configured with <code class="literal">cudaSupport = true;</code> and <code class="literal">rocmSupport = false</code>. It is a convenient way to access a variant of Nixpkgs configured with the default set of CUDA capabilities.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-using-pkgsforcudaarch" class="title" >Using <code class="literal">pkgsForCudaArch</code>   </h5>  </div> </div></div><p>The <code class="literal">pkgsForCudaArch</code> attribute set maps CUDA architectures (e.g., <code class="literal">sm_89</code> for Ada Lovelace or <code class="literal">sm_90a</code> for architecture-specific Hopper) to Nixpkgs variants configured to support exactly that architecture. As an example, <code class="literal">pkgsForCudaArch.sm_89</code> is a Nixpkgs variant extending <code class="literal">pkgs</code> and setting the following values in <code class="literal">config</code>:</p><pre><code class="programlisting nix">{
  cudaSupport = true;
  cudaCapabilities = [ &quot;8.9&quot; ];
  cudaForwardCompat = false;
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>In <code class="literal">pkgsForCudaArch</code>, the <code class="literal">cudaForwardCompat</code> option is set to <code class="literal">false</code> because exactly one CUDA architecture is supported by the corresponding Nixpkgs variant. Furthermore, some architectures, including architecture-specific feature sets like <code class="literal">sm_90a</code>, cannot be built with forward compatibility.</p></div><div class="caution"><h3 class="title">Caution</h3><p>Not every version of CUDA supports every architecture!</p><p>To illustrate: support for Blackwell (e.g., <code class="literal">sm_100</code>) was added in CUDA 12.8. Assume our Nixpkgs’ default CUDA package set is to CUDA 12.6. Then the Nixpkgs variant available through <code class="literal">pkgsForCudaArch.sm_100</code> is useless, since packages like <code class="literal">pkgsForCudaArch.sm_100.opencv</code> and <code class="literal">pkgsForCudaArch.sm_100.python3Packages.torch</code> will try to generate code for <code class="literal">sm_100</code>, an architecture unknown to CUDA 12.6. In that case, you should use <code class="literal">pkgsForCudaArch.sm_100.cudaPackages_12_8.pkgs</code> instead (see <a class="link" href="index.html#cuda-using-cudapackages-pkgs" title="Using cudaPackages.pkgs" >Using cudaPackages.pkgs</a> for more details).</p></div><p>The <code class="literal">pkgsForCudaArch</code> attribute set makes it possible to access packages built for a specific architecture without needing to manually call <code class="literal">pkgs.extend</code> and supply a new <code class="literal">config</code>. As an example, <code class="literal">pkgsForCudaArch.sm_89.python3Packages.torch</code> provides PyTorch built for Ada Lovelace GPUs.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cuda-docker-podman" class="title" >Running Docker or Podman containers with CUDA support   </h4>  </div> </div></div><p>It is possible to run Docker or Podman containers with CUDA support. The recommended mechanism to perform this task is to use the <a class="link" href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/index.html"  target="_top">NVIDIA Container Toolkit</a>.</p><p>The NVIDIA Container Toolkit can be enabled in NixOS like follows:</p><pre><code class="programlisting nix">{ hardware.nvidia-container-toolkit.enable = true; }
</code></pre><p>This will automatically enable a service that generates a CDI specification (located at <code class="literal">/var/run/cdi/nvidia-container-toolkit.json</code>) based on the auto-detected hardware of your machine. You can check this service by running:</p><pre><code class="programlisting ShellSession">$ systemctl status nvidia-container-toolkit-cdi-generator.service
</code></pre><div class="note"><h3 class="title">Note</h3><p>Depending on what settings you had already enabled in your system, you might need to restart your machine in order for the NVIDIA Container Toolkit to generate a valid CDI specification for your machine.</p></div><p>Once that a valid CDI specification has been generated for your machine on boot time, both Podman and Docker (&gt; 25) will use this spec if you provide them with the <code class="literal">--device</code> flag:</p><pre><code class="programlisting ShellSession">$ podman run --rm -it --device=nvidia.com/gpu=all ubuntu:latest nvidia-smi -L
GPU 0: NVIDIA GeForce RTX 4090 (UUID: &lt;REDACTED&gt;)
GPU 1: NVIDIA GeForce RTX 2080 SUPER (UUID: &lt;REDACTED&gt;)
</code></pre><pre><code class="programlisting ShellSession">$ docker run --rm -it --device=nvidia.com/gpu=all ubuntu:latest nvidia-smi -L
GPU 0: NVIDIA GeForce RTX 4090 (UUID: &lt;REDACTED&gt;)
GPU 1: NVIDIA GeForce RTX 2080 SUPER (UUID: &lt;REDACTED&gt;)
</code></pre><p>You can check all the identifiers that have been generated for your auto-detected hardware by checking the contents of the <code class="literal">/var/run/cdi/nvidia-container-toolkit.json</code> file:</p><pre><code class="programlisting ShellSession">$ nix run nixpkgs#jq -- -r &#x27;.devices[].name&#x27; &lt; /var/run/cdi/nvidia-container-toolkit.json
0
1
all
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-specifying-what-devices-to-expose-to-the-container" class="title" >Specifying what devices to expose to the container   </h5>  </div> </div></div><p>You can choose what devices are exposed to your containers by using the identifier on the generated CDI specification. Like follows:</p><pre><code class="programlisting ShellSession">$ podman run --rm -it --device=nvidia.com/gpu=0 ubuntu:latest nvidia-smi -L
GPU 0: NVIDIA GeForce RTX 4090 (UUID: &lt;REDACTED&gt;)
</code></pre><p>You can repeat the <code class="literal">--device</code> argument as many times as necessary if you have multiple GPU’s and you want to pick up which ones to expose to the container:</p><pre><code class="programlisting ShellSession">$ podman run --rm -it --device=nvidia.com/gpu=0 --device=nvidia.com/gpu=1 ubuntu:latest nvidia-smi -L
GPU 0: NVIDIA GeForce RTX 4090 (UUID: &lt;REDACTED&gt;)
GPU 1: NVIDIA GeForce RTX 2080 SUPER (UUID: &lt;REDACTED&gt;)
</code></pre><div class="note"><h3 class="title">Note</h3><p>By default, the NVIDIA Container Toolkit will use the GPU index to identify specific devices. You can change the way to identify what devices to expose by using the <code class="literal">hardware.nvidia-container-toolkit.device-name-strategy</code> NixOS attribute.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-using-docker-compose" class="title" >Using docker-compose   </h5>  </div> </div></div><p>It’s possible to expose GPU’s to a <code class="literal">docker-compose</code> environment as well. With a <code class="literal">docker-compose.yaml</code> file like follows:</p><pre><code class="programlisting yaml">services:
  some-service:
    image: ubuntu:latest
    command: sleep infinity
    deploy:
      resources:
        reservations:
          devices:
          - driver: cdi
            device_ids:
            - nvidia.com/gpu=all
</code></pre><p>In the same manner, you can pick specific devices that will be exposed to the container:</p><pre><code class="programlisting yaml">services:
  some-service:
    image: ubuntu:latest
    command: sleep infinity
    deploy:
      resources:
        reservations:
          devices:
          - driver: cdi
            device_ids:
            - nvidia.com/gpu=0
            - nvidia.com/gpu=1
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="cuda-contributing" class="title" >Contributing   </h3>  </div> </div></div><div class="warning"><h3 class="title">Warning</h3><p>This section of the docs is still very much in progress. Feedback is welcome in GitHub Issues tagging @NixOS/cuda-maintainers or on <a class="link" href="https://matrix.to/#/#cuda:nixos.org"  target="_top">Matrix</a>.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cuda-package-set-maintenance" class="title" >Package set maintenance   </h4>  </div> </div></div><p>The CUDA Toolkit is a suite of CUDA libraries and software meant to provide a development environment for CUDA-accelerated applications. Until the release of CUDA 11.4, NVIDIA had only made the CUDA Toolkit available as a multi-gigabyte runfile installer, which we provide through the <a class="link" href="https://search.nixos.org/packages?channel=unstable&amp;type=packages&amp;query=cudaPackages.cudatoolkit"  target="_top"><code class="literal">cudaPackages.cudatoolkit</code></a> attribute. From CUDA 11.4 and onwards, NVIDIA has also provided CUDA redistributables (“CUDA-redist”): individually packaged CUDA Toolkit components meant to facilitate redistribution and inclusion in downstream projects. These packages are available in the <a class="link" href="https://search.nixos.org/packages?channel=unstable&amp;type=packages&amp;query=cudaPackages"  target="_top"><code class="literal">cudaPackages</code></a> package set.</p><p>All new projects should use the CUDA redistributables available in <a class="link" href="https://search.nixos.org/packages?channel=unstable&amp;type=packages&amp;query=cudaPackages"  target="_top"><code class="literal">cudaPackages</code></a> in place of <a class="link" href="https://search.nixos.org/packages?channel=unstable&amp;type=packages&amp;query=cudaPackages.cudatoolkit"  target="_top"><code class="literal">cudaPackages.cudatoolkit</code></a>, as they are much easier to maintain and update.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-updating-redistributables" class="title" >Updating redistributables   </h5>  </div> </div></div><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Go to NVIDIA’s index of CUDA redistributables: <a class="link" href="https://developer.download.nvidia.com/compute/cuda/redist/"  target="_top">https://developer.download.nvidia.com/compute/cuda/redist/</a></p></li><li class="listitem"><p>Make a note of the new version of CUDA available.</p></li><li class="listitem"><p>Run</p><pre><code class="programlisting bash">nix run github:connorbaker/cuda-redist-find-features -- \
   download-manifests \
   --log-level DEBUG \
   --version &lt;newest CUDA version&gt; \
   https://developer.download.nvidia.com/compute/cuda/redist \
   ./pkgs/development/cuda-modules/cuda/manifests
</code></pre><p>This will download a copy of the manifest for the new version of CUDA.</p></li><li class="listitem"><p>Run</p><pre><code class="programlisting bash">nix run github:connorbaker/cuda-redist-find-features -- \
   process-manifests \
   --log-level DEBUG \
   --version &lt;newest CUDA version&gt; \
   https://developer.download.nvidia.com/compute/cuda/redist \
   ./pkgs/development/cuda-modules/cuda/manifests
</code></pre><p>This will generate a <code class="literal">redistrib_features_&lt;newest CUDA version&gt;.json</code> file in the same directory as the manifest.</p></li><li class="listitem"><p>Update the <code class="literal">cudaVersionMap</code> attribute set in <code class="literal">pkgs/development/cuda-modules/cuda/extension.nix</code>.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-updating-cutensor" class="title" >Updating cuTensor   </h5>  </div> </div></div><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Repeat the steps present in <a class="link" href="index.html#cuda-updating-redistributables" title="Updating redistributables" >Updating CUDA redistributables</a> with the following changes:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Use the index of cuTensor redistributables: <a class="link" href="https://developer.download.nvidia.com/compute/cutensor/redist"  target="_top">https://developer.download.nvidia.com/compute/cutensor/redist</a></p></li><li class="listitem"><p>Use the newest version of cuTensor available instead of the newest version of CUDA.</p></li><li class="listitem"><p>Use <code class="literal">pkgs/development/cuda-modules/cutensor/manifests</code> instead of <code class="literal">pkgs/development/cuda-modules/cuda/manifests</code>.</p></li><li class="listitem"><p>Skip the step of updating <code class="literal">cudaVersionMap</code> in <code class="literal">pkgs/development/cuda-modules/cuda/extension.nix</code>.</p></li></ul></div></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-updating-supported-compilers-and-gpus" class="title" >Updating supported compilers and GPUs   </h5>  </div> </div></div><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Update <code class="literal">nvccCompatibilities</code> in <code class="literal">pkgs/development/cuda-modules/_cuda/data/nvcc.nix</code> to include the newest release of NVCC, as well as any newly supported host compilers.</p></li><li class="listitem"><p>Update <code class="literal">cudaCapabilityToInfo</code> in <code class="literal">pkgs/development/cuda-modules/_cuda/data/cuda.nix</code> to include any new GPUs supported by the new release of CUDA.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-updating-the-cuda-toolkit" class="title" >Updating the CUDA Toolkit runfile installer   </h5>  </div> </div></div><div class="warning"><h3 class="title">Warning</h3><p>While the CUDA Toolkit runfile installer is still available in Nixpkgs as the <a class="link" href="https://search.nixos.org/packages?channel=unstable&amp;type=packages&amp;query=cudaPackages.cudatoolkit"  target="_top"><code class="literal">cudaPackages.cudatoolkit</code></a> attribute, its use is not recommended, and it should be considered deprecated. Please migrate to the CUDA redistributables provided by the <a class="link" href="https://search.nixos.org/packages?channel=unstable&amp;type=packages&amp;query=cudaPackages"  target="_top"><code class="literal">cudaPackages</code></a> package set.</p><p>To ensure packages relying on the CUDA Toolkit runfile installer continue to build, it will continue to be updated until a migration path is available.</p></div><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Go to NVIDIA’s CUDA Toolkit runfile installer download page: <a class="link" href="https://developer.nvidia.com/cuda-downloads"  target="_top">https://developer.nvidia.com/cuda-downloads</a></p></li><li class="listitem"><p>Select the appropriate OS, architecture, distribution, and version, and installer type.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>For example: Linux, x86_64, Ubuntu, 22.04, runfile (local)</p></li><li class="listitem"><p>NOTE: Typically, we use the Ubuntu runfile. It is unclear if the runfile for other distributions will work.</p></li></ul></div></li><li class="listitem"><p>Take the link provided by the installer instructions on the webpage after selecting the installer type and get its hash by running:</p><pre><code class="programlisting bash">nix store prefetch-file --hash-type sha256 &lt;link&gt;
</code></pre></li><li class="listitem"><p>Update <code class="literal">pkgs/development/cuda-modules/cudatoolkit/releases.nix</code> to include the release.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-updating-the-cuda-package-set" class="title" >Updating the CUDA package set   </h5>  </div> </div></div><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Include a new <code class="literal">cudaPackages_&lt;major&gt;_&lt;minor&gt;</code> package set in <code class="literal">pkgs/top-level/all-packages.nix</code>.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>NOTE: Changing the default CUDA package set should occur in a separate PR, allowing time for additional testing.</p></li></ul></div></li><li class="listitem"><p>Successfully build the closure of the new package set, updating <code class="literal">pkgs/development/cuda-modules/cuda/overrides.nix</code> as needed. Below are some common failures:</p></li></ol></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /><col align="left" /><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">Unable to …</th><th align="left">During …</th><th align="left">Reason</th><th align="left">Solution</th><th align="left">Note</th></tr></thead><tbody><tr><td align="left">Find headers</td><td align="left"><code class="literal">configurePhase</code> or <code class="literal">buildPhase</code></td><td align="left">Missing dependency on a <code class="literal">dev</code> output</td><td align="left">Add the missing dependency</td><td align="left">The <code class="literal">dev</code> output typically contains the headers</td></tr><tr><td align="left">Find libraries</td><td align="left"><code class="literal">configurePhase</code></td><td align="left">Missing dependency on a <code class="literal">dev</code> output</td><td align="left">Add the missing dependency</td><td align="left">The <code class="literal">dev</code> output typically contains CMake configuration files</td></tr><tr><td align="left">Find libraries</td><td align="left"><code class="literal">buildPhase</code> or <code class="literal">patchelf</code></td><td align="left">Missing dependency on a <code class="literal">lib</code> or <code class="literal">static</code> output</td><td align="left">Add the missing dependency</td><td align="left">The <code class="literal">lib</code> or <code class="literal">static</code> output typically contains the libraries</td></tr></tbody></table></div><p>Failure to run the resulting binary is typically the most challenging to diagnose, as it may involve a combination of the aforementioned issues. This type of failure typically occurs when a library attempts to load or open a library it depends on that it does not declare in its <code class="literal">DT_NEEDED</code> section. Try the following debugging steps:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>First ensure that dependencies are patched with <a class="link" href="https://search.nixos.org/packages?channel=unstable&amp;type=packages&amp;query=autoAddDriverRunpath"  target="_top"><code class="literal">autoAddDriverRunpath</code></a>.</p></li><li class="listitem"><p>Failing that, try running the application with <a class="link" href="https://github.com/guibou/nixGL"  target="_top"><code class="literal">nixGL</code></a> or a similar wrapper tool.</p></li><li class="listitem"><p>If that works, it likely means that the application is attempting to load a library that is not in the <code class="literal">RPATH</code> or <code class="literal">RUNPATH</code> of the binary.</p></li></ol></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cuda-writing-tests" class="title" >Writing tests   </h4>  </div> </div></div><div class="caution"><h3 class="title">Caution</h3><p>The existence of <code class="literal">passthru.testers</code> and <code class="literal">passthru.tests</code> should be considered an implementation detail – they are not meant to be a public or stable interface.</p></div><p>In general, there are two attribute sets in <code class="literal">passthru</code> that are used to build and run tests for CUDA packages: <code class="literal">passthru.testers</code> and <code class="literal">passthru.tests</code>. Each attribute set may contain an attribute set named <code class="literal">cuda</code>, which contains CUDA-specific derivations. The <code class="literal">cuda</code> attribute set is used to separate CUDA-specific derivations from those which support multiple implementations (e.g., OpenCL, ROCm, etc.) or have different licenses. For an example of such generic derivations, see the <code class="literal">magma</code> package.</p><div class="note"><h3 class="title">Note</h3><p>Derivations are nested under the <code class="literal">cuda</code> attribute due to an OfBorg quirk: if evaluation fails (e.g., because of unfree licenses), the entire enclosing attribute set is discarded. This prevents other attributes in the set from being discovered, evaluated, or built.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-passthru-testers" class="title" ><code class="literal">passthru.testers</code>   </h5>  </div> </div></div><p>Attributes added to <code class="literal">passthru.testers</code> are derivations which produce an executable which runs a test. The produced executable should:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Take care to set up the environment, make temporary directories, and so on.</p></li><li class="listitem"><p>Be registered as the derivation’s <code class="literal">meta.mainProgram</code> so that it can be run directly.</p></li></ul></div><div class="note"><h3 class="title">Note</h3><p>Testers which always require CUDA should be placed in <code class="literal">passthru.testers.cuda</code>, while those which are generic should be placed in <code class="literal">passthru.testers</code>.</p></div><p>The <code class="literal">passthru.testers</code> attribute set allows running tests outside the Nix sandbox. There are a number of reasons why this is useful, since such a test:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Can be run on non-NixOS systems, when wrapped with utilities like <code class="literal">nixGL</code> or <code class="literal">nix-gl-host</code>.</p></li><li class="listitem"><p>Has network access patterns which are difficult or impossible to sandbox.</p></li><li class="listitem"><p>Is free to produce output which is not deterministic, such as timing information.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="cuda-passthru-tests" class="title" ><code class="literal">passthru.tests</code>   </h5>  </div> </div></div><p>Attributes added to <code class="literal">passthru.tests</code> are derivations which run tests inside the Nix sandbox. Tests should:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Use the executables produced by <code class="literal">passthru.testers</code>, where possible, to avoid duplication of test logic.</p></li><li class="listitem"><p>Include <code class="literal">requiredSystemFeatures = [ &quot;cuda&quot; ];</code>, possibly conditioned on the value of <code class="literal">cudaSupport</code> if they are generic, to ensure that they are only run on systems exposing a CUDA-capable GPU.</p></li></ul></div><div class="note"><h3 class="title">Note</h3><p>Tests which always require CUDA should be placed in <code class="literal">passthru.tests.cuda</code>, while those which are generic should be placed in <code class="literal">passthru.tests</code>.</p></div><p>This is useful for tests which are deterministic (e.g., checking exit codes) and which can be provided with all necessary resources in the sandbox.</p>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="cuelang" class="title" style="clear: both">Cue (Cuelang)   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#cuelang-quickstart">Cuelang schema quick start</a> </span></dt><dt> <span class="section">  <a href="index.html#cuelang-writeCueValidator"><code class="literal">writeCueValidator</code></a> </span></dt> </dl></div><p><a class="link" href="https://cuelang.org/"  target="_top">Cuelang</a> is a language to:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>describe schemas and validate backward-compatibility</p></li><li class="listitem"><p>generate code and schemas in various formats (e.g. JSON Schema, OpenAPI)</p></li><li class="listitem"><p>do configuration akin to <a class="link" href="https://dhall-lang.org/"  target="_top">Dhall Lang</a></p></li><li class="listitem"><p>perform data validation</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="cuelang-quickstart" class="title" >Cuelang schema quick start   </h3>  </div> </div></div><p>Cuelang schemas are similar to JSON, here is a quick cheatsheet:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Default types includes: <code class="literal">null</code>, <code class="literal">string</code>, <code class="literal">bool</code>, <code class="literal">bytes</code>, <code class="literal">number</code>, <code class="literal">int</code>, <code class="literal">float</code>, lists as <code class="literal">[...T]</code> where <code class="literal">T</code> is a type.</p></li><li class="listitem"><p>All structures, defined by: <code class="literal">myStructName: { &lt;fields&gt; }</code> are <span class="strong"><strong>open</strong></span> – they accept fields which are not specified.</p></li><li class="listitem"><p>Closed structures can be built by doing <code class="literal">myStructName: close({ &lt;fields&gt; })</code> – they are strict in what they accept.</p></li><li class="listitem"><p><code class="literal">#X</code> are <span class="strong"><strong>definitions</strong></span>, referenced definitions are <span class="strong"><strong>recursively closed</strong></span>, i.e. all its children structures are <span class="strong"><strong>closed</strong></span>.</p></li><li class="listitem"><p><code class="literal">&amp;</code> operator is the <a class="link" href="https://cuelang.org/docs/references/spec/#unification"  target="_top">unification operator</a> (similar to a type-level merging operator), <code class="literal">|</code> is the <a class="link" href="https://cuelang.org/docs/references/spec/#disjunction"  target="_top">disjunction operator</a> (similar to a type-level union operator).</p></li><li class="listitem"><p>Values <span class="strong"><strong>are</strong></span> types, i.e. <code class="literal">myStruct: { a: 3 }</code> is a valid type definition that only allows <code class="literal">3</code> as value.</p></li><li class="listitem"><p>Read <a class="link" href="https://cuelang.org/docs/concepts/logic/"  target="_top">https://cuelang.org/docs/concepts/logic/</a> to learn more about the semantics.</p></li><li class="listitem"><p>Read <a class="link" href="https://cuelang.org/docs/references/spec/"  target="_top">https://cuelang.org/docs/references/spec/</a> to learn about the language specification.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="cuelang-writeCueValidator" class="title" ><code class="literal">writeCueValidator</code>   </h3>  </div> </div></div><p>Nixpkgs provides a <code class="literal">pkgs.writeCueValidator</code> helper, which will write a validation script based on the provided Cuelang schema.</p><p>Here is an example:</p><pre><code class="programlisting nix">pkgs.writeCueValidator (pkgs.writeText &quot;schema.cue&quot; &#x27;&#x27;
  #Def1: {
    field1: string
  }
&#x27;&#x27;) { document = &quot;#Def1&quot;; }
</code></pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>The first parameter is the Cue schema file.</p></li><li class="listitem"><p>The second parameter is an options parameter, currently, only: <code class="literal">document</code> can be passed.</p></li></ul></div><p><code class="literal">document</code> : match your input data against this fragment of structure or definition, e.g. you may use the same schema file but different documents based on the data you are validating.</p><p>Another example, given the following <code class="literal">validator.nix</code> :</p><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:
let
  genericValidator =
    version:
    pkgs.writeCueValidator (pkgs.writeText &quot;schema.cue&quot; &#x27;&#x27;
      #Version1: {
        field1: string
      }
      #Version2: #Version1 &amp; {
        field1: &quot;unused&quot;
      }&#x27;&#x27;) { document = &quot;#Version${toString version}&quot;; };
in
{
  validateV1 = genericValidator 1;
  validateV2 = genericValidator 2;
}
</code></pre><p>The result is a script that will validate the file you pass as the first argument against the schema you provided <code class="literal">writeCueValidator</code>.</p><p>It can be any format that <code class="literal">cue vet</code> supports, i.e. YAML or JSON for example.</p><p>Here is an example, named <code class="literal">example.json</code>, given the following JSON:</p><pre><code class="programlisting">{ &quot;field1&quot;: &quot;abc&quot; }
</code></pre><p>You can run the result script (named <code class="literal">validate</code>) as the following:</p><pre><code class="programlisting console">$ nix-build validator.nix
$ ./result example.json
$ ./result-2 example.json
field1: conflicting values &quot;unused&quot; and &quot;abc&quot;:
    ./example.json:1:13
    ../../../../../../nix/store/v64dzx3vr3glpk0cq4hzmh450lrwh6sg-schema.cue:5:11
$ sed -i &#x27;s/&quot;abc&quot;/3/&#x27; example.json
$ ./result example.json
field1: conflicting values 3 and string (mismatched types int and string):
    ./example.json:1:13
    ../../../../../../nix/store/v64dzx3vr3glpk0cq4hzmh450lrwh6sg-schema.cue:5:11
</code></pre><p><span class="strong"><strong>Known limitations</strong></span></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>The script will enforce <span class="strong"><strong>concrete</strong></span> values and will not accept lossy transformations (strictness). You can add these options if you need them.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-dart" class="title" style="clear: both">Dart   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-dart-applications">Dart applications</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-dart-flutter">Flutter applications</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-dart-applications" class="title" >Dart applications   </h3>  </div> </div></div><p>The function <code class="literal">buildDartApplication</code> builds Dart applications managed with pub.</p><p>It fetches its Dart dependencies automatically through <code class="literal">pub2nix</code>, and (through a series of hooks) builds and installs the executables specified in the pubspec file. The hooks can be used in other derivations, if needed. The phases can also be overridden to do something different from installing binaries.</p><p>If you are packaging a Flutter desktop application, use <a class="link" href="index.html#ssec-dart-flutter" title="Flutter applications" ><code class="literal">buildFlutterApplication</code></a> instead.</p><p><code class="literal">pubspecLock</code> is the parsed pubspec.lock file. pub2nix uses this to download required packages.
This can be converted to JSON from YAML with something like <code class="literal">yq . pubspec.lock</code>, and then read by Nix.</p><p>Alternatively, <code class="literal">autoPubspecLock</code> can be used instead, and set to a path to a regular <code class="literal">pubspec.lock</code> file. This relies on import-from-derivation, and is not permitted in Nixpkgs, but can be useful at other times.</p><div class="warning"><h3 class="title">Warning</h3><p>When using <code class="literal">autoPubspecLock</code> with a local source directory, make sure to use a
concatenation operator (e.g. <code class="literal">autoPubspecLock = src + &quot;/pubspec.lock&quot;;</code>), and
not string interpolation.</p><p>String interpolation will copy your entire source directory to the Nix store and
use its store path, meaning that unrelated changes to your source tree will
cause the generated <code class="literal">pubspec.lock</code> derivation to rebuild!</p></div><p>If the package has Git package dependencies, the hashes must be provided in the <code class="literal">gitHashes</code> set. If a hash is missing, an error message prompting you to add it will be shown.</p><p>The <code class="literal">dart</code> commands run can be overridden through <code class="literal">pubGetScript</code> and <code class="literal">dartCompileCommand</code>, you can also add flags using <code class="literal">dartCompileFlags</code> or <code class="literal">dartJitFlags</code>.</p><p>Dart supports multiple <a class="link" href="https://dart.dev/tools/dart-compile#types-of-output"  target="_top">outputs types</a>, you can choose between them using <code class="literal">dartOutputType</code> (defaults to <code class="literal">exe</code>). If you want to override the binaries path or the source path they come from, you can use <code class="literal">dartEntryPoints</code>. Outputs that require a runtime will automatically be wrapped with the relevant runtime (<code class="literal">dartaotruntime</code> for <code class="literal">aot-snapshot</code>, <code class="literal">dart run</code> for <code class="literal">jit-snapshot</code> and <code class="literal">kernel</code>, <code class="literal">node</code> for <code class="literal">js</code>), this can be overridden through <code class="literal">dartRuntimeCommand</code>.</p><pre><code class="programlisting nix">{
  lib,
  buildDartApplication,
  fetchFromGitHub,
}:

buildDartApplication rec {
  pname = &quot;dart-sass&quot;;
  version = &quot;1.62.1&quot;;

  src = fetchFromGitHub {
    owner = &quot;sass&quot;;
    repo = &quot;dart-sass&quot;;
    tag = version;
    hash = &quot;sha256-U6enz8yJcc4Wf8m54eYIAnVg/jsGi247Wy8lp1r1wg4=&quot;;
  };

  pubspecLock = lib.importJSON ./pubspec.lock.json;
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-dart-applications-patching-dependencies" class="title" >Patching dependencies   </h4>  </div> </div></div><p>Some Dart packages require patches or build environment changes. Package derivations can be customised with the <code class="literal">customSourceBuilders</code> argument.</p><p>A collection of such customisations can be found in Nixpkgs, in the <code class="literal">development/compilers/dart/package-source-builders</code> directory.</p><p>This allows fixes for packages to be shared between all applications that use them. It is strongly recommended to add to this collection instead of including fixes in your application derivation itself.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-dart-applications-build-tools" class="title" >Running executables from dev_dependencies   </h4>  </div> </div></div><p>Many Dart applications require executables from the <code class="literal">dev_dependencies</code> section in <code class="literal">pubspec.yaml</code> to be run before building them.</p><p>This can be done in <code class="literal">preBuild</code>, in one of two ways:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Packaging the tool with <code class="literal">buildDartApplication</code>, adding it to Nixpkgs, and running it like any other application</p></li><li class="listitem"><p>Running the tool from the package cache</p></li></ol></div><p>Of these methods, the first is recommended when using a tool that does not need
to be of a specific version.</p><p>For the second method, the <code class="literal">packageRun</code> function from the <code class="literal">dartConfigHook</code> can be used.
This is an alternative to <code class="literal">dart run</code> that does not rely on Pub.</p><p>e.g., for <code class="literal">build_runner</code>:</p><pre><code class="programlisting bash">packageRun build_runner build
</code></pre><p>Do <span class="emphasis"><em>not</em></span> use <code class="literal">dart run &lt;package_name&gt;</code>, as this will attempt to download dependencies with Pub.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-dart-applications-nix-shell" class="title" >Usage with nix-shell   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="ssec-dart-applications-nix-shell-deps" class="title" >Using dependencies from the Nix store   </h5>  </div> </div></div><p>As <code class="literal">buildDartApplication</code> provides dependencies instead of <code class="literal">pub get</code>, Dart needs to be explicitly told where to find them.</p><p>Run the following commands in the source directory to configure Dart appropriately.
Do not use <code class="literal">pub</code> after doing so; it will download the dependencies itself and overwrite these changes.</p><pre><code class="programlisting bash">cp --no-preserve=all &quot;$pubspecLockFilePath&quot; pubspec.lock
mkdir -p .dart_tool &amp;&amp; cp --no-preserve=all &quot;$packageConfig&quot; .dart_tool/package_config.json
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-dart-flutter" class="title" >Flutter applications   </h3>  </div> </div></div><p>The function <code class="literal">buildFlutterApplication</code> builds Flutter applications.</p><p>See the <a class="link" href="index.html#ssec-dart-applications" title="Dart applications" >Dart documentation</a> for more details on required files and arguments.</p><p><code class="literal">flutter</code> in Nixpkgs always points to <code class="literal">flutterPackages.stable</code>, which is the latest packaged version. To avoid unforeseen breakage during upgrade, packages in Nixpkgs should use a specific flutter version, such as <code class="literal">flutter319</code> and <code class="literal">flutter322</code>, instead of using <code class="literal">flutter</code> directly.</p><pre><code class="programlisting nix">{ flutter322, fetchFromGitHub }:

flutter322.buildFlutterApplication {
  pname = &quot;firmware-updater&quot;;
  version = &quot;0-unstable-2023-04-30&quot;;

  # To build for the Web, use the targetFlutterPlatform argument.
  # targetFlutterPlatform = &quot;web&quot;;

  src = fetchFromGitHub {
    owner = &quot;canonical&quot;;
    repo = &quot;firmware-updater&quot;;
    rev = &quot;6e7dbdb64e344633ea62874b54ff3990bd3b8440&quot;;
    hash = &quot;sha256-s5mwtr5MSPqLMN+k851+pFIFFPa0N1hqz97ys050tFA=&quot;;
    fetchSubmodules = true;
  };

  pubspecLock = lib.importJSON ./pubspec.lock.json;
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-dart-flutter-nix-shell" class="title" >Usage with nix-shell   </h4>  </div> </div></div><p>Flutter-specific <code class="literal">nix-shell</code> usage notes are included here. See the <a class="link" href="index.html#ssec-dart-applications-nix-shell" title="Usage with nix-shell" >Dart documentation</a> for general <code class="literal">nix-shell</code> instructions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="ssec-dart-flutter-nix-shell-enter" class="title" >Entering the shell   </h5>  </div> </div></div><p>By default, dependencies for only the <code class="literal">targetFlutterPlatform</code> are available in the
build environment. This is useful for keeping closures small, but be problematic
during development. It’s common, for example, to build Web apps for Linux during
development to take advantage of native features such as stateful hot reload.</p><p>To enter a shell with all the usual target platforms available, use the <code class="literal">multiShell</code> attribute.</p><p>e.g. <code class="literal">nix-shell &#x27;&lt;nixpkgs&gt;&#x27; -A fluffychat-web.multiShell</code>.</p>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-dhall" class="title" style="clear: both">Dhall   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-dhall-remote-imports">Remote imports</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-dhall-packaging-expression">Packaging a Dhall expression from scratch</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-dhall-package-contents">Contents of a Dhall package</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-dhall-packaging-functions">Packaging functions</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-dhall-dhall-to-nixpkgs"><code class="literal">dhall-to-nixpkgs</code></a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-dhall-overriding-dependency-versions">Overriding dependency versions</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-dhall-overrides">Overrides</a> </span></dt> </dl></div><p>The Nixpkgs support for Dhall assumes some familiarity with Dhall’s language
support for importing Dhall expressions, which is documented here:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="https://docs.dhall-lang.org/tutorials/Language-Tour.html#installing-packages"  target="_top"><code class="literal">dhall-lang.org</code> - Installing packages</a></p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-dhall-remote-imports" class="title" >Remote imports   </h3>  </div> </div></div><p>Nixpkgs bypasses Dhall’s support for remote imports using Dhall’s
semantic integrity checks.  Specifically, any Dhall import can be protected by
an integrity check like:</p><pre><code class="programlisting dhall">https://prelude.dhall-lang.org/v20.1.0/package.dhall
  sha256:26b0ef498663d269e4dc6a82b0ee289ec565d683ef4c00d0ebdd25333a5a3c98
</code></pre><p>… and if the import is cached then the interpreter will load the import from
cache instead of fetching the URL.</p><p>Nixpkgs uses this trick to add all of a Dhall expression’s dependencies into the
cache so that the Dhall interpreter never needs to resolve any remote URLs.  In
fact, Nixpkgs uses a Dhall interpreter with remote imports disabled when
packaging Dhall expressions to enforce that the interpreter never resolves a
remote import.  This means that Nixpkgs only supports building Dhall expressions
if all of their remote imports are protected by semantic integrity checks.</p><p>Instead of remote imports, Nixpkgs uses Nix to fetch remote Dhall code.  For
example, the Prelude Dhall package uses <code class="literal">pkgs.fetchFromGitHub</code> to fetch the
<code class="literal">dhall-lang</code> repository containing the Prelude.  Relying exclusively on Nix
to fetch Dhall code ensures that Dhall packages built using Nix remain pure and
also behave well when built within a sandbox.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-dhall-packaging-expression" class="title" >Packaging a Dhall expression from scratch   </h3>  </div> </div></div><p>We can illustrate how Nixpkgs integrates Dhall by beginning from the following
trivial Dhall expression with one dependency (the Prelude):</p><pre><code class="programlisting dhall">-- ./true.dhall

let Prelude = https://prelude.dhall-lang.org/v20.1.0/package.dhall

in  Prelude.Bool.not False
</code></pre><p>As written, this expression cannot be built using Nixpkgs because the
expression does not protect the Prelude import with a semantic integrity
check, so the first step is to freeze the expression using <code class="literal">dhall freeze</code>,
like this:</p><pre><code class="programlisting ShellSession">$ dhall freeze --inplace ./true.dhall
</code></pre><p>… which gives us:</p><pre><code class="programlisting dhall">-- ./true.dhall

let Prelude =
      https://prelude.dhall-lang.org/v20.1.0/package.dhall
        sha256:26b0ef498663d269e4dc6a82b0ee289ec565d683ef4c00d0ebdd25333a5a3c98

in  Prelude.Bool.not False
</code></pre><p>To package that expression, we create a <code class="literal">./true.nix</code> file containing the
following specification for the Dhall package:</p><pre><code class="programlisting nix"># ./true.nix

{ buildDhallPackage, Prelude }:

buildDhallPackage {
  name = &quot;true&quot;;
  code = ./true.dhall;
  dependencies = [ Prelude ];
  source = true;
}
</code></pre><p>… and we complete the build by incorporating that Dhall package into the
<code class="literal">pkgs.dhallPackages</code> hierarchy using an overlay, like this:</p><pre><code class="programlisting nix"># ./example.nix

let
  nixpkgs = builtins.fetchTarball {
    url = &quot;https://github.com/NixOS/nixpkgs/archive/94b2848559b12a8ed1fe433084686b2a81123c99.tar.gz&quot;;
    hash = &quot;sha256-B4Q3c6IvTLg3Q92qYa8y+i4uTaphtFdjp+Ir3QQjdN0=&quot;;
  };

  dhallOverlay = self: super: { true = self.callPackage ./true.nix { }; };

  overlay = self: super: {
    dhallPackages = super.dhallPackages.override (old: {
      overrides = self.lib.composeExtensions (old.overrides or (_: _: { })) dhallOverlay;
    });
  };

  pkgs = import nixpkgs {
    config = { };
    overlays = [ overlay ];
  };

in
pkgs
</code></pre><p>… which we can then build using this command:</p><pre><code class="programlisting ShellSession">$ nix build --file ./example.nix dhallPackages.true
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-dhall-package-contents" class="title" >Contents of a Dhall package   </h3>  </div> </div></div><p>The above package produces the following directory tree:</p><pre><code class="programlisting ShellSession">$ tree -a ./result
result
├── .cache
│   └── dhall
│       └── 122027abdeddfe8503496adeb623466caa47da5f63abd2bc6fa19f6cfcb73ecfed70
├── binary.dhall
└── source.dhall
</code></pre><p>… where:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">source.dhall</code> contains the result of interpreting our Dhall package:</p><pre><code class="programlisting ShellSession">$ cat ./result/source.dhall
True
</code></pre></li><li class="listitem"><p>The <code class="literal">.cache</code> subdirectory contains one binary cache product encoding the
same result as <code class="literal">source.dhall</code>:</p><pre><code class="programlisting ShellSession">$ dhall decode &lt; ./result/.cache/dhall/122027abdeddfe8503496adeb623466caa47da5f63abd2bc6fa19f6cfcb73ecfed70
True
</code></pre></li><li class="listitem"><p><code class="literal">binary.dhall</code> contains a Dhall expression which handles fetching and decoding
the same cache product:</p><pre><code class="programlisting ShellSession">$ cat ./result/binary.dhall
missing sha256:27abdeddfe8503496adeb623466caa47da5f63abd2bc6fa19f6cfcb73ecfed70
$ cp -r ./result/.cache .cache

$ chmod -R u+w .cache

$ XDG_CACHE_HOME=.cache dhall --file ./result/binary.dhall
True
</code></pre></li></ul></div><p>The <code class="literal">source.dhall</code> file is only present for packages that specify
<code class="literal">source = true;</code>.  By default, Dhall packages omit the <code class="literal">source.dhall</code> in order
to conserve disk space when they are used exclusively as dependencies.  For
example, if we build the Prelude package it will only contain the binary
encoding of the expression:</p><pre><code class="programlisting ShellSession">$ nix build --file ./example.nix dhallPackages.Prelude

$ tree -a result
result
├── .cache
│   └── dhall
│       └── 122026b0ef498663d269e4dc6a82b0ee289ec565d683ef4c00d0ebdd25333a5a3c98
└── binary.dhall

2 directories, 2 files
</code></pre><p>Typically, you only specify <code class="literal">source = true;</code> for the top-level Dhall expression
of interest (such as our example <code class="literal">true.nix</code> Dhall package).  However, if you
wish to specify <code class="literal">source = true</code> for all Dhall packages, then you can amend the
Dhall overlay like this:</p><pre><code class="programlisting nix">{
  dhallOverrides = self: super: {
    # Enable source for all Dhall packages
    buildDhallPackage = args: super.buildDhallPackage (args // { source = true; });

    true = self.callPackage ./true.nix { };
  };
}
</code></pre><p>… and now the Prelude will contain the fully decoded result of interpreting
the Prelude:</p><pre><code class="programlisting ShellSession">$ nix build --file ./example.nix dhallPackages.Prelude

$ tree -a result
result
├── .cache
│   └── dhall
│       └── 122026b0ef498663d269e4dc6a82b0ee289ec565d683ef4c00d0ebdd25333a5a3c98
├── binary.dhall
└── source.dhall

$ cat ./result/source.dhall
{ Bool =
  { and =
      \(_ : List Bool) -&gt;
        List/fold Bool _ Bool (\(_ : Bool) -&gt; \(_ : Bool) -&gt; _@1 &amp;&amp; _) True
  , build = \(_ : Type -&gt; _ -&gt; _@1 -&gt; _@2) -&gt; _ Bool True False
  , even =
      \(_ : List Bool) -&gt;
        List/fold Bool _ Bool (\(_ : Bool) -&gt; \(_ : Bool) -&gt; _@1 == _) True
  , fold =
      \(_ : Bool) -&gt;
…
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-dhall-packaging-functions" class="title" >Packaging functions   </h3>  </div> </div></div><p>We already saw an example of using <code class="literal">buildDhallPackage</code> to create a Dhall
package from a single file, but most Dhall packages consist of more than one
file and there are two derived utilities that you may find more useful when
packaging multiple files:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">buildDhallDirectoryPackage</code> - build a Dhall package from a local directory</p></li><li class="listitem"><p><code class="literal">buildDhallGitHubPackage</code> - build a Dhall package from a GitHub repository</p></li></ul></div><p>The <code class="literal">buildDhallPackage</code> is the lowest-level function and accepts the following
arguments:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">name</code>: The name of the derivation</p></li><li class="listitem"><p><code class="literal">dependencies</code>: Dhall dependencies to build and cache ahead of time</p></li><li class="listitem"><p><code class="literal">code</code>: The top-level expression to build for this package</p><p>Note that the <code class="literal">code</code> field accepts an arbitrary Dhall expression.  You’re
not limited to just a file.</p></li><li class="listitem"><p><code class="literal">source</code>: Set to <code class="literal">true</code> to include the decoded result as <code class="literal">source.dhall</code> in the
build product, at the expense of requiring more disk space</p></li><li class="listitem"><p><code class="literal">documentationRoot</code>: Set to the root directory of the package if you want
<code class="literal">dhall-docs</code> to generate documentation underneath the <code class="literal">docs</code> subdirectory of
the build product</p></li></ul></div><p>The <code class="literal">buildDhallDirectoryPackage</code> is a higher-level function implemented in terms
of <code class="literal">buildDhallPackage</code> that accepts the following arguments:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">name</code>: Same as <code class="literal">buildDhallPackage</code></p></li><li class="listitem"><p><code class="literal">dependencies</code>: Same as <code class="literal">buildDhallPackage</code></p></li><li class="listitem"><p><code class="literal">source</code>: Same as <code class="literal">buildDhallPackage</code></p></li><li class="listitem"><p><code class="literal">src</code>: The directory containing Dhall code that you want to turn into a Dhall
package</p></li><li class="listitem"><p><code class="literal">file</code>: The top-level file (<code class="literal">package.dhall</code> by default) that is the entrypoint
to the rest of the package</p></li><li class="listitem"><p><code class="literal">document</code>: Set to <code class="literal">true</code> to generate documentation for the package</p></li></ul></div><p>The <code class="literal">buildDhallGitHubPackage</code> is another higher-level function implemented in
terms of <code class="literal">buildDhallPackage</code> that accepts the following arguments:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">name</code>: Same as <code class="literal">buildDhallPackage</code></p></li><li class="listitem"><p><code class="literal">dependencies</code>: Same as <code class="literal">buildDhallPackage</code></p></li><li class="listitem"><p><code class="literal">source</code>: Same as <code class="literal">buildDhallPackage</code></p></li><li class="listitem"><p><code class="literal">owner</code>: The owner of the repository</p></li><li class="listitem"><p><code class="literal">repo</code>: The repository name</p></li><li class="listitem"><p><code class="literal">rev</code>: The desired revision (or branch, or tag)</p></li><li class="listitem"><p><code class="literal">directory</code>: The subdirectory of the Git repository to package (if a
directory other than the root of the repository)</p></li><li class="listitem"><p><code class="literal">file</code>: The top-level file (<code class="literal">${directory}/package.dhall</code> by default) that is
the entrypoint to the rest of the package</p></li><li class="listitem"><p><code class="literal">document</code>: Set to <code class="literal">true</code> to generate documentation for the package</p></li></ul></div><p>Additionally, <code class="literal">buildDhallGitHubPackage</code> accepts the same arguments as
<code class="literal">fetchFromGitHub</code>, such as <code class="literal">hash</code> or <code class="literal">fetchSubmodules</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-dhall-dhall-to-nixpkgs" class="title" ><code class="literal">dhall-to-nixpkgs</code>   </h3>  </div> </div></div><p>You can use the <code class="literal">dhall-to-nixpkgs</code> command-line utility to automate
packaging Dhall code.  For example:</p><pre><code class="programlisting ShellSession">$ nix-shell -p haskellPackages.dhall-nixpkgs nix-prefetch-git
[nix-shell]$ dhall-to-nixpkgs github https://github.com/Gabriella439/dhall-semver.git
{ buildDhallGitHubPackage, Prelude }:
  buildDhallGitHubPackage {
    name = &quot;dhall-semver&quot;;
    githubBase = &quot;github.com&quot;;
    owner = &quot;Gabriella439&quot;;
    repo = &quot;dhall-semver&quot;;
    rev = &quot;2d44ae605302ce5dc6c657a1216887fbb96392a4&quot;;
    fetchSubmodules = false;
    hash = &quot;sha256-n0nQtswVapWi/x7or0O3MEYmAkt/a1uvlOtnje6GGnk=&quot;;
    directory = &quot;&quot;;
    file = &quot;package.dhall&quot;;
    source = false;
    document = false;
    dependencies = [ (Prelude.overridePackage { file = &quot;package.dhall&quot;; }) ];
    }
</code></pre><div class="note"><h3 class="title">Note</h3><p><code class="literal">nix-prefetch-git</code> is added to the <code class="literal">nix-shell -p</code> invocation above, because it has to be in <code class="literal">$PATH</code> for <code class="literal">dhall-to-nixpkgs</code> to work.</p></div><p>The utility takes care of automatically detecting remote imports and converting
them to package dependencies.  You can also use the utility on local
Dhall directories, too:</p><pre><code class="programlisting ShellSession">$ dhall-to-nixpkgs directory ~/proj/dhall-semver
{ buildDhallDirectoryPackage, Prelude }:
  buildDhallDirectoryPackage {
    name = &quot;proj&quot;;
    src = ~/proj/dhall-semver;
    file = &quot;package.dhall&quot;;
    source = false;
    document = false;
    dependencies = [ (Prelude.overridePackage { file = &quot;package.dhall&quot;; }) ];
    }
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-dhall-remote-imports-as-fod" class="title" >Remote imports as fixed-output derivations   </h4>  </div> </div></div><p><code class="literal">dhall-to-nixpkgs</code> has the ability to fetch and build remote imports as
fixed-output derivations by using their Dhall integrity check. This is
sometimes easier than manually packaging all remote imports.</p><p>This can be used like the following:</p><pre><code class="programlisting ShellSession">$ dhall-to-nixpkgs directory --fixed-output-derivations ~/proj/dhall-semver
{ buildDhallDirectoryPackage, buildDhallUrl }:
  buildDhallDirectoryPackage {
    name = &quot;proj&quot;;
    src = ~/proj/dhall-semver;
    file = &quot;package.dhall&quot;;
    source = false;
    document = false;
    dependencies = [
      (buildDhallUrl {
        url = &quot;https://prelude.dhall-lang.org/v17.0.0/package.dhall&quot;;
        hash = &quot;sha256-ENs8kZwl6QRoM9+Jeo/+JwHcOQ+giT2VjDQwUkvlpD4=&quot;;
        dhallHash = &quot;sha256:10db3c919c25e9046833df897a8ffe2701dc390fa0893d958c3430524be5a43e&quot;;
        })
      ];
    }
</code></pre><p>Here, <code class="literal">dhall-semver</code>’s <code class="literal">Prelude</code> dependency is fetched and built with the
<code class="literal">buildDhallUrl</code> helper function, instead of being passed in as a function
argument.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-dhall-overriding-dependency-versions" class="title" >Overriding dependency versions   </h3>  </div> </div></div><p>Suppose that we change our <code class="literal">true.dhall</code> example expression to depend on an older
version of the Prelude (19.0.0):</p><pre><code class="programlisting dhall">-- ./true.dhall

let Prelude =
      https://prelude.dhall-lang.org/v19.0.0/package.dhall
        sha256:eb693342eb769f782174157eba9b5924cf8ac6793897fc36a31ccbd6f56dafe2

in  Prelude.Bool.not False
</code></pre><p>If we try to rebuild that expression the build will fail:</p><pre><code class="programlisting ShellSession">$ nix build --file ./example.nix dhallPackages.true
builder for &#x27;/nix/store/0f1hla7ff1wiaqyk1r2ky4wnhnw114fi-true.drv&#x27; failed with exit code 1; last 10 log lines:

  Dhall was compiled without the &#x27;with-http&#x27; flag.

  The requested URL was: https://prelude.dhall-lang.org/v19.0.0/package.dhall


  4│       https://prelude.dhall-lang.org/v19.0.0/package.dhall
  5│         sha256:eb693342eb769f782174157eba9b5924cf8ac6793897fc36a31ccbd6f56dafe2

  /nix/store/rsab4y99h14912h4zplqx2iizr5n4rc2-true.dhall:4:7
[1 built (1 failed), 0.0 MiB DL]
error: build of &#x27;/nix/store/0f1hla7ff1wiaqyk1r2ky4wnhnw114fi-true.drv&#x27; failed
</code></pre><p>… because the default Prelude selected by Nixpkgs revision
<code class="literal">94b2848559b12a8ed1fe433084686b2a81123c99is</code> is version 20.1.0, which doesn’t
have the same integrity check as version 19.0.0.  This means that version
19.0.0 is not cached and the interpreter is not allowed to fall back to
importing the URL.</p><p>However, we can override the default Prelude version by using <code class="literal">dhall-to-nixpkgs</code>
to create a Dhall package for our desired Prelude:</p><pre><code class="programlisting ShellSession">$ dhall-to-nixpkgs github https://github.com/dhall-lang/dhall-lang.git \
    --name Prelude \
    --directory Prelude \
    --rev v19.0.0 \
    &gt; Prelude.nix
</code></pre><p>… and then referencing that package in our Dhall overlay, by either overriding
the Prelude globally for all packages, like this:</p><pre><code class="programlisting nix">{
  dhallOverrides = self: super: {
    true = self.callPackage ./true.nix { };

    Prelude = self.callPackage ./Prelude.nix { };
  };
}
</code></pre><p>… or selectively overriding the Prelude dependency for just the <code class="literal">true</code> package,
like this:</p><pre><code class="programlisting nix">{
  dhallOverrides = self: super: {
    true = self.callPackage ./true.nix {
      Prelude = self.callPackage ./Prelude.nix { };
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-dhall-overrides" class="title" >Overrides   </h3>  </div> </div></div><p>You can override any of the arguments to <code class="literal">buildDhallGitHubPackage</code> or
<code class="literal">buildDhallDirectoryPackage</code> using the <code class="literal">overridePackage</code> attribute of a package.
For example, suppose we wanted to selectively enable <code class="literal">source = true</code> just for the Prelude.  We can do that like this:</p><pre><code class="programlisting nix">{
  dhallOverrides = self: super: {
    Prelude = super.Prelude.overridePackage { source = true; };

    # ...
  };
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="dlang" class="title" style="clear: both">D (Dlang)   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#dub-lockfiles">Lockfiles</a> </span></dt><dt> <span class="section">  <a href="index.html#builddubpackage-parameters"><code class="literal">buildDubPackage</code> parameters</a> </span></dt> </dl></div><p>Nixpkgs provides multiple D compilers such as <code class="literal">ldc</code>, <code class="literal">dmd</code> and <code class="literal">gdc</code>.
These can be used like any other package during build time.</p><p>However, Nixpkgs provides a build helper for compiling packages using the <code class="literal">dub</code> package manager.</p><p>Here’s an example:</p><pre><code class="programlisting nix">{
  lib,
  buildDubPackage,
  fetchFromGitHub,
  ncurses,
  zlib,
}:

buildDubPackage rec {
  pname = &quot;btdu&quot;;
  version = &quot;0.5.1&quot;;

  src = fetchFromGitHub {
    owner = &quot;CyberShadow&quot;;
    repo = &quot;btdu&quot;;
    tag = &quot;v${version}&quot;;
    hash = &quot;sha256-3sSZq+5UJH02IO0Y1yL3BLHDb4lk8k6awb5ZysBQciE=&quot;;
  };

  # generated by dub-to-nix, see below
  dubLock = ./dub-lock.json;

  buildInputs = [
    ncurses
    zlib
  ];

  installPhase = &#x27;&#x27;
    runHook preInstall
    install -Dm755 btdu -t $out/bin
    runHook postInstall
  &#x27;&#x27;;
}
</code></pre><p>Note that you need to define <code class="literal">installPhase</code> because <code class="literal">dub</code> doesn’t know where files should go in <code class="literal">$out</code>.</p><p>Also note that running <code class="literal">dub test</code> is disabled by default. You can enable it by setting <code class="literal">doCheck = true</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="dub-lockfiles" class="title" >Lockfiles   </h3>  </div> </div></div><p>Nixpkgs has its own lockfile format for <code class="literal">dub</code> dependencies, because <code class="literal">dub</code>’s official “lockfile” format (<code class="literal">dub.selections.json</code>) is not hash based.</p><p>A lockfile can be generated using the <code class="literal">dub-to-nix</code> helper package.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Firstly, install <code class="literal">dub-to-nix</code> into your shell session by running <code class="literal">nix-shell -p dub-to-nix</code></p></li><li class="listitem"><p>Then navigate to the root of the source of the program you want to package</p></li><li class="listitem"><p>Finally, run <code class="literal">dub-to-nix</code> and it will print the lockfile to stdout. You could pipe stdout into a text file or just copy the output manually into a file.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="builddubpackage-parameters" class="title" ><code class="literal">buildDubPackage</code> parameters   </h3>  </div> </div></div><p>The <code class="literal">buildDubPackage</code> function takes an attrset of parameters that are passed on to <code class="literal">stdenv.mkDerivation</code>.</p><p>The following parameters are specific to <code class="literal">buildDubPackage</code>:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">dubLock</code>: A lockfile generated by <code class="literal">dub-to-nix</code> from the source of the package. Can be either a path to the file, or an attrset already parsed with <code class="literal">lib.importJSON</code>.
The latter useful if the package uses <code class="literal">dub</code> dependencies not already in the lockfile. (e.g. if the package calls <code class="literal">dub run some-dub-package</code> manually)</p></li><li class="listitem"><p><code class="literal">dubBuildType ? &quot;release&quot;</code>: The build type to pass to <code class="literal">dub build</code> as a value for the <code class="literal">--build=</code> flag.</p></li><li class="listitem"><p><code class="literal">dubFlags ? []</code>: The flags to pass to <code class="literal">dub build</code> and <code class="literal">dub test</code>.</p></li><li class="listitem"><p><code class="literal">dubBuildFlags ? []</code>: The flags to pass to <code class="literal">dub build</code>.</p></li><li class="listitem"><p><code class="literal">dubTestFlags ? []</code>: The flags to pass to <code class="literal">dub test</code>.</p></li><li class="listitem"><p><code class="literal">compiler ? ldc</code>: The D compiler to be used by <code class="literal">dub</code>.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="dotnet" class="title" style="clear: both">Dotnet   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#local-development-workflow">Local Development Workflow</a> </span></dt><dt> <span class="section">  <a href="index.html#dotnet-sdk-vs-dotnetcorepackages.sdk">dotnet-sdk vs dotnetCorePackages.sdk</a> </span></dt><dt> <span class="section">  <a href="index.html#dotnetcorepackages.sdk-vs-dotnetcorepackages.runtime-vs-dotnetcorepackages.aspnetcore">dotnetCorePackages.sdk vs dotnetCorePackages.runtime vs dotnetCorePackages.aspnetcore</a> </span></dt><dt> <span class="section">  <a href="index.html#packaging-a-dotnet-application">Packaging a Dotnet Application</a> </span></dt><dt> <span class="section">  <a href="index.html#dotnet-global-tools">Dotnet global tools</a> </span></dt><dt> <span class="section">  <a href="index.html#generating-and-updating-nuget-dependencies">Generating and updating NuGet dependencies</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="local-development-workflow" class="title" >Local Development Workflow   </h3>  </div> </div></div><p>For local development, it’s recommended to use nix-shell to create a dotnet environment:</p><pre><code class="programlisting nix"># shell.nix
with import &lt;nixpkgs&gt; { };

mkShell {
  name = &quot;dotnet-env&quot;;
  packages = [ dotnet-sdk ];
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="using-many-sdks-in-a-workflow" class="title" >Using many sdks in a workflow   </h4>  </div> </div></div><p>It’s very likely that more than one sdk will be needed on a given project. Dotnet provides several different frameworks (E.g dotnetcore, aspnetcore, etc.) as well as many versions for a given framework. Normally, dotnet is able to fetch a framework and install it relative to the executable. However, this would mean writing to the nix store in nixpkgs, which is read-only. To support the many-sdk use case, one can compose an environment using <code class="literal">dotnetCorePackages.combinePackages</code>:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

mkShell {
  name = &quot;dotnet-env&quot;;
  packages = [
    (
      with dotnetCorePackages;
      combinePackages [
        sdk_8_0
        sdk_9_0
      ]
    )
  ];
}
</code></pre><p>This will produce a dotnet installation that has the dotnet 8.0 9.0 sdk. The first sdk listed will have it’s cli utility present in the resulting environment. Example info output:</p><pre><code class="programlisting ShellSession">$ dotnet --info
.NET SDK:
 Version:           9.0.100
 Commit:            59db016f11
 Workload version:  9.0.100-manifests.3068a692
 MSBuild version:   17.12.7+5b8665660

Runtime Environment:
 OS Name:     nixos
 OS Version:  25.05
 OS Platform: Linux
 RID:         linux-x64
 Base Path:   /nix/store/a03c70i7x6rjdr6vikczsp5ck3v6rixh-dotnet-sdk-9.0.100/share/dotnet/sdk/9.0.100/

.NET workloads installed:
There are no installed workloads to display.
Configured to use loose manifests when installing new manifests.

Host:
  Version:      9.0.0
  Architecture: x64
  Commit:       9d5a6a9aa4

.NET SDKs installed:
  8.0.404 [/nix/store/6wlrjiy10wg766490dcmp6x64zb1vc8j-dotnet-core-combined/share/dotnet/sdk]
  9.0.100 [/nix/store/6wlrjiy10wg766490dcmp6x64zb1vc8j-dotnet-core-combined/share/dotnet/sdk]

.NET runtimes installed:
  Microsoft.AspNetCore.App 8.0.11 [/nix/store/6wlrjiy10wg766490dcmp6x64zb1vc8j-dotnet-core-combined/share/dotnet/shared/Microsoft.AspNetCore.App]
  Microsoft.AspNetCore.App 9.0.0 [/nix/store/6wlrjiy10wg766490dcmp6x64zb1vc8j-dotnet-core-combined/share/dotnet/shared/Microsoft.AspNetCore.App]
  Microsoft.NETCore.App 8.0.11 [/nix/store/6wlrjiy10wg766490dcmp6x64zb1vc8j-dotnet-core-combined/share/dotnet/shared/Microsoft.NETCore.App]
  Microsoft.NETCore.App 9.0.0 [/nix/store/6wlrjiy10wg766490dcmp6x64zb1vc8j-dotnet-core-combined/share/dotnet/shared/Microsoft.NETCore.App]

Other architectures found:
  None

Environment variables:
  Not set

global.json file:
  Not found

Learn more:
  https://aka.ms/dotnet/info

Download .NET:
  https://aka.ms/dotnet/download
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="dotnet-sdk-vs-dotnetcorepackages.sdk" class="title" >dotnet-sdk vs dotnetCorePackages.sdk   </h3>  </div> </div></div><p>The <code class="literal">dotnetCorePackages.sdk_X_Y</code> is preferred over the old dotnet-sdk as both major and minor version are very important for a dotnet environment. If a given minor version isn’t present (or was changed), then this will likely break your ability to build a project.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="dotnetcorepackages.sdk-vs-dotnetcorepackages.runtime-vs-dotnetcorepackages.aspnetcore" class="title" >dotnetCorePackages.sdk vs dotnetCorePackages.runtime vs dotnetCorePackages.aspnetcore   </h3>  </div> </div></div><p>The <code class="literal">dotnetCorePackages.sdk</code> contains both a runtime and the full sdk of a given version. The <code class="literal">runtime</code> and <code class="literal">aspnetcore</code> packages are meant to serve as minimal runtimes to deploy alongside already built applications.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="packaging-a-dotnet-application" class="title" >Packaging a Dotnet Application   </h3>  </div> </div></div><p>To package Dotnet applications, you can use <code class="literal">buildDotnetModule</code>. This has similar arguments to <code class="literal">stdenv.mkDerivation</code>, with the following additions:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">projectFile</code> is used for specifying the dotnet project file, relative to the source root. These have <code class="literal">.sln</code> (entire solution) or <code class="literal">.csproj</code> (single project) file extensions. This can be a list of multiple projects as well. When omitted, will attempt to find and build the solution (<code class="literal">.sln</code>). If running into problems, make sure to set it to a file (or a list of files) with the <code class="literal">.csproj</code> extension - building applications as entire solutions is not fully supported by the .NET CLI.</p></li><li class="listitem"><p><code class="literal">nugetDeps</code> should be a path to a JSON file, a path to a nix file (deprecated), a derivation, or a list of derivations. A <code class="literal">deps.json</code> file can be generated using the script attached to <code class="literal">passthru.fetch-deps</code>, which is the preferred method. All <code class="literal">nugetDeps</code> packages are added to <code class="literal">buildInputs</code>.</p></li></ul></div><div class="note"><h3 class="title">Note</h3><p>For more detail about managing the <code class="literal">deps.json</code> file, see <a class="link" href="index.html#generating-and-updating-nuget-dependencies" title="Generating and updating NuGet dependencies" >Generating and updating NuGet dependencies</a></p></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">packNupkg</code> is used to pack project as a <code class="literal">nupkg</code>, and installs it to <code class="literal">$out/share</code>. If set to <code class="literal">true</code>, the derivation can be used as a dependency for another dotnet project by adding it to <code class="literal">buildInputs</code>.</p></li><li class="listitem"><p><code class="literal">buildInputs</code> can be used to resolve <code class="literal">ProjectReference</code> project items. Referenced projects can be packed with <code class="literal">buildDotnetModule</code> by setting the <code class="literal">packNupkg = true</code> attribute and passing a list of derivations to <code class="literal">buildInputs</code>. Since we are sharing referenced projects as NuGets they must be added to csproj/fsproj files as <code class="literal">PackageReference</code> as well.
For example, your project has a local dependency:</p></li></ul></div><pre><code class="programlisting xml">    &lt;ProjectReference Include=&quot;../foo/bar.fsproj&quot; /&gt;
</code></pre><p>To enable discovery through <code class="literal">buildInputs</code> you would need to add:</p><pre><code class="programlisting xml">    &lt;ProjectReference Include=&quot;../foo/bar.fsproj&quot; /&gt;
    &lt;PackageReference Include=&quot;bar&quot; Version=&quot;*&quot; Condition=&quot; &#x27;$(ContinuousIntegrationBuild)&#x27;==&#x27;true&#x27; &quot;/&gt;
</code></pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">executables</code> is used to specify which executables get wrapped to <code class="literal">$out/bin</code>, relative to <code class="literal">$out/lib/$pname</code>. If this is unset, all executables generated will get installed. If you do not want to install any, set this to <code class="literal">[]</code>. This gets done in the <code class="literal">preFixup</code> phase.</p></li><li class="listitem"><p><code class="literal">runtimeDeps</code> is used to wrap libraries into <code class="literal">LD_LIBRARY_PATH</code>. This is how dotnet usually handles runtime dependencies.</p></li><li class="listitem"><p><code class="literal">buildType</code> is used to change the type of build. Possible values are <code class="literal">Release</code>, <code class="literal">Debug</code>, etc. By default, this is set to <code class="literal">Release</code>.</p></li><li class="listitem"><p><code class="literal">selfContainedBuild</code> allows to enable the <a class="link" href="https://docs.microsoft.com/en-us/dotnet/core/deploying/#publish-self-contained"  target="_top">self-contained</a> build flag. By default, it is set to false and generated applications have a dependency on the selected dotnet runtime. If enabled, the dotnet runtime is bundled into the executable and the built app has no dependency on .NET.</p></li><li class="listitem"><p><code class="literal">useAppHost</code> will enable creation of a binary executable that runs the .NET application using the specified root. More info in <a class="link" href="https://learn.microsoft.com/en-us/dotnet/core/deploying/#publish-framework-dependent"  target="_top">Microsoft docs</a>. Enabled by default.</p></li><li class="listitem"><p><code class="literal">useDotnetFromEnv</code> will change the binary wrapper so that it uses the .NET from the environment. The runtime specified by <code class="literal">dotnet-runtime</code> is given as a fallback in case no .NET is installed in the user’s environment. This is most useful for .NET global tools and LSP servers, which often extend the .NET CLI and their runtime should match the users’ .NET runtime.</p></li><li class="listitem"><p><code class="literal">dotnet-sdk</code> is useful in cases where you need to change what dotnet SDK is being used. You can also set this to the result of <code class="literal">dotnetSdkPackages.combinePackages</code>, if the project uses multiple SDKs to build.</p></li><li class="listitem"><p><code class="literal">dotnet-runtime</code> is useful in cases where you need to change what dotnet runtime is being used. This can be either a regular dotnet runtime, or an aspnetcore.</p></li><li class="listitem"><p><code class="literal">testProjectFile</code> is useful in cases where the regular project file does not contain the unit tests. It gets restored and build, but not installed. You may need to regenerate your nuget lockfile after setting this. Note that if set, only tests from this project are executed.</p></li><li class="listitem"><p><code class="literal">testFilters</code> is used to disable running unit tests based on various <a class="link" href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-test#filter-option-details"  target="_top">filters</a>. This gets passed as: <code class="literal">dotnet test --filter &quot;{}&quot;</code>, with each filter being concatenated using <code class="literal">&quot;&amp;&quot;</code>.</p></li><li class="listitem"><p><code class="literal">disabledTests</code> is used to disable running specific unit tests. This gets passed as: <code class="literal">dotnet test --filter &quot;FullyQualifiedName!={}&quot;</code>, to ensure compatibility with all unit test frameworks.</p></li><li class="listitem"><p><code class="literal">dotnetRestoreFlags</code> can be used to pass flags to <code class="literal">dotnet restore</code>.</p></li><li class="listitem"><p><code class="literal">dotnetBuildFlags</code> can be used to pass flags to <code class="literal">dotnet build</code>.</p></li><li class="listitem"><p><code class="literal">dotnetTestFlags</code> can be used to pass flags to <code class="literal">dotnet test</code>. Used only if <code class="literal">doCheck</code> is set to <code class="literal">true</code>.</p></li><li class="listitem"><p><code class="literal">dotnetInstallFlags</code> can be used to pass flags to <code class="literal">dotnet install</code>.</p></li><li class="listitem"><p><code class="literal">dotnetPackFlags</code> can be used to pass flags to <code class="literal">dotnet pack</code>. Used only if <code class="literal">packNupkg</code> is set to <code class="literal">true</code>.</p></li><li class="listitem"><p><code class="literal">dotnetFlags</code> can be used to pass flags to all of the above phases.</p></li></ul></div><p>When packaging a new application, you need to fetch its dependencies. Create an empty <code class="literal">deps.json</code>, set <code class="literal">nugetDeps = ./deps.json</code>, then run <code class="literal">nix-build -A package.fetch-deps</code> to generate a script that will build the lockfile for you.</p><p>Here is an example <code class="literal">default.nix</code>, using some of the previously discussed arguments:</p><pre><code class="programlisting nix">{
  lib,
  buildDotnetModule,
  dotnetCorePackages,
  ffmpeg,
}:

let
  referencedProject = import ../../bar {
    # ...
  };
in
buildDotnetModule rec {
  pname = &quot;someDotnetApplication&quot;;
  version = &quot;0.1&quot;;

  src = ./.;

  projectFile = &quot;src/project.sln&quot;;
  nugetDeps = ./deps.json; # see &quot;Generating and updating NuGet dependencies&quot; section for details

  buildInputs = [
    referencedProject
  ]; # `referencedProject` must contain `nupkg` in the folder structure.

  dotnet-sdk = dotnetCorePackages.sdk_8_0;
  dotnet-runtime = dotnetCorePackages.runtime_8_0;

  executables = [ &quot;foo&quot; ]; # This wraps &quot;$out/lib/$pname/foo&quot; to `$out/bin/foo`.
  executables = [ ]; # Don&#x27;t install any executables.

  packNupkg = true; # This packs the project as &quot;foo-0.1.nupkg&quot; at `$out/share`.

  runtimeDeps = [ ffmpeg ]; # This will wrap ffmpeg&#x27;s library path into `LD_LIBRARY_PATH`.
}
</code></pre><p>Keep in mind that you can tag the <a class="link" href="https://github.com/orgs/nixos/teams/dotnet"  target="_top"><code class="literal">@NixOS/dotnet</code></a> team for help and code review.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="dotnet-global-tools" class="title" >Dotnet global tools   </h3>  </div> </div></div><p><a class="link" href="https://learn.microsoft.com/en-us/dotnet/core/tools/global-tools"  target="_top">.NET Global tools</a> are a mechanism provided by the dotnet CLI to install .NET binaries from Nuget packages.</p><p>They can be installed either as a global tool for the entire system, or as a local tool specific to project.</p><p>The local installation is the easiest and works on NixOS in the same way as on other Linux distributions.
<a class="link" href="https://learn.microsoft.com/en-us/dotnet/core/tools/global-tools#install-a-local-tool"  target="_top">See dotnet documentation</a> to learn more.</p><p><a class="link" href="https://learn.microsoft.com/en-us/dotnet/core/tools/global-tools#install-a-global-tool"  target="_top">The global installation method</a>
should also work most of the time. You have to remember to update the <code class="literal">PATH</code>
value to the location the tools are installed to (the CLI will inform you about it during installation) and also set
the <code class="literal">DOTNET_ROOT</code> value, so that the tool can find the .NET SDK package.
You can find the path to the SDK by running <code class="literal">nix eval --raw nixpkgs#dotnet-sdk</code> (substitute the <code class="literal">dotnet-sdk</code> package for
another if a different SDK version is needed).</p><p>This method is not recommended on NixOS, since it’s not declarative and involves installing binaries not made for NixOS,
which will not always work.</p><p>The third, and preferred way, is packaging the tool into a Nix derivation.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="packaging-dotnet-global-tools" class="title" >Packaging Dotnet global tools   </h4>  </div> </div></div><p>Dotnet global tools are standard .NET binaries, just made available through a special
NuGet package. Therefore, they can be built and packaged like every .NET application,
using <code class="literal">buildDotnetModule</code>.</p><p>If however the source is not available or difficult to build, the
<code class="literal">buildDotnetGlobalTool</code> helper can be used, which will package the tool
straight from its NuGet package.</p><p>This helper has the same arguments as <code class="literal">buildDotnetModule</code>, with a few differences:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pname</code> and <code class="literal">version</code> are required, and will be used to find the NuGet package of the tool</p></li><li class="listitem"><p><code class="literal">nugetName</code> can be used to override the NuGet package name that will be downloaded, if it’s different from <code class="literal">pname</code></p></li><li class="listitem"><p><code class="literal">nugetHash</code> is the hash of the fetched NuGet package. <code class="literal">nugetSha256</code> is also supported, but not recommended. Set this to <code class="literal">lib.fakeHash</code> for the first build, and it will error out, giving you the proper hash. Also remember to update it during version updates (it will not error out if you just change the version while having a fetched package in <code class="literal">/nix/store</code>)</p></li><li class="listitem"><p><code class="literal">dotnet-runtime</code> is set to <code class="literal">dotnet-sdk</code> by default. When changing this, remember that .NET tools fetched from NuGet require an SDK.</p></li></ul></div><p>Here is an example of packaging <code class="literal">pbm</code>, an unfree binary without source available:</p><pre><code class="programlisting nix">{ buildDotnetGlobalTool, lib }:

buildDotnetGlobalTool {
  pname = &quot;pbm&quot;;
  version = &quot;1.3.1&quot;;

  nugetHash = &quot;sha256-ZG2HFyKYhVNVYd2kRlkbAjZJq88OADe3yjxmLuxXDUo=&quot;;

  meta = {
    homepage = &quot;https://cmd.petabridge.com/index.html&quot;;
    changelog = &quot;https://cmd.petabridge.com/articles/RELEASE_NOTES.html&quot;;
    license = lib.licenses.unfree;
    platforms = lib.platforms.linux;
  };
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="generating-and-updating-nuget-dependencies" class="title" >Generating and updating NuGet dependencies   </h3>  </div> </div></div><p>When writing a new expression, you can use the generated <code class="literal">fetch-deps</code> script to initialise the lockfile.
After setting <code class="literal">nugetDeps</code> to the desired location of the lockfile (e.g. <code class="literal">./deps.json</code>),
build the script with <code class="literal">nix-build -A package.fetch-deps</code> and then run the result.
(When the root attr is your package, it’s simply <code class="literal">nix-build -A fetch-deps</code>.)</p><p>There is also a manual method:
First, restore the packages to the <code class="literal">out</code> directory, ensure you have cloned
the upstream repository and you are inside it.</p><pre><code class="programlisting bash">$ dotnet restore --packages out
  Determining projects to restore...
  Restored /home/ggg/git-credential-manager/src/shared/Git-Credential-Manager/Git-Credential-Manager.csproj (in 1.21 sec).
</code></pre><p>Next, use <code class="literal">nuget-to-json</code> tool provided in nixpkgs to generate a lockfile to <code class="literal">deps.json</code> from
the packages inside the <code class="literal">out</code> directory.</p><pre><code class="programlisting bash">$ nuget-to-json out &gt; deps.json
</code></pre><p>Which <code class="literal">nuget-to-json</code> will generate an output similar to below</p><pre><code class="programlisting json">[
  {
    &quot;pname&quot;: &quot;Avalonia&quot;,
    &quot;version&quot;: &quot;11.1.3&quot;,
    &quot;hash&quot;: &quot;sha256-kz+k/vkuWoL0XBvRT8SadMOmmRCFk9W/J4k/IM6oYX0=&quot;
  },
  {
    &quot;pname&quot;: &quot;Avalonia.Angle.Windows.Natives&quot;,
    &quot;version&quot;: &quot;2.1.22045.20230930&quot;,
    &quot;hash&quot;: &quot;sha256-RxPcWUT3b/+R3Tu5E5ftpr5ppCLZrhm+OTsi0SwW3pc=&quot;
  },
  {
    &quot;pname&quot;: &quot;Avalonia.BuildServices&quot;,
    &quot;version&quot;: &quot;0.0.29&quot;,
    &quot;hash&quot;: &quot;sha256-WPHRMNowRnYSCh88DWNBCltWsLPyOfzXGzBqLYE7tRY=&quot;
  },
  // ...
  {
    &quot;pname&quot;: &quot;System.Runtime.CompilerServices.Unsafe&quot;,
    &quot;version&quot;: &quot;6.0.0&quot;,
    &quot;hash&quot;: &quot;sha256-bEG1PnDp7uKYz/OgLOWs3RWwQSVYm+AnPwVmAmcgp2I=&quot;
  },
  {
    &quot;pname&quot;: &quot;System.Security.Cryptography.ProtectedData&quot;,
    &quot;version&quot;: &quot;4.5.0&quot;,
    &quot;hash&quot;: &quot;sha256-Z+X1Z2lErLL7Ynt2jFszku6/IgrngO3V1bSfZTBiFIc=&quot;
  },
  {
    &quot;pname&quot;: &quot;Tmds.DBus.Protocol&quot;,
    &quot;version&quot;: &quot;0.16.0&quot;,
    &quot;hash&quot;: &quot;sha256-vKYEaa1EszR7alHj48R8G3uYArhI+zh2ZgiBv955E98=&quot;
  }
]

</code></pre><p>Finally, you move the <code class="literal">deps.json</code> file to the appropriate location to be used by <code class="literal">nugetDeps</code>, then you’re all set!</p><p>If you ever need to update the dependencies of a package, you instead do</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">nix-build -A package.fetch-deps</code> to generate the update script for <code class="literal">package</code></p></li><li class="listitem"><p>Run <code class="literal">./result</code> to regenerate the lockfile to the path passed for <code class="literal">nugetDeps</code> (keep in mind if it can’t be resolved to a local path, the script will write to <code class="literal">$1</code> or a temporary path instead)</p></li><li class="listitem"><p>Finally, ensure the correct file was written and the derivation can be built.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="emscripten" class="title" style="clear: both">Emscripten   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#declarative-usage">Examples</a> </span></dt><dt> <span class="section">  <a href="index.html#declarative-debugging">Debugging</a> </span></dt> </dl></div><p><a class="link" href="https://github.com/kripken/emscripten"  target="_top">Emscripten</a>: An LLVM-to-JavaScript Compiler</p><p>If you want to work with <code class="literal">emcc</code>, <code class="literal">emconfigure</code> and <code class="literal">emmake</code> as you are used to from Ubuntu and similar distributions,</p><pre><code class="programlisting console">nix-shell -p emscripten
</code></pre><p>A few things to note:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">export EMCC_DEBUG=2</code> is nice for debugging</p></li><li class="listitem"><p>The build artifact cache in <code class="literal">~/.emscripten</code> sometimes creates issues and needs to be removed from time to time</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="declarative-usage" class="title" >Examples   </h3>  </div> </div></div><p>Let’s see two different examples from <code class="literal">pkgs/top-level/emscripten-packages.nix</code>:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pkgs.zlib.override</code></p></li><li class="listitem"><p><code class="literal">pkgs.buildEmscriptenPackage</code></p></li></ul></div><p>A special requirement of the <code class="literal">pkgs.buildEmscriptenPackage</code> is the <code class="literal">doCheck = true</code>.
This means each Emscripten package requires that a <a class="link" href="index.html#ssec-check-phase" title="The check phase" ><code class="literal">checkPhase</code></a> is implemented.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Use <code class="literal">export EMCC_DEBUG=2</code> from within a phase to get more detailed debug output what is going wrong.</p></li><li class="listitem"><p>The cache at <code class="literal">~/.emscripten</code> requires to set <code class="literal">HOME=$TMPDIR</code> in individual phases.
This makes compilation slower but also more deterministic.</p></li></ul></div><div class="example"><span id="usage-1-pkgs.zlib.override" ></span><details><summary><span class="title"><strong>Example 355. Using <code class="literal">pkgs.zlib.override {}</code></strong></span></summary><div class="example-contents"><p>This example uses <code class="literal">zlib</code> from Nixpkgs, but instead of compiling <span class="strong"><strong>C</strong></span> to <span class="strong"><strong>ELF</strong></span> it compiles <span class="strong"><strong>C</strong></span> to <span class="strong"><strong>JavaScript</strong></span> since we were using <code class="literal">pkgs.zlib.override</code> and changed <code class="literal">stdenv</code> to <code class="literal">pkgs.emscriptenStdenv</code>.</p><p>A few adaptions and hacks were put in place to make it work.
One advantage is that when <code class="literal">pkgs.zlib</code> is updated, it will automatically update this package as well.</p><pre><code class="programlisting nix">(pkgs.zlib.override { stdenv = pkgs.emscriptenStdenv; }).overrideAttrs (old: {
  buildInputs = old.buildInputs ++ [ pkg-config ];
  # we need to reset this setting!
  env = (old.env or { }) // {
    NIX_CFLAGS_COMPILE = &quot;&quot;;
  };

  configurePhase = &#x27;&#x27;
    # FIXME: Some tests require writing at $HOME
    HOME=$TMPDIR
    runHook preConfigure

    #export EMCC_DEBUG=2
    emconfigure ./configure --prefix=$out --shared

    runHook postConfigure
  &#x27;&#x27;;

  dontStrip = true;
  outputs = [ &quot;out&quot; ];

  buildPhase = &#x27;&#x27;
    runHook preBuild

    emmake make

    runHook postBuild
  &#x27;&#x27;;

  installPhase = &#x27;&#x27;
    runHook preInstall

    emmake make install

    runHook postInstall
  &#x27;&#x27;;

  checkPhase = &#x27;&#x27;
    runHook preCheck

    echo &quot;================= testing zlib using node =================&quot;

    echo &quot;Compiling a custom test&quot;
    set -x
    emcc -O2 -s EMULATE_FUNCTION_POINTER_CASTS=1 test/example.c -DZ_SOLO \
    libz.so.${old.version} -I . -o example.js

    echo &quot;Using node to execute the test&quot;
    ${pkgs.nodejs}/bin/node ./example.js

    set +x
    if [ $? -ne 0 ]; then
      echo &quot;test failed for some reason&quot;
      exit 1;
    else
      echo &quot;it seems to work! very good.&quot;
    fi
    echo &quot;================= /testing zlib using node =================&quot;

    runHook postCheck
  &#x27;&#x27;;

  postPatch = pkgs.lib.optionalString pkgs.stdenv.hostPlatform.isDarwin &#x27;&#x27;
    substituteInPlace configure \
      --replace-fail &#x27;/usr/bin/libtool&#x27; &#x27;ar&#x27; \
      --replace-fail &#x27;AR=&quot;libtool&quot;&#x27; &#x27;AR=&quot;ar&quot;&#x27; \
      --replace-fail &#x27;ARFLAGS=&quot;-o&quot;&#x27; &#x27;ARFLAGS=&quot;-r&quot;&#x27;
  &#x27;&#x27;;
})
</code></pre><div class="example"><span id="usage-2-pkgs.buildemscriptenpackage" ></span><details><summary><span class="title"><strong>Example 356. Using <code class="literal">pkgs.buildEmscriptenPackage {}</code></strong></span></summary><div class="example-contents"><p>This <code class="literal">xmlmirror</code> example features an Emscripten package that is defined completely from this context and no <code class="literal">pkgs.zlib.override</code> is used.</p><pre><code class="programlisting nix">pkgs.buildEmscriptenPackage {
  pname = &quot;xmlmirror&quot;;
  version = &quot;1.2.3&quot;;

  buildInputs = [
    pkg-config
    autoconf
    automake
    libtool
    gnumake
    libxml2
    nodejs
    openjdk
    json_c
  ];

  nativeBuildInputs = [
    pkg-config
    writableTmpDirAsHomeHook
    zlib
  ];

  src = pkgs.fetchgit {
    url = &quot;https://gitlab.com/odfplugfest/xmlmirror.git&quot;;
    rev = &quot;4fd7e86f7c9526b8f4c1733e5c8b45175860a8fd&quot;;
    hash = &quot;sha256-i+QgY+5PYVg5pwhzcDnkfXAznBg3e8sWH2jZtixuWsk=&quot;;
  };

  configurePhase = &#x27;&#x27;
    runHook preConfigure

    rm -f fastXmlLint.js*
    # a fix for ERROR:root:For asm.js, TOTAL_MEMORY must be a multiple of 16MB, was 234217728
    # https://gitlab.com/odfplugfest/xmlmirror/issues/8
    sed -e &quot;s/TOTAL_MEMORY=234217728/TOTAL_MEMORY=268435456/g&quot; -i Makefile.emEnv
    # https://github.com/kripken/emscripten/issues/6344
    # https://gitlab.com/odfplugfest/xmlmirror/issues/9
    sed -e &quot;s/\$(JSONC_LDFLAGS) \$(ZLIB_LDFLAGS) \$(LIBXML20_LDFLAGS)/\$(JSONC_LDFLAGS) \$(LIBXML20_LDFLAGS) \$(ZLIB_LDFLAGS) /g&quot; -i Makefile.emEnv
    # https://gitlab.com/odfplugfest/xmlmirror/issues/11
    sed -e &quot;s/-o fastXmlLint.js/-s EXTRA_EXPORTED_RUNTIME_METHODS=&#x27;[\&quot;ccall\&quot;, \&quot;cwrap\&quot;]&#x27; -o fastXmlLint.js/g&quot; -i Makefile.emEnv

    runHook postConfigure
  &#x27;&#x27;;

  buildPhase = &#x27;&#x27;
    runHook preBuild

    make -f Makefile.emEnv

    runHook postBuild
  &#x27;&#x27;;

  outputs = [
    &quot;out&quot;
    &quot;doc&quot;
  ];

  installPhase = &#x27;&#x27;
    runHook preInstall

    mkdir -p $out/share
    mkdir -p $doc/share/${name}

    cp Demo* $out/share
    cp -R codemirror-5.12 $out/share
    cp fastXmlLint.js* $out/share
    cp *.xsd $out/share
    cp *.js $out/share
    cp *.xhtml $out/share
    cp *.html $out/share
    cp *.json $out/share
    cp *.rng $out/share
    cp README.md $doc/share/${name}

    runHook postInstall
  &#x27;&#x27;;

  checkPhase = &#x27;&#x27;
    runHook preCheck

    runHook postCheck
  &#x27;&#x27;;
}
</code></pre></div></details></div><br class="example-break" /></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="declarative-debugging" class="title" >Debugging   </h3>  </div> </div></div><p>Use <code class="literal">nix-shell -I nixpkgs=/some/dir/nixpkgs -A emscriptenPackages.libz</code> and from there you can go trough the individual steps. This makes it easy to build a good <code class="literal">unit test</code> or list the files of the project.</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p><code class="literal">nix-shell -I nixpkgs=/some/dir/nixpkgs -A emscriptenPackages.libz</code></p></li><li class="listitem"><p><code class="literal">cd /tmp/</code></p></li><li class="listitem"><p><code class="literal">unpackPhase</code></p></li><li class="listitem"><p>cd libz-1.2.3</p></li><li class="listitem"><p><code class="literal">configurePhase</code></p></li><li class="listitem"><p><code class="literal">buildPhase</code></p></li><li class="listitem"><p>… happy hacking…</p></li></ol></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-factor" class="title" style="clear: both">Factor   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-factor-dev-env">Development Environment</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-factor-packaging">Packaging Factor Vocabularies</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-factor-applications">Building Applications</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-factor-dev-env" class="title" >Development Environment   </h3>  </div> </div></div><p>All Nix expressions for the Factor compiler and development environment can be found in <code class="literal">pkgs/top-level/factor-packages.nix</code>.</p><p>The default package <code class="literal">factor-lang</code> provides support for the built-in graphical user interface and a selected set of C library bindings, e.g., for sound and TLS connections.
It also comes with the Fuel library for Emacs that provides an integrated development environment for developing Factor programs including access to the Factor runtime and online documentation.</p><p>For using less frequently used libraries that need additional bindings, you can override the <code class="literal">factor-lang</code> package and add more library bindings and/or binaries to its PATH.
The package is defined in <code class="literal">pkgs/development/compilers/factor-lang/wrapper.nix</code> and provides several attributes for adding those:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">extraLibs</code> adds the packages’ <code class="literal">/lib</code> paths to the wrapper and adds all shared libraries to an ld.so cache such that they can be found dynamically by the Factor runtime.</p></li><li class="listitem"><p><code class="literal">binPackages</code> does the same as <code class="literal">extraLibs</code> and additionally adds the packages to Factor’s PATH environment variable.</p></li><li class="listitem"><p><code class="literal">extraVocabs</code> adds Factor vocabularies to the tree that are not part of the standard library.
The packages must adhere to the default vocabulary root structure to be found.</p></li><li class="listitem"><p><code class="literal">guiSupport</code> draws in all necessary graphical libraries to enable the Factor GUI.
This should be set to <code class="literal">true</code> when considering building and running graphical applications with this Factor runtime (even if the Factor GUI is not used for programming).
This argument is <code class="literal">true</code> by default.</p></li><li class="listitem"><p><code class="literal">enableDefaults</code> can be deactivated to only wrap libraries that are named in <code class="literal">extraLibs</code> or <code class="literal">binPackages</code>.
This reduces the runtime dependencies especially when shipping Factor applications.</p></li></ul></div><p>The package also passes through several attributes listing the wrapped libraries and binaries, namely, <code class="literal">extraLibs</code> and <code class="literal">binPackages</code> as well as <code class="literal">defaultLibs</code> and <code class="literal">defaultBins</code>.
Additionally, all <code class="literal">runtimeLibs</code> is the concatenation of all the above for the purpose of providing all necessary dynamic libraries as “<code class="literal">propagatedBuildInputs</code>”.</p><p><code class="literal">factorPackages</code> provides pre-configured Factor packages:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">factorPackages.factor-lang</code> is the default package with GUI support and several default library bindings (e.g. openssl, openal etc.).</p></li><li class="listitem"><p><code class="literal">factorPackages.factor-no-gui</code> turns off GUI support while maintaining default library bindings.</p></li><li class="listitem"><p><code class="literal">factorPackages.factor-minimal</code> comes with practically no additional library bindings and binaries and no GUI support.</p></li><li class="listitem"><p><code class="literal">factorPackages.factor-minimal-gui</code> comes with no additional library bindings but includes GUI support.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-factor-scaffolding" class="title" >Scaffolding and the <code class="literal">work</code> vocabulary root   </h4>  </div> </div></div><p>Factor uses the concept of “scaffolding” to spin off a new vocabulary in a personal workspace rooted at the <code class="literal">work</code> vocabulary root.
This concept does not scale very well, because it makes many assumptions which all turn out to be wrong at some point.
In the current implementation, the <code class="literal">work</code> vocabulary root points to <code class="literal">/var/lib/factor</code> on the target machine.
This can be suitable for a single-user system.
Create the location and make it writable to your user.
Then, you can use the <code class="literal">scaffold-work</code> word as instructed by many tutorials.</p><p>If you don’t like this approach, you can work around it by creating a <code class="literal">~/.factor-roots</code> file in your home directory which contains the locations you desire to represent additional Factor vocabulary roots, one directory per line.
Use <code class="literal">scaffold-vocab</code> to create your vocabularies in one of these additional roots.
The online Factor documentation is extensive on how to use the scaffolding framework.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-factor-packaging" class="title" >Packaging Factor Vocabularies   </h3>  </div> </div></div><p>All Factor vocabularies that shall be added to a Factor environment via the <code class="literal">extraVocabs</code> attribute must adhere to the following directory scheme.
Its top-level directory must be one (or multiple) of <code class="literal">basis</code>, <code class="literal">core</code> or <code class="literal">extra</code>.
<code class="literal">work</code> is routed to <code class="literal">/var/lib/factor</code> and is not shipped nor referenced in the nix store, see the section on <a class="link" href="index.html#ssec-factor-scaffolding" title="Scaffolding and the work vocabulary root" >scaffolding</a>.
You should usually use <code class="literal">extra</code>, but you can use the other roots to overwrite built-in vocabularies.
Be aware that vocabularies in <code class="literal">core</code> are part of the Factor image which the development environment is run from.
This means the code in those vocabularies is not loaded from the sources, such that you need to call <code class="literal">refresh-all</code> to re-compile and load the changed definitions.
In these instances, it is advised to override the <code class="literal">factor-unwrapped</code> package directly, which compiles and packages the core Factor libraries into the default Factor
image.</p><p>As per Factor convention, your vocabulary <code class="literal">foo.factor</code> must be in a directory of the same name in addition to one of the previously mentioned vocabulary roots, e.g. <code class="literal">extra/foo/foo.factor</code>.</p><p>All extra Factor vocabularies are registered in <code class="literal">pkgs/top-level/factor-packages.nix</code> and their package definitions usually live in <code class="literal">development/compilers/factor-lang/vocabs/</code>.</p><p>Package a vocabulary using the <code class="literal">buildFactorVocab</code> function.
Its default <code class="literal">installPhase</code> takes care of installing it under <code class="literal">out/lib/factor</code>.
It also understands the following special attributes:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">vocabName</code> is the path to the vocabulary to be installed.
Defaults to <code class="literal">pname</code>.</p></li><li class="listitem"><p><code class="literal">vocabRoot</code> is the vocabulary root to install the vocabulary under.
Defaults to <code class="literal">extra</code>.
Unless you know what you are doing, do not change it.
Other readily understood vocabulary roots are <code class="literal">core</code> and <code class="literal">base</code>, which allow you to modify the default Factor runtime environment with an external package.</p></li><li class="listitem"><p><code class="literal">extraLibs</code>, <code class="literal">extraVocabs</code>, <code class="literal">extraPaths</code> have the same meaning as for <a class="link" href="index.html#ssec-factor-applications" title="Building Applications" >applications</a>.
They have no immediate effect and are just passed through.
When building factor-lang packages and Factor applications that use this respective vocabulary, these variables are evaluated and their paths added to the runtime environment.</p></li></ul></div><p>The function understands several forms of source directory trees:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Simple single-vocab projects with their Factor and supplementary files directly in the project root.
All <code class="literal">.factor</code> and <code class="literal">.txt</code> files are copied to <code class="literal">out/lib/factor/&lt;vocabRoot&gt;/&lt;vocabName&gt;</code>.</p></li><li class="listitem"><p>More complex projects with several vocabularies next to each other, e.g. <code class="literal">./&lt;vocabName&gt;</code> and <code class="literal">./&lt;otherVocab&gt;</code>.
All directories except <code class="literal">bin</code>, <code class="literal">doc</code> and <code class="literal">lib</code> are copied to <code class="literal">out/lib/factor/&lt;vocabRoot&gt;</code>.</p></li><li class="listitem"><p>Even more complex projects that touch multiple vocabulary roots.
Vocabularies must reside under <code class="literal">lib/factor/&lt;root&gt;/&lt;vocab&gt;</code> with the name-giving vocabulary being in <code class="literal">lib/factor/&lt;vocabRoot&gt;/&lt;vocabName&gt;</code>.
All directories in <code class="literal">lib/factor</code> are copied to <code class="literal">out/</code>.</p></li></ol></div><p>For instance, packaging the Bresenham algorithm for line interpolation looks like this, see <code class="literal">pkgs/development/compilers/factor-lang/vocabs/bresenham</code> for the complete file:</p><pre><code class="programlisting nix">{ factorPackages, fetchFromGitHub }:

factorPackages.buildFactorVocab {
  pname = &quot;bresenham&quot;;
  version = &quot;dev&quot;;

  src = fetchFromGitHub {
    owner = &quot;Capital-EX&quot;;
    repo = &quot;bresenham&quot;;
    rev = &quot;58d76b31a17f547e19597a09d02d46a742bf6808&quot;;
    hash = &quot;sha256-cfQOlB877sofxo29ahlRHVpN3wYTUc/rFr9CJ89dsME=&quot;;
  };
}
</code></pre><p>The vocabulary goes to <code class="literal">lib/factor/extra</code>, extra files, like licenses etc. would go to <code class="literal">share/</code> as usual and could be added to the output via a <code class="literal">postInstall</code> phase.
In case the vocabulary binds to a shared library or calls a binary that needs to be present in the runtime environment of its users, add <code class="literal">extraPaths</code> and <code class="literal">extraLibs</code> attributes respectively.
They are then picked up by the <code class="literal">buildFactorApplication</code> function and added as runtime dependencies.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-factor-applications" class="title" >Building Applications   </h3>  </div> </div></div><p>Factor applications are built using Factor’s <code class="literal">deploy</code> facility with the help of the <code class="literal">buildFactorApplication</code> function.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-factor-buildFactorApplication-func" class="title" ><code class="literal">buildFactorApplication</code> function   </h4>  </div> </div></div><p><code class="literal">factorPackages.buildFactorApplication</code> <span class="emphasis"><em><code class="literal">buildDesc</code></em></span></p><p>When packaging a Factor application with <a class="link" href="index.html#ssec-factor-buildFactorApplication-func" title="buildFactorApplication function" ><code class="literal">buildFactorApplication</code></a>, its <a class="link" href="index.html#sec-pkg-override" title="&lt;pkg&gt;.override" ><code class="literal">override</code></a> interface should contain the <code class="literal">factorPackages</code> argument.
For example:</p><pre><code class="programlisting nix">{
  lib,
  fetchurl,
  factorPackages,
}:

factorPackages.buildFactorApplication (finalAttrs: {
  pname = &quot;foo&quot;;
  version = &quot;1.0&quot;;

  src = fetchurl {
    url = &quot;https://some-forge.org/foo-${finalAttrs.version}.tar.gz&quot;;
  };
})
</code></pre><p>The <code class="literal">buildFactorApplication</code> function expects the following source structure for a package <code class="literal">foo-1.0</code> and produces a <code class="literal">/bin/foo</code> application:</p><pre><code class="programlisting">foo-1.0/
  foo/
    foo.factor
    deploy.factor
  &lt;more files and directories&gt;...
</code></pre><p>It provides the additional attributes <code class="literal">vocabName</code> and <code class="literal">binName</code> to cope with naming deviations.
The <code class="literal">deploy.factor</code> file controls how the application is deployed and is documented in the Factor online documentation on the <code class="literal">deploy</code> facility.</p><p>Use the <code class="literal">preInstall</code> or <code class="literal">postInstall</code> hooks to copy additional files and directories to <code class="literal">out/</code>.
The function itself only builds the application in <code class="literal">/lib/factor/</code> and a wrapper in <code class="literal">/bin/</code>.</p><p>A more complex example shows how to specify runtime dependencies and additional Factor vocabularies at the example of the <code class="literal">painter</code> Factor application:</p><pre><code class="programlisting nix">{
  lib,
  fetchFromGitHub,
  factorPackages,
  curl,
}:

factorPackages.buildFactorApplication (finalAttrs: {
  pname = &quot;painter&quot;;
  version = &quot;1&quot;;

  factor-lang = factorPackages.factor-minimal-gui;

  src = fetchFromGitHub {
    name = finalAttrs.vocabName;
    owner = &quot;Capital-EX&quot;;
    repo = &quot;painter&quot;;
    rev = &quot;365797be8c4f82440bec0ad0a50f5a858a06c1b6&quot;;
    hash = &quot;sha256-VdvnvKNGcFAtjWVDoxyYgRSyyyy0BEZ2MZGQ71O8nUI=&quot;;
  };

  sourceRoot = &quot;.&quot;;

  enableUI = true;
  extraVocabs = [ factorPackages.bresenham ];

  extraPaths = with finalAttrs.factor-lang; binPackages ++ defaultBins ++ [ curl ];

})
</code></pre><p>The use of the <code class="literal">src.name</code> and<code class="literal">sourceRoot</code> attributes conveniently establish the necessary <code class="literal">painter</code> vocabulary directory that is needed for the deployment to work.</p><p>It requires the packager to specify the full set of binaries to be made available at runtime.
This enables the standard pattern for application packages to specify all runtime dependencies explicitly without the Factor runtime interfering.</p><p><code class="literal">buildFactorApplication</code> is a wrapper around <code class="literal">stdenv.mkDerivation</code> and takes all of its attributes.
Additional attributes that are understood by <code class="literal">buildFactorApplication</code>:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em><code class="literal">buildDesc</code></em></span> (Function or attribute set)</span></dt><dd><p>A build description similar to <code class="literal">stdenv.mkDerivation</code> with the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">vocabName</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>is the path to the vocabulary to be deployed relative to the source root.
So, directory <code class="literal">foo/</code> from the example above could be <code class="literal">extra/deep/down/foo</code>.
This allows you to maintain Factor’s vocabulary hierarchy and distribute the same source tree as a stand-alone application and as a library in the Factor development environment via the <code class="literal">extraVocabs</code> attribute.</p></dd><dt><span class="term"><code class="literal">binName</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>is the name of the resulting binary in <code class="literal">/bin/</code>.
It defaults to the last directory component in <code class="literal">vocabName</code>.
It is also added as the <code class="literal">meta.mainProgram</code> attribute to facilitate <code class="literal">nix run</code>.</p></dd><dt><span class="term"><code class="literal">enableUI</code> (Boolean; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>is <code class="literal">false</code> by default.
Set this to <code class="literal">true</code> when you ship a graphical application.</p></dd><dt><span class="term"><code class="literal">extraLibs</code> (List; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>adds additional libraries as runtime dependencies.
Defaults to <code class="literal">[]</code> and is concatenated with <code class="literal">runtimeLibs</code> from the used factor-lang package.
Use <code class="literal">factor-minimal</code> to minimize the closure of runtime libraries.</p></dd><dt><span class="term"><code class="literal">extraPaths</code> (List; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>adds additional binaries to the runtime PATH environment variable (without adding their libraries, as well).
Defaults to <code class="literal">[]</code> and is concatenated with <code class="literal">defaultBins</code> and <code class="literal">binPackages</code> from the used factor-lang package.
Use <code class="literal">factor-minimal</code> to minimize the closure of runtime libraries.</p></dd><dt><span class="term"><code class="literal">deployScriptText</code> (String; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>is the actual deploy Factor file that is executed to deploy the application.
You can change it if you need to perform additional computation during deployment.</p></dd><dt><span class="term"><code class="literal">factor-lang</code> (Package; <span class="emphasis"><em>optional</em></span>)</span></dt><dd><p>overrides the Factor package to use to deploy this application, which also affects the default library bindings and programs in the runtime PATH.
It defaults to <code class="literal">factor-lang</code> when <code class="literal">enableUI</code> is turned on and <code class="literal">factor-no-gui</code> when it is turned off.
Applications that use only Factor libraries without external bindings or programs may set this to <code class="literal">factor-minimal</code> or <code class="literal">factor-minimal-gui</code>.</p></dd></dl></div></dd></dl></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-gnome" class="title" style="clear: both">GNOME   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-gnome-packaging">Packaging GNOME applications</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-gnome-hooks">Onto <code class="literal">wrapGApps*</code> hooks</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-gnome-updating">Updating GNOME packages</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-gnome-common-issues">Frequently encountered issues</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-gnome-packaging" class="title" >Packaging GNOME applications   </h3>  </div> </div></div><p>Programs in the GNOME universe are written in various languages but they all use GObject-based libraries like GLib, GTK or GStreamer. These libraries are often modular, relying on looking into certain directories to find their modules. However, due to Nix’s specific file system organization, this will fail without our intervention. Fortunately, the libraries usually allow overriding the directories through environment variables, either natively or thanks to a patch in nixpkgs. <a class="link" href="index.html#fun-wrapProgram" title="wrapProgram &lt;executable&gt; &lt;makeWrapperArgs&gt;" >Wrapping</a> the executables to ensure correct paths are available to the application constitutes a significant part of packaging a modern desktop application. In this section, we will describe various modules needed by such applications, environment variables needed to make the modules load, and finally a script that will do the work for us.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-settings" class="title" >Settings   </h4>  </div> </div></div><p><a class="link" href="https://developer.gnome.org/gio/stable/GSettings.html"  target="_top">GSettings</a> API is often used for storing settings. GSettings schemas are required, to know the type and other metadata of the stored values. GLib looks for <code class="literal">glib-2.0/schemas/gschemas.compiled</code> files inside the directories of <code class="literal">XDG_DATA_DIRS</code>.</p><p>On Linux, GSettings API is implemented using <a class="link" href="https://gitlab.gnome.org/GNOME/dconf"  target="_top">dconf</a> backend. You will need to add <code class="literal">dconf</code> <a class="link" href="index.html#ssec-gnome-gio-modules" title="GIO modules" >GIO module</a> to <code class="literal">GIO_EXTRA_MODULES</code> variable, otherwise the <code class="literal">memory</code> backend will be used and the saved settings will not be persistent.</p><p>Last you will need the dconf database D-Bus service itself. You can enable it using <code class="literal">programs.dconf.enable</code>.</p><p>Some applications will also require <code class="literal">gsettings-desktop-schemas</code> for things like reading proxy configuration or user interface customization. This dependency is often not mentioned by upstream, you should grep for <code class="literal">org.gnome.desktop</code> and <code class="literal">org.gnome.system</code> to see if the schemas are needed.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-gio-modules" class="title" >GIO modules   </h4>  </div> </div></div><p>GLib’s <a class="link" href="https://developer.gnome.org/gio/stable/ch01.html"  target="_top">GIO</a> library supports several <a class="link" href="https://developer.gnome.org/gio/stable/extending-gio.html"  target="_top">extension points</a>. Notably, they allow:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>implementing settings backends (already <a class="link" href="index.html#ssec-gnome-settings" title="Settings" >mentioned</a>)</p></li><li class="listitem"><p>adding TLS support</p></li><li class="listitem"><p>proxy settings</p></li><li class="listitem"><p>virtual file systems</p></li></ul></div><p>The modules are typically installed to <code class="literal">lib/gio/modules/</code> directory of a package and you need to add them to <code class="literal">GIO_EXTRA_MODULES</code> if you need any of those features.</p><p>In particular, we recommend:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>adding <code class="literal">dconf.lib</code> for any software on Linux that reads <a class="link" href="index.html#ssec-gnome-settings" title="Settings" >GSettings</a> (even transitively through e.g. GTK’s file manager)</p></li><li class="listitem"><p>adding <code class="literal">glib-networking</code> for any software that accesses network using GIO or libsoup – glib-networking contains a module that implements TLS support and loads system-wide proxy settings</p></li></ul></div><p>To allow software to use various virtual file systems, <code class="literal">gvfs</code> package can be also added. But that is usually an optional feature so we typically use <code class="literal">gvfs</code> from the system (e.g. installed globally using NixOS module).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-gdk-pixbuf-loaders" class="title" >GdkPixbuf loaders   </h4>  </div> </div></div><p>GTK applications typically use <a class="link" href="https://gitlab.gnome.org/GNOME/gdk-pixbuf/"  target="_top">GdkPixbuf</a> to load images. But <code class="literal">gdk-pixbuf</code> package only supports basic bitmap formats like JPEG, PNG or TIFF, requiring to use third-party loader modules for other formats. This is especially painful since GTK itself includes SVG icons, which cannot be rendered without a loader provided by <code class="literal">librsvg</code>.</p><p>Unlike other libraries mentioned in this section, GdkPixbuf only supports a single value in its controlling environment variable <code class="literal">GDK_PIXBUF_MODULE_FILE</code>. It is supposed to point to a cache file containing information about the available loaders. Each loader package will contain a <code class="literal">lib/gdk-pixbuf-2.0/2.10.0/loaders.cache</code> file describing the default loaders in <code class="literal">gdk-pixbuf</code> package plus the loader contained in the package itself. If you want to use multiple third-party loaders, you will need to create your own cache file manually. Fortunately, this is pretty rare as <a class="link" href="https://gitlab.gnome.org/federico/gdk-pixbuf-survey/blob/master/src/modules.md"  target="_top">not many loaders exist</a>.</p><p><code class="literal">gdk-pixbuf</code> contains <a class="link" href="index.html#ssec-gnome-hooks-gdk-pixbuf"  >a setup hook</a> that sets <code class="literal">GDK_PIXBUF_MODULE_FILE</code> from dependencies but as mentioned in further section, it is pretty limited. Loaders should propagate this setup hook.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-icons" class="title" >Icons   </h4>  </div> </div></div><p>When an application uses icons, an icon theme should be available in <code class="literal">XDG_DATA_DIRS</code> during runtime. The package for the default, icon-less <a class="link" href="https://www.freedesktop.org/wiki/Software/icon-theme/"  target="_top">hicolor-icon-theme</a> (should be propagated by every icon theme) contains <a class="link" href="index.html#ssec-gnome-hooks-hicolor-icon-theme"  >a setup hook</a> that will pick up icon themes from <code class="literal">buildInputs</code> and add their datadirs to <code class="literal">XDG_ICON_DIRS</code> environment variable (this is Nixpkgs specific, not actually a XDG standard variable). Unfortunately, relying on that would mean every user has to download the theme included in the package expression no matter their preference. For that reason, we leave the installation of icon theme on the user. If you use one of the desktop environments, you probably already have an icon theme installed.</p><p>In the rare case you need to use icons from dependencies (e.g. when an app forces an icon theme), you can use the following to pick them up:</p><pre><code class="programlisting nix">{
  buildInputs = [ pantheon.elementary-icon-theme ];
  preFixup = &#x27;&#x27;
    gappsWrapperArgs+=(
      # The icon theme is hardcoded.
      --prefix XDG_DATA_DIRS : &quot;$XDG_ICON_DIRS&quot;
    )
  &#x27;&#x27;;
}
</code></pre><p>To avoid costly file system access when locating icons, GTK, <a class="link" href="https://woboq.com/blog/qicon-reads-gtk-icon-cache-in-qt57.html"  target="_top">as well as Qt</a>, can rely on <code class="literal">icon-theme.cache</code> files from the themes’ top-level directories. These files are generated using <code class="literal">gtk-update-icon-cache</code>, which is expected to be run whenever an icon is added or removed to an icon theme (typically an application icon into <code class="literal">hicolor</code> theme) and some programs do indeed run this after icon installation. However, since packages are installed into their own prefix by Nix, this would lead to conflicts. For that reason, <code class="literal">gtk3</code> provides a <a class="link" href="index.html#ssec-gnome-hooks-gtk-drop-icon-theme-cache"  >setup hook</a> that will clean the file from installation. Since most applications only ship their own icon that will be loaded on start-up, it should not affect them too much. On the other hand, icon themes are much larger and more widely used so we need to cache them. Because we recommend installing icon themes globally, we will generate the cache files from all packages in a profile using a NixOS module. You can enable the cache generation using <code class="literal">gtk.iconCache.enable</code> option if your desktop environment does not already do that.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-icon-theme-packaging" class="title" >Packaging icon themes   </h4>  </div> </div></div><p>Icon themes may inherit from other icon themes. The inheritance is specified using the <code class="literal">Inherits</code> key in the <code class="literal">index.theme</code> file distributed with the icon theme. According to the <a class="link" href="https://specifications.freedesktop.org/icon-theme-spec/latest"  target="_top">icon theme specification</a>, icons not provided by the theme are looked for in its parent icon themes. Therefore the parent themes should be installed as dependencies for a more complete experience regarding the icon sets used.</p><p>The package <code class="literal">hicolor-icon-theme</code> provides a setup hook which makes symbolic links for the parent themes into the directory <code class="literal">share/icons</code> of the current theme directory in the nix store, making sure they can be found at runtime. For that to work the packages providing parent icon themes should be listed as propagated build dependencies, together with <code class="literal">hicolor-icon-theme</code>.</p><p>Also make sure that <code class="literal">icon-theme.cache</code> is installed for each theme provided by the package, and set <code class="literal">dontDropIconThemeCache</code> to <code class="literal">true</code> so that the cache file is not removed by the <code class="literal">gtk3</code> setup hook.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-themes" class="title" >GTK Themes   </h4>  </div> </div></div><p>Previously, a GTK theme needed to be in <code class="literal">XDG_DATA_DIRS</code>. This is no longer necessary for most programs since GTK incorporated Adwaita theme. Some programs (for example, those designed for <a class="link" href="https://docs.elementary.io/hig"  target="_top">elementary HIG</a>) might require a special theme like <code class="literal">pantheon.elementary-gtk-theme</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-typelibs" class="title" >GObject introspection typelibs   </h4>  </div> </div></div><p><a class="link" href="https://gitlab.gnome.org/GNOME/gobject-introspection"  target="_top">GObject introspection</a> allows applications to use C libraries in other languages easily. It does this through <code class="literal">typelib</code> files searched in <code class="literal">GI_TYPELIB_PATH</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-plugins" class="title" >Various plug-ins   </h4>  </div> </div></div><p>If your application uses <a class="link" href="https://gstreamer.freedesktop.org/"  target="_top">GStreamer</a> or <a class="link" href="https://gitlab.gnome.org/GNOME/grilo"  target="_top">Grilo</a>, you should set <code class="literal">GST_PLUGIN_SYSTEM_PATH_1_0</code> and <code class="literal">GRL_PLUGIN_PATH</code>, respectively.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-gnome-hooks" class="title" >Onto <code class="literal">wrapGApps*</code> hooks   </h3>  </div> </div></div><p>Given the requirements above, the package expression would become messy quickly:</p><pre><code class="programlisting nix">{
  preFixup = &#x27;&#x27;
    for f in $(find $out/bin/ $out/libexec/ -type f -executable); do
      wrapProgram &quot;$f&quot; \
        --prefix GIO_EXTRA_MODULES : &quot;${getLib dconf}/lib/gio/modules&quot; \
        --prefix XDG_DATA_DIRS : &quot;$out/share&quot; \
        --prefix XDG_DATA_DIRS : &quot;$out/share/gsettings-schemas/${name}&quot; \
        --prefix XDG_DATA_DIRS : &quot;${gsettings-desktop-schemas}/share/gsettings-schemas/${gsettings-desktop-schemas.name}&quot; \
        --prefix XDG_DATA_DIRS : &quot;${hicolor-icon-theme}/share&quot; \
        --prefix GI_TYPELIB_PATH : &quot;${
          lib.makeSearchPath &quot;lib/girepository-1.0&quot; [
            pango
            json-glib
          ]
        }&quot;
    done
  &#x27;&#x27;;
}
</code></pre><p>Fortunately, we have a <span id="ssec-gnome-hooks-wrapgappshook"></span>family of hooks that automate this. They work in conjunction with other setup hooks that populate environment variables, and will then wrap all executables in <code class="literal">bin</code> and <code class="literal">libexec</code> directories using said variables.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><span id="ssec-gnome-hooks-wrapgappshook3"></span><code class="literal">wrapGAppsHook3</code> for GTK 3 apps. For convenience, it also adds <code class="literal">dconf.lib</code> for a GIO module implementing a GSettings backend using <code class="literal">dconf</code>, <code class="literal">gtk3</code> for GSettings schemas, and <code class="literal">librsvg</code> for GdkPixbuf loader to the closure.</p></li><li class="listitem"><p><span id="ssec-gnome-hooks-wrapgappshook4"></span><code class="literal">wrapGAppsHook4</code> for GTK 4 apps. Same as <code class="literal">wrapGAppsHook3</code> but replaces <code class="literal">gtk3</code> with <code class="literal">gtk4</code>.</p></li><li class="listitem"><p><span id="ssec-gnome-hooks-wrapgappsnoguihook"></span><code class="literal">wrapGAppsNoGuiHook</code> for programs without a graphical interface. Same as the above but does not bring <code class="literal">gtk3</code> and <code class="literal">librsvg</code> into the closure.</p></li></ul></div><p>The hooks do the the following:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">wrapGApps*</code> hook itself will add the package’s <code class="literal">share</code> directory to <code class="literal">XDG_DATA_DIRS</code>.</p></li><li class="listitem"><p><span id="ssec-gnome-hooks-glib"></span> <code class="literal">glib</code> setup hook will populate <code class="literal">GSETTINGS_SCHEMAS_PATH</code> and then <code class="literal">wrapGApps*</code> hook will prepend it to <code class="literal">XDG_DATA_DIRS</code>.</p></li><li class="listitem"><p><span id="ssec-gnome-hooks-gdk-pixbuf"></span> <code class="literal">gdk-pixbuf</code> setup hook will populate <code class="literal">GDK_PIXBUF_MODULE_FILE</code> with the path to biggest <code class="literal">loaders.cache</code> file from the dependencies containing <a class="link" href="index.html#ssec-gnome-gdk-pixbuf-loaders" title="GdkPixbuf loaders" >GdkPixbuf loaders</a>. This works fine when there are only two packages containing loaders (<code class="literal">gdk-pixbuf</code> and e.g. <code class="literal">librsvg</code>) – it will choose the second one, reasonably expecting that it will be bigger since it describes extra loader in addition to the default ones. But when there are more than two loader packages, this logic will break. One possible solution would be constructing a custom cache file for each package containing a program like <code class="literal">services/x11/gdk-pixbuf.nix</code> NixOS module does. <code class="literal">wrapGApps*</code> hook copies the <code class="literal">GDK_PIXBUF_MODULE_FILE</code> environment variable into the produced wrapper.</p></li><li class="listitem"><p><span id="ssec-gnome-hooks-gtk-drop-icon-theme-cache"></span> One of <code class="literal">gtk3</code>’s setup hooks will remove <code class="literal">icon-theme.cache</code> files from package’s icon theme directories to avoid conflicts. Icon theme packages should prevent this with <code class="literal">dontDropIconThemeCache = true;</code>.</p></li><li class="listitem"><p><span id="ssec-gnome-hooks-dconf"></span> <code class="literal">dconf.lib</code> is a dependency of <code class="literal">wrapGApps*</code> hook, which then also adds it to the <code class="literal">GIO_EXTRA_MODULES</code> variable.</p></li><li class="listitem"><p><span id="ssec-gnome-hooks-hicolor-icon-theme"></span> <code class="literal">hicolor-icon-theme</code>’s setup hook will add icon themes to <code class="literal">XDG_ICON_DIRS</code>.</p></li><li class="listitem"><p><span id="ssec-gnome-hooks-gobject-introspection"></span> <code class="literal">gobject-introspection</code> setup hook populates <code class="literal">GI_TYPELIB_PATH</code> variable with <code class="literal">lib/girepository-1.0</code> directories of dependencies, which is then added to wrapper by <code class="literal">wrapGApps*</code> hook. It also adds <code class="literal">share</code> directories of dependencies to <code class="literal">XDG_DATA_DIRS</code>, which is intended to promote GIR files but it also <a class="link" href="https://github.com/NixOS/nixpkgs/issues/32790"  target="_top">pollutes the closures</a> of packages using <code class="literal">wrapGApps*</code> hook.</p></li><li class="listitem"><p><span id="ssec-gnome-hooks-gst-grl-plugins"></span> Setup hooks of <code class="literal">gst_all_1.gstreamer</code> and <code class="literal">grilo</code> will populate the <code class="literal">GST_PLUGIN_SYSTEM_PATH_1_0</code> and <code class="literal">GRL_PLUGIN_PATH</code> variables, respectively, which will then be added to the wrapper by <code class="literal">wrapGApps*</code> hook.</p></li></ul></div><p>You can also pass additional arguments to <code class="literal">makeWrapper</code> using <code class="literal">gappsWrapperArgs</code> in <code class="literal">preFixup</code> hook:</p><pre><code class="programlisting nix">{
  preFixup = &#x27;&#x27;
    gappsWrapperArgs+=(
      # Thumbnailers
      --prefix XDG_DATA_DIRS : &quot;${gdk-pixbuf}/share&quot;
      --prefix XDG_DATA_DIRS : &quot;${librsvg}/share&quot;
      --prefix XDG_DATA_DIRS : &quot;${shared-mime-info}/share&quot;
    )
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-gnome-updating" class="title" >Updating GNOME packages   </h3>  </div> </div></div><p>Most GNOME package offer <a class="link" href="index.html#var-passthru-updateScript" title="passthru.updateScript" ><code class="literal">updateScript</code></a>, it is therefore possible to update to latest source tarball by running <code class="literal">nix-shell maintainers/scripts/update.nix --argstr package nautilus</code> or even en masse with <code class="literal">nix-shell maintainers/scripts/update.nix --argstr path gnome</code>. Read the package’s <code class="literal">NEWS</code> file to see what changed.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-gnome-common-issues" class="title" >Frequently encountered issues   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-common-issues-no-schemas" class="title" ><code class="literal">GLib-GIO-ERROR **: 06:04:50.903: No GSettings schemas are installed on the system</code>   </h4>  </div> </div></div><p>There are no schemas available in <code class="literal">XDG_DATA_DIRS</code>. Temporarily add a random package containing schemas like <code class="literal">gsettings-desktop-schemas</code> to <code class="literal">buildInputs</code>. <a class="link" href="index.html#ssec-gnome-hooks-glib"  ><code class="literal">glib</code></a> and <a class="link" href="index.html#ssec-gnome-hooks-wrapgappshook"  ><code class="literal">wrapGApps*</code></a> setup hooks will take care of making the schemas available to application and you will see the actual missing schemas with the <a class="link" href="index.html#ssec-gnome-common-issues-missing-schema" title="GLib-GIO-ERROR **: 06:04:50.903: Settings schema ‘org.gnome.foo’ is not installed" >next error</a>. Or you can try looking through the source code for the actual schemas used.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-common-issues-missing-schema" class="title" ><code class="literal">GLib-GIO-ERROR **: 06:04:50.903: Settings schema ‘org.gnome.foo’ is not installed</code>   </h4>  </div> </div></div><p>Package is missing some GSettings schemas. You can find out the package containing the schema with <code class="literal">nix-locate org.gnome.foo.gschema.xml</code> and let the hooks handle the wrapping as <a class="link" href="index.html#ssec-gnome-common-issues-no-schemas" title="GLib-GIO-ERROR **: 06:04:50.903: No GSettings schemas are installed on the system" >above</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-common-issues-double-wrapped" class="title" >When using <code class="literal">wrapGApps*</code> hook with special derivers or hooks you can end up with double wrapped binaries.   </h4>  </div> </div></div><p>This is because some setup hooks like <code class="literal">qt6.wrapQtAppsHook</code> also wrap programs using <code class="literal">makeWrapper</code>.  Likewise, some derivers (e.g. <code class="literal">python.pkgs.buildPythonApplication</code>) automatically pull in their own setup hooks that produce wrappers.</p><p>The simplest workaround is to disable the <code class="literal">wrapGApps*</code> hook’s automatic wrapping using <code class="literal">dontWrapGApps = true;</code> while passing its <code class="literal">makeWrapper</code> arguments to another wrapper.</p><p>In the case of a Python application it could look like:</p><pre><code class="programlisting nix">python3.pkgs.buildPythonApplication {
  pname = &quot;gnome-music&quot;;
  version = &quot;3.32.2&quot;;

  nativeBuildInputs = [
    wrapGAppsHook3
    gobject-introspection
    # ...
  ];

  dontWrapGApps = true;

  # Arguments to be passed to `makeWrapper`, only used by buildPython*
  preFixup = &#x27;&#x27;
    makeWrapperArgs+=(&quot;&#x27;&#x27;${gappsWrapperArgs[@]}&quot;)
  &#x27;&#x27;;
}
</code></pre><p>And for a QT app like:</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  pname = &quot;calibre&quot;;
  version = &quot;3.47.0&quot;;

  nativeBuildInputs = [
    wrapGAppsHook3
    qt6.wrapQtAppsHook
    qmake
    # ...
  ];

  dontWrapGApps = true;

  preFixup = &#x27;&#x27;
    qtWrapperArgs+=(&quot;&#x27;&#x27;${gappsWrapperArgs[@]}&quot;)
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-common-issues-unwrappable-package" class="title" >I am packaging a project that cannot be wrapped, like a library or GNOME Shell extension.   </h4>  </div> </div></div><p>You can rely on applications depending on the library setting the necessary environment variables but that is often easy to miss. Instead we recommend to patch the paths in the source code whenever possible. Here are some examples:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><span id="ssec-gnome-common-issues-unwrappable-package-gnome-shell-ext"></span> <a class="link" href="https://github.com/NixOS/nixpkgs/blob/e981466fbb08e6231a1377539ff17fbba3270fda/pkgs/by-name/gn/gnome-shell-extensions/package.nix#L25-L32"  target="_top">Replacing a <code class="literal">GI_TYPELIB_PATH</code> in GNOME Shell extension</a> – we are using <code class="literal">replaceVars</code> to include the path to a typelib into a patch.</p></li><li class="listitem"><p><span id="ssec-gnome-common-issues-unwrappable-package-gsettings"></span> The following examples are hardcoding GSettings schema paths. To get the schema paths we use the functions</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: circle;"><li class="listitem"><p><code class="literal">glib.getSchemaPath</code> Takes a nix package attribute as an argument.</p></li><li class="listitem"><p><code class="literal">glib.makeSchemaPath</code> Takes a package output like <code class="literal">$out</code> and a derivation name. You should use this if the schemas you need to hardcode are in the same derivation.</p></li></ul></div><p><span id="ssec-gnome-common-issues-unwrappable-package-gsettings-vala"></span> <a class="link" href="https://github.com/NixOS/nixpkgs/blob/7bb8f05f12ca3cff9da72b56caa2f7472d5732bc/pkgs/desktops/pantheon/apps/elementary-files/default.nix#L78-L86"  target="_top">Hard-coding GSettings schema path in Vala plug-in (dynamically loaded library)</a> – here, <code class="literal">replaceVars</code> cannot be used since the schema comes from the same package preventing us from pass its path to the function, probably due to a <a class="link" href="https://github.com/NixOS/nix/issues/1846"  target="_top">Nix bug</a>.</p><p><span id="ssec-gnome-common-issues-unwrappable-package-gsettings-c"></span> <a class="link" href="https://github.com/NixOS/nixpkgs/blob/29c120c065d03b000224872251bed93932d42412/pkgs/development/libraries/glib-networking/default.nix#L31-L34"  target="_top">Hard-coding GSettings schema path in C library</a> – nothing special other than using <a class="link" href="https://github.com/NixOS/nixpkgs/pull/67957#issuecomment-527717467"  target="_top">Coccinelle patch</a> to generate the patch itself.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-gnome-common-issues-weird-location" class="title" >I need to wrap a binary outside <code class="literal">bin</code> and <code class="literal">libexec</code> directories.   </h4>  </div> </div></div><p>You can manually trigger the wrapping with <code class="literal">wrapGApp</code> in <code class="literal">preFixup</code> phase. It takes a path to a program as a first argument; the remaining arguments are passed directly to <a class="link" href="index.html#fun-wrapProgram" title="wrapProgram &lt;executable&gt; &lt;makeWrapperArgs&gt;" ><code class="literal">wrapProgram</code></a> function.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-go" class="title" style="clear: both">Go   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-language-go">Building Go modules with <code class="literal">buildGoModule</code></a> </span></dt><dt> <span class="section">  <a href="index.html#buildgomodule-parameters">Attributes of <code class="literal">buildGoModule</code></a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-go-toolchain-versions">Versioned toolchains and builders</a> </span></dt><dt> <span class="section">  <a href="index.html#buildGoModule-goModules-override">Overriding <code class="literal">goModules</code></a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-go-environment">Controlling the Go environment</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-skip-go-tests">Skipping tests</a> </span></dt><dt> <span class="section">  <a href="index.html#buildGoPackage-migration">Migrating from <code class="literal">buildGoPackage</code> to <code class="literal">buildGoModule</code></a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-language-go" class="title" >Building Go modules with <code class="literal">buildGoModule</code>   </h3>  </div> </div></div><p>The function <code class="literal">buildGoModule</code> builds Go programs managed with Go modules. It builds <a class="link" href="https://go.dev/wiki/Modules"  target="_top">Go Modules</a> through a two phase build:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>An intermediate fetcher derivation called <code class="literal">goModules</code>. This derivation will be used to fetch all the dependencies of the Go module.</p></li><li class="listitem"><p>A final derivation will use the output of the intermediate derivation to build the binaries and produce the final output.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ex-buildGoModule" class="title" >Example for <code class="literal">buildGoModule</code>   </h4>  </div> </div></div><p>The following is an example expression using <code class="literal">buildGoModule</code>:</p><pre><code class="programlisting nix">{
  pet = buildGoModule (finalAttrs: {
    pname = &quot;pet&quot;;
    version = &quot;0.3.4&quot;;

    src = fetchFromGitHub {
      owner = &quot;knqyf263&quot;;
      repo = &quot;pet&quot;;
      tag = &quot;v${finalAttrs.version}&quot;;
      hash = &quot;sha256-Gjw1dRrgM8D3G7v6WIM2+50r4HmTXvx0Xxme2fH9TlQ=&quot;;
    };

    vendorHash = &quot;sha256-ciBIR+a1oaYH+H1PcC8cD8ncfJczk1IiJ8iYNM+R6aA=&quot;;

    meta = {
      description = &quot;Simple command-line snippet manager, written in Go&quot;;
      homepage = &quot;https://github.com/knqyf263/pet&quot;;
      license = lib.licenses.mit;
      maintainers = with lib.maintainers; [ kalbasit ];
    };
  });
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="buildgomodule-parameters" class="title" >Attributes of <code class="literal">buildGoModule</code>   </h3>  </div> </div></div><p>Many attributes <a class="link" href="index.html#variables-controlling-the-build-phase" title="Variables controlling the build phase" >controlling the build phase</a> are respected by <code class="literal">buildGoModule</code>. Note that <code class="literal">buildGoModule</code> reads the following attributes also when building the <code class="literal">vendor/</code> goModules fixed output derivation as well:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="index.html#var-stdenv-sourceRoot" title="sourceRoot" ><code class="literal">sourceRoot</code></a></p></li><li class="listitem"><p><a class="link" href="index.html#var-stdenv-prePatch" title="prePatch" ><code class="literal">prePatch</code></a></p></li><li class="listitem"><p><a class="link" href="index.html#var-stdenv-patches" title="patches" ><code class="literal">patches</code></a></p></li><li class="listitem"><p><a class="link" href="index.html#var-stdenv-patchFlags" title="patchFlags" ><code class="literal">patchFlags</code></a></p></li><li class="listitem"><p><a class="link" href="index.html#var-stdenv-postPatch" title="postPatch" ><code class="literal">postPatch</code></a></p></li><li class="listitem"><p><a class="link" href="index.html#var-stdenv-preBuild" title="preBuild" ><code class="literal">preBuild</code></a></p></li><li class="listitem"><p><code class="literal">env</code>: useful for passing down variables such as <code class="literal">GOWORK</code>.</p></li></ul></div><p>To control test execution of the build derivation, the following attributes are of interest:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="index.html#var-stdenv-checkInputs" title="checkInputs" ><code class="literal">checkInputs</code></a></p></li><li class="listitem"><p><a class="link" href="index.html#var-stdenv-preCheck" title="preCheck" ><code class="literal">preCheck</code></a></p></li><li class="listitem"><p><a class="link" href="index.html#var-stdenv-checkFlags" title="checkFlags / checkFlagsArray" ><code class="literal">checkFlags</code></a></p></li></ul></div><p>In addition to the above attributes, and the many more variables respected also by <code class="literal">stdenv.mkDerivation</code>, <code class="literal">buildGoModule</code> respects Go-specific attributes that tweak them to behave slightly differently:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-vendorHash" class="title" ><code class="literal">vendorHash</code>   </h4>  </div> </div></div><p>Hash of the output of the intermediate fetcher derivation (the dependencies of the Go modules).</p><p><code class="literal">vendorHash</code> can be set to <code class="literal">null</code>.
In that case, rather than fetching the dependencies, the dependencies already vendored in the <code class="literal">vendor</code> directory of the source repo will be used.</p><p>To avoid updating this field when dependencies change, run <code class="literal">go mod vendor</code> in your source repo and set <code class="literal">vendorHash = null;</code>.
You can read more about <a class="link" href="https://go.dev/ref/mod#vendoring"  target="_top">vendoring in the Go documentation</a>.</p><p>To obtain the hash, set <code class="literal">vendorHash = lib.fakeHash;</code> and run the build. (<a class="link" href="index.html#sec-source-hashes" title="Obtaining source hash" >more details here</a>).
Another way is to use use <code class="literal">nix-prefetch</code> to obtain the hash. The following command gets the value of <code class="literal">vendorHash</code> for package <code class="literal">pet</code>:</p><pre><code class="programlisting sh">cd path/to/nixpkgs
nix-prefetch -E &quot;{ sha256 }: ((import ./. { }).my-package.overrideAttrs { vendorHash = sha256; }).goModules&quot;
</code></pre><p><code class="literal">vendorHash</code> can be overridden with <code class="literal">overrideAttrs</code>. Override the above example like this:</p><pre><code class="programlisting nix">{
  pet_0_4_0 = pet.overrideAttrs (
    finalAttrs: previousAttrs: {
      version = &quot;0.4.0&quot;;
      src = fetchFromGitHub {
        inherit (previousAttrs.src) owner repo;
        rev = &quot;v${finalAttrs.version}&quot;;
        hash = &quot;sha256-gVTpzmXekQxGMucDKskGi+e+34nJwwsXwvQTjRO6Gdg=&quot;;
      };
      vendorHash = &quot;sha256-dUvp7FEW09V0xMuhewPGw3TuAic/sD7xyXEYviZ2Ivs=&quot;;
    }
  );
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-proxyVendor" class="title" ><code class="literal">proxyVendor</code>   </h4>  </div> </div></div><p>If <code class="literal">true</code>, the intermediate fetcher downloads dependencies from the
<a class="link" href="https://go.dev/ref/mod#module-proxy"  target="_top">Go module proxy</a> (using <code class="literal">go mod download</code>) instead of vendoring them. The resulting
<a class="link" href="https://go.dev/ref/mod#module-cache"  target="_top">module cache</a> is then passed to the final derivation.</p><p>This is useful if your code depends on C code and <code class="literal">go mod tidy</code> does not include the needed sources to build or
if any dependency has case-insensitive conflicts which will produce platform-dependent <code class="literal">vendorHash</code> checksums.</p><p>Defaults to <code class="literal">false</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-modPostBuild" class="title" ><code class="literal">modPostBuild</code>   </h4>  </div> </div></div><p>Shell commands to run after the build of the goModules executes <code class="literal">go mod vendor</code>, and before calculating fixed output derivation’s <code class="literal">vendorHash</code>.
Note that if you change this attribute, you need to update <code class="literal">vendorHash</code> attribute.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-modRoot" class="title" ><code class="literal">modRoot</code>   </h4>  </div> </div></div><p>The root directory of the Go module that contains the <code class="literal">go.mod</code> file.</p><p>Defaults to <code class="literal">./</code>, which is the root of <code class="literal">src</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-ldflags" class="title" ><code class="literal">ldflags</code>   </h4>  </div> </div></div><p>A string list of flags to pass to the Go linker tool via the <code class="literal">-ldflags</code> argument of <code class="literal">go build</code>. Possible values can be retrieved by running <code class="literal">go tool link --help</code>.
The most common use case for this argument is to make the resulting executable aware of its own version by injecting the value of string variable using the <code class="literal">-X</code> flag. For example:</p><pre><code class="programlisting nix">{
  ldflags = [
    &quot;-X main.Version=${version}&quot;
    &quot;-X main.Commit=${version}&quot;
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-tags" class="title" ><code class="literal">tags</code>   </h4>  </div> </div></div><p>A string list of <a class="link" href="https://pkg.go.dev/cmd/go#hdr-Build_constraints"  target="_top">Go build tags (also called build constraints)</a> that are passed via the <code class="literal">-tags</code> argument of <code class="literal">go build</code>.  These constraints control whether Go files from the source should be included in the build. For example:</p><pre><code class="programlisting nix">{
  tags = [
    &quot;production&quot;
    &quot;sqlite&quot;
  ];
}
</code></pre><p>Tags can also be set conditionally:</p><pre><code class="programlisting nix">{ tags = [ &quot;production&quot; ] ++ lib.optionals withSqlite [ &quot;sqlite&quot; ]; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-deleteVendor" class="title" ><code class="literal">deleteVendor</code>   </h4>  </div> </div></div><p>If set to <code class="literal">true</code>, removes the pre-existing vendor directory. This should only be used if the dependencies included in the vendor folder are broken or incomplete.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-subPackages" class="title" ><code class="literal">subPackages</code>   </h4>  </div> </div></div><p>Specified as a string or list of strings. Limits the builder from building child packages that have not been listed. If <code class="literal">subPackages</code> is not specified, all child packages will be built.</p><p>Many Go projects keep the main package in a <code class="literal">cmd</code> directory.
Following example could be used to only build the example-cli and example-server binaries:</p><pre><code class="programlisting nix">{
  subPackages = [
    &quot;cmd/example-cli&quot;
    &quot;cmd/example-server&quot;
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-excludedPackages" class="title" ><code class="literal">excludedPackages</code>   </h4>  </div> </div></div><p>Specified as a string or list of strings. Causes the builder to skip building child packages that match any of the provided values.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-enableParallelBuilding" class="title" ><code class="literal">enableParallelBuilding</code>   </h4>  </div> </div></div><p>Whether builds and tests should run in parallel.</p><p>Defaults to <code class="literal">true</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-allowGoReference" class="title" ><code class="literal">allowGoReference</code>   </h4>  </div> </div></div><p>Whether the build result should be allowed to contain references to the Go tool chain. This might be needed for programs that are coupled with the compiler, but shouldn’t be set without a good reason.</p><p>Defaults to <code class="literal">false</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-goSum" class="title" ><code class="literal">goSum</code>   </h4>  </div> </div></div><p>Specifies the contents of the <code class="literal">go.sum</code> file and triggers rebuilds when it changes. This helps combat inconsistent dependency errors on <code class="literal">go.sum</code> changes.</p><p>Defaults to <code class="literal">null</code></p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-go-toolchain-versions" class="title" >Versioned toolchains and builders   </h3>  </div> </div></div><p>Beside <code class="literal">buildGoModule</code>, there are also versioned builders available that pin a specific Go version, like <code class="literal">buildGo124Module</code> for Go 1.24.
Similar, versioned toolchains are available, like <code class="literal">go_1_24</code> for Go 1.24.
Both builder and toolchain of a certain version will be removed as soon as the Go version reaches end of life.</p><p>As toolchain updates in nixpkgs cause mass rebuilds and must go through the staging cycle, it can take a while until a new Go minor version is available to consumers of nixpkgs.
If you want quicker access to the latest minor, use <code class="literal">go_latest</code> toolchain and <code class="literal">buildGoLatestModule</code> builder.
To learn more about the Go maintenance and upgrade procedure in nixpkgs, check out the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/build-support/go/README.md#go-toolchainbuilder-upgrade-policy"  target="_top">Go toolchain/builder upgrade policy</a>.</p><div class="warning"><h3 class="title">Warning</h3><p>The use of <code class="literal">go_latest</code> and <code class="literal">buildGoLatestModule</code> is restricted within nixpkgs.
The <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/build-support/go/README.md#go-toolchainbuilder-upgrade-policy"  target="_top">Go toolchain/builder upgrade policy</a> must be followed.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="buildGoModule-goModules-override" class="title" >Overriding <code class="literal">goModules</code>   </h3>  </div> </div></div><p>Overriding <code class="literal">&lt;pkg&gt;.goModules</code> by calling <code class="literal">goModules.overrideAttrs</code> is unsupported. Still, it is possible to override the <code class="literal">vendorHash</code> (<code class="literal">goModules</code>’s <code class="literal">outputHash</code>) and the <code class="literal">pre</code>/<code class="literal">post</code> hooks for both the build and patch phases of the primary and <code class="literal">goModules</code> derivation.</p><p>Alternatively, the primary derivation provides an overridable <code class="literal">passthru.overrideModAttrs</code> function to store the attribute overlay implicitly taken by <code class="literal">goModules.overrideAttrs</code>. Here’s an example usage of <code class="literal">overrideModAttrs</code>:</p><pre><code class="programlisting nix">{
  pet-overridden = pet.overrideAttrs (
    finalAttrs: previousAttrs: {
      passthru = previousAttrs.passthru // {
        # If the original package has an `overrideModAttrs` attribute set, you&#x27;d
        # want to extend it, and not replace it. Hence we use
        # `lib.composeExtensions`. If you are sure the `overrideModAttrs` of the
        # original package trivially does nothing, you can safely replace it
        # with your own by not using `lib.composeExtensions`.
        overrideModAttrs = lib.composeExtensions previousAttrs.passthru.overrideModAttrs (
          finalModAttrs: previousModAttrs: {
            # goModules-specific overriding goes here
            postBuild = &#x27;&#x27;
              # Here you have access to the `vendor` directory.
              substituteInPlace vendor/github.com/example/repo/file.go \
                --replace-fail &quot;panic(err)&quot; &quot;&quot;
            &#x27;&#x27;;
          }
        );
      };
    }
  );
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-go-environment" class="title" >Controlling the Go environment   </h3>  </div> </div></div><p>The Go build can be further tweaked by setting environment variables via the <code class="literal">env</code> attribute. In most cases, this isn’t needed. Possible values can be found in the <a class="link" href="https://pkg.go.dev/cmd/go#hdr-Environment_variables"  target="_top">Go documentation of accepted environment variables</a>. Notice that some of these flags are set by the build helper itself and should not be set explicitly. If in doubt, grep the implementation of the build helper.</p><p><code class="literal">buildGoModule</code> officially supports the following environment variables:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="var-go-CGO_ENABLED" class="title" ><code class="literal">env.CGO_ENABLED</code>   </h4>  </div> </div></div><p>When set to <code class="literal">0</code>, the <a class="link" href="https://pkg.go.dev/cmd/cgo"  target="_top">cgo</a> command is disabled. As consequence, the build
program can’t link against C libraries anymore, and the resulting binary is statically linked.</p><p>When building with CGO enabled, Go will likely link some packages from the Go standard library against C libraries,
even when the target code does not explicitly call into C dependencies. With <code class="literal">env.CGO_ENABLED = 0;</code>, Go
will always use the Go native implementation of these internal packages. For reference see
<a class="link" href="https://pkg.go.dev/net#hdr-Name_Resolution"  target="_top">net</a> and <a class="link" href="https://pkg.go.dev/os/user#pkg-overview"  target="_top">os/user</a> packages.
Notice that the decision whether these packages should use native Go implementation or not can also be controlled
on a per package level using build tags (<code class="literal">tags</code>). In case CGO is disabled, these tags have no additional effect.</p><p>When a Go program depends on C libraries, place those dependencies in <code class="literal">buildInputs</code>:</p><pre><code class="programlisting nix">{
  buildInputs = [
    libvirt
    libxml2
  ];
}
</code></pre><p><code class="literal">env.CGO_ENABLED</code> defaults to <code class="literal">1</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-skip-go-tests" class="title" >Skipping tests   </h3>  </div> </div></div><p><code class="literal">buildGoModule</code> runs tests by default. Failing tests can be disabled using the <code class="literal">checkFlags</code> parameter.
This is done with the <a class="link" href="https://pkg.go.dev/cmd/go#hdr-Testing_flags"  target="_top"><code class="literal">-skip</code> or <code class="literal">-run</code></a> flags of the <code class="literal">go test</code> command.</p><p>For example, only a selection of tests could be run with:</p><pre><code class="programlisting nix">{
  # -run and -skip accept regular expressions
  checkFlags = [ &quot;-run=^Test(Simple|Fast)$&quot; ];
}
</code></pre><p>If a larger amount of tests should be skipped, the following pattern can be used:</p><pre><code class="programlisting nix">{
  checkFlags =
    let
      # Skip tests that require network access
      skippedTests = [
        &quot;TestNetwork&quot;
        &quot;TestDatabase/with_mysql&quot; # exclude only the subtest
        &quot;TestIntegration&quot;
      ];
    in
    [ &quot;-skip=^${builtins.concatStringsSep &quot;$|^&quot; skippedTests}$&quot; ];
}
</code></pre><p>To disable tests altogether, set <code class="literal">doCheck = false;</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="buildGoPackage-migration" class="title" >Migrating from <code class="literal">buildGoPackage</code> to <code class="literal">buildGoModule</code>   </h3>  </div> </div></div><div class="warning"><h3 class="title">Warning</h3><p><code class="literal">buildGoPackage</code> was removed for the 25.05 release. It was used to build legacy Go programs
that do not support Go modules.</p></div><p>Go modules, released 6y ago, are now widely adopted in the ecosystem.
Most upstream projects are using Go modules, and the tooling previously used for dependency management in Go is mostly deprecated, archived or at least unmaintained at this point.</p><p>In case a project doesn’t have external dependencies or dependencies are vendored in a way understood by <code class="literal">go mod init</code>, migration can be done with a few changes in the package.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Switch the builder from <code class="literal">buildGoPackage</code> to <code class="literal">buildGoModule</code></p></li><li class="listitem"><p>Remove <code class="literal">goPackagePath</code> and other attributes specific to <code class="literal">buildGoPackage</code></p></li><li class="listitem"><p>Set <code class="literal">vendorHash = null;</code></p></li><li class="listitem"><p>Run <code class="literal">go mod init &lt;module name&gt;</code> in <code class="literal">postPatch</code></p></li></ul></div><p>In case the package has external dependencies that aren’t vendored or the build setup is more complex the upstream source might need to be patched.
Examples for the migration can be found in the <a class="link" href="https://github.com/NixOS/nixpkgs/issues/318069"  target="_top">issue tracking migration within nixpkgs</a>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="gradle" class="title" style="clear: both">Gradle   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#building-a-gradle-package">Building a Gradle package</a> </span></dt><dt> <span class="section">  <a href="index.html#gradle-update-script">Update Script</a> </span></dt><dt> <span class="section">  <a href="index.html#gradle-environment">Environment</a> </span></dt> </dl></div><p>Gradle is a popular build tool for Java/Kotlin. Gradle itself doesn’t
currently provide tools to make dependency resolution reproducible, so
nixpkgs has a proxy designed for intercepting Gradle web requests to
record dependencies so they can be restored in a reproducible fashion.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="building-a-gradle-package" class="title" >Building a Gradle package   </h3>  </div> </div></div><p>Here’s how a typical derivation will look like:</p><pre><code class="programlisting nix">stdenv.mkDerivation (finalAttrs: {
  pname = &quot;pdftk&quot;;
  version = &quot;3.3.3&quot;;

  src = fetchFromGitLab {
    owner = &quot;pdftk-java&quot;;
    repo = &quot;pdftk&quot;;
    tag = &quot;v${finalAttrs.version}&quot;;
    hash = &quot;sha256-ciKotTHSEcITfQYKFZ6sY2LZnXGChBJy0+eno8B3YHY=&quot;;
  };

  nativeBuildInputs = [
    gradle
    makeWrapper
  ];

  # if the package has dependencies, mitmCache must be set
  mitmCache = gradle.fetchDeps {
    inherit (finalAttrs) pname;
    data = ./deps.json;
  };

  # this is required for using mitm-cache on Darwin
  __darwinAllowLocalNetworking = true;

  gradleFlags = [ &quot;-Dfile.encoding=utf-8&quot; ];

  # defaults to &quot;assemble&quot;
  gradleBuildTask = &quot;shadowJar&quot;;

  # will run the gradleCheckTask (defaults to &quot;test&quot;)
  doCheck = true;

  installPhase = &#x27;&#x27;
    mkdir -p $out/{bin,share/pdftk}
    cp build/libs/pdftk-all.jar $out/share/pdftk

    makeWrapper ${lib.getExe jre} $out/bin/pdftk \
      --add-flags &quot;-jar $out/share/pdftk/pdftk-all.jar&quot;

    cp ${finalAttrs.src}/pdftk.1 $out/share/man/man1
  &#x27;&#x27;;

  meta.sourceProvenance = with lib.sourceTypes; [
    fromSource
    binaryBytecode # mitm cache
  ];
})
</code></pre><p>To update (or initialize) dependencies, run the update script via
something like <code class="literal">$(nix-build -A &lt;pname&gt;.mitmCache.updateScript)</code>
(<code class="literal">nix-build</code> builds the <code class="literal">updateScript</code>, <code class="literal">$(...)</code> runs the script at the
path printed by <code class="literal">nix-build</code>).</p><p>If your package can’t be evaluated using a simple <code class="literal">pkgs.&lt;pname&gt;</code>
expression (for example, if your package isn’t located in nixpkgs, or if
you want to override some of its attributes), you will usually have to
pass <code class="literal">pkg</code> instead of <code class="literal">pname</code> to <code class="literal">gradle.fetchDeps</code>. There are two ways
of doing it.</p><p>The first is to add the derivation arguments required for getting the
package. Using the pdftk example above:</p><pre><code class="programlisting nix">{
  lib,
  stdenv,
  gradle,
  # ...
  pdftk,
}:

stdenv.mkDerivation (finalAttrs: {
  # ...
  mitmCache = gradle.fetchDeps {
    pkg = pdftk;
    data = ./deps.json;
  };
})
</code></pre><p>This allows you to <code class="literal">override</code> any arguments of the <code class="literal">pkg</code> used for the update script (for example, <code class="literal">pkg = pdftk.override { enableSomeFlag = true };)</code>.</p><p>The second is to use <code class="literal">finalAttrs.finalPackage</code> like this:</p><pre><code class="programlisting nix">stdenv.mkDerivation (finalAttrs: {
  # ...
  mitmCache = gradle.fetchDeps {
    pkg = finalAttrs.finalPackage;
    data = ./deps.json;
  };
})
</code></pre><p>The limitation of this method is that you cannot override the <code class="literal">pkg</code> derivations’s arguments.</p><p>In the former case, the update script will stay the same even if the derivation is called with different arguments. In the latter case, the update script will change depending on the derivation arguments. It’s up to you to decide which one would work best for your derivation.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="gradle-update-script" class="title" >Update Script   </h3>  </div> </div></div><p>The update script does the following:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Build the derivation’s source via <code class="literal">pkgs.srcOnly</code></p></li><li class="listitem"><p>Enter a <code class="literal">nix-shell</code> for the derivation in a <code class="literal">bwrap</code> sandbox (the
sandbox is only used on Linux)</p></li><li class="listitem"><p>Set the <code class="literal">IN_GRADLE_UPDATE_DEPS</code> environment variable to <code class="literal">1</code></p></li><li class="listitem"><p>Run the derivation’s <code class="literal">unpackPhase</code>, <code class="literal">patchPhase</code>, <code class="literal">configurePhase</code></p></li><li class="listitem"><p>Run the derivation’s <code class="literal">gradleUpdateScript</code> (the Gradle setup hook sets
a default value for it, which runs <code class="literal">preBuild</code>, <code class="literal">preGradleUpdate</code>
hooks, fetches the dependencies using <code class="literal">gradleUpdateTask</code>, and finally
runs the <code class="literal">postGradleUpdate</code> hook)</p></li><li class="listitem"><p>Finally, store all of the fetched files’ hashes in the lockfile. They
may be <code class="literal">.jar</code>/<code class="literal">.pom</code> files from Maven repositories, or they may be
files otherwise used for building the package.</p></li></ul></div><p><code class="literal">fetchDeps</code> takes the following arguments:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">attrPath</code> - the path to the package in nixpkgs (for example,
<code class="literal">&quot;javaPackages.openjfx22&quot;</code>). Used for update script metadata.</p></li><li class="listitem"><p><code class="literal">pname</code> - an alias for <code class="literal">attrPath</code> for convenience. This is what you
will generally use instead of <code class="literal">pkg</code> or <code class="literal">attrPath</code>.</p></li><li class="listitem"><p><code class="literal">pkg</code> - the package to be used for fetching the dependencies. Defaults
to <code class="literal">getAttrFromPath (splitString &quot;.&quot; attrPath) pkgs</code>.</p></li><li class="listitem"><p><code class="literal">bwrapFlags</code> - allows you to override bwrap flags (only relevant for
downstream, non-nixpkgs projects)</p></li><li class="listitem"><p><code class="literal">data</code> - path to the dependencies lockfile (can be relative to the
package, can be absolute). In nixpkgs, it’s discouraged to have the
lockfiles be named anything other <code class="literal">deps.json</code>, consider creating
subdirectories if your package requires multiple <code class="literal">deps.json</code> files.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="gradle-environment" class="title" >Environment   </h3>  </div> </div></div><p>The Gradle setup hook accepts the following environment variables:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">mitmCache</code> - the MITM proxy cache imported using <code class="literal">gradle.fetchDeps</code></p></li><li class="listitem"><p><code class="literal">gradleFlags</code> - command-line flags to be used for every Gradle
invocation (this simply registers a function that uses the necessary
flags).</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>You can’t use <code class="literal">gradleFlags</code> for flags that contain spaces, in that
case you must add <code class="literal">gradleFlagsArray+=(&quot;-flag with spaces&quot;)</code> to the
derivation’s bash code instead.</p></li><li class="listitem"><p>If you want to build the package using a specific Java version, you
can pass <code class="literal">&quot;-Dorg.gradle.java.home=${jdk}&quot;</code> as one of the flags.</p></li></ul></div></li><li class="listitem"><p><code class="literal">gradleBuildTask</code> - the Gradle task (or tasks) to be used for building
the package. Defaults to <code class="literal">assemble</code>.</p></li><li class="listitem"><p><code class="literal">gradleCheckTask</code> - the Gradle task (or tasks) to be used for checking
the package if <code class="literal">doCheck</code> is set to <code class="literal">true</code>. Defaults to <code class="literal">test</code>.</p></li><li class="listitem"><p><code class="literal">gradleUpdateTask</code> - the Gradle task (or tasks) to be used for
fetching all of the package’s dependencies in
<code class="literal">mitmCache.updateScript</code>. Defaults to <code class="literal">nixDownloadDeps</code>.</p></li><li class="listitem"><p><code class="literal">gradleUpdateScript</code> - the code to run for fetching all of the
package’s dependencies in <code class="literal">mitmCache.updateScript</code>. Defaults to
running the <code class="literal">preBuild</code> and <code class="literal">preGradleUpdate</code> hooks, running the
<code class="literal">gradleUpdateTask</code>, and finally running the <code class="literal">postGradleUpdate</code> hook.</p></li><li class="listitem"><p><code class="literal">gradleInitScript</code> - path to the <code class="literal">--init-script</code> to pass to Gradle. By
default, a simple init script that enables reproducible archive
creation is used.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Note that reproducible archives might break some builds. One example
of an error caused by it is <code class="literal">Could not create task &#x27;:jar&#x27;. Replacing an existing task that may have already been used by other plugins is not supported</code>. If you get such an error, the easiest “fix” is
disabling reproducible archives altogether by setting
<code class="literal">gradleInitScript</code> to something like <code class="literal">writeText &quot;empty-init-script.gradle&quot; &quot;&quot;</code></p></li></ul></div></li><li class="listitem"><p><code class="literal">enableParallelBuilding</code> / <code class="literal">enableParallelChecking</code> /
<code class="literal">enableParallelUpdating</code> - pass <code class="literal">--parallel</code> to Gradle in the
build/check phase or in the update script. Defaults to true. If the
build fails for mysterious reasons, consider setting this to false.</p></li><li class="listitem"><p><code class="literal">dontUseGradleConfigure</code> / <code class="literal">dontUseGradleBuild</code> / <code class="literal">dontUseGradleCheck</code>
- force disable the Gradle setup hook for certain phases.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Note that if you disable the configure hook, you may face issues
such as <code class="literal">Failed to load native library &#x27;libnative-platform.so&#x27;</code>,
because the configure hook is responsible for initializing Gradle.</p></li></ul></div></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-hare" class="title" style="clear: both">Hare   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-language-hare">Building Hare programs with <code class="literal">hareHook</code></a> </span></dt><dt> <span class="section">  <a href="index.html#hareHook-attributes">Attributes of <code class="literal">hareHook</code></a> </span></dt><dt> <span class="section">  <a href="index.html#ex-hareHook">Example for <code class="literal">hareHook</code></a> </span></dt><dt> <span class="section">  <a href="index.html#hareHook-cross-compilation">Cross Compilation</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-language-hare" class="title" >Building Hare programs with <code class="literal">hareHook</code>   </h3>  </div> </div></div><p>The <code class="literal">hareHook</code> package sets up the environment for building Hare programs by
doing the following:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Setting the <code class="literal">HARECACHE</code>, <code class="literal">HAREPATH</code> and <code class="literal">NIX_HAREFLAGS</code> environment variables;</p></li><li class="listitem"><p>Propagating <code class="literal">harec</code>, <code class="literal">qbe</code> and two wrapper scripts  for the hare binary.</p></li></ol></div><p>It is not a function as is the case for some other languages — <span class="emphasis"><em>e. g.</em></span>, Go or
Rust —, but a package to be added to <code class="literal">nativeBuildInputs</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="hareHook-attributes" class="title" >Attributes of <code class="literal">hareHook</code>   </h3>  </div> </div></div><p>The following attributes are accepted by <code class="literal">hareHook</code>:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p><code class="literal">hareBuildType</code>: Either <code class="literal">release</code> (default) or <code class="literal">debug</code>. It controls if the
<code class="literal">-R</code> flag is added to <code class="literal">NIX_HAREFLAGS</code>.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ex-hareHook" class="title" >Example for <code class="literal">hareHook</code>   </h3>  </div> </div></div><pre><code class="programlisting nix">{
  hareHook,
  lib,
  stdenv,
}:
stdenv.mkDerivation {
  pname = &quot;&lt;name&gt;&quot;;
  version = &quot;&lt;version&gt;&quot;;
  src = &quot;&lt;src&gt;&quot;;

  nativeBuildInputs = [ hareHook ];

  meta = {
    description = &quot;&lt;description&gt;&quot;;
    inherit (hareHook) badPlatforms platforms;
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="hareHook-cross-compilation" class="title" >Cross Compilation   </h3>  </div> </div></div><p><code class="literal">hareHook</code> should handle cross compilation out of the box. This is the main
purpose of <code class="literal">NIX_HAREFLAGS</code>: In it, the <code class="literal">-a</code> flag is passed with the architecture
of the <code class="literal">hostPlatform</code>.</p><p>However, manual intervention may be needed when a binary compiled by the build
process must be run for the build to complete — <span class="emphasis"><em>e. g.</em></span>, when using Hare’s
<code class="literal">hare</code> module for code generation.</p><p>In those cases, <code class="literal">hareHook</code> provides the <code class="literal">hare-native</code> script, which is a wrapper
around the hare binary for using the native (<code class="literal">buildPlatform</code>) toolchain.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="haskell" class="title" style="clear: both">Haskell   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#haskell-available-packages">Available packages</a> </span></dt><dt> <span class="section">  <a href="index.html#haskell-mkderivation"><code class="literal">haskellPackages.mkDerivation</code></a> </span></dt><dt> <span class="section">  <a href="index.html#haskell-development-environments">Development environments</a> </span></dt><dt> <span class="section">  <a href="index.html#haskell-overriding-haskell-packages">Overriding Haskell packages</a> </span></dt><dt> <span class="section">  <a href="index.html#haskell-import-from-derivation">Import-from-Derivation helpers</a> </span></dt><dt> <span class="section">  <a href="index.html#haskell-faq">F.A.Q.</a> </span></dt> </dl></div><p>The Haskell infrastructure in Nixpkgs has two main purposes: The primary purpose
is to provide a Haskell compiler and build tools as well as infrastructure for
packaging Haskell-based packages.</p><p>The secondary purpose is to provide support for Haskell development environments
including prebuilt Haskell libraries. However, in this area sacrifices have been
made due to self-imposed restrictions in Nixpkgs, to lessen the maintenance
effort and to improve performance. (More details in the subsection
<a class="link" href="index.html#haskell-limitations" title="Limitations" >Limitations.</a>)</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="haskell-available-packages" class="title" >Available packages   </h3>  </div> </div></div><p>The compiler and most build tools are exposed at the top level:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">ghc</code> is the default version of GHC</p></li><li class="listitem"><p>Language specific tools: <code class="literal">cabal-install</code>, <code class="literal">stack</code>, <code class="literal">hpack</code>, …</p></li></ul></div><p>Many “normal” user facing packages written in Haskell, like <code class="literal">niv</code> or <code class="literal">cachix</code>,
are also exposed at the top level, and there is nothing Haskell specific to
installing and using them.</p><p>All of these packages are originally defined in the <code class="literal">haskellPackages</code> package set.
The same packages are re-exposed with a reduced dependency closure for convenience (see <code class="literal">justStaticExecutables</code> or <code class="literal">separateBinOutput</code> below).</p><div class="note"><h3 class="title">Note</h3><p>See <a class="xref" href="index.html#chap-language-support" title="Languages and frameworks" ><em>Languages and frameworks</em></a> for techniques to explore package sets.</p></div><p>The <code class="literal">haskellPackages</code> set includes at least one version of every package from <a class="link" href="https://hackage.haskell.org/"  target="_top">Hackage</a> as well as some manually injected packages.</p><p>The attribute names in <code class="literal">haskellPackages</code> always correspond with their name on
Hackage. Since Hackage allows names that are not valid Nix without escaping,
you need to take care when handling attribute names like <code class="literal">3dmodels</code>.</p><p>For packages that are part of <a class="link" href="https://www.stackage.org"  target="_top">Stackage</a> (a curated set of known to be
compatible packages), we use the version prescribed by a Stackage snapshot
(usually the current LTS one) as the default version. For all other packages we
use the latest version from <a class="link" href="https://hackage.org"  target="_top">Hackage</a> (the repository of
basically all open source Haskell packages). See <a class="link" href="index.html#haskell-available-versions" title="Available package versions" >below</a> for a few more details on this.</p><p>Roughly half of the 16K packages contained in <code class="literal">haskellPackages</code> don’t actually
build and are <a class="link" href="https://github.com/NixOS/nixpkgs/blob/haskell-updates/pkgs/development/haskell-modules/configuration-hackage2nix/broken.yaml"  target="_top">marked as broken semi-automatically</a>.
Most of those packages are deprecated or unmaintained, but sometimes packages
that should build, do not build. Very often fixing them is not a lot of work.</p><p><code class="literal">haskellPackages</code> is built with our default compiler, but we also provide other releases of GHC and package sets built with them.
Available compilers are collected under <code class="literal">haskell.compiler</code>.</p><p>Each of those compiler versions has a corresponding attribute set <code class="literal">packages</code> built with
it. However, the non-standard package sets are not tested regularly and, as a
result, contain fewer working packages. The corresponding package set for GHC
9.4.8 is <code class="literal">haskell.packages.ghc948</code>. In fact <code class="literal">haskellPackages</code> (at the time of writing) is just an alias
for <code class="literal">haskell.packages.ghc984</code>:</p><p>Every package set also re-exposes the GHC used to build its packages as <code class="literal">haskell.packages.*.ghc</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-available-versions" class="title" >Available package versions   </h4>  </div> </div></div><p>We aim for a “blessed” package set which only contains one version of each
package, like <a class="link" href="https://www.stackage.org"  target="_top">Stackage</a>, which is a curated set of known to be compatible
packages. We use the version information from Stackage snapshots and extend it
with more packages. Normally in Nixpkgs the number of building Haskell packages
is roughly two to three times the size of Stackage. For choosing the version to
use for a certain package we use the following rules:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>By default, for <code class="literal">haskellPackages.foo</code> is the newest version of the package
<code class="literal">foo</code> found on <a class="link" href="https://hackage.org"  target="_top">Hackage</a>, which is the central registry
of all open source Haskell packages. Nixpkgs contains a reference to a pinned
Hackage snapshot, thus we use the state of Hackage as of the last time we
updated this pin.</p></li><li class="listitem"><p>If the <a class="link" href="https://www.stackage.org"  target="_top">Stackage</a> snapshot that we use (usually the newest LTS snapshot)
contains a package, <a class="link" href="https://github.com/NixOS/nixpkgs/blob/haskell-updates/pkgs/development/haskell-modules/configuration-hackage2nix/stackage.yaml"  target="_top">we use instead the version in the Stackage snapshot as
default version for that package.</a></p></li><li class="listitem"><p>For some packages, which are not on Stackage, we have if necessary <a class="link" href="https://github.com/NixOS/nixpkgs/blob/haskell-updates/pkgs/development/haskell-modules/configuration-hackage2nix/main.yaml"  target="_top">manual
overrides to set the default version to a version older than the newest on
Hackage.</a></p></li><li class="listitem"><p>For all packages, for which the newest Hackage version is not the default
version, there will also be a <code class="literal">haskellPackages.foo_x_y_z</code> package with the
newest version. The <code class="literal">x_y_z</code> part encodes the version with dots replaced by
underscores. When the newest version changes by a new release to Hackage the
old package will disappear under that name and be replaced by a newer one under
the name with the new version. The package name including the version will
also disappear when the default version e.g. from Stackage catches up with the
newest version from Hackage. E.g. if <code class="literal">haskellPackages.foo</code> gets updated from
1.0.0 to 1.1.0 the package <code class="literal">haskellPackages.foo_1_1_0</code> becomes obsolete and
gets dropped.</p></li><li class="listitem"><p>For some packages, we also <a class="link" href="https://github.com/NixOS/nixpkgs/blob/haskell-updates/pkgs/development/haskell-modules/configuration-hackage2nix/main.yaml"  target="_top">manually add other <code class="literal">haskellPackages.foo_x_y_z</code>
versions</a>,
if they are required for a certain build.</p></li></ol></div><p>Relying on <code class="literal">haskellPackages.foo_x_y_z</code> attributes in derivations outside
nixpkgs is discouraged because they may change or disappear with every package
set update.
</p><p>All <code class="literal">haskell.packages.*</code> package sets use the same package descriptions and the same sets
of versions by default. There are however GHC version specific override <code class="literal">.nix</code>
files to loosen this a bit.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-dependency-resolution" class="title" >Dependency resolution   </h4>  </div> </div></div><p>Normally when you build Haskell packages with <code class="literal">cabal-install</code>, <code class="literal">cabal-install</code>
does dependency resolution. It will look at all Haskell package versions known
on Hackage and tries to pick for every (transitive) dependency of your build
exactly one version. Those versions need to satisfy all the version constraints
given in the <code class="literal">.cabal</code> file of your package and all its dependencies.</p><p>The <a class="link" href="index.html#haskell-mkderivation" title="haskellPackages.mkDerivation" >Haskell builder in nixpkgs</a> does no such thing.
It will take as input packages with names off the desired dependencies
and just check whether they fulfill the version bounds and fail if they don’t
(by default, see <code class="literal">jailbreak</code> to circumvent this).</p><p>The <code class="literal">haskellPackages.callPackage</code> function does the package resolution.
It will, e.g., use <code class="literal">haskellPackages.aeson</code>which has the default version as
described above for a package input of name <code class="literal">aeson</code>. (More general:
<code class="literal">&lt;packages&gt;.callPackage f</code> will call <code class="literal">f</code> with named inputs provided from the
package set <code class="literal">&lt;packages&gt;</code>.)
While this is the default behavior, it is possible to override the dependencies
for a specific package, see
<a class="link" href="index.html#haskell-overriding-haskell-packages" title="Overriding Haskell packages" ><code class="literal">override</code> and <code class="literal">overrideScope</code></a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-limitations" class="title" >Limitations   </h4>  </div> </div></div><p>Our main objective with <code class="literal">haskellPackages</code> is to package Haskell software in
nixpkgs. This entails some limitations, partially due to self-imposed
restrictions of nixpkgs, partially in the name of maintainability:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Only the packages built with the default compiler see extensive testing of the
whole package set. For other GHC versions only a few essential packages are
tested and cached.</p></li><li class="listitem"><p>As described above we only build one version of most packages.</p></li></ul></div><p>The experience using an older or newer packaged compiler or using different
versions may be worse, because builds will not be cached on <code class="literal">cache.nixos.org</code>
or may fail.</p><p>Thus, to get the best experience, make sure that your project can be compiled
using the default compiler of nixpkgs and recent versions of its dependencies.</p><p>A result of this setup is, that getting a valid build plan for a given
package can sometimes be quite painful, and in fact this is where most of the
maintenance work for <code class="literal">haskellPackages</code> is required. Besides that, it is not
possible to get the dependencies of a legacy project from nixpkgs or to use a
specific stack solver for compiling a project.</p><p>Even though we couldn’t use them directly in nixpkgs, it would be desirable
to have tooling to generate working Nix package sets from build plans generated
by <code class="literal">cabal-install</code> or a specific Stackage snapshot via import-from-derivation.
Sadly we currently don’t have tooling for this. For this you might be
interested in the alternative <a class="link" href="https://input-output-hk.github.io/haskell.nix/index.html"  target="_top">haskell.nix</a> framework, which, be warned, is
completely incompatible with packages from <code class="literal">haskellPackages</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ghc-deprecation-policy" class="title" >GHC Deprecation Policy   </h4>  </div> </div></div><p>We remove GHC versions according to the following policy:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="major-ghc-deprecation" class="title" >Major GHC versions   </h5>  </div> </div></div><p>We keep the following GHC major versions:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>The current Stackage LTS as the default and all later major versions.</p></li><li class="listitem"><p>The two latest major versions older than our default.</p></li><li class="listitem"><p>The currently recommended GHCup version and all later major versions.</p></li></ol></div><p>Older GHC versions might be kept longer, if there are in-tree consumers. We will coordinate with the maintainers of those dependencies to find a way forward.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="minor-ghc-deprecation" class="title" >Minor GHC versions   </h5>  </div> </div></div><p>Every major version has a default minor version. The default minor version will be updated as soon as viable without breakage.</p><p>Older minor versions for a supported major version will only be kept, if they are the last supported version of a major Stackage LTS release.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="haskell-mkderivation" class="title" ><code class="literal">haskellPackages.mkDerivation</code>   </h3>  </div> </div></div><p>Every haskell package set has its own haskell-aware <code class="literal">mkDerivation</code> which is used
to build its packages. Generally you won’t have to interact with this builder
since <a class="link" href="index.html#haskell-cabal2nix" title="cabal2nix" >cabal2nix</a> can generate packages
using it for an arbitrary cabal package definition. Still it is useful to know
the parameters it takes when you need to
<a class="link" href="index.html#haskell-overriding-haskell-packages" title="Overriding Haskell packages" >override</a> a generated Nix expression.</p><p><code class="literal">haskellPackages.mkDerivation</code> is a wrapper around <code class="literal">stdenv.mkDerivation</code> which
re-defines the default phases to be haskell aware and handles dependency
specification, test suites, benchmarks etc. by compiling and invoking the
package’s <code class="literal">Setup.hs</code>. It does <span class="emphasis"><em>not</em></span> use or invoke the <code class="literal">cabal-install</code> binary,
but uses the underlying <code class="literal">Cabal</code> library instead.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-derivation-args" class="title" >General arguments   </h4>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pname</code></span></dt><dd><p>Package name, assumed to be the same as on Hackage (if applicable)</p></dd><dt><span class="term"><code class="literal">version</code></span></dt><dd><p>Packaged version, assumed to be the same as on Hackage (if applicable)</p></dd><dt><span class="term"><code class="literal">src</code></span></dt><dd><p>Source of the package. If omitted, fetch package corresponding to <code class="literal">pname</code>
and <code class="literal">version</code> from Hackage.</p></dd><dt><span class="term"><code class="literal">sha256</code></span></dt><dd><p>Hash to use for the default case of <code class="literal">src</code>.</p></dd><dt><span class="term"><code class="literal">sourceRoot</code>, <code class="literal">setSourceRoot</code></span></dt><dd><p>Passed to <code class="literal">stdenv.mkDerivation</code>; see <a class="link" href="index.html#variables-controlling-the-unpack-phase" title="Variables controlling the unpack phase" >“Variables controlling the unpack
phase”</a>.</p></dd><dt><span class="term"><code class="literal">revision</code></span></dt><dd><p>Revision number of the updated cabal file to fetch from Hackage.
If <code class="literal">null</code> (which is the default value), the one included in <code class="literal">src</code> is used.</p></dd><dt><span class="term"><code class="literal">editedCabalFile</code></span></dt><dd><p><code class="literal">sha256</code> hash of the cabal file identified by <code class="literal">revision</code> or <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">env</code></span></dt><dd><p>Extra environment variables to set during the build.
These will also be set inside the <a class="link" href="index.html#haskell-development-environments" title="Development environments" >development environment defined by the <code class="literal">passthru.env</code> attribute in the returned derivation</a>, but will not be set inside a development environment built with <a class="link" href="index.html#haskell-shellFor" title="shellFor" ><code class="literal">shellFor</code></a> that includes this package.</p></dd><dt><span class="term"><code class="literal">configureFlags</code></span></dt><dd><p>Extra flags passed when executing the <code class="literal">configure</code> command of <code class="literal">Setup.hs</code>.</p></dd><dt><span class="term"><code class="literal">buildFlags</code></span></dt><dd><p>Extra flags passed when executing the <code class="literal">build</code> command of <code class="literal">Setup.hs</code>.</p></dd><dt><span class="term"><code class="literal">haddockFlags</code></span></dt><dd><p>Extra flags passed to <code class="literal">Setup.hs haddock</code> when building the documentation.</p></dd><dt><span class="term"><code class="literal">doCheck</code></span></dt><dd><p>Whether to execute the package’s test suite if it has one. Defaults to <code class="literal">true</code> unless cross-compiling.</p></dd><dt><span class="term"><code class="literal">doBenchmark</code></span></dt><dd><p>Whether to execute the package’s benchmark if it has one. Defaults to <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">doHoogle</code></span></dt><dd><p>Whether to generate an index file for <a class="link" href="https://wiki.haskell.org/Hoogle"  target="_top">hoogle</a> as part of
<code class="literal">haddockPhase</code> by passing the <a class="link" href="https://haskell-haddock.readthedocs.io/en/latest/invoking.html#cmdoption-hoogle"  target="_top"><code class="literal">--hoogle</code> option</a>.
Defaults to <code class="literal">true</code>.</p></dd><dt><span class="term"><code class="literal">doHaddockQuickjump</code></span></dt><dd><p>Whether to generate an index for interactive navigation of the HTML documentation.
Defaults to <code class="literal">true</code> if supported.</p></dd><dt><span class="term"><code class="literal">doInstallIntermediates</code></span></dt><dd><p>Whether to install intermediate build products (files written to <code class="literal">dist/build</code>
by GHC during the build process). With <code class="literal">enableSeparateIntermediatesOutput</code>,
these files are instead installed to <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#chap-multiple-output"  target="_top">a separate <code class="literal">intermediates</code>
output.</a> The output can then be passed into a future build of
the same package with the <code class="literal">previousIntermediates</code> argument to support
incremental builds. See <a class="link" href="index.html#haskell-incremental-builds" title="Incremental builds" >“Incremental builds”</a> for
more information. Defaults to <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">enableLibraryProfiling</code></span></dt><dd><p>Whether to enable <a class="link" href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html"  target="_top">profiling</a> for libraries contained in the
package. Enabled by default if supported.</p></dd><dt><span class="term"><code class="literal">enableExecutableProfiling</code></span></dt><dd><p>Whether to enable <a class="link" href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html"  target="_top">profiling</a> for executables contained in the
package. Disabled by default.</p></dd><dt><span class="term"><code class="literal">profilingDetail</code></span></dt><dd><p><a class="link" href="https://cabal.readthedocs.io/en/latest/cabal-project.html#cfg-field-profiling-detail"  target="_top">Profiling detail level</a> to set. Defaults to <code class="literal">exported-functions</code>.</p></dd><dt><span class="term"><code class="literal">enableSharedExecutables</code></span></dt><dd><p>Whether to link executables dynamically. By default, executables are linked statically.</p></dd><dt><span class="term"><code class="literal">enableSharedLibraries</code></span></dt><dd><p>Whether to build shared Haskell libraries. This is enabled by default unless we are using
<code class="literal">pkgsStatic</code> or shared libraries have been disabled in GHC.</p></dd><dt><span class="term"><code class="literal">enableStaticLibraries</code></span></dt><dd><p>Whether to build static libraries. Enabled by default if supported.</p></dd><dt><span class="term"><code class="literal">enableDeadCodeElimination</code></span></dt><dd><p>Whether to enable linker based dead code elimination in GHC.
Enabled by default if supported.</p></dd><dt><span class="term"><code class="literal">enableHsc2hsViaAsm</code></span></dt><dd><p>Whether to pass <code class="literal">--via-asm</code> to <code class="literal">hsc2hs</code>. Enabled by default only on Windows.</p></dd><dt><span class="term"><code class="literal">hyperlinkSource</code></span></dt><dd><p>Whether to render the source as well as part of the haddock documentation
by passing the <a class="link" href="https://haskell-haddock.readthedocs.io/en/latest/invoking.html#cmdoption-hyperlinked-source"  target="_top"><code class="literal">--hyperlinked-source</code> flag</a>.
Defaults to <code class="literal">true</code>.</p></dd><dt><span class="term"><code class="literal">isExecutable</code></span></dt><dd><p>Whether the package contains an executable.</p></dd><dt><span class="term"><code class="literal">isLibrary</code></span></dt><dd><p>Whether the package contains a library.</p></dd><dt><span class="term"><code class="literal">jailbreak</code></span></dt><dd><p>Whether to execute <a class="link" href="https://github.com/NixOS/jailbreak-cabal/"  target="_top">jailbreak-cabal</a> before <code class="literal">configurePhase</code>
to lift any version constraints in the cabal file. Note that this can’t
lift version bounds if they are conditional, i.e. if a dependency is hidden
behind a flag.</p></dd><dt><span class="term"><code class="literal">enableParallelBuilding</code></span></dt><dd><p>Whether to use the <code class="literal">-j</code> flag to make GHC/Cabal start multiple jobs in parallel.</p></dd><dt><span class="term"><code class="literal">maxBuildCores</code></span></dt><dd><p>Upper limit of jobs to use in parallel for compilation regardless of
<code class="literal">$NIX_BUILD_CORES</code>. Defaults to 16 as Haskell compilation with GHC currently
sees a <a class="link" href="https://gitlab.haskell.org/ghc/ghc/-/issues/9221"  target="_top">performance regression</a>
if too many parallel jobs are used.</p></dd><dt><span class="term"><code class="literal">doCoverage</code></span></dt><dd><p>Whether to generate and install files needed for <a class="link" href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html#observing-code-coverage"  target="_top">HPC</a>.
Defaults to <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">doHaddock</code></span></dt><dd><p>Whether to build (HTML) documentation using <a class="link" href="https://www.haskell.org/haddock/"  target="_top">haddock</a>.
Defaults to <code class="literal">true</code> if supported.</p></dd><dt><span class="term"><code class="literal">testTargets</code></span></dt><dd><p>Names of the test suites to build and run. If unset, all test suites will be executed.</p></dd><dt><span class="term"><code class="literal">preCompileBuildDriver</code></span></dt><dd><p>Shell code to run before compiling <code class="literal">Setup.hs</code>.</p></dd><dt><span class="term"><code class="literal">postCompileBuildDriver</code></span></dt><dd><p>Shell code to run after compiling <code class="literal">Setup.hs</code>.</p></dd><dt><span class="term"><code class="literal">preHaddock</code></span></dt><dd><p>Shell code to run before building documentation using haddock.</p></dd><dt><span class="term"><code class="literal">postHaddock</code></span></dt><dd><p>Shell code to run after building documentation using haddock.</p></dd><dt><span class="term"><code class="literal">coreSetup</code></span></dt><dd><p>Whether to only allow core libraries to be used while building <code class="literal">Setup.hs</code>.
Defaults to <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">useCpphs</code></span></dt><dd><p>Whether to enable the <a class="link" href="https://Hackage.haskell.org/package/cpphs"  target="_top">cpphs</a> preprocessor. Defaults to <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">enableSeparateBinOutput</code></span></dt><dd><p>Whether to install executables to a separate <code class="literal">bin</code> output. Defaults to <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">enableSeparateDataOutput</code></span></dt><dd><p>Whether to install data files shipped with the package to a separate <code class="literal">data</code> output.
Defaults to <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">enableSeparateDocOutput</code></span></dt><dd><p>Whether to install documentation to a separate <code class="literal">doc</code> output.
Is automatically enabled if <code class="literal">doHaddock</code> is <code class="literal">true</code>.</p></dd><dt><span class="term"><code class="literal">enableSeparateIntermediatesOutput</code></span></dt><dd><p>When <code class="literal">doInstallIntermediates</code> is true, whether to install intermediate build
products to a separate <code class="literal">intermediates</code> output. See <a class="link" href="index.html#haskell-incremental-builds" title="Incremental builds" >“Incremental
builds”</a> for more information. Defaults to
<code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">allowInconsistentDependencies</code></span></dt><dd><p>If enabled, allow multiple versions of the same Haskell package in the
dependency tree at configure time. Often in such a situation compilation would
later fail because of type mismatches. Defaults to <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">enableLibraryForGhci</code></span></dt><dd><p>Build and install a special object file for GHCi. This improves performance
when loading the library in the REPL, but requires extra build time and
disk space. Defaults to <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">previousIntermediates</code></span></dt><dd><p>If non-null, intermediate build artifacts are copied from this input to
<code class="literal">dist/build</code> before performing compiling. See <a class="link" href="index.html#haskell-incremental-builds" title="Incremental builds" >“Incremental
builds”</a> for more information. Defaults to <code class="literal">null</code>.</p></dd><dt><span class="term"><code class="literal">buildTarget</code></span></dt><dd><p>Name of the executable or library to build and install.
If unset, all available targets are built and installed.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-derivation-deps" class="title" >Specifying dependencies   </h4>  </div> </div></div><p>Since <code class="literal">haskellPackages.mkDerivation</code> is intended to be generated from cabal
files, it reflects cabal’s way of specifying dependencies. For one, dependencies
are grouped by what part of the package they belong to. This helps to reduce the
dependency closure of a derivation, for example benchmark dependencies are not
included if <code class="literal">doBenchmark == false</code>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">setup*Depends</code></span></dt><dd><p>dependencies necessary to compile <code class="literal">Setup.hs</code></p></dd><dt><span class="term"><code class="literal">library*Depends</code></span></dt><dd><p>dependencies of a library contained in the package</p></dd><dt><span class="term"><code class="literal">executable*Depends</code></span></dt><dd><p>dependencies of an executable contained in the package</p></dd><dt><span class="term"><code class="literal">test*Depends</code></span></dt><dd><p>dependencies of a test suite contained in the package</p></dd><dt><span class="term"><code class="literal">benchmark*Depends</code></span></dt><dd><p>dependencies of a benchmark contained in the package</p></dd></dl></div><p>The other categorization relates to the way the package depends on the dependency:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">*ToolDepends</code></span></dt><dd><p>Tools we need to run as part of the build process.
They are added to the derivation’s <code class="literal">nativeBuildInputs</code>.</p></dd><dt><span class="term"><code class="literal">*HaskellDepends</code></span></dt><dd><p>Haskell libraries the package depends on.
They are added to <code class="literal">propagatedBuildInputs</code>.</p></dd><dt><span class="term"><code class="literal">*SystemDepends</code></span></dt><dd><p>Non-Haskell libraries the package depends on.
They are added to <code class="literal">buildInputs</code></p></dd><dt><span class="term"><code class="literal">*PkgconfigDepends</code></span></dt><dd><p><code class="literal">*SystemDepends</code> which are discovered using <code class="literal">pkg-config</code>.
They are added to <code class="literal">buildInputs</code> and it is additionally
ensured that <code class="literal">pkg-config</code> is available at build time.</p></dd><dt><span class="term"><code class="literal">*FrameworkDepends</code></span></dt><dd><p>Apple SDK Framework which the package depends on when compiling it on Darwin.</p></dd></dl></div><p>Using these two distinctions, you should be able to categorize most of the dependency
specifications that are available:
<code class="literal">benchmarkFrameworkDepends</code>,
<code class="literal">benchmarkHaskellDepends</code>,
<code class="literal">benchmarkPkgconfigDepends</code>,
<code class="literal">benchmarkSystemDepends</code>,
<code class="literal">benchmarkToolDepends</code>,
<code class="literal">executableFrameworkDepends</code>,
<code class="literal">executableHaskellDepends</code>,
<code class="literal">executablePkgconfigDepends</code>,
<code class="literal">executableSystemDepends</code>,
<code class="literal">executableToolDepends</code>,
<code class="literal">libraryFrameworkDepends</code>,
<code class="literal">libraryHaskellDepends</code>,
<code class="literal">libraryPkgconfigDepends</code>,
<code class="literal">librarySystemDepends</code>,
<code class="literal">libraryToolDepends</code>,
<code class="literal">setupHaskellDepends</code>,
<code class="literal">testFrameworkDepends</code>,
<code class="literal">testHaskellDepends</code>,
<code class="literal">testPkgconfigDepends</code>,
<code class="literal">testSystemDepends</code> and
<code class="literal">testToolDepends</code>.</p><p>That only leaves the following extra ways for specifying dependencies:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">buildDepends</code></span></dt><dd><p>Allows specifying Haskell dependencies which are added to <code class="literal">propagatedBuildInputs</code> unconditionally.</p></dd><dt><span class="term"><code class="literal">buildTools</code></span></dt><dd><p>Like <code class="literal">*ToolDepends</code>, but are added to <code class="literal">nativeBuildInputs</code> unconditionally.</p></dd><dt><span class="term"><code class="literal">extraLibraries</code></span></dt><dd><p>Like <code class="literal">*SystemDepends</code>, but are added to <code class="literal">buildInputs</code> unconditionally.</p></dd><dt><span class="term"><code class="literal">pkg-configDepends</code></span></dt><dd><p>Like <code class="literal">*PkgconfigDepends</code>, but are added to <code class="literal">buildInputs</code> unconditionally.</p></dd><dt><span class="term"><code class="literal">testDepends</code></span></dt><dd><p>Deprecated, use either <code class="literal">testHaskellDepends</code> or <code class="literal">testSystemDepends</code>.</p></dd><dt><span class="term"><code class="literal">benchmarkDepends</code></span></dt><dd><p>Deprecated, use either <code class="literal">benchmarkHaskellDepends</code> or <code class="literal">benchmarkSystemDepends</code>.</p></dd></dl></div><p>The dependency specification methods in this list which are unconditional
are especially useful when writing <a class="link" href="index.html#haskell-overriding-haskell-packages" title="Overriding Haskell packages" >overrides</a>
when you want to make sure that they are definitely included. However, it is
recommended to use the more accurate ones listed above when possible.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-derivation-meta" class="title" >Meta attributes   </h4>  </div> </div></div><p><code class="literal">haskellPackages.mkDerivation</code> accepts the following attributes as direct
arguments which are transparently set in <code class="literal">meta</code> of the resulting derivation. See
the <a class="link" href="index.html#chap-meta" title="Meta-attributes" >Meta-attributes section</a> for their documentation.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>These attributes are populated with a default value if omitted:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><code class="literal">homepage</code>: defaults to the Hackage page for <code class="literal">pname</code>.</p></li><li class="listitem"><p><code class="literal">platforms</code>: defaults to <code class="literal">lib.platforms.all</code> (since GHC can cross-compile)</p></li></ul></div></li><li class="listitem"><p>These attributes are only set if given:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><code class="literal">description</code></p></li><li class="listitem"><p><code class="literal">license</code></p></li><li class="listitem"><p><code class="literal">changelog</code></p></li><li class="listitem"><p><code class="literal">maintainers</code></p></li><li class="listitem"><p><code class="literal">broken</code></p></li><li class="listitem"><p><code class="literal">hydraPlatforms</code></p></li></ul></div></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-incremental-builds" class="title" >Incremental builds   </h4>  </div> </div></div><p><code class="literal">haskellPackages.mkDerivation</code> supports incremental builds for GHC 9.4 and
newer with the <code class="literal">doInstallIntermediates</code>, <code class="literal">enableSeparateIntermediatesOutput</code>,
and <code class="literal">previousIntermediates</code> arguments.</p><p>The basic idea is to first perform a full build of the package in question,
save its intermediate build products for later, and then copy those build
products into the build directory of an incremental build performed later.
Then, GHC will use those build artifacts to avoid recompiling unchanged
modules.</p><p>For more detail on how to store and use incremental build products, see
<a class="link" href="https://www.haskellforall.com/2022/12/nixpkgs-support-for-incremental-haskell.html"  target="_top">Gabriella Gonzalez’ blog post “Nixpkgs support for incremental Haskell
builds”.</a> motivation behind this feature.</p><p>An incremental build for <a class="link" href="https://hackage.haskell.org/package/turtle"  target="_top">the <code class="literal">turtle</code> package</a> can be performed like
so:</p><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };
  inherit (pkgs) haskell;
  inherit (haskell.lib.compose) overrideCabal;

  # Incremental builds work with GHC &gt;=9.4.
  turtle = haskell.packages.ghc944.turtle;

  # This will do a full build of `turtle`, while writing the intermediate build products
  # (compiled modules, etc.) to the `intermediates` output.
  turtle-full-build-with-incremental-output = overrideCabal (drv: {
    doInstallIntermediates = true;
    enableSeparateIntermediatesOutput = true;
  }) turtle;

  # This will do an incremental build of `turtle` by copying the previously
  # compiled modules and intermediate build products into the source tree
  # before running the build.
  #
  # GHC will then naturally pick up and reuse these products, making this build
  # complete much more quickly than the previous one.
  turtle-incremental-build = overrideCabal (drv: {
    previousIntermediates = turtle-full-build-with-incremental-output.intermediates;
  }) turtle;
in
turtle-incremental-build
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="haskell-development-environments" class="title" >Development environments   </h3>  </div> </div></div><p>In addition to building and installing Haskell software, nixpkgs can also
provide development environments for Haskell projects. This has the obvious
advantage that you benefit from <code class="literal">cache.nixos.org</code> and no longer need to compile
all project dependencies yourself. While it is often very useful, this is not
the primary use case of our package set. Have a look at the section
<a class="link" href="index.html#haskell-available-versions" title="Available package versions" >available package versions</a> to learn which
versions of packages we provide and the section
<a class="link" href="index.html#haskell-limitations" title="Limitations" >limitations</a>, to judge whether a <code class="literal">haskellPackages</code>
based development environment for your project is feasible.</p><p>By default, every derivation built using
<a class="link" href="index.html#haskell-mkderivation" title="haskellPackages.mkDerivation" ><code class="literal">haskellPackages.mkDerivation</code></a> exposes an environment
suitable for building it interactively as the <code class="literal">env</code> attribute. For example, if
you have a local checkout of <code class="literal">random</code>, you can enter a development environment
for it like this (if the dependencies in the development and packaged version
match):</p><pre><code class="programlisting console">$ cd ~/src/random
$ nix-shell -A haskellPackages.random.env &#x27;&lt;nixpkgs&gt;&#x27;
[nix-shell:~/src/random]$ ghc-pkg list
/nix/store/a8hhl54xlzfizrhcf03c1l3f6l9l8qwv-ghc-9.2.4-with-packages/lib/ghc-9.2.4/package.conf.d
    Cabal-3.6.3.0
    array-0.5.4.0
    base-4.16.3.0
    binary-0.8.9.0
    …
    ghc-9.2.4
    …
</code></pre><p>As you can see, the environment contains a GHC which is set up so it finds all
dependencies of <code class="literal">random</code>. Note that this environment does not mirror
the environment used to build the package, but is intended as a convenient
tool for development and simple debugging. <code class="literal">env</code> relies on the <code class="literal">ghcWithPackages</code>
wrapper which automatically injects a pre-populated package-db into every
GHC invocation. In contrast, using <code class="literal">nix-shell -A haskellPackages.random</code> will
not result in an environment in which the dependencies are in GHCs package
database. Instead, the Haskell builder will pass in all dependencies explicitly
via configure flags.</p><p><code class="literal">env</code> mirrors the normal derivation environment in one aspect: It does not include
familiar development tools like <code class="literal">cabal-install</code>, since we rely on plain <code class="literal">Setup.hs</code>
to build all packages. However, <code class="literal">cabal-install</code> will work as expected if in
<code class="literal">PATH</code> (e.g. when installed globally and using a <code class="literal">nix-shell</code> without <code class="literal">--pure</code>).
A declarative and pure way of adding arbitrary development tools is provided
via <a class="link" href="index.html#haskell-shellFor" title="shellFor" ><code class="literal">shellFor</code></a>.</p><p>When using <code class="literal">cabal-install</code> for dependency resolution you need to be a bit
careful to achieve build purity. <code class="literal">cabal-install</code> will find and use all
dependencies installed from the packages <code class="literal">env</code> via Nix, but it will also
consult Hackage to potentially download and compile dependencies if it can’t
find a valid build plan locally. To prevent this you can either never run
<code class="literal">cabal update</code>, remove the cabal database from your <code class="literal">~/.cabal</code> folder or run
<code class="literal">cabal</code> with <code class="literal">--offline</code>. Note though, that for some usecases <code class="literal">cabal2nix</code> needs
the local Hackage db.</p><p>Often you won’t work on a package that is already part of <code class="literal">haskellPackages</code> or
Hackage, so we first need to write a Nix expression to obtain the development
environment from. Luckily, we can generate one very easily from an already
existing cabal file using <code class="literal">cabal2nix</code>:</p><pre><code class="programlisting console">$ ls
my-project.cabal src …
$ cabal2nix ./. &gt; my-project.nix
</code></pre><p>The generated Nix expression evaluates to a function ready to be
<code class="literal">callPackage</code>-ed. For now, we can add a minimal <code class="literal">default.nix</code> which does just
that:</p><pre><code class="programlisting nix"># Retrieve nixpkgs impurely from NIX_PATH for now, you can pin it instead, of course.
{
  pkgs ? import &lt;nixpkgs&gt; { },
}:

# use the nixpkgs default haskell package set
pkgs.haskellPackages.callPackage ./my-project.nix { }
</code></pre><p>Using <code class="literal">nix-build default.nix</code> we can now build our project, but we can also
enter a shell with all the package’s dependencies available using <code class="literal">nix-shell -A env default.nix</code>. If you have <code class="literal">cabal-install</code> installed globally, it’ll work
inside the shell as expected.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-shellFor" class="title" >shellFor   </h4>  </div> </div></div><p>Having to install tools globally is obviously not great, especially if you want
to provide a batteries-included <code class="literal">shell.nix</code> with your project. Luckily there’s a
proper tool for making development environments out of packages’ build
environments: <code class="literal">shellFor</code>, a function exposed by every haskell package set. It
takes the following arguments and returns a derivation which is suitable as a
development environment inside <code class="literal">nix-shell</code>:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">packages</code></span></dt><dd><p>This argument is used to select the packages for which to build the
development environment. This should be a function which takes a haskell package
set and returns a list of packages. <code class="literal">shellFor</code> will pass the used package set to
this function and include all dependencies of the returned package in the build
environment. This means you can reuse Nix expressions of packages included in
nixpkgs, but also use local Nix expressions like this: <code class="literal">hpkgs: [ (hpkgs.callPackage ./my-project.nix { }) ]</code>.</p></dd><dt><span class="term"><code class="literal">extraDependencies</code></span></dt><dd><p>Extra dependencies, in the form of cabal2nix build attributes. An example use
case is when you have Haskell scripts that use libraries that don’t occur in
your packages’ dependencies. Example: <code class="literal">hpkgs: {libraryHaskellDepends = [ hpkgs.releaser ]}</code>. Defaults to <code class="literal">hpkgs: { }</code>.</p></dd><dt><span class="term"><code class="literal">nativeBuildInputs</code></span></dt><dd><p>Expects a list of derivations to add as build tools to the build environment.
This is the place to add packages like <code class="literal">cabal-install</code>, <code class="literal">doctest</code> or <code class="literal">hlint</code>.
Defaults to <code class="literal">[]</code>.</p></dd><dt><span class="term"><code class="literal">buildInputs</code></span></dt><dd><p>Expects a list of derivations to add as library dependencies, like <code class="literal">openssl</code>.
This is rarely necessary as the haskell package expressions usually track system
dependencies as well. Defaults to <code class="literal">[]</code>. (see also
<a class="link" href="index.html#haskell-derivation-deps" title="Specifying dependencies" >derivation dependencies</a>)</p></dd><dt><span class="term"><code class="literal">withHoogle</code></span></dt><dd><p>If this is true, <code class="literal">hoogle</code> will be added to <code class="literal">nativeBuildInputs</code>.
Additionally, its database will be populated with all included dependencies,
so you’ll be able search through the documentation of your dependencies.
Defaults to <code class="literal">false</code>.</p></dd><dt><span class="term"><code class="literal">genericBuilderArgsModifier</code></span></dt><dd><p>This argument accepts a function allowing you to modify the arguments passed
to <code class="literal">mkDerivation</code> in order to create the development environment. For example,
<code class="literal">args: { doCheck = false; }</code> would cause the environment to not include any test
dependencies. Defaults to <code class="literal">lib.id</code>.</p></dd><dt><span class="term"><code class="literal">doBenchmark</code></span></dt><dd><p>This is a shortcut for enabling <code class="literal">doBenchmark</code> via <code class="literal">genericBuilderArgsModifier</code>.
Setting it to <code class="literal">true</code> will cause the development environment to include all
benchmark dependencies which would be excluded by default. Defaults to <code class="literal">false</code>.</p></dd></dl></div><p>One neat property of <code class="literal">shellFor</code> is that it allows you to work on multiple
packages using the same environment in conjunction with
<a class="link" href="https://cabal.readthedocs.io/en/latest/cabal-project.html"  target="_top">cabal.project files</a>.
Say our example above depends on <code class="literal">distribution-nixpkgs</code> and we have a project
file set up for both, we can add the following <code class="literal">shell.nix</code> expression:</p><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:

pkgs.haskellPackages.shellFor {
  packages = hpkgs: [
    # reuse the nixpkgs for this package
    hpkgs.distribution-nixpkgs
    # call our generated Nix expression manually
    (hpkgs.callPackage ./my-project/my-project.nix { })
  ];

  # development tools we use
  nativeBuildInputs = [
    pkgs.cabal-install
    pkgs.haskellPackages.doctest
    pkgs.cabal2nix
  ];

  # Extra arguments are added to mkDerivation&#x27;s arguments as-is.
  # Since it adds all passed arguments to the shell environment,
  # we can use this to set the environment variable the `Paths_`
  # module of distribution-nixpkgs uses to search for bundled
  # files.
  # See also: https://cabal.readthedocs.io/en/latest/cabal-package.html#accessing-data-files-from-package-code
  distribution_nixpkgs_datadir = toString ./distribution-nixpkgs;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-language-server" class="title" >haskell-language-server   </h4>  </div> </div></div><p>To use HLS in short: Install <code class="literal">pkgs.haskell-language-server</code> e.g. in
<code class="literal">nativeBuildInputs</code> in <code class="literal">shellFor</code> and use the <code class="literal">haskell-language-server-wrapper</code>
command to run it. See the <a class="link" href="https://haskell-language-server.readthedocs.io/en/latest/configuration.html#configuring-your-editor"  target="_top">HLS user guide</a> on how to configure your text
editor to use HLS and how to test your setup.</p><p>HLS needs to be compiled with the GHC version of the project you use it
on.</p><p><code class="literal">pkgs.haskell-language-server</code> provides
<code class="literal">haskell-language-server-wrapper</code>, <code class="literal">haskell-language-server</code>
and <code class="literal">haskell-language-server-x.x.x</code>
binaries, where <code class="literal">x.x.x</code> is the GHC version for which it is compiled. By
default, it only includes binaries for the current GHC version, to reduce
closure size. The closure size is large, because HLS needs to be dynamically
linked to work reliably. You can override the list of supported GHC versions
with e.g.</p><pre><code class="programlisting nix">pkgs.haskell-language-server.override {
  supportedGhcVersions = [
    &quot;90&quot;
    &quot;94&quot;
  ];
}
</code></pre><p>Where all strings <code class="literal">version</code> are allowed such that
<code class="literal">haskell.packages.ghc${version}</code> is an existing package set.</p><p>When you run <code class="literal">haskell-language-server-wrapper</code> it will detect the GHC
version used by the project you are working on (by asking e.g. cabal or
stack) and pick the appropriate versioned binary from your path.</p><p>Be careful when installing HLS globally and using a pinned nixpkgs for a
Haskell project in a <code class="literal">nix-shell</code>. If the nixpkgs versions deviate to much
(e.g., use different <code class="literal">glibc</code> versions) the <code class="literal">haskell-language-server-?.?.?</code>
executable will try to detect these situations and refuse to start. It is
recommended to obtain HLS via <code class="literal">nix-shell</code> from the nixpkgs version pinned in
there instead.</p><p>The top level <code class="literal">pkgs.haskell-language-server</code> attribute is just a convenience
wrapper to make it possible to install HLS for multiple GHC versions at the
same time. If you know, that you only use one GHC version, e.g., in a project
specific <code class="literal">nix-shell</code> you can use
<code class="literal">pkgs.haskellPackages.haskell-language-server</code> or
<code class="literal">pkgs.haskell.packages.*.haskell-language-server</code> from the package set you use.</p><p>If you use <code class="literal">nix-shell</code> for your development environments remember to start your
editor in that environment. You may want to use something like <code class="literal">direnv</code> and/or an
editor plugin to achieve this.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="haskell-overriding-haskell-packages" class="title" >Overriding Haskell packages   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-overriding-a-single-package" class="title" >Overriding a single package   </h4>  </div> </div></div><p>Like many language specific subsystems in nixpkgs, the Haskell infrastructure
also has its own quirks when it comes to overriding. Overriding of the <span class="emphasis"><em>inputs</em></span>
to a package at least follows the standard procedure. For example, imagine you
need to build <code class="literal">nix-tree</code> with a more recent version of <code class="literal">brick</code> than the default
one provided by <code class="literal">haskellPackages</code>:</p><pre><code class="programlisting nix">haskellPackages.nix-tree.override { brick = haskellPackages.brick_0_67; }
</code></pre><p>The custom interface comes into play when you want to override the arguments
passed to <code class="literal">haskellPackages.mkDerivation</code>. For this, the function <code class="literal">overrideCabal</code>
from <code class="literal">haskell.lib.compose</code> is used. E.g., if you want to install a man page
that is distributed with the package, you can do something like this:</p><pre><code class="programlisting nix">haskell.lib.compose.overrideCabal (drv: {
  postInstall = &#x27;&#x27;
    ${drv.postInstall or &quot;&quot;}
    install -Dm644 man/pnbackup.1 -t $out/share/man/man1
  &#x27;&#x27;;
}) haskellPackages.pnbackup
</code></pre><p><code class="literal">overrideCabal</code> takes two arguments:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>A function which receives all arguments passed to <code class="literal">haskellPackages.mkDerivation</code>
before and returns a set of arguments to replace (or add) with a new value.</p></li><li class="listitem"><p>The Haskell derivation to override.</p></li></ol></div><p>The arguments are ordered so that you can easily create helper functions by making
use of currying:</p><pre><code class="programlisting nix">let
  installManPage = haskell.lib.compose.overrideCabal (drv: {
    postInstall = &#x27;&#x27;
      ${drv.postInstall or &quot;&quot;}
      install -Dm644 man/${drv.pname}.1 -t &quot;$out/share/man/man1&quot;
    &#x27;&#x27;;
  });

in
installManPage haskellPackages.pnbackup
</code></pre><p>In fact, <code class="literal">haskell.lib.compose</code> already provides lots of useful helpers for common
tasks, detailed in the next section. They are also structured in such a way that
they can be combined using <code class="literal">lib.pipe</code>:</p><pre><code class="programlisting nix">lib.pipe my-haskell-package [
  # lift version bounds on dependencies
  haskell.lib.compose.doJailbreak
  # disable building the haddock documentation
  haskell.lib.compose.dontHaddock
  # pass extra package flag to Cabal&#x27;s configure step
  (haskell.lib.compose.enableCabalFlag &quot;myflag&quot;)
]
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="haskell-haskell.lib.compose" class="title" ><code class="literal">haskell.lib.compose</code>   </h5>  </div> </div></div><p>The base interface for all overriding is the following function:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">overrideCabal f drv</code></span></dt><dd><p>Takes the arguments passed to obtain <code class="literal">drv</code> to <code class="literal">f</code> and uses the resulting
attribute set to update the argument set. Then a recomputed version of <code class="literal">drv</code>
using the new argument set is returned.</p></dd></dl></div><p>All other helper functions are implemented in terms of <code class="literal">overrideCabal</code> and make
common overrides shorter and more complicate ones trivial. The simple overrides
which only change a single argument are only described very briefly in the
following overview. Refer to the
<a class="link" href="index.html#haskell-mkderivation" title="haskellPackages.mkDerivation" >documentation of <code class="literal">haskellPackages.mkDerivation</code></a>
for a more detailed description of the effects of the respective arguments.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="haskell-packaging-helpers" class="title" >Packaging Helpers   </h6>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">overrideSrc { src, version } drv</code></span></dt><dd><p>Replace the source used for building <code class="literal">drv</code> with the path or derivation given
as <code class="literal">src</code>. The <code class="literal">version</code> attribute is optional. Prefer this function over
overriding <code class="literal">src</code> via <code class="literal">overrideCabal</code>, since it also automatically takes care of
removing any Hackage revisions.</p></dd></dl></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">justStaticExecutables drv</code></span></dt><dd><p>Only build and install the executables produced by <code class="literal">drv</code>, removing everything
that may refer to other Haskell packages’ store paths (like libraries and
documentation). This dramatically reduces the closure size of the resulting
derivation. Note that the executables are only statically linked against their
Haskell dependencies, but will still link dynamically against libc, GMP and
other system library dependencies.</p><p>If a library or its dependencies use their Cabal-generated
<code class="literal">Paths_*</code> module, this may not work as well if GHC’s dead code elimination is
unable to remove the references to the dependency’s store path that module
contains.
As a consequence, an unused reference may be created from the static binary to such a <span class="emphasis"><em>library</em></span> store path.
(See <a class="link" href="https://github.com/NixOS/nixpkgs/issues/164630"  target="_top">nixpkgs#164630</a> for more information.)</p><p>Importing the <code class="literal">Paths_*</code> module may cause builds to fail with this message:</p><pre><code class="programlisting">error: output &#x27;/nix/store/64k8iw0ryz76qpijsnl9v87fb26v28z8-my-haskell-package-1.0.0.0&#x27; is not allowed to refer to the following paths:
         /nix/store/5q5s4a07gaz50h04zpfbda8xjs8wrnhg-ghc-9.6.3
</code></pre><p>If that happens, first disable the check for GHC references and rebuild the
derivation:</p><pre><code class="programlisting nix">pkgs.haskell.lib.overrideCabal (pkgs.haskell.lib.justStaticExecutables my-haskell-package) (drv: {
  disallowGhcReference = false;
})
</code></pre><p>Then use <code class="literal">strings</code> to determine which libraries are responsible:</p><pre><code class="programlisting">$ nix-build ...
$ strings result/bin/my-haskell-binary | grep /nix/store/
...
/nix/store/n7ciwdlg8yyxdhbrgd6yc2d8ypnwpmgq-hs-opentelemetry-sdk-0.0.3.6/bin
...
</code></pre><p>Finally, use <code class="literal">remove-references-to</code> to delete those store paths from the produced output:</p><pre><code class="programlisting nix">pkgs.haskell.lib.overrideCabal (pkgs.haskell.lib.justStaticExecutables my-haskell-package) (drv: {
  postInstall = &#x27;&#x27;
    ${drv.postInstall or &quot;&quot;}
    remove-references-to -t ${pkgs.haskellPackages.hs-opentelemetry-sdk}
  &#x27;&#x27;;
})
</code></pre></dd></dl></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">enableSeparateBinOutput drv</code></span></dt><dd><p>Install executables produced by <code class="literal">drv</code> to a separate <code class="literal">bin</code> output. This
has a similar effect as <code class="literal">justStaticExecutables</code>, but preserves the libraries
and documentation in the <code class="literal">out</code> output alongside the <code class="literal">bin</code> output with a
much smaller closure size.</p></dd><dt><span class="term"><code class="literal">markBroken drv</code></span></dt><dd><p>Sets the <code class="literal">broken</code> flag to <code class="literal">true</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">markUnbroken drv</code>, <code class="literal">unmarkBroken drv</code></span></dt><dd><p>Set the <code class="literal">broken</code> flag to <code class="literal">false</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">doDistribute drv</code></span></dt><dd><p>Updates <code class="literal">hydraPlatforms</code> so that Hydra will build <code class="literal">drv</code>. This is
sometimes necessary when working with versioned packages in
<code class="literal">haskellPackages</code> which are not built by default.</p></dd><dt><span class="term"><code class="literal">dontDistribute drv</code></span></dt><dd><p>Sets <code class="literal">hydraPlatforms</code> to <code class="literal">[]</code>, causing Hydra to skip this package
altogether. Useful if it fails to evaluate cleanly and is causing
noise in the evaluation errors tab on Hydra.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="haskell-development-helpers" class="title" >Development Helpers   </h6>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">sdistTarball drv</code></span></dt><dd><p>Create a source distribution tarball like those found on Hackage
instead of building the package <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">documentationTarball drv</code></span></dt><dd><p>Create a documentation tarball suitable for uploading to Hackage
instead of building the package <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">buildFromSdist drv</code></span></dt><dd><p>Uses <code class="literal">sdistTarball drv</code> as the source to compile <code class="literal">drv</code>. This helps to catch
packaging bugs when building from a local directory, e.g. when required files
are missing from <code class="literal">extra-source-files</code>.</p></dd><dt><span class="term"><code class="literal">failOnAllWarnings drv</code></span></dt><dd><p>Enables all warnings GHC supports and makes it fail the build if any of them
are emitted.</p></dd></dl></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">enableDWARFDebugging drv</code></span></dt><dd><p>Compiles the package with additional debug symbols enabled, useful
for debugging with e.g. <code class="literal">gdb</code>.</p></dd><dt><span class="term"><code class="literal">doStrip drv</code></span></dt><dd><p>Sets <code class="literal">doStrip</code> to <code class="literal">true</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">dontStrip drv</code></span></dt><dd><p>Sets <code class="literal">doStrip</code> to <code class="literal">false</code> for <code class="literal">drv</code>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="haskell-trivial-helpers" class="title" >Trivial Helpers   </h6>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">doJailbreak drv</code></span></dt><dd><p>Sets the <code class="literal">jailbreak</code> argument to <code class="literal">true</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">dontJailbreak drv</code></span></dt><dd><p>Sets the <code class="literal">jailbreak</code> argument to <code class="literal">false</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">doHaddock drv</code></span></dt><dd><p>Sets <code class="literal">doHaddock</code> to <code class="literal">true</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">dontHaddock drv</code></span></dt><dd><p>Sets <code class="literal">doHaddock</code> to <code class="literal">false</code> for <code class="literal">drv</code>. Useful if the build of a package is
failing because of e.g. a syntax error in the Haddock documentation.</p></dd><dt><span class="term"><code class="literal">doHyperlinkSource drv</code></span></dt><dd><p>Sets <code class="literal">hyperlinkSource</code> to <code class="literal">true</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">dontHyperlinkSource drv</code></span></dt><dd><p>Sets <code class="literal">hyperlinkSource</code> to <code class="literal">false</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">doCheck drv</code></span></dt><dd><p>Sets <code class="literal">doCheck</code> to <code class="literal">true</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">dontCheck drv</code></span></dt><dd><p>Sets <code class="literal">doCheck</code> to <code class="literal">false</code> for <code class="literal">drv</code>. Useful if a package has a broken,
flaky or otherwise problematic test suite breaking the build.</p></dd><dt><span class="term"><code class="literal">dontCheckIf condition drv</code></span></dt><dd><p>Sets <code class="literal">doCheck</code> to <code class="literal">false</code> for <code class="literal">drv</code>, but only if <code class="literal">condition</code> applies.
Otherwise it’s a no-op. Useful to conditionally disable tests for a package
without interfering with previous overrides or default values.</p></dd></dl></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">appendConfigureFlags list drv</code></span></dt><dd><p>Adds the strings in <code class="literal">list</code> to the <code class="literal">configureFlags</code> argument for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">enableCabalFlag flag drv</code></span></dt><dd><p>Makes sure that the Cabal flag <code class="literal">flag</code> is enabled in Cabal’s configure step.</p></dd><dt><span class="term"><code class="literal">disableCabalFlag flag drv</code></span></dt><dd><p>Makes sure that the Cabal flag <code class="literal">flag</code> is disabled in Cabal’s configure step.</p></dd><dt><span class="term"><code class="literal">appendBuildFlags list drv</code></span></dt><dd><p>Adds the strings in <code class="literal">list</code> to the <code class="literal">buildFlags</code> argument for <code class="literal">drv</code>.</p></dd></dl></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">appendPatches list drv</code></span></dt><dd><p>Adds the <code class="literal">list</code> of derivations or paths to the <code class="literal">patches</code> argument for <code class="literal">drv</code>.</p></dd></dl></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">addBuildTools list drv</code></span></dt><dd><p>Adds the <code class="literal">list</code> of derivations to the <code class="literal">buildTools</code> argument for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">addExtraLibraries list drv</code></span></dt><dd><p>Adds the <code class="literal">list</code> of derivations to the <code class="literal">extraLibraries</code> argument for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">addBuildDepends list drv</code></span></dt><dd><p>Adds the <code class="literal">list</code> of derivations to the <code class="literal">buildDepends</code> argument for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">addTestToolDepends list drv</code></span></dt><dd><p>Adds the <code class="literal">list</code> of derivations to the <code class="literal">testToolDepends</code> argument for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">addPkgconfigDepends list drv</code></span></dt><dd><p>Adds the <code class="literal">list</code> of derivations to the <code class="literal">pkg-configDepends</code> argument for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">addSetupDepends list drv</code></span></dt><dd><p>Adds the <code class="literal">list</code> of derivations to the <code class="literal">setupHaskellDepends</code> argument for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">doBenchmark drv</code></span></dt><dd><p>Set <code class="literal">doBenchmark</code> to <code class="literal">true</code> for <code class="literal">drv</code>. Useful if your development
environment is missing the dependencies necessary for compiling the
benchmark component.</p></dd><dt><span class="term"><code class="literal">dontBenchmark drv</code></span></dt><dd><p>Set <code class="literal">doBenchmark</code> to <code class="literal">false</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">setBuildTargets drv list</code></span></dt><dd><p>Sets the <code class="literal">buildTarget</code> argument for <code class="literal">drv</code> so that the targets specified in <code class="literal">list</code> are built.</p></dd><dt><span class="term"><code class="literal">doCoverage drv</code></span></dt><dd><p>Sets the <code class="literal">doCoverage</code> argument to <code class="literal">true</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">dontCoverage drv</code></span></dt><dd><p>Sets the <code class="literal">doCoverage</code> argument to <code class="literal">false</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">enableExecutableProfiling drv</code></span></dt><dd><p>Sets the <code class="literal">enableExecutableProfiling</code> argument to <code class="literal">true</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">disableExecutableProfiling drv</code></span></dt><dd><p>Sets the <code class="literal">enableExecutableProfiling</code> argument to <code class="literal">false</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">enableLibraryProfiling drv</code></span></dt><dd><p>Sets the <code class="literal">enableLibraryProfiling</code> argument to <code class="literal">true</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">disableLibraryProfiling drv</code></span></dt><dd><p>Sets the <code class="literal">enableLibraryProfiling</code> argument to <code class="literal">false</code> for <code class="literal">drv</code>.</p></dd><dt><span class="term"><code class="literal">disableParallelBuilding drv</code></span></dt><dd><p>Sets the <code class="literal">enableParallelBuilding</code> argument to <code class="literal">false</code> for <code class="literal">drv</code>.</p></dd></dl></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="haskell-package-set-lib-functions" class="title" >Library functions in the Haskell package sets   </h5>  </div> </div></div><p>Some library functions depend on packages from the Haskell package sets. Thus they are
exposed from those instead of from <code class="literal">haskell.lib.compose</code> which can only access what is
passed directly to it. When using the functions below, make sure that you are obtaining them
from the same package set (<code class="literal">haskellPackages</code>, <code class="literal">haskell.packages.ghc944</code> etc.) as the packages
you are working with or – even better – from the <code class="literal">self</code>/<code class="literal">final</code> fix point of your overlay to
<code class="literal">haskellPackages</code>.</p><p>Note: Some functions like <code class="literal">shellFor</code> that are not intended for overriding per se, are omitted
in this section. </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">cabalSdist { src, name ? ... }</code></span></dt><dd><p>Generates the Cabal sdist tarball for <code class="literal">src</code>, suitable for uploading to Hackage.
Contrary to <code class="literal">haskell.lib.compose.sdistTarball</code>, it uses <code class="literal">cabal-install</code> over <code class="literal">Setup.hs</code>,
so it is usually faster: No build dependencies need to be downloaded, and we can
skip compiling <code class="literal">Setup.hs</code>.</p></dd><dt><span class="term"><code class="literal">buildFromCabalSdist drv</code></span></dt><dd><p>Build <code class="literal">drv</code>, but run its <code class="literal">src</code> attribute through <code class="literal">cabalSdist</code> first. Useful for catching
files necessary for compilation that are missing from the sdist.</p></dd><dt><span class="term"><code class="literal">generateOptparseApplicativeCompletions list drv</code></span></dt><dd><p>Generate and install shell completion files for the installed executables whose
names are given via <code class="literal">list</code>. The executables need to be using <code class="literal">optparse-applicative</code>
for <a class="link" href="https://github.com/pcapriotti/optparse-applicative/blob/7726b63796aa5d0df82e926d467f039b78ca09e2/README.md#bash-zsh-and-fish-completions"  target="_top">this to work</a>.
Note that this feature is automatically disabled when cross-compiling, since it
requires executing the binaries in question.</p></dd></dl></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="haskell-import-from-derivation" class="title" >Import-from-Derivation helpers   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-cabal2nix" class="title" >cabal2nix   </h4>  </div> </div></div><p><a class="link" href="https://github.com/nixos/cabal2nix"  target="_top"><code class="literal">cabal2nix</code></a> can generate Nix package definitions for arbitrary
Haskell packages using <a class="link" href="https://nixos.org/manual/nix/stable/language/import-from-derivation"  target="_top">import from derivation</a>.
<code class="literal">cabal2nix</code> will generate Nix expressions that look like this:</p><pre><code class="programlisting nix"># cabal get mtl-2.2.1 &amp;&amp; cd mtl-2.2.1 &amp;&amp; cabal2nix .
{
  mkDerivation,
  base,
  lib,
  transformers,
}:
mkDerivation {
  pname = &quot;mtl&quot;;
  version = &quot;2.2.1&quot;;
  src = ./.;
  libraryHaskellDepends = [
    base
    transformers
  ];
  homepage = &quot;http://github.com/ekmett/mtl&quot;;
  description = &quot;Monad classes, using functional dependencies&quot;;
  license = lib.licenses.bsd3;
}
</code></pre><p>This expression should be called with <code class="literal">haskellPackages.callPackage</code>, which will
supply <a class="link" href="index.html#haskell-mkderivation" title="haskellPackages.mkDerivation" ><code class="literal">haskellPackages.mkDerivation</code></a> and the Haskell
dependencies as arguments.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">callCabal2nix name src args</code></span></dt><dd><p>Create a package named <code class="literal">name</code> from the source derivation <code class="literal">src</code> using
<code class="literal">cabal2nix</code>.</p><p><code class="literal">args</code> are extra arguments provided to <code class="literal">haskellPackages.callPackage</code>.</p></dd><dt><span class="term"><code class="literal">callCabal2nixWithOptions name src opts args</code></span></dt><dd><p>Create a package named <code class="literal">name</code> from the source derivation <code class="literal">src</code> using
<code class="literal">cabal2nix</code>.</p><p><code class="literal">opts</code> are extra options for calling <code class="literal">cabal2nix</code>. If <code class="literal">opts</code> is a string, it
will be used as extra command line arguments for <code class="literal">cabal2nix</code>, e.g. <code class="literal">--subpath path/to/dir/containing/cabal-file</code>. Otherwise, <code class="literal">opts</code> should be an AttrSet
which can contain the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">extraCabal2nixOptions</code></span></dt><dd><p>Extra command line arguments for <code class="literal">cabal2nix</code>.</p></dd><dt><span class="term"><code class="literal">srcModifier</code></span></dt><dd><p>A function which is used to modify the given <code class="literal">src</code> instead of the default
filter.</p><p>The default source filter will remove all files from <code class="literal">src</code> except for
<code class="literal">.cabal</code> files and <code class="literal">package.yaml</code> files.</p></dd></dl></div></dd></dl></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="haskell-faq" class="title" >F.A.Q.   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-why-not-covered" class="title" >Why is topic X not covered in this section? Why is section Y missing?   </h4>  </div> </div></div><p>We have been working on <a class="link" href="https://github.com/NixOS/nixpkgs/issues/121403"  target="_top">moving the nixpkgs Haskell documentation back into the
nixpkgs manual</a>. Since this
process has not been completed yet, you may find some topics missing here
covered in the old <a class="link" href="https://haskell4nix.readthedocs.io/"  target="_top">haskell4nix docs</a>.</p><p>If you feel any important topic is not documented at all, feel free to comment
on the issue linked above.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="haskell-faq-override-profiling" class="title" >How to enable or disable profiling builds globally?   </h4>  </div> </div></div><p>By default, Nixpkgs builds a profiling version of each Haskell library. The
exception to this rule are some platforms where it is disabled due to concerns
over output size. You may want to…</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>…enable profiling globally so that you can build a project you are working on
with profiling ability giving you insight in the time spent across your code
and code you depend on using <a class="link" href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html"  target="_top">GHC’s profiling feature</a>.</p></li><li class="listitem"><p>…disable profiling (globally) to reduce the time spent building the profiling
versions of libraries which a significant amount of build time is spent on
(although they are not as expensive as the “normal” build of a Haskell library).</p></li></ul></div><div class="note"><h3 class="title">Note</h3><p>The method described below affects the build of all libraries in the
respective Haskell package set as well as GHC. If your choices differ from
Nixpkgs’ default for your (host) platform, you will lose the ability to
substitute from the official binary cache.</p><p>If you are concerned about build times and thus want to disable profiling, it
probably makes sense to use <code class="literal">haskell.lib.compose.disableLibraryProfiling</code> (see
<a class="xref" href="index.html#haskell-trivial-helpers" title="Trivial Helpers" >the section called “Trivial Helpers”</a>) on the packages you are building locally while
continuing to substitute their dependencies and GHC.</p></div><p>Since we need to change the profiling settings for the desired Haskell package
set <span class="emphasis"><em>and</em></span> GHC (as the core libraries like <code class="literal">base</code>, <code class="literal">filepath</code> etc. are bundled
with GHC), it is recommended to use overlays for Nixpkgs to change them.
Since the interrelated parts, i.e. the package set and GHC, are connected
via the Nixpkgs fixpoint, we need to modify them both in a way that preserves
their connection (or else we’d have to wire it up again manually). This is
achieved by changing GHC and the package set in separate overlays to prevent
the package set from pulling in GHC from <code class="literal">prev</code>.</p><p>The result is two overlays like the ones shown below. Adjustable parts are
annotated with comments, as are any optional or alternative ways to achieve
the desired profiling settings without causing too many rebuilds.</p><pre><code class="programlisting nix">let
  # Name of the compiler and package set you want to change. If you are using
  # the default package set `haskellPackages`, you need to look up what version
  # of GHC it currently uses (note that this is subject to change).
  ghcName = &quot;ghc92&quot;;
  # Desired new setting
  enableProfiling = true;

in
[
  # The first overlay modifies the GHC derivation so that it does or does not
  # build profiling versions of the core libraries bundled with it. It is
  # recommended to only use such an overlay if you are enabling profiling on a
  # platform that doesn&#x27;t by default, because compiling GHC from scratch is
  # quite expensive.
  (
    final: prev:
    let
      inherit (final) lib;

    in
    {
      haskell = prev.haskell // {
        compiler = prev.haskell.compiler // {
          ${ghcName} = prev.haskell.compiler.${ghcName}.override {
            # Unfortunately, the GHC setting is named differently for historical reasons
            enableProfiledLibs = enableProfiling;
          };
        };
      };
    }
  )

  (
    final: prev:
    let
      inherit (final) lib;
      haskellLib = final.haskell.lib.compose;

    in
    {
      haskell = prev.haskell // {
        packages = prev.haskell.packages // {
          ${ghcName} = prev.haskell.packages.${ghcName}.override {
            overrides = hfinal: hprev: {
              mkDerivation =
                args:
                hprev.mkDerivation (
                  args
                  // {
                    # Since we are forcing our ideas upon mkDerivation, this change will
                    # affect every package in the package set.
                    enableLibraryProfiling = enableProfiling;

                    # To actually use profiling on an executable, executable profiling
                    # needs to be enabled for the executable you want to profile. You
                    # can either do this globally or…
                    enableExecutableProfiling = enableProfiling;
                  }
                );

              # …only for the package that contains an executable you want to profile.
              # That saves on unnecessary rebuilds for packages that you only depend
              # on for their library, but also contain executables (e.g. pandoc).
              my-executable = haskellLib.enableExecutableProfiling hprev.my-executable;

              # If you are disabling profiling to save on build time, but want to
              # retain the ability to substitute from the binary cache. Drop the
              # override for mkDerivation above and instead have an override like
              # this for the specific packages you are building locally and want
              # to make cheaper to build.
              my-library = haskellLib.disableLibraryProfiling hprev.my-library;
            };
          };
        };
      };
    }
  )
]
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-hy" class="title" style="clear: both">Hy   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-hy-installation">Installation</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-hy-installation" class="title" >Installation   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="installation-without-packages" class="title" >Installation without packages   </h4>  </div> </div></div><p>You can install <code class="literal">hy</code> via nix-env or by adding it to <code class="literal">configuration.nix</code> by referring to it as a <code class="literal">hy</code> attribute. This kind of installation adds <code class="literal">hy</code> to your environment and it successfully works with <code class="literal">python3</code>.</p><div class="caution"><h3 class="title">Caution</h3><p>Packages that are installed with your python derivation, are not accessible by <code class="literal">hy</code> this way.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="installation-with-packages" class="title" >Installation with packages   </h4>  </div> </div></div><p>Creating <code class="literal">hy</code> derivation with custom <code class="literal">python</code> packages is really simple and similar to the way that python does it. Attribute <code class="literal">hy</code> provides function <code class="literal">withPackages</code> that creates custom <code class="literal">hy</code> derivation with specified packages.</p><p>For example if you want to create shell with <code class="literal">matplotlib</code> and <code class="literal">numpy</code>, you can do it like so:</p><pre><code class="programlisting ShellSession">$ nix-shell -p &quot;hy.withPackages (ps: with ps; [ numpy matplotlib ])&quot;
</code></pre><p>Or if you want to extend your <code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix">{
  # ...

  environment.systemPackages = with pkgs; [
    (hy.withPackages (
      py-packages: with py-packages; [
        numpy
        matplotlib
      ]
    ))
  ];
}
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="idris" class="title" style="clear: both">Idris   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#installing-idris">Installing Idris</a> </span></dt><dt> <span class="section">  <a href="index.html#starting-idris-with-library-support">Starting Idris with library support</a> </span></dt><dt> <span class="section">  <a href="index.html#building-an-idris-project-with-nix">Building an Idris project with Nix</a> </span></dt><dt> <span class="section">  <a href="index.html#passing-options-to-idris-commands">Passing options to <code class="literal">idris</code> commands</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="installing-idris" class="title" >Installing Idris   </h3>  </div> </div></div><p>The easiest way to get a working idris version is to install the <code class="literal">idris</code> attribute:</p><pre><code class="programlisting ShellSession">$ nix-env -f &quot;&lt;nixpkgs&gt;&quot; -iA idris
</code></pre><p>This however only provides the <code class="literal">prelude</code> and <code class="literal">base</code> libraries. To install idris with additional libraries, you can use the <code class="literal">idrisPackages.with-packages</code> function, e.g. in an overlay in <code class="literal">~/.config/nixpkgs/overlays/my-idris.nix</code>:</p><pre><code class="programlisting nix">self: super: {
  myIdris =
    with self.idrisPackages;
    with-packages [
      contrib
      pruviloj
    ];
}
</code></pre><p>And then:</p><pre><code class="programlisting ShellSession">$ # On NixOS
$ nix-env -iA nixos.myIdris
$ # On non-NixOS
$ nix-env -iA nixpkgs.myIdris
</code></pre><p>To see all available Idris packages:</p><pre><code class="programlisting ShellSession">$ # On NixOS
$ nix-env -qaPA nixos.idrisPackages
$ # On non-NixOS
$ nix-env -qaPA nixpkgs.idrisPackages
</code></pre><p>Similarly, entering a <code class="literal">nix-shell</code>:</p><pre><code class="programlisting ShellSession">$ nix-shell -p &#x27;idrisPackages.with-packages (with idrisPackages; [ contrib pruviloj ])&#x27;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="starting-idris-with-library-support" class="title" >Starting Idris with library support   </h3>  </div> </div></div><p>To have access to these libraries in idris, call it with an argument <code class="literal">-p &lt;library name&gt;</code> for each library:</p><pre><code class="programlisting ShellSession">$ nix-shell -p &#x27;idrisPackages.with-packages (with idrisPackages; [ contrib pruviloj ])&#x27;
[nix-shell:~]$ idris -p contrib -p pruviloj
</code></pre><p>A listing of all available packages the Idris binary has access to is available via <code class="literal">--listlibs</code>:</p><pre><code class="programlisting ShellSession">$ idris --listlibs
00prelude-idx.ibc
pruviloj
base
contrib
prelude
00pruviloj-idx.ibc
00base-idx.ibc
00contrib-idx.ibc
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="building-an-idris-project-with-nix" class="title" >Building an Idris project with Nix   </h3>  </div> </div></div><p>As an example of how a Nix expression for an Idris package can be created, here is the one for <code class="literal">idrisPackages.yaml</code>:</p><pre><code class="programlisting nix">{
  lib,
  build-idris-package,
  fetchFromGitHub,
  contrib,
  lightyear,
}:
build-idris-package {
  name = &quot;yaml&quot;;
  version = &quot;2018-01-25&quot;;

  # This is the .ipkg file that should be built, defaults to the package name
  # In this case it should build `Yaml.ipkg` instead of `yaml.ipkg`
  # This is only necessary because the yaml packages ipkg file is
  # different from its package name here.
  ipkgName = &quot;Yaml&quot;;
  # Idris dependencies to provide for the build
  idrisDeps = [
    contrib
    lightyear
  ];

  src = fetchFromGitHub {
    owner = &quot;Heather&quot;;
    repo = &quot;Idris.Yaml&quot;;
    rev = &quot;5afa51ffc839844862b8316faba3bafa15656db4&quot;;
    hash = &quot;sha256-h28F9EEPuvab6zrfeE+0k1XGQJGwINnsJEG8yjWIl7w=&quot;;
  };

  meta = {
    description = &quot;Idris YAML lib&quot;;
    homepage = &quot;https://github.com/Heather/Idris.Yaml&quot;;
    license = lib.licenses.mit;
    maintainers = [ lib.maintainers.brainrape ];
  };
}
</code></pre><p>Assuming this file is saved as <code class="literal">yaml.nix</code>, it’s buildable using</p><pre><code class="programlisting ShellSession">$ nix-build -E &#x27;(import &lt;nixpkgs&gt; {}).idrisPackages.callPackage ./yaml.nix {}&#x27;
</code></pre><p>Or it’s possible to use</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

{
  yaml = idrisPackages.callPackage ./yaml.nix { };
}
</code></pre><p>in another file (say <code class="literal">default.nix</code>) to be able to build it with</p><pre><code class="programlisting ShellSession">$ nix-build -A yaml
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="passing-options-to-idris-commands" class="title" >Passing options to <code class="literal">idris</code> commands   </h3>  </div> </div></div><p>The <code class="literal">build-idris-package</code> function provides also optional input values to set additional options for the used <code class="literal">idris</code> commands.</p><p>Specifically, you can set <code class="literal">idrisBuildOptions</code>, <code class="literal">idrisTestOptions</code>, <code class="literal">idrisInstallOptions</code> and <code class="literal">idrisDocOptions</code> to provide additional options to the <code class="literal">idris</code> command respectively when building, testing, installing and generating docs for your package.</p><p>For example you could set</p><pre><code class="programlisting nix">build-idris-package {
  idrisBuildOptions = [
    &quot;--log&quot;
    &quot;1&quot;
    &quot;--verbose&quot;
  ];

  # ...
}
</code></pre><p>to require verbose output during <code class="literal">idris</code> build phase.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-idris2" class="title" style="clear: both">Idris2   </h2>  </div> </div></div><p>In addition to exposing the Idris2 compiler itself, Nixpkgs exposes an <code class="literal">idris2Packages.buildIdris</code> helper to make it a bit more ergonomic to build Idris2 executables or libraries.</p><p>The <code class="literal">buildIdris</code> function takes an attribute set that defines at a minimum the <code class="literal">src</code> and <code class="literal">ipkgName</code> of the package to be built and any <code class="literal">idrisLibraries</code> required to build it. The <code class="literal">src</code> is the same source you’re familiar with and the <code class="literal">ipkgName</code> must be the name of the <code class="literal">ipkg</code> file for the project (omitting the <code class="literal">.ipkg</code> extension). The <code class="literal">idrisLibraries</code> is a list of other library derivations created with <code class="literal">buildIdris</code>. You can optionally specify other derivation properties as needed but sensible defaults for <code class="literal">configurePhase</code>, <code class="literal">buildPhase</code>, and <code class="literal">installPhase</code> are provided.</p><p>Importantly, <code class="literal">buildIdris</code> does not create a single derivation but rather an attribute set with two properties: <code class="literal">executable</code> and <code class="literal">library</code>. The <code class="literal">executable</code> property is a derivation and the <code class="literal">library</code> property is a function that will return a derivation for the library with or without source code included. Source code need not be included unless you are aiming to use IDE or LSP features that are able to jump to definitions within an editor.</p><p>A simple example of a fully packaged library would be the <a class="link" href="https://github.com/idris-community/LSP-lib"  target="_top"><code class="literal">LSP-lib</code></a> found in the <code class="literal">idris-community</code> GitHub organization.</p><pre><code class="programlisting nix">{ fetchFromGitHub, idris2Packages }:
let
  lspLibPkg = idris2Packages.buildIdris {
    ipkgName = &quot;lsp-lib&quot;;
    src = fetchFromGitHub {
      owner = &quot;idris-community&quot;;
      repo = &quot;LSP-lib&quot;;
      rev = &quot;main&quot;;
      hash = &quot;sha256-EvSyMCVyiy9jDZMkXQmtwwMoLaem1GsKVFqSGNNHHmY=&quot;;
    };
    idrisLibraries = [ ];
  };
in
lspLibPkg.library { withSource = true; }
</code></pre><p>The above results in a derivation with the installed library results (with sourcecode).</p><p>A slightly more involved example of a fully packaged executable would be the <a class="link" href="https://github.com/idris-community/idris2-lsp"  target="_top"><code class="literal">idris2-lsp</code></a> which is an Idris2 language server that uses the <code class="literal">LSP-lib</code> found above.</p><pre><code class="programlisting nix">{
  callPackage,
  fetchFromGitHub,
  idris2Packages,
}:

# Assuming the previous example lives in `lsp-lib.nix`:
let
  lspLib = callPackage ./lsp-lib.nix { };
  inherit (idris2Packages) idris2Api;
  lspPkg = idris2Packages.buildIdris {
    ipkgName = &quot;idris2-lsp&quot;;
    src = fetchFromGitHub {
      owner = &quot;idris-community&quot;;
      repo = &quot;idris2-lsp&quot;;
      rev = &quot;main&quot;;
      hash = &quot;sha256-vQTzEltkx7uelDtXOHc6QRWZ4cSlhhm5ziOqWA+aujk=&quot;;
    };
    idrisLibraries = [
      idris2Api
      lspLib
    ];
  };
in
lspPkg.executable
</code></pre><p>The above uses the default value of <code class="literal">withSource = false</code> for the <code class="literal">idris2Api</code> but could be modified to include that library’s source by passing <code class="literal">(idris2Api { withSource = true; })</code> to <code class="literal">idrisLibraries</code> instead. <code class="literal">idris2Api</code> in the above derivation comes built in with <code class="literal">idris2Packages</code>. This library exposes many of the otherwise internal APIs of the Idris2 compiler.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ios" class="title" style="clear: both">iOS   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#deploying-a-proxy-component-wrapper-exposing-xcode">Deploying a proxy component wrapper exposing Xcode</a> </span></dt><dt> <span class="section">  <a href="index.html#building-an-ios-application">Building an iOS application</a> </span></dt><dt> <span class="section">  <a href="index.html#spawning-simulator-instances">Spawning simulator instances</a> </span></dt><dt> <span class="section">  <a href="index.html#troubleshooting">Troubleshooting</a> </span></dt> </dl></div><p>This component is basically a wrapper/workaround that makes it possible to
expose an Xcode installation as a Nix package by means of symlinking to the
relevant executables on the host system.</p><p>Since Xcode can’t be packaged with Nix, nor we can publish it as a Nix package
(because of its license) this is basically the only integration strategy
making it possible to do iOS application builds that integrate with other
components of the Nix ecosystem</p><p>The primary objective of this project is to use the Nix expression language to
specify how iOS apps can be built from source code, and to automatically spawn
iOS simulator instances for testing.</p><p>This component also makes it possible to use <a class="link" href="https://nixos.org/hydra"  target="_top">Hydra</a>,
the Nix-based continuous integration server to regularly build iOS apps and to
do wireless ad-hoc installations of enterprise IPAs on iOS devices through
Hydra.</p><p>The Xcode build environment implements a number of features.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="deploying-a-proxy-component-wrapper-exposing-xcode" class="title" >Deploying a proxy component wrapper exposing Xcode   </h3>  </div> </div></div><p>The first use case is deploying a Nix package that provides symlinks to the Xcode
installation on the host system. This package can be used as a build input to
any build function implemented in the Nix expression language that requires
Xcode.</p><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };

  xcodeenv = import ./xcodeenv { inherit (pkgs) stdenv; };
in
xcodeenv.composeXcodeWrapper {
  version = &quot;9.2&quot;;
  xcodeBaseDir = &quot;/Applications/Xcode.app&quot;;
}
</code></pre><p>By deploying the above expression with <code class="literal">nix-build</code> and inspecting its content
you will notice that several Xcode-related executables are exposed as a Nix
package:</p><pre><code class="programlisting bash">$ ls result/bin
lrwxr-xr-x  1 sander  staff  94  1 jan  1970 Simulator -&gt; /Applications/Xcode.app/Contents/Developer/Applications/Simulator.app/Contents/MacOS/Simulator
lrwxr-xr-x  1 sander  staff  17  1 jan  1970 codesign -&gt; /usr/bin/codesign
lrwxr-xr-x  1 sander  staff  17  1 jan  1970 security -&gt; /usr/bin/security
lrwxr-xr-x  1 sander  staff  21  1 jan  1970 xcode-select -&gt; /usr/bin/xcode-select
lrwxr-xr-x  1 sander  staff  61  1 jan  1970 xcodebuild -&gt; /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild
lrwxr-xr-x  1 sander  staff  14  1 jan  1970 xcrun -&gt; /usr/bin/xcrun
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="building-an-ios-application" class="title" >Building an iOS application   </h3>  </div> </div></div><p>We can build an iOS app executable for the simulator, or an IPA/xcarchive file
for release purposes, e.g. ad-hoc, enterprise or store installations, by
executing the <code class="literal">xcodeenv.buildApp {}</code> function:</p><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };

  xcodeenv = import ./xcodeenv { inherit (pkgs) stdenv; };
in
xcodeenv.buildApp {
  name = &quot;MyApp&quot;;
  src = ./myappsources;
  sdkVersion = &quot;11.2&quot;;

  target = null; # Corresponds to the name of the app by default
  configuration = null; # Release for release builds, Debug for debug builds
  scheme = null; # -scheme will correspond to the app name by default
  sdk = null; # null will set it to &#x27;iphonesimulator` for simulator builds or `iphoneos` to real builds
  xcodeFlags = &quot;&quot;;

  release = true;
  certificateFile = ./mycertificate.p12;
  certificatePassword = &quot;secret&quot;;
  provisioningProfile = ./myprovisioning.profile;
  signMethod = &quot;ad-hoc&quot;; # &#x27;enterprise&#x27; or &#x27;store&#x27;
  generateIPA = true;
  generateXCArchive = false;

  enableWirelessDistribution = true;
  installURL = &quot;/installipa.php&quot;;
  bundleId = &quot;mycompany.myapp&quot;;
  appVersion = &quot;1.0&quot;;

  # Supports all xcodewrapper parameters as well
  xcodeBaseDir = &quot;/Applications/Xcode.app&quot;;
}
</code></pre><p>The above function takes a variety of parameters:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>The <code class="literal">name</code> and <code class="literal">src</code> parameters are mandatory and specify the name of the app
and the location where the source code resides</p></li><li class="listitem"><p><code class="literal">sdkVersion</code> specifies which version of the iOS SDK to use.</p></li></ul></div><p>It also possible to adjust the <code class="literal">xcodebuild</code> parameters. This is only needed in
rare circumstances. In most cases the default values should suffice:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Specifies which <code class="literal">xcodebuild</code> target to build. By default it takes the target
that has the same name as the app.</p></li><li class="listitem"><p>The <code class="literal">configuration</code> parameter can be overridden if desired. By default, it
will do a debug build for the simulator and a release build for real devices.</p></li><li class="listitem"><p>The <code class="literal">scheme</code> parameter specifies which <code class="literal">-scheme</code> parameter to propagate to
<code class="literal">xcodebuild</code>. By default, it corresponds to the app name.</p></li><li class="listitem"><p>The <code class="literal">sdk</code> parameter specifies which SDK to use. By default, it picks
<code class="literal">iphonesimulator</code> for simulator builds and <code class="literal">iphoneos</code> for release builds.</p></li><li class="listitem"><p>The <code class="literal">xcodeFlags</code> parameter specifies arbitrary command line parameters that
should be propagated to <code class="literal">xcodebuild</code>.</p></li></ul></div><p>By default, builds are carried out for the iOS simulator. To do release builds
(builds for real iOS devices), you must set the <code class="literal">release</code> parameter to <code class="literal">true</code>.
In addition, you need to set the following parameters:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">certificateFile</code> refers to a P12 certificate file.</p></li><li class="listitem"><p><code class="literal">certificatePassword</code> specifies the password of the P12 certificate.</p></li><li class="listitem"><p><code class="literal">provisioningProfile</code> refers to the provision profile needed to sign the app</p></li><li class="listitem"><p><code class="literal">signMethod</code> should refer to <code class="literal">ad-hoc</code> for signing the app with an ad-hoc
certificate, <code class="literal">enterprise</code> for enterprise certificates and <code class="literal">app-store</code> for App
store certificates.</p></li><li class="listitem"><p><code class="literal">generateIPA</code> specifies that we want to produce an IPA file (this is probably
what you want)</p></li><li class="listitem"><p><code class="literal">generateXCArchive</code> specifies that we want to produce an xcarchive file.</p></li></ul></div><p>When building IPA files on Hydra and when it is desired to allow iOS devices to
install IPAs by browsing to the Hydra build products page, you can enable the
<code class="literal">enableWirelessDistribution</code> parameter.</p><p>When enabled, you need to configure the following options:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>The <code class="literal">installURL</code> parameter refers to the URL of a PHP script that composes the
<code class="literal">itms-services://</code> URL allowing iOS devices to install the IPA file.</p></li><li class="listitem"><p><code class="literal">bundleId</code> refers to the bundle ID value of the app</p></li><li class="listitem"><p><code class="literal">appVersion</code> refers to the app’s version number</p></li></ul></div><p>To use wireless adhoc distributions, you must also install the corresponding
PHP script on a web server (see section: ‘Installing the PHP script for wireless
ad hoc installations from Hydra’ for more information).</p><p>In addition to the build parameters, you can also specify any parameters that
the <code class="literal">xcodeenv.composeXcodeWrapper {}</code> function takes. For example, the
<code class="literal">xcodeBaseDir</code> parameter can be overridden to refer to a different Xcode
version.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="spawning-simulator-instances" class="title" >Spawning simulator instances   </h3>  </div> </div></div><p>In addition to building iOS apps, we can also automatically spawn simulator
instances:</p><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };

  xcodeenv = import ./xcodeenv { inherit (pkgs) stdenv; };
in
xcode.simulateApp {
  name = &quot;simulate&quot;;

  # Supports all xcodewrapper parameters as well
  xcodeBaseDir = &quot;/Applications/Xcode.app&quot;;
}
</code></pre><p>The above expression produces a script that starts the simulator from the
provided Xcode installation. The script can be started as follows:</p><pre><code class="programlisting bash">./result/bin/run-test-simulator
</code></pre><p>By default, the script will show an overview of UDID for all available simulator
instances and asks you to pick one. You can also provide a UDID as a
command-line parameter to launch an instance automatically:</p><pre><code class="programlisting bash">./result/bin/run-test-simulator 5C93129D-CF39-4B1A-955F-15180C3BD4B8
</code></pre><p>You can also extend the simulator script to automatically deploy and launch an
app in the requested simulator instance:</p><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };

  xcodeenv = import ./xcodeenv { inherit (pkgs) stdenv; };
in
xcode.simulateApp {
  name = &quot;simulate&quot;;
  bundleId = &quot;mycompany.myapp&quot;;
  app = xcode.buildApp {
    # ...
  };

  # Supports all xcodewrapper parameters as well
  xcodeBaseDir = &quot;/Applications/Xcode.app&quot;;
}
</code></pre><p>By providing the result of an <code class="literal">xcode.buildApp {}</code> function and configuring the
app bundle id, the app gets deployed automatically and started.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="troubleshooting" class="title" >Troubleshooting   </h3>  </div> </div></div><p>In some rare cases, it may happen that after a failure, changes are not picked
up. Most likely, this is caused by a derived data cache that Xcode maintains.
To wipe it you can run:</p><pre><code class="programlisting bash">$ rm -rf ~/Library/Developer/Xcode/DerivedData
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-java" class="title" style="clear: both">Java   </h2>  </div> </div></div><p>Ant-based Java packages are typically built from source as follows:</p><pre><code class="programlisting nix">stdenv.mkDerivation {
  pname = &quot;...&quot;;
  version = &quot;...&quot;;

  src = fetchurl {
    # ...
  };

  nativeBuildInputs = [
    ant
    jdk
    stripJavaArchivesHook # removes timestamp metadata from jar files
  ];

  buildPhase = &#x27;&#x27;
    runHook preBuild
    ant # build the project using ant
    runHook postBuild
  &#x27;&#x27;;

  installPhase = &#x27;&#x27;
    runHook preInstall

    # copy generated jar file(s) to an appropriate location in $out
    install -Dm644 build/foo.jar $out/share/java/foo.jar

    runHook postInstall
  &#x27;&#x27;;
}
</code></pre><p>Note that <code class="literal">jdk</code> is an alias for the OpenJDK (self-built where available,
or pre-built via Zulu).</p><p>Also note that not using <code class="literal">stripJavaArchivesHook</code> will likely cause the
generated <code class="literal">.jar</code> files to be non-deterministic, which is not optimal.
Using it, however, does not always guarantee reproducibility.</p><p>JAR files that are intended to be used by other packages should be
installed in <code class="literal">$out/share/java</code>. JDKs have a stdenv setup hook that add
any JARs in the <code class="literal">share/java</code> directories of the build inputs to the
<code class="literal">CLASSPATH</code> environment variable. For instance, if the package <code class="literal">libfoo</code>
installs a JAR named <code class="literal">foo.jar</code> in its <code class="literal">share/java</code> directory, and
another package declares the attribute</p><pre><code class="programlisting nix">{
  buildInputs = [ libfoo ];
  nativeBuildInputs = [ jdk ];
}
</code></pre><p>then <code class="literal">CLASSPATH</code> will be set to
<code class="literal">/nix/store/...-libfoo/share/java/foo.jar</code>.</p><p>Private JARs should be installed in a location like
<code class="literal">$out/share/package-name</code>.</p><p>If your Java package provides a program, you need to generate a wrapper
script to run it using a JRE. You can use <code class="literal">makeWrapper</code> for this:</p><pre><code class="programlisting nix">{
  nativeBuildInputs = [ makeWrapper ];

  installPhase = &#x27;&#x27;
    runHook preInstall

    mkdir -p $out/bin
    makeWrapper ${jre}/bin/java $out/bin/foo \
      --add-flags &quot;-cp $out/share/java/foo.jar org.foo.Main&quot;

    runHook postInstall
  &#x27;&#x27;;
}
</code></pre><p>Since the introduction of the Java Platform Module System in Java 9,
Java distributions typically no longer ship with a general-purpose JRE:
instead, they allow generating a JRE with only the modules required for
your application(s). Because we can’t predict what modules will be
needed on a general-purpose system, the default jre package is the full
JDK. When building a minimal system/image, you can override the
<code class="literal">modules</code> parameter on <code class="literal">jre_minimal</code> to build a JRE with only the
modules relevant for you:</p><pre><code class="programlisting nix">let
  my_jre = pkgs.jre_minimal.override {
    modules = [
      # The modules used by &#x27;something&#x27; and &#x27;other&#x27; combined:
      &quot;java.base&quot;
      &quot;java.logging&quot;
    ];
  };
  something = (pkgs.something.override { jre = my_jre; });
  other = (pkgs.other.override { jre = my_jre; });
in
&lt;...&gt;
</code></pre><p>You can also specify what JDK your JRE should be based on, for example
selecting a ‘headless’ build to avoid including a link to GTK+:</p><pre><code class="programlisting nix">{ my_jre = pkgs.jre_minimal.override { jdk = jdk11_headless; }; }
</code></pre><p>Note all JDKs passthru <code class="literal">home</code>, so if your application requires
environment variables like <code class="literal">JAVA_HOME</code> being set, that can be done in a
generic fashion with the <code class="literal">--set</code> argument of <code class="literal">makeWrapper</code>:</p><pre><code class="programlisting bash">--set JAVA_HOME ${jdk.home}
</code></pre><p>It is possible to use a different Java compiler than <code class="literal">javac</code> from the
OpenJDK. For instance, to use the GNU Java Compiler:</p><pre><code class="programlisting nix">{
  nativeBuildInputs = [
    gcj
    ant
  ];
}
</code></pre><p>Here, Ant will automatically use <code class="literal">gij</code> (the GNU Java Runtime) instead of
the OpenJRE.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="language-javascript" class="title" style="clear: both">Javascript   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#javascript-introduction">Introduction</a> </span></dt><dt> <span class="section">  <a href="index.html#javascript-finding-examples">Getting unstuck / finding code examples</a> </span></dt><dt> <span class="section">  <a href="index.html#javascript-tools-overview">Tools overview</a> </span></dt><dt> <span class="section">  <a href="index.html#javascript-general-principles">General principles</a> </span></dt><dt> <span class="section">  <a href="index.html#javascript-packages-nixpkgs">Javascript packages inside nixpkgs</a> </span></dt><dt> <span class="section">  <a href="index.html#javascript-tool-specific">Tool specific instructions</a> </span></dt><dt> <span class="section">  <a href="index.html#javascript-outside-nixpkgs">Outside Nixpkgs</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="javascript-introduction" class="title" >Introduction   </h3>  </div> </div></div><p>This contains instructions on how to package javascript applications.</p><p>The various tools available will be listed in the <a class="link" href="index.html#javascript-tools-overview" title="Tools overview" >tools-overview</a>.
Some general principles for packaging will follow.
Finally some tool specific instructions will be given.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="javascript-finding-examples" class="title" >Getting unstuck / finding code examples   </h3>  </div> </div></div><p>If you find you are lacking inspiration for packaging javascript applications, the links below might prove useful.
Searching online for prior art can be helpful if you are running into solved problems.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-finding-examples-github" class="title" >Github   </h4>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Searching Nix files for <code class="literal">mkYarnPackage</code>: <a class="link" href="https://github.com/search?q=mkYarnPackage+language%3ANix&amp;type=code"  target="_top">https://github.com/search?q=mkYarnPackage+language%3ANix&amp;type=code</a></p></li><li class="listitem"><p>Searching just <code class="literal">flake.nix</code> files for <code class="literal">mkYarnPackage</code>: <a class="link" href="https://github.com/search?q=mkYarnPackage+path%3A**%2Fflake.nix&amp;type=code"  target="_top">https://github.com/search?q=mkYarnPackage+path%3A**%2Fflake.nix&amp;type=code</a></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-finding-examples-gitlab" class="title" >Gitlab   </h4>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Searching Nix files for <code class="literal">mkYarnPackage</code>: <a class="link" href="https://gitlab.com/search?scope=blobs&amp;search=mkYarnPackage+extension%3Anix"  target="_top">https://gitlab.com/search?scope=blobs&amp;search=mkYarnPackage+extension%3Anix</a></p></li><li class="listitem"><p>Searching just <code class="literal">flake.nix</code> files for <code class="literal">mkYarnPackage</code>: <a class="link" href="https://gitlab.com/search?scope=blobs&amp;search=mkYarnPackage+filename%3Aflake.nix"  target="_top">https://gitlab.com/search?scope=blobs&amp;search=mkYarnPackage+filename%3Aflake.nix</a></p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="javascript-tools-overview" class="title" >Tools overview   </h3>  </div> </div></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="javascript-general-principles" class="title" >General principles   </h3>  </div> </div></div><p>The following principles are given in order of importance with potential exceptions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-upstream-node-version" class="title" >Try to use the same node version used upstream   </h4>  </div> </div></div><p>It is often not documented which node version is used upstream, but if it is, try to use the same version when packaging.</p><p>This can be a problem if upstream is using the latest and greatest and you are trying to use an earlier version of node.
Some cryptic errors regarding V8 may appear.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-upstream-package-manager" class="title" >Try to respect the package manager originally used by upstream (and use the upstream lock file)   </h4>  </div> </div></div><p>A lock file (package-lock.json, yarn.lock…) is supposed to make reproducible installations of <code class="literal">node_modules</code> for each tool.</p><p>Guidelines of package managers, recommend to commit those lock files to the repos.
If a particular lock file is present, it is a strong indication of which package manager is used upstream.</p><p>It’s better to try to use a Nix tool that understand the lock file.
Using a different tool might give you hard to understand error because different packages have been installed.
An example of problems that could arise can be found <a class="link" href="https://github.com/NixOS/nixpkgs/pull/126629"  target="_top">here</a>.
Upstream use npm, but this is an attempt to package it with <code class="literal">yarn2nix</code> (that uses yarn.lock).</p><p>Using a different tool forces to commit a lock file to the repository.
Those files are fairly large, so when packaging for nixpkgs, this approach does not scale well.</p><p>Exceptions to this rule are:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>When you encounter one of the bugs from a Nix tool. In each of the tool specific instructions, known problems will be detailed. If you have a problem with a particular tool, then it’s best to try another tool, even if this means you will have to recreate a lock file and commit it to nixpkgs. In general <code class="literal">yarn2nix</code> has less known problems and so a simple search in nixpkgs will reveal many yarn.lock files committed.</p></li><li class="listitem"><p>Some lock files contain particular version of a package that has been pulled off npm for some reason. In that case, you can recreate upstream lock (by removing the original and <code class="literal">npm install</code>, <code class="literal">yarn</code>, …) and commit this to nixpkgs.</p></li><li class="listitem"><p>The only tool that supports workspaces (a feature of npm that helps manage sub-directories with different package.json from a single top level package.json) is <code class="literal">yarn2nix</code>. If upstream has workspaces you should try <code class="literal">yarn2nix</code>.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-upstream-package-json" class="title" >Try to use upstream package.json   </h4>  </div> </div></div><p>Exceptions to this rule are:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Sometimes the upstream repo assumes some dependencies be installed globally. In that case you can add them manually to the upstream package.json (<code class="literal">yarn add xxx</code> or <code class="literal">npm install xxx</code>, …). Dependencies that are installed locally can be executed with <code class="literal">npx</code> for CLI tools. (e.g. <code class="literal">npx postcss ...</code>, this is how you can call those dependencies in the phases).</p></li><li class="listitem"><p>Sometimes there is a version conflict between some dependency requirements. In that case you can fix a version by removing the <code class="literal">^</code>.</p></li><li class="listitem"><p>Sometimes the script defined in the package.json does not work as is. Some scripts for example use CLI tools that might not be available, or cd in directory with a different package.json (for workspaces notably). In that case, it’s perfectly fine to look at what the particular script is doing and break this down in the phases. In the build script you can see <code class="literal">build:*</code> calling in turns several other build scripts like <code class="literal">build:ui</code> or <code class="literal">build:server</code>. If one of those fails, you can try to separate those into,</p><pre><code class="programlisting sh">yarn build:ui
yarn build:server
# OR
npm run build:ui
npm run build:server
</code></pre><p>when you need to override a package.json. It’s nice to use the one from the upstream source and do some explicit override. Here is an example:</p><pre><code class="programlisting nix">{
  patchedPackageJSON = final.runCommand &quot;package.json&quot; { } &#x27;&#x27;
    ${jq}/bin/jq &#x27;.version = &quot;0.4.0&quot; |
      .devDependencies.&quot;@jsdoc/cli&quot; = &quot;^0.2.5&quot;
      ${sonar-src}/package.json &gt; $out
  &#x27;&#x27;;
}
</code></pre><p>You will still need to commit the modified version of the lock files, but at least the overrides are explicit for everyone to see.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-using-node_modules" class="title" >Using node_modules directly   </h4>  </div> </div></div><p>Each tool has an abstraction to just build the node_modules (dependencies) directory.
You can always use the <code class="literal">stdenv.mkDerivation</code> with the node_modules to build the package (symlink the node_modules directory and then use the package build command).
The node_modules abstraction can be also used to build some web framework frontends.
For an example of this see how <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/servers/web-apps/plausible/default.nix"  target="_top">plausible</a> is built. <code class="literal">mkYarnModules</code> to make the derivation containing node_modules.
Then when building the frontend you can just symlink the node_modules directory.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="javascript-packages-nixpkgs" class="title" >Javascript packages inside nixpkgs   </h3>  </div> </div></div><p>The <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/node-packages"  target="_top">pkgs/development/node-packages</a> folder contains a generated collection of <a class="link" href="https://npmjs.com/"  target="_top">npm packages</a> that can be installed with the Nix package manager.</p><p>As a rule of thumb, the package set should only provide <span class="emphasis"><em>end user</em></span> software packages, such as command-line utilities.
Libraries should only be added to the package set if there is a non-npm package that requires it.</p><p>When it is desired to use npm libraries in a development project, use the <code class="literal">node2nix</code> generator directly on the <code class="literal">package.json</code> configuration file of the project.</p><p>The package set provides support for the official stable Node.js versions.
The latest stable LTS release in <code class="literal">nodePackages</code>, as well as the latest stable current release in <code class="literal">nodePackages_latest</code>.</p><p>If your package uses native addons, you need to examine what kind of native build system it uses. Here are some examples:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">node-gyp</code></p></li><li class="listitem"><p><code class="literal">node-gyp-builder</code></p></li><li class="listitem"><p><code class="literal">node-pre-gyp</code></p></li></ul></div><p>After you have identified the correct system, you need to override your package expression while adding in build system as a build input.
For example, <code class="literal">dat</code> requires <code class="literal">node-gyp-build</code>, so we override its expression in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/node-packages/overrides.nix"  target="_top">pkgs/development/node-packages/overrides.nix</a>:</p><pre><code class="programlisting nix">{
  dat = prev.dat.override (oldAttrs: {
    buildInputs = [
      final.node-gyp-build
      pkgs.libtool
      pkgs.autoconf
      pkgs.automake
    ];
    meta = oldAttrs.meta // {
      broken = since &quot;12&quot;;
    };
  });
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-adding-or-updating-packages" class="title" >Adding and Updating Javascript packages in nixpkgs   </h4>  </div> </div></div><p>To add a package from npm to nixpkgs:</p><div class="orderedlist"><ol class="orderedlist "  type="1"><li class="listitem"><p>Modify <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/node-packages/node-packages.json"  target="_top">pkgs/development/node-packages/node-packages.json</a> to add, update or remove package entries to have it included in <code class="literal">nodePackages</code> and <code class="literal">nodePackages_latest</code>.</p></li><li class="listitem"><p>Run the script:</p><pre><code class="programlisting sh">./pkgs/development/node-packages/generate.sh
</code></pre></li><li class="listitem"><p>Build your new package to test your changes:</p><pre><code class="programlisting sh">nix-build -A nodePackages.&lt;new-or-updated-package&gt;
</code></pre><p>To build against the latest stable Current Node.js version (e.g. 18.x):</p><pre><code class="programlisting sh">nix-build -A nodePackages_latest.&lt;new-or-updated-package&gt;
</code></pre><p>If the package doesn’t build, you may need to add an override as explained above.</p></li><li class="listitem"><p>If the package’s name doesn’t match any of the executables it provides, add an entry in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/node-packages/main-programs.nix"  target="_top">pkgs/development/node-packages/main-programs.nix</a>. This will be the case for all scoped packages, e.g., <code class="literal">@angular/cli</code>.</p></li><li class="listitem"><p>Add and commit all modified and generated files.</p></li></ol></div><p>For more information about the generation process, consult the <a class="link" href="https://github.com/svanderburg/node2nix"  target="_top">README.md</a> file of the <code class="literal">node2nix</code> tool.</p><p>To update npm packages in nixpkgs, run the same <code class="literal">generate.sh</code> script:</p><pre><code class="programlisting sh">./pkgs/development/node-packages/generate.sh
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-git-error" class="title" >Git protocol error   </h5>  </div> </div></div><p>Some packages may have Git dependencies from GitHub specified with <code class="literal">git://</code>.
GitHub has <a class="link" href="https://github.blog/2021-09-01-improving-git-protocol-security-github/#no-more-unauthenticated-git"  target="_top">disabled unencrypted Git connections</a>, so you may see the following error when running the generate script:</p><pre><code class="programlisting">The unauthenticated git protocol on port 9418 is no longer supported
</code></pre><p>Use the following Git configuration to resolve the issue:</p><pre><code class="programlisting sh">git config --global url.&quot;https://github.com/&quot;.insteadOf git://github.com/
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="javascript-tool-specific" class="title" >Tool specific instructions   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-buildNpmPackage" class="title" >buildNpmPackage   </h4>  </div> </div></div><p><code class="literal">buildNpmPackage</code> allows you to package npm-based projects in Nixpkgs without the use of an auto-generated dependencies file (as used in <a class="link" href="index.html#javascript-node2nix" title="node2nix" >node2nix</a>).
It works by utilizing npm’s cache functionality – creating a reproducible cache that contains the dependencies of a project, and pointing npm to it.</p><p>Here’s an example:</p><pre><code class="programlisting nix">{
  lib,
  buildNpmPackage,
  fetchFromGitHub,
}:

buildNpmPackage (finalAttrs: {
  pname = &quot;flood&quot;;
  version = &quot;4.7.0&quot;;

  src = fetchFromGitHub {
    owner = &quot;jesec&quot;;
    repo = &quot;flood&quot;;
    tag = &quot;v${finalAttrs.version}&quot;;
    hash = &quot;sha256-BR+ZGkBBfd0dSQqAvujsbgsEPFYw/ThrylxUbOksYxM=&quot;;
  };

  npmDepsHash = &quot;sha256-tuEfyePwlOy2/mOPdXbqJskO6IowvAP4DWg8xSZwbJw=&quot;;

  # The prepack script runs the build script, which we&#x27;d rather do in the build phase.
  npmPackFlags = [ &quot;--ignore-scripts&quot; ];

  NODE_OPTIONS = &quot;--openssl-legacy-provider&quot;;

  meta = {
    description = &quot;Modern web UI for various torrent clients with a Node.js backend and React frontend&quot;;
    homepage = &quot;https://flood.js.org&quot;;
    license = lib.licenses.gpl3Only;
    maintainers = with lib.maintainers; [ winter ];
  };
})
</code></pre><p>In the default <code class="literal">installPhase</code> set by <code class="literal">buildNpmPackage</code>, it uses <code class="literal">npm pack --json --dry-run</code> to decide what files to install in <code class="literal">$out/lib/node_modules/$name/</code>, where <code class="literal">$name</code> is the <code class="literal">name</code> string defined in the package’s <code class="literal">package.json</code>.
Additionally, the <code class="literal">bin</code> and <code class="literal">man</code> keys in the source’s <code class="literal">package.json</code> are used to decide what binaries and manpages are supposed to be installed.
If these are not defined, <code class="literal">npm pack</code> may miss some files, and no binaries will be produced.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-buildNpmPackage-arguments" class="title" >Arguments   </h5>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">npmDepsHash</code>: The output hash of the dependencies for this project. Can be calculated in advance with <a class="link" href="index.html#javascript-buildNpmPackage-prefetch-npm-deps" title="prefetch-npm-deps" ><code class="literal">prefetch-npm-deps</code></a>.</p></li><li class="listitem"><p><code class="literal">makeCacheWritable</code>: Whether to make the cache writable prior to installing dependencies. Don’t set this unless npm tries to write to the cache directory, as it can slow down the build.</p></li><li class="listitem"><p><code class="literal">npmBuildScript</code>: The script to run to build the project. Defaults to <code class="literal">&quot;build&quot;</code>.</p></li><li class="listitem"><p><code class="literal">npmWorkspace</code>: The workspace directory within the project to build and install.</p></li><li class="listitem"><p><code class="literal">dontNpmBuild</code>: Option to disable running the build script. Set to <code class="literal">true</code> if the package does not have a build script. Defaults to <code class="literal">false</code>. Alternatively, setting <code class="literal">buildPhase</code> explicitly also disables this.</p></li><li class="listitem"><p><code class="literal">dontNpmInstall</code>: Option to disable running <code class="literal">npm install</code>. Defaults to <code class="literal">false</code>. Alternatively, setting <code class="literal">installPhase</code> explicitly also disables this.</p></li><li class="listitem"><p><code class="literal">npmFlags</code>: Flags to pass to all npm commands.</p></li><li class="listitem"><p><code class="literal">npmInstallFlags</code>: Flags to pass to <code class="literal">npm ci</code>.</p></li><li class="listitem"><p><code class="literal">npmBuildFlags</code>: Flags to pass to <code class="literal">npm run ${npmBuildScript}</code>.</p></li><li class="listitem"><p><code class="literal">npmPackFlags</code>: Flags to pass to <code class="literal">npm pack</code>.</p></li><li class="listitem"><p><code class="literal">npmPruneFlags</code>: Flags to pass to <code class="literal">npm prune</code>. Defaults to the value of <code class="literal">npmInstallFlags</code>.</p></li><li class="listitem"><p><code class="literal">makeWrapperArgs</code>: Flags to pass to <code class="literal">makeWrapper</code>, added to executable calling the generated <code class="literal">.js</code> with <code class="literal">node</code> as an interpreter. These scripts are defined in <code class="literal">package.json</code>.</p></li><li class="listitem"><p><code class="literal">nodejs</code>: The <code class="literal">nodejs</code> package to build against, using the corresponding <code class="literal">npm</code> shipped with that version of <code class="literal">node</code>. Defaults to <code class="literal">pkgs.nodejs</code>.</p></li><li class="listitem"><p><code class="literal">npmDeps</code>: The dependencies used to build the npm package. Especially useful to not have to recompute workspace dependencies.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-buildNpmPackage-prefetch-npm-deps" class="title" >prefetch-npm-deps   </h5>  </div> </div></div><p><code class="literal">prefetch-npm-deps</code> is a Nixpkgs package that calculates the hash of the dependencies of an npm project ahead of time.</p><pre><code class="programlisting console">$ ls
package.json package-lock.json index.js
$ prefetch-npm-deps package-lock.json
...
sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-buildNpmPackage-fetchNpmDeps" class="title" >fetchNpmDeps   </h5>  </div> </div></div><p><code class="literal">fetchNpmDeps</code> is a Nix function that requires the following mandatory arguments:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">src</code>: A directory / tarball with <code class="literal">package-lock.json</code> file</p></li><li class="listitem"><p><code class="literal">hash</code>: The output hash of the node dependencies defined in <code class="literal">package-lock.json</code>.</p></li></ul></div><p>It returns a derivation with all <code class="literal">package-lock.json</code> dependencies downloaded into <code class="literal">$out/</code>, usable as an npm cache.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-buildNpmPackage-importNpmLock" class="title" >importNpmLock   </h5>  </div> </div></div><p>This function replaces the npm dependency references in <code class="literal">package.json</code> and <code class="literal">package-lock.json</code> with paths to the Nix store.
How each dependency is fetched can be customized with the <code class="literal">fetcherOpts</code> argument.</p><p>This is a simpler and more convenient alternative to <a class="link" href="index.html#javascript-buildNpmPackage-fetchNpmDeps" title="fetchNpmDeps" ><code class="literal">fetchNpmDeps</code></a> for managing npm dependencies in Nixpkgs.
There is no need to specify a <code class="literal">hash</code>, since it relies entirely on the integrity hashes already present in the <code class="literal">package-lock.json</code> file.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-buildNpmPackage-inputs" class="title" >Inputs   </h6>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">npmRoot</code>: Path to package directory containing the source tree.
If this is omitted, the <code class="literal">package</code> and <code class="literal">packageLock</code> arguments must be specified instead.</p></li><li class="listitem"><p><code class="literal">package</code>: Parsed contents of <code class="literal">package.json</code></p></li><li class="listitem"><p><code class="literal">packageLock</code>: Parsed contents of <code class="literal">package-lock.json</code></p></li><li class="listitem"><p><code class="literal">pname</code>: Package name</p></li><li class="listitem"><p><code class="literal">version</code>: Package version</p></li><li class="listitem"><p><code class="literal">fetcherOpts</code>: An attribute set of arguments forwarded to the underlying fetcher.</p></li></ul></div><p>It returns a derivation with a patched <code class="literal">package.json</code> &amp; <code class="literal">package-lock.json</code> with all dependencies resolved to Nix store paths.</p><div class="note"><h3 class="title">Note</h3><p><code class="literal">npmHooks.npmConfigHook</code> cannot be used with <code class="literal">importNpmLock</code>.
Use <code class="literal">importNpmLock.npmConfigHook</code> instead.</p></div><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 357. <code class="literal">pkgs.importNpmLock</code> usage example</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ buildNpmPackage, importNpmLock }:

buildNpmPackage {
  pname = &quot;hello&quot;;
  version = &quot;0.1.0&quot;;
  src = ./.;

  npmDeps = importNpmLock { npmRoot = ./.; };

  npmConfigHook = importNpmLock.npmConfigHook;
}
</code></pre></div></details></div><br class="example-break" /><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 358. <code class="literal">pkgs.importNpmLock</code> usage example with <code class="literal">fetcherOpts</code></strong></span></summary><div class="example-contents"><p><code class="literal">importNpmLock</code> uses the following fetchers:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pkgs.fetchurl</code> for <code class="literal">http(s)</code> dependencies</p></li><li class="listitem"><p><code class="literal">builtins.fetchGit</code> for <code class="literal">git</code> dependencies</p></li></ul></div><p>It is possible to provide additional arguments to individual fetchers as needed:</p><pre><code class="programlisting nix">{ buildNpmPackage, importNpmLock }:

buildNpmPackage {
  pname = &quot;hello&quot;;
  version = &quot;0.1.0&quot;;
  src = ./.;

  npmDeps = importNpmLock {
    npmRoot = ./.;
    fetcherOpts = {
      # Pass &#x27;curlOptsList&#x27; to &#x27;pkgs.fetchurl&#x27; while fetching &#x27;axios&#x27;
      &quot;node_modules/axios&quot; = {
        curlOptsList = [ &quot;--verbose&quot; ];
      };
    };
  };

  npmConfigHook = importNpmLock.npmConfigHook;
}
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-buildNpmPackage-importNpmLock.buildNodeModules" class="title" >importNpmLock.buildNodeModules   </h5>  </div> </div></div><p><code class="literal">importNpmLock.buildNodeModules</code> returns a derivation with a pre-built <code class="literal">node_modules</code> directory, as imported by <code class="literal">importNpmLock</code>.</p><p>This is to be used together with <code class="literal">importNpmLock.hooks.linkNodeModulesHook</code> to facilitate <code class="literal">nix-shell</code>/<code class="literal">nix develop</code> based development workflows.</p><p>It accepts an argument with the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">npmRoot</code> (Path; optional)</span></dt><dd><p>Path to package directory containing the source tree. If not specified, the <code class="literal">package</code> and <code class="literal">packageLock</code> arguments must both be specified.</p></dd><dt><span class="term"><code class="literal">package</code> (Attrset; optional)</span></dt><dd><p>Parsed contents of <code class="literal">package.json</code>, as returned by <code class="literal">lib.importJSON ./my-package.json</code>. If not specified, the <code class="literal">package.json</code> in <code class="literal">npmRoot</code> is used.</p></dd><dt><span class="term"><code class="literal">packageLock</code> (Attrset; optional)</span></dt><dd><p>Parsed contents of <code class="literal">package-lock.json</code>, as returned <code class="literal">lib.importJSON ./my-package-lock.json</code>. If not specified, the <code class="literal">package-lock.json</code> in <code class="literal">npmRoot</code> is used.</p></dd><dt><span class="term"><code class="literal">derivationArgs</code> (<code class="literal">mkDerivation</code> attrset; optional)</span></dt><dd><p>Arguments passed to <code class="literal">stdenv.mkDerivation</code></p></dd></dl></div><p>For example:</p><pre><code class="programlisting nix">pkgs.mkShell {
  packages = [
    importNpmLock.hooks.linkNodeModulesHook
    nodejs
  ];

  npmDeps = importNpmLock.buildNodeModules {
    npmRoot = ./.;
    inherit nodejs;
  };
}
</code></pre><p>will create a development shell where a <code class="literal">node_modules</code> directory is created &amp; packages symlinked to the Nix store when activated.</p><div class="note"><h3 class="title">Note</h3><p>Commands like <code class="literal">npm install</code> &amp; <code class="literal">npm add</code> that writes packages &amp; executables needs to be used with <code class="literal">--package-lock-only</code>.</p><p>This means <code class="literal">npm</code> installs dependencies by writing into <code class="literal">package-lock.json</code> without modifying the <code class="literal">node_modules</code> folder. Installation happens through reloading the devShell.
This might be best practice since it gives the <code class="literal">nix shell</code> virtually exclusive ownership over your <code class="literal">node_modules</code> folder.</p><p>It’s recommended to set <code class="literal">package-lock-only = true</code> in your project-local <a class="link" href="https://docs.npmjs.com/cli/v11/configuring-npm/npmrc"  target="_top"><code class="literal">.npmrc</code></a>.</p></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-corepack" class="title" >corepack   </h4>  </div> </div></div><p>This package puts the corepack wrappers for pnpm and yarn in your PATH, and they will honor the <code class="literal">packageManager</code> setting in the <code class="literal">package.json</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-node2nix" class="title" >node2nix   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-node2nix-preparation" class="title" >Preparation   </h5>  </div> </div></div><p>You will need to generate a Nix expression for the dependencies. Don’t forget the <code class="literal">-l package-lock.json</code> if there is a lock file. Most probably you will need the <code class="literal">--development</code> to include the <code class="literal">devDependencies</code></p><p>So the command will most likely be:</p><pre><code class="programlisting sh">node2nix --development -l package-lock.json
</code></pre><p>See <code class="literal">node2nix</code> <a class="link" href="https://github.com/svanderburg/node2nix"  target="_top">docs</a> for more info.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-node2nix-pitfalls" class="title" >Pitfalls   </h5>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>If upstream package.json does not have a “version” attribute, <code class="literal">node2nix</code> will crash. You will need to add it like shown in <a class="link" href="index.html#javascript-upstream-package-json" title="Try to use upstream package.json" >the package.json section</a>.</p></li><li class="listitem"><p><code class="literal">node2nix</code> has some <a class="link" href="https://github.com/svanderburg/node2nix/issues/238"  target="_top">bugs</a> related to working with lock files from npm distributed with <code class="literal">nodejs_16</code>.</p></li><li class="listitem"><p><code class="literal">node2nix</code> does not like missing packages from npm. If you see something like <code class="literal">Cannot resolve version: vue-loader-v16@undefined</code> then you might want to try another tool. The package might have been pulled off of npm.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-pnpm" class="title" >pnpm   </h4>  </div> </div></div><p>Pnpm is available as the top-level package <code class="literal">pnpm</code>. Additionally, there are variants pinned to certain major versions, like <code class="literal">pnpm_8</code> and <code class="literal">pnpm_9</code>, which support different sets of lock file versions.</p><p>When packaging an application that includes a <code class="literal">pnpm-lock.yaml</code>, you need to fetch the pnpm store for that project using a fixed-output-derivation. The functions <code class="literal">pnpm_8.fetchDeps</code> and <code class="literal">pnpm_9.fetchDeps</code> can create this pnpm store derivation. In conjunction, the setup hooks <code class="literal">pnpm_8.configHook</code> and <code class="literal">pnpm_9.configHook</code> will prepare the build environment to install the prefetched dependencies store. Here is an example for a package that contains a <code class="literal">package.json</code> and a <code class="literal">pnpm-lock.yaml</code> files using the above <code class="literal">pnpm_</code> attributes:</p><pre><code class="programlisting nix">{
  stdenv,
  nodejs,
  # This is pinned as { pnpm = pnpm_9; }
  pnpm,
}:

stdenv.mkDerivation (finalAttrs: {
  pname = &quot;foo&quot;;
  version = &quot;0-unstable-1980-01-01&quot;;

  src = {
    #...
  };

  nativeBuildInputs = [
    nodejs
    pnpm.configHook
  ];

  pnpmDeps = pnpm.fetchDeps {
    inherit (finalAttrs) pname version src;
    fetcherVersion = 2;
    hash = &quot;...&quot;;
  };
})
</code></pre><p>NOTE: It is highly recommended to use a pinned version of pnpm (i.e. <code class="literal">pnpm_8</code> or <code class="literal">pnpm_9</code>), to increase future reproducibility. It might also be required to use an older version, if the package needs support for a certain lock file version.</p><p>In case you are patching <code class="literal">package.json</code> or <code class="literal">pnpm-lock.yaml</code>, make sure to pass <code class="literal">finalAttrs.patches</code> to the function as well (i.e. <code class="literal">inherit (finalAttrs) patches</code>.</p><p><code class="literal">pnpm.configHook</code> supports adding additional <code class="literal">pnpm install</code> flags via <code class="literal">pnpmInstallFlags</code> which can be set to a Nix string array:</p><pre><code class="programlisting nix">{ pnpm }:

stdenv.mkDerivation (finalAttrs: {
  pname = &quot;foo&quot;;
  version = &quot;0-unstable-1980-01-01&quot;;

  src = {
    # ...
  };

  pnpmInstallFlags = [ &quot;--shamefully-hoist&quot; ];

  pnpmDeps = pnpm.fetchDeps { inherit (finalAttrs) pnpmInstallFlags; };
})
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-pnpm-sourceRoot" class="title" >Dealing with <code class="literal">sourceRoot</code>   </h5>  </div> </div></div><p>If the pnpm project is in a subdirectory, you can just define <code class="literal">sourceRoot</code> or <code class="literal">setSourceRoot</code> for <code class="literal">fetchDeps</code>.
If <code class="literal">sourceRoot</code> is different between the parent derivation and <code class="literal">fetchDeps</code>, you will have to set <code class="literal">pnpmRoot</code> to effectively be the same location as it is in <code class="literal">fetchDeps</code>.</p><p>Assuming the following directory structure, we can define <code class="literal">sourceRoot</code> and <code class="literal">pnpmRoot</code> as follows:</p><pre><code class="programlisting">.
├── frontend
│   ├── ...
│   ├── package.json
│   └── pnpm-lock.yaml
└── ...
</code></pre><pre><code class="programlisting nix">{
  # ...
  pnpmDeps = pnpm.fetchDeps {
    # ...
    sourceRoot = &quot;${finalAttrs.src.name}/frontend&quot;;
  };

  # by default the working directory is the extracted source
  pnpmRoot = &quot;frontend&quot;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-pnpm-workspaces" class="title" >PNPM Workspaces   </h5>  </div> </div></div><p>If you need to use a PNPM workspace for your project, then set <code class="literal">pnpmWorkspaces = [ &quot;&lt;workspace project name 1&gt;&quot; &quot;&lt;workspace project name 2&gt;&quot; ]</code>, etc, in your <code class="literal">pnpm.fetchDeps</code> call,
which will make PNPM only install dependencies for those workspace packages.</p><p>For example:</p><pre><code class="programlisting nix">{
  # ...
  pnpmWorkspaces = [ &quot;@astrojs/language-server&quot; ];
  pnpmDeps = pnpm.fetchDeps {
    inherit (finalAttrs) pnpmWorkspaces;
    #...
  };
}
</code></pre><p>The above would make <code class="literal">pnpm.fetchDeps</code> call only install dependencies for the <code class="literal">@astrojs/language-server</code> workspace package.
Note that you do not need to set <code class="literal">sourceRoot</code> to make this work.</p><p>Usually in such cases, you’d want to use <code class="literal">pnpm --filter=&lt;pnpm workspace name&gt; build</code> to build your project, as <code class="literal">npmHooks.npmBuildHook</code> probably won’t work. A <code class="literal">buildPhase</code> based on the following example will probably fit most workspace projects:</p><pre><code class="programlisting nix">{
  buildPhase = &#x27;&#x27;
    runHook preBuild

    pnpm --filter=@astrojs/language-server build

    runHook postBuild
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-pnpm-extraCommands" class="title" >Additional PNPM Commands and settings   </h5>  </div> </div></div><p>If you require setting an additional PNPM configuration setting (such as <code class="literal">dedupe-peer-dependents</code> or similar),
set <code class="literal">prePnpmInstall</code> to the right commands to run. For example:</p><pre><code class="programlisting nix">{
  prePnpmInstall = &#x27;&#x27;
    pnpm config set dedupe-peer-dependants false
  &#x27;&#x27;;
  pnpmDeps = pnpm.fetchDeps {
    inherit (finalAttrs) prePnpmInstall;
    # ...
  };
}
</code></pre><p>In this example, <code class="literal">prePnpmInstall</code> will be run by both <code class="literal">pnpm.configHook</code> and by the <code class="literal">pnpm.fetchDeps</code> builder.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-pnpm-fetcherVersion" class="title" >PNPM <code class="literal">fetcherVersion</code>   </h5>  </div> </div></div><p>This is the version of the output of <code class="literal">pnpm.fetchDeps</code>, if you haven’t set it already, you can use <code class="literal">1</code> with your current hash:</p><pre><code class="programlisting nix">{
  # ...
  pnpmDeps = pnpm.fetchDeps {
    # ...
    fetcherVersion = 1;
    hash = &quot;...&quot;; # you can use your already set hash here
  };
}
</code></pre><p>After upgrading to a newer <code class="literal">fetcherVersion</code>, you need to regenerate the hash:</p><pre><code class="programlisting nix">{
  # ...
  pnpmDeps = pnpm.fetchDeps {
    # ...
    fetcherVersion = 2;
    hash = &quot;...&quot;; # clear this hash and generate a new one
  };
}
</code></pre><p>This variable ensures that we can make changes to the output of <code class="literal">pnpm.fetchDeps</code> without breaking existing hashes.
Changes can include workarounds or bug fixes to existing PNPM issues.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-pnpm-fetcherVersion-versionHistory" class="title" >Version history   </h6>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>1: Initial version, nothing special</p></li><li class="listitem"><p>2: <a class="link" href="https://github.com/NixOS/nixpkgs/pull/422975"  target="_top">Ensure consistent permissions</a></p></li></ul></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-yarn" class="title" >Yarn   </h4>  </div> </div></div><p>Yarn based projects use a <code class="literal">yarn.lock</code> file instead of a <code class="literal">package-lock.json</code> to pin dependencies.</p><p>To package yarn-based applications, you need to distinguish by the version pointers in the <code class="literal">yarn.lock</code> file. See the following sections.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-yarn-v1" class="title" >Yarn v1   </h5>  </div> </div></div><p>Yarn v1 lockfiles contain a comment <code class="literal"># yarn lockfile v1</code> at the beginning of the file.</p><p>Nixpkgs provides the Nix function <code class="literal">fetchYarnDeps</code> which fetches an offline cache suitable for running <code class="literal">yarn install</code> before building the project. In addition, Nixpkgs provides the hooks:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">yarnConfigHook</code>: Fetches the dependencies from the offline cache and installs them into <code class="literal">node_modules</code>.</p></li><li class="listitem"><p><code class="literal">yarnBuildHook</code>: Runs <code class="literal">yarn build</code> or a specified <code class="literal">yarn</code> command that builds the project.</p></li><li class="listitem"><p><code class="literal">yarnInstallHook</code>: Runs <code class="literal">yarn install --production</code> to prune dependencies and installs the project into <code class="literal">$out</code>.</p></li></ul></div><p>An example usage of the above attributes is:</p><pre><code class="programlisting nix">{
  lib,
  stdenv,
  fetchFromGitHub,
  fetchYarnDeps,
  yarnConfigHook,
  yarnBuildHook,
  yarnInstallHook,
  nodejs,
}:

stdenv.mkDerivation (finalAttrs: {
  pname = &quot;...&quot;;
  version = &quot;...&quot;;

  src = fetchFromGitHub {
    owner = &quot;...&quot;;
    repo = &quot;...&quot;;
    rev = &quot;v${finalAttrs.version}&quot;;
    hash = &quot;sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;;
  };

  yarnOfflineCache = fetchYarnDeps {
    yarnLock = finalAttrs.src + &quot;/yarn.lock&quot;;
    hash = &quot;sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;;
  };

  nativeBuildInputs = [
    yarnConfigHook
    yarnBuildHook
    yarnInstallHook
    # Needed for executing package.json scripts
    nodejs
  ];

  meta = {
    # ...
  };
})
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-yarnconfighook" class="title" ><code class="literal">yarnConfigHook</code> arguments   </h6>  </div> </div></div><p>By default, <code class="literal">yarnConfigHook</code> relies upon the attribute <code class="literal">${yarnOfflineCache}</code> (or <code class="literal">${offlineCache}</code> if the former is not set) to find the location of the offline cache produced by <code class="literal">fetchYarnDeps</code>. To disable this phase, you can set <code class="literal">dontYarnInstallDeps = true</code> or override the <code class="literal">configurePhase</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-yarnbuildhook" class="title" ><code class="literal">yarnBuildHook</code> arguments   </h6>  </div> </div></div><p>This script by default runs <code class="literal">yarn --offline build</code>, and it relies upon the project’s dependencies installed at <code class="literal">node_modules</code>. Below is a list of additional <code class="literal">mkDerivation</code> arguments read by this hook:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">yarnBuildScript</code>: Sets a different <code class="literal">yarn --offline</code> subcommand (defaults to <code class="literal">build</code>).</p></li><li class="listitem"><p><code class="literal">yarnBuildFlags</code>: Single string list of additional flags to pass the above command, or a Nix list of such additional flags.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-yarninstallhook" class="title" ><code class="literal">yarnInstallHook</code> arguments   </h6>  </div> </div></div><p>To install the package <code class="literal">yarnInstallHook</code> uses both <code class="literal">npm</code> and <code class="literal">yarn</code> to cleanup project files and dependencies. To disable this phase, you can set <code class="literal">dontYarnInstall = true</code> or override the <code class="literal">installPhase</code>. Below is a list of additional <code class="literal">mkDerivation</code> arguments read by this hook:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">yarnKeepDevDeps</code>: Disables the removal of devDependencies from <code class="literal">node_modules</code> before installation.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-yarn2nix" class="title" >yarn2nix   </h5>  </div> </div></div><p>WARNING: The <code class="literal">yarn2nix</code> functions have been deprecated in favor of <code class="literal">yarnConfigHook</code>, <code class="literal">yarnBuildHook</code> and <code class="literal">yarnInstallHook</code> (for Yarn v1) and <code class="literal">yarn-berry_*.*</code> tooling (Yarn v3 and v4). Documentation for <code class="literal">yarn2nix</code> functions still appears here for the sake of the packages that still use them. See also a tracking issue <a class="link" href="https://github.com/NixOS/nixpkgs/issues/324246"  target="_top">#324246</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-yarn2nix-preparation" class="title" >Preparation   </h6>  </div> </div></div><p>You will need at least a <code class="literal">yarn.lock</code> file. If upstream does not have one you need to generate it and reference it in your package definition.</p><p>If the downloaded files contain the <code class="literal">package.json</code> and <code class="literal">yarn.lock</code> files they can be used like this:</p><pre><code class="programlisting nix">{
  offlineCache = fetchYarnDeps {
    yarnLock = src + &quot;/yarn.lock&quot;;
    hash = &quot;....&quot;;
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-yarn2nix-mkYarnPackage" class="title" >mkYarnPackage   </h6>  </div> </div></div><p><code class="literal">mkYarnPackage</code> will by default try to generate a binary. For package only generating static assets (Svelte, Vue, React, WebPack, …), you will need to explicitly override the build step with your instructions.</p><p>It’s important to use the <code class="literal">--offline</code> flag. For example if you script is <code class="literal">&quot;build&quot;: &quot;something&quot;</code> in <code class="literal">package.json</code> use:</p><pre><code class="programlisting nix">{
  nativeBuildInputs = [ writableTmpDirAsHomeHook ];

  buildPhase = &#x27;&#x27;
    runHook preBuild

    yarn --offline build

    runHook postBuild
  &#x27;&#x27;;
}
</code></pre><p>The <code class="literal">distPhase</code> is packing the package’s dependencies in a tarball using <code class="literal">yarn pack</code>. You can disable it using:</p><pre><code class="programlisting nix">{ doDist = false; }
</code></pre><p>The configure phase can sometimes fail because it makes many assumptions which may not always apply. One common override is:</p><pre><code class="programlisting nix">{
  configurePhase = &#x27;&#x27;
    runHook preConfigure

    ln -s $node_modules node_modules

    runHook postConfigure
  &#x27;&#x27;;
}
</code></pre><p>or if you need a writeable node_modules directory:</p><pre><code class="programlisting nix">{
  configurePhase = &#x27;&#x27;
    runHook preConfigure

    cp -r $node_modules node_modules
    chmod +w node_modules

    runHook postConfigure
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-yarn2nix-mkYarnModules" class="title" >mkYarnModules   </h6>  </div> </div></div><p>This will generate a derivation including the <code class="literal">node_modules</code> directory.
If you have to build a derivation for an integrated web framework (rails, phoenix…), this is probably the easiest way.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-mkYarnPackage-overriding-dependencies" class="title" >Overriding dependency behavior   </h5>  </div> </div></div><p>In the <code class="literal">mkYarnPackage</code> record the property <code class="literal">pkgConfig</code> can be used to override packages when you encounter problems building.</p><p>For instance, say your package is throwing errors when trying to invoke node-sass:</p><pre><code class="programlisting">ENOENT: no such file or directory, scandir &#x27;/build/source/node_modules/node-sass/vendor&#x27;
</code></pre><p>To fix this we will specify different versions of build inputs to use, as well as some post install steps to get the software built the way we want:</p><pre><code class="programlisting nix">mkYarnPackage rec {
  pkgConfig = {
    node-sass = {
      buildInputs = with final; [
        python
        libsass
        pkg-config
      ];
      postInstall = &#x27;&#x27;
        LIBSASS_EXT=auto yarn --offline run build
        rm build/config.gypi
      &#x27;&#x27;;
    };
  };
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-yarn2nix-pitfalls" class="title" >Pitfalls   </h6>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>If version is missing from upstream package.json, yarn will silently install nothing. In that case, you will need to override package.json as shown in the <a class="link" href="index.html#javascript-upstream-package-json" title="Try to use upstream package.json" >package.json section</a></p></li><li class="listitem"><p>Having trouble with <code class="literal">node-gyp</code>? Try adding these lines to the <code class="literal">yarnPreBuild</code> steps:</p><pre><code class="programlisting nix">{
  yarnPreBuild = &#x27;&#x27;
    mkdir -p $HOME/.node-gyp/${nodejs.version}
    echo 9 &gt; $HOME/.node-gyp/${nodejs.version}/installVersion
    ln -sfv ${nodejs}/include $HOME/.node-gyp/${nodejs.version}
    export npm_config_nodedir=${nodejs}
  &#x27;&#x27;;
}
</code></pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>The <code class="literal">echo 9</code> steps comes from this answer: <a class="link" href="https://stackoverflow.com/a/49139496"  target="_top">https://stackoverflow.com/a/49139496</a></p></li><li class="listitem"><p>Exporting the headers in <code class="literal">npm_config_nodedir</code> comes from this issue: <a class="link" href="https://github.com/nodejs/node-gyp/issues/1191#issuecomment-301243919"  target="_top">https://github.com/nodejs/node-gyp/issues/1191#issuecomment-301243919</a></p></li></ul></div></li><li class="listitem"><p><code class="literal">offlineCache</code> (described <a class="link" href="index.html#javascript-yarn2nix-preparation" title="Preparation" >above</a>) must be specified to avoid <a class="link" href="index.html#ssec-import-from-derivation" title="Import From Derivation" >Import From Derivation</a> (IFD) when used inside Nixpkgs.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-yarn-v3-v4" class="title" >Yarn Berry v3/v4   </h5>  </div> </div></div><p>Yarn Berry (v3 / v4) have similar formats, they start with blocks like these:</p><pre><code class="programlisting yaml">__metadata:
  version: 6
  cacheKey: 8[cX]
</code></pre><pre><code class="programlisting yaml">__metadata:
  version: 8
  cacheKey: 10[cX]
</code></pre><p>For these packages, we have some helpers exposed under the respective <code class="literal">yarn-berry_3</code> and <code class="literal">yarn-berry_4</code> packages:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">yarn-berry-fetcher</code></p></li><li class="listitem"><p><code class="literal">fetchYarnBerryDeps</code></p></li><li class="listitem"><p><code class="literal">yarnBerryConfigHook</code></p></li></ul></div><p>It’s recommended to ensure you’re explicitly pinning the major version used, for example by capturing the <code class="literal">yarn-berry_Xn</code> argument and then re-defining it as a <code class="literal">yarn-berry</code> <code class="literal">let</code> binding.</p><pre><code class="programlisting nix">{
  stdenv,
  nodejs,
  yarn-berry_4,
}:

let
  yarn-berry = yarn-berry_4;

in
stdenv.mkDerivation (finalAttrs: {
  pname = &quot;foo&quot;;
  version = &quot;0-unstable-1980-01-01&quot;;

  src = {
    #...
  };

  nativeBuildInputs = [
    nodejs
    yarn-berry.yarnBerryConfigHook
  ];

  offlineCache = yarn-berry.fetchYarnBerryDeps {
    inherit (finalAttrs) src;
    hash = &quot;...&quot;;
  };
})
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-fetchYarnBerryDeps" class="title" ><code class="literal">yarn-berry_X.fetchYarnBerryDeps</code>   </h6>  </div> </div></div><p><code class="literal">fetchYarnBerryDeps</code> runs <code class="literal">yarn-berry-fetcher fetch</code> in a fixed-output-derivation. It is a custom fetcher designed to reproducibly download all files in the <code class="literal">yarn.lock</code> file, validating their hashes in the process. For git dependencies, it creates a checkout at <code class="literal">${offlineCache}/checkouts/&lt;40-character-commit-hash&gt;</code> (relying on the git commit hash to describe the contents of the checkout).</p><p>To produce the <code class="literal">hash</code> argument for <code class="literal">fetchYarnBerryDeps</code> function call, the <code class="literal">yarn-berry-fetcher prefetch</code> command can be used:</p><pre><code class="programlisting console">$ yarn-berry-fetcher prefetch &lt;/path/to/yarn.lock&gt; [/path/to/missing-hashes.json]
</code></pre><p>This prints the hash to stdout and can be used in update scripts to recalculate the hash for a new version of <code class="literal">yarn.lock</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-yarnBerryConfigHook" class="title" ><code class="literal">yarn-berry_X.yarnBerryConfigHook</code>   </h6>  </div> </div></div><p><code class="literal">yarnBerryConfigHook</code> uses the store path <code class="literal">offlineCache</code> points to, to run a <code class="literal">yarn install</code> during the build, producing a usable <code class="literal">node_modules</code> directory from the downloaded dependencies.</p><p>Internally, this uses a patched version of Yarn to ensure git dependencies are re-packed and any attempted downloads fail immediately.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-yarnBerry-patching" class="title" >Patching upstream <code class="literal">package.json</code> or <code class="literal">yarn.lock</code> files   </h6>  </div> </div></div><p>In case patching the upstream <code class="literal">package.json</code> or <code class="literal">yarn.lock</code> is needed, it’s important to pass <code class="literal">finalAttrs.patches</code> to <code class="literal">fetchYarnBerryDeps</code> as well, so the patched variants are picked up (i.e. <code class="literal">inherit (finalAttrs) patches</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="javascript-yarnBerry-missing-hashes" class="title" >Missing hashes in the <code class="literal">yarn.lock</code> file   </h6>  </div> </div></div><p>Unfortunately, <code class="literal">yarn.lock</code> files do not include hashes for optional/platform-specific dependencies. This is <a class="link" href="https://github.com/yarnpkg/berry/issues/6759"  target="_top">by design</a>.</p><p>To compensate for this, the <code class="literal">yarn-berry-fetcher missing-hashes</code> subcommand can be used to produce all missing hashes. These are usually stored in a <code class="literal">missing-hashes.json</code> file, which needs to be passed to both the build itself, as well as the <code class="literal">fetchYarnBerryDeps</code> helper:</p><pre><code class="programlisting nix">{
  stdenv,
  nodejs,
  yarn-berry_4,
}:

let
  yarn-berry = yarn-berry_4;

in
stdenv.mkDerivation (finalAttrs: {
  pname = &quot;foo&quot;;
  version = &quot;0-unstable-1980-01-01&quot;;

  src = {
    #...
  };

  nativeBuildInputs = [
    nodejs
    yarn-berry.yarnBerryConfigHook
  ];

  missingHashes = ./missing-hashes.json;
  offlineCache = yarn-berry.fetchYarnBerryDeps {
    inherit (finalAttrs) src missingHashes;
    hash = &quot;...&quot;;
  };
})
</code></pre>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="javascript-outside-nixpkgs" class="title" >Outside Nixpkgs   </h3>  </div> </div></div><p>There are some other tools available, which are written in the Nix language.
These that can’t be used inside Nixpkgs because they require <a class="link" href="index.html#ssec-import-from-derivation" title="Import From Derivation" >Import From Derivation</a>, which is not allowed in Nixpkgs.</p><p>If you are packaging something outside Nixpkgs, consider the following:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-npmlock2nix" class="title" >npmlock2nix   </h4>  </div> </div></div><p><a class="link" href="https://github.com/nix-community/npmlock2nix"  target="_top">npmlock2nix</a> aims at building <code class="literal">node_modules</code> without code generation. It hasn’t reached v1 yet, the API might be subject to change.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-npmlock2nix-pitfalls" class="title" >Pitfalls   </h5>  </div> </div></div><p>There are some <a class="link" href="https://github.com/tweag/npmlock2nix/issues/45"  target="_top">problems with npm v7</a>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="javascript-nix-npm-buildpackage" class="title" >nix-npm-buildpackage   </h4>  </div> </div></div><p><a class="link" href="https://github.com/serokell/nix-npm-buildpackage"  target="_top">nix-npm-buildpackage</a> aims at building <code class="literal">node_modules</code> without code generation. It hasn’t reached v1 yet, the API might change. It supports both <code class="literal">package-lock.json</code> and yarn.lock.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="javascript-nix-npm-buildpackage-pitfalls" class="title" >Pitfalls   </h5>  </div> </div></div><p>There are some <a class="link" href="https://github.com/serokell/nix-npm-buildpackage/issues/33"  target="_top">problems with npm v7</a>.</p>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="language-julia" class="title" style="clear: both">Julia   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#julia-introduction">Introduction</a> </span></dt><dt> <span class="section">  <a href="index.html#julia-withpackage">julia.withPackages</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="julia-introduction" class="title" >Introduction   </h3>  </div> </div></div><p>Nixpkgs includes Julia as the <code class="literal">julia</code> derivation.
You can get specific versions by looking at the other <code class="literal">julia*</code> top-level derivations available.
For example, <code class="literal">julia_19</code> corresponds to Julia 1.9.
We also provide the current stable version as <code class="literal">julia-stable</code>, and an LTS version as <code class="literal">julia-lts</code>.</p><p>Occasionally, a Julia version has been too difficult to build from source in Nixpkgs and has been fetched prebuilt instead.
These Julia versions are differentiated with the <code class="literal">*-bin</code> suffix; for example, <code class="literal">julia-stable-bin</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="julia-withpackage" class="title" >julia.withPackages   </h3>  </div> </div></div><p>The basic Julia derivations only provide the built-in packages that come with the distribution.</p><p>You can build Julia environments with additional packages using the <code class="literal">julia.withPackages</code> command.
This function accepts a list of strings representing Julia package names.
For example, you can build a Julia environment with the <code class="literal">Plots</code> package as follows.</p><pre><code class="programlisting nix">julia.withPackages [ &quot;Plots&quot; ]
</code></pre><p>Arguments can be passed using <code class="literal">.override</code>.
For example:</p><pre><code class="programlisting nix">(julia.withPackages.override {
  precompile = false; # Turn off precompilation
})
  [ &quot;Plots&quot; ]
</code></pre><p>Here’s a nice way to run a Julia environment with a shell one-liner:</p><pre><code class="programlisting sh">nix-shell -p &#x27;julia.withPackages [&quot;Plots&quot;]&#x27; --run julia
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="julia-withpackage-arguments" class="title" >Arguments   </h4>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">precompile</code>: Whether to run <code class="literal">Pkg.precompile()</code> on the generated environment.</p><p>This will make package imports faster, but may fail in some cases.
For example, there is an upstream issue with <code class="literal">Gtk.jl</code> that prevents precompilation from working in the Nix build sandbox, because the precompiled code tries to access a display.
Packages like this will work fine if you build with <code class="literal">precompile=false</code>, and then precompile as needed once your environment starts.</p><p>Defaults: <code class="literal">true</code></p></li><li class="listitem"><p><code class="literal">extraLibs</code>: Extra library dependencies that will be placed on the <code class="literal">LD_LIBRARY_PATH</code> for Julia.</p><p>Should not be needed as we try to obtain library dependencies automatically using Julia’s artifacts system.</p></li><li class="listitem"><p><code class="literal">makeWrapperArgs</code>: Extra arguments to pass to the <code class="literal">makeWrapper</code> call which we use to wrap the Julia binary.</p></li><li class="listitem"><p><code class="literal">setDefaultDepot</code>: Whether to automatically prepend <code class="literal">$HOME/.julia</code> to the <code class="literal">JULIA_DEPOT_PATH</code>.</p><p>This is useful because Julia expects a writable depot path as the first entry, which the one we build in Nixpkgs is not.
If there’s no writable depot, then Julia will show a warning and be unable to save command history logs etc.</p><p>Default: <code class="literal">true</code></p></li><li class="listitem"><p><code class="literal">packageOverrides</code>: Allows you to override packages by name by passing an alternative source.</p><p>For example, you can use a custom version of the <code class="literal">LanguageServer</code> package by passing <code class="literal">packageOverrides = { &quot;LanguageServer&quot; = fetchFromGitHub {...}; }</code>.</p></li><li class="listitem"><p><code class="literal">augmentedRegistry</code>: Allows you to change the registry from which Julia packages are drawn.</p><p>This normally points at a special augmented version of the Julia <a class="link" href="https://github.com/JuliaRegistries/General"  target="_top">General packages registry</a>.
If you want to use a bleeding-edge version to pick up the latest package updates, you can plug in a later revision than the one in Nixpkgs.</p></li><li class="listitem"><p><code class="literal">juliaCpuTarget</code>: Allows you to set <code class="literal">JULIA_CPU_TARGET</code> when precompiling. Has no effect if <code class="literal">precompile=false</code>.</p><p>You may want to use this if you’re building a Julia depot that will end up in a Nix cache and used on machines with
different CPUs.</p><p>Why? Julia will detect the CPU microarchitecture of the build machine and include this information in the precompiled
<code class="literal">*.ji</code> files. Starting in 1.10 Julia became more strict about checking the CPU target compatibility, so it may reject
your precompiled files if they were compiled on a different machine.
A good option to provide wide compatibility is to set this to <code class="literal">&quot;generic&quot;</code>, although this may reduce performance.
You can also set a semicolon-separated list of multiple different targets. See the Julia documentation for details.</p></li></ul></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="lisp" class="title" style="clear: both">lisp-modules   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#lisp-overview">Overview</a> </span></dt><dt> <span class="section">  <a href="index.html#lisp-use-case-example">The 90% use case example</a> </span></dt><dt> <span class="section">  <a href="index.html#lisp-importing-packages-from-quicklisp">Importing packages from Quicklisp</a> </span></dt><dt> <span class="section">  <a href="index.html#lisp-defining-packages-inside">Defining packages manually inside Nixpkgs</a> </span></dt><dt> <span class="section">  <a href="index.html#lisp-defining-packages-outside">Defining packages manually outside Nixpkgs</a> </span></dt><dt> <span class="section">  <a href="index.html#lisp-overriding-package-attributes">Overriding package attributes</a> </span></dt><dt> <span class="section">  <a href="index.html#lisp-building-wrappers">Building Wrappers</a> </span></dt><dt> <span class="section">  <a href="index.html#lisp-adding-a-new-lisp">Adding a new Lisp</a> </span></dt> </dl></div><p>This document describes the Nixpkgs infrastructure for building Common Lisp
systems that use <a class="link" href="https://asdf.common-lisp.dev/"  target="_top">ASDF</a> (Another System
Definition Facility). It lives in <code class="literal">pkgs/development/lisp-modules</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lisp-overview" class="title" >Overview   </h3>  </div> </div></div><p>The main entry point of the API are the Common Lisp implementation packages
themselves (e.g. <code class="literal">abcl</code>, <code class="literal">ccl</code>, <code class="literal">clasp-common-lisp</code>, <code class="literal">clisp</code>, <code class="literal">ecl</code>,
<code class="literal">sbcl</code>). They have the <code class="literal">pkgs</code> and <code class="literal">withPackages</code> attributes, which can be used
to discover available packages and to build wrappers, respectively.</p><p>The <code class="literal">pkgs</code> attribute set contains packages that were automatically
<a class="link" href="index.html#lisp-importing-packages-from-quicklisp" title="Importing packages from Quicklisp" >imported</a> from Quicklisp, and any
other <a class="link" href="index.html#lisp-defining-packages-inside" title="Defining packages manually inside Nixpkgs" >manually defined</a> ones. Not every package
works for all the CL implementations (e.g. <code class="literal">nyxt</code> only makes sense for <code class="literal">sbcl</code>).</p><p>The <code class="literal">withPackages</code> function is of primary utility. It is used to build
<a class="link" href="index.html#lisp-building-wrappers" title="Building Wrappers" >runnable wrappers</a>, with a pinned and pre-built
<a class="link" href="index.html#lisp-loading-asdf" title="Loading ASDF" >ASDF FASL</a> available in the <code class="literal">ASDF</code> environment variable,
and <code class="literal">CL_SOURCE_REGISTRY</code>/<code class="literal">ASDF_OUTPUT_TRANSLATIONS</code> configured to
<a class="link" href="index.html#lisp-loading-systems" title="Loading systems" >find the desired systems on runtime</a>.</p><p>In addition, Lisps have the <code class="literal">withOverrides</code> function, which can be used to
<a class="link" href="index.html#lisp-including-external-pkg-in-scope" title="Including an external package in scope" >substitute</a> any package in the scope of
their <code class="literal">pkgs</code>. This will also be useful together with <code class="literal">overrideLispAttrs</code> when
<a class="link" href="index.html#lisp-dealing-with-slashy-systems" title="Dealing with slashy systems" >dealing with slashy systems</a>, because they
should stay in the main package and be built by specifying the <code class="literal">systems</code>
argument to <code class="literal">build-asdf-system</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lisp-use-case-example" class="title" >The 90% use case example   </h3>  </div> </div></div><p>The most common way to use the library is to run ad-hoc wrappers like this:</p><p><code class="literal">nix-shell -p &#x27;sbcl.withPackages (ps: with ps; [ alexandria ])&#x27;</code></p><p>Then, in a shell:</p><pre><code class="programlisting">$ sbcl
* (load (sb-ext:posix-getenv &quot;ASDF&quot;))
* (asdf:load-system &#x27;alexandria)
</code></pre><p>Also one can create a <code class="literal">pkgs.mkShell</code> environment in <code class="literal">shell.nix</code>/<code class="literal">flake.nix</code>:</p><pre><code class="programlisting nix">let
  sbcl&#x27; = sbcl.withPackages (ps: [ ps.alexandria ]);
in
mkShell { packages = [ sbcl&#x27; ]; }
</code></pre><p>Such a Lisp can be now used e.g. to compile your sources:</p><pre><code class="programlisting nix">{
  buildPhase = &#x27;&#x27;
    runHook preBuild

    ${sbcl&#x27;}/bin/sbcl --load my-build-file.lisp

    runHook postBuild
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lisp-importing-packages-from-quicklisp" class="title" >Importing packages from Quicklisp   </h3>  </div> </div></div><p>To save some work of writing Nix expressions, there is a script that imports all
the packages distributed by Quicklisp into <code class="literal">imported.nix</code>. This works by parsing
its <code class="literal">releases.txt</code> and <code class="literal">systems.txt</code> files, which are published every couple of
months on <a class="link" href="https://beta.quicklisp.org/dist/quicklisp.txt"  target="_top">quicklisp.org</a>.</p><p>The import process is implemented in the <code class="literal">import</code> directory as Common Lisp
code in the <code class="literal">org.lispbuilds.nix</code> ASDF system. To run the script, one can
execute <code class="literal">ql-import.lisp</code>:</p><pre><code class="programlisting">cd pkgs/development/lisp-modules
nix-shell --run &#x27;sbcl --script ql-import.lisp&#x27;
</code></pre><p>The script will:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Download the latest Quicklisp <code class="literal">systems.txt</code> and <code class="literal">releases.txt</code> files</p></li><li class="listitem"><p>Generate a temporary SQLite database of all QL systems in <code class="literal">packages.sqlite</code></p></li><li class="listitem"><p>Generate an <code class="literal">imported.nix</code> file from the database</p></li></ol></div><p>(The <code class="literal">packages.sqlite</code> file can be deleted at will, because it is regenerated
each time the script runs.)</p><p>The maintainer’s job is to:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Re-run the <code class="literal">ql-import.lisp</code> script when there is a new Quicklisp release</p></li><li class="listitem"><p><a class="link" href="index.html#lisp-quicklisp-adding-native-dependencies" title="Adding native dependencies" >Add any missing native dependencies</a> in <code class="literal">ql.nix</code></p></li><li class="listitem"><p>For packages that still don’t build, <a class="link" href="index.html#lisp-defining-packages-inside" title="Defining packages manually inside Nixpkgs" >package them manually</a> in <code class="literal">packages.nix</code></p></li></ol></div><p>Also, the <code class="literal">imported.nix</code> file <span class="strong"><strong>must not be edited manually</strong></span>! It should only be
generated as described in this section (by running <code class="literal">ql-import.lisp</code>).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="lisp-quicklisp-adding-native-dependencies" class="title" >Adding native dependencies   </h4>  </div> </div></div><p>The Quicklisp files contain ASDF dependency data, but don’t include native
library (CFFI) dependencies, and, in the case of ABCL, Java dependencies.</p><p>The <code class="literal">ql.nix</code> file contains a long list of overrides, where these dependencies
can be added.</p><p>Packages defined in <code class="literal">packages.nix</code> contain these dependencies naturally.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="lisp-quicklisp-trusting" class="title" >Trusting <code class="literal">systems.txt</code> and <code class="literal">releases.txt</code>   </h4>  </div> </div></div><p>The previous implementation of <code class="literal">lisp-modules</code> didn’t fully trust the Quicklisp
data, because there were times where the dependencies specified were not
complete and caused broken builds. It instead used a <code class="literal">nix-shell</code> environment to
discover real dependencies by using the ASDF APIs.</p><p>The current implementation has chosen to trust this data, because it’s faster to
parse a text file than to build each system to generate its Nix file, and
because that way packages can be mass-imported. Because of that, there may come
a day where some packages will break, due to bugs in Quicklisp. In that case,
the fix could be a manual override in <code class="literal">packages.nix</code> and <code class="literal">ql.nix</code>.</p><p>A known fact is that Quicklisp doesn’t include dependencies on slashy systems in
its data. This is an example of a situation where such fixes were used, e.g. to
replace the <code class="literal">systems</code> attribute of the affected packages. (See the definition of
<code class="literal">iolib</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="lisp-quicklisp-quirks" class="title" >Quirks   </h4>  </div> </div></div><p>During Quicklisp import:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">+</code> in names is converted to <code class="literal">_plus{_,}</code>: <code class="literal">cl+ssl</code>-&gt;<code class="literal">cl_plus_ssl</code>, <code class="literal">alexandria+</code>-&gt;<code class="literal">alexandria_plus</code></p></li><li class="listitem"><p><code class="literal">.</code> in names is converted to <code class="literal">_dot_</code>: <code class="literal">iolib.base</code>-&gt;<code class="literal">iolib_dot_base</code></p></li><li class="listitem"><p>names starting with a number have a <code class="literal">_</code> prepended (<code class="literal">3d-vectors</code>-&gt;<code class="literal">_3d-vectors</code>)</p></li><li class="listitem"><p><code class="literal">_</code> in names is converted to <code class="literal">__</code> for reversibility</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lisp-defining-packages-inside" class="title" >Defining packages manually inside Nixpkgs   </h3>  </div> </div></div><p>Packages that for some reason are not in Quicklisp, and so cannot be
auto-imported, or don’t work straight from the import, are defined in the
<code class="literal">packages.nix</code> file.</p><p>In that file, use the <code class="literal">build-asdf-system</code> function, which is a wrapper around
<code class="literal">mkDerivation</code> for building ASDF systems. Various other hacks are present, such
as <code class="literal">build-with-compile-into-pwd</code> for systems which create files during
compilation (such as cl-unicode).</p><p>The <code class="literal">build-asdf-system</code> function is documented
<a class="link" href="index.html#lisp-defining-packages-outside" title="Defining packages manually outside Nixpkgs" >here</a>. Also, <code class="literal">packages.nix</code> is full of
examples of how to use it.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lisp-defining-packages-outside" class="title" >Defining packages manually outside Nixpkgs   </h3>  </div> </div></div><p>Lisp derivations (<code class="literal">abcl</code>, <code class="literal">sbcl</code> etc.) also export the <code class="literal">buildASDFSystem</code>
function, which is similar to <code class="literal">build-asdf-system</code> from <code class="literal">packages.nix</code>, but is
part of the public API.</p><p>It takes the following arguments:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pname</code>: the package name</p></li><li class="listitem"><p><code class="literal">version</code>: the package version</p></li><li class="listitem"><p><code class="literal">src</code>: the package source</p></li><li class="listitem"><p><code class="literal">patches</code>: patches to apply to the source before build</p></li><li class="listitem"><p><code class="literal">nativeLibs</code>: native libraries used by CFFI and grovelling</p></li><li class="listitem"><p><code class="literal">javaLibs</code>: Java libraries for ABCL</p></li><li class="listitem"><p><code class="literal">lispLibs</code>: dependencies on other packages build with <code class="literal">buildASDFSystem</code></p></li><li class="listitem"><p><code class="literal">systems</code>: list of systems to build</p></li></ul></div><p>It can be used to define packages outside Nixpkgs, and, for example, add them
into the package scope with <code class="literal">withOverrides</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="lisp-including-external-pkg-in-scope" class="title" >Including an external package in scope   </h4>  </div> </div></div><p>A package defined outside Nixpkgs using <code class="literal">buildASDFSystem</code> can be woven into the
Nixpkgs-provided scope like this:</p><pre><code class="programlisting nix">let
  alexandria = sbcl.buildASDFSystem rec {
    pname = &quot;alexandria&quot;;
    version = &quot;1.4&quot;;
    src = fetchFromGitLab {
      domain = &quot;gitlab.common-lisp.net&quot;;
      owner = &quot;alexandria&quot;;
      repo = &quot;alexandria&quot;;
      tag = &quot;v${version}&quot;;
      hash = &quot;sha256-1Hzxt65dZvgOFIljjjlSGgKYkj+YBLwJCACi5DZsKmQ=&quot;;
    };
  };
  sbcl&#x27; = sbcl.withOverrides (self: super: { inherit alexandria; });
in
sbcl&#x27;.pkgs.alexandria
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lisp-overriding-package-attributes" class="title" >Overriding package attributes   </h3>  </div> </div></div><p>Packages export the <code class="literal">overrideLispAttrs</code> function, which can be used to build a
new package with different parameters.</p><p>Example of overriding <code class="literal">alexandria</code>:</p><pre><code class="programlisting nix">sbcl.pkgs.alexandria.overrideLispAttrs (oldAttrs: rec {
  version = &quot;1.4&quot;;
  src = fetchFromGitLab {
    domain = &quot;gitlab.common-lisp.net&quot;;
    owner = &quot;alexandria&quot;;
    repo = &quot;alexandria&quot;;
    tag = &quot;v${version}&quot;;
    hash = &quot;sha256-1Hzxt65dZvgOFIljjjlSGgKYkj+YBLwJCACi5DZsKmQ=&quot;;
  };
})
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="lisp-dealing-with-slashy-systems" class="title" >Dealing with slashy systems   </h4>  </div> </div></div><p>Slashy (secondary) systems should not exist in their own packages! Instead, they
should be included in the parent package as an extra entry in the <code class="literal">systems</code>
argument to the <code class="literal">build-asdf-system</code>/<code class="literal">buildASDFSystem</code> functions.</p><p>The reason is that ASDF searches for a secondary system in the <code class="literal">.asd</code> of the
parent package. Thus, having them separate would cause either one of them not to
load cleanly, because one will contains FASLs of itself but not the other, and
vice versa.</p><p>To package slashy systems, use <code class="literal">overrideLispAttrs</code>, like so:</p><pre><code class="programlisting nix">ecl.pkgs.alexandria.overrideLispAttrs (oldAttrs: {
  systems = oldAttrs.systems ++ [ &quot;alexandria/tests&quot; ];
  lispLibs = oldAttrs.lispLibs ++ [ ecl.pkgs.rt ];
})
</code></pre><p>See the <a class="link" href="index.html#lisp-including-external-pkg-in-scope" title="Including an external package in scope" >respective section</a> on using
<code class="literal">withOverrides</code> for how to weave it back into <code class="literal">ecl.pkgs</code>.</p><p>Note that sometimes the slashy systems might not only have more dependencies
than the main one, but create a circular dependency between <code class="literal">.asd</code>
files. Unfortunately, in this case an adhoc solution becomes necessary.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lisp-building-wrappers" class="title" >Building Wrappers   </h3>  </div> </div></div><p>Wrappers can be built using the <code class="literal">withPackages</code> function of Common Lisp
implementations (<code class="literal">abcl</code>, <code class="literal">ecl</code>, <code class="literal">sbcl</code> etc.):</p><pre><code class="programlisting">nix-shell -p &#x27;sbcl.withPackages (ps: [ ps.alexandria ps.bordeaux-threads ])&#x27;
</code></pre><p>Such a wrapper can then be used like this:</p><pre><code class="programlisting">$ sbcl
* (load (sb-ext:posix-getenv &quot;ASDF&quot;))
* (asdf:load-system &#x27;alexandria)
* (asdf:load-system &#x27;bordeaux-threads)
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="lisp-loading-asdf" class="title" >Loading ASDF   </h4>  </div> </div></div><p>For best results, avoid calling <code class="literal">(require &#x27;asdf)</code> When using the
library-generated wrappers.</p><p>Use <code class="literal">(load (ext:getenv &quot;ASDF&quot;))</code> instead, supplying your implementation’s way of
getting an environment variable for <code class="literal">ext:getenv</code>. This will load the
(pre-compiled to FASL) Nixpkgs-provided version of ASDF.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="lisp-loading-systems" class="title" >Loading systems   </h4>  </div> </div></div><p>There, you can use <code class="literal">asdf:load-system</code>. This works by setting the right
values for the <code class="literal">CL_SOURCE_REGISTRY</code>/<code class="literal">ASDF_OUTPUT_TRANSLATIONS</code> environment
variables, so that systems are found in the Nix store and pre-compiled FASLs are
loaded.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lisp-adding-a-new-lisp" class="title" >Adding a new Lisp   </h3>  </div> </div></div><p>The function <code class="literal">wrapLisp</code> is used to wrap Common Lisp implementations. It adds the
<code class="literal">pkgs</code>, <code class="literal">withPackages</code>, <code class="literal">withOverrides</code> and <code class="literal">buildASDFSystem</code> attributes to the
derivation.</p><p><code class="literal">wrapLisp</code> takes these arguments:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pkg</code>: the Lisp package</p></li><li class="listitem"><p><code class="literal">faslExt</code>: Implementation-specific extension for FASL files</p></li><li class="listitem"><p><code class="literal">program</code>: The name of executable file in <code class="literal">${pkg}/bin/</code> (Default: <code class="literal">pkg.pname</code>)</p></li><li class="listitem"><p><code class="literal">flags</code>: A list of flags to always pass to <code class="literal">program</code> (Default: <code class="literal">[]</code>)</p></li><li class="listitem"><p><code class="literal">asdf</code>: The ASDF version to use (Default: <code class="literal">pkgs.asdf_3_3</code>)</p></li><li class="listitem"><p><code class="literal">packageOverrides</code>: Package overrides config (Default: <code class="literal">(self: super: {})</code>)</p></li></ul></div><p>This example wraps CLISP:</p><pre><code class="programlisting nix">wrapLisp {
  pkg = clisp;
  faslExt = &quot;fas&quot;;
  flags = [
    &quot;-E&quot;
    &quot;UTF8&quot;
  ];
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="lua" class="title" style="clear: both">Lua   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#lua-userguide">Using Lua</a> </span></dt><dt> <span class="section">  <a href="index.html#lua-developing">Developing with lua</a> </span></dt><dt> <span class="section">  <a href="index.html#lua-reference">Lua Reference</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lua-userguide" class="title" >Using Lua   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="lua-overview" class="title" >Overview of Lua   </h4>  </div> </div></div><p>Several versions of the Lua interpreter are available: luajit, lua 5.1, 5.2, 5.3.
The attribute <code class="literal">lua</code> refers to the default interpreter, it is also possible to refer to specific versions, e.g. <code class="literal">lua5_2</code> refers to Lua 5.2.</p><p>Lua libraries are in separate sets, with one set per interpreter version.</p><p>The interpreters have several common attributes. One of these attributes is
<code class="literal">pkgs</code>, which is a package set of Lua libraries for this specific
interpreter. E.g., the <code class="literal">busted</code> package corresponding to the default interpreter
is <code class="literal">lua.pkgs.busted</code>, and the lua 5.2 version is <code class="literal">lua5_2.pkgs.busted</code>.
The main package set contains aliases to these package sets, e.g.
<code class="literal">luaPackages</code> refers to <code class="literal">lua5_1.pkgs</code> and <code class="literal">lua52Packages</code> to
<code class="literal">lua5_2.pkgs</code>.</p><p>Note that nixpkgs patches the non-luajit interpreters to avoid referring to
<code class="literal">/usr</code> and have <code class="literal">;;</code> (a <a class="link" href="https://www.lua.org/manual/5.1/manual.html#pdf-package.path"  target="_top">placeholder</a> replaced with the default LUA_PATH) work correctly.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="installing-lua-and-packages" class="title" >Installing Lua and packages   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="lua-environment-defined-in-separate-.nix-file" class="title" >Lua environment defined in separate <code class="literal">.nix</code> file   </h5>  </div> </div></div><p>Create a file, e.g. <code class="literal">build.nix</code>, with the following expression</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

lua5_2.withPackages (
  ps: with ps; [
    busted
    luafilesystem
  ]
)
</code></pre><p>and install it in your profile with</p><pre><code class="programlisting shell">nix-env -if build.nix
</code></pre><p>Now you can use the Lua interpreter, as well as the extra packages (<code class="literal">busted</code>,
<code class="literal">luafilesystem</code>) that you added to the environment.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="lua-environment-defined-in-.confignixpkgsconfig.nix" class="title" >Lua environment defined in <code class="literal">~/.config/nixpkgs/config.nix</code>   </h5>  </div> </div></div><p>If you prefer to, you could also add the environment as a package override to the Nixpkgs set, e.g.
using <code class="literal">config.nix</code>,</p><pre><code class="programlisting nix">{
  # ...

  packageOverrides =
    pkgs: with pkgs; {
      myLuaEnv = lua5_2.withPackages (
        ps: with ps; [
          busted
          luafilesystem
        ]
      );
    };
}
</code></pre><p>and install it in your profile with</p><pre><code class="programlisting shell">nix-env -iA nixpkgs.myLuaEnv
</code></pre><p>The environment is installed by referring to the attribute, and considering
the <code class="literal">nixpkgs</code> channel was used.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="lua-environment-defined-in-etcnixosconfiguration.nix" class="title" >Lua environment defined in <code class="literal">/etc/nixos/configuration.nix</code>   </h5>  </div> </div></div><p>For the sake of completeness, here’s another example how to install the environment system-wide.</p><pre><code class="programlisting nix">{
  # ...

  environment.systemPackages = with pkgs; [
    (lua.withPackages (
      ps: with ps; [
        busted
        luafilesystem
      ]
    ))
  ];
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="how-to-override-a-lua-package-using-overlays" class="title" >How to override a Lua package using overlays?   </h4>  </div> </div></div><p>Use the following overlay template:</p><pre><code class="programlisting nix">final: prev: {

  lua = prev.lua.override {
    packageOverrides = luaself: luaprev: {

      luarocks-nix = luaprev.luarocks-nix.overrideAttrs (oa: {
        pname = &quot;luarocks-nix&quot;;
        src = /home/my_luarocks/repository;
      });
    };
  };

  luaPackages = lua.pkgs;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="temporary-lua-environment-with-nix-shell" class="title" >Temporary Lua environment with <code class="literal">nix-shell</code>   </h4>  </div> </div></div><p>There are two methods for loading a shell with Lua packages. The first and recommended method
is to create an environment with <code class="literal">lua.buildEnv</code> or <code class="literal">lua.withPackages</code> and load that. E.g.</p><pre><code class="programlisting sh">$ nix-shell -p &#x27;lua.withPackages(ps: with ps; [ busted luafilesystem ])&#x27;
</code></pre><p>opens a shell from which you can launch the interpreter</p><pre><code class="programlisting sh">[nix-shell:~] lua
</code></pre><p>The other method, which is not recommended, does not create an environment and requires you to list the packages directly,</p><pre><code class="programlisting sh">$ nix-shell -p lua.pkgs.busted lua.pkgs.luafilesystem
</code></pre><p>Again, it is possible to launch the interpreter from the shell.
The Lua interpreter has the attribute <code class="literal">pkgs</code> which contains all Lua libraries for that specific interpreter.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lua-developing" class="title" >Developing with lua   </h3>  </div> </div></div><p>Now that you know how to get a working Lua environment with Nix, it is time
to go forward and start actually developing with Lua. There are two ways to
package lua software, either it is on luarocks and most of it can be taken care
of by the luarocks2nix converter or the packaging has to be done manually.
Let’s present the luarocks way first and the manual one in a second time.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="packaging-a-library-on-luarocks" class="title" >Packaging a library on luarocks   </h4>  </div> </div></div><p><a class="link" href="https://luarocks.org/"  target="_top">Luarocks.org</a> is the main repository of lua packages.
The site proposes two types of packages, the <code class="literal">rockspec</code> and the <code class="literal">src.rock</code>
(equivalent of a <a class="link" href="https://github.com/luarocks/luarocks/wiki/Rockspec-format"  target="_top">rockspec</a> but with the source).</p><p>Luarocks-based packages are generated in <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/pkgs/development/lua-modules/generated-packages.nix"  target="_top">pkgs/development/lua-modules/generated-packages.nix</a> from
the whitelist maintainers/scripts/luarocks-packages.csv and updated by running
the package <code class="literal">luarocks-packages-updater</code>:</p><pre><code class="programlisting sh">
nix-shell -p luarocks-packages-updater --run luarocks-packages-updater
</code></pre><p><a class="link" href="https://github.com/nix-community/luarocks"  target="_top">luarocks2nix</a> is a tool capable of generating nix derivations from both rockspec and src.rock (and favors the src.rock).
The automation only goes so far though and some packages need to be customized.
These customizations go in <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/pkgs/development/lua-modules/overrides.nix"  target="_top">pkgs/development/lua-modules/overrides.nix</a>.
For instance if the rockspec defines <code class="literal">external_dependencies</code>, these need to be manually added to the overrides.nix.</p><p>You can try converting luarocks packages to nix packages with the command <code class="literal">nix-shell -p luarocks-nix</code> and then <code class="literal">luarocks nix PKG_NAME</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="packaging-a-library-manually" class="title" >Packaging a library manually   </h5>  </div> </div></div><p>You can develop your package as you usually would, just don’t forget to wrap it
within a <code class="literal">toLuaModule</code> call, for instance</p><pre><code class="programlisting nix">{
  mynewlib = toLuaModule (
    stdenv.mkDerivation {
      # ...
    }
  );
}
</code></pre><p>There is also the <code class="literal">buildLuaPackage</code> function that can be used when lua modules
are not packaged for luarocks. You can see a few examples at <code class="literal">pkgs/top-level/lua-packages.nix</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lua-reference" class="title" >Lua Reference   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="lua-interpreters" class="title" >Lua interpreters   </h4>  </div> </div></div><p>Versions 5.1, 5.2, 5.3 and 5.4 of the lua interpreter are available as
respectively <code class="literal">lua5_1</code>, <code class="literal">lua5_2</code>, <code class="literal">lua5_3</code> and <code class="literal">lua5_4</code>. Luajit is available too.
The Nix expressions for the interpreters can be found in <code class="literal">pkgs/development/interpreters/lua-5</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="attributes-on-lua-interpreters-packages" class="title" >Attributes on lua interpreters packages   </h5>  </div> </div></div><p>Each interpreter has the following attributes:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">interpreter</code>. Alias for <code class="literal">${pkgs.lua}/bin/lua</code>.</p></li><li class="listitem"><p><code class="literal">buildEnv</code>. Function to build lua interpreter environments with extra packages bundled together. See section <span class="emphasis"><em>lua.buildEnv function</em></span> for usage and documentation.</p></li><li class="listitem"><p><code class="literal">withPackages</code>. Simpler interface to <code class="literal">buildEnv</code>.</p></li><li class="listitem"><p><code class="literal">pkgs</code>. Set of Lua packages for that specific interpreter. The package set can be modified by overriding the interpreter and passing <code class="literal">packageOverrides</code>.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="buildluarockspackage-function" class="title" ><code class="literal">buildLuarocksPackage</code> function   </h5>  </div> </div></div><p>The <code class="literal">buildLuarocksPackage</code> function is implemented in <code class="literal">pkgs/development/interpreters/lua-5/build-luarocks-package.nix</code>
The following is an example:</p><pre><code class="programlisting nix">{
  luaposix = buildLuarocksPackage {
    pname = &quot;luaposix&quot;;
    version = &quot;34.0.4-1&quot;;

    src = fetchurl {
      url = &quot;https://raw.githubusercontent.com/rocks-moonscript-org/moonrocks-mirror/master/luaposix-34.0.4-1.src.rock&quot;;
      hash = &quot;sha256-4mLJG8n4m6y4Fqd0meUDfsOb9RHSR0qa/KD5KCwrNXs=&quot;;
    };
    disabled = (luaOlder &quot;5.1&quot;) || (luaAtLeast &quot;5.4&quot;);
    propagatedBuildInputs = [
      bit32
      lua
      std_normalize
    ];

    meta = {
      homepage = &quot;https://github.com/luaposix/luaposix/&quot;;
      description = &quot;Lua bindings for POSIX&quot;;
      maintainers = with lib.maintainers; [
        vyp
        lblasc
      ];
      license.fullName = &quot;MIT/X11&quot;;
    };
  };
}
</code></pre><p>The <code class="literal">buildLuarocksPackage</code> delegates most tasks to luarocks:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>it adds <code class="literal">luarocks</code> as an unpacker for <code class="literal">src.rock</code> files (zip files really).</p></li><li class="listitem"><p><code class="literal">configurePhase</code> writes a temporary luarocks configuration file which location
is exported via the environment variable <code class="literal">LUAROCKS_CONFIG</code>.</p></li><li class="listitem"><p>the <code class="literal">buildPhase</code> does nothing.</p></li><li class="listitem"><p><code class="literal">installPhase</code> calls <code class="literal">luarocks make --deps-mode=none --tree $out</code> to build and
install the package</p></li><li class="listitem"><p>In the <code class="literal">postFixup</code> phase, the <code class="literal">wrapLuaPrograms</code> bash function is called to
wrap all programs in the <code class="literal">$out/bin/*</code> directory to include <code class="literal">$PATH</code>
environment variable and add dependent libraries to script’s <code class="literal">LUA_PATH</code> and
<code class="literal">LUA_CPATH</code>.</p></li></ul></div><p>It accepts as arguments:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>‘luarocksConfig’: a nix value that directly maps to the luarocks config used during
the installation</p></li></ul></div><p>By default <code class="literal">meta.platforms</code> is set to the same value as the interpreter unless overridden otherwise.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="buildluaapplication-function" class="title" ><code class="literal">buildLuaApplication</code> function   </h5>  </div> </div></div><p>The <code class="literal">buildLuaApplication</code> function is practically the same as <code class="literal">buildLuaPackage</code>.
The difference is that <code class="literal">buildLuaPackage</code> by default prefixes the names of the packages with the version of the interpreter.
Because with an application we’re not interested in multiple version the prefix is dropped.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="lua.withpackages-function" class="title" >lua.withPackages function   </h5>  </div> </div></div><p>The <code class="literal">lua.withPackages</code> takes a function as an argument that is passed the set of lua packages and returns the list of packages to be included in the environment.
Using the <code class="literal">withPackages</code> function, the previous example for the luafilesystem environment can be written like this:</p><pre><code class="programlisting nix">lua.withPackages (ps: [ ps.luafilesystem ])
</code></pre><p><code class="literal">withPackages</code> passes the correct package set for the specific interpreter version as an argument to the function. In the above example, <code class="literal">ps</code> equals <code class="literal">luaPackages</code>.
But you can also easily switch to using <code class="literal">lua5_1</code>:</p><pre><code class="programlisting nix">lua5_1.withPackages (ps: [ ps.lua ])
</code></pre><p>Now, <code class="literal">ps</code> is set to <code class="literal">lua5_1.pkgs</code>, matching the version of the interpreter.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="lua-contributing" class="title" >Lua Contributing guidelines   </h4>  </div> </div></div><p>Following rules should be respected:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Commit names of Lua libraries should reflect that they are Lua libraries, so write for example <code class="literal">luaPackages.luafilesystem: 1.11 -&gt; 1.12</code>.</p></li></ul></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="maven" class="title" style="clear: both">Maven   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#maven-buildmavenpackage">Building a package using <code class="literal">maven.buildMavenPackage</code></a> </span></dt><dt> <span class="section">  <a href="index.html#maven-mvn2nix">Manually using <code class="literal">mvn2nix</code></a> </span></dt> </dl></div><p>Maven is a well-known build tool for the Java ecosystem however it has some challenges when integrating into the Nix build system.</p><p>The following provides a list of common patterns with how to package a Maven project (or any JVM language that can export to Maven) as a Nix package.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="maven-buildmavenpackage" class="title" >Building a package using <code class="literal">maven.buildMavenPackage</code>   </h3>  </div> </div></div><p>Consider the following package:</p><pre><code class="programlisting nix">{
  lib,
  fetchFromGitHub,
  jre,
  makeWrapper,
  maven,
}:

maven.buildMavenPackage rec {
  pname = &quot;jd-cli&quot;;
  version = &quot;1.2.1&quot;;

  src = fetchFromGitHub {
    owner = &quot;intoolswetrust&quot;;
    repo = &quot;jd-cli&quot;;
    tag = &quot;jd-cli-${version}&quot;;
    hash = &quot;sha256-rRttA5H0A0c44loBzbKH7Waoted3IsOgxGCD2VM0U/Q=&quot;;
  };

  mvnHash = &quot;sha256-kLpjMj05uC94/5vGMwMlFzLKNFOKeyNvq/vmB6pHTAo=&quot;;

  nativeBuildInputs = [ makeWrapper ];

  installPhase = &#x27;&#x27;
    runHook preInstall

    mkdir -p $out/bin $out/share/jd-cli
    install -Dm644 jd-cli/target/jd-cli.jar $out/share/jd-cli

    makeWrapper ${jre}/bin/java $out/bin/jd-cli \
      --add-flags &quot;-jar $out/share/jd-cli/jd-cli.jar&quot;

    runHook postInstall
  &#x27;&#x27;;

  meta = {
    description = &quot;Simple command line wrapper around JD Core Java Decompiler project&quot;;
    homepage = &quot;https://github.com/intoolswetrust/jd-cli&quot;;
    license = lib.licenses.gpl3Plus;
    maintainers = with lib.maintainers; [ majiir ];
  };
}
</code></pre><p>This package calls <code class="literal">maven.buildMavenPackage</code> to do its work. The primary difference from <code class="literal">stdenv.mkDerivation</code> is the <code class="literal">mvnHash</code> variable, which is a hash of all of the Maven dependencies.</p><div class="tip"><h3 class="title">Tip</h3><p>After setting <code class="literal">maven.buildMavenPackage</code>, we then do standard Java <code class="literal">.jar</code> installation by saving the <code class="literal">.jar</code> to <code class="literal">$out/share/java</code> and then making a wrapper which allows executing that file; see <a class="xref" href="index.html#sec-language-java" title="Java" >the section called “Java”</a> for additional generic information about packaging Java applications.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="maven-overriding-package-attributes" class="title" >Overriding Maven package attributes   </h4>  </div> </div></div><pre><code class="programlisting">overrideMavenAttrs :: (AttrSet -&gt; Derivation) | ((AttrSet -&gt; Attrset) -&gt; Derivation) -&gt; Derivation
</code></pre><p>The output of <code class="literal">buildMavenPackage</code> has an <code class="literal">overrideMavenAttrs</code> attribute, which is a function that takes either</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>any subset of the attributes that can be passed to <code class="literal">buildMavenPackage</code></p><p>or</p></li><li class="listitem"><p>a function that takes the argument passed to the previous invocation of <code class="literal">buildMavenPackage</code> (conventionally called <code class="literal">old</code>) and returns an attribute set that can be passed to <code class="literal">buildMavenPackage</code></p></li></ul></div><p>and returns a derivation that builds a Maven package based on the old and new arguments merged.</p><p>This is similar to <a class="xref" href="index.html#sec-pkg-overrideAttrs" title="&lt;pkg&gt;.overrideAttrs" >the section called “&lt;pkg&gt;.overrideAttrs”</a>, but notably does not allow accessing the final value of the argument to <code class="literal">buildMavenPackage</code>.</p><div class="example"><span  ></span><details><summary><span class="title"><strong>Example 359. <code class="literal">overrideMavenAttrs</code> Example</strong></span></summary><div class="example-contents"><p>Use <code class="literal">overrideMavenAttrs</code> to build <code class="literal">jd-cli</code> version 1.2.0 and disable some flaky test:</p><pre><code class="programlisting nix">jd-cli.overrideMavenAttrs (old: rec {
  version = &quot;1.2.0&quot;;
  src = fetchFromGitHub {
    owner = old.src.owner;
    repo = old.src.repo;
    rev = &quot;${old.pname}-${version}&quot;;
    # old source hash of 1.2.0 version
    hash = &quot;sha256-US7j6tQ6mh1libeHnQdFxPGoxHzbZHqehWSgCYynKx8=&quot;;
  };

  # tests can be disabled by prefixing it with `!`
  # see Maven documentation for more details:
  # https://maven.apache.org/surefire/maven-surefire-plugin/examples/single-test.html#Multiple_Formats_in_One
  mvnParameters = lib.escapeShellArgs [
    &quot;-Dsurefire.failIfNoSpecifiedTests=false&quot;
    &quot;-Dtest=!JavaDecompilerTest#basicTest,!JavaDecompilerTest#patternMatchingTest&quot;
  ];

  # old mvnHash of 1.2.0 maven dependencies
  mvnHash = &quot;sha256-N9XC1pg6Y4sUiBWIQUf16QSXCuiAPpXEHGlgApviF4I=&quot;;
})
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="maven-offline-build" class="title" >Offline build   </h4>  </div> </div></div><p>By default, <code class="literal">buildMavenPackage</code> does the following:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Run <code class="literal">mvn package -Dmaven.repo.local=$out/.m2 ${mvnParameters}</code> in the
<code class="literal">fetchedMavenDeps</code> <a class="link" href="https://nixos.org/manual/nix/stable/glossary.html#gloss-fixed-output-derivation"  target="_top">fixed-output derivation</a>.</p></li><li class="listitem"><p>Run <code class="literal">mvn package -o -nsu &quot;-Dmaven.repo.local=$mvnDeps/.m2&quot; ${mvnParameters}</code> again in the main derivation.</p></li></ol></div><p>As a result, tests are run twice.
This also means that a failing test will trigger a new attempt to realise the fixed-output derivation, which in turn downloads all dependencies again.
For bigger Maven projects, this might lead to a long feedback cycle.</p><p>Use <code class="literal">buildOffline = true</code> to change the behaviour of `buildMavenPackage to the following:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Run <code class="literal">mvn de.qaware.maven:go-offline-maven-plugin:1.2.8:resolve-dependencies -Dmaven.repo.local=$out/.m2 ${mvnDepsParameters}</code> in the fixed-output derivation.</p></li><li class="listitem"><p>Run <code class="literal">mvn package -o -nsu &quot;-Dmaven.repo.local=$mvnDeps/.m2&quot; ${mvnParameters}</code> in the main derivation.</p></li></ol></div><p>As a result, all dependencies are downloaded in step 1 and the tests are executed in step 2.
A failing test only triggers a rebuild of step 2 as it can reuse the dependencies of step 1 because they have not changed.</p><div class="warning"><h3 class="title">Warning</h3><p>Test dependencies are not downloaded in step 1 and are therefore missing in
step 2 which will most probably fail the build. The <code class="literal">go-offline</code> plugin cannot
handle these so-called <a class="link" href="https://github.com/qaware/go-offline-maven-plugin?tab=readme-ov-file#dynamic-dependencies"  target="_top">dynamic dependencies</a>.
In that case you must add these dynamic dependencies manually with:</p><pre><code class="programlisting nix">maven.buildMavenPackage rec {
  manualMvnArtifacts = [
    # add dynamic test dependencies here
    &quot;org.apache.maven.surefire:surefire-junit-platform:3.1.2&quot;
    &quot;org.junit.platform:junit-platform-launcher:1.10.0&quot;
  ];
}
</code></pre></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="stable-maven-plugins" class="title" >Stable Maven plugins   </h4>  </div> </div></div><p>Maven defines default versions for its core plugins, e.g. <code class="literal">maven-compiler-plugin</code>. If your project does not override these versions, an upgrade of Maven will change the version of the used plugins, and therefore the derivation and hash.</p><p>When <code class="literal">maven</code> is upgraded, <code class="literal">mvnHash</code> for the derivation must be updated as well: otherwise, the project will be built on the derivation of old plugins, and fail because the requested plugins are missing.</p><p>This clearly prevents automatic upgrades of Maven: a manual effort must be made throughout nixpkgs by any maintainer wishing to push the upgrades.</p><p>To make sure that your package does not add extra manual effort when upgrading Maven, explicitly define versions for all plugins. You can check if this is the case by adding the following plugin to your (parent) POM:</p><pre><code class="programlisting xml">&lt;plugin&gt;
  &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
  &lt;artifactId&gt;maven-enforcer-plugin&lt;/artifactId&gt;
  &lt;version&gt;3.3.0&lt;/version&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;enforce-plugin-versions&lt;/id&gt;
      &lt;goals&gt;
        &lt;goal&gt;enforce&lt;/goal&gt;
      &lt;/goals&gt;
      &lt;configuration&gt;
        &lt;rules&gt;
          &lt;requirePluginVersions /&gt;
        &lt;/rules&gt;
      &lt;/configuration&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="maven-mvn2nix" class="title" >Manually using <code class="literal">mvn2nix</code>   </h3>  </div> </div></div><div class="warning"><h3 class="title">Warning</h3><p>This way is no longer recommended; see <a class="xref" href="index.html#maven-buildmavenpackage" title="Building a package using maven.buildMavenPackage" >the section called “Building a package using <code class="literal">maven.buildMavenPackage</code>”</a> for the simpler and preferred way.</p></div><p>For the purposes of this example let’s consider a very basic Maven project with the following <code class="literal">pom.xml</code> with a single dependency on <a class="link" href="https://github.com/vdurmont/emoji-java"  target="_top">emoji-java</a>.</p><pre><code class="programlisting xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
        xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;io.github.fzakaria&lt;/groupId&gt;
  &lt;artifactId&gt;maven-demo&lt;/artifactId&gt;
  &lt;version&gt;1.0&lt;/version&gt;
  &lt;packaging&gt;jar&lt;/packaging&gt;
  &lt;name&gt;NixOS Maven Demo&lt;/name&gt;

  &lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.vdurmont&lt;/groupId&gt;
        &lt;artifactId&gt;emoji-java&lt;/artifactId&gt;
        &lt;version&gt;5.1.1&lt;/version&gt;
      &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre><p>Our main class file will be very simple:</p><pre><code class="programlisting java">import com.vdurmont.emoji.EmojiParser;

public class Main {
  public static void main(String[] args) {
    String str = &quot;NixOS :grinning: is super cool :smiley:!&quot;;
    String result = EmojiParser.parseToUnicode(str);
    System.out.println(result);
  }
}
</code></pre><p>You find this demo project at <a class="link" href="https://github.com/fzakaria/nixos-maven-example"  target="_top">https://github.com/fzakaria/nixos-maven-example</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="solving-for-dependencies" class="title" >Solving for dependencies   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="buildmaven-with-nixosmvn2nix-maven-plugin" class="title" >buildMaven with NixOS/mvn2nix-maven-plugin   </h5>  </div> </div></div><p><code class="literal">buildMaven</code> is an alternative method that tries to follow similar patterns of other programming languages by generating a lock file. It relies on the maven plugin <a class="link" href="https://github.com/NixOS/mvn2nix-maven-plugin"  target="_top">mvn2nix-maven-plugin</a>.</p><p>First you generate a <code class="literal">project-info.json</code> file using the maven plugin.</p><div class="blockquote"><blockquote class="blockquote"><p>This should be executed in the project’s source repository or be told which <code class="literal">pom.xml</code> to execute with.</p></blockquote></div><pre><code class="programlisting bash"># run this step within the project&#x27;s source repository
❯ mvn org.nixos.mvn2nix:mvn2nix-maven-plugin:mvn2nix

❯ cat project-info.json | jq | head
{
  &quot;project&quot;: {
    &quot;artifactId&quot;: &quot;maven-demo&quot;,
    &quot;groupId&quot;: &quot;org.nixos&quot;,
    &quot;version&quot;: &quot;1.0&quot;,
    &quot;classifier&quot;: &quot;&quot;,
    &quot;extension&quot;: &quot;jar&quot;,
    &quot;dependencies&quot;: [
      {
        &quot;artifactId&quot;: &quot;maven-resources-plugin&quot;,
</code></pre><p>This file is then given to the <code class="literal">buildMaven</code> function, and it returns 2 attributes.</p><p><span class="strong"><strong><code class="literal">repo</code></strong></span>:
A Maven repository that is a symlink farm of all the dependencies found in the <code class="literal">project-info.json</code></p><p><span class="strong"><strong><code class="literal">build</code></strong></span>:
A simple derivation that runs through <code class="literal">mvn compile</code> &amp; <code class="literal">mvn package</code> to build the JAR. You may use this as inspiration for more complicated derivations.</p><p>Here is an <a class="link" href="https://github.com/fzakaria/nixos-maven-example/blob/main/build-maven-repository.nix"  target="_top">example</a> of building the Maven repository</p><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:
with pkgs;
(buildMaven ./project-info.json).repo
</code></pre><p>The benefit over the <span class="emphasis"><em>double invocation</em></span> as we will see below, is that the <span class="emphasis"><em>/nix/store</em></span> entry is a <span class="emphasis"><em>linkFarm</em></span> of every package, so that changes to your dependency set doesn’t involve downloading everything from scratch.</p><pre><code class="programlisting bash">❯ tree $(nix-build --no-out-link build-maven-repository.nix) | head
/nix/store/g87va52nkc8jzbmi1aqdcf2f109r4dvn-maven-repository
├── antlr
│   └── antlr
│       └── 2.7.2
│           ├── antlr-2.7.2.jar -&gt; /nix/store/d027c8f2cnmj5yrynpbq2s6wmc9cb559-antlr-2.7.2.jar
│           └── antlr-2.7.2.pom -&gt; /nix/store/mv42fc5gizl8h5g5vpywz1nfiynmzgp2-antlr-2.7.2.pom
├── avalon-framework
│   └── avalon-framework
│       └── 4.1.3
│           ├── avalon-framework-4.1.3.jar -&gt; /nix/store/iv5fp3955w3nq28ff9xfz86wvxbiw6n9-avalon-framework-4.1.3.jar
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="double-invocation" class="title" >Double Invocation   </h5>  </div> </div></div><div class="note"><h3 class="title">Note</h3><p>This pattern is the simplest but may cause unnecessary rebuilds due to the output hash changing.</p></div><p>The double invocation is a <span class="emphasis"><em>simple</em></span> way to get around the problem that <code class="literal">nix-build</code> may be sandboxed and have no Internet connectivity.</p><p>It treats the entire Maven repository as a single source to be downloaded, relying on Maven’s dependency resolution to satisfy the output hash. This is similar to fetchers like <code class="literal">fetchgit</code>, except it has to run a Maven build to determine what to download.</p><p>The first step will be to build the Maven project as a fixed-output derivation in order to collect the Maven repository – below is an <a class="link" href="https://github.com/fzakaria/nixos-maven-example/blob/main/double-invocation-repository.nix"  target="_top">example</a>.</p><div class="note"><h3 class="title">Note</h3><p>Traditionally the Maven repository is at <code class="literal">~/.m2/repository</code>. We will override this to be the <code class="literal">$out</code> directory.</p></div><pre><code class="programlisting nix">{
  lib,
  stdenv,
  maven,
}:
stdenv.mkDerivation {
  name = &quot;maven-repository&quot;;
  buildInputs = [ maven ];
  src = ./.; # or fetchFromGitHub, cleanSourceWith, etc
  buildPhase = &#x27;&#x27;
    runHook preBuild

    mvn package -Dmaven.repo.local=$out

    runHook postBuild
  &#x27;&#x27;;

  # keep only *.{pom,jar,sha1,nbm} and delete all ephemeral files with lastModified timestamps inside
  installPhase = &#x27;&#x27;
    runHook preInstall

    find $out -type f \
      -name \*.lastUpdated -or \
      -name resolver-status.properties -or \
      -name _remote.repositories \
      -delete

    runHook postInstall
  &#x27;&#x27;;

  # don&#x27;t do any fixup
  dontFixup = true;
  outputHashAlgo = null;
  outputHashMode = &quot;recursive&quot;;
  # replace this with the correct SHA256
  outputHash = lib.fakeHash;
}
</code></pre><p>The build will fail, and tell you the expected <code class="literal">outputHash</code> to place. When you’ve set the hash, the build will return with a <code class="literal">/nix/store</code> entry whose contents are the full Maven repository.</p><div class="warning"><h3 class="title">Warning</h3><p>Some additional files are deleted that would cause the output hash to change potentially on subsequent runs.</p></div><pre><code class="programlisting bash">❯ tree $(nix-build --no-out-link double-invocation-repository.nix) | head
/nix/store/8kicxzp98j68xyi9gl6jda67hp3c54fq-maven-repository
├── backport-util-concurrent
│   └── backport-util-concurrent
│       └── 3.1
│           ├── backport-util-concurrent-3.1.pom
│           └── backport-util-concurrent-3.1.pom.sha1
├── classworlds
│   └── classworlds
│       ├── 1.1
│       │   ├── classworlds-1.1.jar
</code></pre><p>If your package uses <span class="emphasis"><em>SNAPSHOT</em></span> dependencies or <span class="emphasis"><em>version ranges</em></span>; there is a strong likelihood that over-time your output hash will change since the resolved dependencies may change. Hence this method is less recommended then using <code class="literal">buildMaven</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="building-a-jar" class="title" >Building a JAR   </h4>  </div> </div></div><p>Regardless of which strategy is chosen above, the step to build the derivation is the same.</p><pre><code class="programlisting nix">{
  stdenv,
  maven,
  callPackage,
}:
let
  # pick a repository derivation, here we will use buildMaven
  repository = callPackage ./build-maven-repository.nix { };
in
stdenv.mkDerivation (finalAttrs: {
  pname = &quot;maven-demo&quot;;
  version = &quot;1.0&quot;;

  src = builtins.fetchTarball &quot;https://github.com/fzakaria/nixos-maven-example/archive/main.tar.gz&quot;;
  buildInputs = [ maven ];

  buildPhase = &#x27;&#x27;
    runHook preBuild

    echo &quot;Using repository ${repository}&quot;
    mvn --offline -Dmaven.repo.local=${repository} package;

    runHook postBuild
  &#x27;&#x27;;

  installPhase = &#x27;&#x27;
    runHook preInstall

    install -Dm644 target/${finalAttrs.pname}-${finalAttrs.version}.jar $out/share/java

    runHook postInstall
  &#x27;&#x27;;
})
</code></pre><div class="tip"><h3 class="title">Tip</h3><p>We place the library in <code class="literal">$out/share/java</code> since JDK package has a <span class="emphasis"><em>stdenv setup hook</em></span> that adds any JARs in the <code class="literal">share/java</code> directories of the build inputs to the CLASSPATH environment.</p></div><pre><code class="programlisting bash">❯ tree $(nix-build --no-out-link build-jar.nix)
/nix/store/7jw3xdfagkc2vw8wrsdv68qpsnrxgvky-maven-demo-1.0
└── share
    └── java
        └── maven-demo-1.0.jar

2 directories, 1 file
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="runnable-jar" class="title" >Runnable JAR   </h4>  </div> </div></div><p>The previous example builds a <code class="literal">jar</code> file but that’s not a file one can run.</p><p>You need to use it with <code class="literal">java -jar $out/share/java/output.jar</code> and make sure to provide the required dependencies on the classpath.</p><p>The following explains how to use <code class="literal">makeWrapper</code> in order to make the derivation produce an executable that will run the JAR file you created.</p><p>We will use the same repository we built above (either <span class="emphasis"><em>double invocation</em></span> or <span class="emphasis"><em>buildMaven</em></span>) to setup a CLASSPATH for our JAR.</p><p>The following two methods are more suited to Nix then building an <a class="link" href="https://imagej.net/Uber-JAR"  target="_top">UberJar</a> which may be the more traditional approach.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="classpath" class="title" >CLASSPATH   </h5>  </div> </div></div><p>This method is ideal if you are providing a derivation for <span class="emphasis"><em>nixpkgs</em></span> and don’t want to patch the project’s <code class="literal">pom.xml</code>.</p><p>We will read the Maven repository and flatten it to a single list. This list will then be concatenated with the <span class="emphasis"><em>CLASSPATH</em></span> separator to create the full classpath.</p><p>We make sure to provide this classpath to the <code class="literal">makeWrapper</code>.</p><pre><code class="programlisting nix">{
  stdenv,
  maven,
  callPackage,
  makeWrapper,
  jre,
}:
let
  repository = callPackage ./build-maven-repository.nix { };
in
stdenv.mkDerivation (finalAttrs: {
  pname = &quot;maven-demo&quot;;
  version = &quot;1.0&quot;;

  src = builtins.fetchTarball &quot;https://github.com/fzakaria/nixos-maven-example/archive/main.tar.gz&quot;;
  nativeBuildInputs = [ makeWrapper ];
  buildInputs = [ maven ];

  buildPhase = &#x27;&#x27;
    runHook preBuild

    echo &quot;Using repository ${repository}&quot;
    mvn --offline -Dmaven.repo.local=${repository} package;

    runHook postBuild
  &#x27;&#x27;;

  installPhase = &#x27;&#x27;
    runHook preInstall

    mkdir -p $out/bin

    classpath=$(find ${repository} -name &quot;*.jar&quot; -printf &#x27;:%h/%f&#x27;);
    install -Dm644 target/maven-demo-${finalAttrs.version}.jar $out/share/java
    # create a wrapper that will automatically set the classpath
    # this should be the paths from the dependency derivation
    makeWrapper ${jre}/bin/java $out/bin/maven-demo \
          --add-flags &quot;-classpath $out/share/java/maven-demo-${finalAttrs.version}.jar:&#x27;&#x27;${classpath#:}&quot; \
          --add-flags &quot;Main&quot;

    runHook postInstall
  &#x27;&#x27;;
})
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="manifest-file-via-maven-plugin" class="title" >MANIFEST file via Maven Plugin   </h5>  </div> </div></div><p>This method is ideal if you are the project owner and want to change your <code class="literal">pom.xml</code> to set the CLASSPATH within it.</p><p>Augment the <code class="literal">pom.xml</code> to create a JAR with the following manifest:</p><pre><code class="programlisting xml">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
        &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
        &lt;configuration&gt;
            &lt;archive&gt;
                &lt;manifest&gt;
                    &lt;addClasspath&gt;true&lt;/addClasspath&gt;
                    &lt;classpathPrefix&gt;../../repository/&lt;/classpathPrefix&gt;
                    &lt;classpathLayoutType&gt;repository&lt;/classpathLayoutType&gt;
                    &lt;mainClass&gt;Main&lt;/mainClass&gt;
                &lt;/manifest&gt;
                &lt;manifestEntries&gt;
                    &lt;Class-Path&gt;.&lt;/Class-Path&gt;
                &lt;/manifestEntries&gt;
            &lt;/archive&gt;
        &lt;/configuration&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;
</code></pre><p>The above plugin instructs the JAR to look for the necessary dependencies in the <code class="literal">lib/</code> relative folder. The layout of the folder is also in the <span class="emphasis"><em>maven repository</em></span> style.</p><pre><code class="programlisting bash">❯ unzip -q -c $(nix-build --no-out-link runnable-jar.nix)/share/java/maven-demo-1.0.jar META-INF/MANIFEST.MF

Manifest-Version: 1.0
Archiver-Version: Plexus Archiver
Built-By: nixbld
Class-Path: . ../../repository/com/vdurmont/emoji-java/5.1.1/emoji-jav
 a-5.1.1.jar ../../repository/org/json/json/20170516/json-20170516.jar
Created-By: Apache Maven 3.6.3
Build-Jdk: 1.8.0_265
Main-Class: Main
</code></pre><p>We will modify the derivation above to add a symlink to our repository so that it’s accessible to our JAR during the <code class="literal">installPhase</code>.</p><pre><code class="programlisting nix">{
  stdenv,
  maven,
  callPackage,
  makeWrapper,
  jre,
}:
let
  # pick a repository derivation, here we will use buildMaven
  repository = callPackage ./build-maven-repository.nix { };
in
stdenv.mkDerivation (finalAttrs: {
  pname = &quot;maven-demo&quot;;
  version = &quot;1.0&quot;;

  src = builtins.fetchTarball &quot;https://github.com/fzakaria/nixos-maven-example/archive/main.tar.gz&quot;;
  nativeBuildInputs = [ makeWrapper ];
  buildInputs = [ maven ];

  buildPhase = &#x27;&#x27;
    runHook preBuild

    echo &quot;Using repository ${repository}&quot;
    mvn --offline -Dmaven.repo.local=${repository} package;

    runHook postBuild
  &#x27;&#x27;;

  installPhase = &#x27;&#x27;
    runHook preInstall

    mkdir -p $out/bin

    # create a symbolic link for the repository directory
    ln -s ${repository} $out/repository

    install -Dm644 target/maven-demo-${finalAttrs.version}.jar $out/share/java
    # create a wrapper that will automatically set the classpath
    # this should be the paths from the dependency derivation
    makeWrapper ${jre}/bin/java $out/bin/maven-demo \
          --add-flags &quot;-jar $out/share/java/maven-demo-${finalAttrs.version}.jar&quot;

    runHook postInstall
  &#x27;&#x27;;
})
</code></pre><div class="note"><h3 class="title">Note</h3><p>Our script produces a dependency on <code class="literal">jre</code> rather than <code class="literal">jdk</code> to restrict the runtime closure necessary to run the application.</p></div><p>This will give you an executable shell-script that launches your JAR with all the dependencies available.</p><pre><code class="programlisting bash">❯ tree $(nix-build --no-out-link runnable-jar.nix)
/nix/store/8d4c3ibw8ynsn01ibhyqmc1zhzz75s26-maven-demo-1.0
├── bin
│   └── maven-demo
├── repository -&gt; /nix/store/g87va52nkc8jzbmi1aqdcf2f109r4dvn-maven-repository
└── share
    └── java
        └── maven-demo-1.0.jar

❯ $(nix-build --no-out-link --option tarball-ttl 1 runnable-jar.nix)/bin/maven-demo
NixOS 😀 is super cool 😃!
</code></pre>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-nim" class="title" style="clear: both">Nim   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#buildNimPackage">buildNimPackage</a> </span></dt><dt> <span class="section">  <a href="index.html#buildNimSbom">buildNimSbom</a> </span></dt><dt> <span class="section">  <a href="index.html#nim-overrides">Overriding Nim packages</a> </span></dt><dt> <span class="section">  <a href="index.html#nim-lock-overrides">Lockfile dependency overrides</a> </span></dt> </dl></div><p>The Nim compiler and a builder function is available.
Nim programs are built using a lockfile and either <code class="literal">buildNimPackage</code> or <code class="literal">buildNimSbom</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="buildNimPackage" class="title" >buildNimPackage   </h3>  </div> </div></div><p>The following example shows a Nim program that depends only on Nim libraries:</p><pre><code class="programlisting nix">{
  lib,
  buildNimPackage,
  fetchFromGitHub,
}:

buildNimPackage (finalAttrs: {
  pname = &quot;ttop&quot;;
  version = &quot;1.2.7&quot;;

  src = fetchFromGitHub {
    owner = &quot;inv2004&quot;;
    repo = &quot;ttop&quot;;
    rev = &quot;v${finalAttrs.version}&quot;;
    hash = lib.fakeHash;
  };

  lockFile = ./lock.json;

  nimFlags = [ &quot;-d:NimblePkgVersion=${finalAttrs.version}&quot; ];
})
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="buildnimpackage-parameters" class="title" ><code class="literal">buildNimPackage</code> parameters   </h4>  </div> </div></div><p>The <code class="literal">buildNimPackage</code> function takes an attrset of parameters that are passed on to <code class="literal">stdenv.mkDerivation</code>.</p><p>The following parameters are specific to <code class="literal">buildNimPackage</code>:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">lockFile</code>: JSON formatted lockfile.</p></li><li class="listitem"><p><code class="literal">nimbleFile</code>: Specify the Nimble file location of the package being built
rather than discover the file at build-time.</p></li><li class="listitem"><p><code class="literal">nimRelease ? true</code>: Build the package in <span class="emphasis"><em>release</em></span> mode.</p></li><li class="listitem"><p><code class="literal">nimDefines ? []</code>: A list of Nim defines. Key-value tuples are not supported.</p></li><li class="listitem"><p><code class="literal">nimFlags ? []</code>: A list of command line arguments to pass to the Nim compiler.
Use this to specify defines with arguments in the form of <code class="literal">-d:${name}=${value}</code>.</p></li><li class="listitem"><p><code class="literal">nimDoc</code> ? false`: Build and install HTML documentation.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="nim-lockfiles" class="title" >Lockfiles   </h4>  </div> </div></div><p>Nim lockfiles are created with the <code class="literal">nim_lk</code> utility.
Run <code class="literal">nim_lk</code> with the source directory as an argument and it will print a lockfile to stdout.</p><pre><code class="programlisting sh">$ cd nixpkgs
$ nix build -f . ttop.src
$ nix run -f . nim_lk ./result | jq --sort-keys &gt; pkgs/by-name/tt/ttop/lock.json
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="buildNimSbom" class="title" >buildNimSbom   </h3>  </div> </div></div><p>An alternative to <code class="literal">buildNimPackage</code> is <code class="literal">buildNimSbom</code> which builds packages from <a class="link" href="https://cyclonedx.org/"  target="_top">CycloneDX SBOM</a> files.
<code class="literal">buildNimSbom</code> resolves Nim dependencies to <a class="link" href="https://nixos.org/manual/nix/stable/glossary#gloss-fixed-output-derivation"  target="_top">fixed-output derivations</a> using the <a class="link" href="index.html#sec-interop.cylonedx-fod" title="nix:fod" >nix:fod namespace</a>.</p><p>In the following minimal example only the source code checkout and a <code class="literal">buildInput</code> are specified.
The SBOM file provides metadata such as <code class="literal">pname</code> and <code class="literal">version</code> as well as the sources to Nim dependencies.</p><pre><code class="programlisting nix"># pkgs/by-name/ni/nim_lk/package.nix
{
  lib,
  buildNimSbom,
  fetchFromSourcehut,
  openssl,
}:

buildNimSbom (finalAttrs: {
  src = fetchFromSourcehut {
    owner = &quot;~ehmry&quot;;
    repo = &quot;nim_lk&quot;;
    rev = finalAttrs.version;
    hash = lib.fakeHash;
  };
  buildInputs = [ openssl ];
}) ./sbom.json
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="generating-nim-sboms" class="title" >Generating SBOMs   </h4>  </div> </div></div><p>The <a class="link" href="https://git.sr.ht/~ehmry/nim_lk"  target="_top">nim_lk</a> utility can generate SBOMs from <a class="link" href="https://github.com/nim-lang/nimble"  target="_top">Nimble</a> package metadata.
See the <a class="link" href="https://git.sr.ht/~ehmry/nim_lk#nimble-to-cyclonedx-sbom"  target="_top">nim_lk documentation</a> for more information.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="nim-overrides" class="title" >Overriding Nim packages   </h3>  </div> </div></div><p>The <code class="literal">buildNimPackage</code> and <code class="literal">buildNimSbom</code> functions generate flags and additional build dependencies from the <code class="literal">lockFile</code> parameter passed to <code class="literal">buildNimPackage</code>. Using <a class="link" href="index.html#sec-pkg-overrideAttrs" title="&lt;pkg&gt;.overrideAttrs" ><code class="literal">overrideAttrs</code></a> on the final package will apply after this has already been generated, so this can’t be used to override the <code class="literal">lockFile</code> in a package built with <code class="literal">buildNimPackage</code>. To be able to override parameters before flags and build dependencies are generated from the <code class="literal">lockFile</code>, use <code class="literal">overrideNimAttrs</code> instead with the same syntax as <code class="literal">overrideAttrs</code>:</p><pre><code class="programlisting nix">pkgs.nitter.overrideNimAttrs {
  # using a different source which has different dependencies from the standard package
  src = pkgs.fetchFromGithub {
    # …
  };
  # new lock file generated from the source
  lockFile = ./custom-lock.json;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="nim-lock-overrides" class="title" >Lockfile dependency overrides   </h3>  </div> </div></div><p>The <code class="literal">buildNimPackage</code> function matches the libraries specified by <code class="literal">lockFile</code> to attrset of override functions that are then applied to the package derivation.
The default overrides are maintained as the top-level <code class="literal">nimOverrides</code> attrset at <code class="literal">pkgs/top-level/nim-overrides.nix</code>.</p><p>For example, to propagate a dependency on SDL2 for lockfiles that select the Nim <code class="literal">sdl2</code> library, an overlay is added to the set in the <code class="literal">nim-overrides.nix</code> file:</p><pre><code class="programlisting nix">{
  lib,
  # …
  SDL2,
# …
}:

{
  # …
  sdl2 =
    lockAttrs:
    {
      buildInputs ? [ ],
      ...
    }:
    {
      buildInputs = buildInputs ++ [ SDL2 ];
    };
  # …
}
</code></pre><p>The annotations in the <code class="literal">nim-overrides.nix</code> set are functions that take two arguments and return a new attrset to be overlaid on the package being built.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>lockAttrs: the attrset for this library from within a lockfile. This can be used to implement library version constraints, such as marking libraries as broken or insecure.</p></li><li class="listitem"><p>prevAttrs: the attrset produced by initial arguments to <code class="literal">buildNimPackage</code> and any preceding lockfile overlays.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="nim-lock-overrides-overrides" class="title" >Overriding an Nim library override   </h4>  </div> </div></div><p>The <code class="literal">nimOverrides</code> attrset makes it possible to modify overrides in a few different ways.</p><p>Override a package internal to its definition:</p><pre><code class="programlisting nix">{
  lib,
  buildNimPackage,
  nimOverrides,
  libressl,
}:

let
  buildNimPackage&#x27; = buildNimPackage.override {
    nimOverrides = nimOverrides.override { openssl = libressl; };
  };
in
buildNimPackage&#x27; (finalAttrs: {
  pname = &quot;foo&quot;;
  # …
})
</code></pre><p>Override a package externally:</p><pre><code class="programlisting nix">{ pkgs }:
{
  foo = pkgs.foo.override {
    buildNimPackage = pkgs.buildNimPackage.override {
      nimOverrides = pkgs.nimOverrides.override { openssl = libressl; };
    };
  };
}
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-ocaml" class="title" style="clear: both">OCaml   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-language-ocaml-user-guide">User guide</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-ocaml-packaging">Packaging guide</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-language-ocaml-user-guide" class="title" >User guide   </h3>  </div> </div></div><p>OCaml libraries are available in attribute sets of the form <code class="literal">ocaml-ng.ocamlPackages_X_XX</code> where X is to be replaced with the desired compiler version. For example, ocamlgraph compiled with OCaml 4.12 can be found in <code class="literal">ocaml-ng.ocamlPackages_4_12.ocamlgraph</code>. The compiler itself is also located in this set, under the name <code class="literal">ocaml</code>.</p><p>If you don’t care about the exact compiler version, <code class="literal">ocamlPackages</code> is a top-level alias pointing to a recent version of OCaml.</p><p>OCaml applications are usually available top-level, and not inside <code class="literal">ocamlPackages</code>. Notable exceptions are build tools that must be built with the same compiler version as the compiler you intend to use like <code class="literal">dune</code> or <code class="literal">ocaml-lsp</code>.</p><p>To open a shell able to build a typical OCaml project, put the dependencies in <code class="literal">buildInputs</code> and add <code class="literal">ocamlPackages.ocaml</code> and <code class="literal">ocamlPackages.findlib</code> to <code class="literal">nativeBuildInputs</code> at least.
For example:</p><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };
  # choose the ocaml version you want to use
  ocamlPackages = pkgs.ocaml-ng.ocamlPackages_4_12;
in
pkgs.mkShell {
  # build tools
  nativeBuildInputs = with ocamlPackages; [
    ocaml
    findlib
    dune_2
    ocaml-lsp
  ];
  # dependencies
  buildInputs = with ocamlPackages; [ ocamlgraph ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-language-ocaml-packaging" class="title" >Packaging guide   </h3>  </div> </div></div><p>OCaml libraries should be installed in <code class="literal">$(out)/lib/ocaml/${ocaml.version}/site-lib/</code>. Such directories are automatically added to the <code class="literal">$OCAMLPATH</code> environment variable when building another package that depends on them or when opening a <code class="literal">nix-shell</code>.</p><p>Given that most of the OCaml ecosystem is now built with dune, nixpkgs includes a convenience build support function called <code class="literal">buildDunePackage</code> that will build an OCaml package using dune, OCaml and findlib and any additional dependencies provided as <code class="literal">buildInputs</code> or <code class="literal">propagatedBuildInputs</code>.</p><p>Here is a simple package example.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>It defines an (optional) attribute <code class="literal">minimalOCamlVersion</code> (see note below)
that will be used to throw a descriptive evaluation error if building with
an older OCaml is attempted.</p></li><li class="listitem"><p>It uses the <code class="literal">fetchFromGitHub</code> fetcher to get its source.</p></li><li class="listitem"><p>It also accepts a <code class="literal">duneVersion</code> parameter (valid values are <code class="literal">&quot;1&quot;</code>, <code class="literal">&quot;2&quot;</code>, and
<code class="literal">&quot;3&quot;</code>). The recommended practice is to set it only if you don’t want the default
value and/or it depends on something else like package version. You might see
a not-supported argument <code class="literal">useDune2</code>. The behavior was <code class="literal">useDune2 = true;</code> =&gt;
<code class="literal">duneVersion = &quot;2&quot;;</code> and <code class="literal">useDune2 = false;</code> =&gt; <code class="literal">duneVersion = &quot;1&quot;;</code>. It was
used at the time when dune3 didn’t exist.</p></li><li class="listitem"><p>It sets the optional <code class="literal">doCheck</code> attribute such that tests will be run with
<code class="literal">dune runtest -p angstrom</code> after the build (<code class="literal">dune build -p angstrom</code>) is
complete, but only if the Ocaml version is at at least <code class="literal">&quot;4.05&quot;</code>.</p></li><li class="listitem"><p>It uses the package <code class="literal">ocaml-syntax-shims</code> as a build input, <code class="literal">alcotest</code> and
<code class="literal">ppx_let</code> as check inputs (because they are needed to run the tests), and
<code class="literal">bigstringaf</code> and <code class="literal">result</code> as propagated build inputs (thus they will also be
available to libraries depending on this library).</p></li><li class="listitem"><p>The library will be installed using the <code class="literal">angstrom.install</code> file that dune
generates.</p></li></ul></div><pre><code class="programlisting nix">{
  lib,
  fetchFromGitHub,
  buildDunePackage,
  ocaml,
  ocaml-syntax-shims,
  alcotest,
  result,
  bigstringaf,
  ppx_let,
}:

buildDunePackage rec {
  pname = &quot;angstrom&quot;;
  version = &quot;0.15.0&quot;;

  minimalOCamlVersion = &quot;4.04&quot;;

  src = fetchFromGitHub {
    owner = &quot;inhabitedtype&quot;;
    repo = &quot;angstrom&quot;;
    tag = version;
    hash = &quot;sha256-MK8o+iPGANEhrrTc1Kz9LBilx2bDPQt7Pp5P2libucI=&quot;;
  };

  checkInputs = [
    alcotest
    ppx_let
  ];
  buildInputs = [ ocaml-syntax-shims ];
  propagatedBuildInputs = [
    bigstringaf
    result
  ];
  doCheck = lib.versionAtLeast ocaml.version &quot;4.05&quot;;

  meta = {
    homepage = &quot;https://github.com/inhabitedtype/angstrom&quot;;
    description = &quot;OCaml parser combinators built for speed and memory efficiency&quot;;
    license = lib.licenses.bsd3;
    maintainers = with lib.maintainers; [ sternenseemann ];
  };
}
</code></pre><p>Here is a second example, this time using a source archive generated with <code class="literal">dune-release</code>. It is a good idea to use this archive when it is available as it will usually contain substituted variables such as a <code class="literal">%%VERSION%%</code> field. This library does not depend on any other OCaml library and no tests are run after building it.</p><pre><code class="programlisting nix">{
  lib,
  fetchurl,
  buildDunePackage,
}:

buildDunePackage rec {
  pname = &quot;wtf8&quot;;
  version = &quot;1.0.2&quot;;

  minimalOCamlVersion = &quot;4.02&quot;;

  src = fetchurl {
    url = &quot;https://github.com/flowtype/ocaml-wtf8/releases/download/v${version}/wtf8-v${version}.tbz&quot;;
    hash = &quot;sha256-d5/3KUBAWRj8tntr4RkJ74KWW7wvn/B/m1nx0npnzyc=&quot;;
  };

  meta = {
    homepage = &quot;https://github.com/flowtype/ocaml-wtf8&quot;;
    description = &quot;WTF-8 is a superset of UTF-8 that allows unpaired surrogates&quot;;
    license = lib.licenses.mit;
    maintainers = [ lib.maintainers.eqyiel ];
  };
}
</code></pre><p>The build will automatically fail if two distinct versions of the same library
are added to <code class="literal">buildInputs</code> (which usually happens transitively because of
<code class="literal">propagatedBuildInputs</code>). Set <code class="literal">dontDetectOcamlConflicts</code> to true to disable this
behavior.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-octave" class="title" style="clear: both">Octave   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-octave-introduction">Introduction</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-octave-structure">Structure</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-octave-packaging">Packaging Octave Packages</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-octave-introduction" class="title" >Introduction   </h3>  </div> </div></div><p>Octave is a modular scientific programming language and environment.
A majority of the packages supported by Octave from their <a class="link" href="https://gnu-octave.github.io/packages/"  target="_top">website</a> are packaged in nixpkgs.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-octave-structure" class="title" >Structure   </h3>  </div> </div></div><p>All Octave add-on packages are available in two ways:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Under the top-level <code class="literal">Octave</code> attribute, <code class="literal">octave.pkgs</code>.</p></li><li class="listitem"><p>As a top-level attribute, <code class="literal">octavePackages</code>.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-octave-packaging" class="title" >Packaging Octave Packages   </h3>  </div> </div></div><p>Nixpkgs provides a function <code class="literal">buildOctavePackage</code>, a generic package builder function for any Octave package that complies with the Octave’s current packaging format.</p><p>All Octave packages are defined in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/octave-packages.nix"  target="_top">pkgs/top-level/octave-packages.nix</a> rather than <code class="literal">pkgs/all-packages.nix</code>.
Each package is defined in their own file in the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/octave-modules"  target="_top">pkgs/development/octave-modules</a> directory.
Octave packages are made available through <code class="literal">all-packages.nix</code> through both the attribute <code class="literal">octavePackages</code> and <code class="literal">octave.pkgs</code>.
You can test building an Octave package as follows:</p><pre><code class="programlisting ShellSession">$ nix-build -A octavePackages.symbolic
</code></pre><p>To install it into your user profile, run this command from the root of the repository:</p><pre><code class="programlisting ShellSession">$ nix-env -f. -iA octavePackages.symbolic
</code></pre><p>You can build Octave with packages by using the <code class="literal">withPackages</code> passed-through function.</p><pre><code class="programlisting ShellSession">$ nix-shell -p &#x27;octave.withPackages (ps: with ps; [ symbolic ])&#x27;
</code></pre><p>This will also work in a <code class="literal">shell.nix</code> file.</p><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:

pkgs.mkShell {
  nativeBuildInputs = with pkgs; [ (octave.withPackages (opkgs: with opkgs; [ symbolic ])) ];
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sssec-buildOctavePackage-steps" class="title" ><code class="literal">buildOctavePackage</code> Steps   </h4>  </div> </div></div><p>The <code class="literal">buildOctavePackage</code> does several things to make sure things work properly.</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Sets the environment variable <code class="literal">OCTAVE_HISTFILE</code> to <code class="literal">/dev/null</code> during package compilation so that the commands run through the Octave interpreter directly are not logged.</p></li><li class="listitem"><p>Skips the configuration step, because the packages are stored as gzipped tarballs, which Octave itself handles directly.</p></li><li class="listitem"><p>Change the hierarchy of the tarball so that only a single directory is at the top-most level of the tarball.</p></li><li class="listitem"><p>Use Octave itself to run the <code class="literal">pkg build</code> command, which unzips the tarball, extracts the necessary files written in Octave, and compiles any code written in C++ or Fortran, and places the fully compiled artifact in <code class="literal">$out</code>.</p></li></ol></div><p><code class="literal">buildOctavePackage</code> is built on top of <code class="literal">stdenv</code> in a standard way, allowing most things to be customized.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sssec-octave-handling-dependencies" class="title" >Handling Dependencies   </h4>  </div> </div></div><p>In Octave packages, there are four sets of dependencies that can be specified:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">nativeBuildInputs</code></span></dt><dd><p>Just like other packages, <code class="literal">nativeBuildInputs</code> is intended for architecture-dependent build-time-only dependencies.</p></dd><dt><span class="term"><code class="literal">buildInputs</code></span></dt><dd><p>Like other packages, <code class="literal">buildInputs</code> is intended for architecture-independent build-time-only dependencies.</p></dd><dt><span class="term"><code class="literal">propagatedBuildInputs</code></span></dt><dd><p>Similar to other packages, <code class="literal">propagatedBuildInputs</code> is intended for packages that are required for both building and running of the package.
See <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/octave-modules/symbolic/default.nix"  target="_top">Symbolic</a> for how this works and why it is needed.</p></dd><dt><span class="term"><code class="literal">requiredOctavePackages</code></span></dt><dd><p>This is a special dependency that ensures the specified Octave packages are dependent on others, and are made available simultaneously when loading them in Octave.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sssec-installing-octave-packages" class="title" >Installing Octave Packages   </h4>  </div> </div></div><p>By default, the <code class="literal">buildOctavePackage</code> function does <span class="emphasis"><em>not</em></span> install the requested package into Octave for use.
The function will only build the requested package.
This is due to Octave maintaining an text-based database about which packages are installed where.
To this end, when all the requested packages have been built, the Octave package and all its add-on packages are put together into an environment, similar to Python.</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>First, all the Octave binaries are wrapped with the environment variable <code class="literal">OCTAVE_SITE_INITFILE</code> set to a file in <code class="literal">$out</code>, which is required for Octave to be able to find the non-standard package database location.</p></li><li class="listitem"><p>Because of the way <code class="literal">buildEnv</code> works, all tarballs that are present (which should be all Octave packages to install) should be removed.</p></li><li class="listitem"><p>The path down to the default install location of Octave packages is recreated so that Nix-operated Octave can install the packages.</p></li><li class="listitem"><p>Install the packages into the <code class="literal">$out</code> environment while writing package entries to the database file.
This database file is unique for each different (according to Nix) environment invocation.</p></li><li class="listitem"><p>Rewrite the Octave-wide startup file to read from the list of packages installed in that particular environment.</p></li><li class="listitem"><p>Wrap any programs that are required by the Octave packages so that they work with all the paths defined within the environment.</p></li></ol></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-perl" class="title" style="clear: both">Perl   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-perl-running">Running Perl programs on the shell</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-perl-packaging">Packaging Perl programs</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-perl-running" class="title" >Running Perl programs on the shell   </h3>  </div> </div></div><p>When executing a Perl script, it is possible you get an error such as <code class="literal">./myscript.pl: bad interpreter: /usr/bin/perl: no such file or directory</code>. This happens when the script expects Perl to be installed at <code class="literal">/usr/bin/perl</code>, which is not the case when using Perl from nixpkgs. You can fix the script by changing the first line to:</p><pre><code class="programlisting perl">#!/usr/bin/env perl
</code></pre><p>to take the Perl installation from the <code class="literal">PATH</code> environment variable, or invoke Perl directly with:</p><pre><code class="programlisting ShellSession">$ perl ./myscript.pl
</code></pre><p>When the script is using a Perl library that is not installed globally, you might get an error such as <code class="literal">Can&#x27;t locate DB_File.pm in @INC (you may need to install the DB_File module)</code>. In that case, you can use <code class="literal">nix-shell</code> to start an ad-hoc shell with that library installed, for instance:</p><pre><code class="programlisting ShellSession">$ nix-shell -p perl perlPackages.DBFile --run ./myscript.pl
</code></pre><p>If you are always using the script in places where <code class="literal">nix-shell</code> is available, you can embed the <code class="literal">nix-shell</code> invocation in the shebang like this:</p><pre><code class="programlisting perl">#!/usr/bin/env nix-shell
#! nix-shell -i perl -p perl perlPackages.DBFile
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-perl-packaging" class="title" >Packaging Perl programs   </h3>  </div> </div></div><p>Nixpkgs provides a function <code class="literal">buildPerlPackage</code>, a generic package builder function for any Perl package that has a standard <code class="literal">Makefile.PL</code>. It’s implemented in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/perl-modules/generic"  target="_top">pkgs/development/perl-modules/generic</a>.</p><p>Perl packages from CPAN are defined in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/perl-packages.nix"  target="_top">pkgs/top-level/perl-packages.nix</a> rather than <code class="literal">pkgs/all-packages.nix</code>. Most Perl packages are so straight-forward to build that they are defined here directly, rather than having a separate function for each package called from <code class="literal">perl-packages.nix</code>. However, more complicated packages should be put in a separate file, typically in <code class="literal">pkgs/development/perl-modules</code>. Here is an example of the former:</p><pre><code class="programlisting nix">{
  ClassC3 = buildPerlPackage rec {
    pname = &quot;Class-C3&quot;;
    version = &quot;0.21&quot;;
    src = fetchurl {
      url = &quot;mirror://cpan/authors/id/F/FL/FLORA/Class-C3-${version}.tar.gz&quot;;
      hash = &quot;sha256-/5GE5xHT0uYGOQxroqj6LMU7CtKn2s6vMVoSXxL4iK4=&quot;;
    };
  };
}
</code></pre><p>Note the use of <code class="literal">mirror://cpan/</code>, and the <code class="literal">pname</code> and <code class="literal">version</code> in the URL definition to ensure that the <code class="literal">pname</code> attribute is consistent with the source that we’re actually downloading. Perl packages are made available in <code class="literal">all-packages.nix</code> through the variable <code class="literal">perlPackages</code>. For instance, if you have a package that needs <code class="literal">ClassC3</code>, you would typically write</p><pre><code class="programlisting nix">{
  foo = import ../path/to/foo.nix {
    inherit
      stdenv
      fetchurl # ...
      ;
    inherit (perlPackages) ClassC3;
  };
}
</code></pre><p>in <code class="literal">all-packages.nix</code>. You can test building a Perl package as follows:</p><pre><code class="programlisting ShellSession">$ nix-build -A perlPackages.ClassC3
</code></pre><p>To install it with <code class="literal">nix-env</code> instead: <code class="literal">nix-env -f. -iA perlPackages.ClassC3</code>.</p><p>So what does <code class="literal">buildPerlPackage</code> do? It does the following:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>In the configure phase, it calls <code class="literal">perl Makefile.PL</code> to generate a Makefile. You can set the variable <code class="literal">makeMakerFlags</code> to pass flags to <code class="literal">Makefile.PL</code></p></li><li class="listitem"><p>It adds the contents of the <code class="literal">PERL5LIB</code> environment variable to <code class="literal">#! .../bin/perl</code> line of Perl scripts as <code class="literal">-Idir</code> flags. This ensures that a script can find its dependencies. (This can cause this shebang line to become too long for Darwin to handle; see the note below.)</p></li><li class="listitem"><p>In the fixup phase, it writes the propagated build inputs (<code class="literal">propagatedBuildInputs</code>) to the file <code class="literal">$out/nix-support/propagated-user-env-packages</code>. <code class="literal">nix-env</code> recursively installs all packages listed in this file when you install a package that has it. This ensures that a Perl package can find its dependencies.</p></li></ol></div><p><code class="literal">buildPerlPackage</code> is built on top of <code class="literal">stdenv</code>, so everything can be customised in the usual way. For instance, the <code class="literal">BerkeleyDB</code> module has a <code class="literal">preConfigure</code> hook to generate a configuration file used by <code class="literal">Makefile.PL</code>:</p><pre><code class="programlisting nix">{
  buildPerlPackage,
  fetchurl,
  db,
}:

buildPerlPackage rec {
  pname = &quot;BerkeleyDB&quot;;
  version = &quot;0.36&quot;;

  src = fetchurl {
    url = &quot;mirror://cpan/authors/id/P/PM/PMQS/BerkeleyDB-${version}.tar.gz&quot;;
    hash = &quot;sha256-4Y+HGgGQqcOfdiKcFIyMrWBEccVNVAMDBWZlFTMorh8=&quot;;
  };

  preConfigure = &#x27;&#x27;
    echo &quot;LIB = ${db.out}/lib&quot; &gt; config.in
    echo &quot;INCLUDE = ${db.dev}/include&quot; &gt;&gt; config.in
  &#x27;&#x27;;
}
</code></pre><p>Dependencies on other Perl packages can be specified in the <code class="literal">buildInputs</code> and <code class="literal">propagatedBuildInputs</code> attributes. If something is exclusively a build-time dependency, use <code class="literal">buildInputs</code>; if it’s (also) a runtime dependency, use <code class="literal">propagatedBuildInputs</code>. For instance, this builds a Perl module that has runtime dependencies on a bunch of other modules:</p><pre><code class="programlisting nix">{
  ClassC3Componentised = buildPerlPackage rec {
    pname = &quot;Class-C3-Componentised&quot;;
    version = &quot;1.0004&quot;;
    src = fetchurl {
      url = &quot;mirror://cpan/authors/id/A/AS/ASH/Class-C3-Componentised-${version}.tar.gz&quot;;
      hash = &quot;sha256-ASO9rV/FzJYZ0BH572Fxm2ZrFLMZLFATJng1NuU4FHc=&quot;;
    };
    propagatedBuildInputs = [
      ClassC3
      ClassInspector
      TestException
      MROCompat
    ];
  };
}
</code></pre><p>On Darwin, if a script has too many <code class="literal">-Idir</code> flags in its first line (its “shebang line”), it will not run. This can be worked around by calling the <code class="literal">shortenPerlShebang</code> function from the <code class="literal">postInstall</code> phase:</p><pre><code class="programlisting nix">{
  lib,
  stdenv,
  buildPerlPackage,
  fetchurl,
  shortenPerlShebang,
}:

{
  ImageExifTool = buildPerlPackage {
    pname = &quot;Image-ExifTool&quot;;
    version = &quot;12.50&quot;;

    src = fetchurl {
      url = &quot;https://exiftool.org/Image-ExifTool-${version}.tar.gz&quot;;
      hash = &quot;sha256-vOhB/FwQMC8PPvdnjDvxRpU6jAZcC6GMQfc0AH4uwKg=&quot;;
    };

    nativeBuildInputs = lib.optional stdenv.hostPlatform.isDarwin shortenPerlShebang;
    postInstall = lib.optionalString stdenv.hostPlatform.isDarwin &#x27;&#x27;
      shortenPerlShebang $out/bin/exiftool
    &#x27;&#x27;;
  };
}
</code></pre><p>This will remove the <code class="literal">-I</code> flags from the shebang line, rewrite them in the <code class="literal">use lib</code> form, and put them on the next line instead. This function can be given any number of Perl scripts as arguments; it will modify them in-place.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-generation-from-CPAN" class="title" >Generation from CPAN   </h4>  </div> </div></div><p>Nix expressions for Perl packages can be generated (almost) automatically from CPAN. This is done by the program <code class="literal">nix-generate-from-cpan</code>, which can be installed as follows:</p><pre><code class="programlisting ShellSession">$ nix-env -f &quot;&lt;nixpkgs&gt;&quot; -iA nix-generate-from-cpan
</code></pre><p>Substitute <code class="literal">&lt;nixpkgs&gt;</code> by the path of a nixpkgs clone to use the latest version.</p><p>This program takes a Perl module name, looks it up on CPAN, fetches and unpacks the corresponding package, and prints a Nix expression on standard output. For example:</p><pre><code class="programlisting ShellSession">$ nix-generate-from-cpan XML::Simple
  XMLSimple = buildPerlPackage rec {
    pname = &quot;XML-Simple&quot;;
    version = &quot;2.22&quot;;
    src = fetchurl {
      url = &quot;mirror://cpan/authors/id/G/GR/GRANTM/XML-Simple-2.22.tar.gz&quot;;
      hash = &quot;sha256-uUUO8i6pZErl1q2ghtxDAPoQW+BQogMOvU79KMGY60k=&quot;;
    };
    propagatedBuildInputs = [ XMLNamespaceSupport XMLSAX XMLSAXExpat ];
    meta = {
      description = &quot;API for simple XML files&quot;;
      license = with lib.licenses; [ artistic1 gpl1Plus ];
    };
  };
</code></pre><p>The output can be pasted into <code class="literal">pkgs/top-level/perl-packages.nix</code> or wherever else you need it.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-perl-cross-compilation" class="title" >Cross-compiling modules   </h4>  </div> </div></div><p>Nixpkgs has experimental support for cross-compiling Perl modules. In many cases, it will just work out of the box, even for modules with native extensions. Sometimes, however, the Makefile.PL for a module may (indirectly) import a native module. In that case, you will need to make a stub for that module that will satisfy the Makefile.PL and install it into <code class="literal">lib/perl5/site_perl/cross_perl/${perl.version}</code>. See the <code class="literal">postInstall</code> for <code class="literal">DBI</code> for an example.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-php" class="title" style="clear: both">PHP   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-php-user-guide">User Guide</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-php-user-guide" class="title" >User Guide   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-php-user-guide-overview" class="title" >Overview   </h4>  </div> </div></div><p>Several versions of PHP are available on Nix, each of which having a
wide variety of extensions and libraries available.</p><p>The different versions of PHP that nixpkgs provides are located under
attributes named based on major and minor version number; e.g.,
<code class="literal">php81</code> is PHP 8.1.</p><p>Only versions of PHP that are supported by upstream for the entirety
of a given NixOS release will be included in that release of
NixOS. See <a class="link" href="https://www.php.net/supported-versions.php"  target="_top">PHP Supported
Versions</a>.</p><p>The attribute <code class="literal">php</code> refers to the version of PHP considered most
stable and thoroughly tested in nixpkgs for any given release of
NixOS - not necessarily the latest major release from upstream.</p><p>All available PHP attributes are wrappers around their respective
binary PHP package and provide commonly used extensions this way. The
real PHP 8.1 package, i.e. the unwrapped one, is available as
<code class="literal">php81.unwrapped</code>; see the next section for more details.</p><p>Interactive tools built on PHP are put in <code class="literal">php.packages</code>; composer is
for example available at <code class="literal">php.packages.composer</code>.</p><p>Most extensions that come with PHP, as well as some popular
third-party ones, are available in <code class="literal">php.extensions</code>; for example, the
opcache extension shipped with PHP is available at
<code class="literal">php.extensions.opcache</code> and the third-party ImageMagick extension at
<code class="literal">php.extensions.imagick</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-php-user-guide-installing-with-extensions" class="title" >Installing PHP with extensions   </h4>  </div> </div></div><p>A PHP package with specific extensions enabled can be built using
<code class="literal">php.withExtensions</code>. This is a function which accepts an anonymous
function as its only argument; the function should accept two named
parameters: <code class="literal">enabled</code> - a list of currently enabled extensions and
<code class="literal">all</code> - the set of all extensions, and return a list of wanted
extensions. For example, a PHP package with all default extensions and
ImageMagick enabled:</p><pre><code class="programlisting nix">php.withExtensions ({ enabled, all }: enabled ++ [ all.imagick ])
</code></pre><p>To exclude some, but not all, of the default extensions, you can
filter the <code class="literal">enabled</code> list like this:</p><pre><code class="programlisting nix">php.withExtensions (
  { enabled, all }: (lib.filter (e: e != php.extensions.opcache) enabled) ++ [ all.imagick ]
)
</code></pre><p>To build your list of extensions from the ground up, you can
ignore <code class="literal">enabled</code>:</p><pre><code class="programlisting nix">php.withExtensions (
  { all, ... }:
  with all;
  [
    imagick
    opcache
  ]
)
</code></pre><p><code class="literal">php.withExtensions</code> provides extensions by wrapping a minimal php
base package, providing a <code class="literal">php.ini</code> file listing all extensions to be
loaded. You can access this package through the <code class="literal">php.unwrapped</code>
attribute; useful if you, for example, need access to the <code class="literal">dev</code>
output. The generated <code class="literal">php.ini</code> file can be accessed through the
<code class="literal">php.phpIni</code> attribute.</p><p>If you want a PHP build with extra configuration in the <code class="literal">php.ini</code>
file, you can use <code class="literal">php.buildEnv</code>. This function takes two named and
optional parameters: <code class="literal">extensions</code> and <code class="literal">extraConfig</code>. <code class="literal">extensions</code>
takes an extension specification equivalent to that of
<code class="literal">php.withExtensions</code>, <code class="literal">extraConfig</code> a string of additional <code class="literal">php.ini</code>
configuration parameters. For example, a PHP package with the opcache
and ImageMagick extensions enabled, and <code class="literal">memory_limit</code> set to <code class="literal">256M</code>:</p><pre><code class="programlisting nix">php.buildEnv {
  extensions =
    { all, ... }:
    with all;
    [
      imagick
      opcache
    ];
  extraConfig = &quot;memory_limit=256M&quot;;
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="ssec-php-user-guide-installing-with-extensions-phpfpm" class="title" >Example setup for <code class="literal">phpfpm</code>   </h5>  </div> </div></div><p>You can use the previous examples in a <code class="literal">phpfpm</code> pool called <code class="literal">foo</code> as
follows:</p><pre><code class="programlisting nix">let
  myPhp = php.withExtensions (
    { all, ... }:
    with all;
    [
      imagick
      opcache
    ]
  );
in
{
  services.phpfpm.pools.&quot;foo&quot;.phpPackage = myPhp;
}
</code></pre><pre><code class="programlisting nix">let
  myPhp = php.buildEnv {
    extensions =
      { all, ... }:
      with all;
      [
        imagick
        opcache
      ];
    extraConfig = &quot;memory_limit=256M&quot;;
  };
in
{
  services.phpfpm.pools.&quot;foo&quot;.phpPackage = myPhp;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="ssec-php-user-guide-installing-with-extensions-nix-shell" class="title" >Example usage with <code class="literal">nix-shell</code>   </h5>  </div> </div></div><p>This brings up a temporary environment that contains a PHP interpreter
with the extensions <code class="literal">imagick</code> and <code class="literal">opcache</code> enabled:</p><pre><code class="programlisting sh">nix-shell -p &#x27;php.withExtensions ({ all, ... }: with all; [ imagick opcache ])&#x27;
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-php-user-guide-installing-packages-with-extensions" class="title" >Installing PHP packages with extensions   </h4>  </div> </div></div><p>All interactive tools use the PHP package you get them from, so all
packages at <code class="literal">php.packages.*</code> use the <code class="literal">php</code> package with its default
extensions. Sometimes this default set of extensions isn’t enough and
you may want to extend it. A common case of this is the <code class="literal">composer</code>
package: a project may depend on certain extensions and <code class="literal">composer</code>
won’t work with that project unless those extensions are loaded.</p><p>Example of building <code class="literal">composer</code> with additional extensions:</p><pre><code class="programlisting nix">(php.withExtensions (
  { all, enabled }:
  enabled
  ++ (with all; [
    imagick
    redis
  ])
)).packages.composer
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-php-user-guide-overriding-packages" class="title" >Overriding PHP packages   </h4>  </div> </div></div><p><code class="literal">php-packages.nix</code> form a scope, allowing us to override the packages defined
within. For example, to apply a patch to a <code class="literal">mysqlnd</code> extension, you can
pass an overlay-style function to <code class="literal">php</code>’s <code class="literal">packageOverrides</code> argument:</p><pre><code class="programlisting nix">php.override {
  packageOverrides = final: prev: {
    extensions = prev.extensions // {
      mysqlnd = prev.extensions.mysqlnd.overrideAttrs (attrs: {
        patches = attrs.patches or [ ] ++ [
          # ...
        ];
      });
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-building-php-projects" class="title" >Building PHP projects   </h4>  </div> </div></div><p>With <a class="link" href="https://getcomposer.org/"  target="_top">Composer</a>, you can effectively build PHP
projects by streamlining dependency management. As the de-facto standard
dependency manager for PHP, Composer enables you to declare and manage the
libraries your project relies on, ensuring a more organized and efficient
development process.</p><p>Composer is not a package manager in the same sense as <code class="literal">Yum</code> or <code class="literal">Apt</code> are. Yes,
it deals with “packages” or libraries, but it manages them on a per-project
basis, installing them in a directory (e.g. <code class="literal">vendor</code>) inside your project. By
default, it does not install anything globally. This idea is not new and
Composer is strongly inspired by node’s <code class="literal">npm</code> and ruby’s <code class="literal">bundler</code>.</p><p>Currently, there is no other PHP tool that offers the same functionality as
Composer. Consequently, incorporating a helper in Nix to facilitate building
such applications is a logical choice.</p><p>In a Composer project, dependencies are defined in a <code class="literal">composer.json</code> file,
while their specific versions are locked in a <code class="literal">composer.lock</code> file. Some
Composer-based projects opt to include this <code class="literal">composer.lock</code> file in their source
code, while others choose not to.</p><p>In Nix, there are multiple approaches to building a Composer-based project.</p><p>One such method is the <code class="literal">php.buildComposerProject2</code> helper function, which serves
as a wrapper around <code class="literal">mkDerivation</code>.</p><p>Using this function, you can build a PHP project that includes both a
<code class="literal">composer.json</code> and <code class="literal">composer.lock</code> file. If the project specifies binaries
using the <code class="literal">bin</code> attribute in <code class="literal">composer.json</code>, these binaries will be
automatically linked and made accessible in the derivation. In this context,
“binaries” refer to PHP scripts that are intended to be executable.</p><p>To use the helper effectively, add the <code class="literal">vendorHash</code> attribute, which
enables the wrapper to handle the heavy lifting.</p><p>Internally, the helper operates in three stages:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>It constructs a <code class="literal">composerRepository</code> attribute derivation by creating a
composer repository on the filesystem containing dependencies specified in
<code class="literal">composer.json</code>. This process uses the function
<code class="literal">php.mkComposerRepository</code> which in turn uses the
<code class="literal">php.composerHooks.composerRepositoryHook</code> hook. Internally this function uses
a custom
<a class="link" href="https://github.com/nix-community/composer-local-repo-plugin"  target="_top">Composer plugin</a> to
generate the repository.</p></li><li class="listitem"><p>The resulting <code class="literal">composerRepository</code> derivation is then used by the
<code class="literal">php.composerHooks.composerInstallHook</code> hook, which is responsible for
creating the final <code class="literal">vendor</code> directory.</p></li><li class="listitem"><p>Any “binary” specified in the <code class="literal">composer.json</code> are linked and made accessible
in the derivation.</p></li></ol></div><p>As the autoloader optimization can be activated directly within the
<code class="literal">composer.json</code> file, we do not enable any autoloader optimization flags.</p><p>To customize the PHP version, you can specify the <code class="literal">php</code> attribute. Similarly, if
you wish to modify the Composer version, use the <code class="literal">composer</code> attribute. It is
important to note that both attributes should be of the <code class="literal">derivation</code> type.</p><p>Here’s an example of working code example using <code class="literal">php.buildComposerProject2</code>:</p><pre><code class="programlisting nix">{ php, fetchFromGitHub }:

php.buildComposerProject2 (finalAttrs: {
  pname = &quot;php-app&quot;;
  version = &quot;1.0.0&quot;;

  src = fetchFromGitHub {
    owner = &quot;git-owner&quot;;
    repo = &quot;git-repo&quot;;
    tag = finalAttrs.version;
    hash = &quot;sha256-VcQRSss2dssfkJ+iUb5qT+FJ10GHiFDzySigcmuVI+8=&quot;;
  };

  # PHP version containing the `ast` extension enabled
  php = php.buildEnv {
    extensions = ({ enabled, all }: enabled ++ (with all; [ ast ]));
  };

  # The composer vendor hash
  vendorHash = &quot;sha256-86s/F+/5cBAwBqZ2yaGRM5rTGLmou5//aLRK5SA0WiQ=&quot;;

  # If the composer.lock file is missing from the repository, add it:
  # composerLock = ./path/to/composer.lock;
})
</code></pre><p>In case the file <code class="literal">composer.lock</code> is missing from the repository, it is possible
to specify it using the <code class="literal">composerLock</code> attribute.</p><p>The other method is to use all these methods and hooks individually. This has
the advantage of building a PHP library within another derivation very easily
when necessary.</p><p>Here’s a working code example to build a PHP library using <code class="literal">mkDerivation</code> and
separate functions and hooks:</p><pre><code class="programlisting nix">{
  stdenvNoCC,
  fetchFromGitHub,
  php,
}:

stdenvNoCC.mkDerivation (
  finalAttrs:
  let
    src = fetchFromGitHub {
      owner = &quot;git-owner&quot;;
      repo = &quot;git-repo&quot;;
      rev = finalAttrs.version;
      hash = &quot;sha256-VcQRSss2dssfkJ+iUb5qT+FJ10GHiFDzySigcmuVI+8=&quot;;
    };
  in
  {
    inherit src;
    pname = &quot;php-app&quot;;
    version = &quot;1.0.0&quot;;

    buildInputs = [ php ];

    nativeBuildInputs = [
      php.packages.composer
      # This hook will use the attribute `composerRepository`
      php.composerHooks.composerInstallHook
    ];

    composerRepository = php.mkComposerRepository {
      inherit (finalAttrs) pname version src;
      composerNoDev = true;
      composerNoPlugins = true;
      composerNoScripts = true;
      # Specifying a custom composer.lock since it is not present in the sources.
      composerLock = ./composer.lock;
      # The composer vendor hash
      vendorHash = &quot;sha256-86s/F+/5cBAwBqZ2yaGRM5rTGLmou5//aLRK5SA0WiQ=&quot;;
    };
  }
)
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pkg-config" class="title" style="clear: both">pkg-config   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#pkg-config-writing-packages">Writing packages providing pkg-config modules</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-pkg-config-usage">Accessing packages via pkg-config module name</a> </span></dt> </dl></div><p><span class="emphasis"><em>pkg-config</em></span> is a unified interface for declaring and querying built C/C++ libraries.</p><p>Nixpkgs provides a couple of facilities for working with this tool.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="pkg-config-writing-packages" class="title" >Writing packages providing pkg-config modules   </h3>  </div> </div></div><p>Packages should set <code class="literal">meta.pkgConfigModules</code> with the list of package config modules they provide.
They should also use <code class="literal">testers.hasPkgConfigModules</code> to check that the final built package matches that list,
and optionally check that the pkgconf modules’ version metadata matches the derivation’s.
Additionally, the <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#validatepkgconfig"  target="_top"><code class="literal">validatePkgConfig</code> setup hook</a>, will do extra checks on to-be-installed pkg-config modules.</p><p>A good example of all these things is miniz:</p><pre><code class="programlisting nix">{ pkg-config, testers, ... }:

stdenv.mkDerivation (finalAttrs: {
  # ...

  nativeBuildInputs = [
    pkg-config
    validatePkgConfig
  ];

  passthru.tests.pkg-config = testers.hasPkgConfigModules {
    package = finalAttrs.finalPackage;
    versionCheck = true;
  };

  meta = {
    # ...
    pkgConfigModules = [ &quot;miniz&quot; ];
  };
})
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-pkg-config-usage" class="title" >Accessing packages via pkg-config module name   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-pkg-config-usage-internal" class="title" >Within Nixpkgs   </h4>  </div> </div></div><p>A <a class="link" href="index.html#setup-hook-pkg-config" title="pkg-config" >setup hook</a> is bundled in the <code class="literal">pkg-config</code> package to bring a derivation’s declared build inputs into the environment.
This will populate environment variables like <code class="literal">PKG_CONFIG_PATH</code>, <code class="literal">PKG_CONFIG_PATH_FOR_BUILD</code>, and <code class="literal">PKG_CONFIG_PATH_HOST</code> based on:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>how <code class="literal">pkg-config</code> itself is depended upon</p></li><li class="listitem"><p>how other dependencies are depended upon</p></li></ul></div><p>For more details see the section on <a class="link" href="index.html#ssec-stdenv-dependencies" title="Specifying dependencies" >specifying dependencies in general</a>.</p><p>Normal pkg-config commands to look up dependencies by name will then work with those environment variables defined by the hook.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-pkg-config-usage-external" class="title" >Externally   </h4>  </div> </div></div><p>The <code class="literal">defaultPkgConfigPackages</code> package set is a set of aliases, named after the modules they provide.
This is meant to be used by language-to-nix integrations.
Hand-written packages should use the normal Nixpkgs attribute name instead.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="python" class="title" style="clear: both">Python   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#reference">Reference</a> </span></dt><dt> <span class="section">  <a href="index.html#user-guide">User Guide</a> </span></dt><dt> <span class="section">  <a href="index.html#faq">FAQ</a> </span></dt><dt> <span class="section">  <a href="index.html#contributing">Contributing</a> </span></dt><dt> <span class="section">  <a href="index.html#python-package-set-maintenance">Package set maintenance</a> </span></dt><dt> <span class="section">  <a href="index.html#python-cpython-update-schedule">CPython Update Schedule</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="reference" class="title" >Reference   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="interpreters" class="title" >Interpreters   </h4>  </div> </div></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">Package</th><th align="left">Aliases</th><th align="left">Interpeter</th></tr></thead><tbody><tr><td align="left">python314</td><td align="left"></td><td align="left">CPython 3.14</td></tr><tr><td align="left">python313</td><td align="left">python3</td><td align="left">CPython 3.13</td></tr><tr><td align="left">python312</td><td align="left"></td><td align="left">CPython 3.12</td></tr><tr><td align="left">python311</td><td align="left"></td><td align="left">CPython 3.11</td></tr><tr><td align="left">python310</td><td align="left"></td><td align="left">CPython 3.10</td></tr><tr><td align="left">python27</td><td align="left">python2</td><td align="left">CPython 2.7</td></tr><tr><td align="left">pypy311</td><td align="left">pypy3</td><td align="left">PyPy 3.11</td></tr><tr><td align="left">pypy310</td><td align="left"></td><td align="left">PyPy 3.10</td></tr><tr><td align="left">pypy27</td><td align="left">pypy, pypy2</td><td align="left">PyPy 2.7</td></tr></tbody></table></div><p>The Nix expressions for the interpreters can be found in
<code class="literal">pkgs/development/interpreters/python</code>.</p><p>All packages depending on any Python interpreter get appended
<code class="literal">out/{python.sitePackages}</code> to <code class="literal">$PYTHONPATH</code> if such directory
exists.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="missing-tkinter-module-standard-library" class="title" >Missing <code class="literal">tkinter</code> module standard library   </h5>  </div> </div></div><p>To reduce closure size the <code class="literal">Tkinter</code>/<code class="literal">tkinter</code> is available as a separate package, <code class="literal">pythonPackages.tkinter</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="attributes-on-interpreters-packages" class="title" >Attributes on interpreters packages   </h5>  </div> </div></div><p>Each interpreter has the following attributes:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">libPrefix</code>. Name of the folder in <code class="literal">${python}/lib/</code> for corresponding interpreter.</p></li><li class="listitem"><p><code class="literal">interpreter</code>. Alias for <code class="literal">${python}/bin/${executable}</code>.</p></li><li class="listitem"><p><code class="literal">buildEnv</code>. Function to build python interpreter environments with extra packages bundled together. See <a class="xref" href="index.html#python.buildenv-function" title="python.buildEnv function" >the section called “<code class="literal">python.buildEnv</code> function”</a> for usage and documentation.</p></li><li class="listitem"><p><code class="literal">withPackages</code>. Simpler interface to <code class="literal">buildEnv</code>. See <a class="xref" href="index.html#python.withpackages-function" title="python.withPackages function" >the section called “<code class="literal">python.withPackages</code> function”</a> for usage and documentation.</p></li><li class="listitem"><p><code class="literal">sitePackages</code>. Alias for <code class="literal">lib/${libPrefix}/site-packages</code>.</p></li><li class="listitem"><p><code class="literal">executable</code>. Name of the interpreter executable, e.g. <code class="literal">python3.10</code>.</p></li><li class="listitem"><p><code class="literal">pkgs</code>. Set of Python packages for that specific interpreter. The package set can be modified by overriding the interpreter and passing <code class="literal">packageOverrides</code>.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="building-packages-and-applications" class="title" >Building packages and applications   </h4>  </div> </div></div><p>Python libraries and applications that use tools to follow PEP 517 (e.g. <code class="literal">setuptools</code> or <code class="literal">hatchling</code>, etc.) or
previous tools such as <code class="literal">distutils</code> are typically built with respectively the <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> and
<a class="link" href="index.html#buildpythonapplication-function" title="buildPythonApplication function" ><code class="literal">buildPythonApplication</code></a> functions. These two functions also support installing a <code class="literal">wheel</code>.</p><p>All Python packages reside in <code class="literal">pkgs/top-level/python-packages.nix</code> and all
applications elsewhere. In case a package is used as both a library and an
application, then the package should be in <code class="literal">pkgs/top-level/python-packages.nix</code>
since only those packages are made available for all interpreter versions. The
preferred location for library expressions is in
<code class="literal">pkgs/development/python-modules</code>. It is important that these packages are
called from <code class="literal">pkgs/top-level/python-packages.nix</code> and not elsewhere, to guarantee
the right version of the package is built.</p><p>Based on the packages defined in <code class="literal">pkgs/top-level/python-packages.nix</code> an
attribute set is created for each available Python interpreter. The available
sets are</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pkgs.python27Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.python3Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.python310Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.python311Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.python312Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.python313Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.python314Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.pypy27Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.pypy310Packages</code></p></li></ul></div><p>and the aliases</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pkgs.python2Packages</code> pointing to <code class="literal">pkgs.python27Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.python3Packages</code> pointing to <code class="literal">pkgs.python313Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.pythonPackages</code> pointing to <code class="literal">pkgs.python2Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.pypy2Packages</code> pointing to <code class="literal">pkgs.pypy27Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.pypy3Packages</code> pointing to <code class="literal">pkgs.pypy310Packages</code></p></li><li class="listitem"><p><code class="literal">pkgs.pypyPackages</code> pointing to <code class="literal">pkgs.pypy2Packages</code></p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="buildpythonpackage-function" class="title" ><code class="literal">buildPythonPackage</code> function   </h5>  </div> </div></div><p>The <code class="literal">buildPythonPackage</code> function has its name binding in
<code class="literal">pkgs/development/interpreters/python/python-packages-base.nix</code> and is
implemented in <code class="literal">pkgs/development/interpreters/python/mk-python-derivation.nix</code>
using setup hooks.</p><p>The following is an example:</p><pre><code class="programlisting nix">{
  lib,
  buildPythonPackage,
  fetchPypi,

  # build-system
  setuptools,
  setuptools-scm,

  # dependencies
  attrs,
  pluggy,
  py,
  setuptools,
  six,

  # tests
  hypothesis,
}:

buildPythonPackage rec {
  pname = &quot;pytest&quot;;
  version = &quot;3.3.1&quot;;
  pyproject = true;

  src = fetchPypi {
    inherit pname version;
    hash = &quot;sha256-z4Q23FnYaVNG/NOrKW3kZCXsqwDWQJbOvnn7Ueyy65M=&quot;;
  };

  postPatch = &#x27;&#x27;
    # don&#x27;t test bash builtins
    rm testing/test_argcomplete.py
  &#x27;&#x27;;

  build-system = [
    setuptools
    setuptools-scm
  ];

  dependencies = [
    attrs
    py
    setuptools
    six
    pluggy
  ];

  nativeCheckInputs = [ hypothesis ];

  meta = {
    changelog = &quot;https://github.com/pytest-dev/pytest/releases/tag/${version}&quot;;
    description = &quot;Framework for writing tests&quot;;
    homepage = &quot;https://github.com/pytest-dev/pytest&quot;;
    license = lib.licenses.mit;
    maintainers = with lib.maintainers; [
      lovek323
      madjar
      lsix
    ];
  };
}
</code></pre><p>The <code class="literal">buildPythonPackage</code> mainly does four things:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>In the <a class="link" href="index.html#build-phase" title="The build phase" ><code class="literal">buildPhase</code></a>, it calls <code class="literal">${python.pythonOnBuildForHost.interpreter} -m build --wheel</code> to
build a wheel binary zipfile.</p></li><li class="listitem"><p>In the <a class="link" href="index.html#ssec-install-phase" title="The install phase" ><code class="literal">installPhase</code></a>, it installs the wheel file using <code class="literal">${python.pythonOnBuildForHost.interpreter} -m installer *.whl</code>.</p></li><li class="listitem"><p>In the <a class="link" href="index.html#var-stdenv-postFixup" title="postFixup" ><code class="literal">postFixup</code></a> phase, the <code class="literal">wrapPythonPrograms</code> bash function is called to
wrap all programs in the <code class="literal">$out/bin/*</code> directory to include <code class="literal">$PATH</code>
environment variable and add dependent libraries to script’s <code class="literal">sys.path</code>.</p></li><li class="listitem"><p>In the <a class="link" href="index.html#ssec-installCheck-phase" title="The installCheck phase" ><code class="literal">installCheck</code></a> phase, <code class="literal">${python.interpreter} -m pytest</code> is run.</p></li></ul></div><p>By default tests are run because <a class="link" href="index.html#var-stdenv-doCheck" title="doCheck" ><code class="literal">doCheck = true</code></a>. Test dependencies, like
e.g. the test runner, should be added to <a class="link" href="index.html#var-stdenv-nativeCheckInputs" title="nativeCheckInputs" ><code class="literal">nativeCheckInputs</code></a>.</p><p>By default <code class="literal">meta.platforms</code> is set to the same value
as the interpreter unless overridden otherwise.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="buildpythonpackage-parameters" class="title" ><code class="literal">buildPythonPackage</code> parameters   </h6>  </div> </div></div><p>All parameters from <a class="link" href="index.html#sec-using-stdenv" title="Using stdenv" ><code class="literal">stdenv.mkDerivation</code></a> function are still supported. The
following are specific to <code class="literal">buildPythonPackage</code>:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">catchConflicts ? true</code>: If <code class="literal">true</code>, abort package build if a package name
appears more than once in dependency tree. Default is <code class="literal">true</code>.</p></li><li class="listitem"><p><code class="literal">disabled ? false</code>: If <code class="literal">true</code>, package is not built for the particular Python
interpreter version.</p></li><li class="listitem"><p><code class="literal">dontWrapPythonPrograms ? false</code>: Skip wrapping of Python programs.</p></li><li class="listitem"><p><code class="literal">permitUserSite ? false</code>: Skip setting the <code class="literal">PYTHONNOUSERSITE</code> environment
variable in wrapped programs.</p></li><li class="listitem"><p><code class="literal">pyproject</code>: Whether the pyproject format should be used. As all other formats
are deprecated, you are recommended to set this to <code class="literal">true</code>. When you do so,
<code class="literal">pypaBuildHook</code> will be used, and you can add the required build dependencies
from <code class="literal">build-system.requires</code> to <code class="literal">build-system</code>. Note that the pyproject
format falls back to using <code class="literal">setuptools</code>, so you can use <code class="literal">pyproject = true</code>
even if the package only has a <code class="literal">setup.py</code>. When set to <code class="literal">false</code>, you can
use the existing <a class="link" href="index.html#setup-hooks" title="Setup hooks" >hooks</a> or provide your own logic to build the
package. This can be useful for packages that don’t support the pyproject
format. When unset, the legacy <code class="literal">setuptools</code> hooks are used for backwards
compatibility.</p></li><li class="listitem"><p><code class="literal">makeWrapperArgs ? []</code>: A list of strings. Arguments to be passed to
<a class="link" href="index.html#fun-makeWrapper" title="makeWrapper &lt;executable&gt; &lt;wrapperfile&gt; &lt;args&gt;" ><code class="literal">makeWrapper</code></a>, which wraps generated binaries. By default, the arguments to
<a class="link" href="index.html#fun-makeWrapper" title="makeWrapper &lt;executable&gt; &lt;wrapperfile&gt; &lt;args&gt;" ><code class="literal">makeWrapper</code></a> set <code class="literal">PATH</code> and <code class="literal">PYTHONPATH</code> environment variables before calling
the binary. Additional arguments here can allow a developer to set environment
variables which will be available when the binary is run. For example,
<code class="literal">makeWrapperArgs = [&quot;--set&quot; &quot;FOO&quot; &quot;BAR&quot; &quot;--set&quot; &quot;BAZ&quot; &quot;QUX&quot;]</code>.</p><div class="note"><h3 class="title">Note</h3><p>When <code class="literal">__structuredAttrs = false</code>, the attribute <code class="literal">makeWrapperArgs</code> is passed as a space-separated string to the build script. Developers should use <code class="literal">prependToVar</code> or <code class="literal">appendToVar</code> to add arguments to it in build phases, or use <code class="literal">__structuredAttrs = true</code> to ensure that <code class="literal">makeWrapperArgs</code> is passed as a Bash array.</p><p>For compatibility purposes,
when <code class="literal">makeWrapperArgs</code> shell variable is specified as a space-separated string (instead of a Bash array) in the build script, the string content is Bash-expanded before concatenated into the <code class="literal">wrapProgram</code> command. Still, developers should not rely on such behaviours, but use <code class="literal">__structuredAttrs = true</code> to specify flags containing spaces (e.g. <code class="literal">makeWrapperArgs = [ &quot;--set&quot; &quot;GREETING&quot; &quot;Hello, world!&quot; ]</code>), or use -pre and -post phases to specify flags with Bash-expansions (e.g. <code class="literal">preFixup = &#x27;&#x27;makeWrapperArgs+=(--prefix PATH : &quot;$SOME_PATH&quot;)</code>‘’).</p></div></li><li class="listitem"><p><code class="literal">namePrefix</code>: Prepends text to <code class="literal">${name}</code> parameter. In case of libraries, this
defaults to <code class="literal">&quot;python3.8-&quot;</code> for Python 3.8, etc., and in case of applications to <code class="literal">&quot;&quot;</code>.</p></li><li class="listitem"><p><code class="literal">pypaBuildFlags ? []</code>: A list of strings. Arguments to be passed to <code class="literal">python -m build --wheel</code>.</p></li><li class="listitem"><p><code class="literal">pythonPath ? []</code>: List of packages to be added into <code class="literal">$PYTHONPATH</code>. Packages
in <code class="literal">pythonPath</code> are not propagated (contrary to <a class="link" href="index.html#var-stdenv-propagatedBuildInputs" title="propagatedBuildInputs" ><code class="literal">propagatedBuildInputs</code></a>).</p></li><li class="listitem"><p><code class="literal">preShellHook</code>: Hook to execute commands before <code class="literal">shellHook</code>.</p></li><li class="listitem"><p><code class="literal">postShellHook</code>: Hook to execute commands after <code class="literal">shellHook</code>.</p></li><li class="listitem"><p><code class="literal">removeBinByteCode ? true</code>: Remove bytecode from <code class="literal">/bin</code>. Bytecode is only
created when the filenames end with <code class="literal">.py</code>.</p></li><li class="listitem"><p><code class="literal">setupPyGlobalFlags ? []</code>: List of flags passed to <code class="literal">setup.py</code> command.</p></li><li class="listitem"><p><code class="literal">setupPyBuildFlags ? []</code>: List of flags passed to <code class="literal">setup.py build_ext</code> command.</p></li></ul></div><p>The <a class="link" href="index.html#sec-using-stdenv" title="Using stdenv" ><code class="literal">stdenv.mkDerivation</code></a> function accepts various parameters for describing
build inputs (see “Specifying dependencies”). The following are of special
interest for Python packages, either because these are primarily used, or
because their behaviour is different:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">nativeBuildInputs ? []</code>: Build-time only dependencies. Typically executables.</p></li><li class="listitem"><p><code class="literal">build-system ? []</code>: Build-time only Python dependencies. Items listed in <code class="literal">build-system.requires</code>/<code class="literal">setup_requires</code>.</p></li><li class="listitem"><p><code class="literal">buildInputs ? []</code>: Build and/or run-time dependencies that need to be
compiled for the host machine. Typically non-Python libraries which are being
linked.</p></li><li class="listitem"><p><code class="literal">nativeCheckInputs ? []</code>: Dependencies needed for running the <a class="link" href="index.html#ssec-check-phase" title="The check phase" ><code class="literal">checkPhase</code></a>. These
are added to <a class="link" href="index.html#var-stdenv-nativeBuildInputs" title="nativeBuildInputs" ><code class="literal">nativeBuildInputs</code></a> when <a class="link" href="index.html#var-stdenv-doCheck" title="doCheck" ><code class="literal">doCheck = true</code></a>. Items listed in
<code class="literal">tests_require</code> go here.</p></li><li class="listitem"><p><code class="literal">dependencies ? []</code>: Aside from propagating dependencies,
<code class="literal">buildPythonPackage</code> also injects code into and wraps executables with the
paths included in this list. Items listed in <code class="literal">install_requires</code> go here.</p></li><li class="listitem"><p><code class="literal">optional-dependencies ? { }</code>: Optional feature flagged dependencies.  Items listed in <code class="literal">extras_require</code> go here.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="overriding-python-packages" class="title" >Overriding Python packages   </h6>  </div> </div></div><p>The <code class="literal">buildPythonPackage</code> function has a <code class="literal">overridePythonAttrs</code> method that can be
used to override the package. In the following example we create an environment
where we have the <code class="literal">blaze</code> package using an older version of <code class="literal">pandas</code>. We
override first the Python interpreter and pass <code class="literal">packageOverrides</code> which contains
the overrides for packages in the package set.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

(
  let
    python =
      let
        packageOverrides = self: super: {
          pandas = super.pandas.overridePythonAttrs (old: rec {
            version = &quot;0.19.1&quot;;
            src = fetchPypi {
              pname = &quot;pandas&quot;;
              inherit version;
              hash = &quot;sha256-JQn+rtpy/OA2deLszSKEuxyttqBzcAil50H+JDHUdCE=&quot;;
            };
          });
        };
      in
      pkgs.python3.override {
        inherit packageOverrides;
        self = python;
      };

  in
  python.withPackages (ps: [ ps.blaze ])
).env
</code></pre><p>The next example shows a non trivial overriding of the <code class="literal">blas</code> implementation to
be used through out all of the Python package set:</p><pre><code class="programlisting nix">{
  python3MyBlas = pkgs.python3.override {
    packageOverrides = self: super: {
      # We need toPythonModule for the package set to evaluate this
      blas = super.toPythonModule (super.pkgs.blas.override { blasProvider = super.pkgs.mkl; });
      lapack = super.toPythonModule (super.pkgs.lapack.override { lapackProvider = super.pkgs.mkl; });
    };
  };
}
</code></pre><p>This is particularly useful for numpy and scipy users who want to gain speed with other blas implementations.
Note that using <code class="literal">scipy = super.scipy.override { blas = super.pkgs.mkl; };</code> will likely result in
compilation issues, because scipy dependencies need to use the same blas implementation as well.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="buildpythonapplication-function" class="title" ><code class="literal">buildPythonApplication</code> function   </h5>  </div> </div></div><p>The <a class="link" href="index.html#buildpythonapplication-function" title="buildPythonApplication function" ><code class="literal">buildPythonApplication</code></a> function is practically the same as
<a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a>. The main purpose of this function is to build a Python
package where one is interested only in the executables, and not importable
modules. For that reason, when adding this package to a <a class="link" href="index.html#python.buildenv-function" title="python.buildEnv function" ><code class="literal">python.buildEnv</code></a>, the
modules won’t be made available.</p><p>Another difference is that <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> by default prefixes the names of
the packages with the version of the interpreter. Because this is irrelevant for
applications, the prefix is omitted.</p><p>When packaging a Python application with <a class="link" href="index.html#buildpythonapplication-function" title="buildPythonApplication function" ><code class="literal">buildPythonApplication</code></a>, it should be
called with <code class="literal">callPackage</code> and passed <code class="literal">python3</code> or <code class="literal">python3Packages</code> (possibly
specifying an interpreter version), like this:</p><pre><code class="programlisting nix">{
  lib,
  python3Packages,
  fetchPypi,
}:

python3Packages.buildPythonApplication rec {
  pname = &quot;luigi&quot;;
  version = &quot;2.7.9&quot;;
  pyproject = true;

  src = fetchPypi {
    inherit pname version;
    hash = &quot;sha256-Pe229rT0aHwA98s+nTHQMEFKZPo/yw6sot8MivFDvAw=&quot;;
  };

  build-system = with python3Packages; [ setuptools ];

  dependencies = with python3Packages; [
    tornado
    python-daemon
  ];

  meta = {
    # ...
  };
}
</code></pre><p>This is then added to <code class="literal">pkgs/by-name</code> just as any other application would be.</p><p>Since the package is an application, a consumer doesn’t need to care about
Python versions or modules, which is why they don’t go in <code class="literal">python3Packages</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="topythonapplication-function" class="title" ><code class="literal">toPythonApplication</code> function   </h5>  </div> </div></div><p>A distinction is made between applications and libraries, however, sometimes a
package is used as both. In this case the package is added as a library to
<code class="literal">python-packages.nix</code> and as an application to <code class="literal">pkgs/by-name</code>. To reduce
duplication the <code class="literal">toPythonApplication</code> can be used to convert a library to an
application.</p><p>The Nix expression shall use <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> and be called from
<code class="literal">python-packages.nix</code>. A reference shall be created from <code class="literal">pkgs/by-name</code> to
the attribute in <code class="literal">python-packages.nix</code>, and the <code class="literal">toPythonApplication</code> shall be
applied to the reference:</p><pre><code class="programlisting nix">{ python3Packages }:

python3Packages.toPythonApplication python3Packages.youtube-dl
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="topythonmodule-function" class="title" ><code class="literal">toPythonModule</code> function   </h5>  </div> </div></div><p>In some cases, such as bindings, a package is created using
<a class="link" href="index.html#sec-using-stdenv" title="Using stdenv" ><code class="literal">stdenv.mkDerivation</code></a> and added as attribute in <code class="literal">pkgs/by-name</code> or in <code class="literal">all-packages.nix</code>. The Python
bindings should be made available from <code class="literal">python-packages.nix</code>. The
<code class="literal">toPythonModule</code> function takes a derivation and makes certain Python-specific
modifications.</p><pre><code class="programlisting nix">{
  opencv = toPythonModule (
    pkgs.opencv.override {
      enablePython = true;
      pythonPackages = self;
    }
  );
}
</code></pre><p>Do pay attention to passing in the right Python version!</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="mkpythonmetapackage-function" class="title" ><code class="literal">mkPythonMetaPackage</code> function   </h5>  </div> </div></div><p>This will create a meta package containing <a class="link" href="https://packaging.python.org/en/latest/specifications/recording-installed-packages/"  target="_top">metadata files</a> to satisfy a dependency on a package, without it actually having been installed into the environment.
In nixpkgs this is used to package Python packages with split binary/source distributions such as <a class="link" href="https://pypi.org/project/psycopg2/"  target="_top">psycopg2</a>/<a class="link" href="https://pypi.org/project/psycopg2-binary/"  target="_top">psycopg2-binary</a>.</p><pre><code class="programlisting nix">mkPythonMetaPackage {
  pname = &quot;psycopg2-binary&quot;;
  inherit (psycopg2) optional-dependencies version;
  dependencies = [ psycopg2 ];
  meta = { inherit (psycopg2.meta) description homepage; };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="mkpythoneditablepackage-function" class="title" ><code class="literal">mkPythonEditablePackage</code> function   </h5>  </div> </div></div><p>When developing Python packages it’s common to install packages in <a class="link" href="https://setuptools.pypa.io/en/latest/userguide/development_mode.html"  target="_top">editable mode</a>.
Like <code class="literal">mkPythonMetaPackage</code> this function exists to create an otherwise empty package, but also containing a pointer to an impure location outside the Nix store that can be changed without rebuilding.</p><p>The editable root is passed as a string. Normally <code class="literal">.pth</code> files contains absolute paths to the mutable location. This isn’t always ergonomic with Nix, so environment variables are expanded at runtime.
This means that a shell hook setting up something like a <code class="literal">$REPO_ROOT</code> variable can be used as the relative package root.</p><p>As an implementation detail, the <a class="link" href="https://peps.python.org/pep-0518/"  target="_top">PEP-518</a> <code class="literal">build-system</code> specified won’t be used, but instead the editable package will be built using <a class="link" href="https://pypi.org/project/hatchling/"  target="_top">hatchling</a>.
The <code class="literal">build-system</code>’s provided will instead become runtime dependencies of the editable package.</p><p>Note that overriding packages deeper in the dependency graph <span class="emphasis"><em>can</em></span> work, but it’s not the primary use case and overriding existing packages can make others break in unexpected ways.</p><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:

let
  pyproject = pkgs.lib.importTOML ./pyproject.toml;

  myPython = pkgs.python.override {
    self = myPython;
    packageOverrides = pyfinal: pyprev: {
      # An editable package with a script that loads our mutable location
      my-editable = pyfinal.mkPythonEditablePackage {
        # Inherit project metadata from pyproject.toml
        pname = pyproject.project.name;
        inherit (pyproject.project) version;

        # The editable root passed as a string
        root = &quot;$REPO_ROOT/src&quot;; # Use environment variable expansion at runtime

        # Inject a script (other PEP-621 entrypoints are also accepted)
        inherit (pyproject.project) scripts;
      };
    };
  };

  pythonEnv = myPython.withPackages (ps: [ ps.my-editable ]);

in
pkgs.mkShell { packages = [ pythonEnv ]; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="python.buildenv-function" class="title" ><code class="literal">python.buildEnv</code> function   </h5>  </div> </div></div><p>Python environments can be created using the low-level <code class="literal">pkgs.buildEnv</code> function.
This example shows how to create an environment that has the Pyramid Web Framework.
Saving the following as <code class="literal">default.nix</code></p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

python3.buildEnv.override {
  extraLibs = [ python3Packages.pyramid ];
  ignoreCollisions = true;
}
</code></pre><p>and running <code class="literal">nix-build</code> will create</p><pre><code class="programlisting">/nix/store/cf1xhjwzmdki7fasgr4kz6di72ykicl5-python-2.7.8-env
</code></pre><p>with wrapped binaries in <code class="literal">bin/</code>.</p><p>You can also use the <code class="literal">env</code> attribute to create local environments with needed
packages installed. This is somewhat comparable to <code class="literal">virtualenv</code>. For example,
running <code class="literal">nix-shell</code> with the following <code class="literal">shell.nix</code></p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

(python3.buildEnv.override {
  extraLibs = with python3Packages; [
    numpy
    requests
  ];
}).env
</code></pre><p>will drop you into a shell where Python will have the
specified packages in its path.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="python.buildenv-arguments" class="title" ><code class="literal">python.buildEnv</code> arguments   </h6>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">extraLibs</code>: List of packages installed inside the environment.</p></li><li class="listitem"><p><code class="literal">postBuild</code>: Shell command executed after the build of environment.</p></li><li class="listitem"><p><code class="literal">ignoreCollisions</code>: Ignore file collisions inside the environment (default is <code class="literal">false</code>).</p></li><li class="listitem"><p><code class="literal">permitUserSite</code>: Skip setting the <code class="literal">PYTHONNOUSERSITE</code> environment variable in
wrapped binaries in the environment.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="python.withpackages-function" class="title" ><code class="literal">python.withPackages</code> function   </h5>  </div> </div></div><p>The <a class="link" href="index.html#python.withpackages-function" title="python.withPackages function" ><code class="literal">python.withPackages</code></a> function provides a simpler interface to the <a class="link" href="index.html#python.buildenv-function" title="python.buildEnv function" ><code class="literal">python.buildEnv</code></a> functionality.
It takes a function as an argument that is passed the set of python packages and returns the list
of the packages to be included in the environment. Using the <a class="link" href="index.html#python.withpackages-function" title="python.withPackages function" ><code class="literal">withPackages</code></a> function, the previous
example for the Pyramid Web Framework environment can be written like this:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

python.withPackages (ps: [ ps.pyramid ])
</code></pre><p><a class="link" href="index.html#python.withpackages-function" title="python.withPackages function" ><code class="literal">withPackages</code></a> passes the correct package set for the specific interpreter
version as an argument to the function. In the above example, <code class="literal">ps</code> equals
<code class="literal">pythonPackages</code>. But you can also easily switch to using python3:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

python3.withPackages (ps: [ ps.pyramid ])
</code></pre><p>Now, <code class="literal">ps</code> is set to <code class="literal">python3Packages</code>, matching the version of the interpreter.</p><p>As <a class="link" href="index.html#python.withpackages-function" title="python.withPackages function" ><code class="literal">python.withPackages</code></a> uses <a class="link" href="index.html#python.buildenv-function" title="python.buildEnv function" ><code class="literal">python.buildEnv</code></a> under the hood, it also
supports the <code class="literal">env</code> attribute. The <code class="literal">shell.nix</code> file from the previous section can
thus be also written like this:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

(python3.withPackages (
  ps: with ps; [
    numpy
    requests
  ]
)).env
</code></pre><p>In contrast to <a class="link" href="index.html#python.buildenv-function" title="python.buildEnv function" ><code class="literal">python.buildEnv</code></a>, <a class="link" href="index.html#python.withpackages-function" title="python.withPackages function" ><code class="literal">python.withPackages</code></a> does not support the
more advanced options such as <code class="literal">ignoreCollisions = true</code> or <code class="literal">postBuild</code>. If you
need them, you have to use <a class="link" href="index.html#python.buildenv-function" title="python.buildEnv function" ><code class="literal">python.buildEnv</code></a>.</p><p>Python 2 namespace packages may provide <code class="literal">__init__.py</code> that collide. In that case
<a class="link" href="index.html#python.buildenv-function" title="python.buildEnv function" ><code class="literal">python.buildEnv</code></a> should be used with <code class="literal">ignoreCollisions = true</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="setup-hooks" class="title" >Setup hooks   </h5>  </div> </div></div><p>The following are setup hooks specifically for Python packages. Most of these
are used in <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a>.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">eggUnpackhook</code> to move an egg to the correct folder so it can be installed
with the <code class="literal">eggInstallHook</code></p></li><li class="listitem"><p><code class="literal">eggBuildHook</code> to skip building for eggs.</p></li><li class="listitem"><p><code class="literal">eggInstallHook</code> to install eggs.</p></li><li class="listitem"><p><code class="literal">pypaBuildHook</code> to build a wheel using
<a class="link" href="https://pypa-build.readthedocs.io/en/latest/index.html"  target="_top"><code class="literal">pypa/build</code></a> and
PEP 517/518. Note a build system (e.g. <code class="literal">setuptools</code> or <code class="literal">flit</code>) should still
be added as <code class="literal">build-system</code>.</p></li><li class="listitem"><p><code class="literal">pypaInstallHook</code> to install wheels.</p></li><li class="listitem"><p><code class="literal">pytestCheckHook</code> to run tests with <code class="literal">pytest</code>. See <a class="link" href="index.html#using-pytestcheckhook" title="Using pytestCheckHook" >example usage</a>.</p></li><li class="listitem"><p><code class="literal">pythonCatchConflictsHook</code> to fail if the package depends on two different versions of the same dependency.</p></li><li class="listitem"><p><code class="literal">pythonImportsCheckHook</code> to check whether importing the listed modules works.</p></li><li class="listitem"><p><code class="literal">pythonRelaxDepsHook</code> will relax Python dependencies restrictions for the package.
See <a class="link" href="index.html#using-pythonrelaxdepshook" title="Using pythonRelaxDepsHook" >example usage</a>.</p></li><li class="listitem"><p><code class="literal">pythonRemoveBinBytecode</code> to remove bytecode from the <code class="literal">/bin</code> folder.</p></li><li class="listitem"><p><code class="literal">setuptoolsBuildHook</code> to build a wheel using <code class="literal">setuptools</code>.</p></li><li class="listitem"><p><code class="literal">sphinxHook</code> to build documentation and manpages using Sphinx.</p></li><li class="listitem"><p><code class="literal">venvShellHook</code> to source a Python 3 <code class="literal">venv</code> at the <code class="literal">venvDir</code> location. A
<code class="literal">venv</code> is created if it does not yet exist. <code class="literal">postVenvCreation</code> can be used to
to run commands only after venv is first created.</p></li><li class="listitem"><p><code class="literal">wheelUnpackHook</code> to move a wheel to the correct folder so it can be installed
with the <code class="literal">pipInstallHook</code>.</p></li><li class="listitem"><p><code class="literal">unittestCheckHook</code> will run tests with <code class="literal">python -m unittest discover</code>. See <a class="link" href="index.html#using-unittestcheckhook" title="Using unittestCheckHook" >example usage</a>.</p></li></ul></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="user-guide" class="title" >User Guide   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="using-python" class="title" >Using Python   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="overview" class="title" >Overview   </h5>  </div> </div></div><p>Several versions of the Python interpreter are available on Nix, as well as a
high amount of packages. The attribute <code class="literal">python3</code> refers to the default
interpreter, which is currently CPython 3.13. The attribute <code class="literal">python</code> refers to
CPython 2.7 for backwards-compatibility. It is also possible to refer to
specific versions, e.g. <code class="literal">python313</code> refers to CPython 3.13, and <code class="literal">pypy</code> refers to
the default PyPy interpreter.</p><p>Python is used a lot, and in different ways. This affects also how it is
packaged. In the case of Python on Nix, an important distinction is made between
whether the package is considered primarily an application, or whether it should
be used as a library, i.e., of primary interest are the modules in
<code class="literal">site-packages</code> that should be importable.</p><p>In the Nixpkgs tree Python applications can be found throughout, depending on
what they do, and are called from the main package set. Python libraries,
however, are in separate sets, with one set per interpreter version.</p><p>The interpreters have several common attributes. One of these attributes is
<code class="literal">pkgs</code>, which is a package set of Python libraries for this specific
interpreter. E.g., the <code class="literal">toolz</code> package corresponding to the default interpreter
is <code class="literal">python3.pkgs.toolz</code>, and the CPython 3.13 version is <code class="literal">python313.pkgs.toolz</code>.
The main package set contains aliases to these package sets, e.g.
<code class="literal">pythonPackages</code> refers to <code class="literal">python.pkgs</code> and <code class="literal">python313Packages</code> to
<code class="literal">python313.pkgs</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="installing-python-and-packages" class="title" >Installing Python and packages   </h5>  </div> </div></div><p>The Nix and NixOS manuals explain how packages are generally installed. In the
case of Python and Nix, it is important to make a distinction between whether the
package is considered an application or a library.</p><p>Applications on Nix are typically installed into your user profile imperatively
using <code class="literal">nix-env -i</code>, and on NixOS declaratively by adding the package name to
<code class="literal">environment.systemPackages</code> in <code class="literal">/etc/nixos/configuration.nix</code>. Dependencies
such as libraries are automatically installed and should not be installed
explicitly.</p><p>The same goes for Python applications. Python applications can be installed in
your profile, and will be wrapped to find their exact library dependencies,
without impacting other applications or polluting your user environment.</p><p>But Python libraries you would like to use for development cannot be installed,
at least not individually, because they won’t be able to find each other
resulting in import errors. Instead, it is possible to create an environment
with <a class="link" href="index.html#python.buildenv-function" title="python.buildEnv function" ><code class="literal">python.buildEnv</code></a> or <a class="link" href="index.html#python.withpackages-function" title="python.withPackages function" ><code class="literal">python.withPackages</code></a> where the interpreter and other
executables are wrapped to be able to find each other and all of the modules.</p><p>In the following examples we will start by creating a simple, ad-hoc environment
with a nix-shell that has <code class="literal">numpy</code> and <code class="literal">toolz</code> in Python 3.13; then we will create
a re-usable environment in a single-file Python script; then we will create a
full Python environment for development with this same environment.</p><p>Philosophically, this should be familiar to users who are used to a <code class="literal">venv</code> style
of development: individual projects create their own Python environments without
impacting the global environment or each other.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="ad-hoc-temporary-python-environment-with-nix-shell" class="title" >Ad-hoc temporary Python environment with <code class="literal">nix-shell</code>   </h5>  </div> </div></div><p>The simplest way to start playing with the way nix wraps and sets up Python
environments is with <code class="literal">nix-shell</code> at the cmdline. These environments create a
temporary shell session with a Python and a <span class="emphasis"><em>precise</em></span> list of packages (plus
their runtime dependencies), with no other Python packages in the Python
interpreter’s scope.</p><p>To create a Python 3.13 session with <code class="literal">numpy</code> and <code class="literal">toolz</code> available, run:</p><pre><code class="programlisting sh">$ nix-shell -p &#x27;python313.withPackages(ps: with ps; [ numpy toolz ])&#x27;
</code></pre><p>By default <code class="literal">nix-shell</code> will start a <code class="literal">bash</code> session with this interpreter in our
<code class="literal">PATH</code>, so if we then run:</p><pre><code class="programlisting Python console">[nix-shell:~/src/nixpkgs]$ python3
Python 3.13.3 (main, Apr  8 2025, 13:54:08) [GCC 14.2.1 20250322] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import numpy; import toolz
</code></pre><p>Note that no other modules are in scope, even if they were imperatively
installed into our user environment as a dependency of a Python application:</p><pre><code class="programlisting Python console">&gt;&gt;&gt; import requests
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
ModuleNotFoundError: No module named &#x27;requests&#x27;
</code></pre><p>We can add as many additional modules onto the <code class="literal">nix-shell</code> as we need, and we
will still get 1 wrapped Python interpreter. We can start the interpreter
directly like so:</p><pre><code class="programlisting sh">$ nix-shell -p &quot;python313.withPackages (ps: with ps; [ numpy toolz requests ])&quot; --run python3
Python 3.13.3 (main, Apr  8 2025, 13:54:08) [GCC 14.2.1 20250322] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import requests
&gt;&gt;&gt;
</code></pre><p>Notice that this time it built a new Python environment, which now includes
<code class="literal">requests</code>. Building an environment just creates wrapper scripts that expose the
selected dependencies to the interpreter while re-using the actual modules. This
means if any other env has installed <code class="literal">requests</code> or <code class="literal">numpy</code> in a different
context, we don’t need to recompile them – we just recompile the wrapper script
that sets up an interpreter pointing to them. This matters much more for “big”
modules like <code class="literal">pytorch</code> or <code class="literal">tensorflow</code>.</p><p>Module names usually match their names on <a class="link" href="https://pypi.org/"  target="_top">pypi.org</a>, but
normalized according to PEP 503/508. (e.g. Foo__Bar.baz -&gt; foo-bar-baz)
You can use the <a class="link" href="https://nixos.org/nixos/packages.html"  target="_top">Nixpkgs search website</a>
to find them as well (along with non-python packages).</p><p>At this point we can create throwaway experimental Python environments with
arbitrary dependencies. This is a good way to get a feel for how the Python
interpreter and dependencies work in Nix and NixOS, but to do some actual
development, we’ll want to make it a bit more persistent.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="running-python-scripts-and-using-nix-shell-as-shebang" class="title" >Running Python scripts and using <code class="literal">nix-shell</code> as shebang   </h6>  </div> </div></div><p>Sometimes, we have a script whose header looks like this:</p><pre><code class="programlisting python">#!/usr/bin/env python3
import numpy as np
a = np.array([1,2])
b = np.array([3,4])
print(f&quot;The dot product of {a} and {b} is: {np.dot(a, b)}&quot;)
</code></pre><p>Executing this script requires a <code class="literal">python3</code> that has <code class="literal">numpy</code>. Using what we learned
in the previous section, we could startup a shell and just run it like so:</p><pre><code class="programlisting ShellSession">$ nix-shell -p &#x27;python313.withPackages (ps: with ps; [ numpy ])&#x27; --run &#x27;python3 foo.py&#x27;
The dot product of [1 2] and [3 4] is: 11
</code></pre><p>But if we maintain the script ourselves, and if there are more dependencies, it
may be nice to encode those dependencies in source to make the script re-usable
without that bit of knowledge. That can be done by using <code class="literal">nix-shell</code> as a
<a class="link" href="https://en.wikipedia.org/wiki/Shebang_(Unix)"  target="_top">shebang</a>, like so:</p><pre><code class="programlisting python">#!/usr/bin/env nix-shell
#!nix-shell -i python3 -p &quot;python3.withPackages(ps: [ ps.numpy ])&quot;
import numpy as np
a = np.array([1,2])
b = np.array([3,4])
print(f&quot;The dot product of {a} and {b} is: {np.dot(a, b)}&quot;)
</code></pre><p>Then we execute it, without requiring any environment setup at all!</p><pre><code class="programlisting sh">$ ./foo.py
The dot product of [1 2] and [3 4] is: 11
</code></pre><p>If the dependencies are not available on the host where <code class="literal">foo.py</code> is executed, it
will build or download them from a Nix binary cache prior to starting up, prior
that it is executed on a machine with a multi-user nix installation.</p><p>This provides a way to ship a self bootstrapping Python script, akin to a
statically linked binary, where it can be run on any machine (provided nix is
installed) without having to assume that <code class="literal">numpy</code> is installed globally on the
system.</p><p>By default it is pulling the import checkout of Nixpkgs itself from our nix
channel, which is nice as it cache aligns with our other package builds, but we
can make it fully reproducible by pinning the <code class="literal">nixpkgs</code> import:</p><pre><code class="programlisting python">#!/usr/bin/env nix-shell
#!nix-shell -i python3 -p &quot;python3.withPackages (ps: [ ps.numpy ])&quot;
#!nix-shell -I nixpkgs=https://github.com/NixOS/nixpkgs/archive/e51209796c4262bfb8908e3d6d72302fe4e96f5f.tar.gz
import numpy as np
a = np.array([1,2])
b = np.array([3,4])
print(f&quot;The dot product of {a} and {b} is: {np.dot(a, b)}&quot;)
</code></pre><p>This will execute with the exact same versions of Python 3.10, numpy, and system
dependencies a year from now as it does today, because it will always use
exactly git commit <code class="literal">e51209796c4262bfb8908e3d6d72302fe4e96f5f</code> of Nixpkgs for all
of the package versions.</p><p>This is also a great way to ensure the script executes identically on different
servers.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="load-environment-from-.nix-expression" class="title" >Load environment from <code class="literal">.nix</code> expression   </h6>  </div> </div></div><p>We’ve now seen how to create an ad-hoc temporary shell session, and how to
create a single script with Python dependencies, but in the course of normal
development we’re usually working in an entire package repository.</p><p>As explained <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/nix-shell"  target="_top">in the <code class="literal">nix-shell</code> section</a> of the Nix manual, <code class="literal">nix-shell</code> can also load an expression from a <code class="literal">.nix</code> file.
Say we want to have Python 3.13, <code class="literal">numpy</code> and <code class="literal">toolz</code>, like before,
in an environment. We can add a <code class="literal">shell.nix</code> file describing our dependencies:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };
(python313.withPackages (
  ps: with ps; [
    numpy
    toolz
  ]
)).env
</code></pre><p>And then at the command line, just typing <code class="literal">nix-shell</code> produces the same
environment as before. In a normal project, we’ll likely have many more
dependencies; this can provide a way for developers to share the environments
with each other and with CI builders.</p><p>What’s happening here?</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>We begin with importing the Nix Packages collections. <code class="literal">import &lt;nixpkgs&gt;</code>
imports the <code class="literal">&lt;nixpkgs&gt;</code> function, <code class="literal">{}</code> calls it and the <code class="literal">with</code> statement
brings all attributes of <code class="literal">nixpkgs</code> in the local scope. These attributes form
the main package set.</p></li><li class="listitem"><p>Then we create a Python 3.13 environment with the <a class="link" href="index.html#python.withpackages-function" title="python.withPackages function" ><code class="literal">withPackages</code></a> function, as before.</p></li><li class="listitem"><p>The <a class="link" href="index.html#python.withpackages-function" title="python.withPackages function" ><code class="literal">withPackages</code></a> function expects us to provide a function as an argument
that takes the set of all Python packages and returns a list of packages to
include in the environment. Here, we select the packages <code class="literal">numpy</code> and <code class="literal">toolz</code>
from the package set.</p></li></ol></div><p>To combine this with <code class="literal">mkShell</code> you can:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };
let
  pythonEnv = python313.withPackages (ps: [
    ps.numpy
    ps.toolz
  ]);
in
mkShell {
  packages = [
    pythonEnv

    black
    mypy

    libffi
    openssl
  ];
}
</code></pre><p>This will create a unified environment that has not just our Python interpreter
and its Python dependencies, but also tools like <code class="literal">black</code> or <code class="literal">mypy</code> and libraries
like <code class="literal">libffi</code> the <code class="literal">openssl</code> in scope. This is generic and can span any number of
tools or languages across the Nixpkgs ecosystem.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="installing-environments-globally-on-the-system" class="title" >Installing environments globally on the system   </h6>  </div> </div></div><p>Up to now, we’ve been creating environments scoped to an ad-hoc shell session,
or a single script, or a single project. This is generally advisable, as it
avoids pollution across contexts.</p><p>However, sometimes we know we will often want a Python with some basic packages,
and want this available without having to enter into a shell or build context.
This can be useful to have things like vim/emacs editors and plugins or shell
tools “just work” without having to set them up, or when running other software
that expects packages to be installed globally.</p><p>To create your own custom environment, create a file in <code class="literal">~/.config/nixpkgs/overlays/</code>
that looks like this:</p><pre><code class="programlisting nix"># ~/.config/nixpkgs/overlays/myEnv.nix
self: super: {
  myEnv = super.buildEnv {
    name = &quot;myEnv&quot;;
    paths = [
      # A Python 3 interpreter with some packages
      (self.python3.withPackages (
        ps: with ps; [
          pyflakes
          pytest
          black
        ]
      ))

      # Some other packages we&#x27;d like as part of this env
      self.mypy
      self.black
      self.ripgrep
      self.tmux
    ];
  };
}
</code></pre><p>You can then build and install this to your profile with:</p><pre><code class="programlisting sh">nix-env -iA myEnv
</code></pre><p>One limitation of this is that you can only have 1 Python env installed
globally, since they conflict on the <code class="literal">python</code> to load out of your <code class="literal">PATH</code>.</p><p>If you get a conflict or prefer to keep the setup clean, you can have <code class="literal">nix-env</code>
atomically <span class="emphasis"><em>uninstall</em></span> all other imperatively installed packages and replace
your profile with just <code class="literal">myEnv</code> by using the <code class="literal">--replace</code> flag.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h6 id="environment-defined-in-etcnixosconfiguration.nix" class="title" >Environment defined in <code class="literal">/etc/nixos/configuration.nix</code>   </h6>  </div> </div></div><p>For the sake of completeness, here’s how to install the environment system-wide
on NixOS.</p><pre><code class="programlisting nix">{
  # ...

  environment.systemPackages = with pkgs; [
    (python310.withPackages (
      ps: with ps; [
        numpy
        toolz
      ]
    ))
  ];
}
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="developing-with-python" class="title" >Developing with Python   </h4>  </div> </div></div><p>Above, we were mostly just focused on use cases and what to do to get started
creating working Python environments in nix.</p><p>Now that you know the basics to be up and running, it is time to take a step
back and take a deeper look at how Python packages are packaged on Nix.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="python-library-packages-in-nixpkgs" class="title" >Python library packages in Nixpkgs   </h5>  </div> </div></div><p>With Nix all packages are built by functions. The main function in Nix for
building Python libraries is <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a>. Let’s see how we can build the
<code class="literal">toolz</code> package.</p><pre><code class="programlisting nix">{
  lib,
  buildPythonPackage,
  fetchPypi,
  setuptools,
}:

buildPythonPackage rec {
  pname = &quot;toolz&quot;;
  version = &quot;0.10.0&quot;;
  pyproject = true;

  src = fetchPypi {
    inherit pname version;
    hash = &quot;sha256-CP3V73yWSArRHBLUct4hrNMjWZlvaaUlkpm1QP66RWA=&quot;;
  };

  build-system = [ setuptools ];

  # has no tests
  doCheck = false;

  pythonImportsCheck = [
    &quot;toolz.itertoolz&quot;
    &quot;toolz.functoolz&quot;
    &quot;toolz.dicttoolz&quot;
  ];

  meta = {
    changelog = &quot;https://github.com/pytoolz/toolz/releases/tag/${version}&quot;;
    homepage = &quot;https://github.com/pytoolz/toolz&quot;;
    description = &quot;List processing tools and functional utilities&quot;;
    license = lib.licenses.bsd3;
  };
}
</code></pre><p>What happens here? The function <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> is called and as argument
it accepts a set. In this case the set is a recursive set, <code class="literal">rec</code>. One of the
arguments is the name of the package, which consists of a basename (generally
following the name on PyPI) and a version. Another argument, <code class="literal">src</code> specifies the
source, which in this case is fetched from PyPI using the helper function
<code class="literal">fetchPypi</code>. The argument <code class="literal">doCheck</code> is used to set whether tests should be run
when building the package. Since there are no tests, we rely on <a class="link" href="index.html#using-pythonimportscheck" title="Using pythonImportsCheck" ><code class="literal">pythonImportsCheck</code></a>
to test whether the package can be imported. Furthermore, we specify some meta
information. The output of the function is a derivation.</p><p>An expression for <code class="literal">toolz</code> can be found in the Nixpkgs repository. As explained
in the introduction of this Python section, a derivation of <code class="literal">toolz</code> is available
for each interpreter version, e.g. <code class="literal">python313.pkgs.toolz</code> refers to the <code class="literal">toolz</code>
derivation corresponding to the CPython 3.13 interpreter.</p><p>The above example works when you’re directly working on
<code class="literal">pkgs/top-level/python-packages.nix</code> in the Nixpkgs repository. Often though,
you will want to test a Nix expression outside of the Nixpkgs tree.</p><p>The following expression creates a derivation for the <code class="literal">toolz</code> package,
and adds it along with a <code class="literal">numpy</code> package to a Python environment.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

(
  let
    my_toolz = python313.pkgs.buildPythonPackage rec {
      pname = &quot;toolz&quot;;
      version = &quot;0.10.0&quot;;
      pyproject = true;

      src = fetchPypi {
        inherit pname version;
        hash = &quot;sha256-CP3V73yWSArRHBLUct4hrNMjWZlvaaUlkpm1QP66RWA=&quot;;
      };

      build-system = [ python313.pkgs.setuptools ];

      # has no tests
      doCheck = false;

      meta = {
        homepage = &quot;https://github.com/pytoolz/toolz/&quot;;
        description = &quot;List processing tools and functional utilities&quot;;
        # [...]
      };
    };

  in
  python313.withPackages (
    ps: with ps; [
      numpy
      my_toolz
    ]
  )
).env
</code></pre><p>Executing <code class="literal">nix-shell</code> will result in an environment in which you can use
Python 3.13 and the <code class="literal">toolz</code> package. As you can see we had to explicitly mention
for which Python version we want to build a package.</p><p>So, what did we do here? Well, we took the Nix expression that we used earlier
to build a Python environment, and said that we wanted to include our own
version of <code class="literal">toolz</code>, named <code class="literal">my_toolz</code>. To introduce our own package in the scope
of <a class="link" href="index.html#python.withpackages-function" title="python.withPackages function" ><code class="literal">withPackages</code></a> we used a <code class="literal">let</code> expression. You can see that we used
<code class="literal">ps.numpy</code> to select numpy from the nixpkgs package set (<code class="literal">ps</code>). We did not take
<code class="literal">toolz</code> from the Nixpkgs package set this time, but instead took our own version
that we introduced with the <code class="literal">let</code> expression.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="handling-dependencies" class="title" >Handling dependencies   </h5>  </div> </div></div><p>Our example, <code class="literal">toolz</code>, does not have any dependencies on other Python packages or system libraries.
<a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> uses the the following arguments in the following circumstances:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">dependencies</code> - For Python runtime dependencies.</p></li><li class="listitem"><p><code class="literal">build-system</code> - For Python build-time requirements.</p></li><li class="listitem"><p><a class="link" href="index.html#var-stdenv-buildInputs" title="buildInputs" ><code class="literal">buildInputs</code></a> - For non-Python build-time requirements.</p></li><li class="listitem"><p><a class="link" href="index.html#var-stdenv-nativeCheckInputs" title="nativeCheckInputs" ><code class="literal">nativeCheckInputs</code></a> - For test dependencies</p></li></ul></div><p>Dependencies can belong to multiple arguments, for example if something is both a build time requirement &amp; a runtime dependency.</p><p>The following example shows which arguments are given to <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> in
order to build <a class="link" href="https://github.com/blaze/datashape"  target="_top"><code class="literal">datashape</code></a>.</p><pre><code class="programlisting nix">{
  lib,
  buildPythonPackage,
  fetchPypi,

  # build dependencies
  setuptools,

  # dependencies
  numpy,
  multipledispatch,
  python-dateutil,

  # tests
  pytestCheckHook,
}:

buildPythonPackage rec {
  pname = &quot;datashape&quot;;
  version = &quot;0.4.7&quot;;
  pyproject = true;

  src = fetchPypi {
    inherit pname version;
    hash = &quot;sha256-FLLvdm1MllKrgTGC6Gb0k0deZeVYvtCCLji/B7uhong=&quot;;
  };

  build-system = [ setuptools ];

  dependencies = [
    multipledispatch
    numpy
    python-dateutil
  ];

  nativeCheckInputs = [ pytestCheckHook ];

  meta = {
    changelog = &quot;https://github.com/blaze/datashape/releases/tag/${version}&quot;;
    homepage = &quot;https://github.com/ContinuumIO/datashape&quot;;
    description = &quot;Data description language&quot;;
    license = lib.licenses.bsd2;
  };
}
</code></pre><p>We can see several runtime dependencies, <code class="literal">numpy</code>, <code class="literal">multipledispatch</code>, and
<code class="literal">python-dateutil</code>. Furthermore, we have <a class="link" href="index.html#var-stdenv-nativeCheckInputs" title="nativeCheckInputs" ><code class="literal">nativeCheckInputs</code></a> with <code class="literal">pytestCheckHook</code>.
<code class="literal">pytestCheckHook</code> is a test runner hook and is only used during the <a class="link" href="index.html#ssec-check-phase" title="The check phase" ><code class="literal">checkPhase</code></a> and is
therefore not added to <code class="literal">dependencies</code>.</p><p>In the previous case we had only dependencies on other Python packages to consider.
Occasionally you have also system libraries to consider. E.g., <code class="literal">lxml</code> provides
Python bindings to <code class="literal">libxml2</code> and <code class="literal">libxslt</code>. These libraries are only required
when building the bindings and are therefore added as <a class="link" href="index.html#var-stdenv-buildInputs" title="buildInputs" ><code class="literal">buildInputs</code></a>.</p><pre><code class="programlisting nix">{
  lib,
  buildPythonPackage,
  fetchPypi,
  setuptools,
  libxml2,
  libxslt,
}:

buildPythonPackage rec {
  pname = &quot;lxml&quot;;
  version = &quot;3.4.4&quot;;
  pyproject = true;

  src = fetchPypi {
    inherit pname version;
    hash = &quot;sha256-s9NiusRxFydHzaNRMjjxFcvWxfi45jGb9ql6eJJyQJk=&quot;;
  };

  build-system = [ setuptools ];

  buildInputs = [
    libxml2
    libxslt
  ];

  # tests are meant to be ran &quot;in-place&quot; in the same directory as src
  doCheck = false;

  pythonImportsCheck = [
    &quot;lxml&quot;
    &quot;lxml.etree&quot;
  ];

  meta = {
    changelog = &quot;https://github.com/lxml/lxml/releases/tag/lxml-${version}&quot;;
    description = &quot;Pythonic binding for the libxml2 and libxslt libraries&quot;;
    homepage = &quot;https://lxml.de&quot;;
    license = lib.licenses.bsd3;
    maintainers = with lib.maintainers; [ sjourdois ];
  };
}
</code></pre><p>In this example <code class="literal">lxml</code> and Nix are able to work out exactly where the relevant
files of the dependencies are. This is not always the case.</p><p>The example below shows bindings to The Fastest Fourier Transform in the West,
commonly known as FFTW. On Nix we have separate packages of FFTW for the
different types of floats (<code class="literal">&quot;single&quot;</code>, <code class="literal">&quot;double&quot;</code>, <code class="literal">&quot;long-double&quot;</code>). The
bindings need all three types, and therefore we add all three as <a class="link" href="index.html#var-stdenv-buildInputs" title="buildInputs" ><code class="literal">buildInputs</code></a>.
The bindings don’t expect to find each of them in a different folder, and
therefore we have to set <code class="literal">LDFLAGS</code> and <code class="literal">CFLAGS</code>.</p><pre><code class="programlisting nix">{
  lib,
  buildPythonPackage,
  fetchPypi,

  # build dependencies
  setuptools,

  # dependencies
  fftw,
  fftwFloat,
  fftwLongDouble,
  numpy,
  scipy,
}:

buildPythonPackage rec {
  pname = &quot;pyfftw&quot;;
  version = &quot;0.9.2&quot;;
  pyproject = true;

  src = fetchPypi {
    inherit pname version;
    hash = &quot;sha256-9ru2r6kwhUCaskiFoaPNuJCfCVoUL01J40byvRt4kHQ=&quot;;
  };

  build-system = [ setuptools ];

  buildInputs = [
    fftw
    fftwFloat
    fftwLongDouble
  ];

  dependencies = [
    numpy
    scipy
  ];

  preConfigure = &#x27;&#x27;
    export LDFLAGS=&quot;-L${fftw.dev}/lib -L${fftwFloat.out}/lib -L${fftwLongDouble.out}/lib&quot;
    export CFLAGS=&quot;-I${fftw.dev}/include -I${fftwFloat.dev}/include -I${fftwLongDouble.dev}/include&quot;
  &#x27;&#x27;;

  # Tests cannot import pyfftw. pyfftw works fine though.
  doCheck = false;

  pythonImportsCheck = [ &quot;pyfftw&quot; ];

  meta = {
    changelog = &quot;https://github.com/pyFFTW/pyFFTW/releases/tag/v${version}&quot;;
    description = &quot;Pythonic wrapper around FFTW, the FFT library, presenting a unified interface for all the supported transforms&quot;;
    homepage = &quot;http://hgomersall.github.com/pyFFTW&quot;;
    license = with lib.licenses; [
      bsd2
      bsd3
    ];
  };
}
</code></pre><p>Note also the line <a class="link" href="index.html#var-stdenv-doCheck" title="doCheck" ><code class="literal">doCheck = false;</code></a>, we explicitly disabled running the test-suite.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="testing-python-packages" class="title" >Testing Python Packages   </h5>  </div> </div></div><p>It is highly encouraged to have testing as part of the package build. This
helps to avoid situations where the package was able to build and install,
but is not usable at runtime.
Your package should provide its own <a class="link" href="index.html#ssec-check-phase" title="The check phase" ><code class="literal">checkPhase</code></a>.</p><div class="note"><h3 class="title">Note</h3><p>The <a class="link" href="index.html#ssec-check-phase" title="The check phase" ><code class="literal">checkPhase</code></a> for python maps to the <code class="literal">installCheckPhase</code> on a
normal derivation. This is due to many python packages not behaving well
to the pre-installed version of the package. Version info, and natively
compiled extensions generally only exist in the install directory, and
thus can cause issues when a test suite asserts on that behavior.</p></div><div class="note"><h3 class="title">Note</h3><p>Tests should only be disabled if they don’t agree with nix
(e.g. external dependencies, network access, flakey tests), however,
as many tests should be enabled as possible. Failing tests can still be
a good indication that the package is not in a valid state.</p></div><div class="note"><h3 class="title">Note</h3><p>We only want to test the functionality of a package. In particular, we are not
interested in coverage, formatting, and type checking. If pytest fails with
<code class="literal">unrecognized arguments: --cov</code>, add <code class="literal">pytest-cov-stub</code> to <code class="literal">nativeCheckInputs</code>
rather than <code class="literal">pytest-cov</code>.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="using-pytest" class="title" >Using pytest   </h5>  </div> </div></div><p>Pytest is the most common test runner for python repositories. A trivial
test run would be:</p><pre><code class="programlisting nix">{
  nativeCheckInputs = [ pytest ];
  checkPhase = &#x27;&#x27;
    runHook preCheck

    pytest

    runHook postCheck
  &#x27;&#x27;;
}
</code></pre><p>However, many repositories’ test suites do not translate well to nix’s build
sandbox, and will generally need many tests to be disabled.</p><p>This is achievable by</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Including paths or test items (<code class="literal">path/to/file.py::MyClass</code> or <code class="literal">path/to/file.py::MyClass::test_method</code>) with positional arguments.</p></li><li class="listitem"><p>Excluding paths with <code class="literal">--ignore</code> or globbed paths with <code class="literal">--ignore-glob</code>.</p></li><li class="listitem"><p>Excluding test items using the <code class="literal">--deselect</code> flag.</p></li><li class="listitem"><p>Including or excluding classes or test methods by their name using the <code class="literal">-k</code> flag.</p></li><li class="listitem"><p>Including or excluding test by their marks using the <code class="literal">-m</code> flag.</p></li></ul></div><p>We highly recommend <code class="literal">pytestCheckHook</code> for an easier and more structural setup.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="using-pytestcheckhook" class="title" >Using pytestCheckHook   </h5>  </div> </div></div><p><code class="literal">pytestCheckHook</code> is a convenient hook which will set up (or configure)
a <a class="link" href="index.html#ssec-check-phase" title="The check phase" ><code class="literal">checkPhase</code></a> to run <code class="literal">pytest</code>. This is also beneficial
when a package may need many items disabled to run the test suite.
Most packages use <code class="literal">pytest</code> or <code class="literal">unittest</code>, which is compatible with <code class="literal">pytest</code>,
so you will most likely use <code class="literal">pytestCheckHook</code>.</p><p>To use <code class="literal">pytestCheckHook</code>, add it to <code class="literal">nativeCheckInputs</code>.
Adding <code class="literal">pytest</code> is not required, since it is included with <code class="literal">pytestCheckHook</code>.</p><pre><code class="programlisting nix">{ nativeCheckInputs = [ pytestCheckHook ]; }
</code></pre><p><code class="literal">pytestCheckHook</code> recognizes the following attributes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">enabledTestPaths</code> and <code class="literal">disabledTestPaths</code></span></dt><dd><p>To specify path globs (files or directories) or test items.</p></dd><dt><span class="term"><code class="literal">enabledTests</code> and <code class="literal">disabledTests</code></span></dt><dd><p>To specify keywords for class names or test method names.</p></dd><dt><span class="term"><code class="literal">enabledTestMarks</code> and <code class="literal">disabledTestMarks</code></span></dt><dd><p>To specify test marks.</p></dd><dt><span class="term"><code class="literal">pytestFlags</code></span></dt><dd><p>To append additional command-line arguments to <code class="literal">pytest</code>.</p></dd></dl></div><p>By default, <code class="literal">pytest</code> automatically discovers which tests to run.
If tests are explicitly enabled, only those tests will run.
A test, that is both enabled and disabled, will not run.</p><p>The following example demonstrates usage of various <code class="literal">pytestCheckHook</code> attributes:</p><pre><code class="programlisting nix">{
  nativeCheckInputs = [ pytestCheckHook ];

  # Allow running the following test paths and test objects.
  enabledTestPaths = [
    # Find tests under the tests directory.
    # The trailing slash is not necessary.
    &quot;tests/&quot;

    # Additionally run test_foo
    &quot;other-tests/test_foo.py::Foo::test_foo&quot;
  ];

  # Override the above-enabled test paths and test objects.
  disabledTestPaths = [
    # Tests under tests/integration requires additional data.
    &quot;tests/integration&quot;
  ];

  # Allow tests by keywords matching their class names or method names.
  enabledTests = [
    # pytest by default only runs test methods begin with &quot;test_&quot; or end with &quot;_test&quot;.
    # This includes all functions whose name contains &quot;test&quot;.
    &quot;test&quot;
  ];

  # Override the above-enabled tests by keywords matching their class names or method names.
  disabledTests = [
    # Tests touching networks.
    &quot;upload&quot;
    &quot;download&quot;
  ];

  # Additional pytest flags
  pytestFlags = [
    # Disable benchmarks and run benchmarking tests only once.
    &quot;--benchmark-disable&quot;
  ];
}
</code></pre><p>These attributes are all passed into the derivation directly
and added to the <code class="literal">pytest</code> command without additional Bash expansion.
It requires <code class="literal">__structuredAttrs = true</code> to pass list elements containing spaces.</p><p>The <code class="literal">&lt;enabled/disabled&gt;TestsPaths</code> attributes expand Unix-style globs.
If a test path contains characters like <code class="literal">*</code>, <code class="literal">?</code>, <code class="literal">[</code>, or <code class="literal">]</code>, you can
quote them with square brackets (<code class="literal">[*]</code>, <code class="literal">[?]</code>, <code class="literal">[[]</code>, and <code class="literal">[]]</code>) to match literally.</p><p>The <code class="literal">&lt;enabled/disabled&gt;Tests</code> and <code class="literal">&lt;enabled/disabled&gt;TestMarks</code> attribute pairs
form a logical expression <code class="literal">((included_element1) or (included_element2)) and not (excluded_element1) and not (excluded_element2)</code>
which will be passed to pytest’s <code class="literal">-k</code> and <code class="literal">-m</code> flags respectively.
With <code class="literal">__structuredAttrs = true</code> enabled, they additionally support sub-expressions.</p><p>For example, you could disable test items like <code class="literal">TestFoo::test_bar_functionality</code>
by disabling tests that match both <code class="literal">&quot;Foo&quot;</code> <span class="strong"><strong>and</strong></span> <code class="literal">&quot;bar&quot;</code>:</p><pre><code class="programlisting nix">{
  __structuredAttrs = true;

  disabledTests = [ &quot;Foo and bar&quot; ];
}
</code></pre><p>The main benefits of using <code class="literal">pytestCheckHook</code> to construct <code class="literal">pytest</code> commands
is structuralization and eval-time accessibility.
This is especially helpful to select tests or specify flags conditionally:</p><pre><code class="programlisting nix">{
  disabledTests = [
    # touches network
    &quot;download&quot;
    &quot;update&quot;
  ]
  ++ lib.optionals (pythonAtLeast &quot;3.8&quot;) [
    # broken due to python3.8 async changes
    &quot;async&quot;
  ]
  ++ lib.optionals stdenv.buildPlatform.isDarwin [
    # can fail when building with other packages
    &quot;socket&quot;
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="using-pythonimportscheck" class="title" >Using pythonImportsCheck   </h5>  </div> </div></div><p>Although unit tests are highly preferred to validate correctness of a package, not
all packages have test suites that can be run easily, and some have none at all.
To help ensure the package still works, <a class="link" href="index.html#using-pythonimportscheck" title="Using pythonImportsCheck" ><code class="literal">pythonImportsCheck</code></a> can attempt to import
the listed modules.</p><pre><code class="programlisting nix">{
  pythonImportsCheck = [
    &quot;requests&quot;
    &quot;urllib&quot;
  ];
}
</code></pre><p>roughly translates to:</p><pre><code class="programlisting nix">{
  postCheck = &#x27;&#x27;
    PYTHONPATH=$out/${python.sitePackages}:$PYTHONPATH
    python -c &quot;import requests; import urllib&quot;
  &#x27;&#x27;;
}
</code></pre><p>However, this is done in its own phase, and not dependent on whether <a class="link" href="index.html#var-stdenv-doCheck" title="doCheck" ><code class="literal">doCheck = true;</code></a>.</p><p>This can also be useful in verifying that the package doesn’t assume commonly
present packages (e.g. <code class="literal">setuptools</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="using-pythonrelaxdepshook" class="title" >Using pythonRelaxDepsHook   </h5>  </div> </div></div><p>It is common for upstream to specify a range of versions for its package
dependencies. This makes sense, since it ensures that the package will be built
with a subset of packages that is well tested. However, this commonly causes
issues when packaging in Nixpkgs, because the dependencies that this package
may need are too new or old for the package to build correctly. We also cannot
package multiple versions of the same package since this may cause conflicts
in <code class="literal">PYTHONPATH</code>.</p><p>One way to side step this issue is to relax the dependencies. This can be done
by either removing the package version range or by removing the package
declaration entirely. This can be done using the <code class="literal">pythonRelaxDepsHook</code> hook. For
example, given the following <code class="literal">requirements.txt</code> file:</p><pre><code class="programlisting">pkg1&lt;1.0
pkg2
pkg3&gt;=1.0,&lt;=2.0
</code></pre><p>we can do:</p><pre><code class="programlisting nix">{
  pythonRelaxDeps = [
    &quot;pkg1&quot;
    &quot;pkg3&quot;
  ];
  pythonRemoveDeps = [ &quot;pkg2&quot; ];
}
</code></pre><p>which would result in the following <code class="literal">requirements.txt</code> file:</p><pre><code class="programlisting">pkg1
pkg3
</code></pre><p>Another option is to pass <code class="literal">true</code>, that will relax/remove all dependencies, for
example:</p><pre><code class="programlisting nix">{ pythonRelaxDeps = true; }
</code></pre><p>which would result in the following <code class="literal">requirements.txt</code> file:</p><pre><code class="programlisting">pkg1
pkg2
pkg3
</code></pre><p>In general you should always use <code class="literal">pythonRelaxDeps</code>, because <code class="literal">pythonRemoveDeps</code>
will convert build errors into runtime errors. However <code class="literal">pythonRemoveDeps</code> may
still be useful in exceptional cases, and also to remove dependencies wrongly
declared by upstream (for example, declaring <code class="literal">black</code> as a runtime dependency
instead of a dev dependency).</p><p>Keep in mind that while the examples above are done with <code class="literal">requirements.txt</code>,
<code class="literal">pythonRelaxDepsHook</code> works by modifying the resulting wheel file, so it should
work with any of the <a class="link" href="index.html#setup-hooks" title="Setup hooks" >existing hooks</a>.</p><p>The <code class="literal">pythonRelaxDepsHook</code> has no effect on build time dependencies, such as
those specified in <code class="literal">build-system</code>. If a package requires incompatible build
time dependencies, they should be removed in <code class="literal">postPatch</code> through
<code class="literal">substituteInPlace</code> or similar.</p><p>For ease of use, both <code class="literal">buildPythonPackage</code> and <code class="literal">buildPythonApplication</code> will
automatically add <code class="literal">pythonRelaxDepsHook</code> if either <code class="literal">pythonRelaxDeps</code> or
<code class="literal">pythonRemoveDeps</code> is specified.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="using-unittestcheckhook" class="title" >Using unittestCheckHook   </h5>  </div> </div></div><p><code class="literal">unittestCheckHook</code> is a hook which will set up (or configure) a <a class="link" href="index.html#ssec-check-phase" title="The check phase" ><code class="literal">checkPhase</code></a> to run <code class="literal">python -m unittest discover</code>:</p><pre><code class="programlisting nix">{
  nativeCheckInputs = [ unittestCheckHook ];

  unittestFlags = [
    &quot;-s&quot;
    &quot;tests&quot;
    &quot;-v&quot;
  ];
}
</code></pre><p><code class="literal">pytest</code> is compatible with <code class="literal">unittest</code>, so in most cases you can use <code class="literal">pytestCheckHook</code> instead.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="using-sphinxhook" class="title" >Using sphinxHook   </h5>  </div> </div></div><p>The <code class="literal">sphinxHook</code> is a helpful tool to build documentation and manpages
using the popular Sphinx documentation generator.
It is setup to automatically find common documentation source paths and
render them using the default <code class="literal">html</code> style.</p><pre><code class="programlisting nix">{
  outputs = [
    &quot;out&quot;
    &quot;doc&quot;
  ];

  nativeBuildInputs = [ sphinxHook ];
}
</code></pre><p>The hook will automatically build and install the artifact into the
<code class="literal">doc</code> output, if it exists. It also provides an automatic diversion
for the artifacts of the <code class="literal">man</code> builder into the <code class="literal">man</code> target.</p><pre><code class="programlisting nix">{
  outputs = [
    &quot;out&quot;
    &quot;doc&quot;
    &quot;man&quot;
  ];

  # Use multiple builders
  sphinxBuilders = [
    &quot;singlehtml&quot;
    &quot;man&quot;
  ];
}
</code></pre><p>Overwrite <code class="literal">sphinxRoot</code> when the hook is unable to find your
documentation source root.</p><pre><code class="programlisting nix">{
  # Configure sphinxRoot for uncommon paths
  sphinxRoot = &quot;weird/docs/path&quot;;
}
</code></pre><p>The hook is also available to packages outside the python ecosystem by
referencing it using <code class="literal">sphinxHook</code> from top-level.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="organising-your-packages" class="title" >Organising your packages   </h4>  </div> </div></div><p>So far we discussed how you can use Python on Nix, and how you can develop with
it. We’ve looked at how you write expressions to package Python packages, and we
looked at how you can create environments in which specified packages are
available.</p><p>At some point you’ll likely have multiple packages which you would
like to be able to use in different projects. In order to minimise unnecessary
duplication we now look at how you can maintain a repository with your
own packages. The important functions here are <code class="literal">import</code> and <code class="literal">callPackage</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="including-a-derivation-using-callpackage" class="title" >Including a derivation using <code class="literal">callPackage</code>   </h4>  </div> </div></div><p>Earlier we created a Python environment using <a class="link" href="index.html#python.withpackages-function" title="python.withPackages function" ><code class="literal">withPackages</code></a>, and included the
<code class="literal">toolz</code> package via a <code class="literal">let</code> expression.
Let’s split the package definition from the environment definition.</p><p>We first create a function that builds <code class="literal">toolz</code> in <code class="literal">~/path/to/toolz/release.nix</code></p><pre><code class="programlisting nix">{
  lib,
  buildPythonPackage,
  fetchPypi,
  setuptools,
}:

buildPythonPackage rec {
  pname = &quot;toolz&quot;;
  version = &quot;0.10.0&quot;;
  pyproject = true;

  src = fetchPypi {
    inherit pname version;
    hash = &quot;sha256-CP3V73yWSArRHBLUct4hrNMjWZlvaaUlkpm1QP66RWA=&quot;;
  };

  build-system = [ setuptools ];

  meta = {
    changelog = &quot;https://github.com/pytoolz/toolz/releases/tag/${version}&quot;;
    homepage = &quot;https://github.com/pytoolz/toolz/&quot;;
    description = &quot;List processing tools and functional utilities&quot;;
    license = lib.licenses.bsd3;
  };
}
</code></pre><p>It takes an argument <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a>. We now call this function using
<code class="literal">callPackage</code> in the definition of our environment</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

(
  let
    toolz = callPackage /path/to/toolz/release.nix {
      buildPythonPackage = python3Packages.buildPythonPackage;
    };
  in
  python3.withPackages (ps: [
    ps.numpy
    toolz
  ])
).env
</code></pre><p>Important to remember is that the Python version for which the package is made
depends on the <code class="literal">python</code> derivation that is passed to <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a>. Nix
tries to automatically pass arguments when possible, which is why generally you
don’t explicitly define which <code class="literal">python</code> derivation should be used. In the above
example we use <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> that is part of the set <code class="literal">python3Packages</code>,
and in this case the <code class="literal">python3</code> interpreter is automatically used.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="faq" class="title" >FAQ   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="how-to-solve-circular-dependencies" class="title" >How to solve circular dependencies?   </h4>  </div> </div></div><p>Consider the packages <code class="literal">A</code> and <code class="literal">B</code> that depend on each other. When packaging <code class="literal">B</code>,
a solution is to override package <code class="literal">A</code> not to depend on <code class="literal">B</code> as an input. The same
should also be done when packaging <code class="literal">A</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="how-to-override-a-python-package" class="title" >How to override a Python package?   </h4>  </div> </div></div><p>We can override the interpreter and pass <code class="literal">packageOverrides</code>. In the following
example we rename the <code class="literal">pandas</code> package and build it.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

(
  let
    python =
      let
        packageOverrides = self: super: {
          pandas = super.pandas.overridePythonAttrs (old: {
            name = &quot;foo&quot;;
          });
        };
      in
      pkgs.python310.override { inherit packageOverrides; };

  in
  python.withPackages (ps: [ ps.pandas ])
).env
</code></pre><p>Using <code class="literal">nix-build</code> on this expression will build an environment that contains the
package <code class="literal">pandas</code> but with the new name <code class="literal">foo</code>.</p><p>All packages in the package set will use the renamed package. A typical use case
is to switch to another version of a certain package. For example, in the
Nixpkgs repository we have multiple versions of <code class="literal">django</code> and <code class="literal">scipy</code>. In the
following example we use a different version of <code class="literal">scipy</code> and create an
environment that uses it. All packages in the Python package set will now use
the updated <code class="literal">scipy</code> version.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

(
  let
    packageOverrides = self: super: { scipy = super.scipy_0_17; };
  in
  (pkgs.python310.override { inherit packageOverrides; }).withPackages (ps: [ ps.blaze ])
).env
</code></pre><p>The requested package <code class="literal">blaze</code> depends on <code class="literal">pandas</code> which itself depends on <code class="literal">scipy</code>.</p><p>If you want the whole of Nixpkgs to use your modifications, then you can use
<code class="literal">overlays</code> as explained in this manual. In the following example we build a
<code class="literal">inkscape</code> using a different version of <code class="literal">numpy</code>.</p><pre><code class="programlisting nix">let
  pkgs = import &lt;nixpkgs&gt; { };
  newpkgs = import pkgs.path {
    overlays = [
      (self: super: {
        python310 =
          let
            packageOverrides = python-self: python-super: {
              numpy = python-super.numpy_1_18;
            };
          in
          super.python310.override { inherit packageOverrides; };
      })
    ];
  };
in
newpkgs.inkscape
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="python-setup.py-bdist_wheel-cannot-create-.whl" class="title" ><code class="literal">python setup.py bdist_wheel</code> cannot create .whl   </h4>  </div> </div></div><p>Executing <code class="literal">python setup.py bdist_wheel</code> in a <code class="literal">nix-shell</code>fails with</p><pre><code class="programlisting">ValueError: ZIP does not support timestamps before 1980
</code></pre><p>This is because files from the Nix store (which have a timestamp of the UNIX
epoch of January 1, 1970) are included in the .ZIP, but .ZIP archives follow the
DOS convention of counting timestamps from 1980.</p><p>The command <code class="literal">bdist_wheel</code> reads the <code class="literal">SOURCE_DATE_EPOCH</code> environment variable,
which <code class="literal">nix-shell</code> sets to 1. Unsetting this variable or giving it a value
corresponding to 1980 or later enables building wheels.</p><p>Use 1980 as timestamp:</p><pre><code class="programlisting shell">nix-shell --run &quot;SOURCE_DATE_EPOCH=315532800 python3 setup.py bdist_wheel&quot;
</code></pre><p>or the current time:</p><pre><code class="programlisting shell">nix-shell --run &quot;SOURCE_DATE_EPOCH=$(date +%s) python3 setup.py bdist_wheel&quot;
</code></pre><p>or unset <code class="literal">SOURCE_DATE_EPOCH</code>:</p><pre><code class="programlisting shell">nix-shell --run &quot;unset SOURCE_DATE_EPOCH; python3 setup.py bdist_wheel&quot;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="install_data-data_files-problems" class="title" ><code class="literal">install_data</code> / <code class="literal">data_files</code> problems   </h4>  </div> </div></div><p>If you get the following error:</p><pre><code class="programlisting">could not create &#x27;/nix/store/6l1bvljpy8gazlsw2aw9skwwp4pmvyxw-python-2.7.8/etc&#x27;:
Permission denied
</code></pre><p>This is a <a class="link" href="https://github.com/pypa/setuptools/issues/130"  target="_top">known bug</a> in
<code class="literal">setuptools</code>. Setuptools <code class="literal">install_data</code> does not respect <code class="literal">--prefix</code>. An example
of such package using the feature is <code class="literal">pkgs/tools/X11/xpra/default.nix</code>.</p><p>As workaround install it as an extra <code class="literal">preInstall</code> step:</p><pre><code class="programlisting shell">${python.pythonOnBuildForHost.interpreter} setup.py install_data --install-dir=$out --root=$out
sed -i &#x27;/ = data\_files/d&#x27; setup.py
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="rationale-of-non-existent-global-site-packages" class="title" >Rationale of non-existent global site-packages   </h4>  </div> </div></div><p>On most operating systems a global <code class="literal">site-packages</code> is maintained. This however
becomes problematic if you want to run multiple Python versions or have multiple
versions of certain libraries for your projects. Generally, you would solve such
issues by creating virtual environments using <code class="literal">virtualenv</code>.</p><p>On Nix each package has an isolated dependency tree which, in the case of
Python, guarantees the right versions of the interpreter and libraries or
packages are available. There is therefore no need to maintain a global <code class="literal">site-packages</code>.</p><p>If you want to create a Python environment for development, then the recommended
method is to use <code class="literal">nix-shell</code>, either with or without the <a class="link" href="index.html#python.buildenv-function" title="python.buildEnv function" ><code class="literal">python.buildEnv</code></a>
function.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="how-to-consume-python-modules-using-pip-in-a-virtual-environment-like-i-am-used-to-on-other-operating-systems" class="title" >How to consume Python modules using pip in a virtual environment like I am used to on other Operating Systems?   </h4>  </div> </div></div><p>While this approach is not very idiomatic from Nix perspective, it can still be
useful when dealing with pre-existing projects or in situations where it’s not
feasible or desired to write derivations for all required dependencies.</p><p>This is an example of a <code class="literal">default.nix</code> for a <code class="literal">nix-shell</code>, which allows to consume
a virtual environment created by <code class="literal">venv</code>, and install Python modules through
<code class="literal">pip</code> the traditional way.</p><p>Create this <code class="literal">default.nix</code> file, together with a <code class="literal">requirements.txt</code> and
execute <code class="literal">nix-shell</code>.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

let
  pythonPackages = python3Packages;
in
pkgs.mkShell rec {
  name = &quot;impurePythonEnv&quot;;
  venvDir = &quot;./.venv&quot;;
  buildInputs = [
    # A Python interpreter including the &#x27;venv&#x27; module is required to bootstrap
    # the environment.
    pythonPackages.python

    # This executes some shell code to initialize a venv in $venvDir before
    # dropping into the shell
    pythonPackages.venvShellHook

    # Those are dependencies that we would like to use from nixpkgs, which will
    # add them to PYTHONPATH and thus make them accessible from within the venv.
    pythonPackages.numpy
    pythonPackages.requests

    # In this particular example, in order to compile any binary extensions they may
    # require, the Python modules listed in the hypothetical requirements.txt need
    # the following packages to be installed locally:
    taglib
    openssl
    git
    libxml2
    libxslt
    libzip
    zlib
  ];

  # Run this command, only after creating the virtual environment
  postVenvCreation = &#x27;&#x27;
    unset SOURCE_DATE_EPOCH
    pip install -r requirements.txt
  &#x27;&#x27;;

  # Now we can execute any commands within the virtual environment.
  # This is optional and can be left out to run pip manually.
  postShellHook = &#x27;&#x27;
    # allow pip to install wheels
    unset SOURCE_DATE_EPOCH
  &#x27;&#x27;;

}
</code></pre><p>In case the supplied venvShellHook is insufficient, or when Python 2 support is
needed, you can define your own shell hook and adapt to your needs like in the
following example:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

let
  venvDir = &quot;./.venv&quot;;
  pythonPackages = python3Packages;
in
pkgs.mkShell rec {
  name = &quot;impurePythonEnv&quot;;
  buildInputs = [
    pythonPackages.python
    # Needed when using python 2.7
    # pythonPackages.virtualenv
    # ...
  ];

  # This is very close to how venvShellHook is implemented, but
  # adapted to use &#x27;virtualenv&#x27;
  shellHook = &#x27;&#x27;
    SOURCE_DATE_EPOCH=$(date +%s)

    if [ -d &quot;${venvDir}&quot; ]; then
      echo &quot;Skipping venv creation, &#x27;${venvDir}&#x27; already exists&quot;
    else
      echo &quot;Creating new venv environment in path: &#x27;${venvDir}&#x27;&quot;
      # Note that the module venv was only introduced in python 3, so for 2.7
      # this needs to be replaced with a call to virtualenv
      ${pythonPackages.python.interpreter} -m venv &quot;${venvDir}&quot;
    fi

    # Under some circumstances it might be necessary to add your virtual
    # environment to PYTHONPATH, which you can do here too;
    # PYTHONPATH=$PWD/${venvDir}/${pythonPackages.python.sitePackages}/:$PYTHONPATH

    source &quot;${venvDir}/bin/activate&quot;

    # As in the previous example, this is optional.
    pip install -r requirements.txt
  &#x27;&#x27;;
}
</code></pre><p>Note that the <code class="literal">pip install</code> is an imperative action. So every time <code class="literal">nix-shell</code>
is executed it will attempt to download the Python modules listed in
requirements.txt. However these will be cached locally within the <code class="literal">virtualenv</code>
folder and not downloaded again.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="how-to-override-a-python-package-from-configuration.nix" class="title" >How to override a Python package from <code class="literal">configuration.nix</code>?   </h4>  </div> </div></div><p>If you need to change a package’s attribute(s) from <code class="literal">configuration.nix</code> you could do:</p><pre><code class="programlisting nix">{
  nixpkgs.config.packageOverrides = super: {
    python3 = super.python3.override {
      packageOverrides = python-self: python-super: {
        twisted = python-super.twisted.overridePythonAttrs (oldAttrs: {
          src = super.fetchPypi {
            pname = &quot;Twisted&quot;;
            version = &quot;19.10.0&quot;;
            hash = &quot;sha256-c5S6fycq5yKnTz2Wnc9Zm8TvCTvDkgOHSKSQ8XJKUV0=&quot;;
            extension = &quot;tar.bz2&quot;;
          };
        });
      };
    };
  };
}
</code></pre><p><code class="literal">python3Packages.twisted</code> is now globally overridden.
All packages and also all NixOS services that reference <code class="literal">twisted</code>
(such as <code class="literal">services.buildbot-worker</code>) now use the new definition.
Note that <code class="literal">python-super</code> refers to the old package set and <code class="literal">python-self</code>
to the new, overridden version.</p><p>To modify only a Python package set instead of a whole Python derivation, use
this snippet:</p><pre><code class="programlisting nix">{
  myPythonPackages = python3Packages.override { overrides = self: super: { twisted = &lt;...&gt;; }; };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="how-to-override-a-python-package-using-overlays" class="title" >How to override a Python package using overlays?   </h4>  </div> </div></div><p>Use the following overlay template:</p><pre><code class="programlisting nix">self: super: {
  python = super.python.override {
    packageOverrides = python-self: python-super: {
      twisted = python-super.twisted.overrideAttrs (oldAttrs: {
        src = super.fetchPypi {
          pname = &quot;Twisted&quot;;
          version = &quot;19.10.0&quot;;
          hash = &quot;sha256-c5S6fycq5yKnTz2Wnc9Zm8TvCTvDkgOHSKSQ8XJKUV0=&quot;;
          extension = &quot;tar.bz2&quot;;
        };
      });
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="how-to-override-a-python-package-for-all-python-versions-using-extensions" class="title" >How to override a Python package for all Python versions using extensions?   </h4>  </div> </div></div><p>The following overlay overrides the call to <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> for the
<code class="literal">foo</code> package for all interpreters by appending a Python extension to the
<code class="literal">pythonPackagesExtensions</code> list of extensions.</p><pre><code class="programlisting nix">final: prev: {
  pythonPackagesExtensions = prev.pythonPackagesExtensions ++ [
    (python-final: python-prev: {
      foo = python-prev.foo.overridePythonAttrs (oldAttrs: {
        # ...
      });
    })
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="how-to-use-intels-mkl-with-numpy-and-scipy" class="title" >How to use Intel’s MKL with numpy and scipy?   </h4>  </div> </div></div><p>MKL can be configured using an overlay. See the section “<a class="link" href="index.html#sec-overlays-alternatives-blas-lapack" title="BLAS/LAPACK" >Using overlays to
configure alternatives</a>”.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="what-inputs-do-setup_requires-install_requires-and-tests_require-map-to" class="title" >What inputs do <code class="literal">setup_requires</code>, <code class="literal">install_requires</code> and <code class="literal">tests_require</code> map to?   </h4>  </div> </div></div><p>In a <code class="literal">setup.py</code> or <code class="literal">setup.cfg</code> it is common to declare dependencies:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">setup_requires</code> corresponds to <code class="literal">build-system</code></p></li><li class="listitem"><p><code class="literal">install_requires</code> corresponds to <code class="literal">dependencies</code></p></li><li class="listitem"><p><code class="literal">tests_require</code> corresponds to <a class="link" href="index.html#var-stdenv-nativeCheckInputs" title="nativeCheckInputs" ><code class="literal">nativeCheckInputs</code></a></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="optimizations" class="title" >How to enable interpreter optimizations?   </h4>  </div> </div></div><p>The Python interpreters are by default not built with optimizations enabled, because
the builds are in that case not reproducible. To enable optimizations, override the
interpreter of interest, e.g using</p><pre><code class="programlisting nix">let
  pkgs = import ./. { };
  mypython = pkgs.python3.override {
    enableOptimizations = true;
    reproducibleBuild = false;
    self = mypython;
  };
in
mypython
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="python-optional-dependencies" class="title" >How to add optional dependencies?   </h4>  </div> </div></div><p>Some packages define optional dependencies for additional features. With
<code class="literal">setuptools</code> this is called <code class="literal">extras_require</code> and <code class="literal">flit</code> calls it
<code class="literal">extras-require</code>, while PEP 621 calls these <code class="literal">optional-dependencies</code>.</p><pre><code class="programlisting nix">{
  optional-dependencies = {
    complete = [ distributed ];
  };
}
</code></pre><p>and letting the package requiring the extra add the list to its dependencies</p><pre><code class="programlisting nix">{
  dependencies = [
    # ...
  ]
  ++ dask.optional-dependencies.complete;
}
</code></pre><p>This method is using <code class="literal">passthru</code>, meaning that changing <code class="literal">optional-dependencies</code> of a package won’t cause it to rebuild.</p><p>Note this method is preferred over adding parameters to builders, as that can
result in packages depending on different variants and thereby causing
collisions.</p><div class="note"><h3 class="title">Note</h3><p>The <code class="literal">optional-dependencies</code> attribute should only be used for dependency groups
as defined in package metadata. If a package gracefully handles missing
dependencies in runtime but doesn’t advertise it through package metadata, then
these dependencies should not be listed at all. (One may still have to list
them in <code class="literal">nativeCheckInputs</code> to pass test suite.)</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="tools" class="title" >How to contribute a Python package to nixpkgs?   </h4>  </div> </div></div><p>Packages inside nixpkgs must use the <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> or <a class="link" href="index.html#buildpythonapplication-function" title="buildPythonApplication function" ><code class="literal">buildPythonApplication</code></a> function directly,
because we can only provide security support for non-vendored dependencies.</p><p>We recommend <a class="link" href="https://github.com/nix-community/nix-init"  target="_top">nix-init</a> for creating new python packages within nixpkgs,
as it already prefetches the source, parses dependencies for common formats and prefills most things in <code class="literal">meta</code>.
When using the tool, pull from the original source repository instead of PyPI, if possible.</p><p>See also <a class="link" href="index.html#contributing" title="Contributing" >contributing section</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="deterministic-builds" class="title" >Are Python interpreters built deterministically?   </h4>  </div> </div></div><p>The Python interpreters are now built deterministically. Minor modifications had
to be made to the interpreters in order to generate deterministic bytecode. This
has security implications and is relevant for those using Python in a
<code class="literal">nix-shell</code>.</p><p>When the environment variable <code class="literal">DETERMINISTIC_BUILD</code> is set, all bytecode will
have timestamp 1. The <a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a> function sets <code class="literal">DETERMINISTIC_BUILD=1</code>
and <a class="link" href="https://docs.python.org/3.13/using/cmdline.html#envvar-PYTHONHASHSEED"  target="_top">PYTHONHASHSEED=0</a>.
Both are also exported in <code class="literal">nix-shell</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="automatic-tests" class="title" >How to provide automatic tests to Python packages?   </h4>  </div> </div></div><p>It is recommended to test packages as part of the build process.
Source distributions (<code class="literal">sdist</code>) often include test files, but not always.</p><p>The best practice today is to pass a test hook (e.g. pytestCheckHook, unittestCheckHook) into nativeCheckInputs.
This will reconfigure the checkPhase to make use of that particular test framework.
Occasionally packages don’t make use of a common test framework, which may then require a custom checkPhase.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="common-issues" class="title" >Common issues   </h5>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Tests that attempt to access <code class="literal">$HOME</code> can be fixed by using <code class="literal">writableTmpDirAsHomeHook</code> in
<code class="literal">nativeCheckInputs</code>, which sets up a writable temporary directory as the home directory. Alternatively,
you can achieve the same effect manually (e.g. in <code class="literal">preCheck</code>) with: <code class="literal">export HOME=$(mktemp -d)</code>.</p></li><li class="listitem"><p>Compiling with Cython causes tests to fail with a <code class="literal">ModuleNotLoadedError</code>.
This can be fixed with two changes in the derivation: 1) replacing <code class="literal">pytest</code> with
<code class="literal">pytestCheckHook</code> and 2) adding a <code class="literal">preCheck</code> containing <code class="literal">cd $out</code> to run
tests within the built output.</p></li></ul></div>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="contributing" class="title" >Contributing   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="contributing-guidelines" class="title" >Contributing guidelines   </h4>  </div> </div></div><p>The following rules are desired to be respected:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Python libraries are called from <code class="literal">python-packages.nix</code> and packaged with
<a class="link" href="index.html#buildpythonpackage-function" title="buildPythonPackage function" ><code class="literal">buildPythonPackage</code></a>. The expression of a library should be in
<code class="literal">pkgs/development/python-modules/&lt;name&gt;/default.nix</code>.</p></li><li class="listitem"><p>Python applications live outside of <code class="literal">python-packages.nix</code> and are packaged
with <a class="link" href="index.html#buildpythonapplication-function" title="buildPythonApplication function" ><code class="literal">buildPythonApplication</code></a>.</p></li><li class="listitem"><p>Make sure libraries build for all Python interpreters.
If it fails to build on some Python versions, consider disabling them by setting <code class="literal">disable = pythonAtLeast &quot;3.x&quot;</code> along with a comment.</p></li><li class="listitem"><p>The two parameters, <code class="literal">pyproject</code> and <code class="literal">build-system</code> are set to avoid the legacy setuptools/distutils build.</p></li><li class="listitem"><p>Only unversioned attributes (e.g. <code class="literal">pydantic</code>, but not <code class="literal">pypdantic_1</code>) can be included in <code class="literal">dependencies</code>,
since due to <code class="literal">PYTHONPATH</code> limitations we can only ever support a single version for libraries
without running into duplicate module name conflicts.</p></li><li class="listitem"><p>The version restrictions of <code class="literal">dependencies</code> can be relaxed by <a class="link" href="index.html#using-pythonrelaxdepshook" title="Using pythonRelaxDepsHook" ><code class="literal">pythonRelaxDepsHook</code></a>.</p></li><li class="listitem"><p>Make sure the tests are enabled using for example <a class="link" href="index.html#using-pytestcheckhook" title="Using pytestCheckHook" ><code class="literal">pytestCheckHook</code></a> and, in the case of
libraries, are passing for all interpreters. If certain tests fail they can be
disabled individually. Try to avoid disabling the tests altogether. In any
case, when you disable tests, leave a comment explaining not only <span class="emphasis"><em>what</em></span> the failure
is but <span class="emphasis"><em>why</em></span> the test failure can be ignored for safe distribution with nixpkgs.</p></li><li class="listitem"><p><code class="literal">pythonImportsCheck</code> is set. This is still a good smoke test even if <code class="literal">pytestCheckHook</code> is set.</p></li><li class="listitem"><p><code class="literal">meta.platforms</code> takes the default value in many cases.
It does not need to be set explicitly unless the package requires a specific platform.</p></li><li class="listitem"><p>The file is formatted with <code class="literal">nixfmt-rfc-style</code>.</p></li><li class="listitem"><p>Commit names of Python libraries must reflect that they are Python
libraries (e.g. <code class="literal">python313Packages.numpy: 1.11 -&gt; 1.12</code> rather than <code class="literal">numpy: 1.11 -&gt; 1.12</code>).</p></li><li class="listitem"><p>The current default version of python should be included
in commit messages to enable automatic builds by ofborg.
For example <code class="literal">python313Packages.numpy: 1.11 -&gt; 1.12</code> should be used rather
than <code class="literal">python3Packages.numpy: 1.11 -&gt; 1.12</code>.
Note that <code class="literal">pythonPackages</code> is an alias for <code class="literal">python27Packages</code>.</p></li><li class="listitem"><p>Attribute names in <code class="literal">python-packages.nix</code> as well as <code class="literal">pname</code>s should match the
library’s name on PyPI, but be normalized according to <a class="link" href="https://www.python.org/dev/peps/pep-0503/#normalized-names"  target="_top">PEP
0503</a>. This means
that characters should be converted to lowercase and <code class="literal">.</code> and <code class="literal">_</code> should be
replaced by a single <code class="literal">-</code> (foo-bar-baz instead of Foo__Bar.baz).
If necessary, <code class="literal">pname</code> has to be given a different value within <code class="literal">fetchPypi</code>.</p></li><li class="listitem"><p>It’s generally preferable to fetch <code class="literal">src</code> directly from the repo and not from
PyPI. Use <code class="literal">fetchPypi</code> when there’s a clear technical reason to do so.</p></li><li class="listitem"><p>Packages from sources such as GitHub and GitLab that do not exist on PyPI
should not use a name that is already used on PyPI. When possible, they should
use the package repository name prefixed with the owner (e.g. organization) name
and using a <code class="literal">-</code> as delimiter.</p></li><li class="listitem"><p>Attribute names in <code class="literal">python-packages.nix</code> should be sorted alphanumerically to
avoid merge conflicts and ease locating attributes.</p></li><li class="listitem"><p>Non-python runtime dependencies should be added via explicit wrapping or
patching (using e.g. <code class="literal">substituteInPlace</code>), rather than through propagation via
<code class="literal">dependencies</code>/<code class="literal">propagatedBuildInputs</code>, to reduce clutter in <code class="literal">$PATH</code>.</p></li></ul></div><p>This list is useful for reviewers as well as for self-checking when submitting packages.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="python-package-set-maintenance" class="title" >Package set maintenance   </h3>  </div> </div></div><p>The whole Python package set has a lot of packages that do not see regular
updates, because they either are a very fragile component in the Python
ecosystem, like for example the <code class="literal">hypothesis</code> package, or packages that have
no maintainer, so maintenance falls back to the package set maintainers.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="python-package-bulk-updates" class="title" >Updating packages in bulk   </h4>  </div> </div></div><p>A tool to bulk-update numerous Python libraries is available in the
repository at <code class="literal">maintainers/scripts/update-python-libraries</code>.</p><p>It can quickly update minor or major versions for all packages selected
and create update commits, and supports the <code class="literal">fetchPypi</code>, <code class="literal">fetchurl</code> and
<code class="literal">fetchFromGitHub</code> fetchers. When updating lots of packages that are
hosted on GitHub, exporting a <code class="literal">GITHUB_API_TOKEN</code> is highly recommended.</p><p>Updating packages in bulk leads to lots of breakages, which is why a
stabilization period on the <code class="literal">python-updates</code> branch is required.</p><p>If a package is fragile and often breaks during these bulks updates, it
may be reasonable to set <code class="literal">passthru.skipBulkUpdate = true</code> in the
derivation. This decision should not be made on a whim and should
always be supported by a qualifying comment.</p><p>Once the branch is sufficiently stable it should normally be merged
into the <code class="literal">staging</code> branch.</p><p>An exemplary call to update all python libraries between minor versions
would be:</p><pre><code class="programlisting ShellSession">$ maintainers/scripts/update-python-libraries --target minor --commit --use-pkgs-prefix pkgs/development/python-modules/**/default.nix
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="python-cpython-update-schedule" class="title" >CPython Update Schedule   </h3>  </div> </div></div><p>With <a class="link" href="https://www.python.org/dev/peps/pep-0602/"  target="_top">PEP 602</a>, CPython now
follows a yearly release cadence. In nixpkgs, all supported interpreters
are made available, but only the most recent two
interpreters package sets are built; this is a compromise between being
the latest interpreter, and what the majority of the Python packages support.</p><p>New CPython interpreters are released in October. Generally, it takes some
time for the majority of active Python projects to support the latest stable
interpreter. To help ease the migration for Nixpkgs users
between Python interpreters the schedule below will be used:</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">When</th><th align="left">Event</th></tr></thead><tbody><tr><td align="left">After YY.11 Release</td><td align="left">Bump CPython package set window. The latest and previous latest stable should now be built.</td></tr><tr><td align="left">After YY.05 Release</td><td align="left">Bump default CPython interpreter to latest stable.</td></tr></tbody></table></div><p>In practice, this means that the Python community will have had a stable interpreter
for ~2 months before attempting to update the package set. And this will
allow for ~7 months for Python applications to support the latest interpreter.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-qt" class="title" style="clear: both">Qt   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#qt-default-nix">Nix expression for a Qt package (default.nix)</a> </span></dt><dt> <span class="section">  <a href="index.html#qt-versions">Packages supporting multiple Qt versions</a> </span></dt><dt> <span class="section">  <a href="index.html#qt-runtime-dependencies">Locating additional runtime dependencies</a> </span></dt> </dl></div><p>Writing Nix expressions for Qt libraries and applications is largely similar as for other C++ software.
This section assumes some knowledge of the latter.</p><p>The major caveat with Qt applications is that Qt uses a plugin system to load additional modules at runtime.
In Nixpkgs, we wrap Qt applications to inject environment variables telling Qt where to discover the required plugins and QML modules.</p><p>This effectively makes the runtime dependencies pure and explicit at build-time, at the cost of introducing
an extra indirection.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="qt-default-nix" class="title" >Nix expression for a Qt package (default.nix)   </h3>  </div> </div></div><pre><code class="programlisting nix">{ stdenv, qt6 }:

stdenv.mkDerivation {
  pname = &quot;myapp&quot;;
  version = &quot;1.0&quot;;

  buildInputs = [ qt6.qtbase ];
  nativeBuildInputs = [ qt6.wrapQtAppsHook ];
}
</code></pre><p>The same goes for Qt 5 where libraries and tools are under <code class="literal">libsForQt5</code>.</p><p>Any Qt package should include <code class="literal">wrapQtAppsHook</code> or <code class="literal">wrapQtAppsNoGuiHook</code> in <code class="literal">nativeBuildInputs</code>, or explicitly set <code class="literal">dontWrapQtApps</code> to bypass generating the wrappers.</p><div class="note"><h3 class="title">Note</h3><p><code class="literal">wrapQtAppsHook</code> propagates plugins and QML components from <code class="literal">qtwayland</code> on platforms that support it, to allow applications to act as native Wayland clients. It should be used for all graphical applications.</p><p><code class="literal">wrapQtAppsNoGuiHook</code> does not propagate <code class="literal">qtwayland</code> to reduce closure size for purely command-line applications.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="qt-versions" class="title" >Packages supporting multiple Qt versions   </h3>  </div> </div></div><p>If your package is a library that can be built with multiple Qt versions, you may want to take Qt modules as separate arguments (<code class="literal">qtbase</code>, <code class="literal">qtdeclarative</code> etc.), and invoke the package from <code class="literal">pkgs/top-level/qt5-packages.nix</code> or <code class="literal">pkgs/top-level/qt6-packages.nix</code> using the respective <code class="literal">callPackage</code> functions.</p><p>Applications should generally be built with upstream’s preferred Qt version.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="qt-runtime-dependencies" class="title" >Locating additional runtime dependencies   </h3>  </div> </div></div><p>Add entries to <code class="literal">qtWrapperArgs</code> are to modify the wrappers created by
<code class="literal">wrapQtAppsHook</code>:</p><pre><code class="programlisting nix">{ stdenv, qt6 }:

stdenv.mkDerivation {
  # ...
  nativeBuildInputs = [ qt6.wrapQtAppsHook ];
  qtWrapperArgs = [ &quot;--prefix PATH : /path/to/bin&quot; ];
}
</code></pre><p>The entries are passed as arguments to <a class="link" href="index.html#fun-wrapProgram" title="wrapProgram &lt;executable&gt; &lt;makeWrapperArgs&gt;" >wrapProgram</a>.</p><p>If you need more control over the wrapping process, set <code class="literal">dontWrapQtApps</code> to disable automatic wrapper generation,
and then create wrappers manually in <code class="literal">fixupPhase</code>, using <code class="literal">wrapQtApp</code>, which itself is a small wrapper over <a class="link" href="index.html#fun-wrapProgram" title="wrapProgram &lt;executable&gt; &lt;makeWrapperArgs&gt;" >wrapProgram</a>:</p><p>The <code class="literal">makeWrapper</code> arguments required for Qt are also exposed in the environment as <code class="literal">$qtWrapperArgs</code>.</p><pre><code class="programlisting nix">{
  stdenv,
  lib,
  wrapQtAppsHook,
}:

stdenv.mkDerivation {
  # ...
  nativeBuildInputs = [ wrapQtAppsHook ];
  dontWrapQtApps = true;
  preFixup = &#x27;&#x27;
    wrapQtApp &quot;$out/bin/myapp&quot; --prefix PATH : /path/to/bin
  &#x27;&#x27;;
}
</code></pre><div class="note"><h3 class="title">Note</h3><p><code class="literal">wrapQtAppsHook</code> ignores files that are non-ELF executables.
This means that scripts won’t be automatically wrapped so you’ll need to manually wrap them as previously mentioned.
An example of when you’d always need to do this is with Python applications that use PyQt.</p></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="r" class="title" style="clear: both">R   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#installation">Installation</a> </span></dt><dt> <span class="section">  <a href="index.html#rstudio">RStudio</a> </span></dt><dt> <span class="section">  <a href="index.html#updating-the-package-set">Updating the package set</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="installation" class="title" >Installation   </h3>  </div> </div></div><p>Define an environment for R that contains all the libraries that you’d like to
use by adding the following snippet to your $HOME/.config/nixpkgs/config.nix file:</p><pre><code class="programlisting nix">{
  packageOverrides =
    super:
    let
      self = super.pkgs;
    in
    {

      rEnv = super.rWrapper.override {
        packages = with self.rPackages; [
          devtools
          ggplot2
          reshape2
          yaml
          optparse
        ];
      };
    };
}
</code></pre><p>Then you can use <code class="literal">nix-env -f &quot;&lt;nixpkgs&gt;&quot; -iA rEnv</code> to install it into your user
profile. The set of available libraries can be discovered by running the
command <code class="literal">nix-env -f &quot;&lt;nixpkgs&gt;&quot; -qaP -A rPackages</code>. The first column from that
output is the name that has to be passed to rWrapper in the code snipped above.</p><p>However, if you’d like to add a file to your project source to make the
environment available for other contributors, you can create a <code class="literal">default.nix</code>
file like so:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };
{
  myProject = stdenv.mkDerivation {
    name = &quot;myProject&quot;;
    version = &quot;1&quot;;
    src = if lib.inNixShell then null else nix;

    buildInputs = with rPackages; [
      R
      ggplot2
      knitr
    ];
  };
}
</code></pre><p>and then run <code class="literal">nix-shell .</code> to be dropped into a shell with those packages
available.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="rstudio" class="title" >RStudio   </h3>  </div> </div></div><p>RStudio uses a standard set of packages and ignores any custom R
environments or installed packages you may have.  To create a custom
environment, see <code class="literal">rstudioWrapper</code>, which functions similarly to
<code class="literal">rWrapper</code>:</p><pre><code class="programlisting nix">{
  packageOverrides =
    super:
    let
      self = super.pkgs;
    in
    {

      rstudioEnv = super.rstudioWrapper.override {
        packages = with self.rPackages; [
          dplyr
          ggplot2
          reshape2
        ];
      };
    };
}
</code></pre><p>Then like above, <code class="literal">nix-env -f &quot;&lt;nixpkgs&gt;&quot; -iA rstudioEnv</code> will install
this into your user profile.</p><p>Alternatively, you can create a self-contained <code class="literal">shell.nix</code> without the need to
modify any configuration files:</p><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:

pkgs.rstudioWrapper.override {
  packages = with pkgs.rPackages; [
    dplyr
    ggplot2
    reshape2
  ];
}
</code></pre><p>Executing <code class="literal">nix-shell</code> will then drop you into an environment equivalent to the
one above. If you need additional packages just add them to the list and
re-enter the shell.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="updating-the-package-set" class="title" >Updating the package set   </h3>  </div> </div></div><p>There is a script and associated environment for regenerating the package
sets and synchronising the rPackages tree to the current CRAN and matching
BIOC release. These scripts are found in the <code class="literal">pkgs/development/r-modules</code>
directory and executed as follows:</p><pre><code class="programlisting bash">nix-shell generate-shell.nix

Rscript generate-r-packages.R cran  &gt; cran-packages.json.new
mv cran-packages.json.new cran-packages.json

Rscript generate-r-packages.R bioc  &gt; bioc-packages.json.new
mv bioc-packages.json.new bioc-packages.json

Rscript generate-r-packages.R bioc-annotation &gt; bioc-annotation-packages.json.new
mv bioc-annotation-packages.json.new bioc-annotation-packages.json

Rscript generate-r-packages.R bioc-experiment &gt; bioc-experiment-packages.json.new
mv bioc-experiment-packages.json.new bioc-experiment-packages.json
</code></pre><p><code class="literal">generate-r-packages.R &lt;repo&gt;</code> reads  <code class="literal">&lt;repo&gt;-packages.json</code>, therefore
the renaming.</p><p>The contents of a generated <code class="literal">*-packages.json</code> file will be used to
create a package derivation for each R package listed in the file.</p><p>Some packages require overrides to specify external dependencies or other
patches and special requirements. These overrides are specified in the
<code class="literal">pkgs/development/r-modules/default.nix</code> file. As the <code class="literal">*-packages.json</code>
contents are automatically generated it should not be edited and broken
builds should be addressed using overrides.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-ruby" class="title" style="clear: both">Ruby   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#using-ruby">Using Ruby</a> </span></dt><dt> <span class="section">  <a href="index.html#developing-with-ruby">Developing with Ruby</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="using-ruby" class="title" >Using Ruby   </h3>  </div> </div></div><p>Several versions of Ruby interpreters are available on Nix, as well as over 250 gems and many applications written in Ruby. The attribute <code class="literal">ruby</code> refers to the default Ruby interpreter, which is currently MRI 3.3. It’s also possible to refer to specific versions, e.g. <code class="literal">ruby_3_y</code>, <code class="literal">jruby</code>, or <code class="literal">mruby</code>.</p><p>In the Nixpkgs tree, Ruby packages can be found throughout, depending on what they do, and are called from the main package set. Ruby gems, however are separate sets, and there’s one default set for each interpreter (currently MRI only).</p><p>There are two main approaches for using Ruby with gems. One is to use a specifically locked <code class="literal">Gemfile</code> for an application that has very strict dependencies. The other is to depend on the common gems, which we’ll explain further down, and rely on them being updated regularly.</p><p>The interpreters have common attributes, namely <code class="literal">gems</code>, and <code class="literal">withPackages</code>. So you can refer to <code class="literal">ruby.gems.nokogiri</code>, or <code class="literal">ruby_3_2.gems.nokogiri</code> to get the Nokogiri gem already compiled and ready to use.</p><p>Since not all gems have executables like <code class="literal">nokogiri</code>, it’s usually more convenient to use the <code class="literal">withPackages</code> function like this: <code class="literal">ruby.withPackages (p: with p; [ nokogiri ])</code>. This will also make sure that the Ruby in your environment will be able to find the gem and it can be used in your Ruby code (for example via <code class="literal">ruby</code> or <code class="literal">irb</code> executables) via <code class="literal">require &quot;nokogiri&quot;</code> as usual.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="temporary-ruby-environment-with-nix-shell" class="title" >Temporary Ruby environment with <code class="literal">nix-shell</code>   </h4>  </div> </div></div><p>Rather than having a single Ruby environment shared by all Ruby development projects on a system, Nix allows you to create separate environments per project. <code class="literal">nix-shell</code> gives you the possibility to temporarily load another environment akin to a combined <code class="literal">chruby</code> or <code class="literal">rvm</code> and <code class="literal">bundle exec</code>.</p><p>There are two methods for loading a shell with Ruby packages. The first and recommended method is to create an environment with <code class="literal">ruby.withPackages</code> and load that.</p><pre><code class="programlisting ShellSession">$ nix-shell -p &quot;ruby.withPackages (ps: with ps; [ nokogiri pry ])&quot;
</code></pre><p>The other method, which is not recommended, is to create an environment and list all the packages directly.</p><pre><code class="programlisting ShellSession">$ nix-shell -p ruby.gems.nokogiri ruby.gems.pry
</code></pre><p>Again, it’s possible to launch the interpreter from the shell. The Ruby interpreter has the attribute <code class="literal">gems</code> which contains all Ruby gems for that specific interpreter.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="load-ruby-environment-from-.nix-expression" class="title" >Load Ruby environment from <code class="literal">.nix</code> expression   </h5>  </div> </div></div><p>As explained <a class="link" href="https://nixos.org/manual/nix/stable/command-ref/nix-shell"  target="_top">in the <code class="literal">nix-shell</code> section</a> of the Nix manual, <code class="literal">nix-shell</code> can also load an expression from a <code class="literal">.nix</code> file.
Say we want to have Ruby, <code class="literal">nokogori</code>, and <code class="literal">pry</code>. Consider a <code class="literal">shell.nix</code> file with:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };
ruby.withPackages (
  ps: with ps; [
    nokogiri
    pry
  ]
)
</code></pre><p>What’s happening here?</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>We begin with importing the Nix Packages collections. <code class="literal">import &lt;nixpkgs&gt;</code> imports the <code class="literal">&lt;nixpkgs&gt;</code> function, <code class="literal">{}</code> calls it and the <code class="literal">with</code> statement brings all attributes of <code class="literal">nixpkgs</code> in the local scope. These attributes form the main package set.</p></li><li class="listitem"><p>Then we create a Ruby environment with the <code class="literal">withPackages</code> function.</p></li><li class="listitem"><p>The <code class="literal">withPackages</code> function expects us to provide a function as an argument that takes the set of all ruby gems and returns a list of packages to include in the environment. Here, we select the packages <code class="literal">nokogiri</code> and <code class="literal">pry</code> from the package set.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="execute-command-with---run" class="title" >Execute command with <code class="literal">--run</code>   </h5>  </div> </div></div><p>A convenient flag for <code class="literal">nix-shell</code> is <code class="literal">--run</code>. It executes a command in the <code class="literal">nix-shell</code>. We can e.g. directly open a <code class="literal">pry</code> REPL:</p><pre><code class="programlisting ShellSession">$ nix-shell -p &quot;ruby.withPackages (ps: with ps; [ nokogiri pry ])&quot; --run &quot;pry&quot;
</code></pre><p>Or immediately require <code class="literal">nokogiri</code> in pry:</p><pre><code class="programlisting ShellSession">$ nix-shell -p &quot;ruby.withPackages (ps: with ps; [ nokogiri pry ])&quot; --run &quot;pry -rnokogiri&quot;
</code></pre><p>Or run a script using this environment:</p><pre><code class="programlisting ShellSession">$ nix-shell -p &quot;ruby.withPackages (ps: with ps; [ nokogiri pry ])&quot; --run &quot;ruby example.rb&quot;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="using-nix-shell-as-shebang" class="title" >Using <code class="literal">nix-shell</code> as shebang   </h5>  </div> </div></div><p>In fact, for the last case, there is a more convenient method. You can add a <a class="link" href="https://en.wikipedia.org/wiki/Shebang_(Unix)"  target="_top">shebang</a> to your script specifying which dependencies <code class="literal">nix-shell</code> needs. With the following shebang, you can just execute <code class="literal">./example.rb</code>, and it will run with all dependencies.</p><pre><code class="programlisting ruby">#! /usr/bin/env nix-shell
#! nix-shell -i ruby -p &quot;ruby.withPackages (ps: with ps; [ nokogiri rest-client ])&quot;

require &#x27;nokogiri&#x27;
require &#x27;rest-client&#x27;

body = RestClient.get(&#x27;http://example.com&#x27;).body
puts Nokogiri::HTML(body).at(&#x27;h1&#x27;).text
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="developing-with-ruby" class="title" >Developing with Ruby   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="using-an-existing-gemfile" class="title" >Using an existing Gemfile   </h4>  </div> </div></div><p>In most cases, you’ll already have a <code class="literal">Gemfile.lock</code> listing all your dependencies. This can be used to generate a <code class="literal">gemset.nix</code> which is used to fetch the gems and combine them into a single environment. The reason why you need to have a separate file for this, is that Nix requires you to have a checksum for each input to your build. Since the <code class="literal">Gemfile.lock</code> that <code class="literal">bundler</code> generates doesn’t provide us with checksums, we have to first download each gem, calculate its SHA256, and store it in this separate file.</p><p>So the steps from having just a <code class="literal">Gemfile</code> to a <code class="literal">gemset.nix</code> are:</p><pre><code class="programlisting ShellSession">$ bundle lock
$ bundix
</code></pre><p>If you already have a <code class="literal">Gemfile.lock</code>, you can run <code class="literal">bundix</code> and it will work the same.</p><p>To update the gems in your <code class="literal">Gemfile.lock</code>, you may use the <code class="literal">bundix -l</code> flag, which will create a new <code class="literal">Gemfile.lock</code> in case the <code class="literal">Gemfile</code> has a more recent time of modification.</p><p>Once the <code class="literal">gemset.nix</code> is generated, it can be used in a <code class="literal">bundlerEnv</code> derivation. Here is an example you could use for your <code class="literal">shell.nix</code>:</p><pre><code class="programlisting nix"># ...
let
  gems = bundlerEnv {
    name = &quot;gems-for-some-project&quot;;
    gemdir = ./.;
  };
in
mkShell {
  packages = [
    gems
    gems.wrappedRuby
  ];
}
</code></pre><p>With this file in your directory, you can run <code class="literal">nix-shell</code> to build and use the gems. The important parts here are <code class="literal">bundlerEnv</code> and <code class="literal">wrappedRuby</code>.</p><p>The <code class="literal">bundlerEnv</code> is a wrapper over all the gems in your gemset. This means that all the <code class="literal">/lib</code> and <code class="literal">/bin</code> directories will be available, and the executables of all gems (even of indirect dependencies) will end up in your <code class="literal">$PATH</code>. The <code class="literal">wrappedRuby</code> provides you with all executables that come with Ruby itself, but wrapped so they can easily find the gems in your gemset.</p><p>One common issue that you might have is that you have Ruby, but also <code class="literal">bundler</code> in your gemset. That leads to a conflict for <code class="literal">/bin/bundle</code> and <code class="literal">/bin/bundler</code>. You can resolve this by wrapping either your Ruby or your gems in a <code class="literal">lowPrio</code> call. So in order to give the <code class="literal">bundler</code> from your gemset priority, it would be used like this:</p><pre><code class="programlisting nix"># ...
mkShell {
  buildInputs = [
    gems
    (lowPrio gems.wrappedRuby)
  ];
}
</code></pre><p>Sometimes a Gemfile references other files. Such as <code class="literal">.ruby-version</code> or vendored gems. When copying the Gemfile to the nix store we need to copy those files alongside. This can be done using <code class="literal">extraConfigPaths</code>. For example:</p><pre><code class="programlisting nix">{
  gems = bundlerEnv {
    name = &quot;gems-for-some-project&quot;;
    gemdir = ./.;
    extraConfigPaths = [ &quot;${./.}/.ruby-version&quot; ];
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="gem-specific-configurations-and-workarounds" class="title" >Gem-specific configurations and workarounds   </h4>  </div> </div></div><p>In some cases, especially if the gem has native extensions, you might need to modify the way the gem is built.</p><p>This is done via a common configuration file that includes all of the workarounds for each gem.</p><p>This file lives at <code class="literal">/pkgs/development/ruby-modules/gem-config/default.nix</code>, since it already contains a lot of entries, it should be pretty easy to add the modifications you need for your needs.</p><p>In the meanwhile, or if the modification is for a private gem, you can also add the configuration to only your own environment.</p><p>Two places that allow this modification are the <code class="literal">ruby</code> derivation, or <code class="literal">bundlerEnv</code>.</p><p>Here’s the <code class="literal">ruby</code> one:</p><pre><code class="programlisting nix">{
  pg_version ? &quot;10&quot;,
  pkgs ? import &lt;nixpkgs&gt; { },
}:
let
  myRuby = pkgs.ruby.override {
    defaultGemConfig = pkgs.defaultGemConfig // {
      pg = attrs: {
        buildFlags = [
          &quot;--with-pg-config=${pkgs.&quot;postgresql_${pg_version}&quot;.pg_config}/bin/pg_config&quot;
        ];
      };
    };
  };
in
myRuby.withPackages (ps: with ps; [ pg ])
</code></pre><p>And an example with <code class="literal">bundlerEnv</code>:</p><pre><code class="programlisting nix">{
  pg_version ? &quot;10&quot;,
  pkgs ? import &lt;nixpkgs&gt; { },
}:
let
  gems = pkgs.bundlerEnv {
    name = &quot;gems-for-some-project&quot;;
    gemdir = ./.;
    gemConfig = pkgs.defaultGemConfig // {
      pg = attrs: {
        buildFlags = [
          &quot;--with-pg-config=${pkgs.&quot;postgresql_${pg_version}&quot;.pg_config}/bin/pg_config&quot;
        ];
      };
    };
  };
in
mkShell {
  buildInputs = [
    gems
    gems.wrappedRuby
  ];
}
</code></pre><p>And finally via overlays:</p><pre><code class="programlisting nix">{
  pg_version ? &quot;10&quot;,
}:
let
  pkgs = import &lt;nixpkgs&gt; {
    overlays = [
      (self: super: {
        defaultGemConfig = super.defaultGemConfig // {
          pg = attrs: {
            buildFlags = [
              &quot;--with-pg-config=${pkgs.&quot;postgresql_${pg_version}&quot;.pg_config}/bin/pg_config&quot;
            ];
          };
        };
      })
    ];
  };
in
pkgs.ruby.withPackages (ps: with ps; [ pg ])
</code></pre><p>Then we can get whichever postgresql version we desire and the <code class="literal">pg</code> gem will always reference it correctly:</p><pre><code class="programlisting ShellSession">$ nix-shell --argstr pg_version 9_4 --run &#x27;ruby -rpg -e &quot;puts PG.library_version&quot;&#x27;
90421

$ nix-shell --run &#x27;ruby -rpg -e &quot;puts PG.library_version&quot;&#x27;
100007
</code></pre><p>Of course for this use-case one could also use overlays since the configuration for <code class="literal">pg</code> depends on the <code class="literal">postgresql</code> alias, but for demonstration purposes this has to suffice.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ruby-platform-specif-gems" class="title" >Platform-specific gems   </h4>  </div> </div></div><p>Right now, bundix has some issues with pre-built, platform-specific gems: <a class="link" href="https://github.com/nix-community/bundix/pull/68"  target="_top">bundix PR #68</a>.
Until this is solved, you can tell bundler to not use platform-specific gems and instead build them from source each time:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>globally (will be set in <code class="literal">~/.config/.bundle/config</code>):</p></li></ul></div><pre><code class="programlisting shell">$ bundle config set force_ruby_platform true
</code></pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>locally (will be set in <code class="literal">&lt;project-root&gt;/.bundle/config</code>):</p></li></ul></div><pre><code class="programlisting shell">$ bundle config set --local force_ruby_platform true
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="adding-a-gem-to-the-default-gemset" class="title" >Adding a gem to the default gemset   </h4>  </div> </div></div><p>Now that you know how to get a working Ruby environment with Nix, it’s time to go forward and start actually developing with Ruby. We will first have a look at how Ruby gems are packaged on Nix. Then, we will look at how you can use development mode with your code.</p><p>All gems in the standard set are automatically generated from a single <code class="literal">Gemfile</code>. The dependency resolution is done with <code class="literal">bundler</code> and makes it more likely that all gems are compatible to each other.</p><p>In order to add a new gem to nixpkgs, you can put it into the <code class="literal">/pkgs/development/ruby-modules/with-packages/Gemfile</code> and run <code class="literal">./maintainers/scripts/update-ruby-packages</code>.</p><p>To test that it works, you can then try using the gem with:</p><pre><code class="programlisting shell">NIX_PATH=nixpkgs=$PWD nix-shell -p &quot;ruby.withPackages (ps: with ps; [ name-of-your-gem ])&quot;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="packaging-applications" class="title" >Packaging applications   </h4>  </div> </div></div><p>A common task is to add a ruby executable to nixpkgs, popular examples would be <code class="literal">chef</code>, <code class="literal">jekyll</code>, or <code class="literal">sass</code>. A good way to do that is to use the <code class="literal">bundlerApp</code> function, that allows you to make a package that only exposes the listed executables, otherwise the package may cause conflicts through common paths like <code class="literal">bin/rake</code> or <code class="literal">bin/bundler</code> that aren’t meant to be used.</p><p>The absolute easiest way to do that is to write a <code class="literal">Gemfile</code> along these lines:</p><pre><code class="programlisting ruby">source &#x27;https://rubygems.org&#x27; do
  gem &#x27;mdl&#x27;
end
</code></pre><p>If you want to package a specific version, you can use the standard Gemfile syntax for that, e.g. <code class="literal">gem &#x27;mdl&#x27;, &#x27;0.5.0&#x27;</code>, but if you want the latest stable version anyway, it’s easier to update by running the <code class="literal">bundle lock</code> and <code class="literal">bundix</code> steps again.</p><p>Now you can also make a <code class="literal">default.nix</code> that looks like this:</p><pre><code class="programlisting nix">{ bundlerApp }:

bundlerApp {
  pname = &quot;mdl&quot;;
  gemdir = ./.;
  exes = [ &quot;mdl&quot; ];
}
</code></pre><p>All that’s left to do is to generate the corresponding <code class="literal">Gemfile.lock</code> and <code class="literal">gemset.nix</code> as described above in the <code class="literal">Using an existing Gemfile</code> section.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="packaging-executables-that-require-wrapping" class="title" >Packaging executables that require wrapping   </h5>  </div> </div></div><p>Sometimes your app will depend on other executables at runtime, and tries to find it through the <code class="literal">PATH</code> environment variable.</p><p>In this case, you can provide a <code class="literal">postBuild</code> hook to <code class="literal">bundlerApp</code> that wraps the gem in another script that prefixes the <code class="literal">PATH</code>.</p><p>Of course you could also make a custom <code class="literal">gemConfig</code> if you know exactly how to patch it, but it’s usually much easier to maintain with a simple wrapper so the patch doesn’t have to be adjusted for each version.</p><p>Here’s another example:</p><pre><code class="programlisting nix">{
  lib,
  bundlerApp,
  makeWrapper,
  git,
  gnutar,
  gzip,
}:

bundlerApp {
  pname = &quot;r10k&quot;;
  gemdir = ./.;
  exes = [ &quot;r10k&quot; ];

  nativeBuildInputs = [ makeWrapper ];

  postBuild = &#x27;&#x27;
    wrapProgram $out/bin/r10k --prefix PATH : ${
      lib.makeBinPath [
        git
        gnutar
        gzip
      ]
    }
  &#x27;&#x27;;
}
</code></pre>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="rust" class="title" style="clear: both">Rust   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#compiling-rust-applications-with-cargo"><code class="literal">buildRustPackage</code>: Compiling Rust applications with Cargo</a> </span></dt><dt> <span class="section">  <a href="index.html#compiling-rust-crates-using-nix-instead-of-cargo"><code class="literal">buildRustCrate</code>: Compiling Rust crates using Nix instead of Cargo</a> </span></dt><dt> <span class="section">  <a href="index.html#using-community-maintained-rust-toolchains">Using community maintained Rust toolchains</a> </span></dt><dt> <span class="section">  <a href="index.html#using-git-bisect-on-the-rust-compiler">Using <code class="literal">git bisect</code> on the Rust compiler</a> </span></dt> </dl></div><p>To install the rust compiler and cargo put</p><pre><code class="programlisting nix">{
  environment.systemPackages = [
    rustc
    cargo
  ];
}
</code></pre><p>into your <code class="literal">configuration.nix</code> or bring them into scope with <code class="literal">nix-shell -p rustc cargo</code>.</p><p>For other versions such as daily builds (beta and nightly),
use either <code class="literal">rustup</code> from nixpkgs (which will manage the rust installation in your home directory),
or use <a class="link" href="index.html#using-community-maintained-rust-toolchains" title="Using community maintained Rust toolchains" >community maintained Rust toolchains</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="compiling-rust-applications-with-cargo" class="title" ><code class="literal">buildRustPackage</code>: Compiling Rust applications with Cargo   </h3>  </div> </div></div><p>Rust applications are packaged by using the <code class="literal">buildRustPackage</code> helper from <code class="literal">rustPlatform</code>:</p><pre><code class="programlisting nix">{
  lib,
  fetchFromGitHub,
  rustPlatform,
}:

rustPlatform.buildRustPackage (finalAttrs: {
  pname = &quot;ripgrep&quot;;
  version = &quot;14.1.1&quot;;

  src = fetchFromGitHub {
    owner = &quot;BurntSushi&quot;;
    repo = &quot;ripgrep&quot;;
    tag = finalAttrs.version;
    hash = &quot;sha256-gyWnahj1A+iXUQlQ1O1H1u7K5euYQOld9qWm99Vjaeg=&quot;;
  };

  cargoHash = &quot;sha256-9atn5qyBDy4P6iUoHFhg+TV6Ur71fiah4oTJbBMeEy4=&quot;;

  meta = {
    description = &quot;Fast line-oriented regex search tool, similar to ag and ack&quot;;
    homepage = &quot;https://github.com/BurntSushi/ripgrep&quot;;
    license = lib.licenses.unlicense;
    maintainers = [ ];
  };
})
</code></pre><p><code class="literal">buildRustPackage</code> requires a <code class="literal">cargoHash</code> attribute, computed over all crate sources of this package.</p><div class="warning"><h3 class="title">Warning</h3><p><code class="literal">cargoSha256</code> is already deprecated, and is subject to removal in favor of
<code class="literal">cargoHash</code> which supports <a class="link" href="https://www.w3.org/TR/SRI/"  target="_top">SRI</a> hashes.</p><p>If you are still using <code class="literal">cargoSha256</code>, you can simply replace it with
<code class="literal">cargoHash</code> and recompute the hash, or convert the original sha256 to SRI
hash using <code class="literal">nix-hash --to-sri --type sha256 &quot;&lt;original sha256&gt;&quot;</code>.</p></div><pre><code class="programlisting nix">{ cargoHash = &quot;sha256-l1vL2ZdtDRxSGvP0X/l3nMw8+6WF67KPutJEzUROjg8=&quot;; }
</code></pre><p>If this method does not work, you can resort to copying the <code class="literal">Cargo.lock</code> file into nixpkgs
and importing it as described in the <a class="link" href="index.html#importing-a-cargo.lock-file" title="Importing a Cargo.lock file" >next section</a>.</p><p>Both types of hashes are permitted when contributing to nixpkgs. The
Cargo hash is obtained by inserting a fake checksum into the
expression and building the package once. The correct checksum can
then be taken from the failed build. A fake hash can be used for
<code class="literal">cargoHash</code> as follows:</p><pre><code class="programlisting nix">{ cargoHash = lib.fakeHash; }
</code></pre><p>Per the instructions in the <a class="link" href="https://doc.rust-lang.org/cargo/guide/cargo-toml-vs-cargo-lock.html"  target="_top">Cargo Book</a>
best practices guide, Rust applications should always commit the <code class="literal">Cargo.lock</code>
file in git to ensure a reproducible build. However, a few packages do not, and
Nix depends on this file, so if it is missing you can use <code class="literal">cargoPatches</code> to
apply it in the <code class="literal">patchPhase</code>. Consider sending a PR upstream with a note to the
maintainer describing why it’s important to include in the application.</p><p>The fetcher will verify that the <code class="literal">Cargo.lock</code> file is in sync with the <code class="literal">src</code>
attribute, and fail the build if not. It will also will compress the vendor
directory into a tar.gz archive.</p><p>The tarball with vendored dependencies contains a directory with the
package’s <code class="literal">name</code>, which is normally composed of <code class="literal">pname</code> and
<code class="literal">version</code>. This means that the vendored dependencies hash
(<code class="literal">cargoHash</code>) is dependent on the package name and
version. The <code class="literal">cargoDepsName</code> attribute can be used to use another name
for the directory of vendored dependencies. For example, the hash can
be made invariant to the version by setting <code class="literal">cargoDepsName</code> to
<code class="literal">pname</code>:</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage (finalAttrs: {
  pname = &quot;broot&quot;;
  version = &quot;1.2.0&quot;;

  src = fetchCrate {
    inherit (finalAttrs) pname version;
    hash = &quot;sha256-aDQA4A5mScX9or3Lyiv/5GyAehidnpKKE0grhbP1Ctc=&quot;;
  };

  cargoHash = &quot;sha256-iDYh52rj1M5Uupvbx2WeDd/jvQZ+2A50V5rp5e2t7q4=&quot;;
  cargoDepsName = finalAttrs.pname;

  # ...
})
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="importing-a-cargo.lock-file" class="title" >Importing a <code class="literal">Cargo.lock</code> file   </h4>  </div> </div></div><p>Using a vendored hash (<code class="literal">cargoHash</code>) is tedious when using
<code class="literal">buildRustPackage</code> within a project, since it requires that the hash
is updated after every change to <code class="literal">Cargo.lock</code>. Therefore,
<code class="literal">buildRustPackage</code> also supports vendoring dependencies directly from
a <code class="literal">Cargo.lock</code> file using the <code class="literal">cargoLock</code> argument. For example:</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage {
  pname = &quot;myproject&quot;;
  version = &quot;1.0.0&quot;;

  cargoLock = {
    lockFile = ./Cargo.lock;
  };

  # ...
}
</code></pre><p>This will retrieve the dependencies using fixed-output derivations from
the specified lockfile.</p><p>One caveat is that <code class="literal">Cargo.lock</code> cannot be patched in the <code class="literal">patchPhase</code>
because it runs after the dependencies have already been fetched. If
you need to patch or generate the lockfile you can alternatively set
<code class="literal">cargoLock.lockFileContents</code> to a string of its contents:</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage {
  pname = &quot;myproject&quot;;
  version = &quot;1.0.0&quot;;

  cargoLock =
    let
      fixupLockFile = path: f (builtins.readFile path);
    in
    {
      lockFileContents = fixupLockFile ./Cargo.lock;
    };

  # ...
}
</code></pre><p>If the upstream source repository lacks a <code class="literal">Cargo.lock</code> file, you must add one
to <code class="literal">src</code>, as it is essential for building a Rust package. Setting
<code class="literal">cargoLock.lockFile</code> or <code class="literal">cargoLock.lockFileContents</code> will not automatically add
a <code class="literal">Cargo.lock</code> file to <code class="literal">src</code>. A straightforward solution is to use:</p><pre><code class="programlisting nix">{
  postPatch = &#x27;&#x27;
    ln -s ${./Cargo.lock} Cargo.lock
  &#x27;&#x27;;
}
</code></pre><p>The output hash of each dependency that uses a git source must be
specified in the <code class="literal">outputHashes</code> attribute. For example:</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage {
  pname = &quot;myproject&quot;;
  version = &quot;1.0.0&quot;;

  cargoLock = {
    lockFile = ./Cargo.lock;
    outputHashes = {
      &quot;finalfusion-0.14.0&quot; = &quot;17f4bsdzpcshwh74w5z119xjy2if6l2wgyjy56v621skr2r8y904&quot;;
    };
  };

  # ...
}
</code></pre><p>If you do not specify an output hash for a git dependency, building
the package will fail and inform you of which crate needs to be
added. To find the correct hash, you can first use <code class="literal">lib.fakeSha256</code> or
<code class="literal">lib.fakeHash</code> as a stub hash. Building the package (and thus the
vendored dependencies) will then inform you of the correct hash.</p><p>For usage outside nixpkgs, <code class="literal">allowBuiltinFetchGit</code> could be used to
avoid having to specify <code class="literal">outputHashes</code>. For example:</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage {
  pname = &quot;myproject&quot;;
  version = &quot;1.0.0&quot;;

  cargoLock = {
    lockFile = ./Cargo.lock;
    allowBuiltinFetchGit = true;
  };

  # ...
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cargo-features" class="title" >Cargo features   </h4>  </div> </div></div><p>You can disable default features using <code class="literal">buildNoDefaultFeatures</code>, and
extra features can be added with <code class="literal">buildFeatures</code>.</p><p>If you want to use different features for check phase, you can use
<code class="literal">checkNoDefaultFeatures</code> and <code class="literal">checkFeatures</code>. They are only passed to
<code class="literal">cargo test</code> and not <code class="literal">cargo build</code>. If left unset, they default to
<code class="literal">buildNoDefaultFeatures</code> and <code class="literal">buildFeatures</code>.</p><p>For example:</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage {
  pname = &quot;myproject&quot;;
  version = &quot;1.0.0&quot;;

  buildNoDefaultFeatures = true;
  buildFeatures = [
    &quot;color&quot;
    &quot;net&quot;
  ];

  # disable network features in tests
  checkFeatures = [ &quot;color&quot; ];

  # ...
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="cross-compilation" class="title" >Cross compilation   </h4>  </div> </div></div><p>By default, Rust packages are compiled for the host platform, just like any
other package is.  The <code class="literal">--target</code> passed to rust tools is computed from this.
By default, it takes the <code class="literal">stdenv.hostPlatform.config</code> and replaces components
where they are known to differ. But there are ways to customize the argument:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>To choose a different target by name, define
<code class="literal">stdenv.hostPlatform.rust.rustcTarget</code> as that name (a string), and that
name will be used instead.</p><p>For example:</p><pre><code class="programlisting nix">import &lt;nixpkgs&gt; {
  crossSystem = (import &lt;nixpkgs/lib&gt;).systems.examples.armhf-embedded // {
    rust.rustcTarget = &quot;thumbv7em-none-eabi&quot;;
  };
}
</code></pre><p>will result in:</p><pre><code class="programlisting shell">--target thumbv7em-none-eabi
</code></pre></li><li class="listitem"><p>To pass a completely custom target, define
<code class="literal">stdenv.hostPlatform.rust.rustcTarget</code> with its name, and
<code class="literal">stdenv.hostPlatform.rust.platform</code> with the value.  The value will be
serialized to JSON in a file called
<code class="literal">${stdenv.hostPlatform.rust.rustcTarget}.json</code>, and the path of that file
will be used instead.</p><p>For example:</p><pre><code class="programlisting nix">import &lt;nixpkgs&gt; {
  crossSystem = (import &lt;nixpkgs/lib&gt;).systems.examples.armhf-embedded // {
    rust.rustcTarget = &quot;thumb-crazy&quot;;
    rust.platform = {
      foo = &quot;&quot;;
      bar = &quot;&quot;;
    };
  };
}
</code></pre><p>will result in:</p><pre><code class="programlisting shell">--target /nix/store/asdfasdfsadf-thumb-crazy.json # contains {&quot;foo&quot;:&quot;&quot;,&quot;bar&quot;:&quot;&quot;}
</code></pre></li></ul></div><p>Note that currently custom targets aren’t compiled with <code class="literal">std</code>, so <code class="literal">cargo test</code>
will fail. This can be ignored by adding <code class="literal">doCheck = false;</code> to your derivation.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="running-package-tests" class="title" >Running package tests   </h4>  </div> </div></div><p>When using <code class="literal">buildRustPackage</code>, the <code class="literal">checkPhase</code> is enabled by default and runs
<code class="literal">cargo test</code> on the package to build. To make sure that we don’t compile the
sources twice and to actually test the artifacts that will be used at runtime,
the tests will be ran in the <code class="literal">release</code> mode by default.</p><p>However, in some cases the test-suite of a package doesn’t work properly in the
<code class="literal">release</code> mode. For these situations, the mode for <code class="literal">checkPhase</code> can be changed like
so:</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage {
  # ...
  checkType = &quot;debug&quot;;
}
</code></pre><p>Please note that the code will be compiled twice here: once in <code class="literal">release</code> mode
for the <code class="literal">buildPhase</code>, and again in <code class="literal">debug</code> mode for the <code class="literal">checkPhase</code>.</p><p>Test flags, e.g., <code class="literal">--package foo</code>, can be passed to <code class="literal">cargo test</code> via the
<code class="literal">cargoTestFlags</code> attribute.</p><p>Another attribute, called <code class="literal">checkFlags</code>, is used to pass arguments to the test
binary itself, as stated
<a class="link" href="https://doc.rust-lang.org/cargo/commands/cargo-test.html"  target="_top">here</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="tests-relying-on-the-structure-of-the-target-directory" class="title" >Tests relying on the structure of the <code class="literal">target/</code> directory   </h5>  </div> </div></div><p>Some tests may rely on the structure of the <code class="literal">target/</code> directory. Those tests
are likely to fail because we use <code class="literal">cargo --target</code> during the build. This means that
the artifacts
<a class="link" href="https://doc.rust-lang.org/cargo/guide/build-cache.html"  target="_top">are stored in <code class="literal">target/&lt;architecture&gt;/release/</code></a>,
rather than in <code class="literal">target/release/</code>.</p><p>This can only be worked around by patching the affected tests accordingly.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="disabling-package-tests" class="title" >Disabling package-tests   </h5>  </div> </div></div><p>In some instances, it may be necessary to disable testing altogether (with <code class="literal">doCheck = false;</code>):</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>If no tests exist – the <code class="literal">checkPhase</code> should be explicitly disabled to skip
unnecessary build steps to speed up the build.</p></li><li class="listitem"><p>If tests are highly impure (e.g. due to network usage).</p></li></ul></div><p>There will obviously be some corner-cases not listed above where it’s sensible to disable tests.
The above are just guidelines, and exceptions may be granted on a case-by-case basis.</p><p>However, please check if it’s possible to disable a problematic subset of the
test suite and leave a comment explaining your reasoning.</p><p>This can be achieved with <code class="literal">--skip</code> in <code class="literal">checkFlags</code>:</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage {
  # ...
  checkFlags = [
    # reason for disabling test
    &quot;--skip=example::tests:example_test&quot;
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="using-cargo-nextest" class="title" >Using <code class="literal">cargo-nextest</code>   </h5>  </div> </div></div><p>Tests can be run with <a class="link" href="https://github.com/nextest-rs/nextest"  target="_top">cargo-nextest</a>
by setting <code class="literal">useNextest = true</code>. The same options still apply, but nextest
accepts a different set of arguments and the settings might need to be
adapted to be compatible with cargo-nextest.</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage {
  # ...
  useNextest = true;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="setting-test-threads" class="title" >Setting <code class="literal">test-threads</code>   </h5>  </div> </div></div><p><code class="literal">buildRustPackage</code> will use parallel test threads by default,
sometimes it may be necessary to disable this so the tests run consecutively.</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage {
  # ...
  dontUseCargoParallelTests = true;
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="building-a-package-in-debug-mode" class="title" >Building a package in <code class="literal">debug</code> mode   </h4>  </div> </div></div><p>By default, <code class="literal">buildRustPackage</code> will use <code class="literal">release</code> mode for builds. If a package
should be built in <code class="literal">debug</code> mode, it can be configured like so:</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage {
  # ...
  buildType = &quot;debug&quot;;
}
</code></pre><p>In this scenario, the <code class="literal">checkPhase</code> will be ran in <code class="literal">debug</code> mode as well.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="custom-buildinstall-procedures" class="title" >Custom <code class="literal">build</code>/<code class="literal">install</code>-procedures   </h4>  </div> </div></div><p>Some packages may use custom scripts for building/installing, e.g. with a <code class="literal">Makefile</code>.
In these cases, it’s recommended to override the <code class="literal">buildPhase</code>/<code class="literal">installPhase</code>/<code class="literal">checkPhase</code>.</p><p>Otherwise, some steps may fail because of the modified directory structure of <code class="literal">target/</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="building-a-crate-with-an-absent-or-out-of-date-cargo.lock-file" class="title" >Building a crate with an absent or out-of-date Cargo.lock file   </h4>  </div> </div></div><p><code class="literal">buildRustPackage</code> needs a <code class="literal">Cargo.lock</code> file to get all dependencies in the
source code in a reproducible way. If it is missing or out-of-date one can use
the <code class="literal">cargoPatches</code> attribute to update or add it.</p><pre><code class="programlisting nix">rustPlatform.buildRustPackage {
  # ...
  cargoPatches = [
    # a patch file to add/update Cargo.lock in the source code
    ./add-Cargo.lock.patch
  ];
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="compiling-non-rust-packages-that-include-rust-code" class="title" >Compiling non-Rust packages that include Rust code   </h4>  </div> </div></div><p>Several non-Rust packages incorporate Rust code for performance- or
security-sensitive parts. <code class="literal">rustPlatform</code> exposes several functions and
hooks that can be used to integrate Cargo in non-Rust packages.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="vendoring-of-dependencies" class="title" >Vendoring of dependencies   </h5>  </div> </div></div><p>Since network access is not allowed in sandboxed builds, Rust crate
dependencies need to be retrieved using a fetcher. <code class="literal">rustPlatform</code>
provides the <code class="literal">fetchCargoVendor</code> fetcher, which vendors all
dependencies of a crate. For example, given a source path <code class="literal">src</code>
containing <code class="literal">Cargo.toml</code> and <code class="literal">Cargo.lock</code>, <code class="literal">fetchCargoVendor</code>
can be used as follows:</p><pre><code class="programlisting nix">{
  cargoDeps = rustPlatform.fetchCargoVendor {
    inherit src;
    hash = &quot;sha256-BoHIN/519Top1NUBjpB/oEMqi86Omt3zTQcXFWqrek0=&quot;;
  };
}
</code></pre><p>The <code class="literal">src</code> attribute is required, as well as a hash specified through
one of the <code class="literal">hash</code> attribute. The following optional attributes can
also be used:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">name</code>: the name that is used for the dependencies tarball.  If
<code class="literal">name</code> is not specified, then the name <code class="literal">cargo-deps</code> will be used.</p></li><li class="listitem"><p><code class="literal">sourceRoot</code>: when the <code class="literal">Cargo.lock</code>/<code class="literal">Cargo.toml</code> are in a
subdirectory, <code class="literal">sourceRoot</code> specifies the relative path to these
files.</p></li><li class="listitem"><p><code class="literal">patches</code>: patches to apply before vendoring. This is useful when
the <code class="literal">Cargo.lock</code>/<code class="literal">Cargo.toml</code> files need to be patched before
vendoring.</p></li></ul></div><p>If a <code class="literal">Cargo.lock</code> file is available, you can alternatively use the
<code class="literal">importCargoLock</code> function. In contrast to <code class="literal">fetchCargoVendor</code>, this
function does not require a hash (unless git dependencies are used)
and fetches every dependency as a separate fixed-output derivation.
<code class="literal">importCargoLock</code> can be used as follows:</p><pre><code class="programlisting nix">{ cargoDeps = rustPlatform.importCargoLock { lockFile = ./Cargo.lock; }; }
</code></pre><p>If the <code class="literal">Cargo.lock</code> file includes git dependencies, then their output
hashes need to be specified since they are not available through the
lock file. For example:</p><pre><code class="programlisting nix">{
  cargoDeps = rustPlatform.importCargoLock {
    lockFile = ./Cargo.lock;
    outputHashes = {
      &quot;rand-0.8.3&quot; = &quot;0ya2hia3cn31qa8894s3av2s8j5bjwb6yq92k0jsnlx7jid0jwqa&quot;;
    };
  };
}
</code></pre><p>If you do not specify an output hash for a git dependency, building
<code class="literal">cargoDeps</code> will fail and inform you of which crate needs to be
added. To find the correct hash, you can first use <code class="literal">lib.fakeSha256</code> or
<code class="literal">lib.fakeHash</code> as a stub hash. Building <code class="literal">cargoDeps</code> will then inform
you of the correct hash.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="hooks" class="title" >Hooks   </h5>  </div> </div></div><p><code class="literal">rustPlatform</code> provides the following hooks to automate Cargo builds:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">cargoSetupHook</code>: configure Cargo to use dependencies vendored
through <code class="literal">fetchCargoVendor</code> or <code class="literal">importCargoLock</code>. This hook uses the
<code class="literal">cargoDeps</code> environment variable to find the vendored
dependencies. If a project already vendors its dependencies, the
variable <code class="literal">cargoVendorDir</code> can be used instead. When the
<code class="literal">Cargo.toml</code>/<code class="literal">Cargo.lock</code> files are not in <code class="literal">sourceRoot</code>, then the
optional <code class="literal">cargoRoot</code> is used to specify the Cargo root directory
relative to <code class="literal">sourceRoot</code>.</p></li><li class="listitem"><p><code class="literal">cargoBuildHook</code>: use Cargo to build a crate. If the crate to be
built is a crate in e.g. a Cargo workspace, the relative path to the
crate to build can be set through the optional <code class="literal">buildAndTestSubdir</code>
environment variable. Features can be specified with
<code class="literal">cargoBuildNoDefaultFeatures</code> and <code class="literal">cargoBuildFeatures</code>. Additional
Cargo build flags can be passed through <code class="literal">cargoBuildFlags</code>.</p></li><li class="listitem"><p><code class="literal">maturinBuildHook</code>: use <a class="link" href="https://github.com/PyO3/maturin"  target="_top">Maturin</a>
to build a Python wheel. Similar to <code class="literal">cargoBuildHook</code>, the optional
variable <code class="literal">buildAndTestSubdir</code> can be used to build a crate in a
Cargo workspace. Additional Maturin flags can be passed through
<code class="literal">maturinBuildFlags</code>.</p></li><li class="listitem"><p><code class="literal">cargoCheckHook</code>: run tests using Cargo. The build type for checks
can be set using <code class="literal">cargoCheckType</code>. Features can be specified with
<code class="literal">cargoCheckNoDefaultFeatures</code> and <code class="literal">cargoCheckFeatures</code>. Additional
flags can be passed to the tests using <code class="literal">checkFlags</code> and
<code class="literal">checkFlagsArray</code>. By default, tests are run in parallel. This can
be disabled by setting <code class="literal">dontUseCargoParallelTests</code>.</p></li><li class="listitem"><p><code class="literal">cargoNextestHook</code>: run tests using
<a class="link" href="https://github.com/nextest-rs/nextest"  target="_top">cargo-nextest</a>. The same
options for <code class="literal">cargoCheckHook</code> also applies to <code class="literal">cargoNextestHook</code>.</p></li><li class="listitem"><p><code class="literal">cargoInstallHook</code>: install binaries and static/shared libraries
that were built using <code class="literal">cargoBuildHook</code>.</p></li><li class="listitem"><p><code class="literal">bindgenHook</code>: for crates which use <code class="literal">bindgen</code> as a build dependency, lets
<code class="literal">bindgen</code> find <code class="literal">libclang</code> and <code class="literal">libclang</code> find the libraries in <code class="literal">buildInputs</code>.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="examples" class="title" >Examples   </h5>  </div> </div></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="python-package-using-setuptools-rust" class="title" >Python package using <code class="literal">setuptools-rust</code>   </h5>  </div> </div></div><p>For Python packages using <code class="literal">setuptools-rust</code>, you can use
<code class="literal">fetchCargoVendor</code> and <code class="literal">cargoSetupHook</code> to retrieve and set up Cargo
dependencies. The build itself is then performed by
<code class="literal">buildPythonPackage</code>.</p><p>The following example outlines how the <code class="literal">tokenizers</code> Python package is
built. Since the Python package is in the <code class="literal">source/bindings/python</code>
directory of the <code class="literal">tokenizers</code> project’s source archive, we use
<code class="literal">sourceRoot</code> to point the tooling to this directory:</p><pre><code class="programlisting nix">{
  fetchFromGitHub,
  buildPythonPackage,
  cargo,
  rustPlatform,
  rustc,
  setuptools-rust,
}:

buildPythonPackage rec {
  pname = &quot;tokenizers&quot;;
  version = &quot;0.10.0&quot;;

  src = fetchFromGitHub {
    owner = &quot;huggingface&quot;;
    repo = &quot;tokenizers&quot;;
    tag = &quot;python-v${version}&quot;;
    hash = &quot;sha256-rQ2hRV52naEf6PvRsWVCTN7B1oXAQGmnpJw4iIdhamw=&quot;;
  };

  cargoDeps = rustPlatform.fetchCargoVendor {
    inherit
      pname
      version
      src
      sourceRoot
      ;
    hash = &quot;sha256-RO1m8wEd5Ic2M9q+zFHeCJWhCr4Sv3CEWd08mkxsBec=&quot;;
  };

  sourceRoot = &quot;${src.name}/bindings/python&quot;;

  nativeBuildInputs = [
    cargo
    rustPlatform.cargoSetupHook
    rustc
    setuptools-rust
  ];

  # ...
}
</code></pre><p>In some projects, the Rust crate is not in the main Python source
directory.  In such cases, the <code class="literal">cargoRoot</code> attribute can be used to
specify the crate’s directory relative to <code class="literal">sourceRoot</code>. In the
following example, the crate is in <code class="literal">src/rust</code>, as specified in the
<code class="literal">cargoRoot</code> attribute. Note that we also need to pass in <code class="literal">cargoRoot</code>
to <code class="literal">fetchCargoVendor</code>.</p><pre><code class="programlisting nix">{
  buildPythonPackage,
  fetchPypi,
  rustPlatform,
  setuptools-rust,
  openssl,
}:

buildPythonPackage rec {
  pname = &quot;cryptography&quot;;
  version = &quot;3.4.2&quot;; # Also update the hash in vectors.nix

  src = fetchPypi {
    inherit pname version;
    hash = &quot;sha256-xGDilsjLOnls3MfVbGKnj80KCUCczZxlis5PmHzpNcQ=&quot;;
  };

  cargoDeps = rustPlatform.fetchCargoVendor {
    inherit
      pname
      version
      src
      cargoRoot
      ;
    hash = &quot;sha256-ctUt8maCjnGddKPf+Ii++wKsAXA1h+JM6zKQNXXwJqQ=&quot;;
  };

  cargoRoot = &quot;src/rust&quot;;

  # ...
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="python-package-using-maturin" class="title" >Python package using <code class="literal">maturin</code>   </h5>  </div> </div></div><p>Python packages that use <a class="link" href="https://github.com/PyO3/maturin"  target="_top">Maturin</a>
can be built with <code class="literal">fetchCargoVendor</code>, <code class="literal">cargoSetupHook</code>, and
<code class="literal">maturinBuildHook</code>. For example, the following (partial) derivation
builds the <code class="literal">retworkx</code> Python package. <code class="literal">fetchCargoVendor</code> and
<code class="literal">cargoSetupHook</code> are used to fetch and set up the crate dependencies.
<code class="literal">maturinBuildHook</code> is used to perform the build.</p><pre><code class="programlisting nix">{
  lib,
  buildPythonPackage,
  rustPlatform,
  fetchFromGitHub,
}:

buildPythonPackage rec {
  pname = &quot;retworkx&quot;;
  version = &quot;0.6.0&quot;;
  pyproject = true;

  src = fetchFromGitHub {
    owner = &quot;Qiskit&quot;;
    repo = &quot;retworkx&quot;;
    tag = version;
    hash = &quot;sha256-11n30ldg3y3y6qxg3hbj837pnbwjkqw3nxq6frds647mmmprrd20=&quot;;
  };

  cargoDeps = rustPlatform.fetchCargoVendor {
    inherit pname version src;
    hash = &quot;sha256-QsPCQhNZKYCAogQriQX6pBYQUDAIUsEdRX/63dAqTzg=&quot;;
  };

  nativeBuildInputs = with rustPlatform; [
    cargoSetupHook
    maturinBuildHook
  ];

  # ...
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="rust-package-built-with-meson" class="title" >Rust package built with <code class="literal">meson</code>   </h5>  </div> </div></div><p>Some projects, especially GNOME applications, are built with the Meson Build System instead of calling Cargo directly. Using <code class="literal">rustPlatform.buildRustPackage</code> may successfully build the main program, but related files will be missing. Instead, you need to set up Cargo dependencies with <code class="literal">fetchCargoVendor</code> and <code class="literal">cargoSetupHook</code> and leave the rest to Meson. <code class="literal">rust</code> and <code class="literal">cargo</code> are still needed in <code class="literal">nativeBuildInputs</code> for Meson to use.</p><pre><code class="programlisting nix">{
  lib,
  stdenv,
  fetchFromGitLab,
  meson,
  ninja,
  pkg-config,
  rustPlatform,
  rustc,
  cargo,
  wrapGAppsHook4,
  blueprint-compiler,
  libadwaita,
  libsecret,
  tinysparql,
}:

stdenv.mkDerivation (finalAttrs: {
  pname = &quot;health&quot;;
  version = &quot;0.95.0&quot;;

  src = fetchFromGitLab {
    domain = &quot;gitlab.gnome.org&quot;;
    owner = &quot;World&quot;;
    repo = &quot;health&quot;;
    tag = finalAttrs.version;
    hash = &quot;sha256-PrNPprSS98yN8b8yw2G6hzTSaoE65VbsM3q7FVB4mds=&quot;;
  };

  cargoDeps = rustPlatform.fetchCargoVendor {
    inherit (finalAttrs) pname version src;
    hash = &quot;sha256-eR1ZGtTZQNhofFUEjI7IX16sMKPJmAl7aIFfPJukecg=&quot;;
  };

  nativeBuildInputs = [
    meson
    ninja
    pkg-config
    rustPlatform.cargoSetupHook
    rustc
    cargo
    wrapGAppsHook4
    blueprint-compiler
  ];

  buildInputs = [
    libadwaita
    libsecret
    tinysparql
  ];

  # ...
})
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="compiling-rust-crates-using-nix-instead-of-cargo" class="title" ><code class="literal">buildRustCrate</code>: Compiling Rust crates using Nix instead of Cargo   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="simple-operation" class="title" >Simple operation   </h4>  </div> </div></div><p>When run, <code class="literal">cargo build</code> produces a file called <code class="literal">Cargo.lock</code>,
containing pinned versions of all dependencies. Nixpkgs contains a
tool called <code class="literal">crate2Nix</code> (<code class="literal">nix-shell -p crate2nix</code>), which can be
used to turn a <code class="literal">Cargo.lock</code> into a Nix expression.  That Nix
expression calls <code class="literal">rustc</code> directly (hence bypassing Cargo), and can
be used to compile a crate and all its dependencies.</p><p>See <a class="link" href="https://github.com/kolloch/crate2nix#known-restrictions"  target="_top"><code class="literal">crate2nix</code>’s documentation</a>
for instructions on how to use it.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="handling-external-dependencies" class="title" >Handling external dependencies   </h4>  </div> </div></div><p>Some crates require external libraries. For crates from
<a class="link" href="https://crates.io"  target="_top">crates.io</a>, such libraries can be specified in
<code class="literal">defaultCrateOverrides</code> package in nixpkgs itself.</p><p>Starting from that file, one can add more overrides, to add features
or build inputs by overriding the hello crate in a separate file.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };
((import ./hello.nix).hello { }).override {
  crateOverrides = defaultCrateOverrides // {
    hello = attrs: { buildInputs = [ openssl ]; };
  };
}
</code></pre><p>Here, <code class="literal">crateOverrides</code> is expected to be a attribute set, where the
key is the crate name without version number and the value a function.
The function gets all attributes passed to <code class="literal">buildRustCrate</code> as first
argument and returns a set that contains all attribute that should be
overwritten.</p><p>For more complicated cases, such as when parts of the crate’s
derivation depend on the crate’s version, the <code class="literal">attrs</code> argument of
the override above can be read, as in the following example, which
patches the derivation:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };
((import ./hello.nix).hello { }).override {
  crateOverrides = defaultCrateOverrides // {
    hello =
      attrs:
      lib.optionalAttrs (lib.versionAtLeast attrs.version &quot;1.0&quot;) {
        postPatch = &#x27;&#x27;
          substituteInPlace lib/zoneinfo.rs \
            --replace-fail &quot;/usr/share/zoneinfo&quot; &quot;${tzdata}/share/zoneinfo&quot;
        &#x27;&#x27;;
      };
  };
}
</code></pre><p>Another situation is when we want to override a nested
dependency. This actually works in the exact same way, since the
<code class="literal">crateOverrides</code> parameter is forwarded to the crate’s
dependencies. For instance, to override the build inputs for crate
<code class="literal">libc</code> in the example above, where <code class="literal">libc</code> is a dependency of the main
crate, we could do:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };
((import hello.nix).hello { }).override {
  crateOverrides = defaultCrateOverrides // {
    libc = attrs: { buildInputs = [ ]; };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="options-and-phases-configuration" class="title" >Options and phases configuration   </h4>  </div> </div></div><p>Actually, the overrides introduced in the previous section are more
general. A number of other parameters can be overridden:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>The version of <code class="literal">rustc</code> used to compile the crate:</p><pre><code class="programlisting nix">(hello { }).override { rust = pkgs.rust; }
</code></pre></li><li class="listitem"><p>Whether to build in release mode or debug mode (release mode by
default):</p><pre><code class="programlisting nix">(hello { }).override { release = false; }
</code></pre></li><li class="listitem"><p>Whether to print the commands sent to <code class="literal">rustc</code> when building
(equivalent to <code class="literal">--verbose</code> in cargo:</p><pre><code class="programlisting nix">(hello { }).override { verbose = false; }
</code></pre></li><li class="listitem"><p>Extra arguments to be passed to <code class="literal">rustc</code>:</p><pre><code class="programlisting nix">(hello { }).override { extraRustcOpts = &quot;-Z debuginfo=2&quot;; }
</code></pre></li><li class="listitem"><p>Phases, just like in any other derivation, can be specified using
the following attributes: <code class="literal">preUnpack</code>, <code class="literal">postUnpack</code>, <code class="literal">prePatch</code>,
<code class="literal">patches</code>, <code class="literal">postPatch</code>, <code class="literal">preConfigure</code> (in the case of a Rust crate,
this is run before calling the “build” script), <code class="literal">postConfigure</code>
(after the “build” script),<code class="literal">preBuild</code>, <code class="literal">postBuild</code>, <code class="literal">preInstall</code> and
<code class="literal">postInstall</code>. As an example, here is how to create a new module
before running the build script:</p><pre><code class="programlisting nix">(hello { }).override {
  preConfigure = &#x27;&#x27;
    echo &quot;pub const PATH=\&quot;${hi.out}\&quot;;&quot; &gt;&gt; src/path.rs&quot;
  &#x27;&#x27;;
}
</code></pre></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="setting-up-nix-shell" class="title" >Setting Up <code class="literal">nix-shell</code>   </h4>  </div> </div></div><p>Oftentimes you want to develop code from within <code class="literal">nix-shell</code>. Unfortunately
<code class="literal">buildRustCrate</code> does not support common <code class="literal">nix-shell</code> operations directly
(see <a class="link" href="https://github.com/NixOS/nixpkgs/issues/37945"  target="_top">this issue</a>)
so we will use <code class="literal">stdenv.mkDerivation</code> instead.</p><p>Using the example <code class="literal">hello</code> project above, we want to do the following:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Have access to <code class="literal">cargo</code> and <code class="literal">rustc</code></p></li><li class="listitem"><p>Have the <code class="literal">openssl</code> library available to a crate through it’s <span class="emphasis"><em>normal</em></span>
compilation mechanism (<code class="literal">pkg-config</code>).</p></li></ul></div><p>A typical <code class="literal">shell.nix</code> might look like:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

stdenv.mkDerivation {
  name = &quot;rust-env&quot;;
  nativeBuildInputs = [
    rustc
    cargo

    # Example Build-time Additional Dependencies
    pkg-config
  ];
  buildInputs = [
    # Example Run-time Additional Dependencies
    openssl
  ];

  # Set Environment Variables
  RUST_BACKTRACE = 1;
}
</code></pre><p>You should now be able to run the following:</p><pre><code class="programlisting ShellSession">$ nix-shell --pure
$ cargo build
$ cargo test
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="using-community-maintained-rust-toolchains" class="title" >Using community maintained Rust toolchains   </h3>  </div> </div></div><div class="note"><h3 class="title">Note</h3><p>The following projects cannot be used within Nixpkgs since <a class="link" href="https://nixos.org/manual/nix/unstable/language/import-from-derivation"  target="_top">Import From Derivation</a> (IFD) is disallowed in Nixpkgs.
To package things that require Rust nightly, <code class="literal">RUSTC_BOOTSTRAP = true;</code> can sometimes be used as a hack.</p></div><p>There are two community maintained approaches to Rust toolchain management:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="https://github.com/oxalica/rust-overlay"  target="_top">oxalica’s Rust overlay</a></p></li><li class="listitem"><p><a class="link" href="https://github.com/nix-community/fenix"  target="_top">fenix</a></p></li></ul></div><p>Despite their names, both projects provides a similar set of packages and overlays under different APIs.</p><p>Oxalica’s overlay allows you to select a particular Rust version without you providing a hash or a flake input,
but comes with a larger git repository than fenix.</p><p>Fenix also provides rust-analyzer nightly in addition to the Rust toolchains.</p><p>Both oxalica’s overlay and fenix better integrate with nix and cache optimizations.
Because of this and ergonomics, either of those community projects
should be preferred to the Mozilla’s Rust overlay (<a class="link" href="https://github.com/mozilla/nixpkgs-mozilla"  target="_top">nixpkgs-mozilla</a>).</p><p>The following documentation demonstrates examples using fenix and oxalica’s Rust overlay
with <code class="literal">nix-shell</code> and building derivations. More advanced usages like flake usage
are documented in their own repositories.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="using-rust-nightly-with-nix-shell" class="title" >Using Rust nightly with <code class="literal">nix-shell</code>   </h4>  </div> </div></div><p>Here is a simple <code class="literal">shell.nix</code> that provides Rust nightly (default profile) using fenix:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };
let
  fenix = callPackage (fetchFromGitHub {
    owner = &quot;nix-community&quot;;
    repo = &quot;fenix&quot;;
    # commit from: 2023-03-03
    rev = &quot;e2ea04982b892263c4d939f1cc3bf60a9c4deaa1&quot;;
    hash = &quot;sha256-AsOim1A8KKtMWIxG+lXh5Q4P2bhOZjoUhFWJ1EuZNNk=&quot;;
  }) { };
in
mkShell {
  name = &quot;rust-env&quot;;
  nativeBuildInputs = [
    # Note: to use stable, just replace `default` with `stable`
    fenix.default.toolchain

    # Example Build-time Additional Dependencies
    pkg-config
  ];
  buildInputs = [
    # Example Run-time Additional Dependencies
    openssl
  ];

  # Set Environment Variables
  RUST_BACKTRACE = 1;
}
</code></pre><p>Save this to <code class="literal">shell.nix</code>, then run:</p><pre><code class="programlisting ShellSession">$ rustc --version
rustc 1.69.0-nightly (13471d3b2 2023-03-02)
</code></pre><p>To see that you are using nightly.</p><p>Oxalica’s Rust overlay has more complete examples of <code class="literal">shell.nix</code> (and cross compilation) under its
<a class="link" href="https://github.com/oxalica/rust-overlay/tree/e53e8853aa7b0688bc270e9e6a681d22e01cf299/examples"  target="_top"><code class="literal">examples</code> directory</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="using-rust-nightly-in-a-derivation-with-buildrustpackage" class="title" >Using Rust nightly in a derivation with <code class="literal">buildRustPackage</code>   </h4>  </div> </div></div><p>You can also use Rust nightly to build rust packages using <code class="literal">makeRustPlatform</code>.
The below snippet demonstrates invoking <code class="literal">buildRustPackage</code> with a Rust toolchain from oxalica’s overlay:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; {
  overlays = [
    (import (fetchTarball &quot;https://github.com/oxalica/rust-overlay/archive/master.tar.gz&quot;))
  ];
};
let
  rustPlatform = makeRustPlatform {
    cargo = rust-bin.selectLatestNightlyWith (toolchain: toolchain.default);
    rustc = rust-bin.selectLatestNightlyWith (toolchain: toolchain.default);
  };

in
rustPlatform.buildRustPackage (finalAttrs: {
  pname = &quot;ripgrep&quot;;
  version = &quot;14.1.1&quot;;

  src = fetchFromGitHub {
    owner = &quot;BurntSushi&quot;;
    repo = &quot;ripgrep&quot;;
    tag = finalAttrs.version;
    hash = &quot;sha256-gyWnahj1A+iXUQlQ1O1H1u7K5euYQOld9qWm99Vjaeg=&quot;;
  };

  cargoHash = &quot;sha256-9atn5qyBDy4P6iUoHFhg+TV6Ur71fiah4oTJbBMeEy4=&quot;;

  # Tests require network access. Skipping.
  doCheck = false;

  meta = {
    description = &quot;Fast line-oriented regex search tool, similar to ag and ack&quot;;
    homepage = &quot;https://github.com/BurntSushi/ripgrep&quot;;
    license = with lib.licenses; [
      mit
      unlicense
    ];
    maintainers = with lib.maintainers; [ ];
  };
})
</code></pre><p>Follow the below steps to try that snippet.</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>save the above snippet as <code class="literal">default.nix</code> in that directory</p></li><li class="listitem"><p>cd into that directory and run <code class="literal">nix-build</code></p></li></ol></div><p>Fenix also has examples with <code class="literal">buildRustPackage</code>,
<a class="link" href="https://github.com/ipetkov/crane"  target="_top">crane</a>,
<a class="link" href="https://github.com/nix-community/naersk"  target="_top">naersk</a>,
and cross compilation in its <a class="link" href="https://github.com/nix-community/fenix#examples"  target="_top">Examples</a> section.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="using-git-bisect-on-the-rust-compiler" class="title" >Using <code class="literal">git bisect</code> on the Rust compiler   </h3>  </div> </div></div><p>Sometimes an upgrade of the Rust compiler (<code class="literal">rustc</code>) will break a
downstream package.  In these situations, being able to <code class="literal">git bisect</code>
the <code class="literal">rustc</code> version history to find the offending commit is quite
useful.  Nixpkgs makes it easy to do this.</p><p>First, roll back your nixpkgs to a commit in which its <code class="literal">rustc</code> used
<span class="emphasis"><em>the most recent one which doesn’t have the problem.</em></span>  You’ll need
to do this because of <code class="literal">rustc</code>’s extremely aggressive
version-pinning.</p><p>Next, add the following overlay, updating the Rust version to the
one in your rolled-back nixpkgs, and replacing <code class="literal">/git/scratch/rust</code>
with the path into which you have <code class="literal">git clone</code>d the <code class="literal">rustc</code> git
repository:</p><pre><code class="programlisting nix">(
  final: prev: # lib.optionalAttrs prev.stdenv.targetPlatform.isAarch64
  {
    rust_1_72 = lib.updateManyAttrsByPath [
      {
        path = [
          &quot;packages&quot;
          &quot;stable&quot;
        ];
        update =
          old:
          old.overrideScope (
            final: prev: {
              rustc-unwrapped = prev.rustc-unwrapped.overrideAttrs (_: {
                src = lib.cleanSource /git/scratch/rust;
                # do *not* put passthru.isReleaseTarball=true here
              });
            }
          );
      }
    ] prev.rust_1_72;
  })
</code></pre><p>If the problem you’re troubleshooting only manifests when
cross-compiling you can uncomment the <code class="literal">lib.optionalAttrs</code> in the
example above, and replace <code class="literal">isAarch64</code> with the target that is
having problems.  This will speed up your bisect quite a bit, since
the host compiler won’t need to be rebuilt.</p><p>Now, you can start a <code class="literal">git bisect</code> in the directory where you checked
out the <code class="literal">rustc</code> source code.  It is recommended to select the
endpoint commits by searching backwards from <code class="literal">origin/master</code> for the
<span class="emphasis"><em>commits which added the release notes for the versions in
question.</em></span>  If you set the endpoints to commits on the release
branches (i.e. the release tags), git-bisect will often get confused
by the complex merge-commit structures it will need to traverse.</p><p>The command loop you’ll want to use for bisecting looks like this:</p><pre><code class="programlisting bash">git bisect {good,bad}  # depending on result of last build
git submodule update --init
CARGO_NET_OFFLINE=false cargo vendor \
  --sync ./src/tools/cargo/Cargo.toml \
  --sync ./src/tools/rust-analyzer/Cargo.toml \
  --sync ./compiler/rustc_codegen_cranelift/Cargo.toml \
  --sync ./src/bootstrap/Cargo.toml
nix-build $NIXPKGS -A package-broken-by-rust-changes
</code></pre><p>The <code class="literal">git submodule update --init</code> and <code class="literal">cargo vendor</code> commands above
require network access, so they can’t be performed from within the
<code class="literal">rustc</code> derivation, unfortunately.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-scheme" class="title" style="clear: both">Scheme   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-scheme-package-management">Package Management</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-scheme-package-management" class="title" >Package Management   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-scheme-package-management-akku" class="title" >Akku   </h4>  </div> </div></div><p>About two hundred R6RS &amp; R7RS libraries from <a class="link" href="https://akkuscm.org/"  target="_top">Akku</a>
(which also mirrors <a class="link" href="https://snow-fort.org/pkg"  target="_top">snow-fort</a>)
are available inside the <code class="literal">akkuPackages</code> attrset, and the Akku executable
itself is at the top level as <code class="literal">akku</code>. The packages could be used
in a derivation’s <code class="literal">buildInputs</code>, work inside of <code class="literal">nix-shell</code>, and
are tested using <a class="link" href="https://www.scheme.com/"  target="_top">Chez</a> &amp;
<a class="link" href="https://synthcode.com/wiki/chibi-scheme"  target="_top">Chibi</a>
Scheme during build time.</p><p>Including a package as a build input is done in the typical Nix fashion.
For example, to include
<a class="link" href="https://akkuscm.org/packages/chez-srfi/"  target="_top">a bunch of SRFIs</a>
primarily for Chez Scheme in a derivation, one might write:</p><pre><code class="programlisting nix">{
  buildInputs = [
    chez
    akkuPackages.chez-srfi
  ];
}
</code></pre><p>The package index is located in <code class="literal">pkgs/tools/package-management/akku</code>
as <code class="literal">deps.toml</code>, and should be updated occasionally by running <code class="literal">./update.sh</code>
in the directory. Doing so will pull the source URLs for new packages and
more recent versions, then write them to the TOML.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="swift" class="title" style="clear: both">Swift   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-swift-module-search-paths">Module search paths</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-swift-core-libraries">Core libraries</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-swift-packaging-with-swiftpm">Packaging with SwiftPM</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-swift-considerations-for-custom-build-tools">Considerations for custom build tools</a> </span></dt> </dl></div><p>The Swift compiler is provided by the <code class="literal">swift</code> package:</p><pre><code class="programlisting sh"># Compile and link a simple executable.
nix-shell -p swift --run &#x27;swiftc -&#x27; &lt;&lt;&lt; &#x27;print(&quot;Hello world!&quot;)&#x27;
# Run it!
./main
</code></pre><p>The <code class="literal">swift</code> package also provides the <code class="literal">swift</code> command, with some caveats:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Swift Package Manager (SwiftPM) is packaged separately as <code class="literal">swiftpm</code>. If you
need functionality like <code class="literal">swift build</code>, <code class="literal">swift run</code>, <code class="literal">swift test</code>, you must
also add the <code class="literal">swiftpm</code> package to your closure.</p></li><li class="listitem"><p>On Darwin, the <code class="literal">swift repl</code> command requires an Xcode installation. This is
because it uses the system LLDB debugserver, which has special entitlements.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-swift-module-search-paths" class="title" >Module search paths   </h3>  </div> </div></div><p>Like other toolchains in Nixpkgs, the Swift compiler executables are wrapped
to help Swift find your application’s dependencies in the Nix store. These
wrappers scan the <code class="literal">buildInputs</code> of your package derivation for specific
directories where Swift modules are placed by convention, and automatically
add those directories to the Swift compiler search paths.</p><p>Swift follows different conventions depending on the platform. The wrappers
look for the following directories:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>On Darwin platforms: <code class="literal">lib/swift/macosx</code>
(If not targeting macOS, replace <code class="literal">macosx</code> with the Xcode platform name.)</p></li><li class="listitem"><p>On other platforms: <code class="literal">lib/swift/linux/x86_64</code>
(Where <code class="literal">linux</code> and <code class="literal">x86_64</code> are from lowercase <code class="literal">uname -sm</code>.)</p></li><li class="listitem"><p>For convenience, Nixpkgs also adds <code class="literal">lib/swift</code> to the search path.
This can save a bit of work packaging Swift modules, because many Nix builds
will produce output for just one target any way.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-swift-core-libraries" class="title" >Core libraries   </h3>  </div> </div></div><p>In addition to the standard library, the Swift toolchain contains some
additional ‘core libraries’ that, on Apple platforms, are normally distributed
as part of the OS or Xcode. These are packaged separately in Nixpkgs, and can
be found (for use in <code class="literal">buildInputs</code>) as:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">swiftPackages.Dispatch</code></p></li><li class="listitem"><p><code class="literal">swiftPackages.Foundation</code></p></li><li class="listitem"><p><code class="literal">swiftPackages.XCTest</code></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-swift-packaging-with-swiftpm" class="title" >Packaging with SwiftPM   </h3>  </div> </div></div><p>Nixpkgs includes a small helper <code class="literal">swiftpm2nix</code> that can fetch your SwiftPM
dependencies for you, when you need to write a Nix expression to package your
application.</p><p>The first step is to run the generator:</p><pre><code class="programlisting sh">cd /path/to/my/project
# Enter a Nix shell with the required tools.
nix-shell -p swift swiftpm swiftpm2nix
# First, make sure the workspace is up-to-date.
swift package resolve
# Now generate the Nix code.
swiftpm2nix
</code></pre><p>This produces some files in a directory <code class="literal">nix</code>, which will be part of your Nix
expression. The next step is to write that expression:</p><pre><code class="programlisting nix">{
  stdenv,
  swift,
  swiftpm,
  swiftpm2nix,
  fetchFromGitHub,
}:

let
  # Pass the generated files to the helper.
  generated = swiftpm2nix.helpers ./nix;

in
stdenv.mkDerivation (finalAttrs: {
  pname = &quot;myproject&quot;;
  version = &quot;0.0.0&quot;;

  src = fetchFromGitHub {
    owner = &quot;nixos&quot;;
    repo = &quot;myproject&quot;;
    tag = finalAttrs.version;
    hash = &quot;&quot;;
  };

  # Including SwiftPM as a nativeBuildInput provides a buildPhase for you.
  # This by default performs a release build using SwiftPM, essentially:
  #   swift build -c release
  nativeBuildInputs = [
    swift
    swiftpm
  ];

  # The helper provides a configure snippet that will prepare all dependencies
  # in the correct place, where SwiftPM expects them.
  configurePhase = &#x27;&#x27;
    runHook preConfigure

    ${generated.configure}

    runHook postConfigure
  &#x27;&#x27;;

  installPhase = &#x27;&#x27;
    runHook preInstall

    # This is a special function that invokes swiftpm to find the location
    # of the binaries it produced.
    binPath=&quot;$(swiftpmBinPath)&quot;
    # Now perform any installation steps.
    mkdir -p $out/bin
    cp $binPath/myproject $out/bin/

    runHook postInstall
  &#x27;&#x27;;
})
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-swiftpm-custom-build-flags" class="title" >Custom build flags   </h4>  </div> </div></div><p>If you’d like to build a different configuration than <code class="literal">release</code>:</p><pre><code class="programlisting nix">{ swiftpmBuildConfig = &quot;debug&quot;; }
</code></pre><p>It is also possible to provide additional flags to <code class="literal">swift build</code>:</p><pre><code class="programlisting nix">{ swiftpmFlags = [ &quot;--disable-dead-strip&quot; ]; }
</code></pre><p>The default <code class="literal">buildPhase</code> already passes <code class="literal">-j</code> for parallel building.</p><p>If these two customization options are insufficient, provide your own
<code class="literal">buildPhase</code> that invokes <code class="literal">swift build</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-swiftpm-running-tests" class="title" >Running tests   </h4>  </div> </div></div><p>Including <code class="literal">swiftpm</code> in your <code class="literal">nativeBuildInputs</code> also provides a default
<code class="literal">checkPhase</code>, but it must be enabled with:</p><pre><code class="programlisting nix">{ doCheck = true; }
</code></pre><p>This essentially runs: <code class="literal">swift test -c release</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-swiftpm-patching-dependencies" class="title" >Patching dependencies   </h4>  </div> </div></div><p>In some cases, it may be necessary to patch a SwiftPM dependency. SwiftPM
dependencies are located in <code class="literal">.build/checkouts</code>, but the <code class="literal">swiftpm2nix</code> helper
provides these as symlinks to read-only <code class="literal">/nix/store</code> paths. In order to patch
them, we need to make them writable.</p><p>A special function <code class="literal">swiftpmMakeMutable</code> is available to replace the symlink
with a writable copy:</p><pre><code class="programlisting nix">{
  configurePhase = &#x27;&#x27;
    runHook preConfigure

    ${generated.configure}

    # Replace the dependency symlink with a writable copy.
    swiftpmMakeMutable swift-crypto
    # Now apply a patch.
    patch -p1 -d .build/checkouts/swift-crypto -i ${./some-fix.patch}

    runHook postConfigure
  &#x27;&#x27;;
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-swift-considerations-for-custom-build-tools" class="title" >Considerations for custom build tools   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="ssec-swift-linking-the-standard-library" class="title" >Linking the standard library   </h4>  </div> </div></div><p>The <code class="literal">swift</code> package has a separate <code class="literal">lib</code> output containing just the Swift
standard library, to prevent Swift applications needing a dependency on the
full Swift compiler at run-time. Linking with the Nixpkgs Swift toolchain
already ensures binaries correctly reference the <code class="literal">lib</code> output.</p><p>Sometimes, Swift is used only to compile part of a mixed codebase, and the
link step is manual. Custom build tools often locate the standard library
relative to the <code class="literal">swift</code> compiler executable, and while the result will work,
when this path ends up in the binary, it will have the Swift compiler as an
unintended dependency.</p><p>In this case, you should investigate how your build process discovers the
standard library, and override the path. The correct path will be something
like: <code class="literal">&quot;${swift.swift.lib}/${swift.swiftModuleSubdir}&quot;</code></p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-tcl" class="title" style="clear: both">Tcl   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-language-tcl-user-guide">User guide</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-tcl-packaging">Packaging guide</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-language-tcl-user-guide" class="title" >User guide   </h3>  </div> </div></div><p>Tcl interpreters are available under the <code class="literal">tcl</code> and <code class="literal">tcl-X_Y</code> attributes, where <code class="literal">X_Y</code> is the Tcl version.</p><p>Tcl libraries are available in the <code class="literal">tclPackages</code> attribute set.
They are only guaranteed to work with the default Tcl version, but will probably also work with others thanks to the <a class="link" href="https://wiki.tcl-lang.org/page/Stubs"  target="_top">stubs mechanism</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-language-tcl-packaging" class="title" >Packaging guide   </h3>  </div> </div></div><p>Tcl packages are typically built with <code class="literal">tclPackages.mkTclDerivation</code>.
Tcl dependencies go in <code class="literal">buildInputs</code>/<code class="literal">nativeBuildInputs</code>/… like other packages.
For more complex package definitions, such as packages with mixed languages, use <code class="literal">tcl.tclPackageHook</code>.</p><p>Where possible, make sure to enable stubs for maximum compatibility, usually with the <code class="literal">--enable-stubs</code> configure flag.</p><p>Here is a simple package example to be called with <code class="literal">tclPackages.callPackage</code>.</p><pre><code class="programlisting">{ lib, fetchzip, mkTclDerivation, openssl }:

mkTclDerivation rec {
  pname = &quot;tcltls&quot;;
  version = &quot;1.7.22&quot;;

  src = fetchzip {
    url = &quot;https://core.tcl-lang.org/tcltls/uv/tcltls-${version}.tar.gz&quot;;
    hash = &quot;sha256-TOouWcQc3MNyJtaAGUGbaQoaCWVe6g3BPERct/V65vk=&quot;;
  };

  buildInputs = [ openssl ];

  configureFlags = [
    &quot;--with-ssl-dir=${openssl.dev}&quot;
    &quot;--enable-stubs&quot;
  ];

  meta = {
    homepage = &quot;https://core.tcl-lang.org/tcltls/index&quot;;
    description = &quot;OpenSSL / RSA-bsafe Tcl extension&quot;;
    maintainers = [ lib.maintainers.agbrooks ];
    license = lib.licenses.tcltk;
    platforms = lib.platforms.unix;
  };
}
</code></pre><p>All Tcl libraries are declared in <code class="literal">pkgs/top-level/tcl-packages.nix</code> and are defined in <code class="literal">pkgs/development/tcl-modules/</code>.
If possible, prefer the by-name hierarchy in <code class="literal">pkgs/development/tcl-modules/by-name/</code>.
Its use is documented in <code class="literal">pkgs/development/tcl-modules/by-name/README.md</code>.</p><p>All Tcl applications reside elsewhere.
In case a package is used as both a library and an application (for example <code class="literal">expect</code>), it should be defined in <code class="literal">tcl-packages.nix</code>, with an alias elsewhere.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-language-texlive" class="title" style="clear: both">TeX Live   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-language-texlive-user-guide-experimental">User’s guide (experimental new interface)</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-texlive-user-guide">User’s guide</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-texlive-custom-packages">Custom packages</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-language-texlive-lualatex-font-cache">LuaLaTeX font cache</a> </span></dt> </dl></div><p>There is a TeX Live packaging that lives entirely under attribute <code class="literal">texlive</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-language-texlive-user-guide-experimental" class="title" >User’s guide (experimental new interface)   </h3>  </div> </div></div><p>Release 23.11 ships with a new interface that will eventually replace <code class="literal">texlive.combine</code>.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>For basic usage, use some of the prebuilt environments available at the top level, such as <code class="literal">texliveBasic</code>, <code class="literal">texliveSmall</code>. For the full list of prebuilt environments, inspect <code class="literal">texlive.schemes</code>.</p></li><li class="listitem"><p>Packages cannot be used directly but must be assembled in an environment. To create or add packages to an environment, use</p><pre><code class="programlisting nix">texliveSmall.withPackages (
  ps: with ps; [
    collection-langkorean
    algorithms
    cm-super
  ]
)
</code></pre><p>The function <code class="literal">withPackages</code> can be called multiple times to add more packages.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><span class="strong"><strong>Note.</strong></span> Within Nixpkgs, packages should only use prebuilt environments as inputs, such as <code class="literal">texliveSmall</code> or <code class="literal">texliveInfraOnly</code>, and should not depend directly on <code class="literal">texlive</code>. Further dependencies should be added by calling <code class="literal">withPackages</code>. This is to ensure that there is a consistent and simple way to override the inputs.</p></li></ul></div></li><li class="listitem"><p><code class="literal">texlive.withPackages</code> uses the same logic as <code class="literal">buildEnv</code>. Only parts of a package are installed in an environment: its ‘runtime’ files (<code class="literal">tex</code> output), binaries (<code class="literal">out</code> output), and support files (<code class="literal">tlpkg</code> output). Moreover, man and info pages are assembled into separate <code class="literal">man</code> and <code class="literal">info</code> outputs. To add only the TeX files of a package, or its documentation (<code class="literal">texdoc</code> output), just specify the outputs:</p><pre><code class="programlisting nix">texlive.withPackages (
  ps: with ps; [
    texdoc # recommended package to navigate the documentation
    perlPackages.LaTeXML.tex # tex files of LaTeXML, omit binaries
    cm-super
    cm-super.texdoc # documentation of cm-super
  ]
)
</code></pre></li><li class="listitem"><p>All packages distributed by TeX Live, which contains most of CTAN, are available and can be found under <code class="literal">texlive.pkgs</code>:</p><pre><code class="programlisting ShellSession">$ nix repl
nix-repl&gt; :l &lt;nixpkgs&gt;
nix-repl&gt; texlive.pkgs.[TAB]
</code></pre><p>Note that the packages in <code class="literal">texlive.pkgs</code> are only provided for search purposes and must not be used directly.</p></li><li class="listitem"><p><span class="strong"><strong>Experimental and subject to change without notice:</strong></span> to add the documentation for all packages in the environment, use</p><pre><code class="programlisting nix">texliveSmall.__overrideTeXConfig { withDocs = true; }
</code></pre><p>This can be applied before or after calling <code class="literal">withPackages</code>.</p><p>The function currently support the parameters <code class="literal">withDocs</code>, <code class="literal">withSources</code>, and <code class="literal">requireTeXPackages</code>.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-language-texlive-user-guide" class="title" >User’s guide   </h3>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>For basic usage just pull <code class="literal">texlive.combined.scheme-basic</code> for an environment with basic LaTeX support.</p></li><li class="listitem"><p>It typically won’t work to use separately installed packages together. Instead, you can build a custom set of packages like this. Most CTAN packages should be available:</p><pre><code class="programlisting nix">texlive.combine {
  inherit (texlive)
    scheme-small
    collection-langkorean
    algorithms
    cm-super
    ;
}
</code></pre></li><li class="listitem"><p>There are all the schemes, collections and a few thousand packages, as defined upstream (perhaps with tiny differences).</p></li><li class="listitem"><p>By default you only get executables and files needed during runtime, and a little documentation for the core packages. To change that, you need to add <code class="literal">pkgFilter</code> function to <code class="literal">combine</code>.</p><pre><code class="programlisting nix">texlive.combine {
  # inherit (texlive) whatever-you-want;
  pkgFilter =
    pkg: pkg.tlType == &quot;run&quot; || pkg.tlType == &quot;bin&quot; || pkg.hasManpages || pkg.pname == &quot;cm-super&quot;;
  # elem tlType [ &quot;run&quot; &quot;bin&quot; &quot;doc&quot; &quot;source&quot; ]
  # there are also other attributes: version, name
}
</code></pre></li><li class="listitem"><p>You can list packages e.g. by <code class="literal">nix repl</code>.</p><pre><code class="programlisting ShellSession">$ nix repl
nix-repl&gt; :l &lt;nixpkgs&gt;
nix-repl&gt; texlive.collection-[TAB]
</code></pre></li><li class="listitem"><p>Note that the wrapper assumes that the result has a chance to be useful. For example, the core executables should be present, as well as some core data files. The supported way of ensuring this is by including some scheme, for example <code class="literal">scheme-basic</code>, into the combination.</p></li><li class="listitem"><p>TeX Live packages are also available under <code class="literal">texlive.pkgs</code> as derivations with outputs <code class="literal">out</code>, <code class="literal">tex</code>, <code class="literal">texdoc</code>, <code class="literal">texsource</code>, <code class="literal">tlpkg</code>, <code class="literal">man</code>, <code class="literal">info</code>. They cannot be installed outside of <code class="literal">texlive.combine</code> but are available for other uses. To repackage a font, for instance, use</p><pre><code class="programlisting nix">stdenvNoCC.mkDerivation (finalAttrs: {
  src = texlive.pkgs.iwona;
  dontUnpack = true;

  inherit (finalAttrs.src) pname version;

  installPhase = &#x27;&#x27;
    runHook preInstall
    install -Dm644 $src/fonts/opentype/nowacki/iwona/*.otf -t $out/share/fonts/opentype
    runHook postInstall
  &#x27;&#x27;;
})
</code></pre><p>See <code class="literal">biber</code>, <code class="literal">iwona</code> for complete examples.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-language-texlive-custom-packages" class="title" >Custom packages   </h3>  </div> </div></div><p>You may find that you need to use an external TeX package. A derivation for such package has to provide the contents of the “texmf” directory in its <code class="literal">&quot;tex&quot;</code> output, according to the <a class="link" href="https://tug.ctan.org/tds/tds.html"  target="_top">TeX Directory Structure</a>. Dependencies on other TeX packages can be listed in the attribute <code class="literal">tlDeps</code>.</p><p>The functions <code class="literal">texlive.combine</code> and <code class="literal">texlive.withPackages</code> recognise the following outputs:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">&quot;out&quot;</code>: contents are linked in the TeX Live environment, and binaries in the <code class="literal">$out/bin</code> folder are wrapped;</p></li><li class="listitem"><p><code class="literal">&quot;tex&quot;</code>: linked in <code class="literal">$TEXMFDIST</code>; files should follow the TDS (for instance <code class="literal">$tex/tex/latex/foiltex/foiltex.cls</code>);</p></li><li class="listitem"><p><code class="literal">&quot;texdoc&quot;</code>, <code class="literal">&quot;texsource&quot;</code>: ignored by default, treated as <code class="literal">&quot;tex&quot;</code>;</p></li><li class="listitem"><p><code class="literal">&quot;tlpkg&quot;</code>: linked in <code class="literal">$TEXMFROOT/tlpkg</code>;</p></li><li class="listitem"><p><code class="literal">&quot;man&quot;</code>, <code class="literal">&quot;info&quot;</code>, …: the other outputs are combined into separate outputs.</p></li></ul></div><p>When using <code class="literal">pkgFilter</code>, <code class="literal">texlive.combine</code> will assign <code class="literal">tlType</code> respectively <code class="literal">&quot;bin&quot;</code>, <code class="literal">&quot;run&quot;</code>, <code class="literal">&quot;doc&quot;</code>, <code class="literal">&quot;source&quot;</code>, <code class="literal">&quot;tlpkg&quot;</code> to the above outputs.</p><p>Here is a (very verbose) example. See also the packages <code class="literal">auctex</code>, <code class="literal">eukleides</code>, <code class="literal">mftrace</code> for more examples.</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { };

let
  foiltex = stdenvNoCC.mkDerivation {
    pname = &quot;latex-foiltex&quot;;
    version = &quot;2.1.4b&quot;;

    outputs = [
      &quot;tex&quot;
      &quot;texdoc&quot;
    ];
    passthru.tlDeps = with texlive; [ latex ];

    srcs = [
      (fetchurl {
        url = &quot;http://mirrors.ctan.org/macros/latex/contrib/foiltex/foiltex.dtx&quot;;
        hash = &quot;sha256-/2I2xHXpZi0S988uFsGuPV6hhMw8e0U5m/P8myf42R0=&quot;;
      })
      (fetchurl {
        url = &quot;http://mirrors.ctan.org/macros/latex/contrib/foiltex/foiltex.ins&quot;;
        hash = &quot;sha256-KTm3pkd+Cpu0nSE2WfsNEa56PeXBaNfx/sOO2Vv0kyc=&quot;;
      })
    ];

    unpackPhase = &#x27;&#x27;
      runHook preUnpack

      for _src in $srcs; do
        cp &quot;$_src&quot; $(stripHash &quot;$_src&quot;)
      done

      runHook postUnpack
    &#x27;&#x27;;

    nativeBuildInputs = [
      (texliveSmall.withPackages (
        ps: with ps; [
          cm-super
          hypdoc
          latexmk
        ]
      ))
      # multiple-outputs.sh fails if $out is not defined
      (writeShellScript &quot;force-tex-output.sh&quot; &#x27;&#x27;
        out=&quot;&#x27;&#x27;${tex-}&quot;
      &#x27;&#x27;)
      writableTmpDirAsHomeHook # Need a writable $HOME for latexmk
    ];

    dontConfigure = true;

    buildPhase = &#x27;&#x27;
      runHook preBuild

      # Generate the style files
      latex foiltex.ins

      # Generate the documentation
      latexmk -pdf foiltex.dtx

      runHook postBuild
    &#x27;&#x27;;

    installPhase = &#x27;&#x27;
      runHook preInstall

      path=&quot;$tex/tex/latex/foiltex&quot;
      mkdir -p &quot;$path&quot;
      cp *.{cls,def,clo,sty} &quot;$path/&quot;

      path=&quot;$texdoc/doc/tex/latex/foiltex&quot;
      mkdir -p &quot;$path&quot;
      cp *.pdf &quot;$path/&quot;

      runHook postInstall
    &#x27;&#x27;;

    meta = {
      description = &quot;LaTeX2e class for overhead transparencies&quot;;
      license = lib.licenses.unfreeRedistributable;
      maintainers = with lib.maintainers; [ veprbl ];
      platforms = lib.platforms.all;
    };
  };

  latex_with_foiltex = texliveSmall.withPackages (_: [ foiltex ]);
in
runCommand &quot;test.pdf&quot; { nativeBuildInputs = [ latex_with_foiltex ]; } &#x27;&#x27;
  cat &gt;test.tex &lt;&lt;EOF
  \documentclass{foils}

  \title{Presentation title}
  \date{}

  \begin{document}
  \maketitle
  \end{document}
  EOF
    pdflatex test.tex
    cp test.pdf $out
&#x27;&#x27;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-language-texlive-lualatex-font-cache" class="title" >LuaLaTeX font cache   </h3>  </div> </div></div><p>The font cache for LuaLaTeX is written to <code class="literal">$HOME</code>.
Therefore, it is necessary to set <code class="literal">$HOME</code> to a writable path, e.g. <a class="link" href="https://github.com/NixOS/nixpkgs/issues/180639"  target="_top">before using LuaLaTeX in nix derivations</a>:</p><pre><code class="programlisting nix">runCommandNoCC &quot;lualatex-hello-world&quot; { buildInputs = [ texliveFull ]; } &#x27;&#x27;
  mkdir $out
  echo &#x27;\documentclass{article} \begin{document} Hello world \end{document}&#x27; &gt; main.tex
  env HOME=$(mktemp -d) lualatex  -interaction=nonstopmode -output-format=pdf -output-directory=$out ./main.tex
&#x27;&#x27;
</code></pre><p>Additionally, <a class="link" href="https://github.com/NixOS/nixpkgs/issues/278718"  target="_top">the cache of a user can diverge from the nix store</a>.
To resolve font issues that might follow, the cache can be removed by the user:</p><pre><code class="programlisting ShellSession">luaotfload-tool --cache=erase --flush-lookups --force
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="typst" class="title" style="clear: both">Typst   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#typst-custom-environment">Custom Environment</a> </span></dt><dt> <span class="section">  <a href="index.html#typst-custom-packages">Custom Packages</a> </span></dt> </dl></div><p>Typst can be configured to include packages from <a class="link" href="https://typst.app/universe/"  target="_top">Typst Universe</a> or custom packages.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="typst-custom-environment" class="title" >Custom Environment   </h3>  </div> </div></div><p>You can create a custom Typst environment with a selected set of packages from <span class="strong"><strong>Typst Universe</strong></span> using the following code. It is also possible to specify a Typst package with a specific version (e.g., <code class="literal">cetz_0_3_0</code>). A package without a version number will always refer to its latest version.</p><pre><code class="programlisting nix">typst.withPackages (
  p: with p; [
    polylux_0_4_0
    cetz_0_3_0
  ]
)
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="typst-handling-outdated-package-hashes" class="title" >Handling Outdated Package Hashes   </h4>  </div> </div></div><p>Since <span class="strong"><strong>Typst Universe</strong></span> does not provide a way to fetch a package with a specific hash, the package hashes in <code class="literal">nixpkgs</code> can sometimes be outdated. To resolve this issue, you can manually override the package source using the following approach:</p><pre><code class="programlisting nix">typst.withPackages.override
  (old: {
    typstPackages = old.typstPackages.extend (
      _: previous: {
        polylux_0_4_0 = previous.polylux_0_4_0.overrideAttrs (oldPolylux: {
          src = oldPolylux.src.overrideAttrs { outputHash = YourUpToDatePolyluxHash; };
        });
      }
    );
  })
  (
    p: with p; [
      polylux_0_4_0
      cetz_0_3_0
    ]
  )
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="typst-custom-packages" class="title" >Custom Packages   </h3>  </div> </div></div><p><code class="literal">Nixpkgs</code> provides a helper function, <code class="literal">buildTypstPackage</code>, to build custom Typst packages that can be used within the Typst environment. However, all dependencies of the custom package must be explicitly specified in <code class="literal">typstDeps</code>.</p><p>Here’s how to define a custom Typst package:</p><pre><code class="programlisting nix">{ buildTypstPackage, typstPackages }:

buildTypstPackage (finalAttrs: {
  pname = &quot;my-typst-package&quot;;
  version = &quot;0.0.1&quot;;
  src = ./.;
  typstDeps = with typstPackages; [ cetz_0_3_0 ];
})
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="typst-package-scope-and-usage" class="title" >Package Scope and Usage   </h4>  </div> </div></div><p>By default, every custom package is scoped under <code class="literal">@preview</code>, as shown below:</p><pre><code class="programlisting typst">#import &quot;@preview/my-typst-package:0.0.1&quot;: *
</code></pre><p>Since <code class="literal">@preview</code> is intended for packages from <span class="strong"><strong>Typst Universe</strong></span>, it is recommended to use this approach <span class="strong"><strong>only for temporary or experimental modifications over existing packages</strong></span> from <span class="strong"><strong>Typst Universe</strong></span>.</p><p>On the other hand, <span class="strong"><strong>local packages</strong></span>, packages scoped under <code class="literal">@local</code>, are <span class="strong"><strong>not</strong></span> considered part of the Typst environment. This means that local packages must be manually linked to the Typst compiler if needed.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="vim" class="title" style="clear: both">Vim   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#vim-custom-configuration">Custom configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#managing-plugins-with-vim-packages">Managing plugins with Vim packages</a> </span></dt><dt> <span class="section">  <a href="index.html#managing-plugins-with-vim-plug">Managing plugins with vim-plug</a> </span></dt><dt> <span class="section">  <a href="index.html#adding-new-plugins-to-nixpkgs">Adding new plugins to nixpkgs</a> </span></dt><dt> <span class="section">  <a href="index.html#updating-plugins-in-nixpkgs">Updating plugins in nixpkgs</a> </span></dt><dt> <span class="section">  <a href="index.html#vim-out-of-tree-overlays">How to maintain an out-of-tree overlay of vim plugins ?</a> </span></dt> </dl></div><p>Vim can be configured to include your favorite plugins and additional libraries.</p><p>Loading can be deferred; see examples.</p><p>At the moment we support two different methods for managing plugins:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Vim packages (<span class="emphasis"><em>recommended</em></span>)</p></li><li class="listitem"><p>vim-plug (vim only)</p></li></ul></div><p>Right now two Vim packages are available: <code class="literal">vim</code> which has most features that require extra
dependencies disabled and <code class="literal">vim-full</code> which has them configurable and enabled by default.</p><div class="note"><h3 class="title">Note</h3><p><code class="literal">vim_configurable</code> is a deprecated alias for <code class="literal">vim-full</code> and refers to the fact that its
build-time features are configurable. It has nothing to do with user configuration,
and both the <code class="literal">vim</code> and <code class="literal">vim-full</code> packages can be customized as explained in the next section.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="vim-custom-configuration" class="title" >Custom configuration   </h3>  </div> </div></div><p>Adding custom .vimrc lines can be done using the following code:</p><pre><code class="programlisting nix">vim-full.customize {
  # `name` optionally specifies the name of the executable and package
  name = &quot;vim-with-plugins&quot;;

  vimrcConfig.customRC = &#x27;&#x27;
    set hidden
  &#x27;&#x27;;
}
</code></pre><p>This configuration is used when Vim is invoked with the command specified as name, in this case <code class="literal">vim-with-plugins</code>.
You can also omit <code class="literal">name</code> to customize Vim itself. See the
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/vim/plugins/vim-utils.nix#L408"  target="_top">definition of <code class="literal">vimUtils.makeCustomizable</code></a>
for all supported options.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="managing-plugins-with-vim-packages" class="title" >Managing plugins with Vim packages   </h3>  </div> </div></div><p>To store your plugins in Vim packages (the native Vim plugin manager, see <code class="literal">:help packages</code>) the following example can be used:</p><pre><code class="programlisting nix">vim-full.customize {
  vimrcConfig.packages.myVimPackage = with pkgs.vimPlugins; {
    # loaded on launch
    start = [
      youcompleteme
      fugitive
    ];
    # manually loadable by calling `:packadd $plugin-name`
    # however, if a Vim plugin has a dependency that is not explicitly listed in
    # opt that dependency will always be added to start to avoid confusion.
    opt = [
      phpCompletion
      elm-vim
    ];
    # To automatically load a plugin when opening a filetype, add vimrc lines like:
    # autocmd FileType php :packadd phpCompletion
  };
}
</code></pre><p>The resulting package can be added to <code class="literal">packageOverrides</code> in <code class="literal">~/.nixpkgs/config.nix</code> to make it installable:</p><pre><code class="programlisting nix">{
  packageOverrides =
    pkgs: with pkgs; {
      myVim = vim-full.customize {
        # `name` specifies the name of the executable and package
        name = &quot;vim-with-plugins&quot;;
        # add here code from the example section
      };
      myNeovim = neovim.override {
        configure = {
          # add code from the example section here
        };
      };
    };
}
</code></pre><p>After that you can install your special grafted <code class="literal">myVim</code> or <code class="literal">myNeovim</code> packages.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="what-if-your-favourite-vim-plugin-isnt-already-packaged" class="title" >What if your favourite Vim plugin isn’t already packaged?   </h4>  </div> </div></div><p>If one of your favourite plugins isn’t packaged, you can package it yourself:</p><pre><code class="programlisting nix">{ config, pkgs, ... }:

let
  easygrep = pkgs.vimUtils.buildVimPlugin {
    name = &quot;vim-easygrep&quot;;
    src = pkgs.fetchFromGitHub {
      owner = &quot;dkprice&quot;;
      repo = &quot;vim-easygrep&quot;;
      rev = &quot;d0c36a77cc63c22648e792796b1815b44164653a&quot;;
      hash = &quot;sha256-bL33/S+caNmEYGcMLNCanFZyEYUOUmSsedCVBn4tV3g=&quot;;
    };
  };
in
{
  environment.systemPackages = [
    (pkgs.neovim.override {
      configure = {
        packages.myPlugins = with pkgs.vimPlugins; {
          start = [
            vim-go # already packaged plugin
            easygrep # custom package
          ];
          opt = [ ];
        };
        # ...
      };
    })
  ];
}
</code></pre><p>If your package requires building specific parts, use instead <code class="literal">pkgs.vimUtils.buildVimPlugin</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="managing-plugins-with-vim-plug" class="title" >Managing plugins with vim-plug   </h3>  </div> </div></div><p>To use <a class="link" href="https://github.com/junegunn/vim-plug"  target="_top">vim-plug</a> to manage your Vim
plugins the following example can be used:</p><pre><code class="programlisting nix">vim-full.customize {
  vimrcConfig.packages.myVimPackage = with pkgs.vimPlugins; {
    # loaded on launch
    plug.plugins = [
      youcompleteme
      fugitive
      phpCompletion
      elm-vim
    ];
  };
}
</code></pre><p>Note: this is not possible anymore for Neovim.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="adding-new-plugins-to-nixpkgs" class="title" >Adding new plugins to nixpkgs   </h3>  </div> </div></div><p>Nix expressions for Vim plugins are stored in <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/pkgs/applications/editors/vim/plugins"  target="_top">pkgs/applications/editors/vim/plugins</a>. For the vast majority of plugins, Nix expressions are automatically generated by running <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/vim/plugins/utils/updater.nix"  target="_top"><code class="literal">nix-shell -p vimPluginsUpdater --run vim-plugins-updater</code></a>. This creates a <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/vim/plugins/generated.nix"  target="_top">generated.nix</a> file based on the plugins listed in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/vim/plugins/vim-plugin-names"  target="_top">vim-plugin-names</a>.</p><p>When the vim updater detects an nvim-treesitter update, it also runs <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/vim/plugins/utils/update.py"  target="_top"><code class="literal">nvim-treesitter/update.py $(nix-build -A vimPlugins.nvim-treesitter)</code></a> to update the tree sitter grammars for <code class="literal">nvim-treesitter</code>.</p><p>Some plugins require overrides in order to function properly. Overrides are placed in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/vim/plugins/overrides.nix"  target="_top">overrides.nix</a>. Overrides are most often required when a plugin requires some dependencies, or extra steps are required during the build process. For example <code class="literal">deoplete-fish</code> requires both <code class="literal">deoplete-nvim</code> and <code class="literal">vim-fish</code>, and so the following override was added:</p><pre><code class="programlisting nix">{
  deoplete-fish = super.deoplete-fish.overrideAttrs (old: {
    dependencies = with super; [
      deoplete-nvim
      vim-fish
    ];
  });
}
</code></pre><p>Sometimes plugins require an override that must be changed when the plugin is updated. This can cause issues when Vim plugins are auto-updated but the associated override isn’t updated. For these plugins, the override should be written so that it specifies all information required to install the plugin, and running <code class="literal">nix-shell -p vimPluginsUpdater --run vim-plugins-updater</code> doesn’t change the derivation for the plugin. Manually updating the override is required to update these types of plugins. An example of such a plugin is <code class="literal">LanguageClient-neovim</code>.</p><p>To add a new plugin, run <code class="literal">nix-shell -p vimPluginsUpdater --run &#x27;vim-plugins-updater add &quot;[owner]/[name]&quot;&#x27;</code>. <span class="strong"><strong>NOTE</strong></span>: This script automatically commits to your git repository. Be sure to check out a fresh branch before running.</p><p>Finally, there are some plugins that are also packaged in nodePackages because they have Javascript-related build steps, such as running webpack. Those plugins are not listed in <code class="literal">vim-plugin-names</code> or managed by <code class="literal">vimPluginsUpdater</code> at all, and are included separately in <code class="literal">overrides.nix</code>. Currently, all these plugins are related to the <code class="literal">coc.nvim</code> ecosystem of the Language Server Protocol integration with Vim/Neovim.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="updating-plugins-in-nixpkgs" class="title" >Updating plugins in nixpkgs   </h3>  </div> </div></div><p>Run the update script with a GitHub API token that has at least <code class="literal">public_repo</code> access. Running the script without the token is likely to result in rate-limiting (429 errors). For steps on creating an API token, please refer to <a class="link" href="https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token"  target="_top">GitHub’s token documentation</a>.</p><pre><code class="programlisting sh">nix-shell -p vimPluginsUpdater --run &#x27;vim-plugins-updater --github-token=mytoken&#x27; # or set GITHUB_TOKEN environment variable
</code></pre><p>Alternatively, set the number of processes to a lower count to avoid rate-limiting.</p><pre><code class="programlisting sh">nix-shell -p vimPluginsUpdater --run &#x27;vim-plugins-updater --proc 1&#x27;
</code></pre><p>If you want to update only certain plugins, you can specify them after the <code class="literal">update</code> command. Note that you must use the same plugin names as the <code class="literal">pkgs/applications/editors/vim/plugins/vim-plugin-names</code> file.</p><pre><code class="programlisting sh">nix-shell -p vimPluginsUpdater --run &#x27;vim-plugins-updater update &quot;nvim-treesitter&quot; &quot;LazyVim&quot;&#x27;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="vim-out-of-tree-overlays" class="title" >How to maintain an out-of-tree overlay of vim plugins ?   </h3>  </div> </div></div><p>You can use the updater script to generate basic packages out of a custom vim
plugin list:</p><pre><code class="programlisting">nix-shell -p vimPluginsUpdater --run vim-plugins-updater -i vim-plugin-names -o generated.nix --no-commit
</code></pre><p>with the contents of <code class="literal">vim-plugin-names</code> being for example:</p><pre><code class="programlisting">repo,branch,alias
pwntester/octo.nvim,,
</code></pre><p>You can then reference the generated vim plugins via:</p><pre><code class="programlisting nix">{
  myVimPlugins = pkgs.vimPlugins.extend ((pkgs.callPackage ./generated.nix { }));
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="neovim" class="title" style="clear: both">Neovim   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#neovim-custom-configuration">Custom configuration</a> </span></dt> </dl></div><p>Install <code class="literal">neovim-unwrapped</code> to get a barebone neovim to configure imperatively.
This is the closest to what you encounter on other distributions.</p><p><code class="literal">neovim</code> is a wrapper around neovim with some extra configuration to for
instance set the various language providers like python.
The wrapper can be further configured to include your favorite plugins and
configurations for a reproducible neovim across machines.
See the next section for more details.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="neovim-custom-configuration" class="title" >Custom configuration   </h3>  </div> </div></div><p>There are two wrappers available to provide additional configuration around the vanilla package <code class="literal">pkgs.neovim-unwrapped</code>:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p><code class="literal">wrapNeovim</code>: the historical one you should use</p></li><li class="listitem"><p><code class="literal">wrapNeovimUnstable</code> intended to replace the former. It has more features but
the interface is not stable yet.</p></li></ol></div><p>You can configure the former via:</p><pre><code class="programlisting nix">neovim.override {
  configure = {
    customRC = &#x27;&#x27;
      # here your custom configuration goes!
    &#x27;&#x27;;
    packages.myVimPackage = with pkgs.vimPlugins; {
      # See examples below on how to use custom packages.
      start = [ ];
      # If a Vim plugin has a dependency that is not explicitly listed in
      # `opt`, that dependency will always be added to `start` to avoid confusion.
      opt = [ ];
    };
  };
}
</code></pre><p><code class="literal">myVimPackage</code> is an arbitrary name for the generated package. You can choose any name you like.</p><p>If you want to use <code class="literal">neovim-qt</code> as a graphical editor, you can configure it by overriding Neovim in an overlay
or passing it an overridden Neovim:</p><pre><code class="programlisting nix">neovim-qt.override {
  neovim = neovim.override {
    configure = {
      customRC = &#x27;&#x27;
        # your custom configuration
      &#x27;&#x27;;
    };
  };
}
</code></pre><p>You can use the new unstable wrapper but the interface may change:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">autoconfigure</code>: certain plugins need a custom configuration to work with nix.
For instance, <code class="literal">sqlite-lua</code> needs <code class="literal">g:sqlite_clib_path</code> to be set to work. Nixpkgs historically patched these in the plugins with several drawbacks: harder maintenance and making upstream work harder. Per convention, these mandatory bits of configuration are bookmarked in nixpkgs in <code class="literal">passthru.initLua</code>. Enabling <code class="literal">autoconfigure</code> automatically adds the snippets required for the plugins to work.</p></li><li class="listitem"><p><code class="literal">autowrapRuntimeDeps</code>: Appends plugin’s runtime dependencies to <code class="literal">PATH</code>. For instance, <code class="literal">rest.nvim</code> requires <code class="literal">curl</code> to work. Enabling <code class="literal">autowrapRuntimeDeps</code> adds it to the <code class="literal">PATH</code> visible by your Neovim wrapper (but not your global <code class="literal">PATH</code>).</p></li><li class="listitem"><p><code class="literal">luaRcContent</code>: Extra lua code to add to the generated <code class="literal">init.lua</code>.</p></li><li class="listitem"><p><code class="literal">neovimRcContent</code>: Extra vimL code sourced by the generated <code class="literal">init.lua</code>.</p></li><li class="listitem"><p><code class="literal">wrapperArgs</code>: Extra arguments forwarded to the <code class="literal">makeWrapper</code> call.</p></li><li class="listitem"><p><code class="literal">wrapRc</code>: Nix, not being able to write in your <code class="literal">$HOME</code>, loads the
generated Neovim configuration via the <code class="literal">$VIMINIT</code> environment variable, i.e. : <code class="literal">export VIMINIT=&#x27;lua dofile(&quot;/nix/store/…-init.lua&quot;)&#x27;</code>. This has side effects like preventing Neovim from sourcing your <code class="literal">init.lua</code> in <code class="literal">$XDG_CONFIG_HOME/nvim</code> (see bullet 7 of <a class="link" href="https://neovim.io/doc/user/starting.html#startup"  target="_top"><code class="literal">:help startup</code></a> in Neovim). Disable it if you want to generate your own wrapper. You can still reuse the generated vimscript init code via <code class="literal">neovim.passthru.initRc</code>.</p></li><li class="listitem"><p><code class="literal">plugins</code>: A list of plugins to add to the wrapper.</p></li></ul></div><pre><code class="programlisting">wrapNeovimUnstable neovim-unwrapped {
  autoconfigure = true;
  autowrapRuntimeDeps = true;
  luaRcContent = &#x27;&#x27;
    vim.o.sessionoptions = &#x27;buffers,curdir,help,tabpages,winsize,winpos,localoptions&#x27;
    vim.g.mapleader = &#x27; &#x27;
    vim.g.maplocalleader = &#x27; &#x27;
    vim.opt.smoothscroll = true
    vim.opt.colorcolumn = { 100 }
    vim.opt.termguicolors = true
  &#x27;&#x27;;
  # plugins accepts a list of either plugins or { plugin = ...; config = ..vimscript.. };
  plugins = with vimPlugins; [
    {
      plugin = vim-obsession;
      config = &#x27;&#x27;
        map &lt;Leader&gt;$ &lt;Cmd&gt;Obsession&lt;CR&gt;
      &#x27;&#x27;;
    }
    (nvim-treesitter.withPlugins (p: [ p.nix p.python ]))
    hex-nvim
  ];
}
</code></pre><p>You can explore the configuration with<code class="literal">nix repl</code> to discover these options and
override them. For instance:</p><pre><code class="programlisting nix">neovim.overrideAttrs (oldAttrs: {
  autowrapRuntimeDeps = false;
})
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="neovim-plugin-specificities" class="title" >Specificities for some plugins   </h4>  </div> </div></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="neovim-plugin-required-snippet" class="title" >Plugin optional configuration   </h4>  </div> </div></div><p>Some plugins require specific configuration to work. We choose not to
patch those plugins but expose the necessary configuration under
<code class="literal">PLUGIN.passthru.initLua</code> for neovim plugins. For instance, the <code class="literal">unicode-vim</code> plugin
needs the path towards a unicode database so we expose the following snippet <code class="literal">vim.g.Unicode_data_directory=&quot;${self.unicode-vim}/autoload/unicode&quot;</code> under <code class="literal">vimPlugins.unicode-vim.passthru.initLua</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="neovim-luarocks-based-plugins" class="title" >LuaRocks based plugins   </h5>  </div> </div></div><p>In order to automatically handle plugin dependencies, several neovim plugins
upload their package to <a class="link" href="https://www.luarocks.org"  target="_top">LuaRocks</a>. This means less work for nixpkgs maintainers in the long term as dependencies get updated automatically.
This means several neovim plugins are first packaged as nixpkgs <a class="link" href="index.html#packaging-a-library-on-luarocks" title="Packaging a library on luarocks" >lua
packages</a>, and converted via <code class="literal">buildNeovimPlugin</code> in
a vim plugin. This conversion is necessary because neovim expects lua folders to be
top-level while luarocks installs them in various subfolders by default.</p><p>For instance:</p><pre><code class="programlisting nix">{
  rtp-nvim = neovimUtils.buildNeovimPlugin { luaAttr = luaPackages.rtp-nvim; };
}
</code></pre><p>To update these packages, you should use the lua updater rather than vim’s.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="neovim-plugin-treesitter" class="title" >Treesitter   </h5>  </div> </div></div><p>By default <code class="literal">nvim-treesitter</code> encourages you to download, compile and install
the required Treesitter grammars at run time with <code class="literal">:TSInstall</code>. This works
poorly on NixOS.  Instead, to install the <code class="literal">nvim-treesitter</code> plugins with a set
of precompiled grammars, you can use the <code class="literal">nvim-treesitter.withPlugins</code> function:</p><pre><code class="programlisting nix">(pkgs.neovim.override {
  configure = {
    packages.myPlugins = with pkgs.vimPlugins; {
      start = [
        (nvim-treesitter.withPlugins (
          plugins: with plugins; [
            nix
            python
          ]
        ))
      ];
    };
  };
})
</code></pre><p>To enable all grammars packaged in nixpkgs, use <code class="literal">pkgs.vimPlugins.nvim-treesitter.withAllGrammars</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="testing-neovim-plugins" class="title" >Testing Neovim plugins   </h4>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="testing-neovim-plugins-neovim-require-check" class="title" >neovimRequireCheck   </h5>  </div> </div></div><p><code class="literal">neovimRequireCheck</code> is a simple test which checks if Neovim can requires lua modules without errors. This is often enough to catch missing dependencies.</p><p>It accepts a single string for a module, or a list of module strings to test.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">nvimRequireCheck = MODULE;</code></p></li><li class="listitem"><p><code class="literal">nvimRequireCheck = [ MODULE1 MODULE2 ];</code></p></li></ul></div><p>When <code class="literal">nvimRequireCheck</code> is not specified, we will search the plugin’s directory for lua modules to attempt loading. This quick smoke test can catch obvious dependency errors that might be missed.
The check hook will fail the build if any modules cannot be loaded. This encourages inspecting the logs to identify potential issues.</p><p>To only check a specific module, add it manually to the plugin definition <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/vim/plugins/overrides.nix"  target="_top">overrides</a>.</p><pre><code class="programlisting nix">{
  gitsigns-nvim = super.gitsigns-nvim.overrideAttrs {
    dependencies = [ self.plenary-nvim ];
    nvimRequireCheck = &quot;gitsigns&quot;;
  };
}
</code></pre><p>Some plugins will have lua modules that require a user configuration to function properly or can contain optional lua modules that we dont want to test requiring.
We can skip specific modules using <code class="literal">nvimSkipModules</code>. Similar to <code class="literal">nvimRequireCheck</code>, it accepts a list of strings.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">nvimSkipModules = [ MODULE1 MODULE2 ];</code></p></li></ul></div><pre><code class="programlisting nix">{
  asyncrun-vim = super.asyncrun-vim.overrideAttrs {
    nvimSkipModules = [
      # vim plugin with optional toggleterm integration
      &quot;asyncrun.toggleterm&quot;
      &quot;asyncrun.toggleterm2&quot;
    ];
  };
}
</code></pre><p>In rare cases, we might not want to actually test loading lua modules for a plugin. In those cases, we can disable <code class="literal">neovimRequireCheck</code> with <code class="literal">doCheck = false;</code>.</p><p>This can be manually added through plugin definition overrides in the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/vim/plugins/overrides.nix"  target="_top">overrides.nix</a>.</p><pre><code class="programlisting nix">{
  vim-test = super.vim-test.overrideAttrs {
    # Vim plugin with a test lua file
    doCheck = false;
  };
}
</code></pre>
</div>

</div>

</div>

</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-packages" class="title" >Packages   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-citrix">Citrix Workspace</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-darwin-builder">darwin.linux-builder</a> </span></dt><dt> <span class="section">  <a href="index.html#dlib">DLib</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-eclipse">Eclipse</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-elm">Elm</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-emacs">Emacs</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-firefox">Firefox</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-fish">Fish</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-fuse">FUSE</a> </span></dt><dt> <span class="section">  <a href="index.html#geant4">Geant4</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-ibus-typing-booster">ibus-engines.typing-booster</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-inkscape">Inkscape</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-kakoune">Kakoune</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-krita">Krita</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-linux-kernel">Linux kernel</a> </span></dt><dt> <span class="section">  <a href="index.html#lhapdf">LHAPDF</a> </span></dt><dt> <span class="section">  <a href="index.html#locales">Locales</a> </span></dt><dt> <span class="section">  <a href="index.html#etc">/etc files</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-nginx">Nginx</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-opengl">OpenGL</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-shell-helpers">Interactive shell helpers</a> </span></dt><dt> <span class="section">  <a href="index.html#python-tree-sitter">Python Tree Sitter</a> </span></dt><dt> <span class="section">  <a href="index.html#treefmt">treefmt</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-steam">Steam</a> </span></dt><dt> <span class="section">  <a href="index.html#cataclysm-dark-days-ahead">Cataclysm: Dark Days Ahead</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-urxvt">Urxvt</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-vcpkg">VCPKG</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-weechat">WeeChat</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-xorg">X.org</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-build-support">Build Support</a> </span></dt> </dl></div><p>This chapter contains information about how to use and maintain the Nix expressions for a number of specific packages, such as the Linux kernel or X.org.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-citrix" class="title" style="clear: both">Citrix Workspace   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-citrix-base">Basic usage</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-citrix-selfservice">Citrix Self-service</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-citrix-custom-certs">Custom certificates</a> </span></dt> </dl></div><p>The <a class="link" href="https://www.citrix.com/products/workspace-app/"  target="_top">Citrix Workspace App</a> is a remote desktop viewer which provides access to <a class="link" href="https://www.citrix.com/products/xenapp-xendesktop/"  target="_top">XenDesktop</a> installations.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-citrix-base" class="title" >Basic usage   </h3>  </div> </div></div><p>The tarball archive needs to be downloaded manually, as the license agreements of the vendor for <a class="link" href="https://www.citrix.com/downloads/workspace-app/linux/workspace-app-for-linux-latest.html"  target="_top">Citrix Workspace</a> needs to be accepted first. Then run <code class="literal">nix-prefetch-url file://$PWD/linuxx64-$version.tar.gz</code>. With the archive available in the store, the package can be built and installed with Nix.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-citrix-selfservice" class="title" >Citrix Self-service   </h3>  </div> </div></div><p>The <a class="link" href="https://support.citrix.com/article/CTX200337"  target="_top">self-service</a> is an application managing Citrix desktops and applications. Please note that this feature only works with at least citrix_workspace_20_06_0 and later versions.</p><p>In order to set this up, you first have to <a class="link" href="https://its.uiowa.edu/support/article/102186"  target="_top">download the <code class="literal">.cr</code> file from the Netscaler Gateway</a>. After that, you can configure the <code class="literal">selfservice</code> like this:</p><pre><code class="programlisting ShellSession">$ storebrowse -C ~/Downloads/receiverconfig.cr
$ selfservice
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-citrix-custom-certs" class="title" >Custom certificates   </h3>  </div> </div></div><p>The <code class="literal">Citrix Workspace App</code> in <code class="literal">nixpkgs</code> trusts several certificates <a class="link" href="https://curl.haxx.se/docs/caextract.html"  target="_top">from the Mozilla database</a> by default. However, several companies using Citrix might require their own corporate certificate. On distros with imperative packaging, these certs can be stored easily in <a class="link" href="https://citrix.github.io/receiver-for-linux-command-reference/"  target="_top"><code class="literal">$ICAROOT</code></a>, however this directory is a store path in <code class="literal">nixpkgs</code>. In order to work around this issue, the package provides a simple mechanism to add custom certificates without rebuilding the entire package using <code class="literal">symlinkJoin</code>:</p><pre><code class="programlisting nix">with import &lt;nixpkgs&gt; { config.allowUnfree = true; };
let
  extraCerts = [
    ./custom-cert-1.pem
    ./custom-cert-2.pem # ...
  ];
in
citrix_workspace.override { inherit extraCerts; }
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-darwin-builder" class="title" style="clear: both">darwin.linux-builder   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-darwin-builder-example-flake">Example flake usage</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-darwin-builder-reconfiguring">Reconfiguring the remote builder</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-darwin-builder-troubleshoot">Troubleshooting the generated configuration</a> </span></dt> </dl></div><div class="warning"><h3 class="title">Warning</h3><p>By default, <code class="literal">darwin.linux-builder</code> uses a publicly-known private SSH <span class="strong"><strong>host key</strong></span> (this is different from the SSH key used by the user that connects to the builder).</p><p>Given the intended use case for it (a Linux builder that runs <span class="strong"><strong>on the same machine</strong></span>), this shouldn’t be an issue.
However, if you plan to deviate from this use case in any way (e.g. by exposing this builder to remote machines), you should understand the security implications of doing so and take any appropriate measures.</p></div><p><code class="literal">darwin.linux-builder</code> provides a way to bootstrap a Linux remote builder on a macOS machine.</p><p>This requires macOS version 12.4 or later.</p><p>The remote builder runs on host port 31022 by default.
You can change it by overriding <code class="literal">virtualisation.darwin-builder.hostPort</code>.
See the <a class="link" href="index.html#sec-darwin-builder-example-flake" title="Example flake usage" >example</a>.</p><p>You will also need to be a trusted user for your Nix installation.  In other
words, your <code class="literal">/etc/nix/nix.conf</code> should have something like:</p><pre><code class="programlisting">extra-trusted-users = &lt;your username goes here&gt;
</code></pre><p>To launch the remote builder, run the following flake:</p><pre><code class="programlisting ShellSession">$ nix run nixpkgs#darwin.linux-builder
</code></pre><p>That will prompt you to enter your <code class="literal">sudo</code> password:</p><pre><code class="programlisting">+ sudo --reset-timestamp /nix/store/…-install-credentials.sh ./keys
Password:
</code></pre><p>… so that it can install a private key used to <code class="literal">ssh</code> into the build server.
After that the script will launch the virtual machine and automatically log you
in as the <code class="literal">builder</code> user:</p><pre><code class="programlisting">&lt;&lt;&lt; Welcome to NixOS 22.11.20220901.1bd8d11 (aarch64) - ttyAMA0 &gt;&gt;&gt;

Run &#x27;nixos-help&#x27; for the NixOS manual.

nixos login: builder (automatic login)


[builder@nixos:~]$
</code></pre><div class="blockquote"><blockquote class="blockquote"><p>Note: When you need to stop the VM, run <code class="literal">shutdown now</code> as the <code class="literal">builder</code> user.</p></blockquote></div><p>To delegate builds to the remote builder, add the following options to your
<code class="literal">nix.conf</code> file:</p><pre><code class="programlisting"># - Replace ${ARCH} with either aarch64 or x86_64 to match your host machine
# - Replace ${MAX_JOBS} with the maximum number of builds (pick 4 if you&#x27;re not sure)
builders = ssh-ng://builder@linux-builder ${ARCH}-linux /etc/nix/builder_ed25519 ${MAX_JOBS} - - - c3NoLWVkMjU1MTkgQUFBQUMzTnphQzFsWkRJMU5URTVBQUFBSUpCV2N4Yi9CbGFxdDFhdU90RStGOFFVV3JVb3RpQzVxQkorVXVFV2RWQ2Igcm9vdEBuaXhvcwo=

# Not strictly necessary, but this will reduce your disk utilization
builders-use-substitutes = true
</code></pre><p>To allow Nix to connect to a remote builder not running on port 22, you will also need to create a new file at <code class="literal">/etc/ssh/ssh_config.d/100-linux-builder.conf</code>:</p><pre><code class="programlisting">Host linux-builder
  Hostname localhost
  HostKeyAlias linux-builder
  Port 31022
</code></pre><p>… and then restart your Nix daemon to apply the change:</p><pre><code class="programlisting ShellSession">$ sudo launchctl kickstart -k system/org.nixos.nix-daemon
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-darwin-builder-example-flake" class="title" >Example flake usage   </h3>  </div> </div></div><pre><code class="programlisting nix">{
  inputs = {
    nixpkgs.url = &quot;github:nixos/nixpkgs/nixpkgs-22.11-darwin&quot;;
    darwin.url = &quot;github:lnl7/nix-darwin/master&quot;;
    darwin.inputs.nixpkgs.follows = &quot;nixpkgs&quot;;
  };

  outputs =
    {
      self,
      darwin,
      nixpkgs,
      ...
    }@inputs:
    let

      inherit (darwin.lib) darwinSystem;
      system = &quot;aarch64-darwin&quot;;
      pkgs = nixpkgs.legacyPackages.&quot;${system}&quot;;
      linuxSystem = builtins.replaceStrings [ &quot;darwin&quot; ] [ &quot;linux&quot; ] system;

      darwin-builder = nixpkgs.lib.nixosSystem {
        system = linuxSystem;
        modules = [
          &quot;${nixpkgs}/nixos/modules/profiles/nix-builder-vm.nix&quot;
          {
            virtualisation = {
              host.pkgs = pkgs;
              darwin-builder.workingDirectory = &quot;/var/lib/darwin-builder&quot;;
              darwin-builder.hostPort = 22;
            };
          }
        ];
      };
    in
    {

      darwinConfigurations = {
        machine1 = darwinSystem {
          inherit system;
          modules = [
            {
              nix.distributedBuilds = true;
              nix.buildMachines = [
                {
                  hostName = &quot;localhost&quot;;
                  sshUser = &quot;builder&quot;;
                  sshKey = &quot;/etc/nix/builder_ed25519&quot;;
                  system = linuxSystem;
                  maxJobs = 4;
                  supportedFeatures = [
                    &quot;kvm&quot;
                    &quot;benchmark&quot;
                    &quot;big-parallel&quot;
                  ];
                }
              ];

              launchd.daemons.darwin-builder = {
                command = &quot;${darwin-builder.config.system.build.macos-builder-installer}/bin/create-builder&quot;;
                serviceConfig = {
                  KeepAlive = true;
                  RunAtLoad = true;
                  StandardOutPath = &quot;/var/log/darwin-builder.log&quot;;
                  StandardErrorPath = &quot;/var/log/darwin-builder.log&quot;;
                };
              };
            }
          ];
        };
      };

    };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-darwin-builder-reconfiguring" class="title" >Reconfiguring the remote builder   </h3>  </div> </div></div><p>Initially you should not change the remote builder configuration else you will not be
able to use the binary cache. However, after you have the remote builder running locally
you may use it to build a modified remote builder with additional storage or memory.</p><p>To do this, you just need to set the <code class="literal">virtualisation.darwin-builder.*</code> parameters as
in the example below and rebuild.</p><pre><code class="programlisting nix">{
  darwin-builder = nixpkgs.lib.nixosSystem {
    system = linuxSystem;
    modules = [
      &quot;${nixpkgs}/nixos/modules/profiles/nix-builder-vm.nix&quot;
      {
        virtualisation.host.pkgs = pkgs;
        virtualisation.darwin-builder.diskSize = 5120;
        virtualisation.darwin-builder.memorySize = 1024;
        virtualisation.darwin-builder.hostPort = 33022;
        virtualisation.darwin-builder.workingDirectory = &quot;/var/lib/darwin-builder&quot;;
      }
    ];
  };
}
</code></pre><p>You may make any other changes to your VM in this attribute set. For example,
you could enable Docker or X11 forwarding to your Darwin host.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-darwin-builder-troubleshoot" class="title" >Troubleshooting the generated configuration   </h3>  </div> </div></div><p>The <code class="literal">linux-builder</code> package exposes the attributes <code class="literal">nixosConfig</code> and <code class="literal">nixosOptions</code> that allow you to inspect the generated NixOS configuration in the <code class="literal">nix repl</code>. For example:</p><pre><code class="programlisting">$ nix repl --file ~/src/nixpkgs --argstr system aarch64-darwin

nix-repl&gt; darwin.linux-builder.nixosConfig.nix.package
«derivation /nix/store/...-nix-2.17.0.drv»

nix-repl&gt; :p darwin.linux-builder.nixosOptions.virtualisation.memorySize.definitionsWithLocations
[ { file = &quot;/home/user/src/nixpkgs/nixos/modules/profiles/nix-builder-vm.nix&quot;; value = 3072; } ]

</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="dlib" class="title" style="clear: both">DLib   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#compiling-without-avx-support">Compiling without AVX support</a> </span></dt> </dl></div><p><a class="link" href="http://dlib.net/"  target="_top">DLib</a> is a modern, C++-based toolkit which provides several machine learning algorithms.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="compiling-without-avx-support" class="title" >Compiling without AVX support   </h3>  </div> </div></div><p>Especially older CPUs don’t support <a class="link" href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions"  target="_top">AVX</a> (Advanced Vector Extensions) instructions that are used by DLib to optimize their algorithms.</p><p>On the affected hardware errors like <code class="literal">Illegal instruction</code> will occur. In those cases AVX support needs to be disabled:</p><pre><code class="programlisting nix">self: super: { dlib = super.dlib.override { avxSupport = false; }; }
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-eclipse" class="title" style="clear: both">Eclipse   </h2>  </div> </div></div><p>The Nix expressions related to the Eclipse platform and IDE are in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/eclipse"  target="_top"><code class="literal">pkgs/applications/editors/eclipse</code></a>.</p><p>Nixpkgs provides a number of packages that will install Eclipse in its various forms. These range from the bare-bones Eclipse Platform to the more fully featured Eclipse SDK or Scala-IDE packages and multiple version are often available. It is possible to list available Eclipse packages by issuing the command:</p><pre><code class="programlisting ShellSession">$ nix-env -f &#x27;&lt;nixpkgs&gt;&#x27; -qaP -A eclipses --description
</code></pre><p>Once an Eclipse variant is installed, it can be run using the <code class="literal">eclipse</code> command, as expected. From within Eclipse, it is then possible to install plugins in the usual manner by either manually specifying an Eclipse update site or by installing the Marketplace Client plugin and using it to discover and install other plugins. This installation method provides an Eclipse installation that closely resemble a manually installed Eclipse.</p><p>If you prefer to install plugins in a more declarative manner, then Nixpkgs also offer a number of Eclipse plugins that can be installed in an <span class="emphasis"><em>Eclipse environment</em></span>. This type of environment is created using the function <code class="literal">eclipseWithPlugins</code> found inside the <code class="literal">nixpkgs.eclipses</code> attribute set. This function takes as argument <code class="literal">{ eclipse, plugins ? [], jvmArgs ? [] }</code> where <code class="literal">eclipse</code> is a one of the Eclipse packages described above, <code class="literal">plugins</code> is a list of plugin derivations, and <code class="literal">jvmArgs</code> is a list of arguments given to the JVM running the Eclipse. For example, say you wish to install the latest Eclipse Platform with the popular Eclipse Color Theme plugin and also allow Eclipse to use more RAM. You could then add:</p><pre><code class="programlisting nix">{
  packageOverrides = pkgs: {
    myEclipse =
      with pkgs.eclipses;
      eclipseWithPlugins {
        eclipse = eclipse-platform;
        jvmArgs = [ &quot;-Xmx2048m&quot; ];
        plugins = [ plugins.color-theme ];
      };
  };
}
</code></pre><p>to your Nixpkgs configuration (<code class="literal">~/.config/nixpkgs/config.nix</code>) and install it by running <code class="literal">nix-env -f &#x27;&lt;nixpkgs&gt;&#x27; -iA myEclipse</code> and afterward run Eclipse as usual. It is possible to find out which plugins are available for installation using <code class="literal">eclipseWithPlugins</code> by running:</p><pre><code class="programlisting ShellSession">$ nix-env -f &#x27;&lt;nixpkgs&gt;&#x27; -qaP -A eclipses.plugins --description
</code></pre><p>If there is a need to install plugins that are not available in Nixpkgs then it may be possible to define these plugins outside Nixpkgs using the <code class="literal">buildEclipseUpdateSite</code> and <code class="literal">buildEclipsePlugin</code> functions found in the <code class="literal">nixpkgs.eclipses.plugins</code> attribute set. Use the <code class="literal">buildEclipseUpdateSite</code> function to install a plugin distributed as an Eclipse update site. This function takes <code class="literal">{ name, src }</code> as argument, where <code class="literal">src</code> indicates the Eclipse update site archive. All Eclipse features and plugins within the downloaded update site will be installed. When an update site archive is not available, then the <code class="literal">buildEclipsePlugin</code> function can be used to install a plugin that consists of a pair of feature and plugin JARs. This function takes an argument <code class="literal">{ name, srcFeature, srcPlugin }</code> where <code class="literal">srcFeature</code> and <code class="literal">srcPlugin</code> are the feature and plugin JARs, respectively.</p><p>Expanding the previous example with two plugins using the above functions, we have:</p><pre><code class="programlisting nix">{
  packageOverrides = pkgs: {
    myEclipse =
      with pkgs.eclipses;
      eclipseWithPlugins {
        eclipse = eclipse-platform;
        jvmArgs = [ &quot;-Xmx2048m&quot; ];
        plugins = [
          plugins.color-theme
          (plugins.buildEclipsePlugin {
            name = &quot;myplugin1-1.0&quot;;
            srcFeature = fetchurl {
              url = &quot;http://…/features/myplugin1.jar&quot;;
              hash = &quot;sha256-123…&quot;;
            };
            srcPlugin = fetchurl {
              url = &quot;http://…/plugins/myplugin1.jar&quot;;
              hash = &quot;sha256-123…&quot;;
            };
          })
          (plugins.buildEclipseUpdateSite {
            name = &quot;myplugin2-1.0&quot;;
            src = fetchurl {
              stripRoot = false;
              url = &quot;http://…/myplugin2.zip&quot;;
              hash = &quot;sha256-123…&quot;;
            };
          })
        ];
      };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-elm" class="title" style="clear: both">Elm   </h2>  </div> </div></div><p>To start a development environment, run:</p><pre><code class="programlisting ShellSession">nix-shell -p elmPackages.elm elmPackages.elm-format
</code></pre><p>To update the Elm compiler, see <code class="literal">nixpkgs/pkgs/development/compilers/elm/README.md</code>.</p><p>To package Elm applications, <a class="link" href="https://github.com/hercules-ci/elm2nix#elm2nix"  target="_top">read about elm2nix</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-emacs" class="title" style="clear: both">Emacs   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-emacs-config">Configuring Emacs</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-emacs-config" class="title" >Configuring Emacs   </h3>  </div> </div></div><p>The Emacs package comes with some extra helpers to make it easier to configure. <code class="literal">emacs.pkgs.withPackages</code> allows you to manage packages from ELPA. This means that you will not have to install that packages from within Emacs. For instance, if you wanted to use <code class="literal">company</code> <code class="literal">counsel</code>, <code class="literal">flycheck</code>, <code class="literal">ivy</code>, <code class="literal">magit</code>, <code class="literal">projectile</code>, and <code class="literal">use-package</code> you could use this as a <code class="literal">~/.config/nixpkgs/config.nix</code> override:</p><pre><code class="programlisting nix">{
  packageOverrides =
    pkgs: with pkgs; {
      myEmacs = emacs.pkgs.withPackages (
        epkgs:
        (with epkgs.melpaStablePackages; [
          company
          counsel
          flycheck
          ivy
          magit
          projectile
          use-package
        ])
      );
    };
}
</code></pre><p>You can install it like any other packages via <code class="literal">nix-env -iA myEmacs</code>. However, this will only install those packages. It will not <code class="literal">configure</code> them for us. To do this, we need to provide a configuration file. Luckily, it is possible to do this from within Nix! By modifying the above example, we can make Emacs load a custom config file. The key is to create a package that provides a <code class="literal">default.el</code> file in <code class="literal">/share/emacs/site-start/</code>. Emacs knows to load this file automatically when it starts.</p><pre><code class="programlisting nix">{
  packageOverrides = pkgs: {
    myEmacsConfig = pkgs.writeText &quot;default.el&quot; &#x27;&#x27;
      (eval-when-compile
        (require &#x27;use-package))

      ;; load some packages

      (use-package company
        :bind (&quot;&lt;C-tab&gt;&quot; . company-complete)
        :diminish company-mode
        :commands (company-mode global-company-mode)
        :defer 1
        :config
        (global-company-mode))

      (use-package counsel
        :commands (counsel-descbinds)
        :bind (([remap execute-extended-command] . counsel-M-x)
               (&quot;C-x C-f&quot; . counsel-find-file)
               (&quot;C-c g&quot; . counsel-git)
               (&quot;C-c j&quot; . counsel-git-grep)
               (&quot;C-c k&quot; . counsel-ag)
               (&quot;C-x l&quot; . counsel-locate)
               (&quot;M-y&quot; . counsel-yank-pop)))

      (use-package flycheck
        :defer 2
        :config (global-flycheck-mode))

      (use-package ivy
        :defer 1
        :bind ((&quot;C-c C-r&quot; . ivy-resume)
               (&quot;C-x C-b&quot; . ivy-switch-buffer)
               :map ivy-minibuffer-map
               (&quot;C-j&quot; . ivy-call))
        :diminish ivy-mode
        :commands ivy-mode
        :config
        (ivy-mode 1))

      (use-package magit
        :defer
        :if (executable-find &quot;git&quot;)
        :bind ((&quot;C-x g&quot; . magit-status)
               (&quot;C-x G&quot; . magit-dispatch-popup))
        :init
        (setq magit-completing-read-function &#x27;ivy-completing-read))

      (use-package projectile
        :commands projectile-mode
        :bind-keymap (&quot;C-c p&quot; . projectile-command-map)
        :defer 5
        :config
        (projectile-global-mode))
    &#x27;&#x27;;

    myEmacs = emacs.pkgs.withPackages (
      epkgs:
      (with epkgs.melpaStablePackages; [
        (runCommand &quot;default.el&quot; { } &#x27;&#x27;
          mkdir -p $out/share/emacs/site-lisp
          cp ${myEmacsConfig} $out/share/emacs/site-lisp/default.el
        &#x27;&#x27;)
        company
        counsel
        flycheck
        ivy
        magit
        projectile
        use-package
      ])
    );
  };
}
</code></pre><p>This provides a fairly full Emacs start file. It will load in addition to the user’s personal config. You can always disable it by passing <code class="literal">-q</code> to the Emacs command.</p><p>Sometimes <code class="literal">emacs.pkgs.withPackages</code> is not enough, as this package set has some priorities imposed on packages (with the lowest priority assigned to GNU-devel ELPA, and the highest for packages manually defined in <code class="literal">pkgs/applications/editors/emacs/elisp-packages/manual-packages</code>). But you can’t control these priorities when some package is installed as a dependency. You can override it on a per-package-basis, providing all the required dependencies manually, but it’s tedious and there is always a possibility that an unwanted dependency will sneak in through some other package. To completely override such a package, you can use <code class="literal">overrideScope</code>.</p><pre><code class="programlisting nix">let
  overrides = self: super: rec {
    haskell-mode = self.melpaPackages.haskell-mode;
    # ...
  };
in
((emacsPackagesFor emacs).overrideScope overrides).withPackages (
  p: with p; [
    # here both these package will use haskell-mode of our own choice
    ghc-mod
    dante
  ]
)
</code></pre><p>}</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-firefox" class="title" style="clear: both">Firefox   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#build-wrapped-firefox-with-extensions-and-policies">Build wrapped Firefox with extensions and policies</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-firefox-troubleshooting">Troubleshooting</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="build-wrapped-firefox-with-extensions-and-policies" class="title" >Build wrapped Firefox with extensions and policies   </h3>  </div> </div></div><p>The <code class="literal">wrapFirefox</code> function allows to pass policies, preferences and extensions that are available to Firefox. With the help of <code class="literal">fetchFirefoxAddon</code> this allows to build a Firefox version that already comes with add-ons pre-installed:</p><pre><code class="programlisting nix">{
  # Nix firefox addons only work with the firefox-esr package.
  myFirefox = wrapFirefox firefox-esr-unwrapped {
    nixExtensions = [
      (fetchFirefoxAddon {
        name = &quot;ublock&quot;; # Has to be unique!
        url = &quot;https://addons.mozilla.org/firefox/downloads/file/3679754/ublock_origin-1.31.0-an+fx.xpi&quot;;
        hash = &quot;sha256-2e73AbmYZlZXCP5ptYVcFjQYdjDp4iPoEPEOSCVF5sA=&quot;;
      })
    ];

    extraPolicies = {
      CaptivePortal = false;
      DisableFirefoxStudies = true;
      DisablePocket = true;
      DisableTelemetry = true;
      DisableFirefoxAccounts = true;
      FirefoxHome = {
        Pocket = false;
        Snippets = false;
      };
      UserMessaging = {
        ExtensionRecommendations = false;
        SkipOnboarding = true;
      };
      SecurityDevices = {
        # Use a proxy module rather than `nixpkgs.config.firefox.smartcardSupport = true`
        &quot;PKCS#11 Proxy Module&quot; = &quot;${pkgs.p11-kit}/lib/p11-kit-proxy.so&quot;;
      };
    };

    extraPrefs = &#x27;&#x27;
      // Show more ssl cert infos
      lockPref(&quot;security.identityblock.show_extended_validation&quot;, true);
    &#x27;&#x27;;
  };
}
</code></pre><p>If <code class="literal">nixExtensions != null</code>, then all manually installed add-ons will be uninstalled from your browser profile.
To view available enterprise policies, visit <a class="link" href="https://github.com/mozilla/policy-templates#enterprisepoliciesenabled"  target="_top">enterprise policies</a>
or type into the Firefox URL bar: <code class="literal">about:policies#documentation</code>.
Nix installed add-ons do not have a valid signature, which is why signature verification is disabled. This does not compromise security because downloaded add-ons are checksummed and manual add-ons can’t be installed. Also, make sure that the <code class="literal">name</code> field of <code class="literal">fetchFirefoxAddon</code> is unique. If you remove an add-on from the <code class="literal">nixExtensions</code> array, rebuild and start Firefox: the removed add-on will be completely removed with all of its settings.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-firefox-troubleshooting" class="title" >Troubleshooting   </h3>  </div> </div></div><p>If add-ons are marked as broken or the signature is invalid, make sure you have Firefox ESR installed. Normal Firefox does not provide the ability anymore to disable signature verification for add-ons thus nix add-ons get disabled by the normal Firefox binary.</p><p>If add-ons do not appear installed despite being defined in your nix configuration file, reset the local add-on state of your Firefox profile by clicking <code class="literal">Help -&gt; More Troubleshooting Information -&gt; Refresh Firefox</code>. This can happen if you switch from manual add-on mode to nix add-on mode and then back to manual mode and then again to nix add-on mode.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-fish" class="title" style="clear: both">Fish   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-fish-vendor">Vendor Fish scripts</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-fish-plugins-pkg">Packaging Fish plugins</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-fish-wrapper">Fish wrapper</a> </span></dt> </dl></div><p>Fish is a “smart and user-friendly command line shell” with support for plugins.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-fish-vendor" class="title" >Vendor Fish scripts   </h3>  </div> </div></div><p>Any package may ship its own Fish completions, configuration snippets, and
functions. Those should be installed to
<code class="literal">$out/share/fish/vendor_{completions,conf,functions}.d</code> respectively.</p><p>When the <code class="literal">programs.fish.enable</code> and
<code class="literal">programs.fish.vendor.{completions,config,functions}.enable</code> options from the
NixOS Fish module are set to true, those paths are symlinked in the current
system environment and automatically loaded by Fish.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-fish-plugins-pkg" class="title" >Packaging Fish plugins   </h3>  </div> </div></div><p>While packages providing standalone executables belong to the top level,
packages which have the sole purpose of extending Fish belong to the
<code class="literal">fishPlugins</code> scope and should be registered in
<code class="literal">pkgs/shells/fish/plugins/default.nix</code>.</p><p>The <code class="literal">buildFishPlugin</code> utility function can be used to automatically copy Fish
scripts from <code class="literal">$src/{completions,conf,conf.d,functions}</code> to the standard vendor
installation paths. It also sets up the test environment so that the optional
<code class="literal">checkPhase</code> is executed in a Fish shell with other already packaged plugins
and package-local Fish functions specified in <code class="literal">checkPlugins</code> and
<code class="literal">checkFunctionDirs</code> respectively.</p><p>See <code class="literal">pkgs/shells/fish/plugins/pure.nix</code> for an example of Fish plugin package
using <code class="literal">buildFishPlugin</code> and running unit tests with the <code class="literal">fishtape</code> test runner.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-fish-wrapper" class="title" >Fish wrapper   </h3>  </div> </div></div><p>The <code class="literal">wrapFish</code> package is a wrapper around Fish which can be used to create
Fish shells initialized with some plugins as well as completions, configuration
snippets and functions sourced from the given paths. This provides a convenient
way to test Fish plugins and scripts without having to alter the environment.</p><pre><code class="programlisting nix">wrapFish {
  pluginPkgs = with fishPlugins; [
    pure
    foreign-env
  ];
  completionDirs = [ ];
  functionDirs = [ ];
  confDirs = [ &quot;/path/to/some/fish/init/dir/&quot; ];
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-fuse" class="title" style="clear: both">FUSE   </h2>  </div> </div></div><p>Some packages rely on
<a class="link" href="https://www.kernel.org/doc/html/latest/filesystems/fuse.html"  target="_top">FUSE</a> to provide
support for additional filesystems not supported by the kernel.</p><p>In general, FUSE software are primarily developed for Linux but many of them can
also run on macOS. Nixpkgs supports FUSE packages on macOS, but it requires
<a class="link" href="https://osxfuse.github.io"  target="_top">macFUSE</a> to be installed outside of Nix. macFUSE
currently isn’t packaged in Nixpkgs mainly because it includes a kernel
extension, which isn’t supported by Nix outside of NixOS.</p><p>If a package fails to run on macOS with an error message similar to the
following, it’s a likely sign that you need to have macFUSE installed.</p><pre><code class="programlisting">dyld: Library not loaded: /usr/local/lib/libfuse.2.dylib
Referenced from: /nix/store/w8bi72bssv0bnxhwfw3xr1mvn7myf37x-sshfs-fuse-2.10/bin/sshfs
Reason: image not found
[1]    92299 abort      /nix/store/w8bi72bssv0bnxhwfw3xr1mvn7myf37x-sshfs-fuse-2.10/bin/sshfs
</code></pre><p>Package maintainers may often encounter the following error when building FUSE
packages on macOS:</p><pre><code class="programlisting">checking for fuse.h... no
configure: error: No fuse.h found.
</code></pre><p>This happens on autoconf based projects that use <code class="literal">AC_CHECK_HEADERS</code> or
<code class="literal">AC_CHECK_LIBS</code> to detect libfuse, and will occur even when the <code class="literal">fuse</code> package
is included in <code class="literal">buildInputs</code>. It happens because libfuse headers throw an error
on macOS if the <code class="literal">FUSE_USE_VERSION</code> macro is undefined. Many projects do define
<code class="literal">FUSE_USE_VERSION</code>, but only inside C source files. This results in the above
error at configure time because the configure script would attempt to compile
sample FUSE programs without defining <code class="literal">FUSE_USE_VERSION</code>.</p><p>There are two possible solutions for this problem in Nixpkgs:</p><div class="orderedlist"><ol class="orderedlist compact"  type="1"><li class="listitem"><p>Pass <code class="literal">FUSE_USE_VERSION</code> to the configure script by adding
<code class="literal">CFLAGS=-DFUSE_USE_VERSION=25</code> in <code class="literal">configureFlags</code>. The actual value would
have to match the definition used in the upstream source code.</p></li><li class="listitem"><p>Remove <code class="literal">AC_CHECK_HEADERS</code> / <code class="literal">AC_CHECK_LIBS</code> for libfuse.</p></li></ol></div><p>However, a better solution might be to fix the build script upstream to use
<code class="literal">PKG_CHECK_MODULES</code> instead. This approach wouldn’t suffer from the problem that
<code class="literal">AC_CHECK_HEADERS</code>/<code class="literal">AC_CHECK_LIBS</code> has at the price of introducing a dependency
on pkg-config.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="geant4" class="title" style="clear: both">Geant4   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#geant4-hook">Setup hook</a> </span></dt><dt> <span class="section">  <a href="index.html#geant4-datasets">Datasets</a> </span></dt> </dl></div><p><a class="link" href="https://www.geant4.org/"  target="_top">Geant4</a> is a toolkit for simulating how particles pass through matter. It is available through the <code class="literal">geant4</code> package.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="geant4-hook" class="title" >Setup hook   </h3>  </div> </div></div><p>The setup hook included in the package applies the environment variables set by the <a class="link" href="https://github.com/Geant4/geant4/blob/master/cmake/Modules/G4ConfigureGNUMakeHelpers.cmake#L4-L55"  target="_top"><code class="literal">geant4.sh</code> script</a>, which is typically necessary for compiling <code class="literal">make</code>-based programs that depend on Geant4.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="geant4-datasets" class="title" >Datasets   </h3>  </div> </div></div><p>All of <a class="link" href="https://geant4.web.cern.ch/support/download"  target="_top">the Geant4 datasets provided by CERN</a> are available through the <code class="literal">geant4.data</code> attrset.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="geant4-datasets-hook" class="title" >Setup hook   </h4>  </div> </div></div><p>The hook provided by the packages in <code class="literal">geant4.data</code> will set an appropriate environment variable in the form of <code class="literal">G4[...]DATA</code>. For example, for the <code class="literal">G4RadioactiveDecay</code> dataset, the <code class="literal">G4RADIOACTIVEDATA</code> environment variable is set to the value expected by Geant4.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-ibus-typing-booster" class="title" style="clear: both">ibus-engines.typing-booster   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-ibus-typing-booster-activate">Activating the engine</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-ibus-typing-booster-customize-hunspell">Using custom hunspell dictionaries</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-ibus-typing-booster-emoji-picker">Built-in emoji picker</a> </span></dt> </dl></div><p>This package is an ibus-based completion method to speed up typing.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-ibus-typing-booster-activate" class="title" >Activating the engine   </h3>  </div> </div></div><p>IBus needs to be configured accordingly to activate <code class="literal">typing-booster</code>. The configuration depends on the desktop manager in use. For detailed instructions, please refer to the <a class="link" href="https://mike-fabian.github.io/ibus-typing-booster/"  target="_top">upstream docs</a>.</p><p>On NixOS, you need to explicitly enable <code class="literal">ibus</code> with given engines before customizing your desktop to use <code class="literal">typing-booster</code>. This can be achieved using the <code class="literal">ibus</code> module:</p><pre><code class="programlisting nix">{ pkgs, ... }:
{
  i18n.inputMethod = {
    enable = true;
    type = &quot;ibus&quot;;
    ibus.engines = with pkgs.ibus-engines; [ typing-booster ];
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-ibus-typing-booster-customize-hunspell" class="title" >Using custom hunspell dictionaries   </h3>  </div> </div></div><p>The IBus engine is based on <code class="literal">hunspell</code> to support completion in many languages. By default, the dictionaries <code class="literal">de-de</code>, <code class="literal">en-us</code>, <code class="literal">fr-moderne</code> <code class="literal">es-es</code>, <code class="literal">it-it</code>, <code class="literal">sv-se</code> and <code class="literal">sv-fi</code> are in use. To add another dictionary, the package can be overridden like this:</p><pre><code class="programlisting nix">ibus-engines.typing-booster.override {
  langs = [
    &quot;de-at&quot;
    &quot;en-gb&quot;
  ];
}
</code></pre><p><span class="emphasis"><em>Note: each language passed to <code class="literal">langs</code> must be an attribute name in <code class="literal">pkgs.hunspellDicts</code>.</em></span></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-ibus-typing-booster-emoji-picker" class="title" >Built-in emoji picker   </h3>  </div> </div></div><p>The <code class="literal">ibus-engines.typing-booster</code> package contains a program named <code class="literal">emoji-picker</code>. To display all emojis correctly, a special font such as <code class="literal">noto-fonts-color-emoji</code> is needed:</p><p>On NixOS, it can be installed using the following expression:</p><pre><code class="programlisting nix">{ pkgs, ... }:
{
  fonts.packages = with pkgs; [ noto-fonts-color-emoji ];
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-inkscape" class="title" style="clear: both">Inkscape   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#inkscape-plugins">Plugins</a> </span></dt> </dl></div><p><a class="link" href="https://inkscape.org"  target="_top">Inkscape</a> is a powerful vector graphics editor.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="inkscape-plugins" class="title" >Plugins   </h3>  </div> </div></div><p>Inkscape plugins are collected in the <a class="link" href="https://search.nixos.org/packages?channel=unstable&amp;type=packages&amp;query=cudaPackages"  target="_top"><code class="literal">inkscape-extensions</code></a> package set.
To enable them, use an override on <code class="literal">inkscape-with-extensions</code>:</p><pre><code class="programlisting nix">inkscape-with-extensions.override {
  inkscapeExtensions = with inkscape-extensions; [ inkstitch ];
}
</code></pre><p>Similarly, this works in the shell:</p><pre><code class="programlisting bash">$ nix-shell -p &#x27;inkscape-with-extensions.override { inkscapeExtensions = with inkscape-extensions; [inkstitch]; }&#x27;
[nix-shell:~]$ # Ink/Stitch is now available via the extension menu
[nix-shell:~]$ inkscape
</code></pre><p>All available extension can be enabled by passing <code class="literal">inkscapeExtensions = null;</code>.</p><div class="note"><h3 class="title">Note</h3><p>Loading the Inkscape extensions stand-alone (without using <code class="literal">override</code>) does not affect Inkscape at all.</p></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-kakoune" class="title" style="clear: both">Kakoune   </h2>  </div> </div></div><p>Kakoune can be built to autoload plugins:</p><pre><code class="programlisting nix">(kakoune.override { plugins = with pkgs.kakounePlugins; [ parinfer-rust ]; })
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-krita" class="title" style="clear: both">Krita   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#krita-python-plugins">Python plugins</a> </span></dt><dt> <span class="section">  <a href="index.html#krita-binary-plugins">Binary plugins</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="krita-python-plugins" class="title" >Python plugins   </h3>  </div> </div></div><p>“pykrita” plugins should be installed following
<a class="link" href="https://docs.krita.org/en/user_manual/python_scripting/install_custom_python_plugin.html"  target="_top">Krita’s manual</a>.
This generally involves extracting the extension to <code class="literal">~/.local/share/krita/pykrita/</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="krita-binary-plugins" class="title" >Binary plugins   </h3>  </div> </div></div><p>Binary plugins are Dynamically Linked Libraries to be loaded by Krita.</p><p><span class="emphasis"><em>Note: You most likely won’t need to deal with binary plugins,
all known plugins are bundled and enabled by default.</em></span></p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="krita-install-binary-plugins" class="title" >Installing binary plugins   </h4>  </div> </div></div><p>You can choose what plugins are added to Krita by overriding the
<code class="literal">binaryPlugins</code> attribute.</p><p>If you want to add plugins instead of replacing, you can read the
list of previous plugins via <code class="literal">pkgs.krita.binaryPlugins</code>:</p><pre><code class="programlisting nix">(pkgs.krita.override (old: {
  binaryPlugins = old.binaryPlugins ++ [ your-plugin ];
}))
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="krita-binary-plugin-structure" class="title" >Example structure of a binary plugin   </h4>  </div> </div></div><pre><code class="programlisting">/nix/store/00000000000000000000000000000000-krita-plugin-example-1.2.3
└── lib
   └── kritaplugins
      └── krita_example.so
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-linux-kernel" class="title" style="clear: both">Linux kernel   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-manual-kernel-configuration">Manual kernel configuration</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-linux-kernel-developing-modules">Developing kernel modules</a> </span></dt> </dl></div><p>The Nix expressions to build the Linux kernel are in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/os-specific/linux/kernel"  target="_top"><code class="literal">pkgs/os-specific/linux/kernel</code></a>.</p><p>The function <a class="link" href="https://github.com/NixOS/nixpkgs/blob/d77bda728d5041c1294a68fb25c79e2d161f62b9/pkgs/os-specific/linux/kernel/generic.nix"  target="_top"><code class="literal">pkgs.buildLinux</code></a> builds a kernel with <a class="link" href="https://github.com/NixOS/nixpkgs/blob/d77bda728d5041c1294a68fb25c79e2d161f62b9/pkgs/os-specific/linux/kernel/common-config.nix"  target="_top">common configuration values</a>.
This is the preferred option unless you have a very specific use case.
Most kernels packaged in Nixpkgs are built that way, and it will also generate kernels suitable for NixOS.
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/d77bda728d5041c1294a68fb25c79e2d161f62b9/pkgs/os-specific/linux/kernel/manual-config.nix"  target="_top"><code class="literal">pkgs.linuxManualConfig</code></a> requires a complete configuration to be passed.
It has fewer additional features than <code class="literal">pkgs.buildLinux</code>, which provides common configuration values and exposes the <code class="literal">features</code> attribute, as explained below.</p><p>Both functions have an argument <code class="literal">kernelPatches</code> which should be a list of <code class="literal">{name, patch, extraConfig}</code> attribute sets, where <code class="literal">name</code> is the name of the patch (which is included in the kernel’s <code class="literal">meta.description</code> attribute), <code class="literal">patch</code> is the patch itself (possibly compressed), and <code class="literal">extraConfig</code> (optional) is a string specifying extra options to be concatenated to the kernel configuration file (<code class="literal">.config</code>).</p><p>The kernel derivation created with <code class="literal">pkgs.buildLinux</code> exports an attribute <code class="literal">features</code> specifying whether optional functionality is or isn’t enabled. This is used in NixOS to implement kernel-specific behaviour.</p><p>If you are using a kernel packaged in Nixpkgs, you can customize it by overriding its arguments. For details on how each argument affects the generated kernel, refer to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/d77bda728d5041c1294a68fb25c79e2d161f62b9/pkgs/os-specific/linux/kernel/generic.nix"  target="_top">the <code class="literal">pkgs.buildLinux</code> source code</a>.</p><div class="example"><span id="ex-overriding-kernel-derivation" ></span><details><summary><span class="title"><strong>Example 360. Overriding the kernel derivation</strong></span></summary><div class="example-contents"><p>Assuming you are using the kernel from <code class="literal">pkgs.linux_latest</code>:</p><pre><code class="programlisting nix">pkgs.linux_latest.override {
  ignoreConfigErrors = true;
  autoModules = false;
  kernelPreferBuiltin = true;
  extraStructuredConfig = with lib.kernel; {
    DEBUG_KERNEL = yes;
    FRAME_POINTER = yes;
    KGDB = yes;
    KGDB_SERIAL_CONSOLE = yes;
    DEBUG_INFO = yes;
  };
}
</code></pre></div></details></div><br class="example-break" /><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-manual-kernel-configuration" class="title" >Manual kernel configuration   </h3>  </div> </div></div><p>Sometimes it may not be desirable to use kernels built with <code class="literal">pkgs.buildLinux</code>, especially if most of the common configuration has to be altered or disabled to achieve a kernel as expected by the target use case.
An example of this is building a kernel for use in a VM or micro VM. You can use <code class="literal">pkgs.linuxPackages_custom</code> in these cases. It requires the <code class="literal">src</code>, <code class="literal">version</code>, and <code class="literal">configfile</code> attributes to be specified.</p><div class="example"><span id="ex-using-linux-manual-config" ></span><details><summary><span class="title"><strong>Example 361. Using <code class="literal">pkgs.linuxPackages_custom</code> with a specific source, version, and config file</strong></span></summary><div class="example-contents"><pre><code class="programlisting nix">{ pkgs, ... }:
pkgs.linuxPackages_custom {
  version = &quot;6.1.55&quot;;
  src = pkgs.fetchurl {
    url = &quot;https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${version}.tar.xz&quot;;
    hash = &quot;sha256-qH4kHsFdU0UsTv4hlxOjdp2IzENrW5jPbvsmLEr/FcA=&quot;;
  };
  configfile = ./path_to_config_file;
}
</code></pre><p>If necessary, the version string can be slightly modified to explicitly mark it as a custom version. If you do so, ensure the <code class="literal">modDirVersion</code> attribute matches the source’s version, otherwise the build will fail.</p><pre><code class="programlisting nix">{ pkgs, ... }:
pkgs.linuxPackages_custom {
  version = &quot;6.1.55-custom&quot;;
  modDirVersion = &quot;6.1.55&quot;;
  src = pkgs.fetchurl {
    url = &quot;https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${modDirVersion}.tar.xz&quot;;
    hash = &quot;sha256-qH4kHsFdU0UsTv4hlxOjdp2IzENrW5jPbvsmLEr/FcA=&quot;;
  };
  configfile = ./path_to_config_file;
}
</code></pre></div></details></div><br class="example-break" /><p>Additional attributes can be used with <code class="literal">linuxManualConfig</code> for further customisation instead of <code class="literal">linuxPackages_custom</code>. You’re encouraged to read <a class="link" href="https://github.com/NixOS/nixpkgs/blob/d77bda728d5041c1294a68fb25c79e2d161f62b9/pkgs/os-specific/linux/kernel/manual-config.nix"  target="_top">the <code class="literal">pkgs.linuxManualConfig</code> source code</a> to understand how to use them.</p><p>To edit the <code class="literal">.config</code> file for Linux X.Y from within Nix, proceed as follows:</p><pre><code class="programlisting ShellSession">$ nix-shell &#x27;&lt;nixpkgs&gt;&#x27; -A linuxKernel.kernels.linux_X_Y.configEnv
$ unpackPhase
$ cd linux-*
$ make nconfig
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-linux-kernel-developing-modules" class="title" >Developing kernel modules   </h3>  </div> </div></div><p>When developing kernel modules it’s often convenient to run the edit-compile-run loop as quickly as possible.
See the snippet below as an example.</p><div class="example"><span id="ex-edit-compile-run-kernel-modules" ></span><details><summary><span class="title"><strong>Example 362. Edit-compile-run loop when developing <code class="literal">mellanox</code> drivers</strong></span></summary><div class="example-contents"><pre><code class="programlisting ShellSession">$ nix-build &#x27;&lt;nixpkgs&gt;&#x27; -A linuxPackages.kernel.dev
$ nix-shell &#x27;&lt;nixpkgs&gt;&#x27; -A linuxPackages.kernel
$ unpackPhase
$ cd linux-*
$ make -C $dev/lib/modules/*/build M=$(pwd)/drivers/net/ethernet/mellanox modules
# insmod ./drivers/net/ethernet/mellanox/mlx5/core/mlx5_core.ko
</code></pre></div></details></div><br class="example-break" />
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="lhapdf" class="title" style="clear: both">LHAPDF   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#lhapdf-sets">PDF sets</a> </span></dt> </dl></div><p><a class="link" href="https://lhapdf.hepforge.org/"  target="_top">LHAPDF</a> is a tool for evaluating parton distribution functions (PDFs) in high-energy physics. LHAPDF is available in the <code class="literal">lhapdf</code> package.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="lhapdf-sets" class="title" >PDF sets   </h3>  </div> </div></div><p>All of <a class="link" href="https://lhapdf.hepforge.org/pdfsets.html"  target="_top">the PDF sets made available by the LHAPDF project</a> are available through the <code class="literal">lhapdf.pdf_sets</code> attrset.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="lhapdf-sets-hook" class="title" >Setup hook   </h4>  </div> </div></div><p>Each package provided in the <code class="literal">lhapdf.pdf_sets</code> attrset contains a setup hook which adds itself to <a class="link" href="https://lhapdf.hepforge.org/#sets"  target="_top">the <code class="literal">LHAPDF_DATA_PATH</code> environment variable</a>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="locales" class="title" style="clear: both">Locales   </h2>  </div> </div></div><p>To allow simultaneous use of packages linked against different versions of <code class="literal">glibc</code> with different locale archive formats, Nixpkgs patches <code class="literal">glibc</code> to rely on <code class="literal">LOCALE_ARCHIVE</code> environment variable.</p><p>On non-NixOS distributions, this variable is obviously not set. This can cause regressions in language support or even crashes in some Nixpkgs-provided programs. The simplest way to mitigate this problem is exporting the <code class="literal">LOCALE_ARCHIVE</code> variable pointing to <code class="literal">${glibcLocales}/lib/locale/locale-archive</code>. The drawback (and the reason this is not the default) is the relatively large (a hundred MiB) size of the full set of locales. It is possible to build a custom set of locales by overriding parameters <code class="literal">allLocales</code> and <code class="literal">locales</code> of the package.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="etc" class="title" style="clear: both">/etc files   </h2>  </div> </div></div><p>Certain calls in glibc require access to runtime files found in <code class="literal">/etc</code> such as <code class="literal">/etc/protocols</code> or <code class="literal">/etc/services</code> – <a class="link" href="https://linux.die.net/man/3/getprotobyname"  target="_top">getprotobyname</a> is one such function.</p><p>On non-NixOS distributions these files are typically provided by packages (i.e., <a class="link" href="https://packages.debian.org/sid/netbase"  target="_top">netbase</a>) if not already pre-installed in your distribution. This can cause non-reproducibility for code if they rely on these files being present.</p><p>If <a class="link" href="https://hydra.nixos.org/job/nixos/trunk-combined/nixpkgs.iana-etc.x86_64-linux"  target="_top">iana-etc</a> is part of your <code class="literal">buildInputs</code>, then it will set the environment variables <code class="literal">NIX_ETC_PROTOCOLS</code> and <code class="literal">NIX_ETC_SERVICES</code> to the corresponding files in the package through a setup hook.</p><pre><code class="programlisting bash">&gt; nix-shell -p iana-etc

[nix-shell:~]$ env | grep NIX_ETC
NIX_ETC_SERVICES=/nix/store/aj866hr8fad8flnggwdhrldm0g799ccz-iana-etc-20210225/etc/services
NIX_ETC_PROTOCOLS=/nix/store/aj866hr8fad8flnggwdhrldm0g799ccz-iana-etc-20210225/etc/protocols
</code></pre><p>Nixpkg’s version of <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/libraries/glibc/default.nix"  target="_top">glibc</a> has been patched to check for the existence of these environment variables. If the environment variables are <span class="emphasis"><em>not</em></span> set, then it will attempt to find the files at the default location within <code class="literal">/etc</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-nginx" class="title" style="clear: both">Nginx   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-nginx-etag">ETags on static files served from the Nix store</a> </span></dt> </dl></div><p><a class="link" href="https://nginx.org"  target="_top">Nginx</a> is a reverse proxy and lightweight webserver.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nginx-etag" class="title" >ETags on static files served from the Nix store   </h3>  </div> </div></div><p>HTTP has a couple of different mechanisms for caching to prevent clients from having to download the same content repeatedly if a resource has not changed since the last time it was requested. When nginx is used as a server for static files, it implements the caching mechanism based on the <a class="link" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Last-Modified"  target="_top"><code class="literal">Last-Modified</code></a> response header automatically; unfortunately, it works by using filesystem timestamps to determine the value of the <code class="literal">Last-Modified</code> header. This doesn’t give the desired behavior when the file is in the Nix store because all file timestamps are set to 0 (for reasons related to build reproducibility).</p><p>Fortunately, HTTP supports an alternative (and more effective) caching mechanism: the <a class="link" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag"  target="_top"><code class="literal">ETag</code></a> response header. The value of the <code class="literal">ETag</code> header specifies some identifier for the particular content that the server is sending (e.g., a hash). When a client makes a second request for the same resource, it sends that value back in an <code class="literal">If-None-Match</code> header. If the ETag value is unchanged, then the server does not need to resend the content.</p><p>The nginx package in Nixpkgs is patched such that when nginx serves a file out of <code class="literal">/nix/store</code>, the hash in the store path is used as the <code class="literal">ETag</code> header in the HTTP response, thus providing proper caching functionality. With NixOS 24.05 and later, the <code class="literal">ETag</code> additionally includes the response content length, to ensure files served with static compression do not share <code class="literal">ETag</code>s with their uncompressed version. This <code class="literal">ETag</code> functionality is enabled automatically; you do not need to do modify any configuration to get this behavior.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-opengl" class="title" style="clear: both">OpenGL   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#nixos-desktop">NixOS Desktop</a> </span></dt><dt> <span class="section">  <a href="index.html#nix-on-gnulinux">Nix on GNU/Linux</a> </span></dt> </dl></div><p>OpenGL support varies depending on which hardware is used and which drivers are available and loaded.</p><p>Broadly, we support both GL vendors: Mesa and NVIDIA.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="nixos-desktop" class="title" >NixOS Desktop   </h3>  </div> </div></div><p>The NixOS desktop or other non-headless configurations are the primary target for OpenGL libraries and applications. The current solution for discovering which drivers are available is based on <a class="link" href="https://gitlab.freedesktop.org/glvnd/libglvnd"  target="_top">libglvnd</a>. <code class="literal">libglvnd</code> performs “vendor-neutral dispatch”, trying a variety of techniques to find the system’s GL implementation. In practice, this will be either via standard GLX for X11 users or EGL for Wayland users, and supporting either NVIDIA or Mesa extensions.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="nix-on-gnulinux" class="title" >Nix on GNU/Linux   </h3>  </div> </div></div><p>If you are using a non-NixOS GNU/Linux/X11 desktop with free software video drivers, consider launching OpenGL-dependent programs from Nixpkgs with Nixpkgs versions of <code class="literal">libglvnd</code> and <code class="literal">mesa</code> in <code class="literal">LD_LIBRARY_PATH</code>. For Mesa drivers, the Linux kernel version doesn’t have to match nixpkgs.</p><p>For proprietary video drivers, you might have luck with also adding the corresponding video driver package.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-shell-helpers" class="title" style="clear: both">Interactive shell helpers   </h2>  </div> </div></div><p>Some packages provide the shell integration to be more useful. But unlike other systems, nix doesn’t have a standard <code class="literal">share</code> directory location. This is why a bunch <code class="literal">PACKAGE-share</code> scripts are shipped that print the location of the corresponding shared folder. Current list of such packages is as following:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">fzf</code> : <code class="literal">fzf-share</code></p></li></ul></div><p>E.g. <code class="literal">fzf</code> can then be used in the <code class="literal">.bashrc</code> like this:</p><pre><code class="programlisting bash">source &quot;$(fzf-share)/completion.bash&quot;
source &quot;$(fzf-share)/key-bindings.bash&quot;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="python-tree-sitter" class="title" style="clear: both">Python Tree Sitter   </h2>  </div> </div></div><p><a class="link" href="https://tree-sitter.github.io/tree-sitter/"  target="_top">Tree Sitter</a> is a framework for building grammars for programming languages. It generates and uses syntax trees from source files, which are useful for code analysis, tooling, and syntax highlighting.</p><p>Python bindings for Tree Sitter grammars are provided through the <a class="link" href="https://github.com/tree-sitter/py-tree-sitter"  target="_top">py-tree-sitter</a> module. The Nix package <code class="literal">python3Packages.tree-sitter-grammars</code> provides pre-built grammars for various languages.</p><p>For example, to experiment with the Rust grammar, you can create a shell environment with the following configuration:</p><pre><code class="programlisting nix">{
  pkgs ? import &lt;nixpkgs&gt; { },
}:

pkgs.mkShell {
  name = &quot;py-tree-sitter-dev-shell&quot;;

  buildInputs = with pkgs; [
    (python3.withPackages (
      ps: with ps; [
        tree-sitter
        tree-sitter-grammars.tree-sitter-rust
      ]
    ))
  ];
}
</code></pre><p>Once inside the shell, the following Python code demonstrates how to parse a Rust code snippet:</p><pre><code class="programlisting python"># Import the Tree Sitter library and Rust grammar
import tree_sitter
import tree_sitter_rust

# Load the Rust grammar and initialize the parser
rust = tree_sitter.Language(tree_sitter_rust.language())
parser = tree_sitter.Parser(rust)

# Parse a Rust snippet
tree = parser.parse(
    bytes(
        &quot;&quot;&quot;
        fn main() {
          println!(&quot;Hello, world!&quot;);
        }
        &quot;&quot;&quot;,
        &quot;utf8&quot;
    )
)

# Display the resulting syntax tree
print(tree.root_node)
</code></pre><p>The <code class="literal">tree_sitter_rust.language()</code> function references the Rust grammar loaded in the Nix shell. The resulting tree allows you to inspect the structure of the code programmatically.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="treefmt" class="title" style="clear: both">treefmt   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-functions-library-treefmt">Functions Reference</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-treefmt-options-reference">Options Reference</a> </span></dt> </dl></div><p><a class="link" href="https://github.com/numtide/treefmt"  target="_top">treefmt</a> streamlines the process of applying formatters to your project, making it a breeze with just one command line.</p><p>The <a class="link" href="https://search.nixos.org/packages?channel=unstable&amp;show=treefmt"  target="_top"><code class="literal">treefmt</code> package</a>
provides functions for configuring treefmt using the module system, which are <a class="link" href="index.html#sec-functions-library-treefmt" title="Functions Reference" >documented below</a>, along with <a class="link" href="index.html#sec-treefmt-options-reference" title="Options Reference" >their options</a>.</p><p>Alternatively, treefmt can be configured using <a class="link" href="https://github.com/numtide/treefmt-nix"  target="_top">treefmt-nix</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-functions-library-treefmt" class="title" >Functions Reference   </h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="pkgs.treefmt.evalConfig" class="title" ><code class="literal">pkgs.treefmt.evalConfig</code>   </h4>  </div> </div></div><p>Evaluate a treefmt configuration.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-treefmt-functions-10-1.1.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">Module -&gt; Configuration
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-treefmt-functions-10-1.1.2" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">module</code></span></dt><dd><p>A treefmt module. See <a class="link" href="index.html#sec-treefmt-options-reference" title="Options Reference" >options reference</a>.</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/tr/treefmt/lib.nix#L21"  target="_top">pkgs/by-name/tr/treefmt/lib.nix:21</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="pkgs.treefmt.withConfig" class="title" ><code class="literal">pkgs.treefmt.withConfig</code>   </h4>  </div> </div></div><p>Wrap treefmt, configured using structured settings.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-treefmt-functions-10-1.2.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">Module -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-treefmt-functions-10-1.2.2" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">module</code></span></dt><dd><p>A treefmt module. See <a class="link" href="index.html#sec-treefmt-options-reference" title="Options Reference" >options reference</a>.</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/tr/treefmt/lib.nix#L54"  target="_top">pkgs/by-name/tr/treefmt/lib.nix:54</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="pkgs.treefmt.buildConfig" class="title" ><code class="literal">pkgs.treefmt.buildConfig</code>   </h4>  </div> </div></div><p>Build a treefmt config file from structured settings.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-treefmt-functions-10-1.3.1" class="title" >Type   </h5>  </div> </div></div><pre><code class="programlisting">Module -&gt; Derivation
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="auto-generated-treefmt-functions-10-1.3.2" class="title" >Inputs   </h5>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">settings</code></span></dt><dd><p>A settings module, used to build a treefmt config file.
See <a class="link" href="index.html#opt-treefmt-settings"  ><code class="literal">settings</code> option reference</a>.</p></dd></dl></div><p>Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/tr/treefmt/lib.nix#L79"  target="_top">pkgs/by-name/tr/treefmt/lib.nix:79</a> in <code class="literal">&lt;nixpkgs&gt;</code>.</p>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-treefmt-options-reference" class="title" >Options Reference   </h3>  </div> </div></div><p>The following attributes can be passed to <a class="link" href="index.html#pkgs.treefmt.withConfig" title="pkgs.treefmt.withConfig" ><code class="literal">withConfig</code></a> or <a class="link" href="index.html#pkgs.treefmt.evalConfig" title="pkgs.treefmt.evalConfig" ><code class="literal">evalConfig</code></a>:</p><div class="variablelist">
<a id="configuration-variable-list"></a>
 <dl class="variablelist">
<dt>
 <span class="term">
 <a id="opt-treefmt-configFile"></a><a class="term" href="index.html#opt-treefmt-configFile"><code class="option">configFile</code>
  </a>
 </span>
</dt>
<dd>
<p>The treefmt config file.</p>

<p><span class="emphasis"><em>Type:</em></span>
absolute path</p>

<p><span class="emphasis"><em>Default:</em></span>
generated from <a class="xref" href="index.html#opt-treefmt-settings"  ><code class="option">settings</code></a></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/tr/treefmt/modules/options.nix" target="_top">
pkgs/by-name/tr/treefmt/modules/options.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-treefmt-name"></a><a class="term" href="index.html#opt-treefmt-name"><code class="option">name</code>
  </a>
 </span>
</dt>
<dd>
<p>Name to use for the wrapped treefmt package.</p>

<p><span class="emphasis"><em>Type:</em></span>
string</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">&quot;${getName package}-with-config&quot;</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/tr/treefmt/modules/options.nix" target="_top">
pkgs/by-name/tr/treefmt/modules/options.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-treefmt-runtimeInputs"></a><a class="term" href="index.html#opt-treefmt-runtimeInputs"><code class="option">runtimeInputs</code>
  </a>
 </span>
</dt>
<dd>
<p>Packages to include on treefmt’s PATH.</p>

<p><span class="emphasis"><em>Type:</em></span>
list of package</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">[ ]</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/tr/treefmt/modules/options.nix" target="_top">
pkgs/by-name/tr/treefmt/modules/options.nix
</a></code>
</td></tr>
</table>
</dd>
<dt>
 <span class="term">
 <a id="opt-treefmt-settings"></a><a class="term" href="index.html#opt-treefmt-settings"><code class="option">settings</code>
  </a>
 </span>
</dt>
<dd>
<p>Settings used to build a treefmt config file.</p>

<p><span class="emphasis"><em>Type:</em></span>
TOML value</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">{ }</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tr><td>
<code class="filename"><a class="filename"  href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/by-name/tr/treefmt/modules/settings.nix" target="_top">
pkgs/by-name/tr/treefmt/modules/settings.nix
</a></code>
</td></tr>
</table>
</dd>
 </dl>
</div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-steam" class="title" style="clear: both">Steam   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-steam-nix">Steam in Nix</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-steam-play">How to play</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-steam-troub">Troubleshooting</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-steam-run">steam-run</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-steam-nix" class="title" >Steam in Nix   </h3>  </div> </div></div><p>Steam is distributed as a <code class="literal">.deb</code> file, for now only as an i686 package (the amd64 package only has documentation). When unpacked, it has a script called <code class="literal">steam</code> that in Ubuntu (their target distro) would go to <code class="literal">/usr/bin</code>. When run for the first time, this script copies some files to the user’s home, which include another script that is the ultimate responsible for launching the steam binary, which is also in <code class="literal">$HOME</code>.</p><p>Nix problems and constraints:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>We don’t have <code class="literal">/bin/bash</code> and many scripts point there. Same thing for <code class="literal">/usr/bin/python</code>.</p></li><li class="listitem"><p>We don’t have the dynamic loader in <code class="literal">/lib</code>.</p></li><li class="listitem"><p>The <code class="literal">steam.sh</code> script in <code class="literal">$HOME</code> cannot be patched, as it is checked and rewritten by steam.</p></li><li class="listitem"><p>The steam binary cannot be patched, it’s also checked.</p></li></ul></div><p>The current approach to deploy Steam in NixOS is composing a FHS-compatible chroot environment, as documented <a class="link" href="https://sandervanderburg.blogspot.com/2013/09/composing-fhs-compatible-chroot.html"  target="_top">here</a>. This allows us to have binaries in the expected paths without disrupting the system, and to avoid patching them to work in a non FHS environment.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-steam-play" class="title" >How to play   </h3>  </div> </div></div><p>Use <code class="literal">programs.steam.enable = true;</code> if you want to add steam to <code class="literal">systemPackages</code> and also enable a few workarounds as well as Steam controller support or other Steam supported controllers such as the DualShock 4 or Nintendo Switch Pro Controller.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-steam-troub" class="title" >Troubleshooting   </h3>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><span class="strong"><strong>Steam fails to start. What do I do?</strong></span></p><p>Try to run</p><pre><code class="programlisting ShellSession">strace steam
</code></pre><p>to see what is causing steam to fail.</p></li><li class="listitem"><p><span class="strong"><strong>Using the FOSS Radeon or nouveau (nvidia) drivers</strong></span></p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: circle;"><li class="listitem"><p>Steam ships statically linked with a version of <code class="literal">libcrypto</code> that conflicts with the one dynamically loaded by radeonsi_dri.so. If you get the error:</p><pre><code class="programlisting">steam.sh: line 713: 7842 Segmentation fault (core dumped)
</code></pre><p>have a look at <a class="link" href="https://github.com/NixOS/nixpkgs/pull/20269"  target="_top">this pull request</a>.</p></li></ul></div></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-steam-run" class="title" >steam-run   </h3>  </div> </div></div><p>The FHS-compatible chroot used for Steam can also be used to run other Linux games that expect a FHS environment. To use it, install the <code class="literal">steam-run</code> package and run the game with:</p><pre><code class="programlisting">steam-run ./foo
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="cataclysm-dark-days-ahead" class="title" style="clear: both">Cataclysm: Dark Days Ahead   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#how-to-install-cataclysm-dda">How to install Cataclysm DDA</a> </span></dt><dt> <span class="section">  <a href="index.html#important-note-for-overriding-packages">Important note for overriding packages</a> </span></dt><dt> <span class="section">  <a href="index.html#customizing-with-mods">Customizing with mods</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="how-to-install-cataclysm-dda" class="title" >How to install Cataclysm DDA   </h3>  </div> </div></div><p>To install the latest stable release of Cataclysm DDA to your profile, execute
<code class="literal">nix-env -f &quot;&lt;nixpkgs&gt;&quot; -iA cataclysm-dda</code>. For the curses build (build
without tiles), install <code class="literal">cataclysmDDA.stable.curses</code>. Note: <code class="literal">cataclysm-dda</code> is
an alias to <code class="literal">cataclysmDDA.stable.tiles</code>.</p><p>If you like access to a development build of your favorite git revision,
override <code class="literal">cataclysm-dda-git</code> (or <code class="literal">cataclysmDDA.git.curses</code> if you like curses
build):</p><pre><code class="programlisting nix">cataclysm-dda-git.override {
  version = &quot;YYYY-MM-DD&quot;;
  rev = &quot;YOUR_FAVORITE_REVISION&quot;;
  sha256 = &quot;CHECKSUM_OF_THE_REVISION&quot;;
}
</code></pre><p>The sha256 checksum can be obtained by</p><pre><code class="programlisting sh">nix-prefetch-url --unpack &quot;https://github.com/CleverRaven/Cataclysm-DDA/archive/${YOUR_FAVORITE_REVISION}.tar.gz&quot;
</code></pre><p>The default configuration directory is <code class="literal">~/.cataclysm-dda</code>. If you prefer
<code class="literal">$XDG_CONFIG_HOME/cataclysm-dda</code>, override the derivation:</p><pre><code class="programlisting nix">cataclysm-dda.override { useXdgDir = true; }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="important-note-for-overriding-packages" class="title" >Important note for overriding packages   </h3>  </div> </div></div><p>After applying <code class="literal">overrideAttrs</code>, you need to fix <code class="literal">passthru.pkgs</code> and
<code class="literal">passthru.withMods</code> attributes either manually or by using <code class="literal">attachPkgs</code>:</p><pre><code class="programlisting nix">let
  # You enabled parallel building.
  myCDDA = cataclysm-dda-git.overrideAttrs (_: {
    enableParallelBuilding = true;
  });

  # Unfortunately, this refers to the package before overriding and
  # parallel building is still disabled.
  badExample = myCDDA.withMods (_: [ ]);

  inherit (cataclysmDDA) attachPkgs pkgs wrapCDDA;

  # You can fix it by hand
  goodExample1 = myCDDA.overrideAttrs (old: {
    passthru = old.passthru // {
      pkgs = pkgs.override { build = goodExample1; };
      withMods = wrapCDDA goodExample1;
    };
  });

  # or by using a helper function `attachPkgs`.
  goodExample2 = attachPkgs pkgs myCDDA;

  # badExample                     # parallel building disabled
  # goodExample1.withMods (_: [])  # parallel building enabled
in
goodExample2.withMods (_: [ ]) # parallel building enabled
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="customizing-with-mods" class="title" >Customizing with mods   </h3>  </div> </div></div><p>To install Cataclysm DDA with mods of your choice, you can use <code class="literal">withMods</code>
attribute:</p><pre><code class="programlisting nix">cataclysm-dda.withMods (mods: with mods; [ tileset.UndeadPeople ])
</code></pre><p>All mods, soundpacks, and tilesets available in nixpkgs are found in
<code class="literal">cataclysmDDA.pkgs</code>.</p><p>Here is an example to modify existing mods and/or add more mods not available
in nixpkgs:</p><pre><code class="programlisting nix">let
  customMods =
    self: super:
    lib.recursiveUpdate super {
      # Modify existing mod
      tileset.UndeadPeople = super.tileset.UndeadPeople.overrideAttrs (old: {
        # If you like to apply a patch to the tileset for example
        patches = [ ./path/to/your.patch ];
      });

      # Add another mod
      mod.Awesome = cataclysmDDA.buildMod {
        modName = &quot;Awesome&quot;;
        version = &quot;0.x&quot;;
        src = fetchFromGitHub {
          owner = &quot;Someone&quot;;
          repo = &quot;AwesomeMod&quot;;
          rev = &quot;...&quot;;
          hash = &quot;...&quot;;
        };
        # Path to be installed in the unpacked source (default: &quot;.&quot;)
        modRoot = &quot;contents/under/this/path/will/be/installed&quot;;
      };

      # Add another soundpack
      soundpack.Fantastic = cataclysmDDA.buildSoundPack {
        # ditto
      };

      # Add another tileset
      tileset.SuperDuper = cataclysmDDA.buildTileSet {
        # ditto
      };
    };
in
cataclysm-dda.withMods (
  mods: with mods.extend customMods; [
    tileset.UndeadPeople
    mod.Awesome
    soundpack.Fantastic
    tileset.SuperDuper
  ]
)
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-urxvt" class="title" style="clear: both">Urxvt   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-urxvt-conf">Configuring urxvt</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-urxvt-pkg">Packaging urxvt plugins</a> </span></dt> </dl></div><p>Urxvt, also known as rxvt-unicode, is a highly customizable terminal emulator.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-urxvt-conf" class="title" >Configuring urxvt   </h3>  </div> </div></div><p>In <code class="literal">nixpkgs</code>, urxvt is provided by the package <code class="literal">rxvt-unicode</code>. It can be configured to include your choice of plugins, reducing its closure size from the default configuration which includes all available plugins. To make use of this functionality, use an overlay or directly install an expression that overrides its configuration, such as:</p><pre><code class="programlisting nix">rxvt-unicode.override {
  configure =
    { availablePlugins, ... }:
    {
      plugins = with availablePlugins; [
        perls
        resize-font
        vtwheel
      ];
    };
}
</code></pre><p>If the <code class="literal">configure</code> function returns an attrset without the <code class="literal">plugins</code> attribute, <code class="literal">availablePlugins</code> will be used automatically.</p><p>In order to add plugins but also keep all default plugins installed, it is possible to use the following method:</p><pre><code class="programlisting nix">rxvt-unicode.override {
  configure =
    { availablePlugins, ... }:
    {
      plugins = (builtins.attrValues availablePlugins) ++ [ custom-plugin ];
    };
}
</code></pre><p>To get a list of all the plugins available, open the Nix REPL and run</p><pre><code class="programlisting ShellSession">$ nix repl
:l &lt;nixpkgs&gt;
map (p: p.name) pkgs.rxvt-unicode.plugins
</code></pre><p>Alternatively, if your shell is bash or zsh and have completion enabled, type <code class="literal">nixpkgs.rxvt-unicode.plugins.&lt;tab&gt;</code>.</p><p>In addition to <code class="literal">plugins</code> the options <code class="literal">extraDeps</code> and <code class="literal">perlDeps</code> can be used to install extra packages. <code class="literal">extraDeps</code> can be used, for example, to provide <code class="literal">xsel</code> (a clipboard manager) to the clipboard plugin, without installing it globally:</p><pre><code class="programlisting nix">rxvt-unicode.override {
  configure =
    { availablePlugins, ... }:
    {
      pluginsDeps = [ xsel ];
    };
}
</code></pre><p><code class="literal">perlDeps</code> is a handy way to provide Perl packages to your custom plugins (in <code class="literal">$HOME/.urxvt/ext</code>). For example, if you need <code class="literal">AnyEvent</code> you can do:</p><pre><code class="programlisting nix">rxvt-unicode.override {
  configure =
    { availablePlugins, ... }:
    {
      perlDeps = with perlPackages; [ AnyEvent ];
    };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-urxvt-pkg" class="title" >Packaging urxvt plugins   </h3>  </div> </div></div><p>Urxvt plugins resides in <code class="literal">pkgs/applications/misc/rxvt-unicode-plugins</code>. To add a new plugin, create an expression in a subdirectory and add the package to the set in <code class="literal">pkgs/applications/misc/rxvt-unicode-plugins/default.nix</code>.</p><p>A plugin can be any kind of derivation, the only requirement is that it should always install perl scripts in <code class="literal">$out/lib/urxvt/perl</code>. Look for existing plugins for examples.</p><p>If the plugin is itself a Perl package that needs to be imported from other plugins or scripts, add the following passthrough:</p><pre><code class="programlisting nix">{ passthru.perlPackages = [ &quot;self&quot; ]; }
</code></pre><p>This will make the urxvt wrapper pick up the dependency and set up the Perl path accordingly.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-vcpkg" class="title" style="clear: both">VCPKG   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-vcpkg-nix-envvars">Nix specific environment variables</a> </span></dt> </dl></div><p>The <code class="literal">vcpkg-tool</code> package  has a wrapper around the <code class="literal">vcpkg</code> executable to avoid writing to the nix store.
The wrapper will also be present in <code class="literal">vcpkg</code>, unless you specify <code class="literal">vcpkg.override { vcpkg-tool = vcpkg-tool-unwrapped; }</code></p><p>The wrapper has been made in a way so that it will provide default cli arguments, but tries not to interfere if the user provides the same arguments.
The arguments also have corresponding environment variables that can be used as an alternative way of overriding these paths.</p><p>Run the wrapper with the environment variable <code class="literal">NIX_VCPKG_DEBUG_PRINT_ENVVARS=true</code> to get a full list of corresponding environment variables.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-vcpkg-nix-envvars" class="title" >Nix specific environment variables   </h3>  </div> </div></div><p>The wrapper also provides some new nix-specific environment variables that lets you control some of the wrapper functionality.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">NIX_VCPKG_WRITABLE_PATH = &lt;path&gt;</code></p><p>Set this environment variable to specify the path where <code class="literal">vcpkg</code> will store buildtime artifacts.
This will become the base path for all of the other paths.</p></li><li class="listitem"><p><code class="literal">NIX_VCPKG_DEBUG_PRINT_ENVVARS = true | false</code></p><p>Set this to <code class="literal">true</code> for the wrapper to print the corresponding environment variables for the arguments that will be provided to the unwrapped executable.
The list of variables will be printed right before invoking <code class="literal">vcpkg</code>.
This can be useful if you suspect that the wrapper for some reason was unable to prioritize user-provided cli args over its default ones, or for fixing other issues like typos or unexpanded environment variables.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-weechat" class="title" style="clear: both">WeeChat   </h2>  </div> </div></div><p>WeeChat can be configured to include your choice of plugins, reducing its closure size from the default configuration which includes all available plugins. To make use of this functionality, install an expression that overrides its configuration, such as:</p><pre><code class="programlisting nix">weechat.override {
  configure = (
    { availablePlugins, ... }:
    {
      plugins = with availablePlugins; [
        python
        perl
      ];
    }
  );
}
</code></pre><p>If the <code class="literal">configure</code> function returns an attrset without the <code class="literal">plugins</code> attribute, <code class="literal">availablePlugins</code> will be used automatically.</p><p>The plugins currently available are <code class="literal">python</code>, <code class="literal">perl</code>, <code class="literal">ruby</code>, <code class="literal">guile</code>, <code class="literal">tcl</code> and <code class="literal">lua</code>.</p><p>The Python and Perl plugins allows the addition of extra libraries. For instance, the <code class="literal">inotify.py</code> script in <code class="literal">weechat-scripts</code> requires D-Bus or libnotify, and the <code class="literal">fish.py</code> script requires <code class="literal">pycrypto</code>. To use these scripts, use the plugin’s <code class="literal">withPackages</code> attribute:</p><pre><code class="programlisting nix">weechat.override {
  configure =
    { availablePlugins, ... }:
    {
      plugins = with availablePlugins; [
        (python.withPackages (
          ps: with ps; [
            pycrypto
            python-dbus
          ]
        ))
      ];
    };
}
</code></pre><p>In order to also keep all default plugins installed, it is possible to use the following method:</p><pre><code class="programlisting nix">weechat.override {
  configure =
    { availablePlugins, ... }:
    {
      plugins = builtins.attrValues (
        availablePlugins
        // {
          python = availablePlugins.python.withPackages (
            ps: with ps; [
              pycrypto
              python-dbus
            ]
          );
        }
      );
    };
}
</code></pre><p>WeeChat allows to set defaults on startup using the <code class="literal">--run-command</code>. The <code class="literal">configure</code> method can be used to pass commands to the program:</p><pre><code class="programlisting nix">weechat.override {
  configure =
    { availablePlugins, ... }:
    {
      init = &#x27;&#x27;
        /set foo bar
        /server add libera irc.libera.chat
      &#x27;&#x27;;
    };
}
</code></pre><p>Further values can be added to the list of commands when running <code class="literal">weechat --run-command &quot;your-commands&quot;</code>.</p><p>Additionally, it’s possible to specify scripts to be loaded when starting <code class="literal">weechat</code>. These will be loaded before the commands from <code class="literal">init</code>:</p><pre><code class="programlisting nix">weechat.override {
  configure =
    { availablePlugins, ... }:
    {
      scripts = with pkgs.weechatScripts; [
        weechat-xmpp
        weechat-matrix-bridge
        wee-slack
      ];
      init = &#x27;&#x27;
        /set plugins.var.python.jabber.key &quot;val&quot;
      &#x27;&#x27;;
    };
}
</code></pre><p>In <code class="literal">nixpkgs</code> there’s a subpackage which contains derivations for WeeChat scripts. Such derivations expect a <code class="literal">passthru.scripts</code> attribute, which contains a list of all scripts inside the store path. Furthermore, all scripts have to live in <code class="literal">$out/share</code>. An exemplary derivation looks like this:</p><pre><code class="programlisting nix">{ stdenv, fetchurl }:

stdenv.mkDerivation {
  name = &quot;exemplary-weechat-script&quot;;
  src = fetchurl {
    url = &quot;https://scripts.tld/your-scripts.tar.gz&quot;;
    hash = &quot;...&quot;;
  };
  passthru.scripts = [
    &quot;foo.py&quot;
    &quot;bar.lua&quot;
  ];
  installPhase = &#x27;&#x27;
    runHook preInstall

    mkdir $out/share
    cp foo.py $out/share
    cp bar.lua $out/share

    runHook postInstall
  &#x27;&#x27;;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-xorg" class="title" style="clear: both">X.org   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#katamari-tarballs">Katamari Tarballs</a> </span></dt><dt> <span class="section">  <a href="index.html#individual-tarballs">Individual Tarballs</a> </span></dt><dt> <span class="section">  <a href="index.html#generating-nix-expressions">Generating Nix Expressions</a> </span></dt><dt> <span class="section">  <a href="index.html#overriding-the-generator">Overriding the Generator</a> </span></dt> </dl></div><p>The Nix expressions for the X.org packages reside in <code class="literal">pkgs/servers/x11/xorg/default.nix</code>. This file is automatically generated from lists of tarballs in an X.org release. As such it should not be modified directly; rather, you should modify the lists, the generator script or the file <code class="literal">pkgs/servers/x11/xorg/overrides.nix</code>, in which you can override or add to the derivations produced by the generator.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="katamari-tarballs" class="title" >Katamari Tarballs   </h3>  </div> </div></div><p>X.org upstream releases used to include <a class="link" href="https://en.wiktionary.org/wiki/%E3%81%8B%E3%81%9F%E3%81%BE%E3%82%8A"  target="_top">katamari</a> releases, which included a holistic recommended version for each tarball, up until 7.7. To create a list of tarballs in a katamari release:</p><pre><code class="programlisting ShellSession">export release=&quot;X11R7.7&quot;
export url=&quot;mirror://xorg/$release/src/everything/&quot;
cat $(PRINT_PATH=1 nix-prefetch-url $url | tail -n 1) \
  | perl -e &#x27;while (&lt;&gt;) { if (/(href|HREF)=&quot;([^&quot;]*.bz2)&quot;/) { print &quot;$ENV{&#x27;url&#x27;}$2\n&quot;; }; }&#x27; \
  | sort &gt; &quot;tarballs-$release.list&quot;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="individual-tarballs" class="title" >Individual Tarballs   </h3>  </div> </div></div><p>The upstream release process for <a class="link" href="https://x.org/wiki/Releases/7.8/"  target="_top">X11R7.8</a> does not include a planned katamari. Instead, each component of X.org is released as its own tarball. We maintain <code class="literal">pkgs/servers/x11/xorg/tarballs.list</code> as a list of tarballs for each individual package. This list includes X.org core libraries and protocol descriptions, extra newer X11 interface libraries, like <code class="literal">xorg.libxcb</code>, and classic utilities which are largely unused but still available if needed, like <code class="literal">xorg.imake</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="generating-nix-expressions" class="title" >Generating Nix Expressions   </h3>  </div> </div></div><p>The generator is invoked as follows:</p><pre><code class="programlisting ShellSession">cd pkgs/servers/x11/xorg
&lt;tarballs.list perl ./generate-expr-from-tarballs.pl
</code></pre><p>For each of the tarballs in the <code class="literal">.list</code> files, the script downloads it, unpacks it, and searches its <code class="literal">configure.ac</code> and <code class="literal">*.pc.in</code> files for dependencies. This information is used to generate <code class="literal">default.nix</code>. The generator caches downloaded tarballs between runs. Pay close attention to the <code class="literal">NOT FOUND: $NAME</code> messages at the end of the run, since they may indicate missing dependencies. (Some might be optional dependencies, however.)</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="overriding-the-generator" class="title" >Overriding the Generator   </h3>  </div> </div></div><p>If the expression for a package requires derivation attributes that the generator cannot figure out automatically (say, <code class="literal">patches</code> or a <code class="literal">postInstall</code> hook), you should modify <code class="literal">pkgs/servers/x11/xorg/overrides.nix</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-build-support" class="title" style="clear: both">Build Support   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#pkgs-substitute"><code class="literal">pkgs.substitute</code></a> </span></dt><dt> <span class="section">  <a href="index.html#pkgs-replacevars"><code class="literal">pkgs.replaceVars</code></a> </span></dt><dt> <span class="section">  <a href="index.html#pkgs-replacevarswith"><code class="literal">pkgs.replaceVarsWith</code></a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="pkgs-substitute" class="title" ><code class="literal">pkgs.substitute</code>   </h3>  </div> </div></div><p><code class="literal">pkgs.substitute</code> is a wrapper around <a class="link" href="index.html#fun-substitute" title="substitute &lt;infile&gt; &lt;outfile&gt; &lt;subs&gt;" >the <code class="literal">substitute</code> Bash function</a> in the standard environment.
It replaces strings in <code class="literal">src</code> as specified by the <code class="literal">substitutions</code> argument.</p><div class="example"><span id="ex-pkgs-substitute" ></span><details><summary><span class="title"><strong>Example 363. Usage of <code class="literal">pkgs.substitute</code></strong></span></summary><div class="example-contents"><p>In a build script, the line:</p><pre><code class="programlisting bash">substitute $infile $outfile --replace-fail @foo@ ${foopkg}/bin/foo
</code></pre><p>is equivalent to:</p><pre><code class="programlisting nix">{ substitute, foopkg }:
substitute {
  src = ./sourcefile.txt;
  substitutions = [
    &quot;--replace&quot;
    &quot;@foo@&quot;
    &quot;${foopkg}/bin/foo&quot;
  ];
}
</code></pre></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="pkgs-replacevars" class="title" ><code class="literal">pkgs.replaceVars</code>   </h3>  </div> </div></div><p><code class="literal">pkgs.replaceVars &lt;src&gt; &lt;replacements&gt;</code> replaces all instances of <code class="literal">@varName@</code> (<code class="literal">@</code>s included) in file <code class="literal">src</code> with the respective value in the attribute set <code class="literal">replacements</code>.</p><div class="example"><span id="ex-pkgs-replace-vars" ></span><details><summary><span class="title"><strong>Example 364. Usage of <code class="literal">pkgs.replaceVars</code></strong></span></summary><div class="example-contents"><p>If <code class="literal">say-goodbye.sh</code> contains the following:</p><pre><code class="programlisting bash">#! @bash@/bin/bash

echo @unchanged@
@hello@/bin/hello --greeting @greeting@
</code></pre><p>the following derivation will make substitutions to <code class="literal">@bash@</code>, <code class="literal">@hello@</code>, and <code class="literal">@greeting@</code>:</p><pre><code class="programlisting nix">{
  replaceVars,
  bash,
  hello,
}:
replaceVars ./say-goodbye.sh {
  inherit bash hello;
  greeting = &quot;goodbye&quot;;
  unchanged = null;
}
</code></pre><p>such that <code class="literal">$out</code> will result in something like the following:</p><pre><code class="programlisting">#! /nix/store/s30jrpgav677fpc9yvkqsib70xfmx7xi-bash-5.2p26/bin/bash

echo @unchanged@
/nix/store/566f5isbvw014h7knmzmxa5l6hshx43k-hello-2.12.1/bin/hello --greeting goodbye
</code></pre><p>Note that, in contrast to the old <code class="literal">substituteAll</code>, <code class="literal">unchanged = null</code> must explicitly be set.
Any unreferenced <code class="literal">@...@</code> pattern in the source file will throw an error.</p></div></details></div><br class="example-break" />
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="pkgs-replacevarswith" class="title" ><code class="literal">pkgs.replaceVarsWith</code>   </h3>  </div> </div></div><p><code class="literal">pkgs.replaceVarsWith</code> works the same way as <a class="link" href="index.html#pkgs-replacevars" title="pkgs.replaceVars" >pkgs.replaceVars</a>, but additionally allows more options.</p><div class="example"><span id="ex-pkgs-replace-vars-with" ></span><details><summary><span class="title"><strong>Example 365. Usage of <code class="literal">pkgs.replaceVarsWith</code></strong></span></summary><div class="example-contents"><p>With the example file <code class="literal">say-goodbye.sh</code>, consider:</p><pre><code class="programlisting nix">{ replaceVarsWith }:
replaceVarsWith {
  src = ./say-goodbye.sh;

  replacements = {
    inherit bash hello;
    greeting = &quot;goodbye&quot;;
    unchanged = null;
  };

  name = &quot;say-goodbye&quot;;
  dir = &quot;bin&quot;;
  isExecutable = true;
  meta.mainProgram = &quot;say-goodbye&quot;;
}
</code></pre><p>This will make the resulting file executable, put it in <code class="literal">bin/say-goodbye</code> and set <code class="literal">meta</code> attributes respectively.</p></div></details></div><br class="example-break" />
</div>

</div>
</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="part-development" class="title" >Development of Nixpkgs   </h1>  </div> </div></div><div class="partintro"><p>This section shows you how Nixpkgs is being developed and how you can interact with the contributors and the latest updates.
If you are interested in contributing yourself, see <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#sec-opening-issues">Opening issues</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-opening-issues" class="title" >Opening issues   </h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Make sure you have a <a class="link" href="https://github.com/signup/free"  target="_top">GitHub account</a></p></li><li class="listitem"><p>Make sure there is no open issue on the topic</p></li><li class="listitem"><p><a class="link" href="https://github.com/NixOS/nixpkgs/issues/new/choose"  target="_top">Submit a new issue</a> by choosing the kind of topic and fill out the template</p></li></ul></div>
</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="part-contributing" class="title" >Contributing to Nixpkgs   </h1>  </div> </div></div><div class="partintro"><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#chap-quick-start">Quick Start to Adding a Package</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-conventions">Coding conventions</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-submitting-changes">Submitting changes</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-vulnerability-roundup">Vulnerability Roundup</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-reviewing-contributions">Reviewing contributions</a> </span></dt><dt> <span class="chapter">  <a href="index.html#chap-contributing">Contributing to Nixpkgs documentation</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-quick-start" class="title" >Quick Start to Adding a Package   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-conventions" class="title" >Coding conventions   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-syntax">Syntax</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-package-naming">Package naming</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-organisation">File naming and organisation</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-sources">Fetching Sources</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-source-hashes">Obtaining source hash</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-patches">Patches</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-package-tests">Package tests</a> </span></dt> </dl></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-syntax" class="title" style="clear: both">Syntax   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-package-naming" class="title" style="clear: both">Package naming   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-organisation" class="title" style="clear: both">File naming and organisation   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-versioning">Versioning</a> </span></dt> </dl></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-versioning" class="title" >Versioning   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-sources" class="title" style="clear: both">Fetching Sources   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-source-hashes" class="title" style="clear: both">Obtaining source hash   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-source-hashes-security">Obtaining hashes securely</a> </span></dt> </dl></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-source-hashes-security" class="title" >Obtaining hashes securely   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-patches" class="title" style="clear: both">Patches   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-package-tests" class="title" style="clear: both">Package tests   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#ssec-inline-package-tests-writing">Writing inline package tests</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-package-tests-writing">Writing larger package tests</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-package-tests-running">Running package tests</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-package-tests-examples">Examples of package tests</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-nixos-tests-linking">Linking NixOS module tests to a package</a> </span></dt><dt> <span class="section">  <a href="index.html#ssec-import-from-derivation">Import From Derivation</a> </span></dt> </dl></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-inline-package-tests-writing" class="title" >Writing inline package tests   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-package-tests-writing" class="title" >Writing larger package tests   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-package-tests-running" class="title" >Running package tests   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-package-tests-examples" class="title" >Examples of package tests   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-nixos-tests-linking" class="title" >Linking NixOS module tests to a package   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-import-from-derivation" class="title" >Import From Derivation   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-submitting-changes" class="title" >Submitting changes   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#submitting-changes-submitting-changes">Submitting changes</a> </span></dt><dt> <span class="section">  <a href="index.html#submitting-changes-submitting-security-fixes">Submitting security fixes</a> </span></dt><dt> <span class="section">  <a href="index.html#submitting-changes-deprecating-packages">Deprecating/removing packages</a> </span></dt><dt> <span class="section">  <a href="index.html#submitting-changes-pull-request-template">Pull Request Template</a> </span></dt><dt> <span class="section">  <a href="index.html#submitting-changes-hotfixing-pull-requests">Hotfixing pull requests</a> </span></dt><dt> <span class="section">  <a href="index.html#submitting-changes-commit-policy">Commit policy</a> </span></dt> </dl></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="submitting-changes-submitting-changes" class="title" style="clear: both">Submitting changes   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="submitting-changes-submitting-security-fixes" class="title" style="clear: both">Submitting security fixes   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="submitting-changes-deprecating-packages" class="title" style="clear: both">Deprecating/removing packages   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#steps-to-remove-a-package-from-nixpkgs">Steps to remove a package from Nixpkgs</a> </span></dt> </dl></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="steps-to-remove-a-package-from-nixpkgs" class="title" >Steps to remove a package from Nixpkgs   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="submitting-changes-pull-request-template" class="title" style="clear: both">Pull Request Template   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#submitting-changes-tested-with-sandbox">Tested using sandboxing</a> </span></dt><dt> <span class="section">  <a href="index.html#submitting-changes-platform-diversity">Built on platform(s)</a> </span></dt><dt> <span class="section">  <a href="index.html#submitting-changes-nixos-tests">Tested via one or more NixOS test(s) if existing and applicable for the change (look inside nixos/tests)</a> </span></dt><dt> <span class="section">  <a href="index.html#submitting-changes-tested-compilation">Tested compilation of all pkgs that depend on this change using <code class="literal">nixpkgs-review</code></a> </span></dt><dt> <span class="section">  <a href="index.html#submitting-changes-tested-execution">Tested execution of all binary files (usually in <code class="literal">./result/bin/</code>)</a> </span></dt><dt> <span class="section">  <a href="index.html#submitting-changes-contribution-standards">Meets Nixpkgs contribution standards</a> </span></dt> </dl></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="submitting-changes-tested-with-sandbox" class="title" >Tested using sandboxing   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="submitting-changes-platform-diversity" class="title" >Built on platform(s)   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="submitting-changes-nixos-tests" class="title" >Tested via one or more NixOS test(s) if existing and applicable for the change (look inside nixos/tests)   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="submitting-changes-tested-compilation" class="title" >Tested compilation of all pkgs that depend on this change using <code class="literal">nixpkgs-review</code>   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="submitting-changes-tested-execution" class="title" >Tested execution of all binary files (usually in <code class="literal">./result/bin/</code>)   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="submitting-changes-contribution-standards" class="title" >Meets Nixpkgs contribution standards   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="submitting-changes-hotfixing-pull-requests" class="title" style="clear: both">Hotfixing pull requests   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="submitting-changes-commit-policy" class="title" style="clear: both">Commit policy   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#submitting-changes-branches">Branches</a> </span></dt> </dl></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="submitting-changes-branches" class="title" >Branches   </h3>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="submitting-changes-master-branch" class="title" >Master branch   </h4>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="submitting-changes-staging-branch" class="title" >Staging branch   </h4>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="submitting-changes-staging-next-branch" class="title" >Staging-next branch   </h4>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="submitting-changes-stable-release-branches" class="title" >Stable release branches   </h4>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="submitting-changes-stable-release-branches-automatic-backports" class="title" >Automatically backporting a Pull Request   </h4>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="submitting-changes-stable-release-branches-manual-backports" class="title" >Manually backporting changes   </h4>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="acceptable-backport-criteria" class="title" >Acceptable backport criteria   </h4>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div>

</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-vulnerability-roundup" class="title" >Vulnerability Roundup   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#vulnerability-roundup-issues">Issues</a> </span></dt><dt> <span class="section">  <a href="index.html#vulnerability-roundup-triaging-and-fixing">Triaging and Fixing</a> </span></dt> </dl></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="vulnerability-roundup-issues" class="title" style="clear: both">Issues   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="vulnerability-roundup-triaging-and-fixing" class="title" style="clear: both">Triaging and Fixing   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-reviewing-contributions" class="title" >Reviewing contributions   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#reviewing-contributions-package-updates">Package updates</a> </span></dt><dt> <span class="section">  <a href="index.html#reviewing-contributions-new-packages">New packages</a> </span></dt><dt> <span class="section">  <a href="index.html#reviewing-contributions-module-updates">Module updates</a> </span></dt><dt> <span class="section">  <a href="index.html#reviewing-contributions-new-modules">New modules</a> </span></dt><dt> <span class="section">  <a href="index.html#reviewing-contributions-individual-maintainer-list">Individual maintainer list</a> </span></dt><dt> <span class="section">  <a href="index.html#reviewing-contributions-maintainer-teams">Maintainer teams</a> </span></dt><dt> <span class="section">  <a href="index.html#reviewing-contributions-other-submissions">Other submissions</a> </span></dt><dt> <span class="section">  <a href="index.html#reviewing-contributions--merging-pull-requests">Merging pull requests</a> </span></dt> </dl></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="reviewing-contributions-package-updates" class="title" style="clear: both">Package updates   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="reviewing-contributions-new-packages" class="title" style="clear: both">New packages   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/README.md"  target="_top">pkgs/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="reviewing-contributions-module-updates" class="title" style="clear: both">Module updates   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/README.md"  target="_top">nixos/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="reviewing-contributions-new-modules" class="title" style="clear: both">New modules   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/README.md"  target="_top">nixos/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="reviewing-contributions-individual-maintainer-list" class="title" style="clear: both">Individual maintainer list   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/maintainers/README.md"  target="_top">maintainers/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="reviewing-contributions-maintainer-teams" class="title" style="clear: both">Maintainer teams   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/maintainers/README.md"  target="_top">maintainers/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="reviewing-contributions-other-submissions" class="title" style="clear: both">Other submissions   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="reviewing-contributions--merging-pull-requests" class="title" style="clear: both">Merging pull requests   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md"  target="_top">CONTRIBUTING.md</a>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-contributing" class="title" >Contributing to Nixpkgs documentation   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-contributing-devmode">devmode</a> </span></dt><dt> <span class="section">  <a href="index.html#sec-contributing-markup">Syntax</a> </span></dt> </dl></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/doc/README.md"  target="_top">doc/README.md</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-contributing-devmode" class="title" style="clear: both">devmode   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/doc/README.md"  target="_top">doc/README.md</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-contributing-markup" class="title" style="clear: both">Syntax   </h2>  </div> </div></div><p>This section has been moved to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/doc/README.md"  target="_top">doc/README.md</a>.</p>
</div>

</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="part-interoperability" class="title" >Interoperability Standards   </h1>  </div> </div></div><div class="partintro"><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="index.html#chap-interop-cyclonedx">CycloneDX</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-interop-cyclonedx" class="title" >CycloneDX   </h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-interop.cylonedx-nix"><code class="literal">nix</code> Namespace Property Taxonomy</a> </span></dt> </dl></div><p><a class="link" href="https://owasp.org/"  target="_top">OWASP</a> <a class="link" href="https://cyclonedx.org/"  target="_top">CycloneDX</a> is a Software <a class="link" href="https://en.wikipedia.org/wiki/Bill_of_materials"  target="_top">Bill of Materials</a> (SBOM) standard.
The standards described here are for including Nix specific information within SBOMs in a way that is interoperable with external SBOM tooling.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-interop.cylonedx-nix" class="title" style="clear: both"><code class="literal">nix</code> Namespace Property Taxonomy   </h2>  </div> </div></div><div class="toc"> <dl class="toc">  <dt> <span class="section">  <a href="index.html#sec-interop.cylonedx-narinfo"><code class="literal">nix:narinfo</code></a> </span></dt><dt> <span class="section">  <a href="index.html#sec-interop.cylonedx-fod"><code class="literal">nix:fod</code></a> </span></dt> </dl></div><p>The following tables describe namespaces for <a class="link" href="https://cyclonedx.org/docs/1.6/json/#components_items_properties"  target="_top">properties</a> that may be attached to components within SBOMs.
Component properties are lists of name-value-pairs where values must be strings.
Properties with the same name may appear more than once.
Names and values are case-sensitive.</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">Property</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code class="literal">nix:store_path</code></td><td align="left">A Nix store path for the given component. This property should be contextualized by additional properties that describe the production of the store path, such as those from the <code class="literal">nix:narinfo:</code> and <code class="literal">nix:fod</code> namespaces.</td></tr></tbody></table></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">Namespace</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><a class="link" href="index.html#sec-interop.cylonedx-narinfo" title="nix:narinfo" ><code class="literal">nix:narinfo</code></a></td><td align="left">Namespace for properties that are specific to how a component is stored as a <a class="link" href="https://nixos.org/manual/nix/stable/glossary#gloss-nar"  target="_top">Nix archive</a> (NAR) in a <a class="link" href="https://nixos.org/manual/nix/stable/glossary#gloss-binary-cache"  target="_top">binary cache</a>.</td></tr><tr><td align="left"><a class="link" href="index.html#sec-interop.cylonedx-fod" title="nix:fod" ><code class="literal">nix:fod</code></a></td><td align="left">Namespace for properties that describe a <a class="link" href="https://nixos.org/manual/nix/stable/glossary#gloss-fixed-output-derivation"  target="_top">fixed-output derivation</a>.</td></tr></tbody></table></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-interop.cylonedx-narinfo" class="title" ><code class="literal">nix:narinfo</code>   </h3>  </div> </div></div><p>Narinfo properties describe component archives that may be available from binary caches.
The <code class="literal">nix:narinfo</code> properties should be accompanied by a <code class="literal">nix:store_path</code> property within the same property list.</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">Property</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code class="literal">nix:narinfo:store_path</code></td><td align="left">Store path for the given store component.</td></tr><tr><td align="left"><code class="literal">nix:narinfo:url</code></td><td align="left">URL path component.</td></tr><tr><td align="left"><code class="literal">nix:narinfo:nar_hash</code></td><td align="left">Hash of the file system object part of the component when serialized as a Nix Archive.</td></tr><tr><td align="left"><code class="literal">nix:narinfo:nar_size</code></td><td align="left">Size of the component when serialized as a Nix Archive.</td></tr><tr><td align="left"><code class="literal">nix:narinfo:compression</code></td><td align="left">The compression format that component archive is in.</td></tr><tr><td align="left"><code class="literal">nix:narinfo:file_hash</code></td><td align="left">A digest for the compressed component archive itself, as opposed to the data contained within.</td></tr><tr><td align="left"><code class="literal">nix:narinfo:file_size</code></td><td align="left">The size of the compressed component archive itself.</td></tr><tr><td align="left"><code class="literal">nix:narinfo:deriver</code></td><td align="left">The path to the derivation from which this component is produced.</td></tr><tr><td align="left"><code class="literal">nix:narinfo:system</code></td><td align="left">The hardware and software platform on which this component is produced.</td></tr><tr><td align="left"><code class="literal">nix:narinfo:sig</code></td><td align="left">Signatures claiming that this component is what it claims to be.</td></tr><tr><td align="left"><code class="literal">nix:narinfo:ca</code></td><td align="left">Content address of this store object’s file system object, used to compute its store path.</td></tr><tr><td align="left"><code class="literal">nix:narinfo:references</code></td><td align="left">A whitespace separated array of store paths that this component references.</td></tr></tbody></table></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-interop.cylonedx-fod" class="title" ><code class="literal">nix:fod</code>   </h3>  </div> </div></div><p>FOD properties describe a <a class="link" href="https://nixos.org/manual/nix/stable/glossary#gloss-fixed-output-derivation"  target="_top">fixed-output derivation</a>.
The <code class="literal">nix:fod:method</code> property is required and must be accompanied by a <code class="literal">nix:store_path</code> property within the same property list.
All other properties in this namespace are method-specific.
To reproduce the build of a component the <code class="literal">nix:fod:method</code> value is resolved to an <a class="link" href="index.html#chap-pkgs-fetchers" title="Fetchers" >appropriate function</a> within Nixpkgs whose arguments intersect with the given properties.
When generating <code class="literal">nix:fod</code> properties the method selected should be a stable function with a minimal number arguments.
For example, the <code class="literal">fetchFromGitHub</code> is commonly used within Nixpkgs but should be reduced to a call to the function by which it is implemented, <code class="literal">fetchzip</code>.</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">Property</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code class="literal">nix:fod:method</code></td><td align="left">Nixpkg function that produces this FOD. Required. Examples: <code class="literal">&quot;fetchzip&quot;</code>, <code class="literal">&quot;fetchgit&quot;</code></td></tr><tr><td align="left"><code class="literal">nix:fod:name</code></td><td align="left">Derivation name, present when method is <code class="literal">&quot;fetchzip&quot;</code></td></tr><tr><td align="left"><code class="literal">nix:fod:ref</code></td><td align="left"><a class="link" href="https://git-scm.com/docs/gitglossary#Documentation/gitglossary.txt-aiddefrefaref"  target="_top">Git ref</a>, present when method is <code class="literal">&quot;fetchgit&quot;</code></td></tr><tr><td align="left"><code class="literal">nix:fod:rev</code></td><td align="left"><a class="link" href="https://git-scm.com/docs/gitglossary#Documentation/gitglossary.txt-aiddefrevisionarevision"  target="_top">Git rev</a>, present when method is <code class="literal">&quot;fetchgit&quot;</code></td></tr><tr><td align="left"><code class="literal">nix:fod:sha256</code></td><td align="left">FOD hash</td></tr><tr><td align="left"><code class="literal">nix:fod:url</code></td><td align="left">URL to fetch</td></tr></tbody></table></div><p><code class="literal">nix:fod</code> properties may be extracted and evaluated to a derivation using code similar to the following, assuming a fictitious function <code class="literal">filterPropertiesToAttrs</code>:</p><pre><code class="programlisting nix">{
  pkgs,
  filterPropertiesToAttrs,
  properties,
}:
let
  fodProps = filterPropertiesToAttrs &quot;nix:fod:&quot; properties;

  methods = {
    fetchzip =
      {
        name,
        url,
        sha256,
        ...
      }:
      pkgs.fetchzip { inherit name url sha256; };
  };

in
methods.${fodProps.method} fodProps
</code></pre>
</div>

</div>

</div>
</div>
 </div>
  <div class="navfooter">
   <hr />
   <table width="100%" summary="Navigation footer">
    <tr>
    <td width="40%" align="left">&nbsp;</td>
    <td width="20%" align="center">&nbsp;</td>
    <td width="40%" align="right">&nbsp;<a accesskey="n" href="release-notes.html">Next</a></td>
    </tr>
    <tr>
     <td width="40%" align="left" valign="top">&nbsp;</td>
     <td width="20%" align="center">&nbsp;</td>
     <td width="40%" align="right" valign="top">&nbsp;Appendix A. Release Notes</td>
    </tr>
   </table>
  </div>
 </body>
</html>