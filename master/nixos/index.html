<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>NixOS Manual</title><link rel="stylesheet" type="text/css" href="style.css" /><link rel="stylesheet" type="text/css" href="overrides.css" /><link rel="stylesheet" type="text/css" href="highlightjs/mono-blue.css" /><script src="./highlightjs/highlight.pack.js" type="text/javascript"></script><script src="./highlightjs/loader.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.79.2" /><link rel="home" href="index.html" title="NixOS Manual" /><link rel="next" href="options.html" title="Appendix A. Configuration Options" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">NixOS Manual</th></tr><tr><td width="20%" align="left"> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="options.html">Next</a></td></tr></table><hr /></div><div class="book"><div class="titlepage"><div><div><h1 class="title"><a id="book-nixos-manual"></a>NixOS Manual</h1></div><div><h2 class="subtitle">Version 22.05
  </h2></div></div><hr /></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="preface"><a href="index.html#preface">Preface</a></span></dt><dt><span class="part"><a href="index.html#ch-installation">I. Installation</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#sec-obtaining">1. Obtaining NixOS</a></span></dt><dt><span class="chapter"><a href="index.html#sec-installation">2. Installing NixOS</a></span></dt><dt><span class="chapter"><a href="index.html#sec-changing-config">3. Changing the Configuration</a></span></dt><dt><span class="chapter"><a href="index.html#sec-upgrading">4. Upgrading NixOS</a></span></dt></dl></dd><dt><span class="part"><a href="index.html#ch-configuration">II. Configuration</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#sec-configuration-syntax">5. Configuration Syntax</a></span></dt><dt><span class="chapter"><a href="index.html#sec-package-management">6. Package Management</a></span></dt><dt><span class="chapter"><a href="index.html#sec-user-management">7. User Management</a></span></dt><dt><span class="chapter"><a href="index.html#ch-file-systems">8. File Systems</a></span></dt><dt><span class="chapter"><a href="index.html#sec-x11">9. X Window System</a></span></dt><dt><span class="chapter"><a href="index.html#sec-wayland">10. Wayland</a></span></dt><dt><span class="chapter"><a href="index.html#sec-gpu-accel">11. GPU acceleration</a></span></dt><dt><span class="chapter"><a href="index.html#sec-xfce">12. Xfce Desktop Environment</a></span></dt><dt><span class="chapter"><a href="index.html#sec-networking">13. Networking</a></span></dt><dt><span class="chapter"><a href="index.html#sec-kernel-config">14. Linux Kernel</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-subversion">15. Subversion</a></span></dt><dt><span class="chapter"><a href="index.html#chap-pantheon">16. Pantheon Desktop</a></span></dt><dt><span class="chapter"><a href="index.html#chap-gnome">17. GNOME Desktop</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-matomo">18. Matomo</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-plausible">19. Plausible</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-pict-rs">20. Pict-rs</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-nextcloud">21. Nextcloud</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-lemmy">22. Lemmy</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-keycloak">23. Keycloak</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-jitsi-meet">24. Jitsi Meet</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-grocy">25. Grocy</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-discourse">26. Discourse</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-meilisearch">27. Meilisearch</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-networking-yggdrasil">28. Yggdrasil</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-prosody">29. Prosody</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-pleroma">30. Pleroma</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-mosquitto">31. Mosquitto</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-litestream">32. Litestream</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-prometheus-exporters">33. Prometheus exporters</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-parsedmarc">34. parsedmarc</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-weechat">35. WeeChat</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-taskserver">36. Taskserver</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-sourcehut">37. Sourcehut</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-gitlab">38. GitLab</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-mjolnir">39. Mjolnir (Matrix Moderation Tool)</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-matrix">40. Matrix</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-mailman">41. Mailman</a></span></dt><dt><span class="chapter"><a href="index.html#trezor">42. Trezor</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-emacs">43. Emacs</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-blackfire">44. Blackfire profiler</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-flatpak">45. Flatpak</a></span></dt><dt><span class="chapter"><a href="index.html#module-postgresql">46. PostgreSQL</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-foundationdb">47. FoundationDB</a></span></dt><dt><span class="chapter"><a href="index.html#module-borgbase">48. BorgBackup</a></span></dt><dt><span class="chapter"><a href="index.html#module-security-acme">49. SSL/TLS Certificates with ACME</a></span></dt><dt><span class="chapter"><a href="index.html#module-programs-zsh-ohmyzsh">50. Oh my ZSH</a></span></dt><dt><span class="chapter"><a href="index.html#module-program-plotinus">51. Plotinus</a></span></dt><dt><span class="chapter"><a href="index.html#module-programs-digitalbitbox">52. Digital Bitbox</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-input-methods">53. Input Methods</a></span></dt><dt><span class="chapter"><a href="index.html#ch-profiles">54. Profiles</a></span></dt><dt><span class="chapter"><a href="index.html#sec-kubernetes">55. Kubernetes</a></span></dt></dl></dd><dt><span class="part"><a href="index.html#ch-running">III. Administration</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#sec-systemctl">56. Service Management</a></span></dt><dt><span class="chapter"><a href="index.html#sec-rebooting">57. Rebooting and Shutting Down</a></span></dt><dt><span class="chapter"><a href="index.html#sec-user-sessions">58. User Sessions</a></span></dt><dt><span class="chapter"><a href="index.html#sec-cgroups">59. Control Groups</a></span></dt><dt><span class="chapter"><a href="index.html#sec-logging">60. Logging</a></span></dt><dt><span class="chapter"><a href="index.html#sec-nix-gc">61. Cleaning the Nix Store</a></span></dt><dt><span class="chapter"><a href="index.html#ch-containers">62. Container Management</a></span></dt><dt><span class="chapter"><a href="index.html#ch-troubleshooting">63. Troubleshooting</a></span></dt></dl></dd><dt><span class="part"><a href="index.html#ch-development">IV. Development</a></span></dt><dd><dl><dt><span class="chapter"><a href="index.html#sec-getting-sources">64. Getting the Sources</a></span></dt><dt><span class="chapter"><a href="index.html#sec-writing-modules">65. Writing NixOS Modules</a></span></dt><dt><span class="chapter"><a href="index.html#sec-building-parts">66. Building Specific Parts of NixOS</a></span></dt><dt><span class="chapter"><a href="index.html#sec-switching-systems">67. What happens during a system switch?</a></span></dt><dt><span class="chapter"><a href="index.html#sec-writing-documentation">68. Writing NixOS Documentation</a></span></dt><dt><span class="chapter"><a href="index.html#sec-building-image">69. Building a NixOS (Live) ISO</a></span></dt><dt><span class="chapter"><a href="index.html#sec-nixos-tests">70. NixOS Tests</a></span></dt><dt><span class="chapter"><a href="index.html#ch-testing-installer">71. Testing the Installer</a></span></dt></dl></dd><dt><span class="appendix"><a href="options.html">A. Configuration Options</a></span></dt><dt><span class="chapter"><a href="index.html#chap-contributing">72. Contributing to this manual</a></span></dt><dt><span class="appendix"><a href="release-notes.html">B. Release Notes</a></span></dt></dl></div><div class="list-of-examples"><p><strong>List of Examples</strong></p><dl><dt>43.1. <a href="index.html#ex-emacsNix">Nix expression to build Emacs with packages (<code class="filename">emacs.nix</code>)</a></dt><dt>43.2. <a href="index.html#module-services-emacs-querying-packages">Querying Emacs packages</a></dt><dt>43.3. <a href="index.html#module-services-emacs-configuration-nix">Custom Emacs in <code class="filename">configuration.nix</code></a></dt><dt>43.4. <a href="index.html#module-services-emacs-config-nix">Custom Emacs in <code class="filename">~/.config/nixpkgs/config.nix</code></a></dt><dt>43.5. <a href="index.html#ex-emacsGtk3Nix">Custom Emacs build</a></dt><dt>43.6. <a href="index.html#module-services-emacs-package-initialisation">Package initialization in <code class="filename">.emacs</code></a></dt><dt>43.7. <a href="index.html#ex-emacs-docbook-xml">nXML Schema Configuration (<code class="filename">~/.emacs.d/schemas.xml</code>)</a></dt></dl></div><div class="preface"><div class="titlepage"><div><div><h1 class="title"><a id="preface"></a>Preface</h1></div></div></div><p>
  This manual describes how to install, use and extend NixOS, a Linux
  distribution based on the purely functional package management system
  <a class="link" href="https://nixos.org/nix" target="_top">Nix</a>, that is composed
  using modules and packages defined in the
  <a class="link" href="https://nixos.org/nixpkgs" target="_top">Nixpkgs</a> project.
 </p><p>
  Additional information regarding the Nix package manager and the Nixpkgs
  project can be found in respectively the
  <a class="link" href="https://nixos.org/nix/manual" target="_top">Nix manual</a> and the
  <a class="link" href="https://nixos.org/nixpkgs/manual" target="_top">Nixpkgs manual</a>.
 </p><p>
  If you encounter problems, please report them on the
  <code class="literal"><a class="literal" href="https://discourse.nixos.org" target="_top">Discourse</a></code>,
  the <a class="link" href="https://matrix.to/#nix:nixos.org" target="_top">Matrix room</a>,
  or on the <a class="link" href="irc://irc.libera.chat/#nixos" target="_top">
  <code class="literal">#nixos</code> channel on Libera.Chat</a>.
  Alternatively, consider <a class="link" href="index.html#chap-contributing" title="Chapter 72. Contributing to this manual">
   contributing to this manual</a>. Bugs should be
  reported in
  <a class="link" href="https://github.com/NixOS/nixpkgs/issues" target="_top">NixOS’
  GitHub issue tracker</a>.
 </p><div class="note"><h3 class="title">Note</h3><p>
   Commands prefixed with <code class="literal">#</code> have to be run as root, either
   requiring to login as root user or temporarily switching to it using
   <code class="literal">sudo</code> for example.
  </p></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="ch-installation"></a>Part I. Installation</h1></div></div></div><div class="partintro"><div></div><p>
   This section describes how to obtain, install, and configure NixOS for
   first-time use.
  </p><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="index.html#sec-obtaining">1. Obtaining NixOS</a></span></dt><dt><span class="chapter"><a href="index.html#sec-installation">2. Installing NixOS</a></span></dt><dt><span class="chapter"><a href="index.html#sec-changing-config">3. Changing the Configuration</a></span></dt><dt><span class="chapter"><a href="index.html#sec-upgrading">4. Upgrading NixOS</a></span></dt></dl></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-obtaining"></a>Chapter 1. Obtaining NixOS</h2></div></div></div><p>
    NixOS ISO images can be downloaded from the
    <a class="link" href="https://nixos.org/nixos/download.html" target="_top">NixOS
    download page</a>. There are a number of installation options. If
    you happen to have an optical drive and a spare CD, burning the
    image to CD and booting from that is probably the easiest option.
    Most people will need to prepare a USB stick to boot from.
    <a class="xref" href="index.html#sec-booting-from-usb" title="2.5.1. Booting from a USB Drive">Section 2.5.1, “Booting from a USB Drive”</a> describes the preferred
    method to prepare a USB stick. A number of alternative methods are
    presented in the
    <a class="link" href="https://nixos.wiki/wiki/NixOS_Installation_Guide#Making_the_installation_media" target="_top">NixOS
    Wiki</a>.
  </p><p>
    As an alternative to installing NixOS yourself, you can get a
    running NixOS system through several other means:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        Using virtual appliances in Open Virtualization Format (OVF)
        that can be imported into VirtualBox. These are available from
        the
        <a class="link" href="https://nixos.org/nixos/download.html" target="_top">NixOS
        download page</a>.
      </p></li><li class="listitem"><p>
        Using AMIs for Amazon’s EC2. To find one for your region and
        instance type, please refer to the
        <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/virtualisation/ec2-amis.nix" target="_top">list
        of most recent AMIs</a>.
      </p></li><li class="listitem"><p>
        Using NixOps, the NixOS-based cloud deployment tool, which
        allows you to provision VirtualBox and EC2 NixOS instances from
        declarative specifications. Check out the
        <a class="link" href="https://nixos.org/nixops" target="_top">NixOps
        homepage</a> for details.
      </p></li></ul></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-installation"></a>Chapter 2. Installing NixOS</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-installation-booting">2.1. Booting the system</a></span></dt><dt><span class="section"><a href="index.html#sec-installation-partitioning">2.2. Partitioning and formatting</a></span></dt><dt><span class="section"><a href="index.html#sec-installation-installing">2.3. Installing</a></span></dt><dt><span class="section"><a href="index.html#sec-installation-summary">2.4. Installation summary</a></span></dt><dt><span class="section"><a href="index.html#sec-installation-additional-notes">2.5. Additional installation notes</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-installation-booting"></a>2.1. Booting the system</h2></div></div></div><p>
      NixOS can be installed on BIOS or UEFI systems. The procedure for
      a UEFI installation is by and large the same as a BIOS
      installation. The differences are mentioned in the steps that
      follow.
    </p><p>
      The installation media can be burned to a CD, or now more
      commonly, <span class="quote">“<span class="quote">burned</span>”</span> to a USB drive (see
      <a class="xref" href="index.html#sec-booting-from-usb" title="2.5.1. Booting from a USB Drive">Section 2.5.1, “Booting from a USB Drive”</a>).
    </p><p>
      The installation media contains a basic NixOS installation. When
      it’s finished booting, it should have detected most of your
      hardware.
    </p><p>
      The NixOS manual is available by running
      <code class="literal">nixos-help</code>.
    </p><p>
      You are logged-in automatically as <code class="literal">nixos</code>. The
      <code class="literal">nixos</code> user account has an empty password so you
      can use <code class="literal">sudo</code> without a password:
    </p><pre class="programlisting">
$ sudo -i
</pre><p>
      If you downloaded the graphical ISO image, you can run
      <code class="literal">systemctl start display-manager</code> to start the
      desktop environment. If you want to continue on the terminal, you
      can use <code class="literal">loadkeys</code> to switch to your preferred
      keyboard layout. (We even provide neo2 via
      <code class="literal">loadkeys de neo</code>!)
    </p><p>
      If the text is too small to be legible, try
      <code class="literal">setfont ter-v32n</code> to increase the font size.
    </p><p>
      To install over a serial port connect with
      <code class="literal">115200n8</code> (e.g.
      <code class="literal">picocom -b 115200 /dev/ttyUSB0</code>). When the
      bootloader lists boot entries, select the serial console boot
      entry.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-installation-booting-networking"></a>2.1.1. Networking in the installer</h3></div></div></div><p>
        The boot process should have brought up networking (check
        <code class="literal">ip a</code>). Networking is necessary for the
        installer, since it will download lots of stuff (such as source
        tarballs or Nixpkgs channel binaries). It’s best if you have a
        DHCP server on your network. Otherwise configure networking
        manually using <code class="literal">ifconfig</code>.
      </p><p>
        On the graphical installer, you can configure the network, wifi
        included, through NetworkManager. Using the
        <code class="literal">nmtui</code> program, you can do so even in a
        non-graphical session. If you prefer to configure the network
        manually, disable NetworkManager with
        <code class="literal">systemctl stop NetworkManager</code>.
      </p><p>
        On the minimal installer, NetworkManager is not available, so
        configuration must be perfomed manually. To configure the wifi,
        first start wpa_supplicant with
        <code class="literal">sudo systemctl start wpa_supplicant</code>, then run
        <code class="literal">wpa_cli</code>. For most home networks, you need to
        type in the following commands:
      </p><pre class="programlisting">
&gt; add_network
0
&gt; set_network 0 ssid "myhomenetwork"
OK
&gt; set_network 0 psk "mypassword"
OK
&gt; set_network 0 key_mgmt WPA-PSK
OK
&gt; enable_network 0
OK
</pre><p>
        For enterprise networks, for example
        <span class="emphasis"><em>eduroam</em></span>, instead do:
      </p><pre class="programlisting">
&gt; add_network
0
&gt; set_network 0 ssid "eduroam"
OK
&gt; set_network 0 identity "myname@example.com"
OK
&gt; set_network 0 password "mypassword"
OK
&gt; set_network 0 key_mgmt WPA-EAP
OK
&gt; enable_network 0
OK
</pre><p>
        When successfully connected, you should see a line such as this
        one
      </p><pre class="programlisting">
&lt;3&gt;CTRL-EVENT-CONNECTED - Connection to 32:85:ab:ef:24:5c completed [id=0 id_str=]
</pre><p>
        you can now leave <code class="literal">wpa_cli</code> by typing
        <code class="literal">quit</code>.
      </p><p>
        If you would like to continue the installation from a different
        machine you can use activated SSH daemon. You need to copy your
        ssh key to either
        <code class="literal">/home/nixos/.ssh/authorized_keys</code> or
        <code class="literal">/root/.ssh/authorized_keys</code> (Tip: For
        installers with a modifiable filesystem such as the sd-card
        installer image a key can be manually placed by mounting the
        image on a different machine). Alternatively you must set a
        password for either <code class="literal">root</code> or
        <code class="literal">nixos</code> with <code class="literal">passwd</code> to be
        able to login.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-installation-partitioning"></a>2.2. Partitioning and formatting</h2></div></div></div><p>
      The NixOS installer doesn’t do any partitioning or formatting, so
      you need to do that yourself.
    </p><p>
      The NixOS installer ships with multiple partitioning tools. The
      examples below use <code class="literal">parted</code>, but also provides
      <code class="literal">fdisk</code>, <code class="literal">gdisk</code>,
      <code class="literal">cfdisk</code>, and <code class="literal">cgdisk</code>.
    </p><p>
      The recommended partition scheme differs depending if the computer
      uses <span class="emphasis"><em>Legacy Boot</em></span> or
      <span class="emphasis"><em>UEFI</em></span>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-installation-partitioning-UEFI"></a>2.2.1. UEFI (GPT)</h3></div></div></div><p>
        Here's an example partition scheme for UEFI, using
        <code class="literal">/dev/sda</code> as the device.
      </p><div class="note"><h3 class="title">Note</h3><p>
          You can safely ignore <code class="literal">parted</code>'s
          informational message about needing to update /etc/fstab.
        </p></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
            Create a <span class="emphasis"><em>GPT</em></span> partition table.
          </p><pre class="programlisting">
# parted /dev/sda -- mklabel gpt
</pre></li><li class="listitem"><p>
            Add the <span class="emphasis"><em>root</em></span> partition. This will fill
            the disk except for the end part, where the swap will live,
            and the space left in front (512MiB) which will be used by
            the boot partition.
          </p><pre class="programlisting">
# parted /dev/sda -- mkpart primary 512MiB -8GiB
</pre></li><li class="listitem"><p>
            Next, add a <span class="emphasis"><em>swap</em></span> partition. The size
            required will vary according to needs, here a 8GiB one is
            created.
          </p><pre class="programlisting">
# parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
</pre><div class="note"><h3 class="title">Note</h3><p>
              The swap partition size rules are no different than for
              other Linux distributions.
            </p></div></li><li class="listitem"><p>
            Finally, the <span class="emphasis"><em>boot</em></span> partition. NixOS by
            default uses the ESP (EFI system partition) as its
            <span class="emphasis"><em>/boot</em></span> partition. It uses the initially
            reserved 512MiB at the start of the disk.
          </p><pre class="programlisting">
# parted /dev/sda -- mkpart ESP fat32 1MiB 512MiB
# parted /dev/sda -- set 3 esp on
</pre></li></ol></div><p>
        Once complete, you can follow with
        <a class="xref" href="index.html#sec-installation-partitioning-formatting" title="2.2.3. Formatting">Section 2.2.3, “Formatting”</a>.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-installation-partitioning-MBR"></a>2.2.2. Legacy Boot (MBR)</h3></div></div></div><p>
        Here's an example partition scheme for Legacy Boot, using
        <code class="literal">/dev/sda</code> as the device.
      </p><div class="note"><h3 class="title">Note</h3><p>
          You can safely ignore <code class="literal">parted</code>'s
          informational message about needing to update /etc/fstab.
        </p></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
            Create a <span class="emphasis"><em>MBR</em></span> partition table.
          </p><pre class="programlisting">
# parted /dev/sda -- mklabel msdos
</pre></li><li class="listitem"><p>
            Add the <span class="emphasis"><em>root</em></span> partition. This will fill
            the the disk except for the end part, where the swap will
            live.
          </p><pre class="programlisting">
# parted /dev/sda -- mkpart primary 1MiB -8GiB
</pre></li><li class="listitem"><p>
            Finally, add a <span class="emphasis"><em>swap</em></span> partition. The size
            required will vary according to needs, here a 8GiB one is
            created.
          </p><pre class="programlisting">
# parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
</pre><div class="note"><h3 class="title">Note</h3><p>
              The swap partition size rules are no different than for
              other Linux distributions.
            </p></div></li></ol></div><p>
        Once complete, you can follow with
        <a class="xref" href="index.html#sec-installation-partitioning-formatting" title="2.2.3. Formatting">Section 2.2.3, “Formatting”</a>.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-installation-partitioning-formatting"></a>2.2.3. Formatting</h3></div></div></div><p>
        Use the following commands:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            For initialising Ext4 partitions:
            <code class="literal">mkfs.ext4</code>. It is recommended that you
            assign a unique symbolic label to the file system using the
            option <code class="literal">-L label</code>, since this makes the
            file system configuration independent from device changes.
            For example:
          </p><pre class="programlisting">
# mkfs.ext4 -L nixos /dev/sda1
</pre></li><li class="listitem"><p>
            For creating swap partitions: <code class="literal">mkswap</code>.
            Again it’s recommended to assign a label to the swap
            partition: <code class="literal">-L label</code>. For example:
          </p><pre class="programlisting">
# mkswap -L swap /dev/sda2
</pre></li><li class="listitem"><p>
            <span class="strong"><strong>UEFI systems</strong></span>
          </p><p>
            For creating boot partitions: <code class="literal">mkfs.fat</code>.
            Again it’s recommended to assign a label to the boot
            partition: <code class="literal">-n label</code>. For example:
          </p><pre class="programlisting">
# mkfs.fat -F 32 -n boot /dev/sda3
</pre></li><li class="listitem"><p>
            For creating LVM volumes, the LVM commands, e.g.,
            <code class="literal">pvcreate</code>, <code class="literal">vgcreate</code>,
            and <code class="literal">lvcreate</code>.
          </p></li><li class="listitem"><p>
            For creating software RAID devices, use
            <code class="literal">mdadm</code>.
          </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-installation-installing"></a>2.3. Installing</h2></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
          Mount the target file system on which NixOS should be
          installed on <code class="literal">/mnt</code>, e.g.
        </p><pre class="programlisting">
# mount /dev/disk/by-label/nixos /mnt
</pre></li><li class="listitem"><p>
          <span class="strong"><strong>UEFI systems</strong></span>
        </p><p>
          Mount the boot file system on <code class="literal">/mnt/boot</code>,
          e.g.
        </p><pre class="programlisting">
# mkdir -p /mnt/boot
# mount /dev/disk/by-label/boot /mnt/boot
</pre></li><li class="listitem"><p>
          If your machine has a limited amount of memory, you may want
          to activate swap devices now
          (<code class="literal">swapon device</code>). The installer (or rather,
          the build actions that it may spawn) may need quite a bit of
          RAM, depending on your configuration.
        </p><pre class="programlisting">
# swapon /dev/sda2
</pre></li><li class="listitem"><p>
          You now need to create a file
          <code class="literal">/mnt/etc/nixos/configuration.nix</code> that
          specifies the intended configuration of the system. This is
          because NixOS has a <span class="emphasis"><em>declarative</em></span>
          configuration model: you create or edit a description of the
          desired configuration of your system, and then NixOS takes
          care of making it happen. The syntax of the NixOS
          configuration file is described in
          <a class="xref" href="index.html#sec-configuration-syntax" title="Chapter 5. Configuration Syntax">Chapter 5, <em>Configuration Syntax</em></a>, while a list of
          available configuration options appears in
          <a class="xref" href="options.html" title="Appendix A. Configuration Options">Appendix A, <em>Configuration Options</em></a>. A minimal example is shown in
          <a class="link" href="index.html#ex-config">Example: NixOS Configuration</a>.
        </p><p>
          The command <code class="literal">nixos-generate-config</code> can
          generate an initial configuration file for you:
        </p><pre class="programlisting">
# nixos-generate-config --root /mnt
</pre><p>
          You should then edit
          <code class="literal">/mnt/etc/nixos/configuration.nix</code> to suit
          your needs:
        </p><pre class="programlisting">
# nano /mnt/etc/nixos/configuration.nix
</pre><p>
          If you’re using the graphical ISO image, other editors may be
          available (such as <code class="literal">vim</code>). If you have
          network access, you can also install other editors – for
          instance, you can install Emacs by running
          <code class="literal">nix-env -f '&lt;nixpkgs&gt;' -iA emacs</code>.
        </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
              BIOS systems
            </span></dt><dd><p>
                You <span class="emphasis"><em>must</em></span> set the option
                <a class="xref" href="options.html#opt-boot.loader.grub.device"><code class="option">boot.loader.grub.device</code></a> to
                specify on which disk the GRUB boot loader is to be
                installed. Without it, NixOS cannot boot.
              </p></dd><dt><span class="term">
              UEFI systems
            </span></dt><dd><p>
                You <span class="emphasis"><em>must</em></span> set the option
                <a class="xref" href="options.html#opt-boot.loader.systemd-boot.enable"><code class="option">boot.loader.systemd-boot.enable</code></a>
                to <code class="literal">true</code>.
                <code class="literal">nixos-generate-config</code> should do this
                automatically for new configurations when booted in UEFI
                mode.
              </p><p>
                You may want to look at the options starting with
                <a class="link" href="options.html#opt-boot.loader.efi.canTouchEfiVariables"><code class="literal">boot.loader.efi</code></a>
                and
                <a class="link" href="options.html#opt-boot.loader.systemd-boot.enable"><code class="literal">boot.loader.systemd-boot</code></a>
                as well.
              </p></dd></dl></div><p>
          If there are other operating systems running on the machine
          before installing NixOS, the
          <a class="xref" href="options.html#opt-boot.loader.grub.useOSProber"><code class="option">boot.loader.grub.useOSProber</code></a> option can
          be set to <code class="literal">true</code> to automatically add them to
          the grub menu.
        </p><p>
          If you need to configure networking for your machine the
          configuration options are described in
          <a class="xref" href="index.html#sec-networking" title="Chapter 13. Networking">Chapter 13, <em>Networking</em></a>. In particular, while wifi
          is supported on the installation image, it is not enabled by
          default in the configuration generated by
          <code class="literal">nixos-generate-config</code>.
        </p><p>
          Another critical option is <code class="literal">fileSystems</code>,
          specifying the file systems that need to be mounted by NixOS.
          However, you typically don’t need to set it yourself, because
          <code class="literal">nixos-generate-config</code> sets it automatically
          in
          <code class="literal">/mnt/etc/nixos/hardware-configuration.nix</code>
          from your currently mounted file systems. (The configuration
          file <code class="literal">hardware-configuration.nix</code> is included
          from <code class="literal">configuration.nix</code> and will be
          overwritten by future invocations of
          <code class="literal">nixos-generate-config</code>; thus, you generally
          should not modify it.) Additionally, you may want to look at
          <a class="link" href="https://github.com/NixOS/nixos-hardware" target="_top">Hardware
          configuration for known-hardware</a> at this point or after
          installation.
        </p><div class="note"><h3 class="title">Note</h3><p>
            Depending on your hardware configuration or type of file
            system, you may need to set the option
            <code class="literal">boot.initrd.kernelModules</code> to include the
            kernel modules that are necessary for mounting the root file
            system, otherwise the installed system will not be able to
            boot. (If this happens, boot from the installation media
            again, mount the target file system on
            <code class="literal">/mnt</code>, fix
            <code class="literal">/mnt/etc/nixos/configuration.nix</code> and
            rerun <code class="literal">nixos-install</code>.) In most cases,
            <code class="literal">nixos-generate-config</code> will figure out the
            required modules.
          </p></div></li><li class="listitem"><p>
          Do the installation:
        </p><pre class="programlisting">
# nixos-install
</pre><p>
          This will install your system based on the configuration you
          provided. If anything fails due to a configuration problem or
          any other issue (such as a network outage while downloading
          binaries from the NixOS binary cache), you can re-run
          <code class="literal">nixos-install</code> after fixing your
          <code class="literal">configuration.nix</code>.
        </p><p>
          As the last step, <code class="literal">nixos-install</code> will ask
          you to set the password for the <code class="literal">root</code> user,
          e.g.
        </p><pre class="programlisting">
setting root password...
New password: ***
Retype new password: ***
</pre><div class="note"><h3 class="title">Note</h3><p>
            For unattended installations, it is possible to use
            <code class="literal">nixos-install --no-root-passwd</code> in order
            to disable the password prompt entirely.
          </p></div></li><li class="listitem"><p>
          If everything went well:
        </p><pre class="programlisting">
# reboot
</pre></li><li class="listitem"><p>
          You should now be able to boot into the installed NixOS. The
          GRUB boot menu shows a list of <span class="emphasis"><em>available
          configurations</em></span> (initially just one). Every time you
          change the NixOS configuration (see
          <a class="link" href="index.html#sec-changing-config" title="Chapter 3. Changing the Configuration">Changing
          Configuration</a>), a new item is added to the menu. This
          allows you to easily roll back to a previous configuration if
          something goes wrong.
        </p><p>
          You should log in and change the <code class="literal">root</code>
          password with <code class="literal">passwd</code>.
        </p><p>
          You’ll probably want to create some user accounts as well,
          which can be done with <code class="literal">useradd</code>:
        </p><pre class="programlisting">
$ useradd -c 'Eelco Dolstra' -m eelco
$ passwd eelco
</pre><p>
          You may also want to install some software. This will be
          covered in <a class="xref" href="index.html#sec-package-management" title="Chapter 6. Package Management">Chapter 6, <em>Package Management</em></a>.
        </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-installation-summary"></a>2.4. Installation summary</h2></div></div></div><p>
      To summarise, <a class="link" href="index.html#ex-install-sequence">Example:
      Commands for Installing NixOS on
      <code class="literal">/dev/sda</code></a> shows a typical sequence of
      commands for installing NixOS on an empty hard drive (here
      <code class="literal">/dev/sda</code>). <a class="link" href="index.html#ex-config">Example:
      NixOS Configuration</a> shows a corresponding configuration Nix
      expression.
    </p><a id="ex-partition-scheme-MBR"></a><p>
      <span class="strong"><strong>Example: Example partition schemes for
      NixOS on <code class="literal">/dev/sda</code> (MBR)</strong></span>
    </p><pre class="programlisting">
# parted /dev/sda -- mklabel msdos
# parted /dev/sda -- mkpart primary 1MiB -8GiB
# parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
</pre><a id="ex-partition-scheme-UEFI"></a><p>
      <span class="strong"><strong>Example: Example partition schemes for
      NixOS on <code class="literal">/dev/sda</code> (UEFI)</strong></span>
    </p><pre class="programlisting">
# parted /dev/sda -- mklabel gpt
# parted /dev/sda -- mkpart primary 512MiB -8GiB
# parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
# parted /dev/sda -- mkpart ESP fat32 1MiB 512MiB
# parted /dev/sda -- set 3 esp on
</pre><a id="ex-install-sequence"></a><p>
      <span class="strong"><strong>Example: Commands for Installing NixOS on
      <code class="literal">/dev/sda</code></strong></span>
    </p><p>
      With a partitioned disk.
    </p><pre class="programlisting">
# mkfs.ext4 -L nixos /dev/sda1
# mkswap -L swap /dev/sda2
# swapon /dev/sda2
# mkfs.fat -F 32 -n boot /dev/sda3        # (for UEFI systems only)
# mount /dev/disk/by-label/nixos /mnt
# mkdir -p /mnt/boot                      # (for UEFI systems only)
# mount /dev/disk/by-label/boot /mnt/boot # (for UEFI systems only)
# nixos-generate-config --root /mnt
# nano /mnt/etc/nixos/configuration.nix
# nixos-install
# reboot
</pre><a id="ex-config"></a><p>
      <span class="strong"><strong>Example: NixOS Configuration</strong></span>
    </p><pre class="programlisting">
{ config, pkgs, ... }: {
  imports = [
    # Include the results of the hardware scan.
    ./hardware-configuration.nix
  ];

  boot.loader.grub.device = "/dev/sda";   # (for BIOS systems only)
  boot.loader.systemd-boot.enable = true; # (for UEFI systems only)

  # Note: setting fileSystems is generally not
  # necessary, since nixos-generate-config figures them out
  # automatically in hardware-configuration.nix.
  #fileSystems."/".device = "/dev/disk/by-label/nixos";

  # Enable the OpenSSH server.
  services.sshd.enable = true;
}
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-installation-additional-notes"></a>2.5. Additional installation notes</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-booting-from-usb"></a>2.5.1. Booting from a USB Drive</h3></div></div></div><p>
    For systems without CD drive, the NixOS live CD can be booted from a
    USB stick. You can use the <code class="literal">dd</code> utility to write
    the image: <code class="literal">dd if=path-to-image of=/dev/sdX</code>. Be
    careful about specifying the correct drive; you can use the
    <code class="literal">lsblk</code> command to get a list of block devices.
  </p><div class="note"><h3 class="title">On macOS</h3><pre class="programlisting">
$ diskutil list
[..]
/dev/diskN (external, physical):
   #:                       TYPE NAME                    SIZE       IDENTIFIER
[..]
$ diskutil unmountDisk diskN
Unmount of all volumes on diskN was successful
$ sudo dd if=nix.iso of=/dev/rdiskN
</pre><p>
      Using the 'raw' <code class="literal">rdiskN</code> device instead of
      <code class="literal">diskN</code> completes in minutes instead of hours.
      After <code class="literal">dd</code> completes, a GUI dialog "The disk
      you inserted was not readable by this computer" will pop up,
      which can be ignored.
    </p></div><p>
    The <code class="literal">dd</code> utility will write the image verbatim to
    the drive, making it the recommended option for both UEFI and
    non-UEFI installations.
  </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-booting-from-pxe"></a>2.5.2. Booting from the <span class="quote">“<span class="quote">netboot</span>”</span> media (PXE)</h3></div></div></div><p>
    Advanced users may wish to install NixOS using an existing PXE or
    iPXE setup.
  </p><p>
    These instructions assume that you have an existing PXE or iPXE
    infrastructure and simply want to add the NixOS installer as another
    option. To build the necessary files from your current version of
    nixpkgs, you can run:
  </p><pre class="programlisting">
nix-build -A netboot.x86_64-linux '&lt;nixpkgs/nixos/release.nix&gt;'
</pre><p>
    This will create a <code class="literal">result</code> directory containing: *
    <code class="literal">bzImage</code> – the Linux kernel *
    <code class="literal">initrd</code> – the initrd file *
    <code class="literal">netboot.ipxe</code> – an example ipxe script
    demonstrating the appropriate kernel command line arguments for this
    image
  </p><p>
    If you’re using plain PXE, configure your boot loader to use the
    <code class="literal">bzImage</code> and <code class="literal">initrd</code> files and
    have it provide the same kernel command line arguments found in
    <code class="literal">netboot.ipxe</code>.
  </p><p>
    If you’re using iPXE, depending on how your HTTP/FTP/etc. server is
    configured you may be able to use <code class="literal">netboot.ipxe</code>
    unmodified, or you may need to update the paths to the files to
    match your server’s directory layout.
  </p><p>
    In the future we may begin making these files available as build
    products from hydra at which point we will update this documentation
    with instructions on how to obtain them either for placing on a
    dedicated TFTP server or to boot them directly over the internet.
  </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-instaling-virtualbox-guest"></a>2.5.3. Installing in a VirtualBox guest</h3></div></div></div><p>
    Installing NixOS into a VirtualBox guest is convenient for users who
    want to try NixOS without installing it on bare metal. If you want
    to use a pre-made VirtualBox appliance, it is available at
    <a class="link" href="https://nixos.org/nixos/download.html" target="_top">the
    downloads page</a>. If you want to set up a VirtualBox guest
    manually, follow these instructions:
  </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
        Add a New Machine in VirtualBox with OS Type "Linux / Other
        Linux"
      </p></li><li class="listitem"><p>
        Base Memory Size: 768 MB or higher.
      </p></li><li class="listitem"><p>
        New Hard Disk of 8 GB or higher.
      </p></li><li class="listitem"><p>
        Mount the CD-ROM with the NixOS ISO (by clicking on CD/DVD-ROM)
      </p></li><li class="listitem"><p>
        Click on Settings / System / Processor and enable PAE/NX
      </p></li><li class="listitem"><p>
        Click on Settings / System / Acceleration and enable
        "VT-x/AMD-V" acceleration
      </p></li><li class="listitem"><p>
        Click on Settings / Display / Screen and select VMSVGA as
        Graphics Controller
      </p></li><li class="listitem"><p>
        Save the settings, start the virtual machine, and continue
        installation like normal
      </p></li></ol></div><p>
    There are a few modifications you should make in configuration.nix.
    Enable booting:
  </p><pre class="programlisting">
boot.loader.grub.device = "/dev/sda";
</pre><p>
    Also remove the fsck that runs at startup. It will always fail to
    run, stopping your boot until you press <code class="literal">*</code>.
  </p><pre class="programlisting">
boot.initrd.checkJournalingFS = false;
</pre><p>
    Shared folders can be given a name and a path in the host system in
    the VirtualBox settings (Machine / Settings / Shared Folders, then
    click on the "Add" icon). Add the following to the
    <code class="literal">/etc/nixos/configuration.nix</code> to auto-mount them.
    If you do not add <code class="literal">"nofail"</code>, the system
    will not boot properly.
  </p><pre class="programlisting">
{ config, pkgs, ...} :
{
  fileSystems."/virtualboxshare" = {
    fsType = "vboxsf";
    device = "nameofthesharedfolder";
    options = [ "rw" "nofail" ];
  };
}
</pre><p>
    The folder will be available directly under the root directory.
  </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-installing-from-other-distro"></a>2.5.4. Installing from another Linux distribution</h3></div></div></div><p>
    Because Nix (the package manager) &amp; Nixpkgs (the Nix packages
    collection) can both be installed on any (most?) Linux
    distributions, they can be used to install NixOS in various creative
    ways. You can, for instance:
  </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
        Install NixOS on another partition, from your existing Linux
        distribution (without the use of a USB or optical device!)
      </p></li><li class="listitem"><p>
        Install NixOS on the same partition (in place!), from your
        existing non-NixOS Linux distribution using
        <code class="literal">NIXOS_LUSTRATE</code>.
      </p></li><li class="listitem"><p>
        Install NixOS on your hard drive from the Live CD of any Linux
        distribution.
      </p></li></ol></div><p>
    The first steps to all these are the same:
  </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
        Install the Nix package manager:
      </p><p>
        Short version:
      </p><pre class="programlisting">
$ curl -L https://nixos.org/nix/install | sh
$ . $HOME/.nix-profile/etc/profile.d/nix.sh # …or open a fresh shell
</pre><p>
        More details in the
        <a class="link" href="https://nixos.org/nix/manual/#chap-quick-start" target="_top">
        Nix manual</a>
      </p></li><li class="listitem"><p>
        Switch to the NixOS channel:
      </p><p>
        If you've just installed Nix on a non-NixOS distribution, you
        will be on the <code class="literal">nixpkgs</code> channel by default.
      </p><pre class="programlisting">
$ nix-channel --list
nixpkgs https://nixos.org/channels/nixpkgs-unstable
</pre><p>
        As that channel gets released without running the NixOS tests,
        it will be safer to use the <code class="literal">nixos-*</code> channels
        instead:
      </p><pre class="programlisting">
$ nix-channel --add https://nixos.org/channels/nixos-version nixpkgs
</pre><p>
        You may want to throw in a
        <code class="literal">nix-channel --update</code> for good measure.
      </p></li><li class="listitem"><p>
        Install the NixOS installation tools:
      </p><p>
        You'll need <code class="literal">nixos-generate-config</code> and
        <code class="literal">nixos-install</code>, but this also makes some man
        pages and <code class="literal">nixos-enter</code> available, just in case
        you want to chroot into your NixOS partition. NixOS installs
        these by default, but you don't have NixOS yet..
      </p><pre class="programlisting">
$ nix-env -f '&lt;nixpkgs&gt;' -iA nixos-install-tools
</pre></li><li class="listitem"><div class="note"><h3 class="title">Note</h3><p>
          The following 5 steps are only for installing NixOS to another
          partition. For installing NixOS in place using
          <code class="literal">NIXOS_LUSTRATE</code>, skip ahead.
        </p></div><p>
        Prepare your target partition:
      </p><p>
        At this point it is time to prepare your target partition.
        Please refer to the partitioning, file-system creation, and
        mounting steps of <a class="xref" href="index.html#sec-installation" title="Chapter 2. Installing NixOS">Chapter 2, <em>Installing NixOS</em></a>
      </p><p>
        If you're about to install NixOS in place using
        <code class="literal">NIXOS_LUSTRATE</code> there is nothing to do for
        this step.
      </p></li><li class="listitem"><p>
        Generate your NixOS configuration:
      </p><pre class="programlisting">
$ sudo `which nixos-generate-config` --root /mnt
</pre><p>
        You'll probably want to edit the configuration files. Refer to
        the <code class="literal">nixos-generate-config</code> step in
        <a class="xref" href="index.html#sec-installation" title="Chapter 2. Installing NixOS">Chapter 2, <em>Installing NixOS</em></a> for more information.
      </p><p>
        Consider setting up the NixOS bootloader to give you the ability
        to boot on your existing Linux partition. For instance, if
        you're using GRUB and your existing distribution is running
        Ubuntu, you may want to add something like this to your
        <code class="literal">configuration.nix</code>:
      </p><pre class="programlisting">
boot.loader.grub.extraEntries = ''
  menuentry "Ubuntu" {
    search --set=ubuntu --fs-uuid 3cc3e652-0c1f-4800-8451-033754f68e6e
    configfile "($ubuntu)/boot/grub/grub.cfg"
  }
'';
</pre><p>
        (You can find the appropriate UUID for your partition in
        <code class="literal">/dev/disk/by-uuid</code>)
      </p></li><li class="listitem"><p>
        Create the <code class="literal">nixbld</code> group and user on your
        original distribution:
      </p><pre class="programlisting">
$ sudo groupadd -g 30000 nixbld
$ sudo useradd -u 30000 -g nixbld -G nixbld nixbld
</pre></li><li class="listitem"><p>
        Download/build/install NixOS:
      </p><div class="warning"><h3 class="title">Warning</h3><p>
          Once you complete this step, you might no longer be able to
          boot on existing systems without the help of a rescue USB
          drive or similar.
        </p></div><div class="note"><h3 class="title">Note</h3><p>
          On some distributions there are separate PATHS for programs
          intended only for root. In order for the installation to
          succeed, you might have to use
          <code class="literal">PATH="$PATH:/usr/sbin:/sbin"</code> in
          the following command.
        </p></div><pre class="programlisting">
$ sudo PATH="$PATH" NIX_PATH="$NIX_PATH" `which nixos-install` --root /mnt
</pre><p>
        Again, please refer to the <code class="literal">nixos-install</code> step
        in <a class="xref" href="index.html#sec-installation" title="Chapter 2. Installing NixOS">Chapter 2, <em>Installing NixOS</em></a> for more information.
      </p><p>
        That should be it for installation to another partition!
      </p></li><li class="listitem"><p>
        Optionally, you may want to clean up your non-NixOS
        distribution:
      </p><pre class="programlisting">
$ sudo userdel nixbld
$ sudo groupdel nixbld
</pre><p>
        If you do not wish to keep the Nix package manager installed
        either, run something like
        <code class="literal">sudo rm -rv ~/.nix-* /nix</code> and remove the line
        that the Nix installer added to your
        <code class="literal">~/.profile</code>.
      </p></li><li class="listitem"><div class="note"><h3 class="title">Note</h3><p>
          The following steps are only for installing NixOS in place
          using <code class="literal">NIXOS_LUSTRATE</code>:
        </p></div><p>
        Generate your NixOS configuration:
      </p><pre class="programlisting">
$ sudo `which nixos-generate-config` --root /
</pre><p>
        Note that this will place the generated configuration files in
        <code class="literal">/etc/nixos</code>. You'll probably want to edit the
        configuration files. Refer to the
        <code class="literal">nixos-generate-config</code> step in
        <a class="xref" href="index.html#sec-installation" title="Chapter 2. Installing NixOS">Chapter 2, <em>Installing NixOS</em></a> for more information.
      </p><p>
        You'll likely want to set a root password for your first boot
        using the configuration files because you won't have a chance to
        enter a password until after you reboot. You can initalize the
        root password to an empty one with this line: (and of course
        don't forget to set one once you've rebooted or to lock the
        account with <code class="literal">sudo passwd -l root</code> if you use
        <code class="literal">sudo</code>)
      </p><pre class="programlisting">
users.users.root.initialHashedPassword = "";
</pre></li><li class="listitem"><p>
        Build the NixOS closure and install it in the
        <code class="literal">system</code> profile:
      </p><pre class="programlisting">
$ nix-env -p /nix/var/nix/profiles/system -f '&lt;nixpkgs/nixos&gt;' -I nixos-config=/etc/nixos/configuration.nix -iA system
</pre></li><li class="listitem"><p>
        Change ownership of the <code class="literal">/nix</code> tree to root
        (since your Nix install was probably single user):
      </p><pre class="programlisting">
$ sudo chown -R 0.0 /nix
</pre></li><li class="listitem"><p>
        Set up the <code class="literal">/etc/NIXOS</code> and
        <code class="literal">/etc/NIXOS_LUSTRATE</code> files:
      </p><p>
        <code class="literal">/etc/NIXOS</code> officializes that this is now a
        NixOS partition (the bootup scripts require its presence).
      </p><p>
        <code class="literal">/etc/NIXOS_LUSTRATE</code> tells the NixOS bootup
        scripts to move <span class="emphasis"><em>everything</em></span> that's in the
        root partition to <code class="literal">/old-root</code>. This will move
        your existing distribution out of the way in the very early
        stages of the NixOS bootup. There are exceptions (we do need to
        keep NixOS there after all), so the NixOS lustrate process will
        not touch:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
            The <code class="literal">/nix</code> directory
          </p></li><li class="listitem"><p>
            The <code class="literal">/boot</code> directory
          </p></li><li class="listitem"><p>
            Any file or directory listed in
            <code class="literal">/etc/NIXOS_LUSTRATE</code> (one per line)
          </p></li></ul></div><div class="note"><h3 class="title">Note</h3><p>
          Support for <code class="literal">NIXOS_LUSTRATE</code> was added in
          NixOS 16.09. The act of "lustrating" refers to the
          wiping of the existing distribution. Creating
          <code class="literal">/etc/NIXOS_LUSTRATE</code> can also be used on
          NixOS to remove all mutable files from your root partition
          (anything that's not in <code class="literal">/nix</code> or
          <code class="literal">/boot</code> gets "lustrated" on the
          next boot.
        </p><p>
          lustrate /ˈlʌstreɪt/ verb.
        </p><p>
          purify by expiatory sacrifice, ceremonial washing, or some
          other ritual action.
        </p></div><p>
        Let's create the files:
      </p><pre class="programlisting">
$ sudo touch /etc/NIXOS
$ sudo touch /etc/NIXOS_LUSTRATE
</pre><p>
        Let's also make sure the NixOS configuration files are kept once
        we reboot on NixOS:
      </p><pre class="programlisting">
$ echo etc/nixos | sudo tee -a /etc/NIXOS_LUSTRATE
</pre></li><li class="listitem"><p>
        Finally, move the <code class="literal">/boot</code> directory of your
        current distribution out of the way (the lustrate process will
        take care of the rest once you reboot, but this one must be
        moved out now because NixOS needs to install its own boot files:
      </p><div class="warning"><h3 class="title">Warning</h3><p>
          Once you complete this step, your current distribution will no
          longer be bootable! If you didn't get all the NixOS
          configuration right, especially those settings pertaining to
          boot loading and root partition, NixOS may not be bootable
          either. Have a USB rescue device ready in case this happens.
        </p></div><pre class="programlisting">
$ sudo mv -v /boot /boot.bak &amp;&amp;
sudo /nix/var/nix/profiles/system/bin/switch-to-configuration boot
</pre><p>
        Cross your fingers, reboot, hopefully you should get a NixOS
        prompt!
      </p></li><li class="listitem"><p>
        If for some reason you want to revert to the old distribution,
        you'll need to boot on a USB rescue disk and do something along
        these lines:
      </p><pre class="programlisting">
# mkdir root
# mount /dev/sdaX root
# mkdir root/nixos-root
# mv -v root/* root/nixos-root/
# mv -v root/nixos-root/old-root/* root/
# mv -v root/boot.bak root/boot  # We had renamed this by hand earlier
# umount root
# reboot
</pre><p>
        This may work as is or you might also need to reinstall the boot
        loader.
      </p><p>
        And of course, if you're happy with NixOS and no longer need the
        old distribution:
      </p><pre class="programlisting">
sudo rm -rf /old-root
</pre></li><li class="listitem"><p>
        It's also worth noting that this whole process can be automated.
        This is especially useful for Cloud VMs, where provider do not
        provide NixOS. For instance,
        <a class="link" href="https://github.com/elitak/nixos-infect" target="_top">nixos-infect</a>
        uses the lustrate process to convert Digital Ocean droplets to
        NixOS from other distributions automatically.
      </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-installing-behind-proxy"></a>2.5.5. Installing behind a proxy</h3></div></div></div><p>
    To install NixOS behind a proxy, do the following before running
    <code class="literal">nixos-install</code>.
  </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
        Update proxy configuration in
        <code class="literal">/mnt/etc/nixos/configuration.nix</code> to keep the
        internet accessible after reboot.
      </p><pre class="programlisting">
networking.proxy.default = "http://user:password@proxy:port/";
networking.proxy.noProxy = "127.0.0.1,localhost,internal.domain";
</pre></li><li class="listitem"><p>
        Setup the proxy environment variables in the shell where you are
        running <code class="literal">nixos-install</code>.
      </p><pre class="programlisting">
# proxy_url="http://user:password@proxy:port/"
# export http_proxy="$proxy_url"
# export HTTP_PROXY="$proxy_url"
# export https_proxy="$proxy_url"
# export HTTPS_PROXY="$proxy_url"
</pre></li></ol></div><div class="note"><h3 class="title">Note</h3><p>
      If you are switching networks with different proxy configurations,
      use the <code class="literal">specialisation</code> option in
      <code class="literal">configuration.nix</code> to switch proxies at runtime.
      Refer to <a class="xref" href="options.html" title="Appendix A. Configuration Options">Appendix A, <em>Configuration Options</em></a> for more information.
    </p></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-changing-config"></a>Chapter 3. Changing the Configuration</h2></div></div></div><p>
    The file <code class="literal">/etc/nixos/configuration.nix</code> contains
    the current configuration of your machine. Whenever you’ve
    <a class="link" href="index.html#ch-configuration" title="Part II. Configuration">changed something</a> in that
    file, you should do
  </p><pre class="programlisting">
# nixos-rebuild switch
</pre><p>
    to build the new configuration, make it the default configuration
    for booting, and try to realise the configuration in the running
    system (e.g., by restarting system services).
  </p><div class="warning"><h3 class="title">Warning</h3><p>
      This command doesn't start/stop
      <a class="link" href="options.html#opt-systemd.user.services">user services</a>
      automatically. <code class="literal">nixos-rebuild</code> only runs a
      <code class="literal">daemon-reload</code> for each user with running user
      services.
    </p></div><div class="warning"><h3 class="title">Warning</h3><p>
      These commands must be executed as root, so you should either run
      them from a root shell or by prefixing them with
      <code class="literal">sudo -i</code>.
    </p></div><p>
    You can also do
  </p><pre class="programlisting">
# nixos-rebuild test
</pre><p>
    to build the configuration and switch the running system to it, but
    without making it the boot default. So if (say) the configuration
    locks up your machine, you can just reboot to get back to a working
    configuration.
  </p><p>
    There is also
  </p><pre class="programlisting">
# nixos-rebuild boot
</pre><p>
    to build the configuration and make it the boot default, but not
    switch to it now (so it will only take effect after the next
    reboot).
  </p><p>
    You can make your configuration show up in a different submenu of
    the GRUB 2 boot screen by giving it a different <span class="emphasis"><em>profile
    name</em></span>, e.g.
  </p><pre class="programlisting">
# nixos-rebuild switch -p test
</pre><p>
    which causes the new configuration (and previous ones created using
    <code class="literal">-p test</code>) to show up in the GRUB submenu
    <span class="quote">“<span class="quote">NixOS - Profile 'test'</span>”</span>. This can be useful to
    separate test configurations from <span class="quote">“<span class="quote">stable</span>”</span>
    configurations.
  </p><p>
    Finally, you can do
  </p><pre class="programlisting">
$ nixos-rebuild build
</pre><p>
    to build the configuration but nothing more. This is useful to see
    whether everything compiles cleanly.
  </p><p>
    If you have a machine that supports hardware virtualisation, you can
    also test the new configuration in a sandbox by building and running
    a QEMU <span class="emphasis"><em>virtual machine</em></span> that contains the
    desired configuration. Just do
  </p><pre class="programlisting">
$ nixos-rebuild build-vm
$ ./result/bin/run-*-vm
</pre><p>
    The VM does not have any data from your host system, so your
    existing user accounts and home directories will not be available
    unless you have set <code class="literal">mutableUsers = false</code>. Another
    way is to temporarily add the following to your configuration:
  </p><pre class="programlisting">
users.users.your-user.initialHashedPassword = "test";
</pre><p>
    <span class="emphasis"><em>Important:</em></span> delete the $hostname.qcow2 file if
    you have started the virtual machine at least once without the right
    users, otherwise the changes will not get picked up. You can forward
    ports on the host to the guest. For instance, the following will
    forward host port 2222 to guest port 22 (SSH):
  </p><pre class="programlisting">
$ QEMU_NET_OPTS="hostfwd=tcp::2222-:22" ./result/bin/run-*-vm
</pre><p>
    allowing you to log in via SSH (assuming you have set the
    appropriate passwords or SSH authorized keys):
  </p><pre class="programlisting">
$ ssh -p 2222 localhost
</pre></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-upgrading"></a>Chapter 4. Upgrading NixOS</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-upgrading-automatic">4.1. Automatic Upgrades</a></span></dt></dl></div><p>
    The best way to keep your NixOS installation up to date is to use
    one of the NixOS <span class="emphasis"><em>channels</em></span>. A channel is a Nix
    mechanism for distributing Nix expressions and associated binaries.
    The NixOS channels are updated automatically from NixOS’s Git
    repository after certain tests have passed and all packages have
    been built. These channels are:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <span class="emphasis"><em>Stable channels</em></span>, such as
        <a class="link" href="https://nixos.org/channels/nixos-21.11" target="_top"><code class="literal">nixos-21.11</code></a>.
        These only get conservative bug fixes and package upgrades. For
        instance, a channel update may cause the Linux kernel on your
        system to be upgraded from 4.19.34 to 4.19.38 (a minor bug fix),
        but not from 4.19.x to 4.20.x (a major change that has the
        potential to break things). Stable channels are generally
        maintained until the next stable branch is created.
      </p></li><li class="listitem"><p>
        The <span class="emphasis"><em>unstable channel</em></span>,
        <a class="link" href="https://nixos.org/channels/nixos-unstable" target="_top"><code class="literal">nixos-unstable</code></a>.
        This corresponds to NixOS’s main development branch, and may
        thus see radical changes between channel updates. It’s not
        recommended for production systems.
      </p></li><li class="listitem"><p>
        <span class="emphasis"><em>Small channels</em></span>, such as
        <a class="link" href="https://nixos.org/channels/nixos-21.11-small" target="_top"><code class="literal">nixos-21.11-small</code></a>
        or
        <a class="link" href="https://nixos.org/channels/nixos-unstable-small" target="_top"><code class="literal">nixos-unstable-small</code></a>.
        These are identical to the stable and unstable channels
        described above, except that they contain fewer binary packages.
        This means they get updated faster than the regular channels
        (for instance, when a critical security patch is committed to
        NixOS’s source tree), but may require more packages to be built
        from source than usual. They’re mostly intended for server
        environments and as such contain few GUI applications.
      </p></li></ul></div><p>
    To see what channels are available, go to
    <a class="link" href="https://nixos.org/channels" target="_top">https://nixos.org/channels</a>.
    (Note that the URIs of the various channels redirect to a directory
    that contains the channel’s latest version and includes ISO images
    and VirtualBox appliances.) Please note that during the release
    process, channels that are not yet released will be present here as
    well. See the Getting NixOS page
    <a class="link" href="https://nixos.org/nixos/download.html" target="_top">https://nixos.org/nixos/download.html</a>
    to find the newest supported stable release.
  </p><p>
    When you first install NixOS, you’re automatically subscribed to the
    NixOS channel that corresponds to your installation source. For
    instance, if you installed from a 21.11 ISO, you will be subscribed
    to the <code class="literal">nixos-21.11</code> channel. To see which NixOS
    channel you’re subscribed to, run the following as root:
  </p><pre class="programlisting">
# nix-channel --list | grep nixos
nixos https://nixos.org/channels/nixos-unstable
</pre><p>
    To switch to a different NixOS channel, do
  </p><pre class="programlisting">
# nix-channel --add https://nixos.org/channels/channel-name nixos
</pre><p>
    (Be sure to include the <code class="literal">nixos</code> parameter at the
    end.) For instance, to use the NixOS 21.11 stable channel:
  </p><pre class="programlisting">
# nix-channel --add https://nixos.org/channels/nixos-21.11 nixos
</pre><p>
    If you have a server, you may want to use the <span class="quote">“<span class="quote">small</span>”</span>
    channel instead:
  </p><pre class="programlisting">
# nix-channel --add https://nixos.org/channels/nixos-21.11-small nixos
</pre><p>
    And if you want to live on the bleeding edge:
  </p><pre class="programlisting">
# nix-channel --add https://nixos.org/channels/nixos-unstable nixos
</pre><p>
    You can then upgrade NixOS to the latest version in your chosen
    channel by running
  </p><pre class="programlisting">
# nixos-rebuild switch --upgrade
</pre><p>
    which is equivalent to the more verbose
    <code class="literal">nix-channel --update nixos; nixos-rebuild switch</code>.
  </p><div class="note"><h3 class="title">Note</h3><p>
      Channels are set per user. This means that running
      <code class="literal">nix-channel --add</code> as a non root user (or
      without sudo) will not affect configuration in
      <code class="literal">/etc/nixos/configuration.nix</code>
    </p></div><div class="warning"><h3 class="title">Warning</h3><p>
      It is generally safe to switch back and forth between channels.
      The only exception is that a newer NixOS may also have a newer Nix
      version, which may involve an upgrade of Nix’s database schema.
      This cannot be undone easily, so in that case you will not be able
      to go back to your original channel.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-upgrading-automatic"></a>4.1. Automatic Upgrades</h2></div></div></div><p>
      You can keep a NixOS system up-to-date automatically by adding the
      following to <code class="literal">configuration.nix</code>:
    </p><pre class="programlisting">
system.autoUpgrade.enable = true;
system.autoUpgrade.allowReboot = true;
</pre><p>
      This enables a periodically executed systemd service named
      <code class="literal">nixos-upgrade.service</code>. If the
      <code class="literal">allowReboot</code> option is <code class="literal">false</code>,
      it runs <code class="literal">nixos-rebuild switch --upgrade</code> to
      upgrade NixOS to the latest version in the current channel. (To
      see when the service runs, see
      <code class="literal">systemctl list-timers</code>.) If
      <code class="literal">allowReboot</code> is <code class="literal">true</code>, then
      the system will automatically reboot if the new generation
      contains a different kernel, initrd or kernel modules. You can
      also specify a channel explicitly, e.g.
    </p><pre class="programlisting">
system.autoUpgrade.channel = https://nixos.org/channels/nixos-21.11;
</pre></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="ch-configuration"></a>Part II. Configuration</h1></div></div></div><div class="partintro"><div></div><p>
   This chapter describes how to configure various aspects of a NixOS machine
   through the configuration file
   <code class="filename">/etc/nixos/configuration.nix</code>. As described in
   <a class="xref" href="index.html#sec-changing-config" title="Chapter 3. Changing the Configuration">Chapter 3, <em>Changing the Configuration</em></a>, changes to this file only take
   effect after you run <span class="command"><strong>nixos-rebuild</strong></span>.
  </p><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="index.html#sec-configuration-syntax">5. Configuration Syntax</a></span></dt><dt><span class="chapter"><a href="index.html#sec-package-management">6. Package Management</a></span></dt><dt><span class="chapter"><a href="index.html#sec-user-management">7. User Management</a></span></dt><dt><span class="chapter"><a href="index.html#ch-file-systems">8. File Systems</a></span></dt><dt><span class="chapter"><a href="index.html#sec-x11">9. X Window System</a></span></dt><dt><span class="chapter"><a href="index.html#sec-wayland">10. Wayland</a></span></dt><dt><span class="chapter"><a href="index.html#sec-gpu-accel">11. GPU acceleration</a></span></dt><dt><span class="chapter"><a href="index.html#sec-xfce">12. Xfce Desktop Environment</a></span></dt><dt><span class="chapter"><a href="index.html#sec-networking">13. Networking</a></span></dt><dt><span class="chapter"><a href="index.html#sec-kernel-config">14. Linux Kernel</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-subversion">15. Subversion</a></span></dt><dt><span class="chapter"><a href="index.html#chap-pantheon">16. Pantheon Desktop</a></span></dt><dt><span class="chapter"><a href="index.html#chap-gnome">17. GNOME Desktop</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-matomo">18. Matomo</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-plausible">19. Plausible</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-pict-rs">20. Pict-rs</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-nextcloud">21. Nextcloud</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-lemmy">22. Lemmy</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-keycloak">23. Keycloak</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-jitsi-meet">24. Jitsi Meet</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-grocy">25. Grocy</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-discourse">26. Discourse</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-meilisearch">27. Meilisearch</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-networking-yggdrasil">28. Yggdrasil</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-prosody">29. Prosody</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-pleroma">30. Pleroma</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-mosquitto">31. Mosquitto</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-litestream">32. Litestream</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-prometheus-exporters">33. Prometheus exporters</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-parsedmarc">34. parsedmarc</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-weechat">35. WeeChat</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-taskserver">36. Taskserver</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-sourcehut">37. Sourcehut</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-gitlab">38. GitLab</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-mjolnir">39. Mjolnir (Matrix Moderation Tool)</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-matrix">40. Matrix</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-mailman">41. Mailman</a></span></dt><dt><span class="chapter"><a href="index.html#trezor">42. Trezor</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-emacs">43. Emacs</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-blackfire">44. Blackfire profiler</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-flatpak">45. Flatpak</a></span></dt><dt><span class="chapter"><a href="index.html#module-postgresql">46. PostgreSQL</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-foundationdb">47. FoundationDB</a></span></dt><dt><span class="chapter"><a href="index.html#module-borgbase">48. BorgBackup</a></span></dt><dt><span class="chapter"><a href="index.html#module-security-acme">49. SSL/TLS Certificates with ACME</a></span></dt><dt><span class="chapter"><a href="index.html#module-programs-zsh-ohmyzsh">50. Oh my ZSH</a></span></dt><dt><span class="chapter"><a href="index.html#module-program-plotinus">51. Plotinus</a></span></dt><dt><span class="chapter"><a href="index.html#module-programs-digitalbitbox">52. Digital Bitbox</a></span></dt><dt><span class="chapter"><a href="index.html#module-services-input-methods">53. Input Methods</a></span></dt><dt><span class="chapter"><a href="index.html#ch-profiles">54. Profiles</a></span></dt><dt><span class="chapter"><a href="index.html#sec-kubernetes">55. Kubernetes</a></span></dt></dl></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-configuration-syntax"></a>Chapter 5. Configuration Syntax</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-configuration-file">5.1. NixOS Configuration File</a></span></dt><dt><span class="section"><a href="index.html#sec-module-abstractions">5.2. Abstractions</a></span></dt><dt><span class="section"><a href="index.html#sec-modularity">5.3. Modularity</a></span></dt><dt><span class="section"><a href="index.html#sec-nix-syntax-summary">5.4. Syntax Summary</a></span></dt></dl></div><p>
    The NixOS configuration file
    <code class="literal">/etc/nixos/configuration.nix</code> is actually a
    <span class="emphasis"><em>Nix expression</em></span>, which is the Nix package
    manager’s purely functional language for describing how to build
    packages and configurations. This means you have all the expressive
    power of that language at your disposal, including the ability to
    abstract over common patterns, which is very useful when managing
    complex systems. The syntax and semantics of the Nix language are
    fully described in the
    <a class="link" href="https://nixos.org/nix/manual/#chap-writing-nix-expressions" target="_top">Nix
    manual</a>, but here we give a short overview of the most
    important constructs useful in NixOS configuration files.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-configuration-file"></a>5.1. NixOS Configuration File</h2></div></div></div><p>
    The NixOS configuration file generally looks like this:
  </p><pre class="programlisting">
{ config, pkgs, ... }:

{ option definitions
}
</pre><p>
    The first line (<code class="literal">{ config, pkgs, ... }:</code>) denotes
    that this is actually a function that takes at least the two
    arguments <code class="literal">config</code> and <code class="literal">pkgs</code>.
    (These are explained later, in chapter
    <a class="xref" href="index.html#sec-writing-modules" title="Chapter 65. Writing NixOS Modules">Chapter 65, <em>Writing NixOS Modules</em></a>) The function returns a
    <span class="emphasis"><em>set</em></span> of option definitions
    (<code class="literal">{ ... }</code>). These definitions have the form
    <code class="literal">name = value</code>, where <code class="literal">name</code> is
    the name of an option and <code class="literal">value</code> is its value. For
    example,
  </p><pre class="programlisting">
{ config, pkgs, ... }:

{ services.httpd.enable = true;
  services.httpd.adminAddr = "alice@example.org";
  services.httpd.virtualHosts.localhost.documentRoot = "/webroot";
}
</pre><p>
    defines a configuration with three option definitions that together
    enable the Apache HTTP Server with <code class="literal">/webroot</code> as
    the document root.
  </p><p>
    Sets can be nested, and in fact dots in option names are shorthand
    for defining a set containing another set. For instance,
    <a class="xref" href="options.html#opt-services.httpd.enable"><code class="option">services.httpd.enable</code></a> defines a set named
    <code class="literal">services</code> that contains a set named
    <code class="literal">httpd</code>, which in turn contains an option
    definition named <code class="literal">enable</code> with value
    <code class="literal">true</code>. This means that the example above can also
    be written as:
  </p><pre class="programlisting">
{ config, pkgs, ... }:

{ services = {
    httpd = {
      enable = true;
      adminAddr = "alice@example.org";
      virtualHosts = {
        localhost = {
          documentRoot = "/webroot";
        };
      };
    };
  };
}
</pre><p>
    which may be more convenient if you have lots of option definitions
    that share the same prefix (such as
    <code class="literal">services.httpd</code>).
  </p><p>
    NixOS checks your option definitions for correctness. For instance,
    if you try to define an option that doesn’t exist (that is, doesn’t
    have a corresponding <span class="emphasis"><em>option declaration</em></span>),
    <code class="literal">nixos-rebuild</code> will give an error like:
  </p><pre class="programlisting">
The option `services.httpd.enable' defined in `/etc/nixos/configuration.nix' does not exist.
</pre><p>
    Likewise, values in option definitions must have a correct type. For
    instance, <code class="literal">services.httpd.enable</code> must be a Boolean
    (<code class="literal">true</code> or <code class="literal">false</code>). Trying to
    give it a value of another type, such as a string, will cause an
    error:
  </p><pre class="programlisting">
The option value `services.httpd.enable' in `/etc/nixos/configuration.nix' is not a boolean.
</pre><p>
    Options have various types of values. The most important are:
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        Strings
      </span></dt><dd><p>
          Strings are enclosed in double quotes, e.g.
        </p><pre class="programlisting">
networking.hostName = "dexter";
</pre><p>
          Special characters can be escaped by prefixing them with a
          backslash (e.g. <code class="literal">\"</code>).
        </p><p>
          Multi-line strings can be enclosed in <span class="emphasis"><em>double single
          quotes</em></span>, e.g.
        </p><pre class="programlisting">
networking.extraHosts =
  ''
    127.0.0.2 other-localhost
    10.0.0.1 server
  '';
</pre><p>
          The main difference is that it strips from each line a number
          of spaces equal to the minimal indentation of the string as a
          whole (disregarding the indentation of empty lines), and that
          characters like <code class="literal">"</code> and
          <code class="literal">\</code> are not special (making it more
          convenient for including things like shell code). See more
          info about this in the Nix manual
          <a class="link" href="https://nixos.org/nix/manual/#ssec-values" target="_top">here</a>.
        </p></dd><dt><span class="term">
        Booleans
      </span></dt><dd><p>
          These can be <code class="literal">true</code> or
          <code class="literal">false</code>, e.g.
        </p><pre class="programlisting">
networking.firewall.enable = true;
networking.firewall.allowPing = false;
</pre></dd><dt><span class="term">
        Integers
      </span></dt><dd><p>
          For example,
        </p><pre class="programlisting">
boot.kernel.sysctl."net.ipv4.tcp_keepalive_time" = 60;
</pre><p>
          (Note that here the attribute name
          <code class="literal">net.ipv4.tcp_keepalive_time</code> is enclosed in
          quotes to prevent it from being interpreted as a set named
          <code class="literal">net</code> containing a set named
          <code class="literal">ipv4</code>, and so on. This is because it’s not a
          NixOS option but the literal name of a Linux kernel setting.)
        </p></dd><dt><span class="term">
        Sets
      </span></dt><dd><p>
          Sets were introduced above. They are name/value pairs enclosed
          in braces, as in the option definition
        </p><pre class="programlisting">
fileSystems."/boot" =
  { device = "/dev/sda1";
    fsType = "ext4";
    options = [ "rw" "data=ordered" "relatime" ];
  };
</pre></dd><dt><span class="term">
        Lists
      </span></dt><dd><p>
          The important thing to note about lists is that list elements
          are separated by whitespace, like this:
        </p><pre class="programlisting">
boot.kernelModules = [ "fuse" "kvm-intel" "coretemp" ];
</pre><p>
          List elements can be any other type, e.g. sets:
        </p><pre class="programlisting">
swapDevices = [ { device = "/dev/disk/by-label/swap"; } ];
</pre></dd><dt><span class="term">
        Packages
      </span></dt><dd><p>
          Usually, the packages you need are already part of the Nix
          Packages collection, which is a set that can be accessed
          through the function argument <code class="literal">pkgs</code>. Typical
          uses:
        </p><pre class="programlisting">
environment.systemPackages =
  [ pkgs.thunderbird
    pkgs.emacs
  ];

services.postgresql.package = pkgs.postgresql_10;
</pre><p>
          The latter option definition changes the default PostgreSQL
          package used by NixOS’s PostgreSQL service to 10.x. For more
          information on packages, including how to add new ones, see
          <a class="xref" href="index.html#sec-custom-packages" title="6.1.2. Adding Custom Packages">Section 6.1.2, “Adding Custom Packages”</a>.
        </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-module-abstractions"></a>5.2. Abstractions</h2></div></div></div><p>
    If you find yourself repeating yourself over and over, it’s time to
    abstract. Take, for instance, this Apache HTTP Server configuration:
  </p><pre class="programlisting">
{
  services.httpd.virtualHosts =
    { "blog.example.org" = {
        documentRoot = "/webroot/blog.example.org";
        adminAddr = "alice@example.org";
        forceSSL = true;
        enableACME = true;
        enablePHP = true;
      };
      "wiki.example.org" = {
        documentRoot = "/webroot/wiki.example.org";
        adminAddr = "alice@example.org";
        forceSSL = true;
        enableACME = true;
        enablePHP = true;
      };
    };
}
</pre><p>
    It defines two virtual hosts with nearly identical configuration;
    the only difference is the document root directories. To prevent
    this duplication, we can use a <code class="literal">let</code>:
  </p><pre class="programlisting">
let
  commonConfig =
    { adminAddr = "alice@example.org";
      forceSSL = true;
      enableACME = true;
    };
in
{
  services.httpd.virtualHosts =
    { "blog.example.org" = (commonConfig // { documentRoot = "/webroot/blog.example.org"; });
      "wiki.example.org" = (commonConfig // { documentRoot = "/webroot/wiki.example.com"; });
    };
}
</pre><p>
    The <code class="literal">let commonConfig = ...</code> defines a variable
    named <code class="literal">commonConfig</code>. The <code class="literal">//</code>
    operator merges two attribute sets, so the configuration of the
    second virtual host is the set <code class="literal">commonConfig</code>
    extended with the document root option.
  </p><p>
    You can write a <code class="literal">let</code> wherever an expression is
    allowed. Thus, you also could have written:
  </p><pre class="programlisting">
{
  services.httpd.virtualHosts =
    let commonConfig = ...; in
    { "blog.example.org" = (commonConfig // { ... })
      "wiki.example.org" = (commonConfig // { ... })
    };
}
</pre><p>
    but not <code class="literal">{ let commonConfig = ...; in ...; }</code> since
    attributes (as opposed to attribute values) are not expressions.
  </p><p>
    <span class="strong"><strong>Functions</strong></span> provide another method
    of abstraction. For instance, suppose that we want to generate lots
    of different virtual hosts, all with identical configuration except
    for the document root. This can be done as follows:
  </p><pre class="programlisting">
{
  services.httpd.virtualHosts =
    let
      makeVirtualHost = webroot:
        { documentRoot = webroot;
          adminAddr = "alice@example.org";
          forceSSL = true;
          enableACME = true;
        };
    in
      { "example.org" = (makeVirtualHost "/webroot/example.org");
        "example.com" = (makeVirtualHost "/webroot/example.com");
        "example.gov" = (makeVirtualHost "/webroot/example.gov");
        "example.nl" = (makeVirtualHost "/webroot/example.nl");
      };
}
</pre><p>
    Here, <code class="literal">makeVirtualHost</code> is a function that takes a
    single argument <code class="literal">webroot</code> and returns the
    configuration for a virtual host. That function is then called for
    several names to produce the list of virtual host configurations.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-modularity"></a>5.3. Modularity</h2></div></div></div><p>
    The NixOS configuration mechanism is modular. If your
    <code class="literal">configuration.nix</code> becomes too big, you can split
    it into multiple files. Likewise, if you have multiple NixOS
    configurations (e.g. for different computers) with some commonality,
    you can move the common configuration into a shared file.
  </p><p>
    Modules have exactly the same syntax as
    <code class="literal">configuration.nix</code>. In fact,
    <code class="literal">configuration.nix</code> is itself a module. You can use
    other modules by including them from
    <code class="literal">configuration.nix</code>, e.g.:
  </p><pre class="programlisting">
{ config, pkgs, ... }:

{ imports = [ ./vpn.nix ./kde.nix ];
  services.httpd.enable = true;
  environment.systemPackages = [ pkgs.emacs ];
  ...
}
</pre><p>
    Here, we include two modules from the same directory,
    <code class="literal">vpn.nix</code> and <code class="literal">kde.nix</code>. The
    latter might look like this:
  </p><pre class="programlisting">
{ config, pkgs, ... }:

{ services.xserver.enable = true;
  services.xserver.displayManager.sddm.enable = true;
  services.xserver.desktopManager.plasma5.enable = true;
  environment.systemPackages = [ pkgs.vim ];
}
</pre><p>
    Note that both <code class="literal">configuration.nix</code> and
    <code class="literal">kde.nix</code> define the option
    <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>. When multiple
    modules define an option, NixOS will try to
    <span class="emphasis"><em>merge</em></span> the definitions. In the case of
    <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>, that’s easy: the
    lists of packages can simply be concatenated. The value in
    <code class="literal">configuration.nix</code> is merged last, so for
    list-type options, it will appear at the end of the merged list. If
    you want it to appear first, you can use
    <code class="literal">mkBefore</code>:
  </p><pre class="programlisting">
boot.kernelModules = mkBefore [ "kvm-intel" ];
</pre><p>
    This causes the <code class="literal">kvm-intel</code> kernel module to be
    loaded before any other kernel modules.
  </p><p>
    For other types of options, a merge may not be possible. For
    instance, if two modules define
    <a class="xref" href="options.html#opt-services.httpd.adminAddr"><code class="option">services.httpd.adminAddr</code></a>,
    <code class="literal">nixos-rebuild</code> will give an error:
  </p><pre class="programlisting">
The unique option `services.httpd.adminAddr' is defined multiple times, in `/etc/nixos/httpd.nix' and `/etc/nixos/configuration.nix'.
</pre><p>
    When that happens, it’s possible to force one definition take
    precedence over the others:
  </p><pre class="programlisting">
services.httpd.adminAddr = pkgs.lib.mkForce "bob@example.org";
</pre><p>
    When using multiple modules, you may need to access configuration
    values defined in other modules. This is what the
    <code class="literal">config</code> function argument is for: it contains the
    complete, merged system configuration. That is,
    <code class="literal">config</code> is the result of combining the
    configurations returned by every module <a href="#ftn.id-1.4.3.5.14.3" class="footnote" id="id-1.4.3.5.14.3"><sup class="footnote">[1]</sup></a> . For example, here is a module that adds some packages
    to <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> only if
    <a class="xref" href="options.html#opt-services.xserver.enable"><code class="option">services.xserver.enable</code></a> is set to
    <code class="literal">true</code> somewhere else:
  </p><pre class="programlisting">
{ config, pkgs, ... }:

{ environment.systemPackages =
    if config.services.xserver.enable then
      [ pkgs.firefox
        pkgs.thunderbird
      ]
    else
      [ ];
}
</pre><p>
    With multiple modules, it may not be obvious what the final value of
    a configuration option is. The command
    <code class="literal">nixos-option</code> allows you to find out:
  </p><pre class="programlisting">
$ nixos-option services.xserver.enable
true

$ nixos-option boot.kernelModules
[ "tun" "ipv6" "loop" ... ]
</pre><p>
    Interactive exploration of the configuration is possible using
    <code class="literal">nix repl</code>, a read-eval-print loop for Nix
    expressions. A typical use:
  </p><pre class="programlisting">
$ nix repl '&lt;nixpkgs/nixos&gt;'

nix-repl&gt; config.networking.hostName
"mandark"

nix-repl&gt; map (x: x.hostName) config.services.httpd.virtualHosts
[ "example.org" "example.gov" ]
</pre><p>
    While abstracting your configuration, you may find it useful to
    generate modules using code, instead of writing files. The example
    below would have the same effect as importing a file which sets
    those options.
  </p><pre class="programlisting">
{ config, pkgs, ... }:

let netConfig = hostName: {
  networking.hostName = hostName;
  networking.useDHCP = false;
};

in

{ imports = [ (netConfig "nixos.localdomain") ]; }
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-nix-syntax-summary"></a>5.4. Syntax Summary</h2></div></div></div><p>
    Below is a summary of the most important syntactic constructs in the
    Nix expression language. It’s not complete. In particular, there are
    many other built-in functions. See the
    <a class="link" href="https://nixos.org/nix/manual/#chap-writing-nix-expressions" target="_top">Nix
    manual</a> for the rest.
  </p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">
            Example
          </th><th align="left">
            Description
          </th></tr></thead><tbody><tr><td align="left">
            <span class="emphasis"><em>Basic values</em></span>
          </td><td align="left">
          </td></tr><tr><td align="left">
            <code class="literal">"Hello world"</code>
          </td><td align="left">
            A string
          </td></tr><tr><td align="left">
            <code class="literal">"${pkgs.bash}/bin/sh"</code>
          </td><td align="left">
            A string containing an expression (expands to
            <code class="literal">"/nix/store/hash-bash-version/bin/sh"</code>)
          </td></tr><tr><td align="left">
            <code class="literal">true</code>, <code class="literal">false</code>
          </td><td align="left">
            Booleans
          </td></tr><tr><td align="left">
            <code class="literal">123</code>
          </td><td align="left">
            An integer
          </td></tr><tr><td align="left">
            <code class="literal">./foo.png</code>
          </td><td align="left">
            A path (relative to the containing Nix expression)
          </td></tr><tr><td align="left">
            <span class="emphasis"><em>Compound values</em></span>
          </td><td align="left">
          </td></tr><tr><td align="left">
            <code class="literal">{ x = 1; y = 2; }</code>
          </td><td align="left">
            A set with attributes named <code class="literal">x</code> and
            <code class="literal">y</code>
          </td></tr><tr><td align="left">
            <code class="literal">{ foo.bar = 1; }</code>
          </td><td align="left">
            A nested set, equivalent to
            <code class="literal">{ foo = { bar = 1; }; }</code>
          </td></tr><tr><td align="left">
            <code class="literal">rec { x = "foo"; y = x + "bar"; }</code>
          </td><td align="left">
            A recursive set, equivalent to
            <code class="literal">{ x = "foo"; y = "foobar"; }</code>
          </td></tr><tr><td align="left">
            <code class="literal">[ "foo" "bar" ]</code>
          </td><td align="left">
            A list with two elements
          </td></tr><tr><td align="left">
            <span class="emphasis"><em>Operators</em></span>
          </td><td align="left">
          </td></tr><tr><td align="left">
            <code class="literal">"foo" + "bar"</code>
          </td><td align="left">
            String concatenation
          </td></tr><tr><td align="left">
            <code class="literal">1 + 2</code>
          </td><td align="left">
            Integer addition
          </td></tr><tr><td align="left">
            <code class="literal">"foo" == "f" + "oo"</code>
          </td><td align="left">
            Equality test (evaluates to <code class="literal">true</code>)
          </td></tr><tr><td align="left">
            <code class="literal">"foo" != "bar"</code>
          </td><td align="left">
            Inequality test (evaluates to <code class="literal">true</code>)
          </td></tr><tr><td align="left">
            <code class="literal">!true</code>
          </td><td align="left">
            Boolean negation
          </td></tr><tr><td align="left">
            <code class="literal">{ x = 1; y = 2; }.x</code>
          </td><td align="left">
            Attribute selection (evaluates to <code class="literal">1</code>)
          </td></tr><tr><td align="left">
            <code class="literal">{ x = 1; y = 2; }.z or 3</code>
          </td><td align="left">
            Attribute selection with default (evaluates to
            <code class="literal">3</code>)
          </td></tr><tr><td align="left">
            <code class="literal">{ x = 1; y = 2; } // { z = 3; }</code>
          </td><td align="left">
            Merge two sets (attributes in the right-hand set taking
            precedence)
          </td></tr><tr><td align="left">
            <span class="emphasis"><em>Control structures</em></span>
          </td><td align="left">
          </td></tr><tr><td align="left">
            <code class="literal">if 1 + 1 == 2 then "yes!" else "no!"</code>
          </td><td align="left">
            Conditional expression
          </td></tr><tr><td align="left">
            <code class="literal">assert 1 + 1 == 2; "yes!"</code>
          </td><td align="left">
            Assertion check (evaluates to
            <code class="literal">"yes!"</code>). See
            <a class="xref" href="index.html#sec-assertions" title="65.4. Warnings and Assertions">Section 65.4, “Warnings and Assertions”</a> for using assertions in
            modules
          </td></tr><tr><td align="left">
            <code class="literal">let x = "foo"; y = "bar"; in x + y</code>
          </td><td align="left">
            Variable definition
          </td></tr><tr><td align="left">
            <code class="literal">with pkgs.lib; head [ 1 2 3 ]</code>
          </td><td align="left">
            Add all attributes from the given set to the scope
            (evaluates to <code class="literal">1</code>)
          </td></tr><tr><td align="left">
            <span class="emphasis"><em>Functions (lambdas)</em></span>
          </td><td align="left">
          </td></tr><tr><td align="left">
            <code class="literal">x: x + 1</code>
          </td><td align="left">
            A function that expects an integer and returns it increased
            by 1
          </td></tr><tr><td align="left">
            <code class="literal">(x: x + 1) 100</code>
          </td><td align="left">
            A function call (evaluates to 101)
          </td></tr><tr><td align="left">
            <code class="literal">let inc = x: x + 1; in inc (inc (inc 100))</code>
          </td><td align="left">
            A function bound to a variable and subsequently called by
            name (evaluates to 103)
          </td></tr><tr><td align="left">
            <code class="literal">{ x, y }: x + y</code>
          </td><td align="left">
            A function that expects a set with required attributes
            <code class="literal">x</code> and <code class="literal">y</code> and
            concatenates them
          </td></tr><tr><td align="left">
            <code class="literal">{ x, y ? "bar" }: x + y</code>
          </td><td align="left">
            A function that expects a set with required attribute
            <code class="literal">x</code> and optional <code class="literal">y</code>,
            using <code class="literal">"bar"</code> as default value
            for <code class="literal">y</code>
          </td></tr><tr><td align="left">
            <code class="literal">{ x, y, ... }: x + y</code>
          </td><td align="left">
            A function that expects a set with required attributes
            <code class="literal">x</code> and <code class="literal">y</code> and ignores
            any other attributes
          </td></tr><tr><td align="left">
            <code class="literal">{ x, y } @ args: x + y</code>
          </td><td align="left">
            A function that expects a set with required attributes
            <code class="literal">x</code> and <code class="literal">y</code>, and binds the
            whole set to <code class="literal">args</code>
          </td></tr><tr><td align="left">
            <span class="emphasis"><em>Built-in functions</em></span>
          </td><td align="left">
          </td></tr><tr><td align="left">
            <code class="literal">import ./foo.nix</code>
          </td><td align="left">
            Load and return Nix expression in given file
          </td></tr><tr><td align="left">
            <code class="literal">map (x: x + x) [ 1 2 3 ]</code>
          </td><td align="left">
            Apply a function to every element of a list (evaluates to
            <code class="literal">[ 2 4 6 ]</code>)
          </td></tr></tbody></table></div></div><div class="footnotes"><br /><hr style="width:100; text-align:left;margin-left: 0" /><div id="ftn.id-1.4.3.5.14.3" class="footnote"><p><a href="#id-1.4.3.5.14.3" class="para"><sup class="para">[1] </sup></a>
        If you’re wondering how it’s possible that the (indirect)
        <span class="emphasis"><em>result</em></span> of a function is passed as an
        <span class="emphasis"><em>input</em></span> to that same function: that’s because
        Nix is a <span class="quote">“<span class="quote">lazy</span>”</span> language — it only computes values
        when they are needed. This works as long as no individual
        configuration value depends on itself.
      </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-package-management"></a>Chapter 6. Package Management</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-declarative-package-mgmt">6.1. Declarative Package Management</a></span></dt><dt><span class="section"><a href="index.html#sec-ad-hoc-packages">6.2. Ad-Hoc Package Management</a></span></dt></dl></div><p>
    This section describes how to add additional packages to your
    system. NixOS has two distinct styles of package management:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <span class="emphasis"><em>Declarative</em></span>, where you declare what
        packages you want in your <code class="literal">configuration.nix</code>.
        Every time you run <code class="literal">nixos-rebuild</code>, NixOS will
        ensure that you get a consistent set of binaries corresponding
        to your specification.
      </p></li><li class="listitem"><p>
        <span class="emphasis"><em>Ad hoc</em></span>, where you install, upgrade and
        uninstall packages via the <code class="literal">nix-env</code> command.
        This style allows mixing packages from different Nixpkgs
        versions. It’s the only choice for non-root users.
      </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-declarative-package-mgmt"></a>6.1. Declarative Package Management</h2></div></div></div><p>
    With declarative package management, you specify which packages you
    want on your system by setting the option
    <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>. For instance,
    adding the following line to <code class="literal">configuration.nix</code>
    enables the Mozilla Thunderbird email application:
  </p><pre class="programlisting">
environment.systemPackages = [ pkgs.thunderbird ];
</pre><p>
    The effect of this specification is that the Thunderbird package
    from Nixpkgs will be built or downloaded as part of the system when
    you run <code class="literal">nixos-rebuild switch</code>.
  </p><div class="note"><h3 class="title">Note</h3><p>
      Some packages require additional global configuration such as
      D-Bus or systemd service registration so adding them to
      <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> might not be
      sufficient. You are advised to check the
      <a class="link" href="options.html" title="Appendix A. Configuration Options">list of options</a> whether a NixOS
      module for the package does not exist.
    </p></div><p>
    You can get a list of the available packages as follows:
  </p><pre class="programlisting">
$ nix-env -qaP '*' --description
nixos.firefox   firefox-23.0   Mozilla Firefox - the browser, reloaded
...
</pre><p>
    The first column in the output is the <span class="emphasis"><em>attribute
    name</em></span>, such as <code class="literal">nixos.thunderbird</code>.
  </p><p>
    Note: the <code class="literal">nixos</code> prefix tells us that we want to
    get the package from the <code class="literal">nixos</code> channel and works
    only in CLI tools. In declarative configuration use
    <code class="literal">pkgs</code> prefix (variable).
  </p><p>
    To <span class="quote">“<span class="quote">uninstall</span>”</span> a package, simply remove it from
    <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> and run
    <code class="literal">nixos-rebuild switch</code>.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-customising-packages"></a>6.1.1. Customising Packages</h3></div></div></div><p>
    Some packages in Nixpkgs have options to enable or disable optional
    functionality or change other aspects of the package. For instance,
    the Firefox wrapper package (which provides Firefox with a set of
    plugins such as the Adobe Flash player) has an option to enable the
    Google Talk plugin. It can be set in
    <code class="literal">configuration.nix</code> as follows:
    <code class="literal">nixpkgs.config.firefox.enableGoogleTalkPlugin = true;</code>
  </p><div class="warning"><h3 class="title">Warning</h3><p>
      Unfortunately, Nixpkgs currently lacks a way to query available
      configuration options.
    </p></div><p>
    Apart from high-level options, it’s possible to tweak a package in
    almost arbitrary ways, such as changing or disabling dependencies of
    a package. For instance, the Emacs package in Nixpkgs by default has
    a dependency on GTK 2. If you want to build it against GTK 3, you
    can specify that as follows:
  </p><pre class="programlisting">
environment.systemPackages = [ (pkgs.emacs.override { gtk = pkgs.gtk3; }) ];
</pre><p>
    The function <code class="literal">override</code> performs the call to the
    Nix function that produces Emacs, with the original arguments
    amended by the set of arguments specified by you. So here the
    function argument <code class="literal">gtk</code> gets the value
    <code class="literal">pkgs.gtk3</code>, causing Emacs to depend on GTK 3. (The
    parentheses are necessary because in Nix, function application binds
    more weakly than list construction, so without them,
    <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> would be a list
    with two elements.)
  </p><p>
    Even greater customisation is possible using the function
    <code class="literal">overrideAttrs</code>. While the
    <code class="literal">override</code> mechanism above overrides the arguments
    of a package function, <code class="literal">overrideAttrs</code> allows
    changing the <span class="emphasis"><em>attributes</em></span> passed to
    <code class="literal">mkDerivation</code>. This permits changing any aspect of
    the package, such as the source code. For instance, if you want to
    override the source code of Emacs, you can say:
  </p><pre class="programlisting">
environment.systemPackages = [
  (pkgs.emacs.overrideAttrs (oldAttrs: {
    name = "emacs-25.0-pre";
    src = /path/to/my/emacs/tree;
  }))
];
</pre><p>
    Here, <code class="literal">overrideAttrs</code> takes the Nix derivation
    specified by <code class="literal">pkgs.emacs</code> and produces a new
    derivation in which the original’s <code class="literal">name</code> and
    <code class="literal">src</code> attribute have been replaced by the given
    values by re-calling <code class="literal">stdenv.mkDerivation</code>. The
    original attributes are accessible via the function argument, which
    is conventionally named <code class="literal">oldAttrs</code>.
  </p><p>
    The overrides shown above are not global. They do not affect the
    original package; other packages in Nixpkgs continue to depend on
    the original rather than the customised package. This means that if
    another package in your system depends on the original package, you
    end up with two instances of the package. If you want to have
    everything depend on your customised instance, you can apply a
    <span class="emphasis"><em>global</em></span> override as follows:
  </p><pre class="programlisting">
nixpkgs.config.packageOverrides = pkgs:
  { emacs = pkgs.emacs.override { gtk = pkgs.gtk3; };
  };
</pre><p>
    The effect of this definition is essentially equivalent to modifying
    the <code class="literal">emacs</code> attribute in the Nixpkgs source tree.
    Any package in Nixpkgs that depends on <code class="literal">emacs</code> will
    be passed your customised instance. (However, the value
    <code class="literal">pkgs.emacs</code> in
    <code class="literal">nixpkgs.config.packageOverrides</code> refers to the
    original rather than overridden instance, to prevent an infinite
    recursion.)
  </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-custom-packages"></a>6.1.2. Adding Custom Packages</h3></div></div></div><p>
    It’s possible that a package you need is not available in NixOS. In
    that case, you can do two things. First, you can clone the Nixpkgs
    repository, add the package to your clone, and (optionally) submit a
    patch or pull request to have it accepted into the main Nixpkgs
    repository. This is described in detail in the
    <a class="link" href="https://nixos.org/nixpkgs/manual" target="_top">Nixpkgs
    manual</a>. In short, you clone Nixpkgs:
  </p><pre class="programlisting">
$ git clone https://github.com/NixOS/nixpkgs
$ cd nixpkgs
</pre><p>
    Then you write and test the package as described in the Nixpkgs
    manual. Finally, you add it to
    <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>, e.g.
  </p><pre class="programlisting">
environment.systemPackages = [ pkgs.my-package ];
</pre><p>
    and you run <code class="literal">nixos-rebuild</code>, specifying your own
    Nixpkgs tree:
  </p><pre class="programlisting">
# nixos-rebuild switch -I nixpkgs=/path/to/my/nixpkgs
</pre><p>
    The second possibility is to add the package outside of the Nixpkgs
    tree. For instance, here is how you specify a build of the
    <a class="link" href="https://www.gnu.org/software/hello/" target="_top">GNU
    Hello</a> package directly in
    <code class="literal">configuration.nix</code>:
  </p><pre class="programlisting">
environment.systemPackages =
  let
    my-hello = with pkgs; stdenv.mkDerivation rec {
      name = "hello-2.8";
      src = fetchurl {
        url = "mirror://gnu/hello/${name}.tar.gz";
        sha256 = "0wqd8sjmxfskrflaxywc7gqw7sfawrfvdxd9skxawzfgyy0pzdz6";
      };
    };
  in
  [ my-hello ];
</pre><p>
    Of course, you can also move the definition of
    <code class="literal">my-hello</code> into a separate Nix expression, e.g.
  </p><pre class="programlisting">
environment.systemPackages = [ (import ./my-hello.nix) ];
</pre><p>
    where <code class="literal">my-hello.nix</code> contains:
  </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {}; # bring all of Nixpkgs into scope

stdenv.mkDerivation rec {
  name = "hello-2.8";
  src = fetchurl {
    url = "mirror://gnu/hello/${name}.tar.gz";
    sha256 = "0wqd8sjmxfskrflaxywc7gqw7sfawrfvdxd9skxawzfgyy0pzdz6";
  };
}
</pre><p>
    This allows testing the package easily:
  </p><pre class="programlisting">
$ nix-build my-hello.nix
$ ./result/bin/hello
Hello, world!
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-ad-hoc-packages"></a>6.2. Ad-Hoc Package Management</h2></div></div></div><p>
    With the command <code class="literal">nix-env</code>, you can install and
    uninstall packages from the command line. For instance, to install
    Mozilla Thunderbird:
  </p><pre class="programlisting">
$ nix-env -iA nixos.thunderbird
</pre><p>
    If you invoke this as root, the package is installed in the Nix
    profile <code class="literal">/nix/var/nix/profiles/default</code> and visible
    to all users of the system; otherwise, the package ends up in
    <code class="literal">/nix/var/nix/profiles/per-user/username/profile</code>
    and is not visible to other users. The <code class="literal">-A</code> flag
    specifies the package by its attribute name; without it, the package
    is installed by matching against its package name (e.g.
    <code class="literal">thunderbird</code>). The latter is slower because it
    requires matching against all available Nix packages, and is
    ambiguous if there are multiple matching packages.
  </p><p>
    Packages come from the NixOS channel. You typically upgrade a
    package by updating to the latest version of the NixOS channel:
  </p><pre class="programlisting">
$ nix-channel --update nixos
</pre><p>
    and then running <code class="literal">nix-env -i</code> again. Other packages
    in the profile are <span class="emphasis"><em>not</em></span> affected; this is the
    crucial difference with the declarative style of package management,
    where running <code class="literal">nixos-rebuild switch</code> causes all
    packages to be updated to their current versions in the NixOS
    channel. You can however upgrade all packages for which there is a
    newer version by doing:
  </p><pre class="programlisting">
$ nix-env -u '*'
</pre><p>
    A package can be uninstalled using the <code class="literal">-e</code> flag:
  </p><pre class="programlisting">
$ nix-env -e thunderbird
</pre><p>
    Finally, you can roll back an undesirable <code class="literal">nix-env</code>
    action:
  </p><pre class="programlisting">
$ nix-env --rollback
</pre><p>
    <code class="literal">nix-env</code> has many more flags. For details, see the
    nix-env(1) manpage or the Nix manual.
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-user-management"></a>Chapter 7. User Management</h2></div></div></div><p>
    NixOS supports both declarative and imperative styles of user
    management. In the declarative style, users are specified in
    <code class="literal">configuration.nix</code>. For instance, the following
    states that a user account named <code class="literal">alice</code> shall
    exist:
  </p><pre class="programlisting">
users.users.alice = {
  isNormalUser = true;
  home = "/home/alice";
  description = "Alice Foobar";
  extraGroups = [ "wheel" "networkmanager" ];
  openssh.authorizedKeys.keys = [ "ssh-dss AAAAB3Nza... alice@foobar" ];
};
</pre><p>
    Note that <code class="literal">alice</code> is a member of the
    <code class="literal">wheel</code> and <code class="literal">networkmanager</code>
    groups, which allows her to use <code class="literal">sudo</code> to execute
    commands as <code class="literal">root</code> and to configure the network,
    respectively. Also note the SSH public key that allows remote logins
    with the corresponding private key. Users created in this way do not
    have a password by default, so they cannot log in via mechanisms
    that require a password. However, you can use the
    <code class="literal">passwd</code> program to set a password, which is
    retained across invocations of <code class="literal">nixos-rebuild</code>.
  </p><p>
    If you set <a class="xref" href="options.html#opt-users.mutableUsers"><code class="option">users.mutableUsers</code></a> to false, then
    the contents of <code class="literal">/etc/passwd</code> and
    <code class="literal">/etc/group</code> will be congruent to your NixOS
    configuration. For instance, if you remove a user from
    <a class="xref" href="options.html#opt-users.users"><code class="option">users.users</code></a> and run nixos-rebuild, the user
    account will cease to exist. Also, imperative commands for managing
    users and groups, such as useradd, are no longer available.
    Passwords may still be assigned by setting the user's
    <a class="link" href="options.html#opt-users.users._name_.hashedPassword">hashedPassword</a>
    option. A hashed password can be generated using
    <code class="literal">mkpasswd -m sha-512</code>.
  </p><p>
    A user ID (uid) is assigned automatically. You can also specify a
    uid manually by adding
  </p><pre class="programlisting">
uid = 1000;
</pre><p>
    to the user specification.
  </p><p>
    Groups can be specified similarly. The following states that a group
    named <code class="literal">students</code> shall exist:
  </p><pre class="programlisting">
users.groups.students.gid = 1000;
</pre><p>
    As with users, the group ID (gid) is optional and will be assigned
    automatically if it’s missing.
  </p><p>
    In the imperative style, users and groups are managed by commands
    such as <code class="literal">useradd</code>, <code class="literal">groupmod</code> and
    so on. For instance, to create a user account named
    <code class="literal">alice</code>:
  </p><pre class="programlisting">
# useradd -m alice
</pre><p>
    To make all nix tools available to this new user use `su - USER`
    which opens a login shell (==shell that loads the profile) for given
    user. This will create the ~/.nix-defexpr symlink. So run:
  </p><pre class="programlisting">
# su - alice -c "true"
</pre><p>
    The flag <code class="literal">-m</code> causes the creation of a home
    directory for the new user, which is generally what you want. The
    user does not have an initial password and therefore cannot log in.
    A password can be set using the <code class="literal">passwd</code> utility:
  </p><pre class="programlisting">
# passwd alice
Enter new UNIX password: ***
Retype new UNIX password: ***
</pre><p>
    A user can be deleted using <code class="literal">userdel</code>:
  </p><pre class="programlisting">
# userdel -r alice
</pre><p>
    The flag <code class="literal">-r</code> deletes the user’s home directory.
    Accounts can be modified using <code class="literal">usermod</code>. Unix
    groups can be managed using <code class="literal">groupadd</code>,
    <code class="literal">groupmod</code> and <code class="literal">groupdel</code>.
  </p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="ch-file-systems"></a>Chapter 8. File Systems</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-luks-file-systems">8.1. LUKS-Encrypted File Systems</a></span></dt><dt><span class="section"><a href="index.html#sec-sshfs-file-systems">8.2. SSHFS File Systems</a></span></dt></dl></div><p>
    You can define file systems using the <code class="literal">fileSystems</code>
    configuration option. For instance, the following definition causes
    NixOS to mount the Ext4 file system on device
    <code class="literal">/dev/disk/by-label/data</code> onto the mount point
    <code class="literal">/data</code>:
  </p><pre class="programlisting">
fileSystems."/data" =
  { device = "/dev/disk/by-label/data";
    fsType = "ext4";
  };
</pre><p>
    This will create an entry in <code class="literal">/etc/fstab</code>, which
    will generate a corresponding
    <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd.mount.html" target="_top">systemd.mount</a>
    unit via
    <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-fstab-generator.html" target="_top">systemd-fstab-generator</a>.
    The filesystem will be mounted automatically unless
    <code class="literal">"noauto"</code> is present in
    <a class="link" href="options.html#opt-fileSystems._name_.options">options</a>.
    <code class="literal">"noauto"</code> filesystems can be mounted
    explicitly using <code class="literal">systemctl</code> e.g.
    <code class="literal">systemctl start data.mount</code>. Mount points are
    created automatically if they don’t already exist. For
    <code class="literal">device</code>, it’s best to use the topology-independent
    device aliases in <code class="literal">/dev/disk/by-label</code> and
    <code class="literal">/dev/disk/by-uuid</code>, as these don’t change if the
    topology changes (e.g. if a disk is moved to another IDE
    controller).
  </p><p>
    You can usually omit the file system type
    (<code class="literal">fsType</code>), since <code class="literal">mount</code> can
    usually detect the type and load the necessary kernel module
    automatically. However, if the file system is needed at early boot
    (in the initial ramdisk) and is not <code class="literal">ext2</code>,
    <code class="literal">ext3</code> or <code class="literal">ext4</code>, then it’s best
    to specify <code class="literal">fsType</code> to ensure that the kernel
    module is available.
  </p><div class="note"><h3 class="title">Note</h3><p>
      System startup will fail if any of the filesystems fails to mount,
      dropping you to the emergency shell. You can make a mount
      asynchronous and non-critical by adding
      <code class="literal">options = [ "nofail" ];</code>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-luks-file-systems"></a>8.1. LUKS-Encrypted File Systems</h2></div></div></div><p>
    NixOS supports file systems that are encrypted using
    <span class="emphasis"><em>LUKS</em></span> (Linux Unified Key Setup). For example,
    here is how you create an encrypted Ext4 file system on the device
    <code class="literal">/dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d</code>:
  </p><pre class="programlisting">
# cryptsetup luksFormat /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d

WARNING!
========
This will overwrite data on /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d irrevocably.

Are you sure? (Type uppercase yes): YES
Enter LUKS passphrase: ***
Verify passphrase: ***

# cryptsetup luksOpen /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d crypted
Enter passphrase for /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d: ***

# mkfs.ext4 /dev/mapper/crypted
</pre><p>
    The LUKS volume should be automatically picked up by
    <code class="literal">nixos-generate-config</code>, but you might want to
    verify that your <code class="literal">hardware-configuration.nix</code> looks
    correct. To manually ensure that the system is automatically mounted
    at boot time as <code class="literal">/</code>, add the following to
    <code class="literal">configuration.nix</code>:
  </p><pre class="programlisting">
boot.initrd.luks.devices.crypted.device = "/dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d";
fileSystems."/".device = "/dev/mapper/crypted";
</pre><p>
    Should grub be used as bootloader, and <code class="literal">/boot</code> is
    located on an encrypted partition, it is necessary to add the
    following grub option:
  </p><pre class="programlisting">
boot.loader.grub.enableCryptodisk = true;
</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-luks-file-systems-fido2"></a>8.1.1. FIDO2</h3></div></div></div><p>
      NixOS also supports unlocking your LUKS-Encrypted file system
      using a FIDO2 compatible token. In the following example, we will
      create a new FIDO2 credential and add it as a new key to our
      existing device <code class="literal">/dev/sda2</code>:
    </p><pre class="programlisting">
# export FIDO2_LABEL="/dev/sda2 @ $HOSTNAME"
# fido2luks credential "$FIDO2_LABEL"
f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7

# fido2luks -i add-key /dev/sda2 f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7
Password:
Password (again):
Old password:
Old password (again):
Added to key to device /dev/sda2, slot: 2
</pre><p>
      To ensure that this file system is decrypted using the FIDO2
      compatible key, add the following to
      <code class="literal">configuration.nix</code>:
    </p><pre class="programlisting">
boot.initrd.luks.fido2Support = true;
boot.initrd.luks.devices."/dev/sda2".fido2.credential = "f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7";
</pre><p>
      You can also use the FIDO2 passwordless setup, but for security
      reasons, you might want to enable it only when your device is PIN
      protected, such as
      <a class="link" href="https://trezor.io/" target="_top">Trezor</a>.
    </p><pre class="programlisting">
boot.initrd.luks.devices."/dev/sda2".fido2.passwordLess = true;
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-sshfs-file-systems"></a>8.2. SSHFS File Systems</h2></div></div></div><p>
    <a class="link" href="https://github.com/libfuse/sshfs" target="_top">SSHFS</a> is
    a
    <a class="link" href="https://en.wikipedia.org/wiki/Filesystem_in_Userspace" target="_top">FUSE</a>
    filesystem that allows easy access to directories on a remote
    machine using the SSH File Transfer Protocol (SFTP). It means that
    if you have SSH access to a machine, no additional setup is needed
    to mount a directory.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-sshfs-interactive"></a>8.2.1. Interactive mounting</h3></div></div></div><p>
      In NixOS, SSHFS is packaged as <span class="package">sshfs</span>. Once
      installed, mounting a directory interactively is simple as
      running:
    </p><pre class="programlisting">
$ sshfs my-user@example.com:/my-dir /mnt/my-dir
</pre><p>
      Like any other FUSE file system, the directory is unmounted using:
    </p><pre class="programlisting">
$ fusermount -u /mnt/my-dir
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-sshfs-non-interactive"></a>8.2.2. Non-interactive mounting</h3></div></div></div><p>
      Mounting non-interactively requires some precautions because
      <code class="literal">sshfs</code> will run at boot and under a different
      user (root). For obvious reason, you can’t input a password, so
      public key authentication using an unencrypted key is needed. To
      create a new key without a passphrase you can do:
    </p><pre class="programlisting">
$ ssh-keygen -t ed25519 -P '' -f example-key
Generating public/private ed25519 key pair.
Your identification has been saved in test-key
Your public key has been saved in test-key.pub
The key fingerprint is:
SHA256:yjxl3UbTn31fLWeyLYTAKYJPRmzknjQZoyG8gSNEoIE my-user@workstation
</pre><p>
      To keep the key safe, change the ownership to
      <code class="literal">root:root</code> and make sure the permissions are
      <code class="literal">600</code>: OpenSSH normally refuses to use the key if
      it’s not well-protected.
    </p><p>
      The file system can be configured in NixOS via the usual
      <a class="link" href="options.html#opt-fileSystems">fileSystems</a> option. Here’s
      a typical setup:
    </p><pre class="programlisting">
{
  system.fsPackages = [ pkgs.sshfs ];

  fileSystems."/mnt/my-dir" = {
    device = "my-user@example.com:/my-dir/";
    fsType = "sshfs";
    options =
      [ # Filesystem options
        "allow_other"          # for non-root access
        "_netdev"              # this is a network fs
        "x-systemd.automount"  # mount on demand

        # SSH options
        "reconnect"              # handle connection drops
        "ServerAliveInterval=15" # keep connections alive
        "IdentityFile=/var/secrets/example-key"
      ];
  };
}
</pre><p>
      More options from <code class="literal">ssh_config(5)</code> can be given as
      well, for example you can change the default SSH port or specify a
      jump proxy:
    </p><pre class="programlisting">
{
  options =
    [ "ProxyJump=bastion@example.com"
      "Port=22"
    ];
}
</pre><p>
      It’s also possible to change the <code class="literal">ssh</code> command
      used by SSHFS to connect to the server. For example:
    </p><pre class="programlisting">
{
  options =
    [ (builtins.replaceStrings [" "] ["\\040"]
        "ssh_command=${pkgs.openssh}/bin/ssh -v -L 8080:localhost:80")
    ];

}
</pre><div class="note"><h3 class="title">Note</h3><p>
        The escaping of spaces is needed because every option is written
        to the <code class="literal">/etc/fstab</code> file, which is a
        space-separated table.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sec-sshfs-troubleshooting"></a>8.2.2.1. Troubleshooting</h4></div></div></div><p>
        If you’re having a hard time figuring out why mounting is
        failing, you can add the option
        <code class="literal">"debug"</code>. This enables a verbose log
        in SSHFS that you can access via:
      </p><pre class="programlisting">
$ journalctl -u $(systemd-escape -p /mnt/my-dir/).mount
Jun 22 11:41:18 workstation mount[87790]: SSHFS version 3.7.1
Jun 22 11:41:18 workstation mount[87793]: executing &lt;ssh&gt; &lt;-x&gt; &lt;-a&gt; &lt;-oClearAllForwardings=yes&gt; &lt;-oServerAliveInterval=15&gt; &lt;-oIdentityFile=/var/secrets/wrong-key&gt; &lt;-2&gt; &lt;my-user@example.com&gt; &lt;-s&gt; &lt;sftp&gt;
Jun 22 11:41:19 workstation mount[87793]: my-user@example.com: Permission denied (publickey).
Jun 22 11:41:19 workstation mount[87790]: read: Connection reset by peer
Jun 22 11:41:19 workstation systemd[1]: mnt-my\x2ddir.mount: Mount process exited, code=exited, status=1/FAILURE
Jun 22 11:41:19 workstation systemd[1]: mnt-my\x2ddir.mount: Failed with result 'exit-code'.
Jun 22 11:41:19 workstation systemd[1]: Failed to mount /mnt/my-dir.
Jun 22 11:41:19 workstation systemd[1]: mnt-my\x2ddir.mount: Consumed 54ms CPU time, received 2.3K IP traffic, sent 2.7K IP traffic.
</pre><div class="note"><h3 class="title">Note</h3><p>
          If the mount point contains special characters it needs to be
          escaped using <code class="literal">systemd-escape</code>. This is due
          to the way systemd converts paths into unit names.
        </p></div></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-x11"></a>Chapter 9. X Window System</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-x11-auto-login">9.1. Auto-login</a></span></dt><dt><span class="section"><a href="index.html#sec-x11--graphics-cards-intel">9.2. Intel Graphics drivers</a></span></dt><dt><span class="section"><a href="index.html#sec-x11-graphics-cards-nvidia">9.3. Proprietary NVIDIA drivers</a></span></dt><dt><span class="section"><a href="index.html#sec-x11--graphics-cards-amd">9.4. Proprietary AMD drivers</a></span></dt><dt><span class="section"><a href="index.html#sec-x11-touchpads">9.5. Touchpads</a></span></dt><dt><span class="section"><a href="index.html#sec-x11-gtk-and-qt-themes">9.6. GTK/Qt themes</a></span></dt><dt><span class="section"><a href="index.html#custom-xkb-layouts">9.7. Custom XKB layouts</a></span></dt></dl></div><p>
    The X Window System (X11) provides the basis of NixOS’ graphical
    user interface. It can be enabled as follows:
  </p><pre class="programlisting">
services.xserver.enable = true;
</pre><p>
    The X server will automatically detect and use the appropriate video
    driver from a set of X.org drivers (such as <code class="literal">vesa</code>
    and <code class="literal">intel</code>). You can also specify a driver
    manually, e.g.
  </p><pre class="programlisting">
services.xserver.videoDrivers = [ "r128" ];
</pre><p>
    to enable X.org’s <code class="literal">xf86-video-r128</code> driver.
  </p><p>
    You also need to enable at least one desktop or window manager.
    Otherwise, you can only log into a plain undecorated
    <code class="literal">xterm</code> window. Thus you should pick one or more of
    the following lines:
  </p><pre class="programlisting">
services.xserver.desktopManager.plasma5.enable = true;
services.xserver.desktopManager.xfce.enable = true;
services.xserver.desktopManager.gnome.enable = true;
services.xserver.desktopManager.mate.enable = true;
services.xserver.windowManager.xmonad.enable = true;
services.xserver.windowManager.twm.enable = true;
services.xserver.windowManager.icewm.enable = true;
services.xserver.windowManager.i3.enable = true;
services.xserver.windowManager.herbstluftwm.enable = true;
</pre><p>
    NixOS’s default <span class="emphasis"><em>display manager</em></span> (the program
    that provides a graphical login prompt and manages the X server) is
    LightDM. You can select an alternative one by picking one of the
    following lines:
  </p><pre class="programlisting">
services.xserver.displayManager.sddm.enable = true;
services.xserver.displayManager.gdm.enable = true;
</pre><p>
    You can set the keyboard layout (and optionally the layout variant):
  </p><pre class="programlisting">
services.xserver.layout = "de";
services.xserver.xkbVariant = "neo";
</pre><p>
    The X server is started automatically at boot time. If you don’t
    want this to happen, you can set:
  </p><pre class="programlisting">
services.xserver.autorun = false;
</pre><p>
    The X server can then be started manually:
  </p><pre class="programlisting">
# systemctl start display-manager.service
</pre><p>
    On 64-bit systems, if you want OpenGL for 32-bit programs such as in
    Wine, you should also set the following:
  </p><pre class="programlisting">
hardware.opengl.driSupport32Bit = true;
</pre><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-x11-auto-login"></a>9.1. Auto-login</h2></div></div></div><p>
      The x11 login screen can be skipped entirely, automatically
      logging you into your window manager and desktop environment when
      you boot your computer.
    </p><p>
      This is especially helpful if you have disk encryption enabled.
      Since you already have to provide a password to decrypt your disk,
      entering a second password to login can be redundant.
    </p><p>
      To enable auto-login, you need to define your default window
      manager and desktop environment. If you wanted no desktop
      environment and i3 as your your window manager, you'd define:
    </p><pre class="programlisting">
services.xserver.displayManager.defaultSession = "none+i3";
</pre><p>
      Every display manager in NixOS supports auto-login, here is an
      example using lightdm for a user <code class="literal">alice</code>:
    </p><pre class="programlisting">
services.xserver.displayManager.lightdm.enable = true;
services.xserver.displayManager.autoLogin.enable = true;
services.xserver.displayManager.autoLogin.user = "alice";
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-x11--graphics-cards-intel"></a>9.2. Intel Graphics drivers</h2></div></div></div><p>
      There are two choices for Intel Graphics drivers in X.org:
      <code class="literal">modesetting</code> (included in the xorg-server
      itself) and <code class="literal">intel</code> (provided by the package
      xf86-video-intel).
    </p><p>
      The default and recommended is <code class="literal">modesetting</code>. It
      is a generic driver which uses the kernel
      <a class="link" href="https://en.wikipedia.org/wiki/Mode_setting" target="_top">mode
      setting</a> (KMS) mechanism. It supports Glamor (2D graphics
      acceleration via OpenGL) and is actively maintained but may
      perform worse in some cases (like in old chipsets).
    </p><p>
      The second driver, <code class="literal">intel</code>, is specific to Intel
      GPUs, but not recommended by most distributions: it lacks several
      modern features (for example, it doesn't support Glamor) and the
      package hasn't been officially updated since 2015.
    </p><p>
      The results vary depending on the hardware, so you may have to try
      both drivers. Use the option
      <a class="xref" href="options.html#opt-services.xserver.videoDrivers"><code class="option">services.xserver.videoDrivers</code></a> to set one.
      The recommended configuration for modern systems is:
    </p><pre class="programlisting">
services.xserver.videoDrivers = [ "modesetting" ];
services.xserver.useGlamor = true;
</pre><p>
      If you experience screen tearing no matter what, this
      configuration was reported to resolve the issue:
    </p><pre class="programlisting">
services.xserver.videoDrivers = [ "intel" ];
services.xserver.deviceSection = ''
  Option "DRI" "2"
  Option "TearFree" "true"
'';
</pre><p>
      Note that this will likely downgrade the performance compared to
      <code class="literal">modesetting</code> or <code class="literal">intel</code> with
      DRI 3 (default).
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-x11-graphics-cards-nvidia"></a>9.3. Proprietary NVIDIA drivers</h2></div></div></div><p>
      NVIDIA provides a proprietary driver for its graphics cards that
      has better 3D performance than the X.org drivers. It is not
      enabled by default because it’s not free software. You can enable
      it as follows:
    </p><pre class="programlisting">
services.xserver.videoDrivers = [ "nvidia" ];
</pre><p>
      Or if you have an older card, you may have to use one of the
      legacy drivers:
    </p><pre class="programlisting">
services.xserver.videoDrivers = [ "nvidiaLegacy390" ];
services.xserver.videoDrivers = [ "nvidiaLegacy340" ];
services.xserver.videoDrivers = [ "nvidiaLegacy304" ];
</pre><p>
      You may need to reboot after enabling this driver to prevent a
      clash with other kernel modules.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-x11--graphics-cards-amd"></a>9.4. Proprietary AMD drivers</h2></div></div></div><p>
      AMD provides a proprietary driver for its graphics cards that is
      not enabled by default because it’s not Free Software, is often
      broken in nixpkgs and as of this writing doesn't offer more
      features or performance. If you still want to use it anyway, you
      need to explicitly set:
    </p><pre class="programlisting">
services.xserver.videoDrivers = [ "amdgpu-pro" ];
</pre><p>
      You will need to reboot after enabling this driver to prevent a
      clash with other kernel modules.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-x11-touchpads"></a>9.5. Touchpads</h2></div></div></div><p>
      Support for Synaptics touchpads (found in many laptops such as the
      Dell Latitude series) can be enabled as follows:
    </p><pre class="programlisting">
services.xserver.libinput.enable = true;
</pre><p>
      The driver has many options (see <a class="xref" href="options.html" title="Appendix A. Configuration Options">Appendix A, <em>Configuration Options</em></a>).
      For instance, the following disables tap-to-click behavior:
    </p><pre class="programlisting">
services.xserver.libinput.touchpad.tapping = false;
</pre><p>
      Note: the use of <code class="literal">services.xserver.synaptics</code> is
      deprecated since NixOS 17.09.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-x11-gtk-and-qt-themes"></a>9.6. GTK/Qt themes</h2></div></div></div><p>
      GTK themes can be installed either to user profile or system-wide
      (via <code class="literal">environment.systemPackages</code>). To make Qt 5
      applications look similar to GTK ones, you can use the following
      configuration:
    </p><pre class="programlisting">
qt5.enable = true;
qt5.platformTheme = "gtk2";
qt5.style = "gtk2";
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="custom-xkb-layouts"></a>9.7. Custom XKB layouts</h2></div></div></div><p>
      It is possible to install custom
      <a class="link" href="https://en.wikipedia.org/wiki/X_keyboard_extension" target="_top">
      XKB </a> keyboard layouts using the option
      <code class="literal">services.xserver.extraLayouts</code>.
    </p><p>
      As a first example, we are going to create a layout based on the
      basic US layout, with an additional layer to type some greek
      symbols by pressing the right-alt key.
    </p><p>
      Create a file called <code class="literal">us-greek</code> with the
      following content (under a directory called
      <code class="literal">symbols</code>; it's an XKB peculiarity that will help
      with testing):
    </p><pre class="programlisting">
xkb_symbols "us-greek"
{
  include "us(basic)"            // includes the base US keys
  include "level3(ralt_switch)"  // configures right alt as a third level switch

  key &lt;LatA&gt; { [ a, A, Greek_alpha ] };
  key &lt;LatB&gt; { [ b, B, Greek_beta  ] };
  key &lt;LatG&gt; { [ g, G, Greek_gamma ] };
  key &lt;LatD&gt; { [ d, D, Greek_delta ] };
  key &lt;LatZ&gt; { [ z, Z, Greek_zeta  ] };
};
</pre><p>
      A minimal layout specification must include the following:
    </p><pre class="programlisting">
services.xserver.extraLayouts.us-greek = {
  description = "US layout with alt-gr greek";
  languages   = [ "eng" ];
  symbolsFile = /yourpath/symbols/us-greek;
};
</pre><div class="note"><h3 class="title">Note</h3><p>
        The name (after <code class="literal">extraLayouts.</code>) should match
        the one given to the <code class="literal">xkb_symbols</code> block.
      </p></div><p>
      Applying this customization requires rebuilding several packages,
      and a broken XKB file can lead to the X session crashing at login.
      Therefore, you're strongly advised to <span class="strong"><strong>test
      your layout before applying it</strong></span>:
    </p><pre class="programlisting">
$ nix-shell -p xorg.xkbcomp
$ setxkbmap -I/yourpath us-greek -print | xkbcomp -I/yourpath - $DISPLAY
</pre><p>
      You can inspect the predefined XKB files for examples:
    </p><pre class="programlisting">
$ echo "$(nix-build --no-out-link '&lt;nixpkgs&gt;' -A xorg.xkeyboardconfig)/etc/X11/xkb/"
</pre><p>
      Once the configuration is applied, and you did a logout/login
      cycle, the layout should be ready to use. You can try it by e.g.
      running <code class="literal">setxkbmap us-greek</code> and then type
      <code class="literal">&lt;alt&gt;+a</code> (it may not get applied in your
      terminal straight away). To change the default, the usual
      <code class="literal">services.xserver.layout</code> option can still be
      used.
    </p><p>
      A layout can have several other components besides
      <code class="literal">xkb_symbols</code>, for example we will define new
      keycodes for some multimedia key and bind these to some symbol.
    </p><p>
      Use the <span class="emphasis"><em>xev</em></span> utility from
      <code class="literal">pkgs.xorg.xev</code> to find the codes of the keys of
      interest, then create a <code class="literal">media-key</code> file to hold
      the keycodes definitions
    </p><pre class="programlisting">
xkb_keycodes "media"
{
 &lt;volUp&gt;   = 123;
 &lt;volDown&gt; = 456;
}
</pre><p>
      Now use the newly define keycodes in <code class="literal">media-sym</code>:
    </p><pre class="programlisting">
xkb_symbols "media"
{
 key.type = "ONE_LEVEL";
 key &lt;volUp&gt;   { [ XF86AudioLowerVolume ] };
 key &lt;volDown&gt; { [ XF86AudioRaiseVolume ] };
}
</pre><p>
      As before, to install the layout do
    </p><pre class="programlisting">
services.xserver.extraLayouts.media = {
  description  = "Multimedia keys remapping";
  languages    = [ "eng" ];
  symbolsFile  = /path/to/media-key;
  keycodesFile = /path/to/media-sym;
};
</pre><div class="note"><h3 class="title">Note</h3><p>
        The function
        <code class="literal">pkgs.writeText &lt;filename&gt; &lt;content&gt;</code>
        can be useful if you prefer to keep the layout definitions
        inside the NixOS configuration.
      </p></div><p>
      Unfortunately, the Xorg server does not (currently) support
      setting a keymap directly but relies instead on XKB rules to
      select the matching components (keycodes, types, ...) of a layout.
      This means that components other than symbols won't be loaded by
      default. As a workaround, you can set the keymap using
      <code class="literal">setxkbmap</code> at the start of the session with:
    </p><pre class="programlisting">
services.xserver.displayManager.sessionCommands = "setxkbmap -keycodes media";
</pre><p>
      If you are manually starting the X server, you should set the
      argument <code class="literal">-xkbdir /etc/X11/xkb</code>, otherwise X
      won't find your layout files. For example with
      <code class="literal">xinit</code> run
    </p><pre class="programlisting">
$ xinit -- -xkbdir /etc/X11/xkb
</pre><p>
      To learn how to write layouts take a look at the XKB
      <a class="link" href="https://www.x.org/releases/current/doc/xorg-docs/input/XKB-Enhancing.html#Defining_New_Layouts" target="_top">documentation
      </a>. More example layouts can also be found
      <a class="link" href="https://wiki.archlinux.org/index.php/X_KeyBoard_extension#Basic_examples" target="_top">here
      </a>.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-wayland"></a>Chapter 10. Wayland</h2></div></div></div><p>
    While X11 (see <a class="xref" href="index.html#sec-x11" title="Chapter 9. X Window System">Chapter 9, <em>X Window System</em></a>) is still the primary
    display technology on NixOS, Wayland support is steadily improving.
    Where X11 separates the X Server and the window manager, on Wayland
    those are combined: a Wayland Compositor is like an X11 window
    manager, but also embeds the Wayland 'Server' functionality. This
    means it is sufficient to install a Wayland Compositor such as sway
    without separately enabling a Wayland server:
  </p><pre class="programlisting">
programs.sway.enable = true;
</pre><p>
    This installs the sway compositor along with some essential
    utilities. Now you can start sway from the TTY console.
  </p><p>
    If you are using a wlroots-based compositor, like sway, and want to
    be able to share your screen, you might want to activate this
    option:
  </p><pre class="programlisting">
xdg.portal.wlr.enable = true;
</pre><p>
    and configure Pipewire using
    <a class="xref" href="options.html#opt-services.pipewire.enable"><code class="option">services.pipewire.enable</code></a> and related options.
  </p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-gpu-accel"></a>Chapter 11. GPU acceleration</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-gpu-accel-opencl">11.1. OpenCL</a></span></dt><dt><span class="section"><a href="index.html#sec-gpu-accel-vulkan">11.2. Vulkan</a></span></dt><dt><span class="section"><a href="index.html#sec-gpu-accel-common-issues">11.3. Common issues</a></span></dt></dl></div><p>
    NixOS provides various APIs that benefit from GPU hardware
    acceleration, such as VA-API and VDPAU for video playback; OpenGL
    and Vulkan for 3D graphics; and OpenCL for general-purpose
    computing. This chapter describes how to set up GPU hardware
    acceleration (as far as this is not done automatically) and how to
    verify that hardware acceleration is indeed used.
  </p><p>
    Most of the aforementioned APIs are agnostic with regards to which
    display server is used. Consequently, these instructions should
    apply both to the X Window System and Wayland compositors.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-gpu-accel-opencl"></a>11.1. OpenCL</h2></div></div></div><p>
      <a class="link" href="https://en.wikipedia.org/wiki/OpenCL" target="_top">OpenCL</a>
      is a general compute API. It is used by various applications such
      as Blender and Darktable to accelerate certain operations.
    </p><p>
      OpenCL applications load drivers through the <span class="emphasis"><em>Installable
      Client Driver</em></span> (ICD) mechanism. In this mechanism, an
      ICD file specifies the path to the OpenCL driver for a particular
      GPU family. In NixOS, there are two ways to make ICD files visible
      to the ICD loader. The first is through the
      <code class="literal">OCL_ICD_VENDORS</code> environment variable. This
      variable can contain a directory which is scanned by the ICL
      loader for ICD files. For example:
    </p><pre class="programlisting">
$ export \
  OCL_ICD_VENDORS=`nix-build '&lt;nixpkgs&gt;' --no-out-link -A rocm-opencl-icd`/etc/OpenCL/vendors/
</pre><p>
      The second mechanism is to add the OpenCL driver package to
      <a class="xref" href="options.html#opt-hardware.opengl.extraPackages"><code class="option">hardware.opengl.extraPackages</code></a>. This links
      the ICD file under <code class="literal">/run/opengl-driver</code>, where it
      will be visible to the ICD loader.
    </p><p>
      The proper installation of OpenCL drivers can be verified through
      the <code class="literal">clinfo</code> command of the clinfo package. This
      command will report the number of hardware devices that is found
      and give detailed information for each device:
    </p><pre class="programlisting">
$ clinfo | head -n3
Number of platforms  1
Platform Name        AMD Accelerated Parallel Processing
Platform Vendor      Advanced Micro Devices, Inc.
</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gpu-accel-opencl-amd"></a>11.1.1. AMD</h3></div></div></div><p>
        Modern AMD
        <a class="link" href="https://en.wikipedia.org/wiki/Graphics_Core_Next" target="_top">Graphics
        Core Next</a> (GCN) GPUs are supported through the
        rocm-opencl-icd package. Adding this package to
        <a class="xref" href="options.html#opt-hardware.opengl.extraPackages"><code class="option">hardware.opengl.extraPackages</code></a> enables
        OpenCL support:
      </p><pre class="programlisting">
hardware.opengl.extraPackages = [
  rocm-opencl-icd
];
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gpu-accel-opencl-intel"></a>11.1.2. Intel</h3></div></div></div><p>
        <a class="link" href="https://en.wikipedia.org/wiki/List_of_Intel_graphics_processing_units#Gen8" target="_top">Intel
        Gen8 and later GPUs</a> are supported by the Intel NEO OpenCL
        runtime that is provided by the intel-compute-runtime package.
        For Gen7 GPUs, the deprecated Beignet runtime can be used, which
        is provided by the beignet package. The proprietary Intel OpenCL
        runtime, in the intel-ocl package, is an alternative for Gen7
        GPUs.
      </p><p>
        The intel-compute-runtime, beignet, or intel-ocl package can be
        added to <a class="xref" href="options.html#opt-hardware.opengl.extraPackages"><code class="option">hardware.opengl.extraPackages</code></a> to
        enable OpenCL support. For example, for Gen8 and later GPUs, the
        following configuration can be used:
      </p><pre class="programlisting">
hardware.opengl.extraPackages = [
  intel-compute-runtime
];
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-gpu-accel-vulkan"></a>11.2. Vulkan</h2></div></div></div><p>
      <a class="link" href="https://en.wikipedia.org/wiki/Vulkan_(API)" target="_top">Vulkan</a>
      is a graphics and compute API for GPUs. It is used directly by
      games or indirectly though compatibility layers like
      <a class="link" href="https://github.com/doitsujin/dxvk/wiki" target="_top">DXVK</a>.
    </p><p>
      By default, if <a class="xref" href="options.html#opt-hardware.opengl.driSupport"><code class="option">hardware.opengl.driSupport</code></a>
      is enabled, mesa is installed and provides Vulkan for supported
      hardware.
    </p><p>
      Similar to OpenCL, Vulkan drivers are loaded through the
      <span class="emphasis"><em>Installable Client Driver</em></span> (ICD) mechanism.
      ICD files for Vulkan are JSON files that specify the path to the
      driver library and the supported Vulkan version. All successfully
      loaded drivers are exposed to the application as different GPUs.
      In NixOS, there are two ways to make ICD files visible to Vulkan
      applications: an environment variable and a module option.
    </p><p>
      The first option is through the
      <code class="literal">VK_ICD_FILENAMES</code> environment variable. This
      variable can contain multiple JSON files, separated by
      <code class="literal">:</code>. For example:
    </p><pre class="programlisting">
$ export \
  VK_ICD_FILENAMES=`nix-build '&lt;nixpkgs&gt;' --no-out-link -A amdvlk`/share/vulkan/icd.d/amd_icd64.json
</pre><p>
      The second mechanism is to add the Vulkan driver package to
      <a class="xref" href="options.html#opt-hardware.opengl.extraPackages"><code class="option">hardware.opengl.extraPackages</code></a>. This links
      the ICD file under <code class="literal">/run/opengl-driver</code>, where it
      will be visible to the ICD loader.
    </p><p>
      The proper installation of Vulkan drivers can be verified through
      the <code class="literal">vulkaninfo</code> command of the vulkan-tools
      package. This command will report the hardware devices and drivers
      found, in this example output amdvlk and radv:
    </p><pre class="programlisting">
$ vulkaninfo | grep GPU
                GPU id  : 0 (Unknown AMD GPU)
                GPU id  : 1 (AMD RADV NAVI10 (LLVM 9.0.1))
     ...
GPU0:
        deviceType     = PHYSICAL_DEVICE_TYPE_DISCRETE_GPU
        deviceName     = Unknown AMD GPU
GPU1:
        deviceType     = PHYSICAL_DEVICE_TYPE_DISCRETE_GPU
</pre><p>
      A simple graphical application that uses Vulkan is
      <code class="literal">vkcube</code> from the vulkan-tools package.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gpu-accel-vulkan-amd"></a>11.2.1. AMD</h3></div></div></div><p>
        Modern AMD
        <a class="link" href="https://en.wikipedia.org/wiki/Graphics_Core_Next" target="_top">Graphics
        Core Next</a> (GCN) GPUs are supported through either radv,
        which is part of mesa, or the amdvlk package. Adding the amdvlk
        package to <a class="xref" href="options.html#opt-hardware.opengl.extraPackages"><code class="option">hardware.opengl.extraPackages</code></a>
        makes amdvlk the default driver and hides radv and lavapipe from
        the device list. A specific driver can be forced as follows:
      </p><pre class="programlisting">
hardware.opengl.extraPackages = [
  pkgs.amdvlk
];

# To enable Vulkan support for 32-bit applications, also add:
hardware.opengl.extraPackages32 = [
  pkgs.driversi686Linux.amdvlk
];

# Force radv
environment.variables.AMD_VULKAN_ICD = "RADV";
# Or
environment.variables.VK_ICD_FILENAMES =
  "/run/opengl-driver/share/vulkan/icd.d/radeon_icd.x86_64.json";
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-gpu-accel-common-issues"></a>11.3. Common issues</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gpu-accel-common-issues-permissions"></a>11.3.1. User permissions</h3></div></div></div><p>
        Except where noted explicitly, it should not be necessary to
        adjust user permissions to use these acceleration APIs. In the
        default configuration, GPU devices have world-read/write
        permissions (<code class="literal">/dev/dri/renderD*</code>) or are tagged
        as <code class="literal">uaccess</code>
        (<code class="literal">/dev/dri/card*</code>). The access control lists of
        devices with the <code class="literal">uaccess</code> tag will be updated
        automatically when a user logs in through
        <code class="literal">systemd-logind</code>. For example, if the user
        <span class="emphasis"><em>jane</em></span> is logged in, the access control list
        should look as follows:
      </p><pre class="programlisting">
$ getfacl /dev/dri/card0
# file: dev/dri/card0
# owner: root
# group: video
user::rw-
user:jane:rw-
group::rw-
mask::rw-
other::---
</pre><p>
        If you disabled (this functionality of)
        <code class="literal">systemd-logind</code>, you may need to add the user
        to the <code class="literal">video</code> group and log in again.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gpu-accel-common-issues-mixing-nixpkgs"></a>11.3.2. Mixing different versions of nixpkgs</h3></div></div></div><p>
        The <span class="emphasis"><em>Installable Client Driver</em></span> (ICD)
        mechanism used by OpenCL and Vulkan loads runtimes into its
        address space using <code class="literal">dlopen</code>. Mixing an ICD
        loader mechanism and runtimes from different version of nixpkgs
        may not work. For example, if the ICD loader uses an older
        version of glibc than the runtime, the runtime may not be
        loadable due to missing symbols. Unfortunately, the loader will
        generally be quiet about such issues.
      </p><p>
        If you suspect that you are running into library version
        mismatches between an ICL loader and a runtime, you could run an
        application with the <code class="literal">LD_DEBUG</code> variable set to
        get more diagnostic information. For example, OpenCL can be
        tested with <code class="literal">LD_DEBUG=files clinfo</code>, which
        should report missing symbols.
      </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-xfce"></a>Chapter 12. Xfce Desktop Environment</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-xfce-thunar-plugins">12.1. Thunar Plugins</a></span></dt><dt><span class="section"><a href="index.html#sec-xfce-troubleshooting">12.2. Troubleshooting</a></span></dt></dl></div><p>
    To enable the Xfce Desktop Environment, set
  </p><pre class="programlisting">
services.xserver.desktopManager.xfce.enable = true;
services.xserver.displayManager.defaultSession = "xfce";
</pre><p>
    Optionally, <span class="emphasis"><em>picom</em></span> can be enabled for nice
    graphical effects, some example settings:
  </p><pre class="programlisting">
services.picom = {
  enable = true;
  fade = true;
  inactiveOpacity = 0.9;
  shadow = true;
  fadeDelta = 4;
};
</pre><p>
    Some Xfce programs are not installed automatically. To install them
    manually (system wide), put them into your
    <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> from
    <code class="literal">pkgs.xfce</code>.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-xfce-thunar-plugins"></a>12.1. Thunar Plugins</h2></div></div></div><p>
      If you'd like to add extra plugins to Thunar, add them to
      <a class="xref" href="options.html#opt-services.xserver.desktopManager.xfce.thunarPlugins"><code class="option">services.xserver.desktopManager.xfce.thunarPlugins</code></a>.
      You shouldn't just add them to
      <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-xfce-troubleshooting"></a>12.2. Troubleshooting</h2></div></div></div><p>
      Even after enabling udisks2, volume management might not work.
      Thunar and/or the desktop takes time to show up. Thunar will spit
      out this kind of message on start (look at
      <code class="literal">journalctl --user -b</code>).
    </p><pre class="programlisting">
Thunar:2410): GVFS-RemoteVolumeMonitor-WARNING **: remote volume monitor with dbus name org.gtk.Private.UDisks2VolumeMonitor is not supported
</pre><p>
      This is caused by some needed GNOME services not running. This is
      all fixed by enabling "Launch GNOME services on startup"
      in the Advanced tab of the Session and Startup settings panel.
      Alternatively, you can run this command to do the same thing.
    </p><pre class="programlisting">
$ xfconf-query -c xfce4-session -p /compat/LaunchGNOME -s true
</pre><p>
      A log-out and re-log will be needed for this to take effect.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-networking"></a>Chapter 13. Networking</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-networkmanager">13.1. NetworkManager</a></span></dt><dt><span class="section"><a href="index.html#sec-ssh">13.2. Secure Shell Access</a></span></dt><dt><span class="section"><a href="index.html#sec-ipv4">13.3. IPv4 Configuration</a></span></dt><dt><span class="section"><a href="index.html#sec-ipv6">13.4. IPv6 Configuration</a></span></dt><dt><span class="section"><a href="index.html#sec-firewall">13.5. Firewall</a></span></dt><dt><span class="section"><a href="index.html#sec-wireless">13.6. Wireless Networks</a></span></dt><dt><span class="section"><a href="index.html#ad-hoc-network-config">13.7. Ad-Hoc Configuration</a></span></dt><dt><span class="section"><a href="index.html#sec-rename-ifs">13.8. Renaming network interfaces</a></span></dt></dl></div><p>
    This section describes how to configure networking components on
    your NixOS machine.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-networkmanager"></a>13.1. NetworkManager</h2></div></div></div><p>
    To facilitate network configuration, some desktop environments use
    NetworkManager. You can enable NetworkManager by setting:
  </p><pre class="programlisting">
networking.networkmanager.enable = true;
</pre><p>
    some desktop managers (e.g., GNOME) enable NetworkManager
    automatically for you.
  </p><p>
    All users that should have permission to change network settings
    must belong to the <code class="literal">networkmanager</code> group:
  </p><pre class="programlisting">
users.users.alice.extraGroups = [ "networkmanager" ];
</pre><p>
    NetworkManager is controlled using either <code class="literal">nmcli</code>
    or <code class="literal">nmtui</code> (curses-based terminal user interface).
    See their manual pages for details on their usage. Some desktop
    environments (GNOME, KDE) have their own configuration tools for
    NetworkManager. On XFCE, there is no configuration tool for
    NetworkManager by default: by enabling
    <a class="xref" href="options.html#opt-programs.nm-applet.enable"><code class="option">programs.nm-applet.enable</code></a>, the graphical
    applet will be installed and will launch automatically when the
    graphical session is started.
  </p><div class="note"><h3 class="title">Note</h3><p>
      <code class="literal">networking.networkmanager</code> and
      <code class="literal">networking.wireless</code> (WPA Supplicant) can be
      used together if desired. To do this you need to instruct
      NetworkManager to ignore those interfaces like:
    </p><pre class="programlisting">
networking.networkmanager.unmanaged = [
   "*" "except:type:wwan" "except:type:gsm"
];
</pre><p>
      Refer to the option description for the exact syntax and
      references to external documentation.
    </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-ssh"></a>13.2. Secure Shell Access</h2></div></div></div><p>
    Secure shell (SSH) access to your machine can be enabled by setting:
  </p><pre class="programlisting">
services.openssh.enable = true;
</pre><p>
    By default, root logins using a password are disallowed. They can be
    disabled entirely by setting
    <a class="xref" href="options.html#opt-services.openssh.permitRootLogin"><code class="option">services.openssh.permitRootLogin</code></a> to
    <code class="literal">"no"</code>.
  </p><p>
    You can declaratively specify authorised RSA/DSA public keys for a
    user as follows:
  </p><pre class="programlisting">
users.users.alice.openssh.authorizedKeys.keys =
  [ "ssh-dss AAAAB3NzaC1kc3MAAACBAPIkGWVEt4..." ];
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-ipv4"></a>13.3. IPv4 Configuration</h2></div></div></div><p>
    By default, NixOS uses DHCP (specifically,
    <code class="literal">dhcpcd</code>) to automatically configure network
    interfaces. However, you can configure an interface manually as
    follows:
  </p><pre class="programlisting">
networking.interfaces.eth0.ipv4.addresses = [ {
  address = "192.168.1.2";
  prefixLength = 24;
} ];
</pre><p>
    Typically you’ll also want to set a default gateway and set of name
    servers:
  </p><pre class="programlisting">
networking.defaultGateway = "192.168.1.1";
networking.nameservers = [ "8.8.8.8" ];
</pre><div class="note"><h3 class="title">Note</h3><p>
      Statically configured interfaces are set up by the systemd service
      <code class="literal">interface-name-cfg.service</code>. The default gateway
      and name server configuration is performed by
      <code class="literal">network-setup.service</code>.
    </p></div><p>
    The host name is set using
    <a class="xref" href="options.html#opt-networking.hostName"><code class="option">networking.hostName</code></a>:
  </p><pre class="programlisting">
networking.hostName = "cartman";
</pre><p>
    The default host name is <code class="literal">nixos</code>. Set it to the
    empty string (<code class="literal">""</code>) to allow the DHCP
    server to provide the host name.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-ipv6"></a>13.4. IPv6 Configuration</h2></div></div></div><p>
    IPv6 is enabled by default. Stateless address autoconfiguration is
    used to automatically assign IPv6 addresses to all interfaces, and
    Privacy Extensions (RFC 4946) are enabled by default. You can adjust
    the default for this by setting
    <a class="xref" href="options.html#opt-networking.tempAddresses"><code class="option">networking.tempAddresses</code></a>. This option may be
    overridden on a per-interface basis by
    <a class="xref" href="options.html#opt-networking.interfaces._name_.tempAddress"><code class="option">networking.interfaces.&lt;name&gt;.tempAddress</code></a>. You
    can disable IPv6 support globally by setting:
  </p><pre class="programlisting">
networking.enableIPv6 = false;
</pre><p>
    You can disable IPv6 on a single interface using a normal sysctl (in
    this example, we use interface <code class="literal">eth0</code>):
  </p><pre class="programlisting">
boot.kernel.sysctl."net.ipv6.conf.eth0.disable_ipv6" = true;
</pre><p>
    As with IPv4 networking interfaces are automatically configured via
    DHCPv6. You can configure an interface manually:
  </p><pre class="programlisting">
networking.interfaces.eth0.ipv6.addresses = [ {
  address = "fe00:aa:bb:cc::2";
  prefixLength = 64;
} ];
</pre><p>
    For configuring a gateway, optionally with explicitly specified
    interface:
  </p><pre class="programlisting">
networking.defaultGateway6 = {
  address = "fe00::1";
  interface = "enp0s3";
};
</pre><p>
    See <a class="xref" href="index.html#sec-ipv4" title="13.3. IPv4 Configuration">Section 13.3, “IPv4 Configuration”</a> for similar examples and additional
    information.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-firewall"></a>13.5. Firewall</h2></div></div></div><p>
    NixOS has a simple stateful firewall that blocks incoming
    connections and other unexpected packets. The firewall applies to
    both IPv4 and IPv6 traffic. It is enabled by default. It can be
    disabled as follows:
  </p><pre class="programlisting">
networking.firewall.enable = false;
</pre><p>
    If the firewall is enabled, you can open specific TCP ports to the
    outside world:
  </p><pre class="programlisting">
networking.firewall.allowedTCPPorts = [ 80 443 ];
</pre><p>
    Note that TCP port 22 (ssh) is opened automatically if the SSH
    daemon is enabled
    (<code class="literal">services.openssh.enable = true</code>). UDP ports can
    be opened through
    <a class="xref" href="options.html#opt-networking.firewall.allowedUDPPorts"><code class="option">networking.firewall.allowedUDPPorts</code></a>.
  </p><p>
    To open ranges of TCP ports:
  </p><pre class="programlisting">
networking.firewall.allowedTCPPortRanges = [
  { from = 4000; to = 4007; }
  { from = 8000; to = 8010; }
];
</pre><p>
    Similarly, UDP port ranges can be opened through
    <a class="xref" href="options.html#opt-networking.firewall.allowedUDPPortRanges"><code class="option">networking.firewall.allowedUDPPortRanges</code></a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-wireless"></a>13.6. Wireless Networks</h2></div></div></div><p>
    For a desktop installation using NetworkManager (e.g., GNOME), you
    just have to make sure the user is in the
    <code class="literal">networkmanager</code> group and you can skip the rest of
    this section on wireless networks.
  </p><p>
    NixOS will start wpa_supplicant for you if you enable this setting:
  </p><pre class="programlisting">
networking.wireless.enable = true;
</pre><p>
    NixOS lets you specify networks for wpa_supplicant declaratively:
  </p><pre class="programlisting">
networking.wireless.networks = {
  echelon = {                # SSID with no spaces or special characters
    psk = "abcdefgh";
  };
  "echelon's AP" = {         # SSID with spaces and/or special characters
    psk = "ijklmnop";
  };
  echelon = {                # Hidden SSID
    hidden = true;
    psk = "qrstuvwx";
  };
  free.wifi = {};            # Public wireless network
};
</pre><p>
    Be aware that keys will be written to the nix store in plaintext!
    When no networks are set, it will default to using a configuration
    file at <code class="literal">/etc/wpa_supplicant.conf</code>. You should edit
    this file yourself to define wireless networks, WPA keys and so on
    (see wpa_supplicant.conf(5)).
  </p><p>
    If you are using WPA2 you can generate pskRaw key using
    <code class="literal">wpa_passphrase</code>:
  </p><pre class="programlisting">
$ wpa_passphrase ESSID PSK
network={
        ssid="echelon"
        #psk="abcdefgh"
        psk=dca6d6ed41f4ab5a984c9f55f6f66d4efdc720ebf66959810f4329bb391c5435
}
</pre><pre class="programlisting">
networking.wireless.networks = {
  echelon = {
    pskRaw = "dca6d6ed41f4ab5a984c9f55f6f66d4efdc720ebf66959810f4329bb391c5435";
  };
}
</pre><p>
    or you can use it to directly generate the
    <code class="literal">wpa_supplicant.conf</code>:
  </p><pre class="programlisting">
# wpa_passphrase ESSID PSK &gt; /etc/wpa_supplicant.conf
</pre><p>
    After you have edited the <code class="literal">wpa_supplicant.conf</code>,
    you need to restart the wpa_supplicant service.
  </p><pre class="programlisting">
# systemctl restart wpa_supplicant.service
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ad-hoc-network-config"></a>13.7. Ad-Hoc Configuration</h2></div></div></div><p>
    You can use <a class="xref" href="options.html#opt-networking.localCommands"><code class="option">networking.localCommands</code></a> to
    specify shell commands to be run at the end of
    <code class="literal">network-setup.service</code>. This is useful for doing
    network configuration not covered by the existing NixOS modules. For
    instance, to statically configure an IPv6 address:
  </p><pre class="programlisting">
networking.localCommands =
  ''
    ip -6 addr add 2001:610:685:1::1/64 dev eth0
  '';
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-rename-ifs"></a>13.8. Renaming network interfaces</h2></div></div></div><p>
    NixOS uses the udev
    <a class="link" href="https://systemd.io/PREDICTABLE_INTERFACE_NAMES/" target="_top">predictable
    naming scheme</a> to assign names to network interfaces. This
    means that by default cards are not given the traditional names like
    <code class="literal">eth0</code> or <code class="literal">eth1</code>, whose order can
    change unpredictably across reboots. Instead, relying on physical
    locations and firmware information, the scheme produces names like
    <code class="literal">ens1</code>, <code class="literal">enp2s0</code>, etc.
  </p><p>
    These names are predictable but less memorable and not necessarily
    stable: for example installing new hardware or changing firmware
    settings can result in a
    <a class="link" href="https://github.com/systemd/systemd/issues/3715#issue-165347602" target="_top">name
    change</a>. If this is undesirable, for example if you have a
    single ethernet card, you can revert to the traditional scheme by
    setting
    <a class="xref" href="options.html#opt-networking.usePredictableInterfaceNames"><code class="option">networking.usePredictableInterfaceNames</code></a> to
    <code class="literal">false</code>.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-custom-ifnames"></a>13.8.1. Assigning custom names</h3></div></div></div><p>
      In case there are multiple interfaces of the same type, it’s
      better to assign custom names based on the device hardware
      address. For example, we assign the name <code class="literal">wan</code> to
      the interface with MAC address
      <code class="literal">52:54:00:12:01:01</code> using a netword link unit:
    </p><pre class="programlisting">
systemd.network.links."10-wan" = {
  matchConfig.PermanentMACAddress = "52:54:00:12:01:01";
  linkConfig.Name = "wan";
};
</pre><p>
      Note that links are directly read by udev, <span class="emphasis"><em>not
      networkd</em></span>, and will work even if networkd is disabled.
    </p><p>
      Alternatively, we can use a plain old udev rule:
    </p><pre class="programlisting">
services.udev.initrdRules = ''
  SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", \
  ATTR{address}=="52:54:00:12:01:01", KERNEL=="eth*", NAME="wan"
'';
</pre><div class="warning"><h3 class="title">Warning</h3><p>
        The rule must be installed in the initrd using
        <code class="literal">services.udev.initrdRules</code>, not the usual
        <code class="literal">services.udev.extraRules</code> option. This is to
        avoid race conditions with other programs controlling the
        interface.
      </p></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-kernel-config"></a>Chapter 14. Linux Kernel</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-linux-config-customizing">14.1. Customize your kernel</a></span></dt><dt><span class="section"><a href="index.html#sec-linux-config-developing-modules">14.2. Developing kernel modules</a></span></dt></dl></div><p>
    You can override the Linux kernel and associated packages using the
    option <code class="literal">boot.kernelPackages</code>. For instance, this
    selects the Linux 3.10 kernel:
  </p><pre class="programlisting">
boot.kernelPackages = pkgs.linuxKernel.packages.linux_3_10;
</pre><p>
    Note that this not only replaces the kernel, but also packages that
    are specific to the kernel version, such as the NVIDIA video
    drivers. This ensures that driver packages are consistent with the
    kernel.
  </p><p>
    While <code class="literal">pkgs.linuxKernel.packages</code> contains all
    available kernel packages, you may want to use one of the
    unversioned <code class="literal">pkgs.linuxPackages_*</code> aliases such as
    <code class="literal">pkgs.linuxPackages_latest</code>, that are kept up to
    date with new versions.
  </p><p>
    The default Linux kernel configuration should be fine for most
    users. You can see the configuration of your current kernel with the
    following command:
  </p><pre class="programlisting">
zcat /proc/config.gz
</pre><p>
    If you want to change the kernel configuration, you can use the
    <code class="literal">packageOverrides</code> feature (see
    <a class="xref" href="index.html#sec-customising-packages" title="6.1.1. Customising Packages">Section 6.1.1, “Customising Packages”</a>). For instance, to
    enable support for the kernel debugger KGDB:
  </p><pre class="programlisting">
nixpkgs.config.packageOverrides = pkgs: pkgs.lib.recursiveUpdate pkgs {
  linuxKernel.kernels.linux_5_10 = pkgs.linuxKernel.kernels.linux_5_10.override {
    extraConfig = ''
      KGDB y
    '';
  };
};
</pre><p>
    <code class="literal">extraConfig</code> takes a list of Linux kernel
    configuration options, one per line. The name of the option should
    not include the prefix <code class="literal">CONFIG_</code>. The option value
    is typically <code class="literal">y</code>, <code class="literal">n</code> or
    <code class="literal">m</code> (to build something as a kernel module).
  </p><p>
    Kernel modules for hardware devices are generally loaded
    automatically by <code class="literal">udev</code>. You can force a module to
    be loaded via <a class="xref" href="options.html#opt-boot.kernelModules"><code class="option">boot.kernelModules</code></a>, e.g.
  </p><pre class="programlisting">
boot.kernelModules = [ "fuse" "kvm-intel" "coretemp" ];
</pre><p>
    If the module is required early during the boot (e.g. to mount the
    root file system), you can use
    <a class="xref" href="options.html#opt-boot.initrd.kernelModules"><code class="option">boot.initrd.kernelModules</code></a>:
  </p><pre class="programlisting">
boot.initrd.kernelModules = [ "cifs" ];
</pre><p>
    This causes the specified modules and their dependencies to be added
    to the initial ramdisk.
  </p><p>
    Kernel runtime parameters can be set through
    <a class="xref" href="options.html#opt-boot.kernel.sysctl"><code class="option">boot.kernel.sysctl</code></a>, e.g.
  </p><pre class="programlisting">
boot.kernel.sysctl."net.ipv4.tcp_keepalive_time" = 120;
</pre><p>
    sets the kernel’s TCP keepalive time to 120 seconds. To see the
    available parameters, run <code class="literal">sysctl -a</code>.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-linux-config-customizing"></a>14.1. Customize your kernel</h2></div></div></div><p>
      The first step before compiling the kernel is to generate an
      appropriate <code class="literal">.config</code> configuration. Either you
      pass your own config via the <code class="literal">configfile</code> setting
      of <code class="literal">linuxKernel.manualConfig</code>:
    </p><pre class="programlisting">
custom-kernel = let base_kernel = linuxKernel.kernels.linux_4_9;
  in super.linuxKernel.manualConfig {
    inherit (super) stdenv hostPlatform;
    inherit (base_kernel) src;
    version = "${base_kernel.version}-custom";

    configfile = /home/me/my_kernel_config;
    allowImportFromDerivation = true;
};
</pre><p>
      You can edit the config with this snippet (by default
      <code class="literal">make menuconfig</code> won't work out of the box on
      nixos):
    </p><pre class="programlisting">
nix-shell -E 'with import &lt;nixpkgs&gt; {}; kernelToOverride.overrideAttrs (o: {nativeBuildInputs=o.nativeBuildInputs ++ [ pkg-config ncurses ];})'
</pre><p>
      or you can let nixpkgs generate the configuration. Nixpkgs
      generates it via answering the interactive kernel utility
      <code class="literal">make config</code>. The answers depend on parameters
      passed to
      <code class="literal">pkgs/os-specific/linux/kernel/generic.nix</code>
      (which you can influence by overriding
      <code class="literal">extraConfig, autoModules, modDirVersion, preferBuiltin, extraConfig</code>).
    </p><pre class="programlisting">
mptcp93.override ({
  name="mptcp-local";

  ignoreConfigErrors = true;
  autoModules = false;
  kernelPreferBuiltin = true;

  enableParallelBuilding = true;

  extraConfig = ''
    DEBUG_KERNEL y
    FRAME_POINTER y
    KGDB y
    KGDB_SERIAL_CONSOLE y
    DEBUG_INFO y
  '';
});
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-linux-config-developing-modules"></a>14.2. Developing kernel modules</h2></div></div></div><p>
      When developing kernel modules it's often convenient to run
      edit-compile-run loop as quickly as possible. See below snippet as
      an example of developing <code class="literal">mellanox</code> drivers.
    </p><pre class="programlisting">
$ nix-build '&lt;nixpkgs&gt;' -A linuxPackages.kernel.dev
$ nix-shell '&lt;nixpkgs&gt;' -A linuxPackages.kernel
$ unpackPhase
$ cd linux-*
$ make -C $dev/lib/modules/*/build M=$(pwd)/drivers/net/ethernet/mellanox modules
# insmod ./drivers/net/ethernet/mellanox/mlx5/core/mlx5_core.ko
</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-subversion"></a>Chapter 15. Subversion</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-subversion-apache-httpd">15.1. Subversion inside Apache HTTP</a></span></dt></dl></div><p>
    <a class="link" href="https://subversion.apache.org/" target="_top">Subversion</a>
    is a centralized version-control system. It can use a
    <a class="link" href="http://svnbook.red-bean.com/en/1.7/svn-book.html#svn.serverconfig.choosing" target="_top">variety
    of protocols</a> for communication between client and server.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-subversion-apache-httpd"></a>15.1. Subversion inside Apache HTTP</h2></div></div></div><p>
      This section focuses on configuring a web-based server on top of
      the Apache HTTP server, which uses
      <a class="link" href="http://www.webdav.org/" target="_top">WebDAV</a>/<a class="link" href="http://www.webdav.org/deltav/WWW10/deltav-intro.htm" target="_top">DeltaV</a>
      for communication.
    </p><p>
      For more information on the general setup, please refer to the
      <a class="link" href="http://svnbook.red-bean.com/en/1.7/svn-book.html#svn.serverconfig.httpd" target="_top">the
      appropriate section of the Subversion book</a>.
    </p><p>
      To configure, include in
      <code class="literal">/etc/nixos/configuration.nix</code> code to activate
      Apache HTTP, setting
      <a class="xref" href="options.html#opt-services.httpd.adminAddr"><code class="option">services.httpd.adminAddr</code></a> appropriately:
    </p><pre class="programlisting">
services.httpd.enable = true;
services.httpd.adminAddr = ...;
networking.firewall.allowedTCPPorts = [ 80 443 ];
</pre><p>
      For a simple Subversion server with basic authentication,
      configure the Subversion module for Apache as follows, setting
      <code class="literal">hostName</code> and <code class="literal">documentRoot</code>
      appropriately, and <code class="literal">SVNParentPath</code> to the parent
      directory of the repositories,
      <code class="literal">AuthzSVNAccessFile</code> to the location of the
      <code class="literal">.authz</code> file describing access permission, and
      <code class="literal">AuthUserFile</code> to the password file.
    </p><pre class="programlisting">
services.httpd.extraModules = [
    # note that order is *super* important here
    { name = "dav_svn"; path = "${pkgs.apacheHttpdPackages.subversion}/modules/mod_dav_svn.so"; }
    { name = "authz_svn"; path = "${pkgs.apacheHttpdPackages.subversion}/modules/mod_authz_svn.so"; }
  ];
  services.httpd.virtualHosts = {
    "svn" = {
       hostName = HOSTNAME;
       documentRoot = DOCUMENTROOT;
       locations."/svn".extraConfig = ''
           DAV svn
           SVNParentPath REPO_PARENT
           AuthzSVNAccessFile ACCESS_FILE
           AuthName "SVN Repositories"
           AuthType Basic
           AuthUserFile PASSWORD_FILE
           Require valid-user
      '';
    }
</pre><p>
      The key <code class="literal">"svn"</code> is just a symbolic name
      identifying the virtual host. The
      <code class="literal">"/svn"</code> in
      <code class="literal">locations."/svn".extraConfig</code> is the
      path underneath which the repositories will be served.
    </p><p>
      <a class="link" href="https://wiki.archlinux.org/index.php/Subversion" target="_top">This
      page</a> explains how to set up the Subversion configuration
      itself. This boils down to the following:
    </p><p>
      Underneath <code class="literal">REPO_PARENT</code> repositories can be set
      up as follows:
    </p><pre class="programlisting">
$ svn create REPO_NAME
</pre><p>
      Repository files need to be accessible by
      <code class="literal">wwwrun</code>:
    </p><pre class="programlisting">
$ chown -R wwwrun:wwwrun REPO_PARENT
</pre><p>
      The password file <code class="literal">PASSWORD_FILE</code> can be created
      as follows:
    </p><pre class="programlisting">
$ htpasswd -cs PASSWORD_FILE USER_NAME
</pre><p>
      Additional users can be set up similarly, omitting the
      <code class="literal">c</code> flag:
    </p><pre class="programlisting">
$ htpasswd -s PASSWORD_FILE USER_NAME
</pre><p>
      The file describing access permissions
      <code class="literal">ACCESS_FILE</code> will look something like the
      following:
    </p><pre class="programlisting">
[/]
* = r

[REPO_NAME:/]
USER_NAME = rw
</pre><p>
      The Subversion repositories will be accessible as
      <code class="literal">http://HOSTNAME/svn/REPO_NAME</code>.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-pantheon"></a>Chapter 16. Pantheon Desktop</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-pantheon-enable">16.1. Enabling Pantheon</a></span></dt><dt><span class="section"><a href="index.html#sec-pantheon-wingpanel-switchboard">16.2. Wingpanel and Switchboard plugins</a></span></dt><dt><span class="section"><a href="index.html#sec-pantheon-faq">16.3. FAQ</a></span></dt></dl></div><p>
  Pantheon is the desktop environment created for the elementary OS distribution. It is written from scratch in Vala, utilizing GNOME technologies with GTK 3 and Granite.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pantheon-enable"></a>16.1. Enabling Pantheon</h2></div></div></div><p>
   All of Pantheon is working in NixOS and the applications should be available, aside from a few <a class="link" href="https://github.com/NixOS/nixpkgs/issues/58161" target="_top">exceptions</a>. To enable Pantheon, set
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.xserver.desktopManager.pantheon.enable"><code class="option">services.xserver.desktopManager.pantheon.enable</code></a> = true;
</pre><p>
   This automatically enables LightDM and Pantheon's LightDM greeter. If you'd like to disable this, set
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.xserver.displayManager.lightdm.greeters.pantheon.enable"><code class="option">services.xserver.displayManager.lightdm.greeters.pantheon.enable</code></a> = false;
<a class="xref" href="options.html#opt-services.xserver.displayManager.lightdm.enable"><code class="option">services.xserver.displayManager.lightdm.enable</code></a> = false;
</pre><p>
   but please be aware using Pantheon without LightDM as a display manager will break screenlocking from the UI. The NixOS module for Pantheon installs all of Pantheon's default applications. If you'd like to not install Pantheon's apps, set
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.pantheon.apps.enable"><code class="option">services.pantheon.apps.enable</code></a> = false;
</pre><p>
   You can also use <a class="xref" href="options.html#opt-environment.pantheon.excludePackages"><code class="option">environment.pantheon.excludePackages</code></a> to remove any other app (like <span class="package">elementary-mail</span>).
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pantheon-wingpanel-switchboard"></a>16.2. Wingpanel and Switchboard plugins</h2></div></div></div><p>
   Wingpanel and Switchboard work differently than they do in other distributions, as far as using plugins. You cannot install a plugin globally (like with <code class="option">environment.systemPackages</code>) to start using it. You should instead be using the following options:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      <a class="xref" href="options.html#opt-services.xserver.desktopManager.pantheon.extraWingpanelIndicators"><code class="option">services.xserver.desktopManager.pantheon.extraWingpanelIndicators</code></a>
     </p></li><li class="listitem"><p>
      <a class="xref" href="options.html#opt-services.xserver.desktopManager.pantheon.extraSwitchboardPlugs"><code class="option">services.xserver.desktopManager.pantheon.extraSwitchboardPlugs</code></a>
     </p></li></ul></div><p>
   to configure the programs with plugs or indicators.
  </p><p>
   The difference in NixOS is both these programs are patched to load plugins from a directory that is the value of an environment variable. All of which is controlled in Nix. If you need to configure the particular packages manually you can override the packages like:
</p><pre class="programlisting">
wingpanel-with-indicators.override {
  indicators = [
    pkgs.some-special-indicator
  ];
};

switchboard-with-plugs.override {
  plugs = [
    pkgs.some-special-plug
  ];
};
</pre><p>
   please note that, like how the NixOS options describe these as extra plugins, this would only add to the default plugins included with the programs. If for some reason you'd like to configure which plugins to use exactly, both packages have an argument for this:
</p><pre class="programlisting">
wingpanel-with-indicators.override {
  useDefaultIndicators = false;
  indicators = specialListOfIndicators;
};

switchboard-with-plugs.override {
  useDefaultPlugs = false;
  plugs = specialListOfPlugs;
};
</pre><p>
   this could be most useful for testing a particular plug-in in isolation.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pantheon-faq"></a>16.3. FAQ</h2></div></div></div><div class="variablelist"><dl class="variablelist"><dt><a id="sec-pantheon-faq-messed-up-theme"></a><span class="term">
     I have switched from a different desktop and Pantheon’s theming looks messed up.
    </span></dt><dd><p>
      Open Switchboard and go to: <span class="guilabel">Administration</span> → <span class="guilabel">About</span> → <span class="guilabel">Restore Default Settings</span> → <span class="guibutton">Restore Settings</span>. This will reset any dconf settings to their Pantheon defaults. Note this could reset certain GNOME specific preferences if that desktop was used prior.
     </p></dd><dt><a id="sec-pantheon-faq-gnome3-and-pantheon"></a><span class="term">
     I cannot enable both GNOME 3 and Pantheon.
    </span></dt><dd><p>
      This is a known <a class="link" href="https://github.com/NixOS/nixpkgs/issues/64611" target="_top">issue</a> and there is no known workaround.
     </p></dd><dt><a id="sec-pantheon-faq-appcenter"></a><span class="term">
     Does AppCenter work, or is it available?
    </span></dt><dd><p>
      AppCenter has been available since 20.03. Starting from 21.11, the Flatpak backend should work so you can install some Flatpak applications using it. However, due to missing appstream metadata, the Packagekit backend does not function currently. See this <a class="link" href="https://github.com/NixOS/nixpkgs/issues/15932" target="_top">issue</a>.
     </p><p>
      If you are using Pantheon, AppCenter should be installed by default if you have <a class="link" href="index.html#module-services-flatpak" title="Chapter 45. Flatpak">Flatpak support</a> enabled. If you also wish to add the <code class="literal">appcenter</code> Flatpak remote:
     </p><pre class="screen">
<code class="prompt">$ </code>flatpak remote-add --if-not-exists appcenter https://flatpak.elementary.io/repo.flatpakrepo
</pre></dd></dl></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-gnome"></a>Chapter 17. GNOME Desktop</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-gnome-enable">17.1. Enabling GNOME</a></span></dt><dt><span class="section"><a href="index.html#sec-gnome-enable-flashback">17.2. Enabling GNOME Flashback</a></span></dt><dt><span class="section"><a href="index.html#sec-gnome-icons-and-gtk-themes">17.3. Icons and GTK Themes</a></span></dt><dt><span class="section"><a href="index.html#sec-gnome-shell-extensions">17.4. Shell Extensions</a></span></dt><dt><span class="section"><a href="index.html#sec-gnome-gsettings-overrides">17.5. GSettings Overrides</a></span></dt><dt><span class="section"><a href="index.html#sec-gnome-faq">17.6. Frequently Asked Questions</a></span></dt></dl></div><p>
  GNOME provides a simple, yet full-featured desktop environment with a focus on productivity. Its Mutter compositor supports both Wayland and X server, and the GNOME Shell user interface is fully customizable by extensions.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-gnome-enable"></a>17.1. Enabling GNOME</h2></div></div></div><p>
   All of the core apps, optional apps, games, and core developer tools from GNOME are available.
  </p><p>
   To enable the GNOME desktop use:
  </p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.xserver.desktopManager.gnome.enable"><code class="option">services.xserver.desktopManager.gnome.enable</code></a> = true;
<a class="xref" href="options.html#opt-services.xserver.displayManager.gdm.enable"><code class="option">services.xserver.displayManager.gdm.enable</code></a> = true;
</pre><div class="note"><h3 class="title">Note</h3><p>
    While it is not strictly necessary to use GDM as the display manager with GNOME, it is recommended, as some features such as screen lock <a class="link" href="index.html#sec-gnome-faq-can-i-use-lightdm-with-gnome" title="17.6.1. Can I use LightDM with GNOME?">might not work</a> without it.
   </p></div><p>
   The default applications used in NixOS are very minimal, inspired by the defaults used in <a class="link" href="https://gitlab.gnome.org/GNOME/gnome-build-meta/blob/40.0/elements/core/meta-gnome-core-utilities.bst" target="_top">gnome-build-meta</a>.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gnome-without-the-apps"></a>17.1.1. GNOME without the apps</h3></div></div></div><p>
    If you’d like to only use the GNOME desktop and not the apps, you can disable them with:
   </p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.gnome.core-utilities.enable"><code class="option">services.gnome.core-utilities.enable</code></a> = false;
</pre><p>
    and none of them will be installed.
   </p><p>
    If you’d only like to omit a subset of the core utilities, you can use <a class="xref" href="options.html#opt-environment.gnome.excludePackages"><code class="option">environment.gnome.excludePackages</code></a>.
    Note that this mechanism can only exclude core utilities, games and core developer tools.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gnome-disabling-services"></a>17.1.2. Disabling GNOME services</h3></div></div></div><p>
    It is also possible to disable many of the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/b8ec4fd2a4edc4e30d02ba7b1a2cc1358f3db1d5/nixos/modules/services/x11/desktop-managers/gnome.nix#L329-L348" target="_top">core services</a>. For example, if you do not need indexing files, you can disable Tracker with:
   </p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.gnome.tracker-miners.enable"><code class="option">services.gnome.tracker-miners.enable</code></a> = false;
<a class="xref" href="options.html#opt-services.gnome.tracker.enable"><code class="option">services.gnome.tracker.enable</code></a> = false;
</pre><p>
    Note, however, that doing so is not supported and might break some applications. Notably, GNOME Music cannot work without Tracker.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gnome-games"></a>17.1.3. GNOME games</h3></div></div></div><p>
    You can install all of the GNOME games with:
   </p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.gnome.games.enable"><code class="option">services.gnome.games.enable</code></a> = true;
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gnome-core-developer-tools"></a>17.1.4. GNOME core developer tools</h3></div></div></div><p>
    You can install GNOME core developer tools with:
   </p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.gnome.core-developer-tools.enable"><code class="option">services.gnome.core-developer-tools.enable</code></a> = true;
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-gnome-enable-flashback"></a>17.2. Enabling GNOME Flashback</h2></div></div></div><p>
   GNOME Flashback provides a desktop environment based on the classic GNOME 2 architecture. You can enable the default GNOME Flashback session, which uses the Metacity window manager, with:
  </p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.xserver.desktopManager.gnome.flashback.enableMetacity"><code class="option">services.xserver.desktopManager.gnome.flashback.enableMetacity</code></a> = true;
</pre><p>
   It is also possible to create custom sessions that replace Metacity with a different window manager using <a class="xref" href="options.html#opt-services.xserver.desktopManager.gnome.flashback.customSessions"><code class="option">services.xserver.desktopManager.gnome.flashback.customSessions</code></a>.
  </p><p>
   The following example uses <code class="literal">xmonad</code> window manager:
  </p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.xserver.desktopManager.gnome.flashback.customSessions"><code class="option">services.xserver.desktopManager.gnome.flashback.customSessions</code></a> = [
  {
    wmName = "xmonad";
    wmLabel = "XMonad";
    wmCommand = "${pkgs.haskellPackages.xmonad}/bin/xmonad";
    enableGnomePanel = false;
  }
];
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-gnome-icons-and-gtk-themes"></a>17.3. Icons and GTK Themes</h2></div></div></div><p>
   Icon themes and GTK themes don’t require any special option to install in NixOS.
  </p><p>
   You can add them to <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> and switch to them with GNOME Tweaks.
   If you’d like to do this manually in dconf, change the values of the following keys:
  </p><pre class="programlisting">
/org/gnome/desktop/interface/gtk-theme
/org/gnome/desktop/interface/icon-theme
</pre><p>
   in <code class="literal">dconf-editor</code>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-gnome-shell-extensions"></a>17.4. Shell Extensions</h2></div></div></div><p>
   Most Shell extensions are packaged under the <code class="literal">gnomeExtensions</code> attribute.
   Some packages that include Shell extensions, like <code class="literal">gnome.gpaste</code>, don’t have their extension decoupled under this attribute.
  </p><p>
   You can install them like any other package:
  </p><pre class="programlisting">
<a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> = [
  gnomeExtensions.dash-to-dock
  gnomeExtensions.gsconnect
  gnomeExtensions.mpris-indicator-button
];
</pre><p>
   Unfortunately, we lack a way for these to be managed in a completely declarative way.
   So you have to enable them manually with an Extensions application.
   It is possible to use a <a class="link" href="index.html#sec-gnome-gsettings-overrides" title="17.5. GSettings Overrides">GSettings override</a> for this on <code class="literal">org.gnome.shell.enabled-extensions</code>, but that will only influence the default value.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-gnome-gsettings-overrides"></a>17.5. GSettings Overrides</h2></div></div></div><p>
   Majority of software building on the GNOME platform use GLib’s <a class="link" href="https://developer.gnome.org/gio/unstable/GSettings.html" target="_top">GSettings</a> system to manage runtime configuration. For our purposes, the system consists of XML schemas describing the individual configuration options, stored in the package, and a settings backend, where the values of the settings are stored. On NixOS, like on most Linux distributions, dconf database is used as the backend.
  </p><p>
   <a class="link" href="https://developer.gnome.org/gio/unstable/GSettings.html#id-1.4.19.2.9.25" target="_top">GSettings vendor overrides</a> can be used to adjust the default values for settings of the GNOME desktop and apps by replacing the default values specified in the XML schemas. Using overrides will allow you to pre-seed user settings before you even start the session.
  </p><div class="warning"><h3 class="title">Warning</h3><p>
    Overrides really only change the default values for GSettings keys so if you or an application changes the setting value, the value set by the override will be ignored. Until <a class="link" href="https://github.com/NixOS/nixpkgs/issues/54150" target="_top">NixOS’s dconf module implements changing values</a>, you will either need to keep that in mind and clear the setting from the backend using <code class="literal">dconf reset</code> command when that happens, or use the <a class="link" href="https://nix-community.github.io/home-manager/options.html#opt-dconf.settings" target="_top">module from home-manager</a>.
   </p></div><p>
   You can override the default GSettings values using the <a class="xref" href="options.html#opt-services.xserver.desktopManager.gnome.extraGSettingsOverrides"><code class="option">services.xserver.desktopManager.gnome.extraGSettingsOverrides</code></a> option.
  </p><p>
   Take note that whatever packages you want to override GSettings for, you need to add them to
   <a class="xref" href="options.html#opt-services.xserver.desktopManager.gnome.extraGSettingsOverridePackages"><code class="option">services.xserver.desktopManager.gnome.extraGSettingsOverridePackages</code></a>.
  </p><p>
   You can use <code class="literal">dconf-editor</code> tool to explore which GSettings you can set.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gnome-gsettings-overrides-example"></a>17.5.1. Example</h3></div></div></div><pre class="programlisting">
services.xserver.desktopManager.gnome = {
  <a class="link" href="options.html#opt-services.xserver.desktopManager.gnome.extraGSettingsOverrides">extraGSettingsOverrides</a> = ''
    # Change default background
    [org.gnome.desktop.background]
    picture-uri='file://${pkgs.nixos-artwork.wallpapers.mosaic-blue.gnomeFilePath}'

    # Favorite apps in gnome-shell
    [org.gnome.shell]
    favorite-apps=['org.gnome.Photos.desktop', 'org.gnome.Nautilus.desktop']
  '';

  <a class="link" href="options.html#opt-services.xserver.desktopManager.gnome.extraGSettingsOverridePackages">extraGSettingsOverridePackages</a> = [
    pkgs.gsettings-desktop-schemas # for org.gnome.desktop
    pkgs.gnome.gnome-shell # for org.gnome.shell
  ];
};
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-gnome-faq"></a>17.6. Frequently Asked Questions</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gnome-faq-can-i-use-lightdm-with-gnome"></a>17.6.1. Can I use LightDM with GNOME?</h3></div></div></div><p>
    Yes you can, and any other display-manager in NixOS.
   </p><p>
    However, it doesn’t work correctly for the Wayland session of GNOME Shell yet, and
    won’t be able to lock your screen.
   </p><p>
    See <a class="link" href="https://github.com/NixOS/nixpkgs/issues/56342" target="_top">this issue.</a>
   </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-matomo"></a>Chapter 18. Matomo</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-matomo-database-setup">18.1. Database Setup</a></span></dt><dt><span class="section"><a href="index.html#module-services-matomo-archive-processing">18.2. Archive Processing</a></span></dt><dt><span class="section"><a href="index.html#module-services-matomo-backups">18.3. Backup</a></span></dt><dt><span class="section"><a href="index.html#module-services-matomo-issues">18.4. Issues</a></span></dt><dt><span class="section"><a href="index.html#module-services-matomo-other-web-servers">18.5. Using other Web Servers than nginx</a></span></dt></dl></div><p>
  Matomo is a real-time web analytics application. This module configures
  php-fpm as backend for Matomo, optionally configuring an nginx vhost as well.
 </p><p>
  An automatic setup is not suported by Matomo, so you need to configure Matomo
  itself in the browser-based Matomo setup.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-matomo-database-setup"></a>18.1. Database Setup</h2></div></div></div><p>
   You also need to configure a MariaDB or MySQL database and -user for Matomo
   yourself, and enter those credentials in your browser. You can use
   passwordless database authentication via the UNIX_SOCKET authentication
   plugin with the following SQL commands:
</p><pre class="programlisting">
# For MariaDB
INSTALL PLUGIN unix_socket SONAME 'auth_socket';
CREATE DATABASE matomo;
CREATE USER 'matomo'@'localhost' IDENTIFIED WITH unix_socket;
GRANT ALL PRIVILEGES ON matomo.* TO 'matomo'@'localhost';

# For MySQL
INSTALL PLUGIN auth_socket SONAME 'auth_socket.so';
CREATE DATABASE matomo;
CREATE USER 'matomo'@'localhost' IDENTIFIED WITH auth_socket;
GRANT ALL PRIVILEGES ON matomo.* TO 'matomo'@'localhost';
</pre><p>
   Then fill in <code class="literal">matomo</code> as database user and database name,
   and leave the password field blank. This authentication works by allowing
   only the <code class="literal">matomo</code> unix user to authenticate as the
   <code class="literal">matomo</code> database user (without needing a password), but no
   other users. For more information on passwordless login, see
   <a class="link" href="https://mariadb.com/kb/en/mariadb/unix_socket-authentication-plugin/" target="_top">https://mariadb.com/kb/en/mariadb/unix_socket-authentication-plugin/</a>.
  </p><p>
   Of course, you can use password based authentication as well, e.g. when the
   database is not on the same host.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-matomo-archive-processing"></a>18.2. Archive Processing</h2></div></div></div><p>
   This module comes with the systemd service
   <code class="literal">matomo-archive-processing.service</code> and a timer that
   automatically triggers archive processing every hour. This means that you
   can safely
   <a class="link" href="https://matomo.org/docs/setup-auto-archiving/#disable-browser-triggers-for-matomo-archiving-and-limit-matomo-reports-to-updating-every-hour" target="_top">
   disable browser triggers for Matomo archiving </a> at
   <code class="literal">Administration &gt; System &gt; General Settings</code>.
  </p><p>
   With automatic archive processing, you can now also enable to
   <a class="link" href="https://matomo.org/docs/privacy/#step-2-delete-old-visitors-logs" target="_top">
   delete old visitor logs </a> at <code class="literal">Administration &gt; System &gt;
   Privacy</code>, but make sure that you run <code class="literal">systemctl start
   matomo-archive-processing.service</code> at least once without errors if
   you have already collected data before, so that the reports get archived
   before the source data gets deleted.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-matomo-backups"></a>18.3. Backup</h2></div></div></div><p>
   You only need to take backups of your MySQL database and the
   <code class="filename">/var/lib/matomo/config/config.ini.php</code> file. Use a user
   in the <code class="literal">matomo</code> group or root to access the file. For more
   information, see
   <a class="link" href="https://matomo.org/faq/how-to-install/faq_138/" target="_top">https://matomo.org/faq/how-to-install/faq_138/</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-matomo-issues"></a>18.4. Issues</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Matomo will warn you that the JavaScript tracker is not writable. This is
     because it's located in the read-only nix store. You can safely ignore
     this, unless you need a plugin that needs JavaScript tracker access.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-matomo-other-web-servers"></a>18.5. Using other Web Servers than nginx</h2></div></div></div><p>
   You can use other web servers by forwarding calls for
   <code class="filename">index.php</code> and <code class="filename">piwik.php</code> to the
   <code class="literal"><a class="link" href="options.html#opt-services.phpfpm.pools._name_.socket">services.phpfpm.pools.&lt;name&gt;.socket</a></code> fastcgi unix socket. You can use
   the nginx configuration in the module code as a reference to what else
   should be configured.
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-plausible"></a>Chapter 19. Plausible</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-plausible-basic-usage">19.1. Basic Usage</a></span></dt></dl></div><p>
  <a class="link" href="https://plausible.io/" target="_top">Plausible</a> is a privacy-friendly alternative to
  Google analytics.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-plausible-basic-usage"></a>19.1. Basic Usage</h2></div></div></div><p>
   At first, a secret key is needed to be generated. This can be done with e.g.
   </p><pre class="screen"><code class="prompt">$ </code>openssl rand -base64 64</pre><p>
  </p><p>
   After that, <span class="package">plausible</span> can be deployed like this:
</p><pre class="programlisting">{
  services.plausible = {
    <a class="link" href="options.html#opt-services.plausible.enable">enable</a> = true;
    adminUser = {
      <a class="link" href="options.html#opt-services.plausible.adminUser.activate">activate</a> = true; <a id="ex-plausible-cfg-activate"></a><span><img src="images/callouts/1.svg" alt="1" border="0" /></span>
      <a class="link" href="options.html#opt-services.plausible.adminUser.email">email</a> = "admin@localhost";
      <a class="link" href="options.html#opt-services.plausible.adminUser.passwordFile">passwordFile</a> = "/run/secrets/plausible-admin-pwd";
    };
    server = {
      <a class="link" href="options.html#opt-services.plausible.server.baseUrl">baseUrl</a> = "http://analytics.example.org";
      <a class="link" href="options.html#opt-services.plausible.server.secretKeybaseFile">secretKeybaseFile</a> = "/run/secrets/plausible-secret-key-base"; <a id="ex-plausible-cfg-secretbase"></a><span><img src="images/callouts/2.svg" alt="2" border="0" /></span>
    };
  };
}</pre><p>
   </p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#ex-plausible-cfg-activate"><span><img src="images/callouts/1.svg" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
      <code class="varname">activate</code> is used to skip the email verification of the admin-user that's
      automatically created by <span class="package">plausible</span>. This is only supported if
      <span class="package">postgresql</span> is configured by the module. This is done by default, but
      can be turned off with <a class="xref" href="options.html#opt-services.plausible.database.postgres.setup"><code class="option">services.plausible.database.postgres.setup</code></a>.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#ex-plausible-cfg-secretbase"><span><img src="images/callouts/2.svg" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
      <code class="varname">secretKeybaseFile</code> is a path to the file which contains the secret generated
      with <span class="package">openssl</span> as described above.
     </p></td></tr></table></div><p>
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-pict-rs"></a>Chapter 20. Pict-rs</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-pict-rs-quickstart">20.1. Quickstart</a></span></dt><dt><span class="section"><a href="index.html#module-services-pict-rs-usage">20.2. Usage</a></span></dt><dt><span class="section"><a href="index.html#module-services-pict-rs-missing">20.3. Missing</a></span></dt></dl></div><p>
    pict-rs is a a simple image hosting service.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-pict-rs-quickstart"></a>20.1. Quickstart</h2></div></div></div><p>
      the minimum to start pict-rs is
    </p><pre class="programlisting">
services.pict-rs.enable = true;
</pre><p>
      this will start the http server on port 8080 by default.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-pict-rs-usage"></a>20.2. Usage</h2></div></div></div><p>
      pict-rs offers the following endpoints: -
      <code class="literal">POST /image</code> for uploading an image. Uploaded
      content must be valid multipart/form-data with an image array
      located within the <code class="literal">images[]</code> key
    </p><pre class="programlisting">
This endpoint returns the following JSON structure on success with a 201 Created status
```json
{
    "files": [
        {
            "delete_token": "JFvFhqJA98",
            "file": "lkWZDRvugm.jpg"
        },
        {
            "delete_token": "kAYy9nk2WK",
            "file": "8qFS0QooAn.jpg"
        },
        {
            "delete_token": "OxRpM3sf0Y",
            "file": "1hJaYfGE01.jpg"
        }
    ],
    "msg": "ok"
}
```
</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="literal">GET /image/download?url=...</code> Download an
          image from a remote server, returning the same JSON payload as
          the <code class="literal">POST</code> endpoint
        </p></li><li class="listitem"><p>
          <code class="literal">GET /image/original/{file}</code> for getting a
          full-resolution image. <code class="literal">file</code> here is the
          <code class="literal">file</code> key from the <code class="literal">/image</code>
          endpoint’s JSON
        </p></li><li class="listitem"><p>
          <code class="literal">GET /image/details/original/{file}</code> for
          getting the details of a full-resolution image. The returned
          JSON is structured like so:
          <code class="literal">json     {         "width": 800,         "height": 537,         "content_type": "image/webp",         "created_at": [             2020,             345,             67376,             394363487         ]     }</code>
        </p></li><li class="listitem"><p>
          <code class="literal">GET /image/process.{ext}?src={file}&amp;...</code>
          get a file with transformations applied. existing
          transformations include
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
              <code class="literal">identity=true</code>: apply no changes
            </p></li><li class="listitem"><p>
              <code class="literal">blur={float}</code>: apply a gaussian blur to
              the file
            </p></li><li class="listitem"><p>
              <code class="literal">thumbnail={int}</code>: produce a thumbnail of
              the image fitting inside an <code class="literal">{int}</code> by
              <code class="literal">{int}</code> square using raw pixel sampling
            </p></li><li class="listitem"><p>
              <code class="literal">resize={int}</code>: produce a thumbnail of
              the image fitting inside an <code class="literal">{int}</code> by
              <code class="literal">{int}</code> square using a Lanczos2 filter.
              This is slower than sampling but looks a bit better in
              some cases
            </p></li><li class="listitem"><p>
              <code class="literal">crop={int-w}x{int-h}</code>: produce a cropped
              version of the image with an <code class="literal">{int-w}</code> by
              <code class="literal">{int-h}</code> aspect ratio. The resulting
              crop will be centered on the image. Either the width or
              height of the image will remain full-size, depending on
              the image’s aspect ratio and the requested aspect ratio.
              For example, a 1600x900 image cropped with a 1x1 aspect
              ratio will become 900x900. A 1600x1100 image cropped with
              a 16x9 aspect ratio will become 1600x900.
            </p></li></ul></div><p>
          Supported <code class="literal">ext</code> file extensions include
          <code class="literal">png</code>, <code class="literal">jpg</code>, and
          <code class="literal">webp</code>
        </p><p>
          An example of usage could be
          <code class="literal">GET /image/process.jpg?src=asdf.png&amp;thumbnail=256&amp;blur=3.0</code>
          which would create a 256x256px JPEG thumbnail and blur it
        </p></li><li class="listitem"><p>
          <code class="literal">GET /image/details/process.{ext}?src={file}&amp;...</code>
          for getting the details of a processed image. The returned
          JSON is the same format as listed for the full-resolution
          details endpoint.
        </p></li><li class="listitem"><p>
          <code class="literal">DELETE /image/delete/{delete_token}/{file}</code>
          or <code class="literal">GET /image/delete/{delete_token}/{file}</code>
          to delete a file, where <code class="literal">delete_token</code> and
          <code class="literal">file</code> are from the <code class="literal">/image</code>
          endpoint’s JSON
        </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-pict-rs-missing"></a>20.3. Missing</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          Configuring the secure-api-key is not included yet. The
          envisioned basic use case is consumption on localhost by other
          services without exposing the service to the internet.
        </p></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-nextcloud"></a>Chapter 21. Nextcloud</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-nextcloud-basic-usage">21.1. Basic usage</a></span></dt><dt><span class="section"><a href="index.html#module-services-nextcloud-pitfalls-during-upgrade">21.2. Common problems</a></span></dt><dt><span class="section"><a href="index.html#module-services-nextcloud-httpd">21.3. Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)</a></span></dt><dt><span class="section"><a href="index.html#installing-apps-php-extensions-nextcloud">21.4. Installing Apps and PHP extensions</a></span></dt><dt><span class="section"><a href="index.html#module-services-nextcloud-maintainer-info">21.5. Maintainer information</a></span></dt></dl></div><p>
  <a class="link" href="https://nextcloud.com/" target="_top">Nextcloud</a> is an open-source,
  self-hostable cloud platform. The server setup can be automated using
  <a class="link" href="options.html#opt-services.nextcloud.enable">services.nextcloud</a>. A
  desktop client is packaged at <code class="literal">pkgs.nextcloud-client</code>.
 </p><p>
  The current default by NixOS is <span class="package">nextcloud23</span> which is also the latest
  major version available.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-nextcloud-basic-usage"></a>21.1. Basic usage</h2></div></div></div><p>
   Nextcloud is a PHP-based application which requires an HTTP server
   (<code class="literal"><a class="link" href="options.html#opt-services.nextcloud.enable">services.nextcloud</a></code>
   optionally supports
   <code class="literal"><a class="link" href="options.html#opt-services.nginx.enable">services.nginx</a></code>)
   and a database (it's recommended to use
   <code class="literal"><a class="link" href="options.html#opt-services.postgresql.enable">services.postgresql</a></code>).
  </p><p>
   A very basic configuration may look like this:
</p><pre class="programlisting">{ pkgs, ... }:
{
  services.nextcloud = {
    <a class="link" href="options.html#opt-services.nextcloud.enable">enable</a> = true;
    <a class="link" href="options.html#opt-services.nextcloud.hostName">hostName</a> = "nextcloud.tld";
    config = {
      <a class="link" href="options.html#opt-services.nextcloud.config.dbtype">dbtype</a> = "pgsql";
      <a class="link" href="options.html#opt-services.nextcloud.config.dbuser">dbuser</a> = "nextcloud";
      <a class="link" href="options.html#opt-services.nextcloud.config.dbhost">dbhost</a> = "/run/postgresql"; # nextcloud will add /.s.PGSQL.5432 by itself
      <a class="link" href="options.html#opt-services.nextcloud.config.dbname">dbname</a> = "nextcloud";
      <a class="link" href="options.html#opt-services.nextcloud.config.adminpassFile">adminpassFile</a> = "/path/to/admin-pass-file";
      <a class="link" href="options.html#opt-services.nextcloud.config.adminuser">adminuser</a> = "root";
    };
  };

  services.postgresql = {
    <a class="link" href="options.html#opt-services.postgresql.enable">enable</a> = true;
    <a class="link" href="options.html#opt-services.postgresql.ensureDatabases">ensureDatabases</a> = [ "nextcloud" ];
    <a class="link" href="options.html#opt-services.postgresql.ensureUsers">ensureUsers</a> = [
     { name = "nextcloud";
       ensurePermissions."DATABASE nextcloud" = "ALL PRIVILEGES";
     }
    ];
  };

  # ensure that postgres is running *before* running the setup
  systemd.services."nextcloud-setup" = {
    requires = ["postgresql.service"];
    after = ["postgresql.service"];
  };

  <a class="link" href="options.html#opt-networking.firewall.allowedTCPPorts">networking.firewall.allowedTCPPorts</a> = [ 80 443 ];
}</pre><p>
  </p><p>
   The <code class="literal">hostName</code> option is used internally to configure an HTTP
   server using <code class="literal"><a class="link" href="https://php-fpm.org/" target="_top">PHP-FPM</a></code>
   and <code class="literal">nginx</code>. The <code class="literal">config</code> attribute set is
   used by the imperative installer and all values are written to an additional file
   to ensure that changes can be applied by changing the module's options.
  </p><p>
   In case the application serves multiple domains (those are checked with
   <code class="literal"><a class="link" href="http://php.net/manual/en/reserved.variables.server.php" target="_top">$_SERVER['HTTP_HOST']</a></code>)
   it's needed to add them to
   <code class="literal"><a class="link" href="options.html#opt-services.nextcloud.config.extraTrustedDomains">services.nextcloud.config.extraTrustedDomains</a></code>.
  </p><p>
   Auto updates for Nextcloud apps can be enabled using
   <code class="literal"><a class="link" href="options.html#opt-services.nextcloud.autoUpdateApps.enable">services.nextcloud.autoUpdateApps</a></code>.
</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-nextcloud-pitfalls-during-upgrade"></a>21.2. Common problems</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><strong>General notes. </strong>
      Unfortunately Nextcloud appears to be very stateful when it comes to
      managing its own configuration. The config file lives in the home directory
      of the <code class="literal">nextcloud</code> user (by default
      <code class="literal">/var/lib/nextcloud/config/config.php</code>) and is also used to
      track several states of the application (e.g., whether installed or not).
     </p><p>
     All configuration parameters are also stored in
     <code class="filename">/var/lib/nextcloud/config/override.config.php</code> which is generated by
     the module and linked from the store to ensure that all values from
     <code class="filename">config.php</code> can be modified by the module.
     However <code class="filename">config.php</code> manages the application's state and shouldn't be
     touched manually because of that.
    </p><div class="warning"><h3 class="title">Warning</h3><p>Don't delete <code class="filename">config.php</code>! This file
     tracks the application's state and a deletion can cause unwanted
     side-effects!</p></div><div class="warning"><h3 class="title">Warning</h3><p>Don't rerun <code class="literal">nextcloud-occ
     maintenance:install</code>! This command tries to install the application
     and can cause unwanted side-effects!</p></div></li><li class="listitem"><p><strong>Multiple version upgrades. </strong>
      Nextcloud doesn't allow to move more than one major-version forward. E.g., if you're on
      <code class="literal">v16</code>, you cannot upgrade to <code class="literal">v18</code>, you need to upgrade to
      <code class="literal">v17</code> first. This is ensured automatically as long as the
      <a class="link" href="options.html#opt-system.stateVersion">stateVersion</a> is declared properly. In that case
      the oldest version available (one major behind the one from the previous NixOS
      release) will be selected by default and the module will generate a warning that reminds
      the user to upgrade to latest Nextcloud <span class="emphasis"><em>after</em></span> that deploy.
     </p></li><li class="listitem"><p><strong><code class="literal">Error: Command "upgrade" is not defined.</code> </strong>
      This error usually occurs if the initial installation
      (<span class="command"><strong>nextcloud-occ maintenance:install</strong></span>) has failed. After that, the application
      is not installed, but the upgrade is attempted to be executed. Further context can
      be found in <a class="link" href="https://github.com/NixOS/nixpkgs/issues/111175" target="_top">NixOS/nixpkgs#111175</a>.
     </p><p>
     First of all, it makes sense to find out what went wrong by looking at the logs
     of the installation via <span class="command"><strong>journalctl -u nextcloud-setup</strong></span> and try to fix
     the underlying issue.
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
       If this occurs on an <span class="emphasis"><em>existing</em></span> setup, this is most likely because
       the maintenance mode is active. It can be deactivated by running
       <span class="command"><strong>nextcloud-occ maintenance:mode --off</strong></span>. It's advisable though to
       check the logs first on why the maintenance mode was activated.
      </p></li><li class="listitem"><div class="warning"><h3 class="title">Warning</h3><p>Only perform the following measures on
      <span class="emphasis"><em>freshly installed instances!</em></span></p></div><p>
       A re-run of the installer can be forced by <span class="emphasis"><em>deleting</em></span>
       <code class="filename">/var/lib/nextcloud/config/config.php</code>. This is the only time
       advisable because the fresh install doesn't have any state that can be lost.
       In case that doesn't help, an entire re-creation can be forced via
       <span class="command"><strong>rm -rf ~nextcloud/</strong></span>.
      </p></li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-nextcloud-httpd"></a>21.3. Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)</h2></div></div></div><p>
   By default, <span class="package">nginx</span> is used as reverse-proxy for <span class="package">nextcloud</span>.
   However, it's possible to use e.g. <span class="package">httpd</span> by explicitly disabling
   <span class="package">nginx</span> using <a class="xref" href="options.html#opt-services.nginx.enable"><code class="option">services.nginx.enable</code></a> and fixing the
   settings <code class="literal">listen.owner</code> &amp; <code class="literal">listen.group</code> in the
   <a class="link" href="options.html#opt-services.phpfpm.pools">corresponding <code class="literal">phpfpm</code> pool</a>.
  </p><p>
   An exemplary configuration may look like this:
</p><pre class="programlisting">{ config, lib, pkgs, ... }: {
  <a class="link" href="options.html#opt-services.nginx.enable">services.nginx.enable</a> = false;
  services.nextcloud = {
    <a class="link" href="options.html#opt-services.nextcloud.enable">enable</a> = true;
    <a class="link" href="options.html#opt-services.nextcloud.hostName">hostName</a> = "localhost";

    /* further, required options */
  };
  <a class="link" href="options.html#opt-services.phpfpm.pools._name_.settings">services.phpfpm.pools.nextcloud.settings</a> = {
    "listen.owner" = config.services.httpd.user;
    "listen.group" = config.services.httpd.group;
  };
  services.httpd = {
    <a class="link" href="options.html#opt-services.httpd.enable">enable</a> = true;
    <a class="link" href="options.html#opt-services.httpd.adminAddr">adminAddr</a> = "webmaster@localhost";
    <a class="link" href="options.html#opt-services.httpd.extraModules">extraModules</a> = [ "proxy_fcgi" ];
    virtualHosts."localhost" = {
      <a class="link" href="options.html#opt-services.httpd.virtualHosts._name_.documentRoot">documentRoot</a> = config.services.nextcloud.package;
      <a class="link" href="options.html#opt-services.httpd.virtualHosts._name_.extraConfig">extraConfig</a> = ''
        &lt;Directory "${config.services.nextcloud.package}"&gt;
          &lt;FilesMatch "\.php$"&gt;
            &lt;If "-f %{REQUEST_FILENAME}"&gt;
              SetHandler "proxy:unix:${config.services.phpfpm.pools.nextcloud.socket}|fcgi://localhost/"
            &lt;/If&gt;
          &lt;/FilesMatch&gt;
          &lt;IfModule mod_rewrite.c&gt;
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.php$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.php [L]
          &lt;/IfModule&gt;
          DirectoryIndex index.php
          Require all granted
          Options +FollowSymLinks
        &lt;/Directory&gt;
      '';
    };
  };
}</pre><p>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="installing-apps-php-extensions-nextcloud"></a>21.4. Installing Apps and PHP extensions</h2></div></div></div><p>
   Nextcloud apps are installed statefully through the web interface.

   Some apps may require extra PHP extensions to be installed.
   This can be configured with the <a class="xref" href="options.html#opt-services.nextcloud.phpExtraExtensions"><code class="option">services.nextcloud.phpExtraExtensions</code></a> setting.
  </p><p>
   Alternatively, extra apps can also be declared with the <a class="xref" href="options.html#opt-services.nextcloud.extraApps"><code class="option">services.nextcloud.extraApps</code></a> setting.
   When using this setting, apps can no longer be managed statefully because this can lead to Nextcloud updating apps
   that are managed by Nix. If you want automatic updates it is recommended that you use web interface to install apps.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-nextcloud-maintainer-info"></a>21.5. Maintainer information</h2></div></div></div><p>
   As stated in the previous paragraph, we must provide a clean upgrade-path for Nextcloud
   since it cannot move more than one major version forward on a single upgrade. This chapter
   adds some notes how Nextcloud updates should be rolled out in the future.
  </p><p>
   While minor and patch-level updates are no problem and can be done directly in the
   package-expression (and should be backported to supported stable branches after that),
   major-releases should be added in a new attribute (e.g. Nextcloud <code class="literal">v19.0.0</code>
   should be available in <code class="literal">nixpkgs</code> as <code class="literal">pkgs.nextcloud19</code>).
   To provide simple upgrade paths it's generally useful to backport those as well to stable
   branches. As long as the package-default isn't altered, this won't break existing setups.
   After that, the versioning-warning in the <code class="literal">nextcloud</code>-module should be
   updated to make sure that the
   <a class="link" href="options.html#opt-services.nextcloud.package">package</a>-option selects the latest version
   on fresh setups.
  </p><p>
   If major-releases will be abandoned by upstream, we should check first if those are needed
   in NixOS for a safe upgrade-path before removing those. In that case we shold keep those
   packages, but mark them as insecure in an expression like this (in
   <code class="literal">&lt;nixpkgs/pkgs/servers/nextcloud/default.nix&gt;</code>):
</p><pre class="programlisting">/* ... */
{
  nextcloud17 = generic {
    version = "17.0.x";
    sha256 = "0000000000000000000000000000000000000000000000000000";
    eol = true;
  };
}</pre><p>
  </p><p>
   Ideally we should make sure that it's possible to jump two NixOS versions forward:
   i.e. the warnings and the logic in the module should guard a user to upgrade from a
   Nextcloud on e.g. 19.09 to a Nextcloud on 20.09.
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-lemmy"></a>Chapter 22. Lemmy</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-lemmy-quickstart">22.1. Quickstart</a></span></dt><dt><span class="section"><a href="index.html#module-services-lemmy-usage">22.2. Usage</a></span></dt><dt><span class="section"><a href="index.html#module-services-lemmy-missing">22.3. Missing</a></span></dt></dl></div><p>
    Lemmy is a federated alternative to reddit in rust.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-lemmy-quickstart"></a>22.1. Quickstart</h2></div></div></div><p>
      the minimum to start lemmy is
    </p><pre class="programlisting">
services.lemmy = {
  enable = true;
  settings = {
    hostname = "lemmy.union.rocks";
    database.createLocally = true;
  };
  jwtSecretPath = "/run/secrets/lemmyJwt";
  caddy.enable = true;
}
</pre><p>
      (note that you can use something like agenix to get your secret
      jwt to the specified path)
    </p><p>
      this will start the backend on port 8536 and the frontend on port
      1234. It will expose your instance with a caddy reverse proxy to
      the hostname you’ve provided. Postgres will be initialized on that
      same instance automatically.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-lemmy-usage"></a>22.2. Usage</h2></div></div></div><p>
      On first connection you will be asked to define an admin user.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-lemmy-missing"></a>22.3. Missing</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          Exposing with nginx is not implemented yet.
        </p></li><li class="listitem"><p>
          This has been tested using a local database with a unix socket
          connection. Using different database settings will likely
          require modifications
        </p></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-keycloak"></a>Chapter 23. Keycloak</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-keycloak-admin">23.1. Administration</a></span></dt><dt><span class="section"><a href="index.html#module-services-keycloak-database">23.2. Database access</a></span></dt><dt><span class="section"><a href="index.html#module-services-keycloak-frontendurl">23.3. Frontend URL</a></span></dt><dt><span class="section"><a href="index.html#module-services-keycloak-tls">23.4. Setting up TLS/SSL</a></span></dt><dt><span class="section"><a href="index.html#module-services-keycloak-themes">23.5. Themes</a></span></dt><dt><span class="section"><a href="index.html#module-services-keycloak-extra-config">23.6. Additional configuration</a></span></dt><dt><span class="section"><a href="index.html#module-services-keycloak-example-config">23.7. Example configuration</a></span></dt></dl></div><p>
   <a class="link" href="https://www.keycloak.org/" target="_top">Keycloak</a> is an
   open source identity and access management server with support for
   <a class="link" href="https://openid.net/connect/" target="_top">OpenID
   Connect</a>, <a class="link" href="https://oauth.net/2/" target="_top">OAUTH
   2.0</a> and <a class="link" href="https://en.wikipedia.org/wiki/SAML_2.0" target="_top">SAML
   2.0</a>.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-keycloak-admin"></a>23.1. Administration</h2></div></div></div><p>
       An administrative user with the username
       <code class="literal">admin</code> is automatically created in the
       <code class="literal">master</code> realm. Its initial password can be
       configured by setting <a class="xref" href="options.html#opt-services.keycloak.initialAdminPassword"><code class="option">services.keycloak.initialAdminPassword</code></a>
       and defaults to <code class="literal">changeme</code>. The password is
       not stored safely and should be changed immediately in the
       admin panel.
     </p><p>
       Refer to the <a class="link" href="https://www.keycloak.org/docs/latest/server_admin/index.html#admin-console" target="_top">Admin
       Console section of the Keycloak Server Administration Guide</a> for
       information on how to administer your
       <span class="productname">Keycloak</span> instance.
     </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-keycloak-database"></a>23.2. Database access</h2></div></div></div><p>
       <span class="productname">Keycloak</span> can be used with either
       <span class="productname">PostgreSQL</span> or
       <span class="productname">MySQL</span>. Which one is used can be
       configured in <a class="xref" href="options.html#opt-services.keycloak.database.type"><code class="option">services.keycloak.database.type</code></a>. The selected
       database will automatically be enabled and a database and role
       created unless <a class="xref" href="options.html#opt-services.keycloak.database.host"><code class="option">services.keycloak.database.host</code></a> is changed from
       its default of <code class="literal">localhost</code> or <a class="xref" href="options.html#opt-services.keycloak.database.createLocally"><code class="option">services.keycloak.database.createLocally</code></a> is set
       to <code class="literal">false</code>.
     </p><p>
       External database access can also be configured by setting
       <a class="xref" href="options.html#opt-services.keycloak.database.host"><code class="option">services.keycloak.database.host</code></a>, <a class="xref" href="options.html#opt-services.keycloak.database.username"><code class="option">services.keycloak.database.username</code></a>, <a class="xref" href="options.html#opt-services.keycloak.database.useSSL"><code class="option">services.keycloak.database.useSSL</code></a> and <a class="xref" href="options.html#opt-services.keycloak.database.caCert"><code class="option">services.keycloak.database.caCert</code></a> as
       appropriate. Note that you need to manually create a database
       called <code class="literal">keycloak</code> and allow the configured
       database user full access to it.
     </p><p>
       <a class="xref" href="options.html#opt-services.keycloak.database.passwordFile"><code class="option">services.keycloak.database.passwordFile</code></a>
       must be set to the path to a file containing the password used
       to log in to the database. If <a class="xref" href="options.html#opt-services.keycloak.database.host"><code class="option">services.keycloak.database.host</code></a>
       and <a class="xref" href="options.html#opt-services.keycloak.database.createLocally"><code class="option">services.keycloak.database.createLocally</code></a>
       are kept at their defaults, the database role
       <code class="literal">keycloak</code> with that password is provisioned
       on the local database instance.
     </p><div class="warning"><h3 class="title">Warning</h3><p>
         The path should be provided as a string, not a Nix path, since Nix
         paths are copied into the world readable Nix store.
       </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-keycloak-frontendurl"></a>23.3. Frontend URL</h2></div></div></div><p>
       The frontend URL is used as base for all frontend requests and
       must be configured through <a class="xref" href="options.html#opt-services.keycloak.frontendUrl"><code class="option">services.keycloak.frontendUrl</code></a>.
       It should normally include a trailing <code class="literal">/auth</code>
       (the default web context). If you use a reverse proxy, you need
       to set this option to <code class="literal">""</code>, so that frontend URL
       is derived from HTTP headers. <code class="literal">X-Forwarded-*</code> headers
       support also should be enabled, using <a class="link" href="https://www.keycloak.org/docs/latest/server_installation/index.html#identifying-client-ip-addresses" target="_top">
       respective guidelines</a>.
     </p><p>
       <a class="xref" href="options.html#opt-services.keycloak.forceBackendUrlToFrontendUrl"><code class="option">services.keycloak.forceBackendUrlToFrontendUrl</code></a>
       determines whether Keycloak should force all requests to go
       through the frontend URL. By default,
       <span class="productname">Keycloak</span> allows backend requests to
       instead use its local hostname or IP address and may also
       advertise it to clients through its OpenID Connect Discovery
       endpoint.
     </p><p>
       See the <a class="link" href="https://www.keycloak.org/docs/latest/server_installation/#_hostname" target="_top">Hostname
       section of the Keycloak Server Installation and Configuration
       Guide</a> for more information.
     </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-keycloak-tls"></a>23.4. Setting up TLS/SSL</h2></div></div></div><p>
       By default, <span class="productname">Keycloak</span> won't accept
       unsecured HTTP connections originating from outside its local
       network.
     </p><p>
       HTTPS support requires a TLS/SSL certificate and a private key,
       both <a class="link" href="https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail" target="_top">PEM
       formatted</a>. Their paths should be set through <a class="xref" href="options.html#opt-services.keycloak.sslCertificate"><code class="option">services.keycloak.sslCertificate</code></a> and <a class="xref" href="options.html#opt-services.keycloak.sslCertificateKey"><code class="option">services.keycloak.sslCertificateKey</code></a>.
     </p><div class="warning"><h3 class="title">Warning</h3><p>
         The paths should be provided as a strings, not a Nix paths,
         since Nix paths are copied into the world readable Nix store.
       </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-keycloak-themes"></a>23.5. Themes</h2></div></div></div><p>
        You can package custom themes and make them visible to Keycloak via
        <a class="xref" href="options.html#opt-services.keycloak.themes"><code class="option">services.keycloak.themes</code></a>
        option. See the <a class="link" href="https://www.keycloak.org/docs/latest/server_development/#_themes" target="_top">
        Themes section of the Keycloak Server Development Guide</a>
        and respective NixOS option description for more information.
     </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-keycloak-extra-config"></a>23.6. Additional configuration</h2></div></div></div><p>
       Additional Keycloak configuration options, for which no
       explicit <span class="productname">NixOS</span> options are provided,
       can be set in <a class="xref" href="options.html#opt-services.keycloak.extraConfig"><code class="option">services.keycloak.extraConfig</code></a>.
     </p><p>
       Options are expressed as a Nix attribute set which matches the
       structure of the jboss-cli configuration. The configuration is
       effectively overlayed on top of the default configuration
       shipped with Keycloak. To remove existing nodes and undefine
       attributes from the default configuration, set them to
       <code class="literal">null</code>.
     </p><p>
       For example, the following script, which removes the hostname
       provider <code class="literal">default</code>, adds the deprecated
       hostname provider <code class="literal">fixed</code> and defines it the
       default:

</p><pre class="programlisting">
/subsystem=keycloak-server/spi=hostname/provider=default:remove()
/subsystem=keycloak-server/spi=hostname/provider=fixed:add(enabled = true, properties = { hostname = "keycloak.example.com" })
/subsystem=keycloak-server/spi=hostname:write-attribute(name=default-provider, value="fixed")
</pre><p>

       would be expressed as

</p><pre class="programlisting">
services.keycloak.extraConfig = {
  "subsystem=keycloak-server" = {
    "spi=hostname" = {
      "provider=default" = null;
      "provider=fixed" = {
        enabled = true;
        properties.hostname = "keycloak.example.com";
      };
      default-provider = "fixed";
    };
  };
};
</pre><p>
     </p><p>
       You can discover available options by using the <a class="link" href="http://docs.wildfly.org/21/Admin_Guide.html#Command_Line_Interface" target="_top">jboss-cli.sh</a>
       program and by referring to the <a class="link" href="https://www.keycloak.org/docs/latest/server_installation/index.html" target="_top">Keycloak
       Server Installation and Configuration Guide</a>.
     </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-keycloak-example-config"></a>23.7. Example configuration</h2></div></div></div><p>
       A basic configuration with some custom settings could look like this:
</p><pre class="programlisting">
services.keycloak = {
  <a class="link" href="options.html#opt-services.keycloak.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.keycloak.initialAdminPassword">initialAdminPassword</a> = "e6Wcm0RrtegMEHl";  # change on first login
  <a class="link" href="options.html#opt-services.keycloak.frontendUrl">frontendUrl</a> = "https://keycloak.example.com/auth";
  <a class="link" href="options.html#opt-services.keycloak.forceBackendUrlToFrontendUrl">forceBackendUrlToFrontendUrl</a> = true;
  <a class="link" href="options.html#opt-services.keycloak.sslCertificate">sslCertificate</a> = "/run/keys/ssl_cert";
  <a class="link" href="options.html#opt-services.keycloak.sslCertificateKey">sslCertificateKey</a> = "/run/keys/ssl_key";
  <a class="link" href="options.html#opt-services.keycloak.database.passwordFile">database.passwordFile</a> = "/run/keys/db_password";
};
</pre><p>
     </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-jitsi-meet"></a>Chapter 24. Jitsi Meet</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-jitsi-basic-usage">24.1. Basic usage</a></span></dt><dt><span class="section"><a href="index.html#module-services-jitsi-configuration">24.2. Configuration</a></span></dt></dl></div><p>
   With Jitsi Meet on NixOS you can quickly configure a complete,
   private, self-hosted video conferencing solution.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-jitsi-basic-usage"></a>24.1. Basic usage</h2></div></div></div><p>
     A minimal configuration using Let's Encrypt for TLS certificates looks like this:
</p><pre class="programlisting">{
  services.jitsi-meet = {
    <a class="link" href="options.html#opt-services.jitsi-meet.enable">enable</a> = true;
    <a class="link" href="options.html#opt-services.jitsi-meet.enable">hostName</a> = "jitsi.example.com";
  };
  <a class="link" href="options.html#opt-services.jitsi-videobridge.openFirewall">services.jitsi-videobridge.openFirewall</a> = true;
  <a class="link" href="options.html#opt-networking.firewall.allowedTCPPorts">networking.firewall.allowedTCPPorts</a> = [ 80 443 ];
  <a class="link" href="options.html#opt-security.acme.defaults.email">security.acme.email</a> = "me@example.com";
  <a class="link" href="options.html#opt-security.acme.acceptTerms">security.acme.acceptTerms</a> = true;
}</pre><p>
   </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-jitsi-configuration"></a>24.2. Configuration</h2></div></div></div><p>
     Here is the minimal configuration with additional configurations:
</p><pre class="programlisting">{
  services.jitsi-meet = {
    <a class="link" href="options.html#opt-services.jitsi-meet.enable">enable</a> = true;
    <a class="link" href="options.html#opt-services.jitsi-meet.enable">hostName</a> = "jitsi.example.com";
    <a class="link" href="options.html#opt-services.jitsi-meet.config">config</a> = {
      enableWelcomePage = false;
      prejoinPageEnabled = true;
      defaultLang = "fi";
    };
    <a class="link" href="options.html#opt-services.jitsi-meet.interfaceConfig">interfaceConfig</a> = {
      SHOW_JITSI_WATERMARK = false;
      SHOW_WATERMARK_FOR_GUESTS = false;
    };
  };
  <a class="link" href="options.html#opt-services.jitsi-videobridge.openFirewall">services.jitsi-videobridge.openFirewall</a> = true;
  <a class="link" href="options.html#opt-networking.firewall.allowedTCPPorts">networking.firewall.allowedTCPPorts</a> = [ 80 443 ];
  <a class="link" href="options.html#opt-security.acme.defaults.email">security.acme.email</a> = "me@example.com";
  <a class="link" href="options.html#opt-security.acme.acceptTerms">security.acme.acceptTerms</a> = true;
}</pre><p>
   </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-grocy"></a>Chapter 25. Grocy</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-grocy-basic-usage">25.1. Basic usage</a></span></dt><dt><span class="section"><a href="index.html#module-services-grocy-settings">25.2. Settings</a></span></dt></dl></div><p>
    <a class="link" href="https://grocy.info/" target="_top">Grocy</a> is a web-based self-hosted groceries
    &amp; household management solution for your home.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-grocy-basic-usage"></a>25.1. Basic usage</h2></div></div></div><p>
    A very basic configuration may look like this:
</p><pre class="programlisting">{ pkgs, ... }:
{
  services.grocy = {
    <a class="link" href="options.html#opt-services.grocy.enable">enable</a> = true;
    <a class="link" href="options.html#opt-services.grocy.hostName">hostName</a> = "grocy.tld";
  };
}</pre><p>
    This configures a simple vhost using <a class="link" href="options.html#opt-services.nginx.enable">nginx</a>
    which listens to <code class="literal">grocy.tld</code> with fully configured ACME/LE (this can be
    disabled by setting <a class="link" href="options.html#opt-services.grocy.nginx.enableSSL">services.grocy.nginx.enableSSL</a>
    to <code class="literal">false</code>). After the initial setup the credentials <code class="literal">admin:admin</code>
    can be used to login.
   </p><p>
    The application's state is persisted at <code class="literal">/var/lib/grocy/grocy.db</code> in a
    <span class="package">sqlite3</span> database. The migration is applied when requesting the <code class="literal">/</code>-route
    of the application.
   </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-grocy-settings"></a>25.2. Settings</h2></div></div></div><p>
    The configuration for <code class="literal">grocy</code> is located at <code class="literal">/etc/grocy/config.php</code>.
    By default, the following settings can be defined in the NixOS-configuration:
</p><pre class="programlisting">{ pkgs, ... }:
{
  services.grocy.settings = {
    # The default currency in the system for invoices etc.
    # Please note that exchange rates aren't taken into account, this
    # is just the setting for what's shown in the frontend.
    <a class="link" href="options.html#opt-services.grocy.settings.currency">currency</a> = "EUR";

    # The display language (and locale configuration) for grocy.
    <a class="link" href="options.html#opt-services.grocy.settings.currency">culture</a> = "de";

    calendar = {
      # Whether or not to show the week-numbers
      # in the calendar.
      <a class="link" href="options.html#opt-services.grocy.settings.calendar.showWeekNumber">showWeekNumber</a> = true;

      # Index of the first day to be shown in the calendar (0=Sunday, 1=Monday,
      # 2=Tuesday and so on).
      <a class="link" href="options.html#opt-services.grocy.settings.calendar.firstDayOfWeek">firstDayOfWeek</a> = 2;
    };
  };
}</pre><p>
   </p><p>
    If you want to alter the configuration file on your own, you can do this manually with
    an expression like this:
</p><pre class="programlisting">{ lib, ... }:
{
  environment.etc."grocy/config.php".text = lib.mkAfter ''
    // Arbitrary PHP code in grocy's configuration file
  '';
}</pre><p>
   </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-discourse"></a>Chapter 26. Discourse</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-discourse-basic-usage">26.1. Basic usage</a></span></dt><dt><span class="section"><a href="index.html#module-services-discourse-tls">26.2. Using a regular TLS certificate</a></span></dt><dt><span class="section"><a href="index.html#module-services-discourse-database">26.3. Database access</a></span></dt><dt><span class="section"><a href="index.html#module-services-discourse-mail">26.4. Email</a></span></dt><dt><span class="section"><a href="index.html#module-services-discourse-settings">26.5. Additional settings</a></span></dt><dt><span class="section"><a href="index.html#module-services-discourse-plugins">26.6. Plugins</a></span></dt></dl></div><p>
   <a class="link" href="https://www.discourse.org/" target="_top">Discourse</a> is a
   modern and open source discussion platform.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-discourse-basic-usage"></a>26.1. Basic usage</h2></div></div></div><p>
     A minimal configuration using Let's Encrypt for TLS certificates looks like this:
</p><pre class="programlisting">
services.discourse = {
  <a class="link" href="options.html#opt-services.discourse.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.discourse.hostname">hostname</a> = "discourse.example.com";
  admin = {
    <a class="link" href="options.html#opt-services.discourse.admin.email">email</a> = "admin@example.com";
    <a class="link" href="options.html#opt-services.discourse.admin.username">username</a> = "admin";
    <a class="link" href="options.html#opt-services.discourse.admin.fullName">fullName</a> = "Administrator";
    <a class="link" href="options.html#opt-services.discourse.admin.passwordFile">passwordFile</a> = "/path/to/password_file";
  };
  <a class="link" href="options.html#opt-services.discourse.secretKeyBaseFile">secretKeyBaseFile</a> = "/path/to/secret_key_base_file";
};
<a class="link" href="options.html#opt-security.acme.defaults.email">security.acme.email</a> = "me@example.com";
<a class="link" href="options.html#opt-security.acme.acceptTerms">security.acme.acceptTerms</a> = true;
</pre><p>
   </p><p>
     Provided a proper DNS setup, you'll be able to connect to the
     instance at <code class="literal">discourse.example.com</code> and log in
     using the credentials provided in
     <code class="literal">services.discourse.admin</code>.
   </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-discourse-tls"></a>26.2. Using a regular TLS certificate</h2></div></div></div><p>
     To set up TLS using a regular certificate and key on file, use
     the <a class="xref" href="options.html#opt-services.discourse.sslCertificate"><code class="option">services.discourse.sslCertificate</code></a>
     and <a class="xref" href="options.html#opt-services.discourse.sslCertificateKey"><code class="option">services.discourse.sslCertificateKey</code></a>
     options:

</p><pre class="programlisting">
services.discourse = {
  <a class="link" href="options.html#opt-services.discourse.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.discourse.hostname">hostname</a> = "discourse.example.com";
  <a class="link" href="options.html#opt-services.discourse.sslCertificate">sslCertificate</a> = "/path/to/ssl_certificate";
  <a class="link" href="options.html#opt-services.discourse.sslCertificateKey">sslCertificateKey</a> = "/path/to/ssl_certificate_key";
  admin = {
    <a class="link" href="options.html#opt-services.discourse.admin.email">email</a> = "admin@example.com";
    <a class="link" href="options.html#opt-services.discourse.admin.username">username</a> = "admin";
    <a class="link" href="options.html#opt-services.discourse.admin.fullName">fullName</a> = "Administrator";
    <a class="link" href="options.html#opt-services.discourse.admin.passwordFile">passwordFile</a> = "/path/to/password_file";
  };
  <a class="link" href="options.html#opt-services.discourse.secretKeyBaseFile">secretKeyBaseFile</a> = "/path/to/secret_key_base_file";
};
</pre><p>

   </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-discourse-database"></a>26.3. Database access</h2></div></div></div><p>
     <span class="productname">Discourse</span> uses
     <span class="productname">PostgreSQL</span> to store most of its
     data. A database will automatically be enabled and a database
     and role created unless <a class="xref" href="options.html#opt-services.discourse.database.host"><code class="option">services.discourse.database.host</code></a> is changed from
     its default of <code class="literal">null</code> or <a class="xref" href="options.html#opt-services.discourse.database.createLocally"><code class="option">services.discourse.database.createLocally</code></a> is set
     to <code class="literal">false</code>.
   </p><p>
     External database access can also be configured by setting
     <a class="xref" href="options.html#opt-services.discourse.database.host"><code class="option">services.discourse.database.host</code></a>, <a class="xref" href="options.html#opt-services.discourse.database.username"><code class="option">services.discourse.database.username</code></a> and <a class="xref" href="options.html#opt-services.discourse.database.passwordFile"><code class="option">services.discourse.database.passwordFile</code></a> as
     appropriate. Note that you need to manually create a database
     called <code class="literal">discourse</code> (or the name you chose in
     <a class="xref" href="options.html#opt-services.discourse.database.name"><code class="option">services.discourse.database.name</code></a>) and
     allow the configured database user full access to it.
   </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-discourse-mail"></a>26.4. Email</h2></div></div></div><p>
     In addition to the basic setup, you'll want to configure an SMTP
     server <span class="productname">Discourse</span> can use to send user
     registration and password reset emails, among others. You can
     also optionally let <span class="productname">Discourse</span> receive
     email, which enables people to reply to threads and conversations
     via email.
   </p><p>
     A basic setup which assumes you want to use your configured <a class="link" href="options.html#opt-services.discourse.hostname">hostname</a> as
     email domain can be done like this:

</p><pre class="programlisting">
services.discourse = {
  <a class="link" href="options.html#opt-services.discourse.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.discourse.hostname">hostname</a> = "discourse.example.com";
  <a class="link" href="options.html#opt-services.discourse.sslCertificate">sslCertificate</a> = "/path/to/ssl_certificate";
  <a class="link" href="options.html#opt-services.discourse.sslCertificateKey">sslCertificateKey</a> = "/path/to/ssl_certificate_key";
  admin = {
    <a class="link" href="options.html#opt-services.discourse.admin.email">email</a> = "admin@example.com";
    <a class="link" href="options.html#opt-services.discourse.admin.username">username</a> = "admin";
    <a class="link" href="options.html#opt-services.discourse.admin.fullName">fullName</a> = "Administrator";
    <a class="link" href="options.html#opt-services.discourse.admin.passwordFile">passwordFile</a> = "/path/to/password_file";
  };
  mail.outgoing = {
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.serverAddress">serverAddress</a> = "smtp.emailprovider.com";
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.port">port</a> = 587;
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.username">username</a> = "user@emailprovider.com";
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.passwordFile">passwordFile</a> = "/path/to/smtp_password_file";
  };
  <a class="link" href="options.html#opt-services.discourse.mail.incoming.enable">mail.incoming.enable</a> = true;
  <a class="link" href="options.html#opt-services.discourse.secretKeyBaseFile">secretKeyBaseFile</a> = "/path/to/secret_key_base_file";
};
</pre><p>

     This assumes you have set up an MX record for the address you've
     set in <a class="link" href="options.html#opt-services.discourse.hostname">hostname</a> and
     requires proper SPF, DKIM and DMARC configuration to be done for
     the domain you're sending from, in order for email to be reliably delivered.
   </p><p>
     If you want to use a different domain for your outgoing email
     (for example <code class="literal">example.com</code> instead of
     <code class="literal">discourse.example.com</code>) you should set
     <a class="xref" href="options.html#opt-services.discourse.mail.notificationEmailAddress"><code class="option">services.discourse.mail.notificationEmailAddress</code></a> and
     <a class="xref" href="options.html#opt-services.discourse.mail.contactEmailAddress"><code class="option">services.discourse.mail.contactEmailAddress</code></a> manually.
   </p><div class="note"><h3 class="title">Note</h3><p>
       Setup of TLS for incoming email is currently only configured
       automatically when a regular TLS certificate is used, i.e. when
       <a class="xref" href="options.html#opt-services.discourse.sslCertificate"><code class="option">services.discourse.sslCertificate</code></a> and
       <a class="xref" href="options.html#opt-services.discourse.sslCertificateKey"><code class="option">services.discourse.sslCertificateKey</code></a> are
       set.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-discourse-settings"></a>26.5. Additional settings</h2></div></div></div><p>
     Additional site settings and backend settings, for which no
     explicit <span class="productname">NixOS</span> options are provided,
     can be set in <a class="xref" href="options.html#opt-services.discourse.siteSettings"><code class="option">services.discourse.siteSettings</code></a> and
     <a class="xref" href="options.html#opt-services.discourse.backendSettings"><code class="option">services.discourse.backendSettings</code></a> respectively.
   </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-discourse-site-settings"></a>26.5.1. Site settings</h3></div></div></div><p>
       <span class="quote">“<span class="quote">Site settings</span>”</span> are the settings that can be
       changed through the <span class="productname">Discourse</span>
       UI. Their <span class="emphasis"><em>default</em></span> values can be set using
       <a class="xref" href="options.html#opt-services.discourse.siteSettings"><code class="option">services.discourse.siteSettings</code></a>.
     </p><p>
       Settings are expressed as a Nix attribute set which matches the
       structure of the configuration in
       <a class="link" href="https://github.com/discourse/discourse/blob/master/config/site_settings.yml" target="_top">config/site_settings.yml</a>.
       To find a setting's path, you only need to care about the first
       two levels; i.e. its category (e.g. <code class="literal">login</code>)
       and name (e.g. <code class="literal">invite_only</code>).
     </p><p>
       Settings containing secret data should be set to an attribute
       set containing the attribute <code class="literal">_secret</code> - a
       string pointing to a file containing the value the option
       should be set to. See the example.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-discourse-backend-settings"></a>26.5.2. Backend settings</h3></div></div></div><p>
       Settings are expressed as a Nix attribute set which matches the
       structure of the configuration in
       <a class="link" href="https://github.com/discourse/discourse/blob/stable/config/discourse_defaults.conf" target="_top">config/discourse.conf</a>.
       Empty parameters can be defined by setting them to
       <code class="literal">null</code>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-discourse-settings-example"></a>26.5.3. Example</h3></div></div></div><p>
       The following example sets the title and description of the
       <span class="productname">Discourse</span> instance and enables
       <span class="productname">GitHub</span> login in the site settings,
       and changes a few request limits in the backend settings:
</p><pre class="programlisting">
services.discourse = {
  <a class="link" href="options.html#opt-services.discourse.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.discourse.hostname">hostname</a> = "discourse.example.com";
  <a class="link" href="options.html#opt-services.discourse.sslCertificate">sslCertificate</a> = "/path/to/ssl_certificate";
  <a class="link" href="options.html#opt-services.discourse.sslCertificateKey">sslCertificateKey</a> = "/path/to/ssl_certificate_key";
  admin = {
    <a class="link" href="options.html#opt-services.discourse.admin.email">email</a> = "admin@example.com";
    <a class="link" href="options.html#opt-services.discourse.admin.username">username</a> = "admin";
    <a class="link" href="options.html#opt-services.discourse.admin.fullName">fullName</a> = "Administrator";
    <a class="link" href="options.html#opt-services.discourse.admin.passwordFile">passwordFile</a> = "/path/to/password_file";
  };
  mail.outgoing = {
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.serverAddress">serverAddress</a> = "smtp.emailprovider.com";
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.port">port</a> = 587;
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.username">username</a> = "user@emailprovider.com";
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.passwordFile">passwordFile</a> = "/path/to/smtp_password_file";
  };
  <a class="link" href="options.html#opt-services.discourse.mail.incoming.enable">mail.incoming.enable</a> = true;
  <a class="link" href="options.html#opt-services.discourse.siteSettings">siteSettings</a> = {
    required = {
      title = "My Cats";
      site_description = "Discuss My Cats (and be nice plz)";
    };
    login = {
      enable_github_logins = true;
      github_client_id = "a2f6dfe838cb3206ce20";
      github_client_secret._secret = /run/keys/discourse_github_client_secret;
    };
  };
  <a class="link" href="options.html#opt-services.discourse.backendSettings">backendSettings</a> = {
    max_reqs_per_ip_per_minute = 300;
    max_reqs_per_ip_per_10_seconds = 60;
    max_asset_reqs_per_ip_per_10_seconds = 250;
    max_reqs_per_ip_mode = "warn+block";
  };
  <a class="link" href="options.html#opt-services.discourse.secretKeyBaseFile">secretKeyBaseFile</a> = "/path/to/secret_key_base_file";
};
</pre><p>
     </p><p>
       In the resulting site settings file, the
       <code class="literal">login.github_client_secret</code> key will be set
       to the contents of the
       <code class="filename">/run/keys/discourse_github_client_secret</code>
       file.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-discourse-plugins"></a>26.6. Plugins</h2></div></div></div><p>
      You can install <span class="productname">Discourse</span> plugins
      using the <a class="xref" href="options.html#opt-services.discourse.plugins"><code class="option">services.discourse.plugins</code></a>
      option. Pre-packaged plugins are provided in
      <code class="literal">&lt;your_discourse_package_here&gt;.plugins</code>. If
      you want the full suite of plugins provided through
      <code class="literal">nixpkgs</code>, you can also set the <a class="xref" href="options.html#opt-services.discourse.package"><code class="option">services.discourse.package</code></a> option to
      <code class="literal">pkgs.discourseAllPlugins</code>.
    </p><p>
      Plugins can be built with the
      <code class="literal">&lt;your_discourse_package_here&gt;.mkDiscoursePlugin</code>
      function. Normally, it should suffice to provide a
      <code class="literal">name</code> and <code class="literal">src</code> attribute. If
      the plugin has Ruby dependencies, however, they need to be
      packaged in accordance with the <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#developing-with-ruby" target="_top">Developing
      with Ruby</a> section of the Nixpkgs manual and the
      appropriate gem options set in <code class="literal">bundlerEnvArgs</code>
      (normally <code class="literal">gemdir</code> is sufficient). A plugin's
      Ruby dependencies are listed in its
      <code class="filename">plugin.rb</code> file as function calls to
      <code class="literal">gem</code>. To construct the corresponding
      <code class="filename">Gemfile</code> manually, run <span class="command"><strong>bundle
      init</strong></span>, then add the <code class="literal">gem</code> lines to it
      verbatim.
    </p><p>
      Much of the packaging can be done automatically by the
      <code class="filename">nixpkgs/pkgs/servers/web-apps/discourse/update.py</code>
      script - just add the plugin to the <code class="literal">plugins</code>
      list in the <code class="function">update_plugins</code> function and run
      the script:
      </p><pre class="programlisting">
./update.py update-plugins
</pre><p>
    </p><p>
      Some plugins provide <a class="link" href="index.html#module-services-discourse-site-settings" title="26.5.1. Site settings">site
      settings</a>. Their defaults can be configured using <a class="xref" href="options.html#opt-services.discourse.siteSettings"><code class="option">services.discourse.siteSettings</code></a>, just like
      regular site settings. To find the names of these settings, look
      in the <code class="literal">config/settings.yml</code> file of the plugin
      repo.
    </p><p>
      For example, to add the <a class="link" href="https://github.com/discourse/discourse-spoiler-alert" target="_top">discourse-spoiler-alert</a>
      and <a class="link" href="https://github.com/discourse/discourse-solved" target="_top">discourse-solved</a>
      plugins, and disable <code class="literal">discourse-spoiler-alert</code>
      by default:

</p><pre class="programlisting">
services.discourse = {
  <a class="link" href="options.html#opt-services.discourse.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.discourse.hostname">hostname</a> = "discourse.example.com";
  <a class="link" href="options.html#opt-services.discourse.sslCertificate">sslCertificate</a> = "/path/to/ssl_certificate";
  <a class="link" href="options.html#opt-services.discourse.sslCertificateKey">sslCertificateKey</a> = "/path/to/ssl_certificate_key";
  admin = {
    <a class="link" href="options.html#opt-services.discourse.admin.email">email</a> = "admin@example.com";
    <a class="link" href="options.html#opt-services.discourse.admin.username">username</a> = "admin";
    <a class="link" href="options.html#opt-services.discourse.admin.fullName">fullName</a> = "Administrator";
    <a class="link" href="options.html#opt-services.discourse.admin.passwordFile">passwordFile</a> = "/path/to/password_file";
  };
  mail.outgoing = {
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.serverAddress">serverAddress</a> = "smtp.emailprovider.com";
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.port">port</a> = 587;
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.username">username</a> = "user@emailprovider.com";
    <a class="link" href="options.html#opt-services.discourse.mail.outgoing.passwordFile">passwordFile</a> = "/path/to/smtp_password_file";
  };
  <a class="link" href="options.html#opt-services.discourse.mail.incoming.enable">mail.incoming.enable</a> = true;
  <a class="link" href="options.html#opt-services.discourse.mail.incoming.enable">plugins</a> = with config.services.discourse.package.plugins; [
    discourse-spoiler-alert
    discourse-solved
  ];
  <a class="link" href="options.html#opt-services.discourse.siteSettings">siteSettings</a> = {
    plugins = {
      spoiler_enabled = false;
    };
  };
  <a class="link" href="options.html#opt-services.discourse.secretKeyBaseFile">secretKeyBaseFile</a> = "/path/to/secret_key_base_file";
};
</pre><p>

    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-meilisearch"></a>Chapter 27. Meilisearch</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#quickstart">27.1. Quickstart</a></span></dt><dt><span class="section"><a href="index.html#usage">27.2. Usage</a></span></dt><dt><span class="section"><a href="index.html#defaults">27.3. Defaults</a></span></dt><dt><span class="section"><a href="index.html#missing">27.4. Missing</a></span></dt></dl></div><p>
    Meilisearch is a lightweight, fast and powerful search engine. Think
    elastic search with a much smaller footprint.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="quickstart"></a>27.1. Quickstart</h2></div></div></div><p>
      the minimum to start meilisearch is
    </p><pre class="programlisting">
services.meilisearch.enable = true;
</pre><p>
      this will start the http server included with meilisearch on port
      7700.
    </p><p>
      test with
      <code class="literal">curl -X GET 'http://localhost:7700/health'</code>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="usage"></a>27.2. Usage</h2></div></div></div><p>
      you first need to add documents to an index before you can search
      for documents.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="add-a-documents-to-the-movies-index"></a>27.2.1. Add a documents to the <code class="literal">movies</code>
      index</h3></div></div></div><p>
        <code class="literal">curl -X POST 'http://127.0.0.1:7700/indexes/movies/documents' --data '[{"id": "123", "title": "Superman"}, {"id": 234, "title": "Batman"}]'</code>
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="search-documents-in-the-movies-index"></a>27.2.2. Search documents in the <code class="literal">movies</code>
      index</h3></div></div></div><p>
        <code class="literal">curl 'http://127.0.0.1:7700/indexes/movies/search' --data '{ "q": "botman" }'</code>
        (note the typo is intentional and there to demonstrate the typo
        tolerant capabilities)
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="defaults"></a>27.3. Defaults</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          The default nixos package doesn’t come with the
          <a class="link" href="https://docs.meilisearch.com/learn/getting_started/quick_start.html#search" target="_top">dashboard</a>,
          since the dashboard features makes some assets downloads at
          compile time.
        </p></li><li class="listitem"><p>
          Anonimized Analytics sent to meilisearch are disabled by
          default.
        </p></li><li class="listitem"><p>
          Default deployment is development mode. It doesn’t require a
          secret master key. All routes are not protected and
          accessible.
        </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="missing"></a>27.4. Missing</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          the snapshot feature is not yet configurable from the module,
          it’s just a matter of adding the relevant environment
          variables.
        </p></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-networking-yggdrasil"></a>Chapter 28. Yggdrasil</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-networking-yggdrasil-configuration">28.1. Configuration</a></span></dt></dl></div><p>
    <span class="emphasis"><em>Source:</em></span>
    <code class="filename">modules/services/networking/yggdrasil/default.nix</code>
  </p><p>
    <span class="emphasis"><em>Upstream documentation:</em></span>
    <a class="link" href="https://yggdrasil-network.github.io/" target="_top">https://yggdrasil-network.github.io/</a>
  </p><p>
Yggdrasil is an early-stage implementation of a fully end-to-end encrypted,
self-arranging IPv6 network.
</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-networking-yggdrasil-configuration"></a>28.1. Configuration</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-networking-yggdrasil-configuration-simple"></a>28.1.1. Simple ephemeral node</h3></div></div></div><p>
An annotated example of a simple configuration:
</p><pre class="programlisting">
{
  services.yggdrasil = {
    enable = true;
    persistentKeys = false;
      # The NixOS module will generate new keys and a new IPv6 address each time
      # it is started if persistentKeys is not enabled.

    config = {
      Peers = [
        # Yggdrasil will automatically connect and "peer" with other nodes it
        # discovers via link-local multicast annoucements. Unless this is the
        # case (it probably isn't) a node needs peers within the existing
        # network that it can tunnel to.
        "tcp://1.2.3.4:1024"
        "tcp://1.2.3.5:1024"
        # Public peers can be found at
        # https://github.com/yggdrasil-network/public-peers
      ];
    };
  };
}
</pre><p>
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-networking-yggdrasil-configuration-prefix"></a>28.1.2. Persistent node with prefix</h3></div></div></div><p>
A node with a fixed address that announces a prefix:
</p><pre class="programlisting">
let
  address = "210:5217:69c0:9afc:1b95:b9f:8718:c3d2";
  prefix = "310:5217:69c0:9afc";
  # taken from the output of "yggdrasilctl getself".
in {

  services.yggdrasil = {
    enable = true;
    persistentKeys = true; # Maintain a fixed public key and IPv6 address.
    config = {
      Peers = [ "tcp://1.2.3.4:1024" "tcp://1.2.3.5:1024" ];
      NodeInfo = {
        # This information is visible to the network.
        name = config.networking.hostName;
        location = "The North Pole";
      };
    };
  };

  boot.kernel.sysctl."net.ipv6.conf.all.forwarding" = 1;
    # Forward traffic under the prefix.

  networking.interfaces.${eth0}.ipv6.addresses = [{
    # Set a 300::/8 address on the local physical device.
    address = prefix + "::1";
    prefixLength = 64;
  }];

  services.radvd = {
    # Annouce the 300::/8 prefix to eth0.
    enable = true;
    config = ''
      interface eth0
      {
        AdvSendAdvert on;
        prefix ${prefix}::/64 {
          AdvOnLink on;
          AdvAutonomous on;
        };
        route 200::/8 {};
      };
    '';
  };
}
</pre><p>
  </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-networking-yggdrasil-configuration-container"></a>28.1.3. Yggdrasil attached Container</h3></div></div></div><p>
A NixOS container attached to the Yggdrasil network via a node running on the
host:
        </p><pre class="programlisting">
let
  yggPrefix64 = "310:5217:69c0:9afc";
    # Again, taken from the output of "yggdrasilctl getself".
in
{
  boot.kernel.sysctl."net.ipv6.conf.all.forwarding" = 1;
  # Enable IPv6 forwarding.

  networking = {
    bridges.br0.interfaces = [ ];
    # A bridge only to containers…

    interfaces.br0 = {
      # … configured with a prefix address.
      ipv6.addresses = [{
        address = "${yggPrefix64}::1";
        prefixLength = 64;
      }];
    };
  };

  containers.foo = {
    autoStart = true;
    privateNetwork = true;
    hostBridge = "br0";
    # Attach the container to the bridge only.
    config = { config, pkgs, ... }: {
      networking.interfaces.eth0.ipv6 = {
        addresses = [{
          # Configure a prefix address.
          address = "${yggPrefix64}::2";
          prefixLength = 64;
        }];
        routes = [{
          # Configure the prefix route.
          address = "200::";
          prefixLength = 7;
          via = "${yggPrefix64}::1";
        }];
      };

      services.httpd.enable = true;
      networking.firewall.allowedTCPPorts = [ 80 ];
    };
  };

}
</pre><p>
      </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-prosody"></a>Chapter 29. Prosody</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-prosody-basic-usage">29.1. Basic usage</a></span></dt><dt><span class="section"><a href="index.html#module-services-prosody-letsencrypt">29.2. Let's Encrypt Configuration</a></span></dt></dl></div><p>
  <a class="link" href="https://prosody.im/" target="_top">Prosody</a> is an open-source, modern XMPP server.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-prosody-basic-usage"></a>29.1. Basic usage</h2></div></div></div><p>
    A common struggle for most XMPP newcomers is to find the right set
    of XMPP Extensions (XEPs) to setup. Forget to activate a few of
    those and your XMPP experience might turn into a nightmare!
  </p><p>
    The XMPP community tackles this problem by creating a meta-XEP
    listing a decent set of XEPs you should implement. This meta-XEP
    is issued every year, the 2020 edition being
    <a class="link" href="https://xmpp.org/extensions/xep-0423.html" target="_top">XEP-0423</a>.
  </p><p>
    The NixOS Prosody module will implement most of these recommendend XEPs out of
    the box. That being said, two components still require some
    manual configuration: the
    <a class="link" href="https://xmpp.org/extensions/xep-0045.html" target="_top">Multi User Chat (MUC)</a>
    and the <a class="link" href="https://xmpp.org/extensions/xep-0363.html" target="_top">HTTP File Upload</a> ones.
    You'll need to create a DNS subdomain for each of those. The current convention is to name your
    MUC endpoint <code class="literal">conference.example.org</code> and your HTTP upload domain <code class="literal">upload.example.org</code>.
  </p><p>
    A good configuration to start with, including a
    <a class="link" href="https://xmpp.org/extensions/xep-0045.html" target="_top">Multi User Chat (MUC)</a>
    endpoint as well as a <a class="link" href="https://xmpp.org/extensions/xep-0363.html" target="_top">HTTP File Upload</a>
    endpoint will look like this:
    </p><pre class="programlisting">
services.prosody = {
  <a class="link" href="options.html#opt-services.prosody.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.prosody.admins">admins</a> = [ "root@example.org" ];
  <a class="link" href="options.html#opt-services.prosody.ssl.cert">ssl.cert</a> = "/var/lib/acme/example.org/fullchain.pem";
  <a class="link" href="options.html#opt-services.prosody.ssl.key">ssl.key</a> = "/var/lib/acme/example.org/key.pem";
  <a class="link" href="options.html#opt-services.prosody.virtualHosts">virtualHosts</a>."example.org" = {
      <a class="link" href="options.html#opt-services.prosody.virtualHosts._name_.enabled">enabled</a> = true;
      <a class="link" href="options.html#opt-services.prosody.virtualHosts._name_.domain">domain</a> = "example.org";
      <a class="link" href="options.html#opt-services.prosody.virtualHosts._name_.ssl.cert">ssl.cert</a> = "/var/lib/acme/example.org/fullchain.pem";
      <a class="link" href="options.html#opt-services.prosody.virtualHosts._name_.ssl.key">ssl.key</a> = "/var/lib/acme/example.org/key.pem";
  };
  <a class="link" href="options.html#opt-services.prosody.muc">muc</a> = [ {
      <a class="link" href="options.html#opt-services.prosody.muc">domain</a> = "conference.example.org";
  } ];
  <a class="link" href="options.html#opt-services.prosody.uploadHttp">uploadHttp</a> = {
      <a class="link" href="options.html#opt-services.prosody.uploadHttp.domain">domain</a> = "upload.example.org";
  };
};</pre><p>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-prosody-letsencrypt"></a>29.2. Let's Encrypt Configuration</h2></div></div></div><p>
   As you can see in the code snippet from the
   <a class="link" href="index.html#module-services-prosody-basic-usage" title="29.1. Basic usage">previous section</a>,
   you'll need a single TLS certificate covering your main endpoint,
   the MUC one as well as the HTTP Upload one. We can generate such a
   certificate by leveraging the ACME
   <a class="link" href="options.html#opt-security.acme.certs._name_.extraDomainNames">extraDomainNames</a> module option.
 </p><p>
   Provided the setup detailed in the previous section, you'll need the following acme configuration to generate
   a TLS certificate for the three endponits:
    </p><pre class="programlisting">
security.acme = {
  <a class="link" href="options.html#opt-security.acme.defaults.email">email</a> = "root@example.org";
  <a class="link" href="options.html#opt-security.acme.acceptTerms">acceptTerms</a> = true;
  <a class="link" href="options.html#opt-security.acme.certs">certs</a> = {
    "example.org" = {
      <a class="link" href="options.html#opt-security.acme.certs._name_.webroot">webroot</a> = "/var/www/example.org";
      <a class="link" href="options.html#opt-security.acme.certs._name_.email">email</a> = "root@example.org";
      <a class="link" href="options.html#opt-security.acme.certs._name_.extraDomainNames">extraDomainNames</a> = [ "conference.example.org" "upload.example.org" ];
    };
  };
};</pre><p>
 </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-pleroma"></a>Chapter 30. Pleroma</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-pleroma-generate-config">30.1. Generating the Pleroma config</a></span></dt><dt><span class="section"><a href="index.html#module-services-pleroma-initialize-db">30.2. Initializing the database</a></span></dt><dt><span class="section"><a href="index.html#module-services-pleroma-enable">30.3. Enabling the Pleroma service locally</a></span></dt><dt><span class="section"><a href="index.html#module-services-pleroma-admin-user">30.4. Creating the admin user</a></span></dt><dt><span class="section"><a href="index.html#module-services-pleroma-nginx">30.5. Configuring Nginx</a></span></dt></dl></div><p>
  <a class="link" href="https://pleroma.social/" target="_top">Pleroma</a> is a lightweight activity pub server.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-pleroma-generate-config"></a>30.1. Generating the Pleroma config</h2></div></div></div><p>The <code class="literal">pleroma_ctl</code> CLI utility will prompt you some questions and it will generate an initial config file. This is an example of usage
</p><pre class="programlisting">
<code class="prompt">$ </code>mkdir tmp-pleroma
<code class="prompt">$ </code>cd tmp-pleroma
<code class="prompt">$ </code>nix-shell -p pleroma-otp
<code class="prompt">$ </code>pleroma_ctl instance gen --output config.exs --output-psql setup.psql
</pre><p>
  </p><p>The <code class="literal">config.exs</code> file can be further customized following the instructions on the <a class="link" href="https://docs-develop.pleroma.social/backend/configuration/cheatsheet/" target="_top">upstream documentation</a>. Many refinements can be applied also after the service is running.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-pleroma-initialize-db"></a>30.2. Initializing the database</h2></div></div></div><p>First, the Postgresql service must be enabled in the NixOS configuration
</p><pre class="programlisting">
services.postgresql = {
  enable = true;
  package = pkgs.postgresql_13;
};
</pre><p>
and activated with the usual
</p><pre class="programlisting">
<code class="prompt">$ </code>nixos-rebuild switch
</pre><p>
  </p><p>Then you can create and seed the database, using the <code class="literal">setup.psql</code> file that you generated in the previous section, by running
</p><pre class="programlisting">
<code class="prompt">$ </code>sudo -u postgres psql -f setup.psql
</pre><p>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-pleroma-enable"></a>30.3. Enabling the Pleroma service locally</h2></div></div></div><p>In this section we will enable the Pleroma service only locally, so its configurations can be improved incrementally.</p><p>This is an example of configuration, where <a class="link" href="options.html#opt-services.pleroma.configs">services.pleroma.configs</a> option contains the content of the file <code class="literal">config.exs</code>, generated <a class="link" href="index.html#module-services-pleroma-generate-config" title="30.1. Generating the Pleroma config">in the first section</a>, but with the secrets (database password, endpoint secret key, salts, etc.) removed. Removing secrets is important, because otherwise they will be stored publicly in the Nix store.
</p><pre class="programlisting">
services.pleroma = {
  enable = true;
  secretConfigFile = "/var/lib/pleroma/secrets.exs";
  configs = [
    ''
    import Config

    config :pleroma, Pleroma.Web.Endpoint,
      url: [host: "pleroma.example.net", scheme: "https", port: 443],
      http: [ip: {127, 0, 0, 1}, port: 4000]

    config :pleroma, :instance,
      name: "Test",
      email: "admin@example.net",
      notify_email: "admin@example.net",
      limit: 5000,
      registrations_open: true

    config :pleroma, :media_proxy,
      enabled: false,
      redirect_on_failure: true

    config :pleroma, Pleroma.Repo,
      adapter: Ecto.Adapters.Postgres,
      username: "pleroma",
      database: "pleroma",
      hostname: "localhost"

    # Configure web push notifications
    config :web_push_encryption, :vapid_details,
      subject: "mailto:admin@example.net"

    # ... TO CONTINUE ...
    ''
  ];
};
</pre><p>
  </p><p>Secrets must be moved into a file pointed by <a class="link" href="options.html#opt-services.pleroma.secretConfigFile">services.pleroma.secretConfigFile</a>, in our case <code class="literal">/var/lib/pleroma/secrets.exs</code>. This file can be created copying the previously generated <code class="literal">config.exs</code> file and then removing all the settings, except the secrets. This is an example
</p><pre class="programlisting">
# Pleroma instance passwords

import Config

config :pleroma, Pleroma.Web.Endpoint,
   secret_key_base: "&lt;the secret generated by pleroma_ctl&gt;",
   signing_salt: "&lt;the secret generated by pleroma_ctl&gt;"

config :pleroma, Pleroma.Repo,
  password: "&lt;the secret generated by pleroma_ctl&gt;"

# Configure web push notifications
config :web_push_encryption, :vapid_details,
  public_key: "&lt;the secret generated by pleroma_ctl&gt;",
  private_key: "&lt;the secret generated by pleroma_ctl&gt;"

# ... TO CONTINUE ...
</pre><p>
  Note that the lines of the same configuration group are comma separated (i.e. all the lines end with a comma, except the last one), so when the lines with passwords are added or removed, commas must be adjusted accordingly.</p><p>The service can be enabled with the usual
</p><pre class="programlisting">
<code class="prompt">$ </code>nixos-rebuild switch
</pre><p>
  </p><p>The service is accessible only from the local <code class="literal">127.0.0.1:4000</code> port. It can be tested using a port forwarding like this
</p><pre class="programlisting">
<code class="prompt">$ </code>ssh -L 4000:localhost:4000 myuser@example.net
</pre><p>
and then accessing <a class="link" href="http://localhost:4000" target="_top">http://localhost:4000</a> from a web browser.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-pleroma-admin-user"></a>30.4. Creating the admin user</h2></div></div></div><p>After Pleroma service is running, all <a class="link" href="https://docs-develop.pleroma.social/" target="_top">Pleroma administration utilities</a> can be used. In particular an admin user can be created with
</p><pre class="programlisting">
<code class="prompt">$ </code>pleroma_ctl user new &lt;nickname&gt; &lt;email&gt;  --admin --moderator --password &lt;password&gt;
</pre><p>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-pleroma-nginx"></a>30.5. Configuring Nginx</h2></div></div></div><p>In this configuration, Pleroma is listening only on the local port 4000. Nginx can be configured as a Reverse Proxy, for forwarding requests from public ports to the Pleroma service. This is an example of configuration, using
<a class="link" href="https://letsencrypt.org/" target="_top">Let's Encrypt</a> for the TLS certificates
</p><pre class="programlisting">
security.acme = {
  email = "root@example.net";
  acceptTerms = true;
};

services.nginx = {
  enable = true;
  addSSL = true;

  recommendedTlsSettings = true;
  recommendedOptimisation = true;
  recommendedGzipSettings = true;

  recommendedProxySettings = false;
  # NOTE: if enabled, the NixOS proxy optimizations will override the Pleroma
  # specific settings, and they will enter in conflict.

  virtualHosts = {
    "pleroma.example.net" = {
      http2 = true;
      enableACME = true;
      forceSSL = true;

      locations."/" = {
        proxyPass = "http://127.0.0.1:4000";

        extraConfig = ''
          etag on;
          gzip on;

          add_header 'Access-Control-Allow-Origin' '*' always;
          add_header 'Access-Control-Allow-Methods' 'POST, PUT, DELETE, GET, PATCH, OPTIONS' always;
          add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Idempotency-Key' always;
          add_header 'Access-Control-Expose-Headers' 'Link, X-RateLimit-Reset, X-RateLimit-Limit, X-RateLimit-Remaining, X-Request-Id' always;
          if ($request_method = OPTIONS) {
            return 204;
          }
          add_header X-XSS-Protection "1; mode=block";
          add_header X-Permitted-Cross-Domain-Policies none;
          add_header X-Frame-Options DENY;
          add_header X-Content-Type-Options nosniff;
          add_header Referrer-Policy same-origin;
          add_header X-Download-Options noopen;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;

          client_max_body_size 16m;
          # NOTE: increase if users need to upload very big files
        '';
      };
    };
  };
};
</pre><p>
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-mosquitto"></a>Chapter 31. Mosquitto</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-mosquitto-quickstart">31.1. Quickstart</a></span></dt><dt><span class="section"><a href="index.html#module-services-mosquitto-config">31.2. Configuration</a></span></dt></dl></div><p>
    Mosquitto is a MQTT broker often used for IoT or home automation
    data transport.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-mosquitto-quickstart"></a>31.1. Quickstart</h2></div></div></div><p>
      A minimal configuration for Mosquitto is
    </p><pre class="programlisting">
services.mosquitto = {
  enable = true;
  listeners = [ {
    acl = [ "pattern readwrite #" ];
    omitPasswordAuth = true;
    settings.allow_anonymous = true;
  } ];
};
</pre><p>
      This will start a broker on port 1883, listening on all interfaces
      of the machine, allowing read/write access to all topics to any
      user without password requirements.
    </p><p>
      User authentication can be configured with the
      <code class="literal">users</code> key of listeners. A config that gives
      full read access to a user <code class="literal">monitor</code> and
      restricted write access to a user <code class="literal">service</code> could
      look like
    </p><pre class="programlisting">
services.mosquitto = {
  enable = true;
  listeners = [ {
    users = {
      monitor = {
        acl = [ "read #" ];
        password = "monitor";
      };
      service = {
        acl = [ "write service/#" ];
        password = "service";
      };
    };
  } ];
};
</pre><p>
      TLS authentication is configured by setting TLS-related options of
      the listener:
    </p><pre class="programlisting">
services.mosquitto = {
  enable = true;
  listeners = [ {
    port = 8883; # port change is not required, but helpful to avoid mistakes
    # ...
    settings = {
      cafile = "/path/to/mqtt.ca.pem";
      certfile = "/path/to/mqtt.pem";
      keyfile = "/path/to/mqtt.key";
    };
  } ];
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-mosquitto-config"></a>31.2. Configuration</h2></div></div></div><p>
      The Mosquitto configuration has four distinct types of settings:
      the global settings of the daemon, listeners, plugins, and
      bridges. Bridges and listeners are part of the global
      configuration, plugins are part of listeners. Users of the broker
      are configured as parts of listeners rather than globally,
      allowing configurations in which a given user is only allowed to
      log in to the broker using specific listeners (eg to configure an
      admin user with full access to all topics, but restricted to
      localhost).
    </p><p>
      Almost all options of Mosquitto are available for configuration at
      their appropriate levels, some as NixOS options written in camel
      case, the remainders under <code class="literal">settings</code> with their
      exact names in the Mosquitto config file. The exceptions are
      <code class="literal">acl_file</code> (which is always set according to the
      <code class="literal">acl</code> attributes of a listener and its users) and
      <code class="literal">per_listener_settings</code> (which is always set to
      <code class="literal">true</code>).
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-mosquitto-config-passwords"></a>31.2.1. Password authentication</h3></div></div></div><p>
        Mosquitto can be run in two modes, with a password file or
        without. Each listener has its own password file, and different
        listeners may use different password files. Password file
        generation can be disabled by setting
        <code class="literal">omitPasswordAuth = true</code> for a listener; in
        this case it is necessary to either set
        <code class="literal">settings.allow_anonymous = true</code> to allow all
        logins, or to configure other authentication methods like TLS
        client certificates with
        <code class="literal">settings.use_identity_as_username = true</code>.
      </p><p>
        The default is to generate a password file for each listener
        from the users configured to that listener. Users with no
        configured password will not be added to the password file and
        thus will not be able to use the broker.
      </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-mosquitto-config-acl"></a>31.2.2. ACL format</h3></div></div></div><p>
        Every listener has a Mosquitto <code class="literal">acl_file</code>
        attached to it. This ACL is configured via two attributes of the
        config:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
            the <code class="literal">acl</code> attribute of the listener
            configures pattern ACL entries and topic ACL entries for
            anonymous users. Each entry must be prefixed with
            <code class="literal">pattern</code> or <code class="literal">topic</code> to
            distinguish between these two cases.
          </p></li><li class="listitem"><p>
            the <code class="literal">acl</code> attribute of every user
            configures in the listener configured the ACL for that given
            user. Only topic ACLs are supported by Mosquitto in this
            setting, so no prefix is required or allowed.
          </p></li></ul></div><p>
        The default ACL for a listener is empty, disallowing all
        accesses from all clients. To configure a completely open ACL,
        set <code class="literal">acl = [ "pattern readwrite #" ]</code>
        in the listener.
      </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-litestream"></a>Chapter 32. Litestream</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-litestream-configuration">32.1. Configuration</a></span></dt></dl></div><p>
  <a class="link" href="https://litestream.io/" target="_top">Litestream</a> is a standalone streaming
  replication tool for SQLite.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-litestream-configuration"></a>32.1. Configuration</h2></div></div></div><p>
   Litestream service is managed by a dedicated user named <code class="literal">litestream</code>
   which needs permission to the database file. Here's an example config which gives
   required permissions to access <a class="link" href="options.html#opt-services.grafana.database.path">
   grafana database</a>:
</p><pre class="programlisting">
{ pkgs, ... }:
{
  users.users.litestream.extraGroups = [ "grafana" ];

  systemd.services.grafana.serviceConfig.ExecStartPost = "+" + pkgs.writeShellScript "grant-grafana-permissions" ''
    timeout=10

    while [ ! -f /var/lib/grafana/data/grafana.db ];
    do
      if [ "$timeout" == 0 ]; then
        echo "ERROR: Timeout while waiting for /var/lib/grafana/data/grafana.db."
        exit 1
      fi

      sleep 1

      ((timeout--))
    done

    find /var/lib/grafana -type d -exec chmod -v 775 {} \;
    find /var/lib/grafana -type f -exec chmod -v 660 {} \;
  '';

  services.litestream = {
    enable = true;

    environmentFile = "/run/secrets/litestream";

    settings = {
      dbs = [
        {
          path = "/var/lib/grafana/data/grafana.db";
          replicas = [{
            url = "s3://mybkt.litestream.io/grafana";
          }];
        }
      ];
    };
  };
}
</pre><p>
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-prometheus-exporters"></a>Chapter 33. Prometheus exporters</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-prometheus-exporters-configuration">33.1. Configuration</a></span></dt><dt><span class="section"><a href="index.html#module-services-prometheus-exporters-new-exporter">33.2. Adding a new exporter</a></span></dt><dt><span class="section"><a href="index.html#module-services-prometheus-exporters-update-exporter-module">33.3. Updating an exporter module</a></span></dt></dl></div><p>
  Prometheus exporters provide metrics for the
  <a class="link" href="https://prometheus.io" target="_top">prometheus monitoring system</a>.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-prometheus-exporters-configuration"></a>33.1. Configuration</h2></div></div></div><p>
   One of the most common exporters is the
   <a class="link" href="https://github.com/prometheus/node_exporter" target="_top">node
   exporter</a>, it provides hardware and OS metrics from the host it's
   running on. The exporter could be configured as follows:
</p><pre class="programlisting">
  services.prometheus.exporters.node = {
    enable = true;
    enabledCollectors = [
      "logind"
      "systemd"
    ];
    disabledCollectors = [
      "textfile"
    ];
    openFirewall = true;
    firewallFilter = "-i br0 -p tcp -m tcp --dport 9100";
  };
</pre><p>
   It should now serve all metrics from the collectors that are explicitly
   enabled and the ones that are
   <a class="link" href="https://github.com/prometheus/node_exporter#enabled-by-default" target="_top">enabled
   by default</a>, via http under <code class="literal">/metrics</code>. In this
   example the firewall should just allow incoming connections to the
   exporter's port on the bridge interface <code class="literal">br0</code> (this would
   have to be configured seperately of course). For more information about
   configuration see <code class="literal">man configuration.nix</code> or search through
   the
   <a class="link" href="https://nixos.org/nixos/options.html#prometheus.exporters" target="_top">available
   options</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-prometheus-exporters-new-exporter"></a>33.2. Adding a new exporter</h2></div></div></div><p>
   To add a new exporter, it has to be packaged first (see
   <code class="literal">nixpkgs/pkgs/servers/monitoring/prometheus/</code> for
   examples), then a module can be added. The postfix exporter is used in this
   example:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Some default options for all exporters are provided by
     <code class="literal">nixpkgs/nixos/modules/services/monitoring/prometheus/exporters.nix</code>:
    </p></li><li class="listitem" style="list-style-type: none"><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
       <code class="literal">enable</code>
      </p></li><li class="listitem"><p>
       <code class="literal">port</code>
      </p></li><li class="listitem"><p>
       <code class="literal">listenAddress</code>
      </p></li><li class="listitem"><p>
       <code class="literal">extraFlags</code>
      </p></li><li class="listitem"><p>
       <code class="literal">openFirewall</code>
      </p></li><li class="listitem"><p>
       <code class="literal">firewallFilter</code>
      </p></li><li class="listitem"><p>
       <code class="literal">user</code>
      </p></li><li class="listitem"><p>
       <code class="literal">group</code>
      </p></li></ul></div></li><li class="listitem"><p>
     As there is already a package available, the module can now be added. This
     is accomplished by adding a new file to the
     <code class="literal">nixos/modules/services/monitoring/prometheus/exporters/</code>
     directory, which will be called postfix.nix and contains all exporter
     specific options and configuration:
</p><pre class="programlisting">
# nixpgs/nixos/modules/services/prometheus/exporters/postfix.nix
{ config, lib, pkgs, options }:

with lib;

let
  # for convenience we define cfg here
  cfg = config.services.prometheus.exporters.postfix;
in
{
  port = 9154; # The postfix exporter listens on this port by default

  # `extraOpts` is an attribute set which contains additional options
  # (and optional overrides for default options).
  # Note that this attribute is optional.
  extraOpts = {
    telemetryPath = mkOption {
      type = types.str;
      default = "/metrics";
      description = ''
        Path under which to expose metrics.
      '';
    };
    logfilePath = mkOption {
      type = types.path;
      default = /var/log/postfix_exporter_input.log;
      example = /var/log/mail.log;
      description = ''
        Path where Postfix writes log entries.
        This file will be truncated by this exporter!
      '';
    };
    showqPath = mkOption {
      type = types.path;
      default = /var/spool/postfix/public/showq;
      example = /var/lib/postfix/queue/public/showq;
      description = ''
        Path at which Postfix places its showq socket.
      '';
    };
  };

  # `serviceOpts` is an attribute set which contains configuration
  # for the exporter's systemd service. One of
  # `serviceOpts.script` and `serviceOpts.serviceConfig.ExecStart`
  # has to be specified here. This will be merged with the default
  # service confiuration.
  # Note that by default 'DynamicUser' is 'true'.
  serviceOpts = {
    serviceConfig = {
      DynamicUser = false;
      ExecStart = ''
        ${pkgs.prometheus-postfix-exporter}/bin/postfix_exporter \
          --web.listen-address ${cfg.listenAddress}:${toString cfg.port} \
          --web.telemetry-path ${cfg.telemetryPath} \
          ${concatStringsSep " \\\n  " cfg.extraFlags}
      '';
    };
  };
}
</pre><p>
    </p></li><li class="listitem"><p>
     This should already be enough for the postfix exporter. Additionally one
     could now add assertions and conditional default values. This can be done
     in the 'meta-module' that combines all exporter definitions and generates
     the submodules:
     <code class="literal">nixpkgs/nixos/modules/services/prometheus/exporters.nix</code>
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-prometheus-exporters-update-exporter-module"></a>33.3. Updating an exporter module</h2></div></div></div><p>
     Should an exporter option change at some point, it is possible to add
     information about the change to the exporter definition similar to
     <code class="literal">nixpkgs/nixos/modules/rename.nix</code>:
</p><pre class="programlisting">
{ config, lib, pkgs, options }:

with lib;

let
  cfg = config.services.prometheus.exporters.nginx;
in
{
  port = 9113;
  extraOpts = {
    # additional module options
    # ...
  };
  serviceOpts = {
    # service configuration
    # ...
  };
  imports = [
    # 'services.prometheus.exporters.nginx.telemetryEndpoint' -&gt; 'services.prometheus.exporters.nginx.telemetryPath'
    (mkRenamedOptionModule [ "telemetryEndpoint" ] [ "telemetryPath" ])

    # removed option 'services.prometheus.exporters.nginx.insecure'
    (mkRemovedOptionModule [ "insecure" ] ''
      This option was replaced by 'prometheus.exporters.nginx.sslVerify' which defaults to true.
    '')
    ({ options.warnings = options.warnings; })
  ];
}
</pre><p>
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-parsedmarc"></a>Chapter 34. parsedmarc</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-parsedmarc-basic-usage">34.1. Basic usage</a></span></dt><dt><span class="section"><a href="index.html#local-mail">34.2. Local mail</a></span></dt><dt><span class="section"><a href="index.html#grafana-and-geoip">34.3. Grafana and GeoIP</a></span></dt></dl></div><p>
    <a class="link" href="https://domainaware.github.io/parsedmarc/" target="_top">parsedmarc</a>
    is a service which parses incoming
    <a class="link" href="https://dmarc.org/" target="_top">DMARC</a> reports and
    stores or sends them to a downstream service for further analysis.
    In combination with Elasticsearch, Grafana and the included Grafana
    dashboard, it provides a handy overview of DMARC reports over time.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-parsedmarc-basic-usage"></a>34.1. Basic usage</h2></div></div></div><p>
      A very minimal setup which reads incoming reports from an external
      email address and saves them to a local Elasticsearch instance
      looks like this:
    </p><pre class="programlisting">
services.parsedmarc = {
  enable = true;
  settings.imap = {
    host = "imap.example.com";
    user = "alice@example.com";
    password = "/path/to/imap_password_file";
    watch = true;
  };
  provision.geoIp = false; # Not recommended!
};
</pre><p>
      Note that GeoIP provisioning is disabled in the example for
      simplicity, but should be turned on for fully functional reports.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="local-mail"></a>34.2. Local mail</h2></div></div></div><p>
      Instead of watching an external inbox, a local inbox can be
      automatically provisioned. The recipient’s name is by default set
      to <code class="literal">dmarc</code>, but can be configured in
      <a class="link" href="options.html#opt-services.parsedmarc.provision.localMail.recipientName" target="_top">services.parsedmarc.provision.localMail.recipientName</a>.
      You need to add an MX record pointing to the host. More
      concretely: for the example to work, an MX record needs to be set
      up for <code class="literal">monitoring.example.com</code> and the complete
      email address that should be configured in the domain’s dmarc
      policy is <code class="literal">dmarc@monitoring.example.com</code>.
    </p><pre class="programlisting">
services.parsedmarc = {
  enable = true;
  provision = {
    localMail = {
      enable = true;
      hostname = monitoring.example.com;
    };
    geoIp = false; # Not recommended!
  };
};
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="grafana-and-geoip"></a>34.3. Grafana and GeoIP</h2></div></div></div><p>
      The reports can be visualized and summarized with parsedmarc’s
      official Grafana dashboard. For all views to work, and for the
      data to be complete, GeoIP databases are also required. The
      following example shows a basic deployment where the provisioned
      Elasticsearch instance is automatically added as a Grafana
      datasource, and the dashboard is added to Grafana as well.
    </p><pre class="programlisting">
services.parsedmarc = {
  enable = true;
  provision = {
    localMail = {
      enable = true;
      hostname = url;
    };
    grafana = {
      datasource = true;
      dashboard = true;
    };
  };
};

# Not required, but recommended for full functionality
services.geoipupdate = {
  settings = {
    AccountID = 000000;
    LicenseKey = "/path/to/license_key_file";
  };
};

services.grafana = {
  enable = true;
  addr = "0.0.0.0";
  domain = url;
  rootUrl = "https://" + url;
  protocol = "socket";
  security = {
    adminUser = "admin";
    adminPasswordFile = "/path/to/admin_password_file";
    secretKeyFile = "/path/to/secret_key_file";
  };
};

services.nginx = {
  enable = true;
  recommendedTlsSettings = true;
  recommendedOptimisation = true;
  recommendedGzipSettings = true;
  recommendedProxySettings = true;
  upstreams.grafana.servers."unix:/${config.services.grafana.socket}" = {};
  virtualHosts.${url} = {
    root = config.services.grafana.staticRootPath;
    enableACME = true;
    forceSSL = true;
    locations."/".tryFiles = "$uri @grafana";
    locations."@grafana".proxyPass = "http://grafana";
  };
};
users.users.nginx.extraGroups = [ "grafana" ];
</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-weechat"></a>Chapter 35. WeeChat</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-weechat-basic-usage">35.1. Basic Usage</a></span></dt><dt><span class="section"><a href="index.html#module-services-weechat-reattach">35.2. Re-attaching to WeeChat</a></span></dt></dl></div><p>
  <a class="link" href="https://weechat.org/" target="_top">WeeChat</a> is a fast and
  extensible IRC client.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-weechat-basic-usage"></a>35.1. Basic Usage</h2></div></div></div><p>
   By default, the module creates a
   <code class="literal"><a class="link" href="https://www.freedesktop.org/wiki/Software/systemd/" target="_top">systemd</a></code>
   unit which runs the chat client in a detached
   <code class="literal"><a class="link" href="https://www.gnu.org/software/screen/" target="_top">screen</a></code>
   session.
  </p><p>
   This can be done by enabling the <code class="literal">weechat</code> service:
</p><pre class="programlisting">
{ ... }:

{
  <a class="link" href="options.html#opt-services.weechat.enable">services.weechat.enable</a> = true;
}
</pre><p>
  </p><p>
   The service is managed by a dedicated user named <code class="literal">weechat</code>
   in the state directory <code class="literal">/var/lib/weechat</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-weechat-reattach"></a>35.2. Re-attaching to WeeChat</h2></div></div></div><p>
   WeeChat runs in a screen session owned by a dedicated user. To explicitly
   allow your another user to attach to this session, the
   <code class="literal">screenrc</code> needs to be tweaked by adding
   <a class="link" href="https://www.gnu.org/software/screen/manual/html_node/Multiuser.html#Multiuser" target="_top">multiuser</a>
   support:
</p><pre class="programlisting">
{
  <a class="link" href="options.html#opt-programs.screen.screenrc">programs.screen.screenrc</a> = ''
    multiuser on
    acladd normal_user
  '';
}
</pre><p>
   Now, the session can be re-attached like this:
</p><pre class="programlisting">
screen -x weechat/weechat-screen
</pre><p>
  </p><p>
   <span class="emphasis"><em>The session name can be changed using
   <a class="link" href="options.html#opt-services.weechat.sessionName">services.weechat.sessionName.</a></em></span>
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-taskserver"></a>Chapter 36. Taskserver</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-taskserver-configuration">36.1. Configuration</a></span></dt><dt><span class="section"><a href="index.html#module-services-taskserver-nixos-taskserver-tool">36.2. The nixos-taskserver tool</a></span></dt><dt><span class="section"><a href="index.html#module-services-taskserver-declarative-ca-management">36.3. Declarative/automatic CA management</a></span></dt><dt><span class="section"><a href="index.html#module-services-taskserver-manual-ca-management">36.4. Manual CA management</a></span></dt></dl></div><p>
  Taskserver is the server component of
  <a class="link" href="https://taskwarrior.org/" target="_top">Taskwarrior</a>, a free and
  open source todo list application.
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span>
  <a class="link" href="https://taskwarrior.org/docs/#taskd" target="_top">https://taskwarrior.org/docs/#taskd</a>
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-taskserver-configuration"></a>36.1. Configuration</h2></div></div></div><p>
   Taskserver does all of its authentication via TLS using client certificates,
   so you either need to roll your own CA or purchase a certificate from a
   known CA, which allows creation of client certificates. These certificates
   are usually advertised as <span class="quote">“<span class="quote">server certificates</span>”</span>.
  </p><p>
   So in order to make it easier to handle your own CA, there is a helper tool
   called <span class="command"><strong>nixos-taskserver</strong></span> which manages the custom CA along
   with Taskserver organisations, users and groups.
  </p><p>
   While the client certificates in Taskserver only authenticate whether a user
   is allowed to connect, every user has its own UUID which identifies it as an
   entity.
  </p><p>
   With <span class="command"><strong>nixos-taskserver</strong></span> the client certificate is created
   along with the UUID of the user, so it handles all of the credentials needed
   in order to setup the Taskwarrior client to work with a Taskserver.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-taskserver-nixos-taskserver-tool"></a>36.2. The nixos-taskserver tool</h2></div></div></div><p>
   Because Taskserver by default only provides scripts to setup users
   imperatively, the <span class="command"><strong>nixos-taskserver</strong></span> tool is used for
   addition and deletion of organisations along with users and groups defined
   by <a class="xref" href="options.html#opt-services.taskserver.organisations"><code class="option">services.taskserver.organisations</code></a> and as well for
   imperative set up.
  </p><p>
   The tool is designed to not interfere if the command is used to manually set
   up some organisations, users or groups.
  </p><p>
   For example if you add a new organisation using <span class="command"><strong>nixos-taskserver
   org add foo</strong></span>, the organisation is not modified and deleted no
   matter what you define in
   <code class="option">services.taskserver.organisations</code>, even if you're adding
   the same organisation in that option.
  </p><p>
   The tool is modelled to imitate the official <span class="command"><strong>taskd</strong></span>
   command, documentation for each subcommand can be shown by using the
   <code class="option">--help</code> switch.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-taskserver-declarative-ca-management"></a>36.3. Declarative/automatic CA management</h2></div></div></div><p>
   Everything is done according to what you specify in the module options,
   however in order to set up a Taskwarrior client for synchronisation with a
   Taskserver instance, you have to transfer the keys and certificates to the
   client machine.
  </p><p>
   This is done using <span class="command"><strong>nixos-taskserver user export $orgname
   $username</strong></span> which is printing a shell script fragment to stdout
   which can either be used verbatim or adjusted to import the user on the
   client machine.
  </p><p>
   For example, let's say you have the following configuration:
</p><pre class="screen">
{
  <a class="xref" href="options.html#opt-services.taskserver.enable"><code class="option">services.taskserver.enable</code></a> = true;
  <a class="xref" href="options.html#opt-services.taskserver.fqdn"><code class="option">services.taskserver.fqdn</code></a> = "server";
  <a class="xref" href="options.html#opt-services.taskserver.listenHost"><code class="option">services.taskserver.listenHost</code></a> = "::";
  <a class="link" href="options.html#opt-services.taskserver.organisations._name_.users">services.taskserver.organisations.my-company.users</a> = [ "alice" ];
}
</pre><p>
   This creates an organisation called <code class="literal">my-company</code> with the
   user <code class="literal">alice</code>.
  </p><p>
   Now in order to import the <code class="literal">alice</code> user to another machine
   <code class="literal">alicebox</code>, all we need to do is something like this:
</p><pre class="screen">
<code class="prompt">$ </code>ssh server nixos-taskserver user export my-company alice | sh
</pre><p>
   Of course, if no SSH daemon is available on the server you can also copy
   &amp; paste it directly into a shell.
  </p><p>
   After this step the user should be set up and you can start synchronising
   your tasks for the first time with <span class="command"><strong>task sync init</strong></span> on
   <code class="literal">alicebox</code>.
  </p><p>
   Subsequent synchronisation requests merely require the command <span class="command"><strong>task
   sync</strong></span> after that stage.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-taskserver-manual-ca-management"></a>36.4. Manual CA management</h2></div></div></div><p>
   If you set any options within
   <a class="link" href="options.html#opt-services.taskserver.pki.manual.ca.cert">service.taskserver.pki.manual</a>.*,
   <span class="command"><strong>nixos-taskserver</strong></span> won't issue certificates, but you can
   still use it for adding or removing user accounts.
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-sourcehut"></a>Chapter 37. Sourcehut</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-sourcehut-basic-usage">37.1. Basic usage</a></span></dt><dt><span class="section"><a href="index.html#module-services-sourcehut-configuration">37.2. Configuration</a></span></dt><dt><span class="section"><a href="index.html#module-services-sourcehut-httpd">37.3. Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)</a></span></dt></dl></div><p>
  <a class="link" href="https://sr.ht.com/" target="_top">Sourcehut</a> is an open-source,
  self-hostable software development platform. The server setup can be automated using
  <a class="link" href="options.html#opt-services.sourcehut.enable">services.sourcehut</a>.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-sourcehut-basic-usage"></a>37.1. Basic usage</h2></div></div></div><p>
   Sourcehut is a Python and Go based set of applications.
   This NixOS module also provides basic configuration integrating Sourcehut into locally running
   <code class="literal"><a class="link" href="options.html#opt-services.nginx.enable">services.nginx</a></code>,
   <code class="literal"><a class="link" href="options.html#opt-services.redis.servers">services.redis.servers.sourcehut</a></code>,
   <code class="literal"><a class="link" href="options.html#opt-services.postfix.enable">services.postfix</a></code>
   and
   <code class="literal"><a class="link" href="options.html#opt-services.postgresql.enable">services.postgresql</a></code> services.
  </p><p>
   A very basic configuration may look like this:
</p><pre class="programlisting">
{ pkgs, ... }:
let
  fqdn =
    let
      join = hostName: domain: hostName + optionalString (domain != null) ".${domain}";
    in join config.networking.hostName config.networking.domain;
in {

  networking = {
    <a class="link" href="options.html#opt-networking.hostName">hostName</a> = "srht";
    <a class="link" href="options.html#opt-networking.domain">domain</a> = "tld";
    <a class="link" href="options.html#opt-networking.firewall.allowedTCPPorts">firewall.allowedTCPPorts</a> = [ 22 80 443 ];
  };

  services.sourcehut = {
    <a class="link" href="options.html#opt-services.sourcehut.enable">enable</a> = true;
    <a class="link" href="options.html#opt-services.sourcehut.git.enable">git.enable</a> = true;
    <a class="link" href="options.html#opt-services.sourcehut.man.enable">man.enable</a> = true;
    <a class="link" href="options.html#opt-services.sourcehut.meta.enable">meta.enable</a> = true;
    <a class="link" href="options.html#opt-services.sourcehut.nginx.enable">nginx.enable</a> = true;
    <a class="link" href="options.html#opt-services.sourcehut.postfix.enable">postfix.enable</a> = true;
    <a class="link" href="options.html#opt-services.sourcehut.postgresql.enable">postgresql.enable</a> = true;
    <a class="link" href="options.html#opt-services.sourcehut.redis.enable">redis.enable</a> = true;
    <a class="link" href="options.html#opt-services.sourcehut.settings">settings</a> = {
        "sr.ht" = {
          environment = "production";
          global-domain = fqdn;
          origin = "https://${fqdn}";
          # Produce keys with srht-keygen from <span class="package">sourcehut.coresrht</span>.
          network-key = "/run/keys/path/to/network-key";
          service-key = "/run/keys/path/to/service-key";
        };
        webhooks.private-key= "/run/keys/path/to/webhook-key";
    };
  };

  <a class="link" href="options.html#opt-security.acme.certs._name_.extraDomainNames">security.acme.certs."${fqdn}".extraDomainNames</a> = [
    "meta.${fqdn}"
    "man.${fqdn}"
    "git.${fqdn}"
  ];

  services.nginx = {
    <a class="link" href="options.html#opt-services.nginx.enable">enable</a> = true;
    # only recommendedProxySettings are strictly required, but the rest make sense as well.
    <a class="link" href="options.html#opt-services.nginx.recommendedTlsSettings">recommendedTlsSettings</a> = true;
    <a class="link" href="options.html#opt-services.nginx.recommendedOptimisation">recommendedOptimisation</a> = true;
    <a class="link" href="options.html#opt-services.nginx.recommendedGzipSettings">recommendedGzipSettings</a> = true;
    <a class="link" href="options.html#opt-services.nginx.recommendedProxySettings">recommendedProxySettings</a> = true;

    # Settings to setup what certificates are used for which endpoint.
    <a class="link" href="options.html#opt-services.nginx.virtualHosts">virtualHosts</a> = {
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.enableACME">"${fqdn}".enableACME</a> = true;
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.useACMEHost">"meta.${fqdn}".useACMEHost</a> = fqdn:
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.useACMEHost">"man.${fqdn}".useACMEHost</a> = fqdn:
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.useACMEHost">"git.${fqdn}".useACMEHost</a> = fqdn:
    };
  };
}
</pre><p>
  </p><p>
   The <code class="literal">hostName</code> option is used internally to configure the nginx
   reverse-proxy. The <code class="literal">settings</code> attribute set is
   used by the configuration generator and the result is placed in <code class="literal">/etc/sr.ht/config.ini</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-sourcehut-configuration"></a>37.2. Configuration</h2></div></div></div><p>
   All configuration parameters are also stored in
   <code class="literal">/etc/sr.ht/config.ini</code> which is generated by
   the module and linked from the store to ensure that all values from <code class="literal">config.ini</code>
   can be modified by the module.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-sourcehut-httpd"></a>37.3. Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)</h2></div></div></div><p>
   By default, <span class="package">nginx</span> is used as reverse-proxy for <span class="package">sourcehut</span>.
   However, it's possible to use e.g. <span class="package">httpd</span> by explicitly disabling
   <span class="package">nginx</span> using <a class="xref" href="options.html#opt-services.nginx.enable"><code class="option">services.nginx.enable</code></a> and fixing the
   <code class="literal">settings</code>.
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-gitlab"></a>Chapter 38. GitLab</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-gitlab-prerequisites">38.1. Prerequisites</a></span></dt><dt><span class="section"><a href="index.html#module-services-gitlab-configuring">38.2. Configuring</a></span></dt><dt><span class="section"><a href="index.html#module-services-gitlab-maintenance">38.3. Maintenance</a></span></dt></dl></div><p>
  GitLab is a feature-rich git hosting service.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-gitlab-prerequisites"></a>38.1. Prerequisites</h2></div></div></div><p>
   The <code class="literal">gitlab</code> service exposes only an Unix socket at
   <code class="literal">/run/gitlab/gitlab-workhorse.socket</code>. You need to
   configure a webserver to proxy HTTP requests to the socket.
  </p><p>
   For instance, the following configuration could be used to use nginx as
   frontend proxy:
</p><pre class="programlisting">
<a class="link" href="options.html#opt-services.nginx.enable">services.nginx</a> = {
  <a class="link" href="options.html#opt-services.nginx.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.nginx.recommendedGzipSettings">recommendedGzipSettings</a> = true;
  <a class="link" href="options.html#opt-services.nginx.recommendedOptimisation">recommendedOptimisation</a> = true;
  <a class="link" href="options.html#opt-services.nginx.recommendedProxySettings">recommendedProxySettings</a> = true;
  <a class="link" href="options.html#opt-services.nginx.recommendedTlsSettings">recommendedTlsSettings</a> = true;
  <a class="link" href="options.html#opt-services.nginx.virtualHosts">virtualHosts</a>."git.example.com" = {
    <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.enableACME">enableACME</a> = true;
    <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.forceSSL">forceSSL</a> = true;
    <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.locations._name_.proxyPass">locations."/".proxyPass</a> = "http://unix:/run/gitlab/gitlab-workhorse.socket";
  };
};
</pre><p>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-gitlab-configuring"></a>38.2. Configuring</h2></div></div></div><p>
   GitLab depends on both PostgreSQL and Redis and will automatically enable
   both services. In the case of PostgreSQL, a database and a role will be
   created.
  </p><p>
   The default state dir is <code class="literal">/var/gitlab/state</code>. This is where
   all data like the repositories and uploads will be stored.
  </p><p>
   A basic configuration with some custom settings could look like this:
</p><pre class="programlisting">
services.gitlab = {
  <a class="link" href="options.html#opt-services.gitlab.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.gitlab.databasePasswordFile">databasePasswordFile</a> = "/var/keys/gitlab/db_password";
  <a class="link" href="options.html#opt-services.gitlab.initialRootPasswordFile">initialRootPasswordFile</a> = "/var/keys/gitlab/root_password";
  <a class="link" href="options.html#opt-services.gitlab.https">https</a> = true;
  <a class="link" href="options.html#opt-services.gitlab.host">host</a> = "git.example.com";
  <a class="link" href="options.html#opt-services.gitlab.port">port</a> = 443;
  <a class="link" href="options.html#opt-services.gitlab.user">user</a> = "git";
  <a class="link" href="options.html#opt-services.gitlab.group">group</a> = "git";
  smtp = {
    <a class="link" href="options.html#opt-services.gitlab.smtp.enable">enable</a> = true;
    <a class="link" href="options.html#opt-services.gitlab.smtp.address">address</a> = "localhost";
    <a class="link" href="options.html#opt-services.gitlab.smtp.port">port</a> = 25;
  };
  secrets = {
    <a class="link" href="options.html#opt-services.gitlab.secrets.dbFile">dbFile</a> = "/var/keys/gitlab/db";
    <a class="link" href="options.html#opt-services.gitlab.secrets.secretFile">secretFile</a> = "/var/keys/gitlab/secret";
    <a class="link" href="options.html#opt-services.gitlab.secrets.otpFile">otpFile</a> = "/var/keys/gitlab/otp";
    <a class="link" href="options.html#opt-services.gitlab.secrets.jwsFile">jwsFile</a> = "/var/keys/gitlab/jws";
  };
  <a class="link" href="options.html#opt-services.gitlab.extraConfig">extraConfig</a> = {
    gitlab = {
      email_from = "gitlab-no-reply@example.com";
      email_display_name = "Example GitLab";
      email_reply_to = "gitlab-no-reply@example.com";
      default_projects_features = { builds = false; };
    };
  };
};
</pre><p>
  </p><p>
   If you're setting up a new GitLab instance, generate new
   secrets. You for instance use <code class="literal">tr -dc A-Za-z0-9 &lt;
   /dev/urandom | head -c 128 &gt; /var/keys/gitlab/db</code> to
   generate a new db secret. Make sure the files can be read by, and
   only by, the user specified by <a class="link" href="options.html#opt-services.gitlab.user">services.gitlab.user</a>. GitLab
   encrypts sensitive data stored in the database. If you're restoring
   an existing GitLab instance, you must specify the secrets secret
   from <code class="literal">config/secrets.yml</code> located in your GitLab
   state folder.
  </p><p>
    When <code class="literal">incoming_mail.enabled</code> is set to <code class="literal">true</code>
    in <a class="link" href="options.html#opt-services.gitlab.extraConfig">extraConfig</a> an additional
    service called <code class="literal">gitlab-mailroom</code> is enabled for fetching incoming mail.
  </p><p>
   Refer to <a class="xref" href="options.html" title="Appendix A. Configuration Options">Appendix A, <em>Configuration Options</em></a> for all available configuration
   options for the
   <a class="link" href="options.html#opt-services.gitlab.enable">services.gitlab</a> module.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-gitlab-maintenance"></a>38.3. Maintenance</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-gitlab-maintenance-backups"></a>38.3.1. Backups</h3></div></div></div><p>
     Backups can be configured with the options in <a class="link" href="options.html#opt-services.gitlab.backup.keepTime">services.gitlab.backup</a>. Use
     the <a class="link" href="options.html#opt-services.gitlab.backup.startAt">services.gitlab.backup.startAt</a>
     option to configure regular backups.
   </p><p>
     To run a manual backup, start the <code class="literal">gitlab-backup</code> service:
</p><pre class="screen">
<code class="prompt">$ </code>systemctl start gitlab-backup.service
</pre><p>
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-gitlab-maintenance-rake"></a>38.3.2. Rake tasks</h3></div></div></div><p>
    You can run GitLab's rake tasks with <code class="literal">gitlab-rake</code>
    which will be available on the system when GitLab is enabled. You
    will have to run the command as the user that you configured to run
    GitLab with.
   </p><p>
    A list of all availabe rake tasks can be obtained by running:
</p><pre class="screen">
<code class="prompt">$ </code>sudo -u git -H gitlab-rake -T
</pre><p>
   </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-mjolnir"></a>Chapter 39. Mjolnir (Matrix Moderation Tool)</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-mjolnir-setup">39.1. Mjolnir Setup</a></span></dt><dt><span class="section"><a href="index.html#module-services-mjolnir-matrix-synapse-antispam">39.2. Synapse Antispam Module</a></span></dt></dl></div><p>
  This chapter will show you how to set up your own, self-hosted
  <a class="link" href="https://github.com/matrix-org/mjolnir" target="_top">Mjolnir</a>
  instance.
 </p><p>
  As an all-in-one moderation tool, it can protect your server from
  malicious invites, spam messages, and whatever else you don't want.
  In addition to server-level protection, Mjolnir is great for communities
  wanting to protect their rooms without having to use their personal
  accounts for moderation.
 </p><p>
  The bot by default includes support for bans, redactions, anti-spam,
  server ACLs, room directory changes, room alias transfers, account
  deactivation, room shutdown, and more.
 </p><p>
  See the <a class="link" href="https://github.com/matrix-org/mjolnir#readme" target="_top">README</a>
  page and the <a class="link" href="https://github.com/matrix-org/mjolnir/blob/main/docs/moderators.md" target="_top">Moderator's guide</a>
  for additional instructions on how to setup and use Mjolnir.
 </p><p>
  For <a class="link" href="options.html#opt-services.mjolnir.settings">additional settings</a>
  see <a class="link" href="https://github.com/matrix-org/mjolnir/blob/main/config/default.yaml" target="_top">the default configuration</a>.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-mjolnir-setup"></a>39.1. Mjolnir Setup</h2></div></div></div><p>
   First create a new Room which will be used as a management room for Mjolnir. In
   this room, Mjolnir will log possible errors and debugging information. You'll
   need to set this Room-ID in <a class="link" href="options.html#opt-services.mjolnir.managementRoom">services.mjolnir.managementRoom</a>.
  </p><p>
   Next, create a new user for Mjolnir on your homeserver, if not present already.
  </p><p>
   The Mjolnir Matrix user expects to be free of any rate limiting.
   See <a class="link" href="https://github.com/matrix-org/synapse/issues/6286" target="_top">Synapse #6286</a>
   for an example on how to achieve this.
  </p><p>
   If you want Mjolnir to be able to deactivate users, move room aliases, shutdown rooms, etc.
   you'll need to make the Mjolnir user a Matrix server admin.
  </p><p>
   Now invite the Mjolnir user to the management room.
  </p><p>
   It is recommended to use <a class="link" href="https://github.com/matrix-org/pantalaimon" target="_top">Pantalaimon</a>,
   so your management room can be encrypted. This also applies if you are looking to moderate an encrypted room.
  </p><p>
   To enable the Pantalaimon E2E Proxy for mjolnir, enable
   <a class="link" href="options.html#opt-services.mjolnir.pantalaimon.enable">services.mjolnir.pantalaimon</a>. This will
   autoconfigure a new Pantalaimon instance, which will connect to the homeserver
   set in <a class="link" href="options.html#opt-services.mjolnir.homeserverUrl">services.mjolnir.homeserverUrl</a> and Mjolnir itself
   will be configured to connect to the new Pantalaimon instance.
  </p><pre class="programlisting">
{
  services.mjolnir = {
    enable = true;
    <a class="link" href="options.html#opt-services.mjolnir.homeserverUrl">homeserverUrl</a> = "https://matrix.domain.tld";
    <a class="link" href="options.html#opt-services.mjolnir.pantalaimon">pantalaimon</a> = {
       <a class="link" href="options.html#opt-services.mjolnir.pantalaimon.enable">enable</a> = true;
       <a class="link" href="options.html#opt-services.mjolnir.pantalaimon.username">username</a> = "mjolnir";
       <a class="link" href="options.html#opt-services.mjolnir.pantalaimon.passwordFile">passwordFile</a> = "/run/secrets/mjolnir-password";
    };
    <a class="link" href="options.html#opt-services.mjolnir.protectedRooms">protectedRooms</a> = [
      "https://matrix.to/#/!xxx:domain.tld"
    ];
    <a class="link" href="options.html#opt-services.mjolnir.managementRoom">managementRoom</a> = "!yyy:domain.tld";
  };
}
</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-mjolnir-setup-ems"></a>39.1.1. Element Matrix Services (EMS)</h3></div></div></div><p>
   If you are using a managed <a class="link" href="https://ems.element.io/" target="_top">"Element Matrix Services (EMS)"</a>
   server, you will need to consent to the terms and conditions. Upon startup, an error
   log entry with a URL to the consent page will be generated.
  </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-mjolnir-matrix-synapse-antispam"></a>39.2. Synapse Antispam Module</h2></div></div></div><p>
   A Synapse module is also available to apply the same rulesets the bot
   uses across an entire homeserver.
  </p><p>
   To use the Antispam Module, add <span class="package">matrix-synapse-plugins.matrix-synapse-mjolnir-antispam</span>
   to the Synapse plugin list and enable the <code class="literal">mjolnir.Module</code> module.
  </p><pre class="programlisting">
{
  services.matrix-synapse = {
    plugins = with pkgs; [
      matrix-synapse-plugins.matrix-synapse-mjolnir-antispam
    ];
    extraConfig = ''
      modules:
        - module: mjolnir.Module
          config:
            # Prevent servers/users in the ban lists from inviting users on this
            # server to rooms. Default true.
            block_invites: true
            # Flag messages sent by servers/users in the ban lists as spam. Currently
            # this means that spammy messages will appear as empty to users. Default
            # false.
            block_messages: false
            # Remove users from the user directory search by filtering matrix IDs and
            # display names by the entries in the user ban list. Default false.
            block_usernames: false
            # The room IDs of the ban lists to honour. Unlike other parts of Mjolnir,
            # this list cannot be room aliases or permalinks. This server is expected
            # to already be joined to the room - Mjolnir will not automatically join
            # these rooms.
            ban_lists:
              - "!roomid:example.org"
    '';
  };
}
</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-matrix"></a>Chapter 40. Matrix</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-matrix-synapse">40.1. Synapse Homeserver</a></span></dt><dt><span class="section"><a href="index.html#module-services-matrix-element-web">40.2. Element (formerly known as Riot) Web Client</a></span></dt></dl></div><p>
  <a class="link" href="https://matrix.org/" target="_top">Matrix</a> is an open standard for
  interoperable, decentralised, real-time communication over IP. It can be used
  to power Instant Messaging, VoIP/WebRTC signalling, Internet of Things
  communication - or anywhere you need a standard HTTP API for publishing and
  subscribing to data whilst tracking the conversation history.
 </p><p>
  This chapter will show you how to set up your own, self-hosted Matrix
  homeserver using the Synapse reference homeserver, and how to serve your own
  copy of the Element web client. See the
  <a class="link" href="https://matrix.org/docs/projects/try-matrix-now.html" target="_top">Try
  Matrix Now!</a> overview page for links to Element Apps for Android and iOS,
  desktop clients, as well as bridges to other networks and other projects
  around Matrix.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-matrix-synapse"></a>40.1. Synapse Homeserver</h2></div></div></div><p>
   <a class="link" href="https://github.com/matrix-org/synapse" target="_top">Synapse</a> is
   the reference homeserver implementation of Matrix from the core development
   team at matrix.org. The following configuration example will set up a
   synapse server for the <code class="literal">example.org</code> domain, served from
   the host <code class="literal">myhostname.example.org</code>. For more information,
   please refer to the
   <a class="link" href="https://github.com/matrix-org/synapse#synapse-installation" target="_top">
   installation instructions of Synapse </a>.
</p><pre class="programlisting">
{ pkgs, lib, ... }:
let
  fqdn =
    let
      join = hostName: domain: hostName + lib.optionalString (domain != null) ".${domain}";
    in join config.networking.hostName config.networking.domain;
in {
  networking = {
    <a class="link" href="options.html#opt-networking.hostName">hostName</a> = "myhostname";
    <a class="link" href="options.html#opt-networking.domain">domain</a> = "example.org";
  };
  <a class="link" href="options.html#opt-networking.firewall.allowedTCPPorts">networking.firewall.allowedTCPPorts</a> = [ 80 443 ];

  <a class="link" href="options.html#opt-services.postgresql.enable">services.postgresql.enable</a> = true;
  <a class="link" href="options.html#opt-services.postgresql.initialScript">services.postgresql.initialScript</a> = pkgs.writeText "synapse-init.sql" ''
    CREATE ROLE "matrix-synapse" WITH LOGIN PASSWORD 'synapse';
    CREATE DATABASE "matrix-synapse" WITH OWNER "matrix-synapse"
      TEMPLATE template0
      LC_COLLATE = "C"
      LC_CTYPE = "C";
  '';

  services.nginx = {
    <a class="link" href="options.html#opt-services.nginx.enable">enable</a> = true;
    # only recommendedProxySettings and recommendedGzipSettings are strictly required,
    # but the rest make sense as well
    <a class="link" href="options.html#opt-services.nginx.recommendedTlsSettings">recommendedTlsSettings</a> = true;
    <a class="link" href="options.html#opt-services.nginx.recommendedOptimisation">recommendedOptimisation</a> = true;
    <a class="link" href="options.html#opt-services.nginx.recommendedGzipSettings">recommendedGzipSettings</a> = true;
    <a class="link" href="options.html#opt-services.nginx.recommendedProxySettings">recommendedProxySettings</a> = true;

    <a class="link" href="options.html#opt-services.nginx.virtualHosts">virtualHosts</a> = {
      # This host section can be placed on a different host than the rest,
      # i.e. to delegate from the host being accessible as ${config.networking.domain}
      # to another host actually running the Matrix homeserver.
      "${config.networking.domain}" = {
        <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.enableACME">enableACME</a> = true;
        <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.forceSSL">forceSSL</a> = true;

        <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.locations._name_.extraConfig">locations."= /.well-known/matrix/server".extraConfig</a> =
          let
            # use 443 instead of the default 8448 port to unite
            # the client-server and server-server port for simplicity
            server = { "m.server" = "${fqdn}:443"; };
          in ''
            add_header Content-Type application/json;
            return 200 '${builtins.toJSON server}';
          '';
        <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.locations._name_.extraConfig">locations."= /.well-known/matrix/client".extraConfig</a> =
          let
            client = {
              "m.homeserver" =  { "base_url" = "https://${fqdn}"; };
              "m.identity_server" =  { "base_url" = "https://vector.im"; };
            };
          # ACAO required to allow element-web on any URL to request this json file
          in ''
            add_header Content-Type application/json;
            add_header Access-Control-Allow-Origin *;
            return 200 '${builtins.toJSON client}';
          '';
      };

      # Reverse proxy for Matrix client-server and server-server communication
      ${fqdn} = {
        <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.enableACME">enableACME</a> = true;
        <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.forceSSL">forceSSL</a> = true;

        # Or do a redirect instead of the 404, or whatever is appropriate for you.
        # But do not put a Matrix Web client here! See the Element web section below.
        <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.locations._name_.extraConfig">locations."/".extraConfig</a> = ''
          return 404;
        '';

        # forward all Matrix API calls to the synapse Matrix homeserver
        locations."/_matrix" = {
          <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.locations._name_.proxyPass">proxyPass</a> = "http://[::1]:8008"; # without a trailing /
        };
      };
    };
  };
  services.matrix-synapse = {
    <a class="link" href="options.html#opt-services.matrix-synapse.enable">enable</a> = true;
    <a class="link" href="options.html#opt-services.matrix-synapse.settings.server_name">server_name</a> = config.networking.domain;
    <a class="link" href="options.html#opt-services.matrix-synapse.settings.listeners">listeners</a> = [
      {
        <a class="link" href="options.html#opt-services.matrix-synapse.settings.listeners._.port">port</a> = 8008;
        <a class="link" href="options.html#opt-services.matrix-synapse.settings.listeners._.bind_addresses">bind_addresses</a> = [ "::1" ];
        <a class="link" href="options.html#opt-services.matrix-synapse.settings.listeners._.type">type</a> = "http";
        <a class="link" href="options.html#opt-services.matrix-synapse.settings.listeners._.tls">tls</a> = false;
        <a class="link" href="options.html#opt-services.matrix-synapse.settings.listeners._.x_forwarded">x_forwarded</a> = true;
        <a class="link" href="options.html#opt-services.matrix-synapse.settings.listeners._.resources">resources</a> = [ {
          <a class="link" href="options.html#opt-services.matrix-synapse.settings.listeners._.resources._.names">names</a> = [ "client" ];
          <a class="link" href="options.html#opt-services.matrix-synapse.settings.listeners._.resources._.compress">compress</a> = true;
        } {
          <a class="link" href="options.html#opt-services.matrix-synapse.settings.listeners._.resources._.names">names</a> = [ "federation" ];
          <a class="link" href="options.html#opt-services.matrix-synapse.settings.listeners._.resources._.compress">compress</a> = false;
        } ];
      }
    ];
  };
}
</pre><p>
  </p><p>
   If the <code class="code">A</code> and <code class="code">AAAA</code> DNS records on
   <code class="literal">example.org</code> do not point on the same host as the records
   for <code class="code">myhostname.example.org</code>, you can easily move the
   <code class="code">/.well-known</code> virtualHost section of the code to the host that
   is serving <code class="literal">example.org</code>, while the rest stays on
   <code class="literal">myhostname.example.org</code> with no other changes required.
   This pattern also allows to seamlessly move the homeserver from
   <code class="literal">myhostname.example.org</code> to
   <code class="literal">myotherhost.example.org</code> by only changing the
   <code class="code">/.well-known</code> redirection target.
  </p><p>
   If you want to run a server with public registration by anybody, you can
   then enable <code class="literal"><a class="link" href="options.html#opt-services.matrix-synapse.settings.enable_registration">services.matrix-synapse.settings.enable_registration</a> =
   true;</code>. Otherwise, or you can generate a registration secret with
   <span class="command"><strong>pwgen -s 64 1</strong></span> and set it with
   <code class="option"><a class="link" href="options.html#opt-services.matrix-synapse.settings.registration_shared_secret">services.matrix-synapse.settings.registration_shared_secret</a></code>.
   To create a new user or admin, run the following after you have set the secret
   and have rebuilt NixOS:
</p><pre class="screen">
<code class="prompt">$ </code>nix run nixpkgs.matrix-synapse
<code class="prompt">$ </code>register_new_matrix_user -k <em class="replaceable"><code>your-registration-shared-secret</code></em> http://localhost:8008
<code class="prompt">New user localpart: </code><em class="replaceable"><code>your-username</code></em>
<code class="prompt">Password:</code>
<code class="prompt">Confirm password:</code>
<code class="prompt">Make admin [no]:</code>
Success!
</pre><p>
   In the example, this would create a user with the Matrix Identifier
   <code class="literal">@your-username:example.org</code>. Note that the registration
   secret ends up in the nix store and therefore is world-readable by any user
   on your machine, so it makes sense to only temporarily activate the
   <a class="link" href="options.html#opt-services.matrix-synapse.settings.registration_shared_secret">registration_shared_secret</a>
   option until a better solution for NixOS is in place.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-matrix-element-web"></a>40.2. Element (formerly known as Riot) Web Client</h2></div></div></div><p>
   <a class="link" href="https://github.com/vector-im/riot-web/" target="_top">Element Web</a> is
   the reference web client for Matrix and developed by the core team at
   matrix.org. Element was formerly known as Riot.im, see the
   <a class="link" href="https://element.io/blog/welcome-to-element/" target="_top">Element introductory blog post</a>
   for more information. The following snippet can be optionally added to the code before
   to complete the synapse installation with a web client served at
   <code class="code">https://element.myhostname.example.org</code> and
   <code class="code">https://element.example.org</code>. Alternatively, you can use the hosted
   copy at <a class="link" href="https://app.element.io/" target="_top">https://app.element.io/</a>,
   or use other web clients or native client applications. Due to the
   <code class="literal">/.well-known</code> urls set up done above, many clients should
   fill in the required connection details automatically when you enter your
   Matrix Identifier. See
   <a class="link" href="https://matrix.org/docs/projects/try-matrix-now.html" target="_top">Try
   Matrix Now!</a> for a list of existing clients and their supported
   featureset.
</p><pre class="programlisting">
{
  services.nginx.virtualHosts."element.${fqdn}" = {
    <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.enableACME">enableACME</a> = true;
    <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.forceSSL">forceSSL</a> = true;
    <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.serverAliases">serverAliases</a> = [
      "element.${config.networking.domain}"
    ];

    <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.root">root</a> = pkgs.element-web.override {
      conf = {
        default_server_config."m.homeserver" = {
          "base_url" = "https://${fqdn}";
          "server_name" = "${fqdn}";
        };
      };
    };
  };
}
</pre><p>
  </p><p>
   Note that the Element developers do not recommend running Element and your Matrix
   homeserver on the same fully-qualified domain name for security reasons. In
   the example, this means that you should not reuse the
   <code class="literal">myhostname.example.org</code> virtualHost to also serve Element,
   but instead serve it on a different subdomain, like
   <code class="literal">element.example.org</code> in the example. See the
   <a class="link" href="https://github.com/vector-im/riot-web#important-security-note" target="_top">Element
   Important Security Notes</a> for more information on this subject.
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-mailman"></a>Chapter 41. Mailman</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-mailman-basic-usage">41.1. Basic usage with Postfix</a></span></dt><dt><span class="section"><a href="index.html#module-services-mailman-other-mtas">41.2. Using with other MTAs</a></span></dt></dl></div><p>
    <a class="link" href="https://www.list.org" target="_top">Mailman</a> is free
    software for managing electronic mail discussion and e-newsletter
    lists. Mailman and its web interface can be configured using the
    corresponding NixOS module. Note that this service is best used with
    an existing, securely configured Postfix setup, as it does not automatically configure this.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-mailman-basic-usage"></a>41.1. Basic usage with Postfix</h2></div></div></div><p>
      For a basic configuration with Postfix as the MTA, the following settings are suggested:
      </p><pre class="programlisting">{ config, ... }: {
  services.postfix = {
    enable = true;
    relayDomains = ["hash:/var/lib/mailman/data/postfix_domains"];
    sslCert = config.security.acme.certs."lists.example.org".directory + "/full.pem";
    sslKey = config.security.acme.certs."lists.example.org".directory + "/key.pem";
    config = {
      transport_maps = ["hash:/var/lib/mailman/data/postfix_lmtp"];
      local_recipient_maps = ["hash:/var/lib/mailman/data/postfix_lmtp"];
    };
  };
  services.mailman = {
    <a class="link" href="options.html#opt-services.mailman.enable">enable</a> = true;
    <a class="link" href="options.html#opt-services.mailman.serve.enable">serve.enable</a> = true;
    <a class="link" href="options.html#opt-services.mailman.hyperkitty.enable">hyperkitty.enable</a> = true;
    <a class="link" href="options.html#opt-services.mailman.webHosts">webHosts</a> = ["lists.example.org"];
    <a class="link" href="options.html#opt-services.mailman.siteOwner">siteOwner</a> = "mailman@example.org";
  };
  <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.enableACME">services.nginx.virtualHosts."lists.example.org".enableACME</a> = true;
  <a class="link" href="options.html#opt-networking.firewall.allowedTCPPorts">networking.firewall.allowedTCPPorts</a> = [ 25 80 443 ];
}</pre><p>
    </p><p>
      DNS records will also be required:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">AAAA</code> and <code class="literal">A</code> records pointing to the host in question, in order for browsers to be able to discover the address of the web server;</p></li><li class="listitem"><p>An <code class="literal">MX</code> record pointing to a domain name at which the host is reachable, in order for other mail servers to be able to deliver emails to the mailing lists it hosts.</p></li></ul></div><p>
    </p><p>
      After this has been done and appropriate DNS records have been
      set up, the Postorius mailing list manager and the Hyperkitty
      archive browser will be available at
      https://lists.example.org/. Note that this setup is not
      sufficient to deliver emails to most email providers nor to
      avoid spam -- a number of additional measures for authenticating
      incoming and outgoing mails, such as SPF, DMARC and DKIM are
      necessary, but outside the scope of the Mailman module.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-mailman-other-mtas"></a>41.2. Using with other MTAs</h2></div></div></div><p>
      Mailman also supports other MTA, though with a little bit more configuration. For example, to use Mailman with Exim, you can use the following settings:
      </p><pre class="programlisting">{ config, ... }: {
  services = {
    mailman = {
      enable = true;
      siteOwner = "mailman@example.org";
      <a class="link" href="options.html#opt-services.mailman.enablePostfix">enablePostfix</a> = false;
      settings.mta = {
        incoming = "mailman.mta.exim4.LMTP";
        outgoing = "mailman.mta.deliver.deliver";
        lmtp_host = "localhost";
        lmtp_port = "8024";
        smtp_host = "localhost";
        smtp_port = "25";
        configuration = "python:mailman.config.exim4";
      };
    };
    exim = {
      enable = true;
      # You can configure Exim in a separate file to reduce configuration.nix clutter
      config = builtins.readFile ./exim.conf;
    };
  };
}</pre><p>
    </p><p>
      The exim config needs some special additions to work with Mailman. Currently
      NixOS can't manage Exim config with such granularity. Please refer to
      <a class="link" href="https://mailman.readthedocs.io/en/latest/src/mailman/docs/mta.html" target="_top">Mailman documentation</a>
      for more info on configuring Mailman for working with Exim.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="trezor"></a>Chapter 42. Trezor</h2></div></div></div><p>
  Trezor is an open-source cryptocurrency hardware wallet and security token
  allowing secure storage of private keys.
 </p><p>
  It offers advanced features such U2F two-factor authorization, SSH login
  through
  <a class="link" href="https://wiki.trezor.io/Apps:SSH_agent" target="_top">Trezor SSH agent</a>,
  <a class="link" href="https://wiki.trezor.io/GPG" target="_top">GPG</a> and a
  <a class="link" href="https://wiki.trezor.io/Trezor_Password_Manager" target="_top">password manager</a>.
  For more information, guides and documentation, see <a class="link" href="https://wiki.trezor.io" target="_top">https://wiki.trezor.io</a>.
 </p><p>
  To enable Trezor support, add the following to your <code class="filename">configuration.nix</code>:
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.trezord.enable"><code class="option">services.trezord.enable</code></a> = true;
</pre><p>
  This will add all necessary udev rules and start Trezor Bridge.
 </p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-emacs"></a>Chapter 43. Emacs</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-emacs-installing">43.1. Installing <span class="application">Emacs</span></a></span></dt><dt><span class="section"><a href="index.html#module-services-emacs-running">43.2. Running Emacs as a Service</a></span></dt><dt><span class="section"><a href="index.html#module-services-emacs-configuring">43.3. Configuring Emacs</a></span></dt></dl></div><p>
  <a class="link" href="https://www.gnu.org/software/emacs/" target="_top">Emacs</a> is an
  extensible, customizable, self-documenting real-time display editor — and
  more. At its core is an interpreter for Emacs Lisp, a dialect of the Lisp
  programming language with extensions to support text editing.
 </p><p>
  Emacs runs within a graphical desktop environment using the X Window System,
  but works equally well on a text terminal. Under
  <span class="productname">macOS</span>, a "Mac port" edition is available, which
  uses Apple's native GUI frameworks.
 </p><p>
  <span class="productname">Nixpkgs</span> provides a superior environment for
  running <span class="application">Emacs</span>. It's simple to create custom builds
  by overriding the default packages. Chaotic collections of Emacs Lisp code
  and extensions can be brought under control using declarative package
  management. <span class="productname">NixOS</span> even provides a
  <span class="command"><strong>systemd</strong></span> user service for automatically starting the Emacs
  daemon.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-emacs-installing"></a>43.1. Installing <span class="application">Emacs</span></h2></div></div></div><p>
   Emacs can be installed in the normal way for Nix (see
   <a class="xref" href="index.html#sec-package-management" title="Chapter 6. Package Management">Chapter 6, <em>Package Management</em></a>). In addition, a NixOS
   <span class="emphasis"><em>service</em></span> can be enabled.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-emacs-releases"></a>43.1.1. The Different Releases of Emacs</h3></div></div></div><p>
    <span class="productname">Nixpkgs</span> defines several basic Emacs packages.
    The following are attributes belonging to the <code class="varname">pkgs</code> set:
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
       <code class="varname">emacs</code>
      , </span><span class="term">
       <code class="varname">emacs</code>
      </span></dt><dd><p>
        The latest stable version of Emacs using the
        <a class="link" href="http://www.gtk.org" target="_top">GTK 2</a>
        widget toolkit.
       </p></dd><dt><span class="term">
       <code class="varname">emacs-nox</code>
      </span></dt><dd><p>
        Emacs built without any dependency on X11 libraries.
       </p></dd><dt><span class="term">
       <code class="varname">emacsMacport</code>
      , </span><span class="term">
       <code class="varname">emacsMacport</code>
      </span></dt><dd><p>
        Emacs with the "Mac port" patches, providing a more native look and
        feel under macOS.
       </p></dd></dl></div><p>
   </p><p>
    If those aren't suitable, then the following imitation Emacs editors are
    also available in Nixpkgs:
    <a class="link" href="https://www.gnu.org/software/zile/" target="_top">Zile</a>,
    <a class="link" href="http://homepage.boetes.org/software/mg/" target="_top">mg</a>,
    <a class="link" href="http://yi-editor.github.io/" target="_top">Yi</a>,
    <a class="link" href="https://joe-editor.sourceforge.io/" target="_top">jmacs</a>.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-emacs-adding-packages"></a>43.1.2. Adding Packages to Emacs</h3></div></div></div><p>
    Emacs includes an entire ecosystem of functionality beyond text editing,
    including a project planner, mail and news reader, debugger interface,
    calendar, and more.
   </p><p>
    Most extensions are gotten with the Emacs packaging system
    (<code class="filename">package.el</code>) from
    <a class="link" href="https://elpa.gnu.org/" target="_top">Emacs Lisp Package Archive
    (<acronym class="acronym">ELPA</acronym>)</a>,
    <a class="link" href="https://melpa.org/" target="_top"><acronym class="acronym">MELPA</acronym></a>,
    <a class="link" href="https://stable.melpa.org/" target="_top">MELPA Stable</a>, and
    <a class="link" href="http://orgmode.org/elpa.html" target="_top">Org ELPA</a>. Nixpkgs is
    regularly updated to mirror all these archives.
   </p><p>
    Under NixOS, you can continue to use
    <code class="function">package-list-packages</code> and
    <code class="function">package-install</code> to install packages. You can also
    declare the set of Emacs packages you need using the derivations from
    Nixpkgs. The rest of this section discusses declarative installation of
    Emacs packages through nixpkgs.
   </p><p>
    The first step to declare the list of packages you want in your Emacs
    installation is to create a dedicated derivation. This can be done in a
    dedicated <code class="filename">emacs.nix</code> file such as:
    </p><div class="example"><a id="ex-emacsNix"></a><p class="title"><strong>Example 43.1. Nix expression to build Emacs with packages (<code class="filename">emacs.nix</code>)</strong></p><div class="example-contents"><pre class="programlisting">
/*
This is a nix expression to build Emacs and some Emacs packages I like
from source on any distribution where Nix is installed. This will install
all the dependencies from the nixpkgs repository and build the binary files
without interfering with the host distribution.

To build the project, type the following from the current directory:

$ nix-build emacs.nix

To run the newly compiled executable:

$ ./result/bin/emacs
*/
{ pkgs ? import &lt;nixpkgs&gt; {} }: <a id="ex-emacsNix-1"></a><span><img src="images/callouts/1.svg" alt="1" border="0" /></span>

let
  myEmacs = pkgs.emacs; <a id="ex-emacsNix-2"></a><span><img src="images/callouts/2.svg" alt="2" border="0" /></span>
  emacsWithPackages = (pkgs.emacsPackagesFor myEmacs).emacsWithPackages; <a id="ex-emacsNix-3"></a><span><img src="images/callouts/3.svg" alt="3" border="0" /></span>
in
  emacsWithPackages (epkgs: (with epkgs.melpaStablePackages; [ <a id="ex-emacsNix-4"></a><span><img src="images/callouts/4.svg" alt="4" border="0" /></span>
    magit          # ; Integrate git &lt;C-x g&gt;
    zerodark-theme # ; Nicolas' theme
  ]) ++ (with epkgs.melpaPackages; [ <a id="ex-emacsNix-5"></a><span><img src="images/callouts/5.svg" alt="5" border="0" /></span>
    undo-tree      # ; &lt;C-x u&gt; to show the undo tree
    zoom-frm       # ; increase/decrease font size for all buffers %lt;C-x C-+&gt;
  ]) ++ (with epkgs.elpaPackages; [ <a id="ex-emacsNix-6"></a><span><img src="images/callouts/6.svg" alt="6" border="0" /></span>
    auctex         # ; LaTeX mode
    beacon         # ; highlight my cursor when scrolling
    nameless       # ; hide current package name everywhere in elisp code
  ]) ++ [
    pkgs.notmuch   # From main packages set <a id="ex-emacsNix-7"></a><span><img src="images/callouts/7.svg" alt="7" border="0" /></span>
  ])
</pre></div></div><p><br class="example-break" />
    </p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#ex-emacsNix-1"><span><img src="images/callouts/1.svg" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
       The first non-comment line in this file (<code class="literal">{ pkgs ? ...
       }</code>) indicates that the whole file represents a function.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#ex-emacsNix-2"><span><img src="images/callouts/2.svg" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
       The <code class="varname">let</code> expression below defines a
       <code class="varname">myEmacs</code> binding pointing to the current stable
       version of Emacs. This binding is here to separate the choice of the
       Emacs binary from the specification of the required packages.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#ex-emacsNix-3"><span><img src="images/callouts/3.svg" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
       This generates an <code class="varname">emacsWithPackages</code> function. It
       takes a single argument: a function from a package set to a list of
       packages (the packages that will be available in Emacs).
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#ex-emacsNix-4"><span><img src="images/callouts/4.svg" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
       The rest of the file specifies the list of packages to install. In the
       example, two packages (<code class="varname">magit</code> and
       <code class="varname">zerodark-theme</code>) are taken from MELPA stable.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#ex-emacsNix-5"><span><img src="images/callouts/5.svg" alt="5" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
       Two packages (<code class="varname">undo-tree</code> and
       <code class="varname">zoom-frm</code>) are taken from MELPA.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#ex-emacsNix-6"><span><img src="images/callouts/6.svg" alt="6" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
       Three packages are taken from GNU ELPA.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#ex-emacsNix-7"><span><img src="images/callouts/7.svg" alt="7" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
       <code class="varname">notmuch</code> is taken from a nixpkgs derivation which
       contains an Emacs mode.
      </p></td></tr></table></div><p>
   </p><p>
    The result of this configuration will be an <span class="command"><strong>emacs</strong></span>
    command which launches Emacs with all of your chosen packages in the
    <code class="varname">load-path</code>.
   </p><p>
    You can check that it works by executing this in a terminal:
</p><pre class="screen">
<code class="prompt">$ </code>nix-build emacs.nix
<code class="prompt">$ </code>./result/bin/emacs -q
</pre><p>
    and then typing <code class="literal">M-x package-initialize</code>. Check that you
    can use all the packages you want in this Emacs instance. For example, try
    switching to the zerodark theme through <code class="literal">M-x load-theme &lt;RET&gt;
    zerodark &lt;RET&gt; y</code>.
   </p><div class="tip"><h3 class="title">Tip</h3><p>
     A few popular extensions worth checking out are: auctex, company,
     edit-server, flycheck, helm, iedit, magit, multiple-cursors, projectile,
     and yasnippet.
    </p></div><p>
    The list of available packages in the various ELPA repositories can be seen
    with the following commands:
    </p><div class="example"><a id="module-services-emacs-querying-packages"></a><p class="title"><strong>Example 43.2. Querying Emacs packages</strong></p><div class="example-contents"><pre class="programlisting">
nix-env -f "&lt;nixpkgs&gt;" -qaP -A emacs.pkgs.elpaPackages
nix-env -f "&lt;nixpkgs&gt;" -qaP -A emacs.pkgs.melpaPackages
nix-env -f "&lt;nixpkgs&gt;" -qaP -A emacs.pkgs.melpaStablePackages
nix-env -f "&lt;nixpkgs&gt;" -qaP -A emacs.pkgs.orgPackages
</pre></div></div><p><br class="example-break" />
   </p><p>
    If you are on NixOS, you can install this particular Emacs for all users by
    adding it to the list of system packages (see
    <a class="xref" href="index.html#sec-declarative-package-mgmt" title="6.1. Declarative Package Management">Section 6.1, “Declarative Package Management”</a>). Simply modify your file
    <code class="filename">configuration.nix</code> to make it contain:
    </p><div class="example"><a id="module-services-emacs-configuration-nix"></a><p class="title"><strong>Example 43.3. Custom Emacs in <code class="filename">configuration.nix</code></strong></p><div class="example-contents"><pre class="programlisting">
{
 environment.systemPackages = [
   # [...]
   (import /path/to/emacs.nix { inherit pkgs; })
  ];
}
</pre></div></div><p><br class="example-break" />
   </p><p>
    In this case, the next <span class="command"><strong>nixos-rebuild switch</strong></span> will take
    care of adding your <span class="command"><strong>emacs</strong></span> to the <code class="varname">PATH</code>
    environment variable (see <a class="xref" href="index.html#sec-changing-config" title="Chapter 3. Changing the Configuration">Chapter 3, <em>Changing the Configuration</em></a>).
   </p><p>
    If you are not on NixOS or want to install this particular Emacs only for
    yourself, you can do so by adding it to your
    <code class="filename">~/.config/nixpkgs/config.nix</code> (see
    <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-modify-via-packageOverrides" target="_top">Nixpkgs
    manual</a>):
    </p><div class="example"><a id="module-services-emacs-config-nix"></a><p class="title"><strong>Example 43.4. Custom Emacs in <code class="filename">~/.config/nixpkgs/config.nix</code></strong></p><div class="example-contents"><pre class="programlisting">
{
  packageOverrides = super: let self = super.pkgs; in {
    myemacs = import /path/to/emacs.nix { pkgs = self; };
  };
}
</pre></div></div><p><br class="example-break" />
   </p><p>
    In this case, the next <code class="literal">nix-env -f '&lt;nixpkgs&gt;' -iA
    myemacs</code> will take care of adding your emacs to the
    <code class="varname">PATH</code> environment variable.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-emacs-advanced"></a>43.1.3. Advanced Emacs Configuration</h3></div></div></div><p>
    If you want, you can tweak the Emacs package itself from your
    <code class="filename">emacs.nix</code>. For example, if you want to have a
    GTK 3-based Emacs instead of the default GTK 2-based binary and remove the
    automatically generated <code class="filename">emacs.desktop</code> (useful if you
    only use <span class="command"><strong>emacsclient</strong></span>), you can change your file
    <code class="filename">emacs.nix</code> in this way:
   </p><div class="example"><a id="ex-emacsGtk3Nix"></a><p class="title"><strong>Example 43.5. Custom Emacs build</strong></p><div class="example-contents"><pre class="programlisting">
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  myEmacs = (pkgs.emacs.override {
    # Use gtk3 instead of the default gtk2
    withGTK3 = true;
    withGTK2 = false;
  }).overrideAttrs (attrs: {
    # I don't want emacs.desktop file because I only use
    # emacsclient.
    postInstall = (attrs.postInstall or "") + ''
      rm $out/share/applications/emacs.desktop
    '';
  });
in [...]
</pre></div></div><br class="example-break" /><p>
    After building this file as shown in <a class="xref" href="index.html#ex-emacsNix" title="Example 43.1. Nix expression to build Emacs with packages (emacs.nix)">Example 43.1, “Nix expression to build Emacs with packages (<code class="filename">emacs.nix</code>)”</a>, you
    will get an GTK 3-based Emacs binary pre-loaded with your favorite packages.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-emacs-running"></a>43.2. Running Emacs as a Service</h2></div></div></div><p>
   <span class="productname">NixOS</span> provides an optional
   <span class="command"><strong>systemd</strong></span> service which launches
   <a class="link" href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html" target="_top">
   Emacs daemon </a> with the user's login session.
  </p><p>
   <span class="emphasis"><em>Source:</em></span>
   <code class="filename">modules/services/editors/emacs.nix</code>
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-emacs-enabling"></a>43.2.1. Enabling the Service</h3></div></div></div><p>
    To install and enable the <span class="command"><strong>systemd</strong></span> user service for Emacs
    daemon, add the following to your <code class="filename">configuration.nix</code>:
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.emacs.enable"><code class="option">services.emacs.enable</code></a> = true;
<a class="xref" href="options.html#opt-services.emacs.package"><code class="option">services.emacs.package</code></a> = import /home/cassou/.emacs.d { pkgs = pkgs; };
</pre><p>
   </p><p>
    The <code class="varname">services.emacs.package</code> option allows a custom
    derivation to be used, for example, one created by
    <code class="function">emacsWithPackages</code>.
   </p><p>
    Ensure that the Emacs server is enabled for your user's Emacs
    configuration, either by customizing the <code class="varname">server-mode</code>
    variable, or by adding <code class="literal">(server-start)</code> to
    <code class="filename">~/.emacs.d/init.el</code>.
   </p><p>
    To start the daemon, execute the following:
</p><pre class="screen">
<code class="prompt">$ </code>nixos-rebuild switch  # to activate the new configuration.nix
<code class="prompt">$ </code>systemctl --user daemon-reload        # to force systemd reload
<code class="prompt">$ </code>systemctl --user start emacs.service  # to start the Emacs daemon
</pre><p>
    The server should now be ready to serve Emacs clients.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-emacs-starting-client"></a>43.2.2. Starting the client</h3></div></div></div><p>
    Ensure that the emacs server is enabled, either by customizing the
    <code class="varname">server-mode</code> variable, or by adding
    <code class="literal">(server-start)</code> to <code class="filename">~/.emacs</code>.
   </p><p>
    To connect to the emacs daemon, run one of the following:
</p><pre class="programlisting">
emacsclient FILENAME
emacsclient --create-frame  # opens a new frame (window)
emacsclient --create-frame --tty  # opens a new frame on the current terminal
</pre><p>
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-emacs-editor-variable"></a>43.2.3. Configuring the <code class="varname">EDITOR</code> variable</h3></div></div></div><p>
    If <a class="xref" href="options.html#opt-services.emacs.defaultEditor"><code class="option">services.emacs.defaultEditor</code></a> is
    <code class="literal">true</code>, the <code class="varname">EDITOR</code> variable will be set
    to a wrapper script which launches <span class="command"><strong>emacsclient</strong></span>.
   </p><p>
    Any setting of <code class="varname">EDITOR</code> in the shell config files will
    override <code class="varname">services.emacs.defaultEditor</code>. To make sure
    <code class="varname">EDITOR</code> refers to the Emacs wrapper script, remove any
    existing <code class="varname">EDITOR</code> assignment from
    <code class="filename">.profile</code>, <code class="filename">.bashrc</code>,
    <code class="filename">.zshenv</code> or any other shell config file.
   </p><p>
    If you have formed certain bad habits when editing files, these can be
    corrected with a shell alias to the wrapper script:
</p><pre class="programlisting">alias vi=$EDITOR</pre><p>
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-emacs-per-user"></a>43.2.4. Per-User Enabling of the Service</h3></div></div></div><p>
    In general, <span class="command"><strong>systemd</strong></span> user services are globally enabled
    by symlinks in <code class="filename">/etc/systemd/user</code>. In the case where
    Emacs daemon is not wanted for all users, it is possible to install the
    service but not globally enable it:
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.emacs.enable"><code class="option">services.emacs.enable</code></a> = false;
<a class="xref" href="options.html#opt-services.emacs.install"><code class="option">services.emacs.install</code></a> = true;
</pre><p>
   </p><p>
    To enable the <span class="command"><strong>systemd</strong></span> user service for just the
    currently logged in user, run:
</p><pre class="programlisting">systemctl --user enable emacs</pre><p>
    This will add the symlink
    <code class="filename">~/.config/systemd/user/emacs.service</code>.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-emacs-configuring"></a>43.3. Configuring Emacs</h2></div></div></div><p>
   The Emacs init file should be changed to load the extension packages at
   startup:
   </p><div class="example"><a id="module-services-emacs-package-initialisation"></a><p class="title"><strong>Example 43.6. Package initialization in <code class="filename">.emacs</code></strong></p><div class="example-contents"><pre class="programlisting">
(require 'package)

;; optional. makes unpure packages archives unavailable
(setq package-archives nil)

(setq package-enable-at-startup nil)
(package-initialize)
</pre></div></div><p><br class="example-break" />
  </p><p>
   After the declarative emacs package configuration has been tested,
   previously downloaded packages can be cleaned up by removing
   <code class="filename">~/.emacs.d/elpa</code> (do make a backup first, in case you
   forgot a package).
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-emacs-major-mode"></a>43.3.1. A Major Mode for Nix Expressions</h3></div></div></div><p>
    Of interest may be <code class="varname">melpaPackages.nix-mode</code>, which
    provides syntax highlighting for the Nix language. This is particularly
    convenient if you regularly edit Nix files.
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-emacs-man-pages"></a>43.3.2. Accessing man pages</h3></div></div></div><p>
    You can use <code class="function">woman</code> to get completion of all available
    man pages. For example, type <code class="literal">M-x woman &lt;RET&gt; nixos-rebuild
    &lt;RET&gt;.</code>
   </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-emacs-docbook-xml"></a>43.3.3. Editing DocBook 5 XML Documents</h3></div></div></div><p>
    Emacs includes
    <a class="link" href="https://www.gnu.org/software/emacs/manual/html_node/nxml-mode/Introduction.html" target="_top">nXML</a>,
    a major-mode for validating and editing XML documents. When editing DocBook
    5.0 documents, such as <a class="link" href="index.html" title="NixOS Manual">this one</a>,
    nXML needs to be configured with the relevant schema, which is not
    included.
   </p><p>
    To install the DocBook 5.0 schemas, either add
    <code class="varname">pkgs.docbook5</code> to
    <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>
    (<a class="link" href="index.html#sec-declarative-package-mgmt" title="6.1. Declarative Package Management">NixOS</a>), or run
    <code class="literal">nix-env -f '&lt;nixpkgs&gt;' -iA docbook5</code>
    (<a class="link" href="index.html#sec-ad-hoc-packages" title="6.2. Ad-Hoc Package Management">Nix</a>).
   </p><p>
    Then customize the variable <code class="varname">rng-schema-locating-files</code> to
    include <code class="filename">~/.emacs.d/schemas.xml</code> and put the following
    text into that file:
    </p><div class="example"><a id="ex-emacs-docbook-xml"></a><p class="title"><strong>Example 43.7. nXML Schema Configuration (<code class="filename">~/.emacs.d/schemas.xml</code>)</strong></p><div class="example-contents"><pre class="programlisting">
&lt;?xml version="1.0"?&gt;
&lt;!--
  To let emacs find this file, evaluate:
  (add-to-list 'rng-schema-locating-files "~/.emacs.d/schemas.xml")
--&gt;
&lt;locatingRules xmlns="http://thaiopensource.com/ns/locating-rules/1.0"&gt;
  &lt;!--
    Use this variation if pkgs.docbook5 is added to environment.systemPackages
  --&gt;
  &lt;namespace ns="http://docbook.org/ns/docbook"
             uri="/run/current-system/sw/share/xml/docbook-5.0/rng/docbookxi.rnc"/&gt;
  &lt;!--
    Use this variation if installing schema with "nix-env -iA pkgs.docbook5".
  &lt;namespace ns="http://docbook.org/ns/docbook"
             uri="../.nix-profile/share/xml/docbook-5.0/rng/docbookxi.rnc"/&gt;
  --&gt;
&lt;/locatingRules&gt;
</pre></div></div><p><br class="example-break" />
   </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-blackfire"></a>Chapter 44. Blackfire profiler</h2></div></div></div><p>
  <span class="emphasis"><em>Source:</em></span>
  <code class="filename">modules/services/development/blackfire.nix</code>
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span>
  <a class="link" href="https://blackfire.io/docs/introduction" target="_top">https://blackfire.io/docs/introduction</a>
 </p><p>
  <a class="link" href="https://blackfire.io" target="_top">Blackfire</a> is a proprietary tool for profiling applications. There are several languages supported by the product but currently only PHP support is packaged in Nixpkgs. The back-end consists of a module that is loaded into the language runtime (called <em class="firstterm">probe</em>) and a service (<em class="firstterm">agent</em>) that the probe connects to and that sends the profiles to the server.
 </p><p>
  To use it, you will need to enable the agent and the probe on your server. The exact method will depend on the way you use PHP but here is an example of NixOS configuration for PHP-FPM:
</p><pre class="programlisting">let
  php = pkgs.php.withExtensions ({ enabled, all }: enabled ++ (with all; [
    blackfire
  ]));
in {
  # Enable the probe extension for PHP-FPM.
  services.phpfpm = {
    phpPackage = php;
  };

  # Enable and configure the agent.
  services.blackfire-agent = {
    enable = true;
    settings = {
      # You will need to get credentials at https://blackfire.io/my/settings/credentials
      # You can also use other options described in https://blackfire.io/docs/up-and-running/configuration/agent
      server-id = "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX";
      server-token = "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX";
    };
  };

  # Make the agent run on start-up.
  # (WantedBy= from the upstream unit not respected: https://github.com/NixOS/nixpkgs/issues/81138)
  # Alternately, you can start it manually with `systemctl start blackfire-agent`.
  systemd.services.blackfire-agent.wantedBy = [ "phpfpm-foo.service" ];
}</pre><p>
 </p><p>
  On your developer machine, you will also want to install <a class="link" href="https://blackfire.io/docs/up-and-running/installation#install-a-profiling-client" target="_top">the client</a> (see <span class="package">blackfire</span> package) or the browser extension to actually trigger the profiling.
 </p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-flatpak"></a>Chapter 45. Flatpak</h2></div></div></div><p>
  <span class="emphasis"><em>Source:</em></span>
  <code class="filename">modules/services/desktop/flatpak.nix</code>
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span>
  <a class="link" href="https://github.com/flatpak/flatpak/wiki" target="_top">https://github.com/flatpak/flatpak/wiki</a>
 </p><p>
  Flatpak is a system for building, distributing, and running sandboxed desktop
  applications on Linux.
 </p><p>
  To enable Flatpak, add the following to your
  <code class="filename">configuration.nix</code>:
</p><pre class="programlisting">
  <a class="xref" href="options.html#opt-services.flatpak.enable"><code class="option">services.flatpak.enable</code></a> = true;
</pre><p>
 </p><p>
  For the sandboxed apps to work correctly, desktop integration portals need to
  be installed. If you run GNOME, this will be handled automatically for you;
  in other cases, you will need to add something like the following to your
  <code class="filename">configuration.nix</code>:
</p><pre class="programlisting">
  <a class="xref" href="options.html#opt-xdg.portal.extraPortals"><code class="option">xdg.portal.extraPortals</code></a> = [ pkgs.xdg-desktop-portal-gtk ];
</pre><p>
 </p><p>
  Then, you will need to add a repository, for example,
  <a class="link" href="https://github.com/flatpak/flatpak/wiki" target="_top">Flathub</a>,
  either using the following commands:
</p><pre class="screen">
<code class="prompt">$ </code>flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
<code class="prompt">$ </code>flatpak update
</pre><p>
  or by opening the
  <a class="link" href="https://flathub.org/repo/flathub.flatpakrepo" target="_top">repository
  file</a> in GNOME Software.
 </p><p>
  Finally, you can search and install programs:
</p><pre class="screen">
<code class="prompt">$ </code>flatpak search bustle
<code class="prompt">$ </code>flatpak install flathub org.freedesktop.Bustle
<code class="prompt">$ </code>flatpak run org.freedesktop.Bustle
</pre><p>
  Again, GNOME Software offers graphical interface for these tasks.
 </p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-postgresql"></a>Chapter 46. PostgreSQL</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-postgres-configuring">46.1. Configuring</a></span></dt><dt><span class="section"><a href="index.html#module-services-postgres-upgrading">46.2. Upgrading</a></span></dt><dt><span class="section"><a href="index.html#module-services-postgres-options">46.3. Options</a></span></dt><dt><span class="section"><a href="index.html#module-services-postgres-plugins">46.4. Plugins</a></span></dt></dl></div><p>
  <span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/databases/postgresql.nix</code>
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="http://www.postgresql.org/docs/" target="_top">http://www.postgresql.org/docs/</a>
 </p><p>
  PostgreSQL is an advanced, free relational database.

 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-postgres-configuring"></a>46.1. Configuring</h2></div></div></div><p>
   To enable PostgreSQL, add the following to your <code class="filename">configuration.nix</code>:
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.postgresql.enable"><code class="option">services.postgresql.enable</code></a> = true;
<a class="xref" href="options.html#opt-services.postgresql.package"><code class="option">services.postgresql.package</code></a> = pkgs.postgresql_11;
</pre><p>
   Note that you are required to specify the desired version of PostgreSQL (e.g. <code class="literal">pkgs.postgresql_11</code>). Since upgrading your PostgreSQL version requires a database dump and reload (see below), NixOS cannot provide a default value for <a class="xref" href="options.html#opt-services.postgresql.package"><code class="option">services.postgresql.package</code></a> such as the most recent release of PostgreSQL.
  </p><p>
   By default, PostgreSQL stores its databases in <code class="filename">/var/lib/postgresql/$psqlSchema</code>. You can override this using <a class="xref" href="options.html#opt-services.postgresql.dataDir"><code class="option">services.postgresql.dataDir</code></a>, e.g.
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.postgresql.dataDir"><code class="option">services.postgresql.dataDir</code></a> = "/data/postgresql";
</pre><p>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-postgres-upgrading"></a>46.2. Upgrading</h2></div></div></div><div class="note"><h3 class="title">Note</h3><p>
    The steps below demonstrate how to upgrade from an older version to <span class="package">pkgs.postgresql_13</span>.
    These instructions are also applicable to other versions.
   </p></div><p>
   Major PostgreSQL upgrades require a downtime and a few imperative steps to be called. This is the case because
   each major version has some internal changes in the databases' state during major releases. Because of that,
   NixOS places the state into <code class="filename">/var/lib/postgresql/&lt;version&gt;</code> where each <code class="literal">version</code>
   can be obtained like this:
</p><pre class="programlisting">
<code class="prompt">$ </code>nix-instantiate --eval -A postgresql_13.psqlSchema
"13"
</pre><p>
   For an upgrade, a script like this can be used to simplify the process:
</p><pre class="programlisting">
{ config, pkgs, ... }:
{
  <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> = [
    (pkgs.writeScriptBin "upgrade-pg-cluster" ''
      set -eux
      # XXX it's perhaps advisable to stop all services that depend on postgresql
      systemctl stop postgresql

      # XXX replace `&lt;new version&gt;` with the psqlSchema here
      export NEWDATA="/var/lib/postgresql/&lt;new version&gt;"

      # XXX specify the postgresql package you'd like to upgrade to
      export NEWBIN="${pkgs.postgresql_13}/bin"

      export OLDDATA="${config.<a class="xref" href="options.html#opt-services.postgresql.dataDir"><code class="option">services.postgresql.dataDir</code></a>}"
      export OLDBIN="${config.<a class="xref" href="options.html#opt-services.postgresql.package"><code class="option">services.postgresql.package</code></a>}/bin"

      install -d -m 0700 -o postgres -g postgres "$NEWDATA"
      cd "$NEWDATA"
      sudo -u postgres $NEWBIN/initdb -D "$NEWDATA"

      sudo -u postgres $NEWBIN/pg_upgrade \
        --old-datadir "$OLDDATA" --new-datadir "$NEWDATA" \
        --old-bindir $OLDBIN --new-bindir $NEWBIN \
        "$@"
    '')
  ];
}
</pre><p>
  </p><p>
   The upgrade process is:
  </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
     Rebuild nixos configuration with the configuration above added to your <code class="filename">configuration.nix</code>. Alternatively, add that into separate file and reference it in <code class="literal">imports</code> list.
    </p></li><li class="listitem"><p>
     Login as root (<code class="literal">sudo su -</code>)
    </p></li><li class="listitem"><p>
     Run <code class="literal">upgrade-pg-cluster</code>. It will stop old postgresql, initialize a new one and migrate the old one to the new one. You may supply arguments like <code class="literal">--jobs 4</code> and <code class="literal">--link</code> to speedup migration process. See <a class="link" href="https://www.postgresql.org/docs/current/pgupgrade.html" target="_top">https://www.postgresql.org/docs/current/pgupgrade.html</a> for details.
    </p></li><li class="listitem"><p>
     Change postgresql package in NixOS configuration to the one you were upgrading to via <a class="xref" href="options.html#opt-services.postgresql.package"><code class="option">services.postgresql.package</code></a>. Rebuild NixOS. This should start new postgres using upgraded data directory and all services you stopped during the upgrade.
    </p></li><li class="listitem"><p>
     After the upgrade it's advisable to analyze the new cluster (as <code class="literal">su -l postgres</code> in the
     <a class="xref" href="options.html#opt-services.postgresql.dataDir"><code class="option">services.postgresql.dataDir</code></a>, in this example <code class="filename">/var/lib/postgresql/13</code>):
</p><pre class="programlisting">
<code class="prompt">$ </code>./analyze_new_cluster.sh
</pre><p>
     </p><div class="warning"><h3 class="title">Warning</h3><p>The next step removes the old state-directory!</p></div><p>
</p><pre class="programlisting">
<code class="prompt">$ </code>./delete_old_cluster.sh
</pre><p>
    </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-postgres-options"></a>46.3. Options</h2></div></div></div><p>
   A complete list of options for the PostgreSQL module may be found <a class="link" href="options.html#opt-services.postgresql.enable">here</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-postgres-plugins"></a>46.4. Plugins</h2></div></div></div><p>
   Plugins collection for each PostgreSQL version can be accessed with <code class="literal">.pkgs</code>. For example, for <code class="literal">pkgs.postgresql_11</code> package, its plugin collection is accessed by <code class="literal">pkgs.postgresql_11.pkgs</code>:
</p><pre class="screen">
<code class="prompt">$ </code>nix repl '&lt;nixpkgs&gt;'

Loading '&lt;nixpkgs&gt;'...
Added 10574 variables.

<code class="prompt">nix-repl&gt; </code>postgresql_11.pkgs.&lt;TAB&gt;&lt;TAB&gt;
postgresql_11.pkgs.cstore_fdw        postgresql_11.pkgs.pg_repack
postgresql_11.pkgs.pg_auto_failover  postgresql_11.pkgs.pg_safeupdate
postgresql_11.pkgs.pg_bigm           postgresql_11.pkgs.pg_similarity
postgresql_11.pkgs.pg_cron           postgresql_11.pkgs.pg_topn
postgresql_11.pkgs.pg_hll            postgresql_11.pkgs.pgjwt
postgresql_11.pkgs.pg_partman        postgresql_11.pkgs.pgroonga
...
</pre><p>
  </p><p>
   To add plugins via NixOS configuration, set <code class="literal">services.postgresql.extraPlugins</code>:
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-services.postgresql.package"><code class="option">services.postgresql.package</code></a> = pkgs.postgresql_11;
<a class="xref" href="options.html#opt-services.postgresql.extraPlugins"><code class="option">services.postgresql.extraPlugins</code></a> = with pkgs.postgresql_11.pkgs; [
  pg_repack
  postgis
];
</pre><p>
  </p><p>
   You can build custom PostgreSQL-with-plugins (to be used outside of NixOS) using function <code class="literal">.withPackages</code>. For example, creating a custom PostgreSQL package in an overlay can look like:
</p><pre class="programlisting">
self: super: {
  postgresql_custom = self.postgresql_11.withPackages (ps: [
    ps.pg_repack
    ps.postgis
  ]);
}
</pre><p>
  </p><p>
   Here's a recipe on how to override a particular plugin through an overlay:
</p><pre class="programlisting">
self: super: {
  postgresql_11 = super.postgresql_11.override { this = self.postgresql_11; } // {
    pkgs = super.postgresql_11.pkgs // {
      pg_repack = super.postgresql_11.pkgs.pg_repack.overrideAttrs (_: {
        name = "pg_repack-v20181024";
        src = self.fetchzip {
          url = "https://github.com/reorg/pg_repack/archive/923fa2f3c709a506e111cc963034bf2fd127aa00.tar.gz";
          sha256 = "17k6hq9xaax87yz79j773qyigm4fwk8z4zh5cyp6z0sxnwfqxxw5";
        };
      });
    };
  };
}
</pre><p>
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-foundationdb"></a>Chapter 47. FoundationDB</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-foundationdb-configuring">47.1. Configuring and basic setup</a></span></dt><dt><span class="section"><a href="index.html#module-services-foundationdb-scaling">47.2. Scaling processes and backup agents</a></span></dt><dt><span class="section"><a href="index.html#module-services-foundationdb-clustering">47.3. Clustering</a></span></dt><dt><span class="section"><a href="index.html#module-services-foundationdb-connectivity">47.4. Client connectivity</a></span></dt><dt><span class="section"><a href="index.html#module-services-foundationdb-authorization">47.5. Client authorization and TLS</a></span></dt><dt><span class="section"><a href="index.html#module-services-foundationdb-disaster-recovery">47.6. Backups and Disaster Recovery</a></span></dt><dt><span class="section"><a href="index.html#module-services-foundationdb-limitations">47.7. Known limitations</a></span></dt><dt><span class="section"><a href="index.html#module-services-foundationdb-options">47.8. Options</a></span></dt><dt><span class="section"><a href="index.html#module-services-foundationdb-full-docs">47.9. Full documentation</a></span></dt></dl></div><p>
  <span class="emphasis"><em>Source:</em></span>
  <code class="filename">modules/services/databases/foundationdb.nix</code>
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span>
  <a class="link" href="https://apple.github.io/foundationdb/" target="_top">https://apple.github.io/foundationdb/</a>
 </p><p>
  <span class="emphasis"><em>Maintainer:</em></span> Austin Seipp
 </p><p>
  <span class="emphasis"><em>Available version(s):</em></span> 5.1.x, 5.2.x, 6.0.x
 </p><p>
  FoundationDB (or "FDB") is an open source, distributed, transactional
  key-value store.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-foundationdb-configuring"></a>47.1. Configuring and basic setup</h2></div></div></div><p>
   To enable FoundationDB, add the following to your
   <code class="filename">configuration.nix</code>:
</p><pre class="programlisting">
services.foundationdb.enable = true;
services.foundationdb.package = pkgs.foundationdb52; # FoundationDB 5.2.x
</pre><p>
  </p><p>
   The <code class="option">services.foundationdb.package</code> option is required, and
   must always be specified. Due to the fact FoundationDB network protocols and
   on-disk storage formats may change between (major) versions, and upgrades
   must be explicitly handled by the user, you must always manually specify
   this yourself so that the NixOS module will use the proper version. Note
   that minor, bugfix releases are always compatible.
  </p><p>
   After running <span class="command"><strong>nixos-rebuild</strong></span>, you can verify whether
   FoundationDB is running by executing <span class="command"><strong>fdbcli</strong></span> (which is
   added to <code class="option">environment.systemPackages</code>):
</p><pre class="screen">
<code class="prompt">$ </code>sudo -u foundationdb fdbcli
Using cluster file `/etc/foundationdb/fdb.cluster'.

The database is available.

Welcome to the fdbcli. For help, type `help'.
<code class="prompt">fdb&gt; </code>status

Using cluster file `/etc/foundationdb/fdb.cluster'.

Configuration:
  Redundancy mode        - single
  Storage engine         - memory
  Coordinators           - 1

Cluster:
  FoundationDB processes - 1
  Machines               - 1
  Memory availability    - 5.4 GB per process on machine with least available
  Fault Tolerance        - 0 machines
  Server time            - 04/20/18 15:21:14

...

<code class="prompt">fdb&gt;</code>
</pre><p>
  </p><p>
   You can also write programs using the available client libraries. For
   example, the following Python program can be run in order to grab the
   cluster status, as a quick example. (This example uses
   <span class="command"><strong>nix-shell</strong></span> shebang support to automatically supply the
   necessary Python modules).
</p><pre class="screen">
<code class="prompt">a@link&gt; </code>cat fdb-status.py
#! /usr/bin/env nix-shell
#! nix-shell -i python -p python pythonPackages.foundationdb52

import fdb
import json

def main():
    fdb.api_version(520)
    db = fdb.open()

    @fdb.transactional
    def get_status(tr):
        return str(tr['\xff\xff/status/json'])

    obj = json.loads(get_status(db))
    print('FoundationDB available: %s' % obj['client']['database_status']['available'])

if __name__ == "__main__":
    main()
<code class="prompt">a@link&gt; </code>chmod +x fdb-status.py
<code class="prompt">a@link&gt; </code>./fdb-status.py
FoundationDB available: True
<code class="prompt">a@link&gt;</code>
</pre><p>
  </p><p>
   FoundationDB is run under the <span class="command"><strong>foundationdb</strong></span> user and group
   by default, but this may be changed in the NixOS configuration. The systemd
   unit <span class="command"><strong>foundationdb.service</strong></span> controls the
   <span class="command"><strong>fdbmonitor</strong></span> process.
  </p><p>
   By default, the NixOS module for FoundationDB creates a single SSD-storage
   based database for development and basic usage. This storage engine is
   designed for SSDs and will perform poorly on HDDs; however it can handle far
   more data than the alternative "memory" engine and is a better default
   choice for most deployments. (Note that you can change the storage backend
   on-the-fly for a given FoundationDB cluster using
   <span class="command"><strong>fdbcli</strong></span>.)
  </p><p>
   Furthermore, only 1 server process and 1 backup agent are started in the
   default configuration. See below for more on scaling to increase this.
  </p><p>
   FoundationDB stores all data for all server processes under
   <code class="filename">/var/lib/foundationdb</code>. You can override this using
   <code class="option">services.foundationdb.dataDir</code>, e.g.
</p><pre class="programlisting">
services.foundationdb.dataDir = "/data/fdb";
</pre><p>
  </p><p>
   Similarly, logs are stored under <code class="filename">/var/log/foundationdb</code>
   by default, and there is a corresponding
   <code class="option">services.foundationdb.logDir</code> as well.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-foundationdb-scaling"></a>47.2. Scaling processes and backup agents</h2></div></div></div><p>
   Scaling the number of server processes is quite easy; simply specify
   <code class="option">services.foundationdb.serverProcesses</code> to be the number of
   FoundationDB worker processes that should be started on the machine.
  </p><p>
   FoundationDB worker processes typically require 4GB of RAM per-process at
   minimum for good performance, so this option is set to 1 by default since
   the maximum amount of RAM is unknown. You're advised to abide by this
   restriction, so pick a number of processes so that each has 4GB or more.
  </p><p>
   A similar option exists in order to scale backup agent processes,
   <code class="option">services.foundationdb.backupProcesses</code>. Backup agents are
   not as performance/RAM sensitive, so feel free to experiment with the number
   of available backup processes.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-foundationdb-clustering"></a>47.3. Clustering</h2></div></div></div><p>
   FoundationDB on NixOS works similarly to other Linux systems, so this
   section will be brief. Please refer to the full FoundationDB documentation
   for more on clustering.
  </p><p>
   FoundationDB organizes clusters using a set of
   <span class="emphasis"><em>coordinators</em></span>, which are just specially-designated
   worker processes. By default, every installation of FoundationDB on NixOS
   will start as its own individual cluster, with a single coordinator: the
   first worker process on <span class="command"><strong>localhost</strong></span>.
  </p><p>
   Coordinators are specified globally using the
   <span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> file, which all servers and
   client applications will use to find and join coordinators. Note that this
   file <span class="emphasis"><em>can not</em></span> be managed by NixOS so easily:
   FoundationDB is designed so that it will rewrite the file at runtime for all
   clients and nodes when cluster coordinators change, with clients
   transparently handling this without intervention. It is fundamentally a
   mutable file, and you should not try to manage it in any way in NixOS.
  </p><p>
   When dealing with a cluster, there are two main things you want to do:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Add a node to the cluster for storage/compute.
    </p></li><li class="listitem"><p>
     Promote an ordinary worker to a coordinator.
    </p></li></ul></div><p>
   A node must already be a member of the cluster in order to properly be
   promoted to a coordinator, so you must always add it first if you wish to
   promote it.
  </p><p>
   To add a machine to a FoundationDB cluster:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Choose one of the servers to start as the initial coordinator.
    </p></li><li class="listitem"><p>
     Copy the <span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> file from this
     server to all the other servers. Restart FoundationDB on all of these
     other servers, so they join the cluster.
    </p></li><li class="listitem"><p>
     All of these servers are now connected and working together in the
     cluster, under the chosen coordinator.
    </p></li></ul></div><p>
   At this point, you can add as many nodes as you want by just repeating the
   above steps. By default there will still be a single coordinator: you can
   use <span class="command"><strong>fdbcli</strong></span> to change this and add new coordinators.
  </p><p>
   As a convenience, FoundationDB can automatically assign coordinators based
   on the redundancy mode you wish to achieve for the cluster. Once all the
   nodes have been joined, simply set the replication policy, and then issue
   the <span class="command"><strong>coordinators auto</strong></span> command
  </p><p>
   For example, assuming we have 3 nodes available, we can enable double
   redundancy mode, then auto-select coordinators. For double redundancy, 3
   coordinators is ideal: therefore FoundationDB will make
   <span class="emphasis"><em>every</em></span> node a coordinator automatically:
  </p><pre class="screen">
<code class="prompt">fdbcli&gt; </code>configure double ssd
<code class="prompt">fdbcli&gt; </code>coordinators auto
</pre><p>
   This will transparently update all the servers within seconds, and
   appropriately rewrite the <span class="command"><strong>fdb.cluster</strong></span> file, as well as
   informing all client processes to do the same.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-foundationdb-connectivity"></a>47.4. Client connectivity</h2></div></div></div><p>
   By default, all clients must use the current <span class="command"><strong>fdb.cluster</strong></span>
   file to access a given FoundationDB cluster. This file is located by default
   in <span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> on all machines with the
   FoundationDB service enabled, so you may copy the active one from your
   cluster to a new node in order to connect, if it is not part of the cluster.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-foundationdb-authorization"></a>47.5. Client authorization and TLS</h2></div></div></div><p>
   By default, any user who can connect to a FoundationDB process with the
   correct cluster configuration can access anything. FoundationDB uses a
   pluggable design to transport security, and out of the box it supports a
   LibreSSL-based plugin for TLS support. This plugin not only does in-flight
   encryption, but also performs client authorization based on the given
   endpoint's certificate chain. For example, a FoundationDB server may be
   configured to only accept client connections over TLS, where the client TLS
   certificate is from organization <span class="emphasis"><em>Acme Co</em></span> in the
   <span class="emphasis"><em>Research and Development</em></span> unit.
  </p><p>
   Configuring TLS with FoundationDB is done using the
   <code class="option">services.foundationdb.tls</code> options in order to control the
   peer verification string, as well as the certificate and its private key.
  </p><p>
   Note that the certificate and its private key must be accessible to the
   FoundationDB user account that the server runs under. These files are also
   NOT managed by NixOS, as putting them into the store may reveal private
   information.
  </p><p>
   After you have a key and certificate file in place, it is not enough to
   simply set the NixOS module options -- you must also configure the
   <span class="command"><strong>fdb.cluster</strong></span> file to specify that a given set of
   coordinators use TLS. This is as simple as adding the suffix
   <span class="command"><strong>:tls</strong></span> to your cluster coordinator configuration, after the
   port number. For example, assuming you have a coordinator on localhost with
   the default configuration, simply specifying:
  </p><pre class="programlisting">
XXXXXX:XXXXXX@127.0.0.1:4500:tls
</pre><p>
   will configure all clients and server processes to use TLS from now on.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-foundationdb-disaster-recovery"></a>47.6. Backups and Disaster Recovery</h2></div></div></div><p>
   The usual rules for doing FoundationDB backups apply on NixOS as written in
   the FoundationDB manual. However, one important difference is the security
   profile for NixOS: by default, the <span class="command"><strong>foundationdb</strong></span> systemd
   unit uses <span class="emphasis"><em>Linux namespaces</em></span> to restrict write access to
   the system, except for the log directory, data directory, and the
   <span class="command"><strong>/etc/foundationdb/</strong></span> directory. This is enforced by default
   and cannot be disabled.
  </p><p>
   However, a side effect of this is that the <span class="command"><strong>fdbbackup</strong></span>
   command doesn't work properly for local filesystem backups: FoundationDB
   uses a server process alongside the database processes to perform backups
   and copy the backups to the filesystem. As a result, this process is put
   under the restricted namespaces above: the backup process can only write to
   a limited number of paths.
  </p><p>
   In order to allow flexible backup locations on local disks, the FoundationDB
   NixOS module supports a
   <code class="option">services.foundationdb.extraReadWritePaths</code> option. This
   option takes a list of paths, and adds them to the systemd unit, allowing
   the processes inside the service to write (and read) the specified
   directories.
  </p><p>
   For example, to create backups in <span class="command"><strong>/opt/fdb-backups</strong></span>, first
   set up the paths in the module options:
  </p><pre class="programlisting">
services.foundationdb.extraReadWritePaths = [ "/opt/fdb-backups" ];
</pre><p>
   Restart the FoundationDB service, and it will now be able to write to this
   directory (even if it does not yet exist.) Note: this path
   <span class="emphasis"><em>must</em></span> exist before restarting the unit. Otherwise,
   systemd will not include it in the private FoundationDB namespace (and it
   will not add it dynamically at runtime).
  </p><p>
   You can now perform a backup:
  </p><pre class="screen">
<code class="prompt">$ </code>sudo -u foundationdb fdbbackup start  -t default -d file:///opt/fdb-backups
<code class="prompt">$ </code>sudo -u foundationdb fdbbackup status -t default
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-foundationdb-limitations"></a>47.7. Known limitations</h2></div></div></div><p>
   The FoundationDB setup for NixOS should currently be considered beta.
   FoundationDB is not new software, but the NixOS compilation and integration
   has only undergone fairly basic testing of all the available functionality.
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     There is no way to specify individual parameters for individual
     <span class="command"><strong>fdbserver</strong></span> processes. Currently, all server processes
     inherit all the global <span class="command"><strong>fdbmonitor</strong></span> settings.
    </p></li><li class="listitem"><p>
     Ruby bindings are not currently installed.
    </p></li><li class="listitem"><p>
     Go bindings are not currently installed.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-foundationdb-options"></a>47.8. Options</h2></div></div></div><p>
   NixOS's FoundationDB module allows you to configure all of the most relevant
   configuration options for <span class="command"><strong>fdbmonitor</strong></span>, matching it quite
   closely. A complete list of options for the FoundationDB module may be found
   <a class="link" href="options.html#opt-services.foundationdb.enable">here</a>. You should
   also read the FoundationDB documentation as well.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-foundationdb-full-docs"></a>47.9. Full documentation</h2></div></div></div><p>
   FoundationDB is a complex piece of software, and requires careful
   administration to properly use. Full documentation for administration can be
   found here: <a class="link" href="https://apple.github.io/foundationdb/" target="_top">https://apple.github.io/foundationdb/</a>.
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-borgbase"></a>Chapter 48. BorgBackup</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-backup-borgbackup-configuring">48.1. Configuring</a></span></dt><dt><span class="section"><a href="index.html#opt-services-backup-borgbackup-local-directory">48.2. Basic usage for a local backup</a></span></dt><dt><span class="section"><a href="index.html#opt-services-backup-create-server">48.3. Create a borg backup server</a></span></dt><dt><span class="section"><a href="index.html#opt-services-backup-borgbackup-remote-server">48.4. Backup to the borg repository server</a></span></dt><dt><span class="section"><a href="index.html#opt-services-backup-borgbackup-borgbase">48.5. Backup to a hosting service</a></span></dt><dt><span class="section"><a href="index.html#opt-services-backup-borgbackup-vorta">48.6. Vorta backup client for the desktop</a></span></dt></dl></div><p>
  <span class="emphasis"><em>Source:</em></span>
  <code class="filename">modules/services/backup/borgbackup.nix</code>
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span>
  <a class="link" href="https://borgbackup.readthedocs.io/" target="_top">https://borgbackup.readthedocs.io/</a>
 </p><p>
  <a class="link" href="https://www.borgbackup.org/" target="_top">BorgBackup</a> (short: Borg)
  is a deduplicating backup program. Optionally, it supports compression and
  authenticated encryption.
  </p><p>
  The main goal of Borg is to provide an efficient and secure way to backup
  data. The data deduplication technique used makes Borg suitable for daily
  backups since only changes are stored. The authenticated encryption technique
  makes it suitable for backups to not fully trusted targets.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-backup-borgbackup-configuring"></a>48.1. Configuring</h2></div></div></div><p>
   A complete list of options for the Borgbase module may be found
   <a class="link" href="options.html#opt-services.borgbackup.jobs">here</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="opt-services-backup-borgbackup-local-directory"></a>48.2. Basic usage for a local backup</h2></div></div></div><p>
   A very basic configuration for backing up to a locally accessible directory
   is:
</p><pre class="programlisting">
{
    opt.services.borgbackup.jobs = {
      { rootBackup = {
          paths = "/";
          exclude = [ "/nix" "/path/to/local/repo" ];
          repo = "/path/to/local/repo";
          doInit = true;
          encryption = {
            mode = "repokey";
            passphrase = "secret";
          };
          compression = "auto,lzma";
          startAt = "weekly";
        };
      }
    };
}</pre><p>
  </p><div class="warning"><h3 class="title">Warning</h3><p>
        If you do not want the passphrase to be stored in the world-readable
        Nix store, use passCommand. You find an example below.
    </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="opt-services-backup-create-server"></a>48.3. Create a borg backup server</h2></div></div></div><p>You should use a different SSH key for each repository you write to,
    because the specified keys are restricted to running borg serve and can only
    access this single repository. You need the output of the generate pub file.
  </p><p>
</p><pre class="screen">
<code class="prompt"># </code>sudo ssh-keygen -N '' -t ed25519 -f /run/keys/id_ed25519_my_borg_repo
<code class="prompt"># </code>cat /run/keys/id_ed25519_my_borg_repo
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID78zmOyA+5uPG4Ot0hfAy+sLDPU1L4AiIoRYEIVbbQ/ root@nixos</pre><p>
    </p><p>
      Add the following snippet to your NixOS configuration:
      </p><pre class="programlisting">
{
  services.borgbackup.repos = {
    my_borg_repo = {
      authorizedKeys = [
        "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID78zmOyA+5uPG4Ot0hfAy+sLDPU1L4AiIoRYEIVbbQ/ root@nixos"
      ] ;
      path = "/var/lib/my_borg_repo" ;
    };
  };
}</pre><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="opt-services-backup-borgbackup-remote-server"></a>48.4. Backup to the borg repository server</h2></div></div></div><p>The following NixOS snippet creates an hourly backup to the service
    (on the host nixos) as created in the section above. We assume
    that you have stored a secret passphrasse in the file
    <code class="code">/run/keys/borgbackup_passphrase</code>, which should be only
    accessible by root
  </p><p>
      </p><pre class="programlisting">
{
  services.borgbackup.jobs = {
    backupToLocalServer = {
      paths = [ "/etc/nixos" ];
      doInit = true;
      repo =  "borg@nixos:." ;
      encryption = {
        mode = "repokey-blake2";
        passCommand = "cat /run/keys/borgbackup_passphrase";
      };
      environment = { BORG_RSH = "ssh -i /run/keys/id_ed25519_my_borg_repo"; };
      compression = "auto,lzma";
      startAt = "hourly";
    };
  };
};</pre><p>
  </p><p>The following few commands (run as root) let you test your backup.
      </p><pre class="programlisting">
&gt; nixos-rebuild switch
...restarting the following units: polkit.service
&gt; systemctl restart borgbackup-job-backupToLocalServer
&gt; sleep 10
&gt; systemctl restart borgbackup-job-backupToLocalServer
&gt; export BORG_PASSPHRASE=topSecrect
&gt; borg list --rsh='ssh -i /run/keys/id_ed25519_my_borg_repo' borg@nixos:.
nixos-backupToLocalServer-2020-03-30T21:46:17 Mon, 2020-03-30 21:46:19 [84feb97710954931ca384182f5f3cb90665f35cef214760abd7350fb064786ac]
nixos-backupToLocalServer-2020-03-30T21:46:30 Mon, 2020-03-30 21:46:32 [e77321694ecd160ca2228611747c6ad1be177d6e0d894538898de7a2621b6e68]</pre><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="opt-services-backup-borgbackup-borgbase"></a>48.5. Backup to a hosting service</h2></div></div></div><p>
    Several companies offer <a class="link" href="https://www.borgbackup.org/support/commercial.html" target="_top">(paid)
      hosting services</a> for Borg repositories.
  </p><p>
    To backup your home directory to borgbase you have to:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      Generate a SSH key without a password, to access the remote server. E.g.
    </p><p>
        </p><pre class="programlisting">sudo ssh-keygen -N '' -t ed25519 -f /run/keys/id_ed25519_borgbase</pre><p>
    </p></li><li class="listitem"><p>
      Create the repository on the server by following the instructions for your
      hosting server.
    </p></li><li class="listitem"><p>
      Initialize the repository on the server. Eg.
      </p><pre class="programlisting">
sudo borg init --encryption=repokey-blake2  \
    -rsh "ssh -i /run/keys/id_ed25519_borgbase" \
    zzz2aaaaa@zzz2aaaaa.repo.borgbase.com:repo</pre><p>
  </p></li><li class="listitem"><p>Add it to your NixOS configuration, e.g.
</p><pre class="programlisting">
{
    services.borgbackup.jobs = {
    my_Remote_Backup = {
        paths = [ "/" ];
        exclude = [ "/nix" "'**/.cache'" ];
        repo =  "zzz2aaaaa@zzz2aaaaa.repo.borgbase.com:repo";
          encryption = {
          mode = "repokey-blake2";
          passCommand = "cat /run/keys/borgbackup_passphrase";
        };
        BORG_RSH = "ssh -i /run/keys/id_ed25519_borgbase";
        compression = "auto,lzma";
        startAt = "daily";
    };
  };
}}</pre><p>
  </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="opt-services-backup-borgbackup-vorta"></a>48.6. Vorta backup client for the desktop</h2></div></div></div><p>
    Vorta is a backup client for macOS and Linux desktops. It integrates the
    mighty BorgBackup with your desktop environment to protect your data from
    disk failure, ransomware and theft.
  </p><p>
   It can be installed in NixOS e.g. by adding <span class="package">pkgs.vorta</span>
   to <a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>.
  </p><p>
    Details about using Vorta can be found under <a class="link" href="https://vorta.borgbase.com/usage" target="_top">https://vorta.borgbase.com
      </a>.
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-security-acme"></a>Chapter 49. SSL/TLS Certificates with ACME</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-security-acme-prerequisites">49.1. Prerequisites</a></span></dt><dt><span class="section"><a href="index.html#module-security-acme-nginx">49.2. Using ACME certificates in Nginx</a></span></dt><dt><span class="section"><a href="index.html#module-security-acme-httpd">49.3. Using ACME certificates in Apache/httpd</a></span></dt><dt><span class="section"><a href="index.html#module-security-acme-configuring">49.4. Manual configuration of HTTP-01 validation</a></span></dt><dt><span class="section"><a href="index.html#module-security-acme-config-dns">49.5. Configuring ACME for DNS validation</a></span></dt><dt><span class="section"><a href="index.html#module-security-acme-config-dns-with-vhosts">49.6. Using DNS validation with web server virtual hosts</a></span></dt><dt><span class="section"><a href="index.html#module-security-acme-root-owned">49.7. Using ACME with services demanding root owned certificates</a></span></dt><dt><span class="section"><a href="index.html#module-security-acme-regenerate">49.8. Regenerating certificates</a></span></dt><dt><span class="section"><a href="index.html#module-security-acme-fix-jws">49.9. Fixing JWS Verification error</a></span></dt></dl></div><p>
  NixOS supports automatic domain validation &amp; certificate retrieval and
  renewal using the ACME protocol. Any provider can be used, but by default
  NixOS uses Let's Encrypt. The alternative ACME client
  <a class="link" href="https://go-acme.github.io/lego/" target="_top">lego</a> is used under
  the hood.
 </p><p>
  Automatic cert validation and configuration for Apache and Nginx virtual
  hosts is included in NixOS, however if you would like to generate a wildcard
  cert or you are not using a web server you will have to configure DNS
  based validation.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-security-acme-prerequisites"></a>49.1. Prerequisites</h2></div></div></div><p>
   To use the ACME module, you must accept the provider's terms of service
   by setting <code class="literal"><a class="xref" href="options.html#opt-security.acme.acceptTerms"><code class="option">security.acme.acceptTerms</code></a></code>
   to <code class="literal">true</code>. The Let's Encrypt ToS can be found
   <a class="link" href="https://letsencrypt.org/repository/" target="_top">here</a>.
  </p><p>
   You must also set an email address to be used when creating accounts with
   Let's Encrypt. You can set this for all certs with
   <code class="literal"><a class="xref" href="options.html#opt-security.acme.defaults.email"><code class="option">security.acme.defaults.email</code></a></code>
   and/or on a per-cert basis with
   <code class="literal"><a class="xref" href="options.html#opt-security.acme.certs._name_.email"><code class="option">security.acme.certs.&lt;name&gt;.email</code></a></code>.
   This address is only used for registration and renewal reminders,
   and cannot be used to administer the certificates in any way.
  </p><p>
   Alternatively, you can use a different ACME server by changing the
   <code class="literal"><a class="xref" href="options.html#opt-security.acme.defaults.server"><code class="option">security.acme.defaults.server</code></a></code> option
   to a provider of your choosing, or just change the server for one cert with
   <code class="literal"><a class="xref" href="options.html#opt-security.acme.certs._name_.server"><code class="option">security.acme.certs.&lt;name&gt;.server</code></a></code>.
  </p><p>
   You will need an HTTP server or DNS server for verification. For HTTP,
   the server must have a webroot defined that can serve
   <code class="filename">.well-known/acme-challenge</code>. This directory must be
   writeable by the user that will run the ACME client. For DNS, you must
   set up credentials with your provider/server for use with lego.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-security-acme-nginx"></a>49.2. Using ACME certificates in Nginx</h2></div></div></div><p>
   NixOS supports fetching ACME certificates for you by setting
   <code class="literal"><a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.enableACME">enableACME</a>
   = true;</code> in a virtualHost config. We first create self-signed
   placeholder certificates in place of the real ACME certs. The placeholder
   certs are overwritten when the ACME certs arrive. For
   <code class="literal">foo.example.com</code> the config would look like this:
  </p><pre class="programlisting">
<a class="xref" href="options.html#opt-security.acme.acceptTerms"><code class="option">security.acme.acceptTerms</code></a> = true;
<a class="xref" href="options.html#opt-security.acme.defaults.email"><code class="option">security.acme.defaults.email</code></a> = "admin+acme@example.com";
services.nginx = {
  <a class="link" href="options.html#opt-services.nginx.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.nginx.virtualHosts">virtualHosts</a> = {
    "foo.example.com" = {
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.forceSSL">forceSSL</a> = true;
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.enableACME">enableACME</a> = true;
      # All serverAliases will be added as <a class="link" href="options.html#opt-security.acme.certs._name_.extraDomainNames">extra domain names</a> on the certificate.
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.serverAliases">serverAliases</a> = [ "bar.example.com" ];
      locations."/" = {
        <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.locations._name_.root">root</a> = "/var/www";
      };
    };

    # We can also add a different vhost and reuse the same certificate
    # but we have to append extraDomainNames manually.
    <a class="link" href="options.html#opt-security.acme.certs._name_.extraDomainNames">security.acme.certs."foo.example.com".extraDomainNames</a> = [ "baz.example.com" ];
    "baz.example.com" = {
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.forceSSL">forceSSL</a> = true;
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.useACMEHost">useACMEHost</a> = "foo.example.com";
      locations."/" = {
        <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.locations._name_.root">root</a> = "/var/www";
      };
    };
  };
}
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-security-acme-httpd"></a>49.3. Using ACME certificates in Apache/httpd</h2></div></div></div><p>
   Using ACME certificates with Apache virtual hosts is identical
   to using them with Nginx. The attribute names are all the same, just replace
   "nginx" with "httpd" where appropriate.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-security-acme-configuring"></a>49.4. Manual configuration of HTTP-01 validation</h2></div></div></div><p>
   First off you will need to set up a virtual host to serve the challenges.
   This example uses a vhost called <code class="literal">certs.example.com</code>, with
   the intent that you will generate certs for all your vhosts and redirect
   everyone to HTTPS.
  </p><pre class="programlisting">
<a class="xref" href="options.html#opt-security.acme.acceptTerms"><code class="option">security.acme.acceptTerms</code></a> = true;
<a class="xref" href="options.html#opt-security.acme.defaults.email"><code class="option">security.acme.defaults.email</code></a> = "admin+acme@example.com";

# /var/lib/acme/.challenges must be writable by the ACME user
# and readable by the Nginx user. The easiest way to achieve
# this is to add the Nginx user to the ACME group.
<a class="link" href="options.html#opt-users.users._name_.extraGroups">users.users.nginx.extraGroups</a> = [ "acme" ];

services.nginx = {
  <a class="link" href="options.html#opt-services.nginx.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.nginx.virtualHosts">virtualHosts</a> = {
    "acmechallenge.example.com" = {
      # Catchall vhost, will redirect users to HTTPS for all vhosts
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.serverAliases">serverAliases</a> = [ "*.example.com" ];
      locations."/.well-known/acme-challenge" = {
        <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.locations._name_.root">root</a> = "/var/lib/acme/.challenges";
      };
      locations."/" = {
        <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.locations._name_.return">return</a> = "301 https://$host$request_uri";
      };
    };
  };
}
# Alternative config for Apache
<a class="link" href="options.html#opt-users.users._name_.extraGroups">users.users.wwwrun.extraGroups</a> = [ "acme" ];
services.httpd = {
  <a class="link" href="options.html#opt-services.httpd.enable">enable = true;</a>
  <a class="link" href="options.html#opt-services.httpd.virtualHosts">virtualHosts</a> = {
    "acmechallenge.example.com" = {
      # Catchall vhost, will redirect users to HTTPS for all vhosts
      <a class="link" href="options.html#opt-services.httpd.virtualHosts._name_.serverAliases">serverAliases</a> = [ "*.example.com" ];
      # /var/lib/acme/.challenges must be writable by the ACME user and readable by the Apache user.
      # By default, this is the case.
      <a class="link" href="options.html#opt-services.httpd.virtualHosts._name_.documentRoot">documentRoot</a> = "/var/lib/acme/.challenges";
      <a class="link" href="options.html#opt-services.httpd.virtualHosts._name_.extraConfig">extraConfig</a> = ''
        RewriteEngine On
        RewriteCond %{HTTPS} off
        RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge [NC]
        RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R=301]
      '';
    };
  };
}
</pre><p>
   Now you need to configure ACME to generate a certificate.
  </p><pre class="programlisting">
<a class="xref" href="options.html#opt-security.acme.certs"><code class="option">security.acme.certs</code></a>."foo.example.com" = {
  <a class="link" href="options.html#opt-security.acme.certs._name_.webroot">webroot</a> = "/var/lib/acme/.challenges";
  <a class="link" href="options.html#opt-security.acme.certs._name_.email">email</a> = "foo@example.com";
  # Ensure that the web server you use can read the generated certs
  # Take a look at the <a class="link" href="options.html#opt-services.nginx.group">group</a> option for the web server you choose.
  <a class="link" href="options.html#opt-security.acme.certs._name_.group">group</a> = "nginx";
  # Since we have a wildcard vhost to handle port 80,
  # we can generate certs for anything!
  # Just make sure your DNS resolves them.
  <a class="link" href="options.html#opt-security.acme.certs._name_.extraDomainNames">extraDomainNames</a> = [ "mail.example.com" ];
};
</pre><p>
   The private key <code class="filename">key.pem</code> and certificate
   <code class="filename">fullchain.pem</code> will be put into
   <code class="filename">/var/lib/acme/foo.example.com</code>.
  </p><p>
   Refer to <a class="xref" href="options.html" title="Appendix A. Configuration Options">Appendix A, <em>Configuration Options</em></a> for all available configuration
   options for the <a class="link" href="options.html#opt-security.acme.certs">security.acme</a>
   module.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-security-acme-config-dns"></a>49.5. Configuring ACME for DNS validation</h2></div></div></div><p>
   This is useful if you want to generate a wildcard certificate, since
   ACME servers will only hand out wildcard certs over DNS validation.
   There are a number of supported DNS providers and servers you can utilise,
   see the <a class="link" href="https://go-acme.github.io/lego/dns/" target="_top">lego docs</a>
   for provider/server specific configuration values. For the sake of these
   docs, we will provide a fully self-hosted example using bind.
  </p><pre class="programlisting">
services.bind = {
  <a class="link" href="options.html#opt-services.bind.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.bind.extraConfig">extraConfig</a> = ''
    include "/var/lib/secrets/dnskeys.conf";
  '';
  <a class="link" href="options.html#opt-services.bind.zones">zones</a> = [
    rec {
      name = "example.com";
      file = "/var/db/bind/${name}";
      master = true;
      extraConfig = "allow-update { key rfc2136key.example.com.; };";
    }
  ];
}

# Now we can configure ACME
<a class="xref" href="options.html#opt-security.acme.acceptTerms"><code class="option">security.acme.acceptTerms</code></a> = true;
<a class="xref" href="options.html#opt-security.acme.defaults.email"><code class="option">security.acme.defaults.email</code></a> = "admin+acme@example.com";
<a class="xref" href="options.html#opt-security.acme.certs"><code class="option">security.acme.certs</code></a>."example.com" = {
  <a class="link" href="options.html#opt-security.acme.certs._name_.domain">domain</a> = "*.example.com";
  <a class="link" href="options.html#opt-security.acme.certs._name_.dnsProvider">dnsProvider</a> = "rfc2136";
  <a class="link" href="options.html#opt-security.acme.certs._name_.credentialsFile">credentialsFile</a> = "/var/lib/secrets/certs.secret";
  # We don't need to wait for propagation since this is a local DNS server
  <a class="link" href="options.html#opt-security.acme.certs._name_.dnsPropagationCheck">dnsPropagationCheck</a> = false;
};
</pre><p>
   The <code class="filename">dnskeys.conf</code> and <code class="filename">certs.secret</code>
   must be kept secure and thus you should not keep their contents in your
   Nix config. Instead, generate them one time with a systemd service:
  </p><pre class="programlisting">
systemd.services.dns-rfc2136-conf = {
  requiredBy = ["acme-example.com.service", "bind.service"];
  before = ["acme-example.com.service", "bind.service"];
  unitConfig = {
    ConditionPathExists = "!/var/lib/secrets/dnskeys.conf";
  };
  serviceConfig = {
    Type = "oneshot";
    UMask = 0077;
  };
  path = [ pkgs.bind ];
  script = ''
    mkdir -p /var/lib/secrets
    tsig-keygen rfc2136key.example.com &gt; /var/lib/secrets/dnskeys.conf
    chown named:root /var/lib/secrets/dnskeys.conf
    chmod 400 /var/lib/secrets/dnskeys.conf

    # Copy the secret value from the dnskeys.conf, and put it in
    # RFC2136_TSIG_SECRET below

    cat &gt; /var/lib/secrets/certs.secret &lt;&lt; EOF
    RFC2136_NAMESERVER='127.0.0.1:53'
    RFC2136_TSIG_ALGORITHM='hmac-sha256.'
    RFC2136_TSIG_KEY='rfc2136key.example.com'
    RFC2136_TSIG_SECRET='your secret key'
    EOF
    chmod 400 /var/lib/secrets/certs.secret
  '';
};
</pre><p>
   Now you're all set to generate certs! You should monitor the first invocation
   by running <code class="literal">systemctl start acme-example.com.service &amp;
   journalctl -fu acme-example.com.service</code> and watching its log output.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-security-acme-config-dns-with-vhosts"></a>49.6. Using DNS validation with web server virtual hosts</h2></div></div></div><p>
   It is possible to use DNS-01 validation with all certificates,
   including those automatically configured via the Nginx/Apache
   <code class="literal"><a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.enableACME">enableACME</a></code>
   option. This configuration pattern is fully
   supported and part of the module's test suite for Nginx + Apache.
  </p><p>
   You must follow the guide above on configuring DNS-01 validation
   first, however instead of setting the options for one certificate
   (e.g. <a class="xref" href="options.html#opt-security.acme.certs._name_.dnsProvider"><code class="option">security.acme.certs.&lt;name&gt;.dnsProvider</code></a>)
   you will set them as defaults
   (e.g. <a class="xref" href="options.html#opt-security.acme.defaults.dnsProvider"><code class="option">security.acme.defaults.dnsProvider</code></a>).
  </p><pre class="programlisting">
# Configure ACME appropriately
<a class="xref" href="options.html#opt-security.acme.acceptTerms"><code class="option">security.acme.acceptTerms</code></a> = true;
<a class="xref" href="options.html#opt-security.acme.defaults.email"><code class="option">security.acme.defaults.email</code></a> = "admin+acme@example.com";
<a class="xref" href="options.html#opt-security.acme.defaults"><code class="option">security.acme.defaults</code></a> = {
  <a class="link" href="options.html#opt-security.acme.defaults.dnsProvider">dnsProvider</a> = "rfc2136";
  <a class="link" href="options.html#opt-security.acme.defaults.credentialsFile">credentialsFile</a> = "/var/lib/secrets/certs.secret";
  # We don't need to wait for propagation since this is a local DNS server
  <a class="link" href="options.html#opt-security.acme.defaults.dnsPropagationCheck">dnsPropagationCheck</a> = false;
};

# For each virtual host you would like to use DNS-01 validation with,
# set acmeRoot = null
services.nginx = {
  <a class="link" href="options.html#opt-services.nginx.enable">enable</a> = true;
  <a class="link" href="options.html#opt-services.nginx.virtualHosts">virtualHosts</a> = {
    "foo.example.com" = {
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.enableACME">enableACME</a> = true;
      <a class="link" href="options.html#opt-services.nginx.virtualHosts._name_.acmeRoot">acmeRoot</a> = null;
    };
  };
}
</pre><p>
   And that's it! Next time your configuration is rebuilt, or when
   you add a new virtualHost, it will be DNS-01 validated.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-security-acme-root-owned"></a>49.7. Using ACME with services demanding root owned certificates</h2></div></div></div><p>
   Some services refuse to start if the configured certificate files
   are not owned by root. PostgreSQL and OpenSMTPD are examples of these.
   There is no way to change the user the ACME module uses (it will always be
   <code class="literal">acme</code>), however you can use systemd's
   <code class="literal">LoadCredential</code> feature to resolve this elegantly.
   Below is an example configuration for OpenSMTPD, but this pattern
   can be applied to any service.
  </p><pre class="programlisting">
# Configure ACME however you like (DNS or HTTP validation), adding
# the following configuration for the relevant certificate.
# Note: You cannot use `systemctl reload` here as that would mean
# the LoadCredential configuration below would be skipped and
# the service would continue to use old certificates.
security.acme.certs."mail.example.com".postRun = ''
  systemctl restart opensmtpd
'';

# Now you must augment OpenSMTPD's systemd service to load
# the certificate files.
<a class="link" href="options.html#opt-systemd.services._name_.requires">systemd.services.opensmtpd.requires</a> = ["acme-finished-mail.example.com.target"];
<a class="link" href="options.html#opt-systemd.services._name_.serviceConfig">systemd.services.opensmtpd.serviceConfig.LoadCredential</a> = let
  certDir = config.security.acme.certs."mail.example.com".directory;
in [
  "cert.pem:${certDir}/cert.pem"
  "key.pem:${certDir}/key.pem"
];

# Finally, configure OpenSMTPD to use these certs.
services.opensmtpd = let
  credsDir = "/run/credentials/opensmtpd.service";
in {
  enable = true;
  setSendmail = false;
  serverConfiguration = ''
    pki mail.example.com cert "${credsDir}/cert.pem"
    pki mail.example.com key "${credsDir}/key.pem"
    listen on localhost tls pki mail.example.com
    action act1 relay host smtp://127.0.0.1:10027
    match for local action act1
  '';
};
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-security-acme-regenerate"></a>49.8. Regenerating certificates</h2></div></div></div><p>
   Should you need to regenerate a particular certificate in a hurry, such
   as when a vulnerability is found in Let's Encrypt, there is now a convenient
   mechanism for doing so. Running
   <code class="literal">systemctl clean --what=state acme-example.com.service</code>
   will remove all certificate files and the account data for the given domain,
   allowing you to then <code class="literal">systemctl start acme-example.com.service</code>
   to generate fresh ones.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-security-acme-fix-jws"></a>49.9. Fixing JWS Verification error</h2></div></div></div><p>
   It is possible that your account credentials file may become corrupt and need
   to be regenerated. In this scenario lego will produce the error <code class="literal">JWS verification error</code>.
   The solution is to simply delete the associated accounts file and
   re-run the affected service(s).
  </p><pre class="programlisting">
# Find the accounts folder for the certificate
systemctl cat acme-example.com.service | grep -Po 'accounts/[^:]*'
export accountdir="$(!!)"
# Move this folder to some place else
mv /var/lib/acme/.lego/$accountdir{,.bak}
# Recreate the folder using systemd-tmpfiles
systemd-tmpfiles --create
# Get a new account and reissue certificates
# Note: Do this for all certs that share the same account email address
systemctl start acme-example.com.service
</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-programs-zsh-ohmyzsh"></a>Chapter 50. Oh my ZSH</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-programs-oh-my-zsh-usage">50.1. Basic usage</a></span></dt><dt><span class="section"><a href="index.html#module-programs-oh-my-zsh-additions">50.2. Custom additions</a></span></dt><dt><span class="section"><a href="index.html#module-programs-oh-my-zsh-environments">50.3. Custom environments</a></span></dt><dt><span class="section"><a href="index.html#module-programs-oh-my-zsh-packaging-customizations">50.4. Package your own customizations</a></span></dt></dl></div><p>
  <code class="literal"><a class="link" href="https://ohmyz.sh/" target="_top">oh-my-zsh</a></code> is a
  framework to manage your <a class="link" href="https://www.zsh.org/" target="_top">ZSH</a>
  configuration including completion scripts for several CLI tools or custom
  prompt themes.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-programs-oh-my-zsh-usage"></a>50.1. Basic usage</h2></div></div></div><p>
   The module uses the <code class="literal">oh-my-zsh</code> package with all available
   features. The initial setup using Nix expressions is fairly similar to the
   configuration format of <code class="literal">oh-my-zsh</code>.
</p><pre class="programlisting">
{
  programs.zsh.ohMyZsh = {
    enable = true;
    plugins = [ "git" "python" "man" ];
    theme = "agnoster";
  };
}
</pre><p>
   For a detailed explanation of these arguments please refer to the
   <a class="link" href="https://github.com/robbyrussell/oh-my-zsh/wiki" target="_top"><code class="literal">oh-my-zsh</code>
   docs</a>.
  </p><p>
   The expression generates the needed configuration and writes it into your
   <code class="literal">/etc/zshrc</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-programs-oh-my-zsh-additions"></a>50.2. Custom additions</h2></div></div></div><p>
   Sometimes third-party or custom scripts such as a modified theme may be
   needed. <code class="literal">oh-my-zsh</code> provides the
   <a class="link" href="https://github.com/robbyrussell/oh-my-zsh/wiki/Customization#overriding-internals" target="_top"><code class="literal">ZSH_CUSTOM</code></a>
   environment variable for this which points to a directory with additional
   scripts.
  </p><p>
   The module can do this as well:
</p><pre class="programlisting">
{
  programs.zsh.ohMyZsh.custom = "~/path/to/custom/scripts";
}
</pre><p>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-programs-oh-my-zsh-environments"></a>50.3. Custom environments</h2></div></div></div><p>
   There are several extensions for <code class="literal">oh-my-zsh</code> packaged in
   <code class="literal">nixpkgs</code>. One of them is
   <a class="link" href="https://github.com/spwhitt/nix-zsh-completions" target="_top">nix-zsh-completions</a>
   which bundles completion scripts and a plugin for
   <code class="literal">oh-my-zsh</code>.
  </p><p>
   Rather than using a single mutable path for <code class="literal">ZSH_CUSTOM</code>,
   it's also possible to generate this path from a list of Nix packages:
</p><pre class="programlisting">
{ pkgs, ... }:
{
  programs.zsh.ohMyZsh.customPkgs = [
    pkgs.nix-zsh-completions
    # and even more...
  ];
}
</pre><p>
   Internally a single store path will be created using
   <code class="literal">buildEnv</code>. Please refer to the docs of
   <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-building-environment" target="_top"><code class="literal">buildEnv</code></a>
   for further reference.
  </p><p>
   <span class="emphasis"><em>Please keep in mind that this is not compatible with
   <code class="literal">programs.zsh.ohMyZsh.custom</code> as it requires an immutable
   store path while <code class="literal">custom</code> shall remain mutable! An
   evaluation failure will be thrown if both <code class="literal">custom</code> and
   <code class="literal">customPkgs</code> are set.</em></span>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-programs-oh-my-zsh-packaging-customizations"></a>50.4. Package your own customizations</h2></div></div></div><p>
   If third-party customizations (e.g. new themes) are supposed to be added to
   <code class="literal">oh-my-zsh</code> there are several pitfalls to keep in mind:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     To comply with the default structure of <code class="literal">ZSH</code> the entire
     output needs to be written to <code class="literal">$out/share/zsh.</code>
    </p></li><li class="listitem"><p>
     Completion scripts are supposed to be stored at
     <code class="literal">$out/share/zsh/site-functions</code>. This directory is part
     of the
     <code class="literal"><a class="link" href="http://zsh.sourceforge.net/Doc/Release/Functions.html" target="_top">fpath</a></code>
     and the package should be compatible with pure <code class="literal">ZSH</code>
     setups. The module will automatically link the contents of
     <code class="literal">site-functions</code> to completions directory in the proper
     store path.
    </p></li><li class="listitem"><p>
     The <code class="literal">plugins</code> directory needs the structure
     <code class="literal">pluginname/pluginname.plugin.zsh</code> as structured in the
     <a class="link" href="https://github.com/robbyrussell/oh-my-zsh/tree/91b771914bc7c43dd7c7a43b586c5de2c225ceb7/plugins" target="_top">upstream
     repo.</a>
    </p></li></ul></div><p>
   A derivation for <code class="literal">oh-my-zsh</code> may look like this:
</p><pre class="programlisting">
{ stdenv, fetchFromGitHub }:

stdenv.mkDerivation rec {
  name = "exemplary-zsh-customization-${version}";
  version = "1.0.0";
  src = fetchFromGitHub {
    # path to the upstream repository
  };

  dontBuild = true;
  installPhase = ''
    mkdir -p $out/share/zsh/site-functions
    cp {themes,plugins} $out/share/zsh
    cp completions $out/share/zsh/site-functions
  '';
}
</pre><p>
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-program-plotinus"></a>Chapter 51. Plotinus</h2></div></div></div><p>
  <span class="emphasis"><em>Source:</em></span>
  <code class="filename">modules/programs/plotinus.nix</code>
 </p><p>
  <span class="emphasis"><em>Upstream documentation:</em></span>
  <a class="link" href="https://github.com/p-e-w/plotinus" target="_top">https://github.com/p-e-w/plotinus</a>
 </p><p>
  Plotinus is a searchable command palette in every modern GTK application.
 </p><p>
  When in a GTK 3 application and Plotinus is enabled, you can press
  <code class="literal">Ctrl+Shift+P</code> to open the command palette. The command
  palette provides a searchable list of of all menu items in the application.
 </p><p>
  To enable Plotinus, add the following to your
  <code class="filename">configuration.nix</code>:
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-programs.plotinus.enable"><code class="option">programs.plotinus.enable</code></a> = true;
</pre><p>
 </p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-programs-digitalbitbox"></a>Chapter 52. Digital Bitbox</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-digitalbitbox-package">52.1. Package</a></span></dt><dt><span class="section"><a href="index.html#sec-digitalbitbox-hardware-module">52.2. Hardware</a></span></dt></dl></div><p>
  Digital Bitbox is a hardware wallet and second-factor authenticator.
 </p><p>
  The <code class="literal">digitalbitbox</code> programs module may be installed by
  setting <code class="literal">programs.digitalbitbox</code> to <code class="literal">true</code>
  in a manner similar to
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-programs.digitalbitbox.enable"><code class="option">programs.digitalbitbox.enable</code></a> = true;
</pre><p>
  and bundles the <code class="literal">digitalbitbox</code> package (see
  <a class="xref" href="index.html#sec-digitalbitbox-package" title="52.1. Package">Section 52.1, “Package”</a>), which contains the
  <code class="literal">dbb-app</code> and <code class="literal">dbb-cli</code> binaries, along
  with the hardware module (see
  <a class="xref" href="index.html#sec-digitalbitbox-hardware-module" title="52.2. Hardware">Section 52.2, “Hardware”</a>) which sets up the
  necessary udev rules to access the device.
 </p><p>
  Enabling the digitalbitbox module is pretty much the easiest way to get a
  Digital Bitbox device working on your system.
 </p><p>
  For more information, see
  <a class="link" href="https://digitalbitbox.com/start_linux" target="_top">https://digitalbitbox.com/start_linux</a>.
 </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-digitalbitbox-package"></a>52.1. Package</h2></div></div></div><p>
   The binaries, <code class="literal">dbb-app</code> (a GUI tool) and
   <code class="literal">dbb-cli</code> (a CLI tool), are available through the
   <code class="literal">digitalbitbox</code> package which could be installed as
   follows:
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> = [
  pkgs.digitalbitbox
];
</pre><p>
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-digitalbitbox-hardware-module"></a>52.2. Hardware</h2></div></div></div><p>
   The digitalbitbox hardware package enables the udev rules for Digital Bitbox
   devices and may be installed as follows:
</p><pre class="programlisting">
<a class="xref" href="options.html#opt-hardware.digitalbitbox.enable"><code class="option">hardware.digitalbitbox.enable</code></a> = true;
</pre><p>
  </p><p>
   In order to alter the udev rules, one may provide different values for the
   <code class="literal">udevRule51</code> and <code class="literal">udevRule52</code> attributes
   by means of overriding as follows:
</p><pre class="programlisting">
programs.digitalbitbox = {
  <a class="link" href="options.html#opt-programs.digitalbitbox.enable">enable</a> = true;
  <a class="link" href="options.html#opt-programs.digitalbitbox.package">package</a> = pkgs.digitalbitbox.override {
    udevRule51 = "something else";
  };
};
</pre><p>
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="module-services-input-methods"></a>Chapter 53. Input Methods</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#module-services-input-methods-ibus">53.1. IBus</a></span></dt><dt><span class="section"><a href="index.html#module-services-input-methods-fcitx">53.2. Fcitx</a></span></dt><dt><span class="section"><a href="index.html#module-services-input-methods-nabi">53.3. Nabi</a></span></dt><dt><span class="section"><a href="index.html#module-services-input-methods-uim">53.4. Uim</a></span></dt><dt><span class="section"><a href="index.html#module-services-input-methods-hime">53.5. Hime</a></span></dt><dt><span class="section"><a href="index.html#module-services-input-methods-kime">53.6. Kime</a></span></dt></dl></div><p>
  Input methods are an operating system component that allows any data, such as
  keyboard strokes or mouse movements, to be received as input. In this way
  users can enter characters and symbols not found on their input devices.
  Using an input method is obligatory for any language that has more graphemes
  than there are keys on the keyboard.
 </p><p>
  The following input methods are available in NixOS:
 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
    IBus: The intelligent input bus.
   </p></li><li class="listitem"><p>
    Fcitx: A customizable lightweight input method.
   </p></li><li class="listitem"><p>
    Nabi: A Korean input method based on XIM.
   </p></li><li class="listitem"><p>
    Uim: The universal input method, is a library with a XIM bridge.
   </p></li><li class="listitem"><p>
    Hime: An extremely easy-to-use input method framework.
   </p></li><li class="listitem"><p>
     Kime: Korean IME
    </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-input-methods-ibus"></a>53.1. IBus</h2></div></div></div><p>
   IBus is an Intelligent Input Bus. It provides full featured and user
   friendly input method user interface.
  </p><p>
   The following snippet can be used to configure IBus:
  </p><pre class="programlisting">
i18n.inputMethod = {
  <a class="link" href="options.html#opt-i18n.inputMethod.enabled">enabled</a> = "ibus";
  <a class="link" href="options.html#opt-i18n.inputMethod.ibus.engines">ibus.engines</a> = with pkgs.ibus-engines; [ anthy hangul mozc ];
};
</pre><p>
   <code class="literal">i18n.inputMethod.ibus.engines</code> is optional and can be used
   to add extra IBus engines.
  </p><p>
   Available extra IBus engines are:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Anthy (<code class="literal">ibus-engines.anthy</code>): Anthy is a system for
     Japanese input method. It converts Hiragana text to Kana Kanji mixed text.
    </p></li><li class="listitem"><p>
     Hangul (<code class="literal">ibus-engines.hangul</code>): Korean input method.
    </p></li><li class="listitem"><p>
     m17n (<code class="literal">ibus-engines.m17n</code>): m17n is an input method that
     uses input methods and corresponding icons in the m17n database.
    </p></li><li class="listitem"><p>
     mozc (<code class="literal">ibus-engines.mozc</code>): A Japanese input method from
     Google.
    </p></li><li class="listitem"><p>
     Table (<code class="literal">ibus-engines.table</code>): An input method that load
     tables of input methods.
    </p></li><li class="listitem"><p>
     table-others (<code class="literal">ibus-engines.table-others</code>): Various
     table-based input methods. To use this, and any other table-based input
     methods, it must appear in the list of engines along with
     <code class="literal">table</code>. For example:
</p><pre class="programlisting">
ibus.engines = with pkgs.ibus-engines; [ table table-others ];
</pre><p>
    </p></li></ul></div><p>
   To use any input method, the package must be added in the configuration, as
   shown above, and also (after running <code class="literal">nixos-rebuild</code>) the
   input method must be added from IBus' preference dialog.
  </p><div class="simplesect"><div class="titlepage"><div><div><h3 class="title"><a id="module-services-input-methods-troubleshooting"></a>Troubleshooting</h3></div></div></div><p>
    If IBus works in some applications but not others, a likely cause of this
    is that IBus is depending on a different version of <code class="literal">glib</code>
    to what the applications are depending on. This can be checked by running
    <code class="literal">nix-store -q --requisites &lt;path&gt; | grep glib</code>,
    where <code class="literal">&lt;path&gt;</code> is the path of either IBus or an
    application in the Nix store. The <code class="literal">glib</code> packages must
    match exactly. If they do not, uninstalling and reinstalling the
    application is a likely fix.
   </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-input-methods-fcitx"></a>53.2. Fcitx</h2></div></div></div><p>
   Fcitx is an input method framework with extension support. It has three
   built-in Input Method Engine, Pinyin, QuWei and Table-based input methods.
  </p><p>
   The following snippet can be used to configure Fcitx:
  </p><pre class="programlisting">
i18n.inputMethod = {
  <a class="link" href="options.html#opt-i18n.inputMethod.enabled">enabled</a> = "fcitx";
  <a class="link" href="options.html#opt-i18n.inputMethod.fcitx.engines">fcitx.engines</a> = with pkgs.fcitx-engines; [ mozc hangul m17n ];
};
</pre><p>
   <code class="literal">i18n.inputMethod.fcitx.engines</code> is optional and can be
   used to add extra Fcitx engines.
  </p><p>
   Available extra Fcitx engines are:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
     Anthy (<code class="literal">fcitx-engines.anthy</code>): Anthy is a system for
     Japanese input method. It converts Hiragana text to Kana Kanji mixed text.
    </p></li><li class="listitem"><p>
     Chewing (<code class="literal">fcitx-engines.chewing</code>): Chewing is an
     intelligent Zhuyin input method. It is one of the most popular input
     methods among Traditional Chinese Unix users.
    </p></li><li class="listitem"><p>
     Hangul (<code class="literal">fcitx-engines.hangul</code>): Korean input method.
    </p></li><li class="listitem"><p>
     Unikey (<code class="literal">fcitx-engines.unikey</code>): Vietnamese input method.
    </p></li><li class="listitem"><p>
     m17n (<code class="literal">fcitx-engines.m17n</code>): m17n is an input method that
     uses input methods and corresponding icons in the m17n database.
    </p></li><li class="listitem"><p>
     mozc (<code class="literal">fcitx-engines.mozc</code>): A Japanese input method from
     Google.
    </p></li><li class="listitem"><p>
     table-others (<code class="literal">fcitx-engines.table-others</code>): Various
     table-based input methods.
    </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-input-methods-nabi"></a>53.3. Nabi</h2></div></div></div><p>
   Nabi is an easy to use Korean X input method. It allows you to enter
   phonetic Korean characters (hangul) and pictographic Korean characters
   (hanja).
  </p><p>
   The following snippet can be used to configure Nabi:
  </p><pre class="programlisting">
i18n.inputMethod = {
  <a class="link" href="options.html#opt-i18n.inputMethod.enabled">enabled</a> = "nabi";
};
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-input-methods-uim"></a>53.4. Uim</h2></div></div></div><p>
   Uim (short for "universal input method") is a multilingual input method
   framework. Applications can use it through so-called bridges.
  </p><p>
   The following snippet can be used to configure uim:
  </p><pre class="programlisting">
i18n.inputMethod = {
  <a class="link" href="options.html#opt-i18n.inputMethod.enabled">enabled</a> = "uim";
};
</pre><p>
   Note: The <a class="xref" href="options.html#opt-i18n.inputMethod.uim.toolbar"><code class="option">i18n.inputMethod.uim.toolbar</code></a> option can be
   used to choose uim toolbar.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-input-methods-hime"></a>53.5. Hime</h2></div></div></div><p>
   Hime is an extremely easy-to-use input method framework. It is lightweight,
   stable, powerful and supports many commonly used input methods, including
   Cangjie, Zhuyin, Dayi, Rank, Shrimp, Greek, Korean Pinyin, Latin Alphabet,
   etc...
  </p><p>
   The following snippet can be used to configure Hime:
  </p><pre class="programlisting">
i18n.inputMethod = {
  <a class="link" href="options.html#opt-i18n.inputMethod.enabled">enabled</a> = "hime";
};
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="module-services-input-methods-kime"></a>53.6. Kime</h2></div></div></div><p>
   Kime is Korean IME. it's built with Rust language and let you get simple, safe, fast Korean typing
  </p><p>
   The following snippet can be used to configure Kime:
  </p><pre class="programlisting">
i18n.inputMethod = {
  <a class="link" href="options.html#opt-i18n.inputMethod.enabled">enabled</a> = "kime";
};
</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="ch-profiles"></a>Chapter 54. Profiles</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-profile-all-hardware">54.1. All Hardware</a></span></dt><dt><span class="section"><a href="index.html#sec-profile-base">54.2. Base</a></span></dt><dt><span class="section"><a href="index.html#sec-profile-clone-config">54.3. Clone Config</a></span></dt><dt><span class="section"><a href="index.html#sec-profile-demo">54.4. Demo</a></span></dt><dt><span class="section"><a href="index.html#sec-profile-docker-container">54.5. Docker Container</a></span></dt><dt><span class="section"><a href="index.html#sec-profile-graphical">54.6. Graphical</a></span></dt><dt><span class="section"><a href="index.html#sec-profile-hardened">54.7. Hardened</a></span></dt><dt><span class="section"><a href="index.html#sec-profile-headless">54.8. Headless</a></span></dt><dt><span class="section"><a href="index.html#sec-profile-installation-device">54.9. Installation Device</a></span></dt><dt><span class="section"><a href="index.html#sec-profile-minimal">54.10. Minimal</a></span></dt><dt><span class="section"><a href="index.html#sec-profile-qemu-guest">54.11. QEMU Guest</a></span></dt></dl></div><p>
    In some cases, it may be desirable to take advantage of
    commonly-used, predefined configurations provided by nixpkgs, but
    different from those that come as default. This is a role fulfilled
    by NixOS's Profiles, which come as files living in
    <code class="literal">&lt;nixpkgs/nixos/modules/profiles&gt;</code>. That is
    to say, expected usage is to add them to the imports list of your
    <code class="literal">/etc/configuration.nix</code> as such:
  </p><pre class="programlisting">
imports = [
  &lt;nixpkgs/nixos/modules/profiles/profile-name.nix&gt;
];
</pre><p>
    Even if some of these profiles seem only useful in the context of
    install media, many are actually intended to be used in real
    installs.
  </p><p>
    What follows is a brief explanation on the purpose and use-case for
    each profile. Detailing each option configured by each one is out of
    scope.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-profile-all-hardware"></a>54.1. All Hardware</h2></div></div></div><p>
    Enables all hardware supported by NixOS: i.e., all firmware is
    included, and all devices from which one may boot are enabled in the
    initrd. Its primary use is in the NixOS installation CDs.
  </p><p>
    The enabled kernel modules include support for SATA and PATA, SCSI
    (partially), USB, Firewire (untested), Virtio (QEMU, KVM, etc.),
    VMware, and Hyper-V. Additionally,
    <a class="xref" href="options.html#opt-hardware.enableAllFirmware"><code class="option">hardware.enableAllFirmware</code></a> is enabled, and
    the firmware for the ZyDAS ZD1211 chipset is specifically installed.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-profile-base"></a>54.2. Base</h2></div></div></div><p>
    Defines the software packages included in the <span class="quote">“<span class="quote">minimal</span>”</span>
    installation CD. It installs several utilities useful in a simple
    recovery or install media, such as a text-mode web browser, and
    tools for manipulating block devices, networking, hardware
    diagnostics, and filesystems (with their respective kernel modules).
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-profile-clone-config"></a>54.3. Clone Config</h2></div></div></div><p>
    This profile is used in installer images. It provides an editable
    configuration.nix that imports all the modules that were also used
    when creating the image in the first place. As a result it allows
    users to edit and rebuild the live-system.
  </p><p>
    On images where the installation media also becomes an installation
    target, copying over <code class="literal">configuration.nix</code> should be
    disabled by setting <code class="literal">installer.cloneConfig</code> to
    <code class="literal">false</code>. For example, this is done in
    <code class="literal">sd-image-aarch64-installer.nix</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-profile-demo"></a>54.4. Demo</h2></div></div></div><p>
    This profile just enables a <code class="literal">demo</code> user, with
    password <code class="literal">demo</code>, uid <code class="literal">1000</code>,
    <code class="literal">wheel</code> group and
    <a class="link" href="options.html#opt-services.xserver.displayManager.autoLogin">autologin
    in the SDDM display manager</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-profile-docker-container"></a>54.5. Docker Container</h2></div></div></div><p>
    This is the profile from which the Docker images are generated. It
    prepares a working system by importing the
    <a class="link" href="index.html#sec-profile-minimal" title="54.10. Minimal">Minimal</a> and
    <a class="link" href="index.html#sec-profile-clone-config" title="54.3. Clone Config">Clone Config</a>
    profiles, and setting appropriate configuration options that are
    useful inside a container context, like
    <a class="xref" href="options.html#opt-boot.isContainer"><code class="option">boot.isContainer</code></a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-profile-graphical"></a>54.6. Graphical</h2></div></div></div><p>
    Defines a NixOS configuration with the Plasma 5 desktop. It’s used
    by the graphical installation CD.
  </p><p>
    It sets <a class="xref" href="options.html#opt-services.xserver.enable"><code class="option">services.xserver.enable</code></a>,
    <a class="xref" href="options.html#opt-services.xserver.displayManager.sddm.enable"><code class="option">services.xserver.displayManager.sddm.enable</code></a>,
    <a class="xref" href="options.html#opt-services.xserver.desktopManager.plasma5.enable"><code class="option">services.xserver.desktopManager.plasma5.enable</code></a>,
    and <a class="xref" href="options.html#opt-services.xserver.libinput.enable"><code class="option">services.xserver.libinput.enable</code></a> to true.
    It also includes glxinfo and firefox in the system packages list.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-profile-hardened"></a>54.7. Hardened</h2></div></div></div><p>
    A profile with most (vanilla) hardening options enabled by default,
    potentially at the cost of stability, features and performance.
  </p><p>
    This includes a hardened kernel, and limiting the system information
    available to processes through the <code class="literal">/sys</code> and
    <code class="literal">/proc</code> filesystems. It also disables the User
    Namespaces feature of the kernel, which stops Nix from being able to
    build anything (this particular setting can be overriden via
    <a class="xref" href="options.html#opt-security.allowUserNamespaces"><code class="option">security.allowUserNamespaces</code></a>). See the
    <a class="link" href="https://github.com/nixos/nixpkgs/tree/master/nixos/modules/profiles/hardened.nix" target="_top">profile
    source</a> for further detail on which settings are altered.
  </p><div class="warning"><h3 class="title">Warning</h3><p>
      This profile enables options that are known to affect system
      stability. If you experience any stability issues when using the
      profile, try disabling it. If you report an issue and use this
      profile, always mention that you do.
    </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-profile-headless"></a>54.8. Headless</h2></div></div></div><p>
    Common configuration for headless machines (e.g., Amazon EC2
    instances).
  </p><p>
    Disables <a class="link" href="options.html#opt-sound.enable">sound</a>,
    <a class="link" href="options.html#opt-boot.vesa">vesa</a>, serial consoles,
    <a class="link" href="options.html#opt-systemd.enableEmergencyMode">emergency
    mode</a>, <a class="link" href="options.html#opt-boot.loader.grub.splashImage">grub
    splash images</a> and configures the kernel to reboot
    automatically on panic.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-profile-installation-device"></a>54.9. Installation Device</h2></div></div></div><p>
    Provides a basic configuration for installation devices like CDs.
    This enables redistributable firmware, includes the
    <a class="link" href="index.html#sec-profile-clone-config" title="54.3. Clone Config">Clone Config profile</a>
    and a copy of the Nixpkgs channel, so
    <code class="literal">nixos-install</code> works out of the box.
  </p><p>
    Documentation for
    <a class="link" href="options.html#opt-documentation.enable">Nixpkgs</a> and
    <a class="link" href="options.html#opt-documentation.nixos.enable">NixOS</a> are
    forcefully enabled (to override the
    <a class="link" href="index.html#sec-profile-minimal" title="54.10. Minimal">Minimal profile</a>
    preference); the NixOS manual is shown automatically on TTY 8,
    udisks is disabled. Autologin is enabled as <code class="literal">nixos</code>
    user, while passwordless login as both <code class="literal">root</code> and
    <code class="literal">nixos</code> is possible. Passwordless
    <code class="literal">sudo</code> is enabled too.
    <a class="link" href="options.html#opt-networking.wireless.enable">wpa_supplicant</a>
    is enabled, but configured to not autostart.
  </p><p>
    It is explained how to login, start the ssh server, and if
    available, how to start the display manager.
  </p><p>
    Several settings are tweaked so that the installer has a better
    chance of succeeding under low-memory environments.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-profile-minimal"></a>54.10. Minimal</h2></div></div></div><p>
    This profile defines a small NixOS configuration. It does not
    contain any graphical stuff. It’s a very short file that enables
    <a class="link" href="options.html#opt-environment.noXlibs">noXlibs</a>, sets
    <a class="xref" href="options.html#opt-i18n.supportedLocales"><code class="option">i18n.supportedLocales</code></a> to only support the
    user-selected locale,
    <a class="link" href="options.html#opt-documentation.enable">disables packages’
    documentation</a>, and <a class="link" href="options.html#opt-sound.enable">disables
    sound</a>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-profile-qemu-guest"></a>54.11. QEMU Guest</h2></div></div></div><p>
    This profile contains common configuration for virtual machines
    running under QEMU (using virtio).
  </p><p>
    It makes virtio modules available on the initrd and sets the system
    time from the hardware clock to work around a bug in qemu-kvm.
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-kubernetes"></a>Chapter 55. Kubernetes</h2></div></div></div><p>
    The NixOS Kubernetes module is a collective term for a handful of
    individual submodules implementing the Kubernetes cluster
    components.
  </p><p>
    There are generally two ways of enabling Kubernetes on NixOS. One
    way is to enable and configure cluster components appropriately by
    hand:
  </p><pre class="programlisting">
services.kubernetes = {
  apiserver.enable = true;
  controllerManager.enable = true;
  scheduler.enable = true;
  addonManager.enable = true;
  proxy.enable = true;
  flannel.enable = true;
};
</pre><p>
    Another way is to assign cluster roles ("master" and/or
    "node") to the host. This enables apiserver,
    controllerManager, scheduler, addonManager, kube-proxy and etcd:
  </p><pre class="programlisting">
services.kubernetes.roles = [ "master" ];
</pre><p>
    While this will enable the kubelet and kube-proxy only:
  </p><pre class="programlisting">
services.kubernetes.roles = [ "node" ];
</pre><p>
    Assigning both the master and node roles is usable if you want a
    single node Kubernetes cluster for dev or testing purposes:
  </p><pre class="programlisting">
services.kubernetes.roles = [ "master" "node" ];
</pre><p>
    Note: Assigning either role will also default both
    <a class="xref" href="options.html#opt-services.kubernetes.flannel.enable"><code class="option">services.kubernetes.flannel.enable</code></a> and
    <a class="xref" href="options.html#opt-services.kubernetes.easyCerts"><code class="option">services.kubernetes.easyCerts</code></a> to true. This
    sets up flannel as CNI and activates automatic PKI bootstrapping.
  </p><p>
    As of kubernetes 1.10.X it has been deprecated to open
    non-tls-enabled ports on kubernetes components. Thus, from NixOS
    19.03 all plain HTTP ports have been disabled by default. While
    opening insecure ports is still possible, it is recommended not to
    bind these to other interfaces than loopback. To re-enable the
    insecure port on the apiserver, see options:
    <a class="xref" href="options.html#opt-services.kubernetes.apiserver.insecurePort"><code class="option">services.kubernetes.apiserver.insecurePort</code></a>
    and
    <a class="xref" href="options.html#opt-services.kubernetes.apiserver.insecureBindAddress"><code class="option">services.kubernetes.apiserver.insecureBindAddress</code></a>
  </p><div class="note"><h3 class="title">Note</h3><p>
      As of NixOS 19.03, it is mandatory to configure:
      <a class="xref" href="options.html#opt-services.kubernetes.masterAddress"><code class="option">services.kubernetes.masterAddress</code></a>. The
      masterAddress must be resolveable and routeable by all cluster
      nodes. In single node clusters, this can be set to
      <code class="literal">localhost</code>.
    </p></div><p>
    Role-based access control (RBAC) authorization mode is enabled by
    default. This means that anonymous requests to the apiserver secure
    port will expectedly cause a permission denied error. All cluster
    components must therefore be configured with x509 certificates for
    two-way tls communication. The x509 certificate subject section
    determines the roles and permissions granted by the apiserver to
    perform clusterwide or namespaced operations. See also:
    <a class="link" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" target="_top">
    Using RBAC Authorization</a>.
  </p><p>
    The NixOS kubernetes module provides an option for automatic
    certificate bootstrapping and configuration,
    <a class="xref" href="options.html#opt-services.kubernetes.easyCerts"><code class="option">services.kubernetes.easyCerts</code></a>. The PKI
    bootstrapping process involves setting up a certificate authority
    (CA) daemon (cfssl) on the kubernetes master node. cfssl generates a
    CA-cert for the cluster, and uses the CA-cert for signing
    subordinate certs issued to each of the cluster components.
    Subsequently, the certmgr daemon monitors active certificates and
    renews them when needed. For single node Kubernetes clusters,
    setting <a class="xref" href="options.html#opt-services.kubernetes.easyCerts"><code class="option">services.kubernetes.easyCerts</code></a> = true
    is sufficient and no further action is required. For joining extra
    node machines to an existing cluster on the other hand, establishing
    initial trust is mandatory.
  </p><p>
    To add new nodes to the cluster: On any (non-master) cluster node
    where <a class="xref" href="options.html#opt-services.kubernetes.easyCerts"><code class="option">services.kubernetes.easyCerts</code></a> is
    enabled, the helper script
    <code class="literal">nixos-kubernetes-node-join</code> is available on PATH.
    Given a token on stdin, it will copy the token to the kubernetes
    secrets directory and restart the certmgr service. As requested
    certificates are issued, the script will restart kubernetes cluster
    components as needed for them to pick up new keypairs.
  </p><div class="note"><h3 class="title">Note</h3><p>
      Multi-master (HA) clusters are not supported by the easyCerts
      module.
    </p></div><p>
    In order to interact with an RBAC-enabled cluster as an
    administrator, one needs to have cluster-admin privileges. By
    default, when easyCerts is enabled, a cluster-admin kubeconfig file
    is generated and linked into
    <code class="literal">/etc/kubernetes/cluster-admin.kubeconfig</code> as
    determined by
    <a class="xref" href="options.html#opt-services.kubernetes.pki.etcClusterAdminKubeconfig"><code class="option">services.kubernetes.pki.etcClusterAdminKubeconfig</code></a>.
    <code class="literal">export KUBECONFIG=/etc/kubernetes/cluster-admin.kubeconfig</code>
    will make kubectl use this kubeconfig to access and authenticate the
    cluster. The cluster-admin kubeconfig references an auto-generated
    keypair owned by root. Thus, only root on the kubernetes master may
    obtain cluster-admin rights by means of this file.
  </p></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="ch-running"></a>Part III. Administration</h1></div></div></div><div class="partintro"><div></div><p>
   This chapter describes various aspects of managing a running NixOS system,
   such as how to use the <span class="command"><strong>systemd</strong></span> service manager.
  </p><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="index.html#sec-systemctl">56. Service Management</a></span></dt><dt><span class="chapter"><a href="index.html#sec-rebooting">57. Rebooting and Shutting Down</a></span></dt><dt><span class="chapter"><a href="index.html#sec-user-sessions">58. User Sessions</a></span></dt><dt><span class="chapter"><a href="index.html#sec-cgroups">59. Control Groups</a></span></dt><dt><span class="chapter"><a href="index.html#sec-logging">60. Logging</a></span></dt><dt><span class="chapter"><a href="index.html#sec-nix-gc">61. Cleaning the Nix Store</a></span></dt><dt><span class="chapter"><a href="index.html#ch-containers">62. Container Management</a></span></dt><dt><span class="chapter"><a href="index.html#ch-troubleshooting">63. Troubleshooting</a></span></dt></dl></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-systemctl"></a>Chapter 56. Service Management</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sect-nixos-systemd-general">56.1. Interacting with a running systemd</a></span></dt><dt><span class="section"><a href="index.html#sect-nixos-systemd-nixos">56.2. systemd in NixOS</a></span></dt></dl></div><p>
    In NixOS, all system services are started and monitored using the
    systemd program. systemd is the <span class="quote">“<span class="quote">init</span>”</span> process of the
    system (i.e. PID 1), the parent of all other processes. It manages a
    set of so-called <span class="quote">“<span class="quote">units</span>”</span>, which can be things like
    system services (programs), but also mount points, swap files,
    devices, targets (groups of units) and more. Units can have complex
    dependencies; for instance, one unit can require that another unit
    must be successfully started before the first unit can be started.
    When the system boots, it starts a unit named
    <code class="literal">default.target</code>; the dependencies of this unit
    cause all system services to be started, file systems to be mounted,
    swap files to be activated, and so on.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sect-nixos-systemd-general"></a>56.1. Interacting with a running systemd</h2></div></div></div><p>
      The command <code class="literal">systemctl</code> is the main way to
      interact with <code class="literal">systemd</code>. The following paragraphs
      demonstrate ways to interact with any OS running systemd as init
      system. NixOS is of no exception. The
      <a class="link" href="index.html#sect-nixos-systemd-nixos" title="56.2. systemd in NixOS">next section </a>
      explains NixOS specific things worth knowing.
    </p><p>
      Without any arguments, <code class="literal">systemctl</code> the status of
      active units:
    </p><pre class="programlisting">
$ systemctl
-.mount          loaded active mounted   /
swapfile.swap    loaded active active    /swapfile
sshd.service     loaded active running   SSH Daemon
graphical.target loaded active active    Graphical Interface
...
</pre><p>
      You can ask for detailed status information about a unit, for
      instance, the PostgreSQL database service:
    </p><pre class="programlisting">
$ systemctl status postgresql.service
postgresql.service - PostgreSQL Server
          Loaded: loaded (/nix/store/pn3q73mvh75gsrl8w7fdlfk3fq5qm5mw-unit/postgresql.service)
          Active: active (running) since Mon, 2013-01-07 15:55:57 CET; 9h ago
        Main PID: 2390 (postgres)
          CGroup: name=systemd:/system/postgresql.service
                  ├─2390 postgres
                  ├─2418 postgres: writer process
                  ├─2419 postgres: wal writer process
                  ├─2420 postgres: autovacuum launcher process
                  ├─2421 postgres: stats collector process
                  └─2498 postgres: zabbix zabbix [local] idle

Jan 07 15:55:55 hagbard postgres[2394]: [1-1] LOG:  database system was shut down at 2013-01-07 15:55:05 CET
Jan 07 15:55:57 hagbard postgres[2390]: [1-1] LOG:  database system is ready to accept connections
Jan 07 15:55:57 hagbard postgres[2420]: [1-1] LOG:  autovacuum launcher started
Jan 07 15:55:57 hagbard systemd[1]: Started PostgreSQL Server.
</pre><p>
      Note that this shows the status of the unit (active and running),
      all the processes belonging to the service, as well as the most
      recent log messages from the service.
    </p><p>
      Units can be stopped, started or restarted:
    </p><pre class="programlisting">
# systemctl stop postgresql.service
# systemctl start postgresql.service
# systemctl restart postgresql.service
</pre><p>
      These operations are synchronous: they wait until the service has
      finished starting or stopping (or has failed). Starting a unit
      will cause the dependencies of that unit to be started as well (if
      necessary).
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sect-nixos-systemd-nixos"></a>56.2. systemd in NixOS</h2></div></div></div><p>
      Packages in Nixpkgs sometimes provide systemd units with them,
      usually in e.g <code class="literal">#pkg-out#/lib/systemd/</code>. Putting
      such a package in <code class="literal">environment.systemPackages</code>
      doesn't make the service available to users or the system.
    </p><p>
      In order to enable a systemd <span class="emphasis"><em>system</em></span> service
      with provided upstream package, use (e.g):
    </p><pre class="programlisting">
systemd.packages = [ pkgs.packagekit ];
</pre><p>
      Usually NixOS modules written by the community do the above, plus
      take care of other details. If a module was written for a service
      you are interested in, you'd probably need only to use
      <code class="literal">services.#name#.enable = true;</code>. These services
      are defined in Nixpkgs'
      <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/modules" target="_top">
      <code class="literal">nixos/modules/</code> directory </a>. In case the
      service is simple enough, the above method should work, and start
      the service on boot.
    </p><p>
      <span class="emphasis"><em>User</em></span> systemd services on the other hand,
      should be treated differently. Given a package that has a systemd
      unit file at <code class="literal">#pkg-out#/lib/systemd/user/</code>, using
      <a class="xref" href="options.html#opt-systemd.packages"><code class="option">systemd.packages</code></a> will make you able to
      start the service via <code class="literal">systemctl --user start</code>,
      but it won't start automatically on login. However, You can
      imperatively enable it by adding the package's attribute to
      <a class="xref" href="options.html#opt-systemd.packages"><code class="option">systemd.packages</code></a> and then do this (e.g):
    </p><pre class="programlisting">
$ mkdir -p ~/.config/systemd/user/default.target.wants
$ ln -s /run/current-system/sw/lib/systemd/user/syncthing.service ~/.config/systemd/user/default.target.wants/
$ systemctl --user daemon-reload
$ systemctl --user enable syncthing.service
</pre><p>
      If you are interested in a timer file, use
      <code class="literal">timers.target.wants</code> instead of
      <code class="literal">default.target.wants</code> in the 1st and 2nd
      command.
    </p><p>
      Using <code class="literal">systemctl --user enable syncthing.service</code>
      instead of the above, will work, but it'll use the absolute path
      of <code class="literal">syncthing.service</code> for the symlink, and this
      path is in <code class="literal">/nix/store/.../lib/systemd/user/</code>.
      Hence <a class="link" href="index.html#sec-nix-gc" title="Chapter 61. Cleaning the Nix Store">garbage collection</a> will
      remove that file and you will wind up with a broken symlink in
      your systemd configuration, which in turn will not make the
      service / timer start on login.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-rebooting"></a>Chapter 57. Rebooting and Shutting Down</h2></div></div></div><p>
    The system can be shut down (and automatically powered off) by
    doing:
  </p><pre class="programlisting">
# shutdown
</pre><p>
    This is equivalent to running <code class="literal">systemctl poweroff</code>.
  </p><p>
    To reboot the system, run
  </p><pre class="programlisting">
# reboot
</pre><p>
    which is equivalent to <code class="literal">systemctl reboot</code>.
    Alternatively, you can quickly reboot the system using
    <code class="literal">kexec</code>, which bypasses the BIOS by directly
    loading the new kernel into memory:
  </p><pre class="programlisting">
# systemctl kexec
</pre><p>
    The machine can be suspended to RAM (if supported) using
    <code class="literal">systemctl suspend</code>, and suspended to disk using
    <code class="literal">systemctl hibernate</code>.
  </p><p>
    These commands can be run by any user who is logged in locally, i.e.
    on a virtual console or in X11; otherwise, the user is asked for
    authentication.
  </p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-user-sessions"></a>Chapter 58. User Sessions</h2></div></div></div><p>
    Systemd keeps track of all users who are logged into the system
    (e.g. on a virtual console or remotely via SSH). The command
    <code class="literal">loginctl</code> allows querying and manipulating user
    sessions. For instance, to list all user sessions:
  </p><pre class="programlisting">
$ loginctl
   SESSION        UID USER             SEAT
        c1        500 eelco            seat0
        c3          0 root             seat0
        c4        500 alice
</pre><p>
    This shows that two users are logged in locally, while another is
    logged in remotely. (<span class="quote">“<span class="quote">Seats</span>”</span> are essentially the
    combinations of displays and input devices attached to the system;
    usually, there is only one seat.) To get information about a
    session:
  </p><pre class="programlisting">
$ loginctl session-status c3
c3 - root (0)
           Since: Tue, 2013-01-08 01:17:56 CET; 4min 42s ago
          Leader: 2536 (login)
            Seat: seat0; vc3
             TTY: /dev/tty3
         Service: login; type tty; class user
           State: online
          CGroup: name=systemd:/user/root/c3
                  ├─ 2536 /nix/store/10mn4xip9n7y9bxqwnsx7xwx2v2g34xn-shadow-4.1.5.1/bin/login --
                  ├─10339 -bash
                  └─10355 w3m nixos.org
</pre><p>
    This shows that the user is logged in on virtual console 3. It also
    lists the processes belonging to this session. Since systemd keeps
    track of this, you can terminate a session in a way that ensures
    that all the session’s processes are gone:
  </p><pre class="programlisting">
# loginctl terminate-session c3
</pre></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-cgroups"></a>Chapter 59. Control Groups</h2></div></div></div><p>
    To keep track of the processes in a running system, systemd uses
    <span class="emphasis"><em>control groups</em></span> (cgroups). A control group is a
    set of processes used to allocate resources such as CPU, memory or
    I/O bandwidth. There can be multiple control group hierarchies,
    allowing each kind of resource to be managed independently.
  </p><p>
    The command <code class="literal">systemd-cgls</code> lists all control groups
    in the <code class="literal">systemd</code> hierarchy, which is what systemd
    uses to keep track of the processes belonging to each service or
    user session:
  </p><pre class="programlisting">
$ systemd-cgls
├─user
│ └─eelco
│   └─c1
│     ├─ 2567 -:0
│     ├─ 2682 kdeinit4: kdeinit4 Running...
│     ├─ ...
│     └─10851 sh -c less -R
└─system
  ├─httpd.service
  │ ├─2444 httpd -f /nix/store/3pyacby5cpr55a03qwbnndizpciwq161-httpd.conf -DNO_DETACH
  │ └─...
  ├─dhcpcd.service
  │ └─2376 dhcpcd --config /nix/store/f8dif8dsi2yaa70n03xir8r653776ka6-dhcpcd.conf
  └─ ...
</pre><p>
    Similarly, <code class="literal">systemd-cgls cpu</code> shows the cgroups in
    the CPU hierarchy, which allows per-cgroup CPU scheduling
    priorities. By default, every systemd service gets its own CPU
    cgroup, while all user sessions are in the top-level CPU cgroup.
    This ensures, for instance, that a thousand run-away processes in
    the <code class="literal">httpd.service</code> cgroup cannot starve the CPU
    for one process in the <code class="literal">postgresql.service</code> cgroup.
    (By contrast, it they were in the same cgroup, then the PostgreSQL
    process would get 1/1001 of the cgroup’s CPU time.) You can limit a
    service’s CPU share in <code class="literal">configuration.nix</code>:
  </p><pre class="programlisting">
systemd.services.httpd.serviceConfig.CPUShares = 512;
</pre><p>
    By default, every cgroup has 1024 CPU shares, so this will halve the
    CPU allocation of the <code class="literal">httpd.service</code> cgroup.
  </p><p>
    There also is a <code class="literal">memory</code> hierarchy that controls
    memory allocation limits; by default, all processes are in the
    top-level cgroup, so any service or session can exhaust all
    available memory. Per-cgroup memory limits can be specified in
    <code class="literal">configuration.nix</code>; for instance, to limit
    <code class="literal">httpd.service</code> to 512 MiB of RAM (excluding swap):
  </p><pre class="programlisting">
systemd.services.httpd.serviceConfig.MemoryLimit = "512M";
</pre><p>
    The command <code class="literal">systemd-cgtop</code> shows a continuously
    updated list of all cgroups with their CPU and memory usage.
  </p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-logging"></a>Chapter 60. Logging</h2></div></div></div><p>
    System-wide logging is provided by systemd’s
    <span class="emphasis"><em>journal</em></span>, which subsumes traditional logging
    daemons such as syslogd and klogd. Log entries are kept in binary
    files in <code class="literal">/var/log/journal/</code>. The command
    <code class="literal">journalctl</code> allows you to see the contents of the
    journal. For example,
  </p><pre class="programlisting">
$ journalctl -b
</pre><p>
    shows all journal entries since the last reboot. (The output of
    <code class="literal">journalctl</code> is piped into <code class="literal">less</code>
    by default.) You can use various options and match operators to
    restrict output to messages of interest. For instance, to get all
    messages from PostgreSQL:
  </p><pre class="programlisting">
$ journalctl -u postgresql.service
-- Logs begin at Mon, 2013-01-07 13:28:01 CET, end at Tue, 2013-01-08 01:09:57 CET. --
...
Jan 07 15:44:14 hagbard postgres[2681]: [2-1] LOG:  database system is shut down
-- Reboot --
Jan 07 15:45:10 hagbard postgres[2532]: [1-1] LOG:  database system was shut down at 2013-01-07 15:44:14 CET
Jan 07 15:45:13 hagbard postgres[2500]: [1-1] LOG:  database system is ready to accept connections
</pre><p>
    Or to get all messages since the last reboot that have at least a
    <span class="quote">“<span class="quote">critical</span>”</span> severity level:
  </p><pre class="programlisting">
$ journalctl -b -p crit
Dec 17 21:08:06 mandark sudo[3673]: pam_unix(sudo:auth): auth could not identify password for [alice]
Dec 29 01:30:22 mandark kernel[6131]: [1053513.909444] CPU6: Core temperature above threshold, cpu clock throttled (total events = 1)
</pre><p>
    The system journal is readable by root and by users in the
    <code class="literal">wheel</code> and <code class="literal">systemd-journal</code>
    groups. All users have a private journal that can be read using
    <code class="literal">journalctl</code>.
  </p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-nix-gc"></a>Chapter 61. Cleaning the Nix Store</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sect-nixos-gc-boot-entries">61.1. NixOS Boot Entries</a></span></dt></dl></div><p>
    Nix has a purely functional model, meaning that packages are never
    upgraded in place. Instead new versions of packages end up in a
    different location in the Nix store (<code class="literal">/nix/store</code>).
    You should periodically run Nix’s <span class="emphasis"><em>garbage
    collector</em></span> to remove old, unreferenced packages. This is
    easy:
  </p><pre class="programlisting">
$ nix-collect-garbage
</pre><p>
    Alternatively, you can use a systemd unit that does the same in the
    background:
  </p><pre class="programlisting">
# systemctl start nix-gc.service
</pre><p>
    You can tell NixOS in <code class="literal">configuration.nix</code> to run
    this unit automatically at certain points in time, for instance,
    every night at 03:15:
  </p><pre class="programlisting">
nix.gc.automatic = true;
nix.gc.dates = "03:15";
</pre><p>
    The commands above do not remove garbage collector roots, such as
    old system configurations. Thus they do not remove the ability to
    roll back to previous configurations. The following command deletes
    old roots, removing the ability to roll back to them:
  </p><pre class="programlisting">
$ nix-collect-garbage -d
</pre><p>
    You can also do this for specific profiles, e.g.
  </p><pre class="programlisting">
$ nix-env -p /nix/var/nix/profiles/per-user/eelco/profile --delete-generations old
</pre><p>
    Note that NixOS system configurations are stored in the profile
    <code class="literal">/nix/var/nix/profiles/system</code>.
  </p><p>
    Another way to reclaim disk space (often as much as 40% of the size
    of the Nix store) is to run Nix’s store optimiser, which seeks out
    identical files in the store and replaces them with hard links to a
    single copy.
  </p><pre class="programlisting">
$ nix-store --optimise
</pre><p>
    Since this command needs to read the entire Nix store, it can take
    quite a while to finish.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sect-nixos-gc-boot-entries"></a>61.1. NixOS Boot Entries</h2></div></div></div><p>
      If your <code class="literal">/boot</code> partition runs out of space,
      after clearing old profiles you must rebuild your system with
      <code class="literal">nixos-rebuild boot</code> or
      <code class="literal">nixos-rebuild switch</code> to update the
      <code class="literal">/boot</code> partition and clear space.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="ch-containers"></a>Chapter 62. Container Management</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-imperative-containers">62.1. Imperative Container Management</a></span></dt><dt><span class="section"><a href="index.html#sec-declarative-containers">62.2. Declarative Container Specification</a></span></dt><dt><span class="section"><a href="index.html#sec-container-networking">62.3. Container Networking</a></span></dt></dl></div><p>
    NixOS allows you to easily run other NixOS instances as
    <span class="emphasis"><em>containers</em></span>. Containers are a light-weight
    approach to virtualisation that runs software in the container at
    the same speed as in the host system. NixOS containers share the Nix
    store of the host, making container creation very efficient.
  </p><div class="warning"><h3 class="title">Warning</h3><p>
      Currently, NixOS containers are not perfectly isolated from the
      host system. This means that a user with root access to the
      container can do things that affect the host. So you should not
      give container root access to untrusted users.
    </p></div><p>
    NixOS containers can be created in two ways: imperatively, using the
    command <code class="literal">nixos-container</code>, and declaratively, by
    specifying them in your <code class="literal">configuration.nix</code>. The
    declarative approach implies that containers get upgraded along with
    your host system when you run <code class="literal">nixos-rebuild</code>,
    which is often not what you want. By contrast, in the imperative
    approach, containers are configured and updated independently from
    the host system.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-imperative-containers"></a>62.1. Imperative Container Management</h2></div></div></div><p>
    We’ll cover imperative container management using
    <code class="literal">nixos-container</code> first. Be aware that container
    management is currently only possible as <code class="literal">root</code>.
  </p><p>
    You create a container with identifier <code class="literal">foo</code> as
    follows:
  </p><pre class="programlisting">
# nixos-container create foo
</pre><p>
    This creates the container’s root directory in
    <code class="literal">/var/lib/containers/foo</code> and a small configuration
    file in <code class="literal">/etc/containers/foo.conf</code>. It also builds
    the container’s initial system configuration and stores it in
    <code class="literal">/nix/var/nix/profiles/per-container/foo/system</code>.
    You can modify the initial configuration of the container on the
    command line. For instance, to create a container that has
    <code class="literal">sshd</code> running, with the given public key for
    <code class="literal">root</code>:
  </p><pre class="programlisting">
# nixos-container create foo --config '
  services.openssh.enable = true;
  users.users.root.openssh.authorizedKeys.keys = ["ssh-dss AAAAB3N…"];
'
</pre><p>
    By default the next free address in the
    <code class="literal">10.233.0.0/16</code> subnet will be chosen as container
    IP. This behavior can be altered by setting
    <code class="literal">--host-address</code> and
    <code class="literal">--local-address</code>:
  </p><pre class="programlisting">
# nixos-container create test --config-file test-container.nix \
    --local-address 10.235.1.2 --host-address 10.235.1.1
</pre><p>
    Creating a container does not start it. To start the container, run:
  </p><pre class="programlisting">
# nixos-container start foo
</pre><p>
    This command will return as soon as the container has booted and has
    reached <code class="literal">multi-user.target</code>. On the host, the
    container runs within a systemd unit called
    <code class="literal">container@container-name.service</code>. Thus, if
    something went wrong, you can get status info using
    <code class="literal">systemctl</code>:
  </p><pre class="programlisting">
# systemctl status container@foo
</pre><p>
    If the container has started successfully, you can log in as root
    using the <code class="literal">root-login</code> operation:
  </p><pre class="programlisting">
# nixos-container root-login foo
[root@foo:~]#
</pre><p>
    Note that only root on the host can do this (since there is no
    authentication). You can also get a regular login prompt using the
    <code class="literal">login</code> operation, which is available to all users
    on the host:
  </p><pre class="programlisting">
# nixos-container login foo
foo login: alice
Password: ***
</pre><p>
    With <code class="literal">nixos-container run</code>, you can execute
    arbitrary commands in the container:
  </p><pre class="programlisting">
# nixos-container run foo -- uname -a
Linux foo 3.4.82 #1-NixOS SMP Thu Mar 20 14:44:05 UTC 2014 x86_64 GNU/Linux
</pre><p>
    There are several ways to change the configuration of the container.
    First, on the host, you can edit
    <code class="literal">/var/lib/container/name/etc/nixos/configuration.nix</code>,
    and run
  </p><pre class="programlisting">
# nixos-container update foo
</pre><p>
    This will build and activate the new configuration. You can also
    specify a new configuration on the command line:
  </p><pre class="programlisting">
# nixos-container update foo --config '
  services.httpd.enable = true;
  services.httpd.adminAddr = "foo@example.org";
  networking.firewall.allowedTCPPorts = [ 80 ];
'

# curl http://$(nixos-container show-ip foo)/
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;…
</pre><p>
    However, note that this will overwrite the container’s
    <code class="literal">/etc/nixos/configuration.nix</code>.
  </p><p>
    Alternatively, you can change the configuration from within the
    container itself by running <code class="literal">nixos-rebuild switch</code>
    inside the container. Note that the container by default does not
    have a copy of the NixOS channel, so you should run
    <code class="literal">nix-channel --update</code> first.
  </p><p>
    Containers can be stopped and started using
    <code class="literal">nixos-container stop</code> and
    <code class="literal">nixos-container start</code>, respectively, or by using
    <code class="literal">systemctl</code> on the container’s service unit. To
    destroy a container, including its file system, do
  </p><pre class="programlisting">
# nixos-container destroy foo
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-declarative-containers"></a>62.2. Declarative Container Specification</h2></div></div></div><p>
    You can also specify containers and their configuration in the
    host’s <code class="literal">configuration.nix</code>. For example, the
    following specifies that there shall be a container named
    <code class="literal">database</code> running PostgreSQL:
  </p><pre class="programlisting">
containers.database =
  { config =
      { config, pkgs, ... }:
      { services.postgresql.enable = true;
      services.postgresql.package = pkgs.postgresql_10;
      };
  };
</pre><p>
    If you run <code class="literal">nixos-rebuild switch</code>, the container
    will be built. If the container was already running, it will be
    updated in place, without rebooting. The container can be configured
    to start automatically by setting
    <code class="literal">containers.database.autoStart = true</code> in its
    configuration.
  </p><p>
    By default, declarative containers share the network namespace of
    the host, meaning that they can listen on (privileged) ports.
    However, they cannot change the network configuration. You can give
    a container its own network as follows:
  </p><pre class="programlisting">
containers.database = {
  privateNetwork = true;
  hostAddress = "192.168.100.10";
  localAddress = "192.168.100.11";
};
</pre><p>
    This gives the container a private virtual Ethernet interface with
    IP address <code class="literal">192.168.100.11</code>, which is hooked up to
    a virtual Ethernet interface on the host with IP address
    <code class="literal">192.168.100.10</code>. (See the next section for details
    on container networking.)
  </p><p>
    To disable the container, just remove it from
    <code class="literal">configuration.nix</code> and run
    <code class="literal">nixos-rebuild switch</code>. Note that this will not
    delete the root directory of the container in
    <code class="literal">/var/lib/containers</code>. Containers can be destroyed
    using the imperative method:
    <code class="literal">nixos-container destroy foo</code>.
  </p><p>
    Declarative containers can be started and stopped using the
    corresponding systemd service, e.g.
    <code class="literal">systemctl start container@database</code>.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-container-networking"></a>62.3. Container Networking</h2></div></div></div><p>
    When you create a container using
    <code class="literal">nixos-container create</code>, it gets it own private
    IPv4 address in the range <code class="literal">10.233.0.0/16</code>. You can
    get the container’s IPv4 address as follows:
  </p><pre class="programlisting">
# nixos-container show-ip foo
10.233.4.2

$ ping -c1 10.233.4.2
64 bytes from 10.233.4.2: icmp_seq=1 ttl=64 time=0.106 ms
</pre><p>
    Networking is implemented using a pair of virtual Ethernet devices.
    The network interface in the container is called
    <code class="literal">eth0</code>, while the matching interface in the host is
    called <code class="literal">ve-container-name</code> (e.g.,
    <code class="literal">ve-foo</code>). The container has its own network
    namespace and the <code class="literal">CAP_NET_ADMIN</code> capability, so it
    can perform arbitrary network configuration such as setting up
    firewall rules, without affecting or having access to the host’s
    network.
  </p><p>
    By default, containers cannot talk to the outside network. If you
    want that, you should set up Network Address Translation (NAT) rules
    on the host to rewrite container traffic to use your external IP
    address. This can be accomplished using the following configuration
    on the host:
  </p><pre class="programlisting">
networking.nat.enable = true;
networking.nat.internalInterfaces = ["ve-+"];
networking.nat.externalInterface = "eth0";
</pre><p>
    where <code class="literal">eth0</code> should be replaced with the desired
    external interface. Note that <code class="literal">ve-+</code> is a wildcard
    that matches all container interfaces.
  </p><p>
    If you are using Network Manager, you need to explicitly prevent it
    from managing container interfaces:
  </p><pre class="programlisting">
networking.networkmanager.unmanaged = [ "interface-name:ve-*" ];
</pre><p>
    You may need to restart your system for the changes to take effect.
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="ch-troubleshooting"></a>Chapter 63. Troubleshooting</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-boot-problems">63.1. Boot Problems</a></span></dt><dt><span class="section"><a href="index.html#sec-maintenance-mode">63.2. Maintenance Mode</a></span></dt><dt><span class="section"><a href="index.html#sec-rollback">63.3. Rolling Back Configuration Changes</a></span></dt><dt><span class="section"><a href="index.html#sec-nix-store-corruption">63.4. Nix Store Corruption</a></span></dt><dt><span class="section"><a href="index.html#sec-nix-network-issues">63.5. Network Problems</a></span></dt></dl></div><p>
    This chapter describes solutions to common problems you might
    encounter when you manage your NixOS system.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-boot-problems"></a>63.1. Boot Problems</h2></div></div></div><p>
    If NixOS fails to boot, there are a number of kernel command line
    parameters that may help you to identify or fix the issue. You can
    add these parameters in the GRUB boot menu by pressing “e” to modify
    the selected boot entry and editing the line starting with
    <code class="literal">linux</code>. The following are some useful kernel
    command line parameters that are recognised by the NixOS boot
    scripts or by systemd:
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        <code class="literal">boot.shell_on_fail</code>
      </span></dt><dd><p>
          Allows the user to start a root shell if something goes wrong
          in stage 1 of the boot process (the initial ramdisk). This is
          disabled by default because there is no authentication for the
          root shell.
        </p></dd><dt><span class="term">
        <code class="literal">boot.debug1</code>
      </span></dt><dd><p>
          Start an interactive shell in stage 1 before anything useful
          has been done. That is, no modules have been loaded and no
          file systems have been mounted, except for
          <code class="literal">/proc</code> and <code class="literal">/sys</code>.
        </p></dd><dt><span class="term">
        <code class="literal">boot.debug1devices</code>
      </span></dt><dd><p>
          Like <code class="literal">boot.debug1</code>, but runs stage1 until
          kernel modules are loaded and device nodes are created. This
          may help with e.g. making the keyboard work.
        </p></dd><dt><span class="term">
        <code class="literal">boot.debug1mounts</code>
      </span></dt><dd><p>
          Like <code class="literal">boot.debug1</code> or
          <code class="literal">boot.debug1devices</code>, but runs stage1 until
          all filesystems that are mounted during initrd are mounted
          (see
          <a class="link" href="options.html#opt-fileSystems._name_.neededForBoot">neededForBoot</a>).
          As a motivating example, this could be useful if you’ve
          forgotten to set
          <a class="link" href="options.html#opt-fileSystems._name_.neededForBoot">neededForBoot</a>
          on a file system.
        </p></dd><dt><span class="term">
        <code class="literal">boot.trace</code>
      </span></dt><dd><p>
          Print every shell command executed by the stage 1 and 2 boot
          scripts.
        </p></dd><dt><span class="term">
        <code class="literal">single</code>
      </span></dt><dd><p>
          Boot into rescue mode (a.k.a. single user mode). This will
          cause systemd to start nothing but the unit
          <code class="literal">rescue.target</code>, which runs
          <code class="literal">sulogin</code> to prompt for the root password and
          start a root login shell. Exiting the shell causes the system
          to continue with the normal boot process.
        </p></dd><dt><span class="term">
        <code class="literal">systemd.log_level=debug</code>
        <code class="literal">systemd.log_target=console</code>
      </span></dt><dd><p>
          Make systemd very verbose and send log messages to the console
          instead of the journal. For more parameters recognised by
          systemd, see systemd(1).
        </p></dd></dl></div><p>
    In addition, these arguments are recognised by the live image only:
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        <code class="literal">live.nixos.passwd=password</code>
      </span></dt><dd><p>
          Set the password for the <code class="literal">nixos</code> live user.
          This can be used for SSH access if there are issues using the
          terminal.
        </p></dd></dl></div><p>
    Notice that for <code class="literal">boot.shell_on_fail</code>,
    <code class="literal">boot.debug1</code>,
    <code class="literal">boot.debug1devices</code>, and
    <code class="literal">boot.debug1mounts</code>, if you did
    <span class="strong"><strong>not</strong></span> select <span class="quote">“<span class="quote">start the new
    shell as pid 1</span>”</span>, and you <code class="literal">exit</code> from the new
    shell, boot will proceed normally from the point where it failed, as
    if you’d chosen <span class="quote">“<span class="quote">ignore the error and continue</span>”</span>.
  </p><p>
    If no login prompts or X11 login screens appear (e.g. due to hanging
    dependencies), you can press Alt+ArrowUp. If you’re lucky, this will
    start rescue mode (described above). (Also note that since most
    units have a 90-second timeout before systemd gives up on them, the
    <code class="literal">agetty</code> login prompts should appear eventually
    unless something is very wrong.)
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-maintenance-mode"></a>63.2. Maintenance Mode</h2></div></div></div><p>
    You can enter rescue mode by running:
  </p><pre class="programlisting">
# systemctl rescue
</pre><p>
    This will eventually give you a single-user root shell. Systemd will
    stop (almost) all system services. To get out of maintenance mode,
    just exit from the rescue shell.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-rollback"></a>63.3. Rolling Back Configuration Changes</h2></div></div></div><p>
    After running <code class="literal">nixos-rebuild</code> to switch to a new
    configuration, you may find that the new configuration doesn’t work
    very well. In that case, there are several ways to return to a
    previous configuration.
  </p><p>
    First, the GRUB boot manager allows you to boot into any previous
    configuration that hasn’t been garbage-collected. These
    configurations can be found under the GRUB submenu <span class="quote">“<span class="quote">NixOS -
    All configurations</span>”</span>. This is especially useful if the new
    configuration fails to boot. After the system has booted, you can
    make the selected configuration the default for subsequent boots:
  </p><pre class="programlisting">
# /run/current-system/bin/switch-to-configuration boot
</pre><p>
    Second, you can switch to the previous configuration in a running
    system:
  </p><pre class="programlisting">
# nixos-rebuild switch --rollback
</pre><p>
    This is equivalent to running:
  </p><pre class="programlisting">
# /nix/var/nix/profiles/system-N-link/bin/switch-to-configuration switch
</pre><p>
    where <code class="literal">N</code> is the number of the NixOS system
    configuration. To get a list of the available configurations, do:
  </p><pre class="programlisting">
$ ls -l /nix/var/nix/profiles/system-*-link
...
lrwxrwxrwx 1 root root 78 Aug 12 13:54 /nix/var/nix/profiles/system-268-link -&gt; /nix/store/202b...-nixos-13.07pre4932_5a676e4-4be1055
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-nix-store-corruption"></a>63.4. Nix Store Corruption</h2></div></div></div><p>
    After a system crash, it’s possible for files in the Nix store to
    become corrupted. (For instance, the Ext4 file system has the
    tendency to replace un-synced files with zero bytes.) NixOS tries
    hard to prevent this from happening: it performs a
    <code class="literal">sync</code> before switching to a new configuration, and
    Nix’s database is fully transactional. If corruption still occurs,
    you may be able to fix it automatically.
  </p><p>
    If the corruption is in a path in the closure of the NixOS system
    configuration, you can fix it by doing
  </p><pre class="programlisting">
# nixos-rebuild switch --repair
</pre><p>
    This will cause Nix to check every path in the closure, and if its
    cryptographic hash differs from the hash recorded in Nix’s database,
    the path is rebuilt or redownloaded.
  </p><p>
    You can also scan the entire Nix store for corrupt paths:
  </p><pre class="programlisting">
# nix-store --verify --check-contents --repair
</pre><p>
    Any corrupt paths will be redownloaded if they’re available in a
    binary cache; otherwise, they cannot be repaired.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-nix-network-issues"></a>63.5. Network Problems</h2></div></div></div><p>
    Nix uses a so-called <span class="emphasis"><em>binary cache</em></span> to optimise
    building a package from source into downloading it as a pre-built
    binary. That is, whenever a command like
    <code class="literal">nixos-rebuild</code> needs a path in the Nix store, Nix
    will try to download that path from the Internet rather than build
    it from source. The default binary cache is
    <code class="literal">https://cache.nixos.org/</code>. If this cache is
    unreachable, Nix operations may take a long time due to HTTP
    connection timeouts. You can disable the use of the binary cache by
    adding <code class="literal">--option use-binary-caches false</code>, e.g.
  </p><pre class="programlisting">
# nixos-rebuild switch --option use-binary-caches false
</pre><p>
    If you have an alternative binary cache at your disposal, you can
    use it instead:
  </p><pre class="programlisting">
# nixos-rebuild switch --option binary-caches http://my-cache.example.org/
</pre></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="ch-development"></a>Part IV. Development</h1></div></div></div><div class="partintro"><div></div><p>
   This chapter describes how you can modify and extend NixOS.
  </p><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="index.html#sec-getting-sources">64. Getting the Sources</a></span></dt><dt><span class="chapter"><a href="index.html#sec-writing-modules">65. Writing NixOS Modules</a></span></dt><dt><span class="chapter"><a href="index.html#sec-building-parts">66. Building Specific Parts of NixOS</a></span></dt><dt><span class="chapter"><a href="index.html#sec-switching-systems">67. What happens during a system switch?</a></span></dt><dt><span class="chapter"><a href="index.html#sec-writing-documentation">68. Writing NixOS Documentation</a></span></dt><dt><span class="chapter"><a href="index.html#sec-building-image">69. Building a NixOS (Live) ISO</a></span></dt><dt><span class="chapter"><a href="index.html#sec-nixos-tests">70. NixOS Tests</a></span></dt><dt><span class="chapter"><a href="index.html#ch-testing-installer">71. Testing the Installer</a></span></dt></dl></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-getting-sources"></a>Chapter 64. Getting the Sources</h2></div></div></div><p>
    By default, NixOS’s <code class="literal">nixos-rebuild</code> command uses
    the NixOS and Nixpkgs sources provided by the
    <code class="literal">nixos</code> channel (kept in
    <code class="literal">/nix/var/nix/profiles/per-user/root/channels/nixos</code>).
    To modify NixOS, however, you should check out the latest sources
    from Git. This is as follows:
  </p><pre class="programlisting">
$ git clone https://github.com/NixOS/nixpkgs
$ cd nixpkgs
$ git remote update origin
</pre><p>
    This will check out the latest Nixpkgs sources to
    <code class="literal">./nixpkgs</code> the NixOS sources to
    <code class="literal">./nixpkgs/nixos</code>. (The NixOS source tree lives in
    a subdirectory of the Nixpkgs repository.) The
    <code class="literal">nixpkgs</code> repository has branches that correspond
    to each Nixpkgs/NixOS channel (see <a class="xref" href="index.html#sec-upgrading" title="Chapter 4. Upgrading NixOS">Chapter 4, <em>Upgrading NixOS</em></a>
    for more information about channels). Thus, the Git branch
    <code class="literal">origin/nixos-17.03</code> will contain the latest built
    and tested version available in the <code class="literal">nixos-17.03</code>
    channel.
  </p><p>
    It’s often inconvenient to develop directly on the master branch,
    since if somebody has just committed (say) a change to GCC, then the
    binary cache may not have caught up yet and you’ll have to rebuild
    everything from source. So you may want to create a local branch
    based on your current NixOS version:
  </p><pre class="programlisting">
$ nixos-version
17.09pre104379.6e0b727 (Hummingbird)

$ git checkout -b local 6e0b727
</pre><p>
    Or, to base your local branch on the latest version available in a
    NixOS channel:
  </p><pre class="programlisting">
$ git remote update origin
$ git checkout -b local origin/nixos-17.03
</pre><p>
    (Replace <code class="literal">nixos-17.03</code> with the name of the channel
    you want to use.) You can use <code class="literal">git merge</code> or
    <code class="literal">git rebase</code> to keep your local branch in sync with
    the channel, e.g.
  </p><pre class="programlisting">
$ git remote update origin
$ git merge origin/nixos-17.03
</pre><p>
    You can use <code class="literal">git cherry-pick</code> to copy commits from
    your local branch to the upstream branch.
  </p><p>
    If you want to rebuild your system using your (modified) sources,
    you need to tell <code class="literal">nixos-rebuild</code> about them using
    the <code class="literal">-I</code> flag:
  </p><pre class="programlisting">
# nixos-rebuild switch -I nixpkgs=/my/sources/nixpkgs
</pre><p>
    If you want <code class="literal">nix-env</code> to use the expressions in
    <code class="literal">/my/sources</code>, use
    <code class="literal">nix-env -f /my/sources/nixpkgs</code>, or change the
    default by adding a symlink in <code class="literal">~/.nix-defexpr</code>:
  </p><pre class="programlisting">
$ ln -s /my/sources/nixpkgs ~/.nix-defexpr/nixpkgs
</pre><p>
    You may want to delete the symlink
    <code class="literal">~/.nix-defexpr/channels_root</code> to prevent root’s
    NixOS channel from clashing with your own tree (this may break the
    command-not-found utility though). If you want to go back to the
    default state, you may just remove the
    <code class="literal">~/.nix-defexpr</code> directory completely, log out and
    log in again and it should have been recreated with a link to the
    root channels.
  </p></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-writing-modules"></a>Chapter 65. Writing NixOS Modules</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-option-declarations">65.1. Option Declarations</a></span></dt><dt><span class="section"><a href="index.html#sec-option-types">65.2. Options Types</a></span></dt><dt><span class="section"><a href="index.html#sec-option-definitions">65.3. Option Definitions</a></span></dt><dt><span class="section"><a href="index.html#sec-assertions">65.4. Warnings and Assertions</a></span></dt><dt><span class="section"><a href="index.html#sec-meta-attributes">65.5. Meta Attributes</a></span></dt><dt><span class="section"><a href="index.html#sec-importing-modules">65.6. Importing Modules</a></span></dt><dt><span class="section"><a href="index.html#sec-replace-modules">65.7. Replace Modules</a></span></dt><dt><span class="section"><a href="index.html#sec-freeform-modules">65.8. Freeform modules</a></span></dt><dt><span class="section"><a href="index.html#sec-settings-options">65.9. Options for Program Settings</a></span></dt></dl></div><p>
    NixOS has a modular system for declarative configuration. This
    system combines multiple <span class="emphasis"><em>modules</em></span> to produce the
    full system configuration. One of the modules that constitute the
    configuration is <code class="literal">/etc/nixos/configuration.nix</code>.
    Most of the others live in the
    <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/modules" target="_top"><code class="literal">nixos/modules</code></a>
    subdirectory of the Nixpkgs tree.
  </p><p>
    Each NixOS module is a file that handles one logical aspect of the
    configuration, such as a specific kind of hardware, a service, or
    network settings. A module configuration does not have to handle
    everything from scratch; it can use the functionality provided by
    other modules for its implementation. Thus a module can
    <span class="emphasis"><em>declare</em></span> options that can be used by other
    modules, and conversely can <span class="emphasis"><em>define</em></span> options
    provided by other modules in its own implementation. For example,
    the module
    <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/security/pam.nix" target="_top"><code class="literal">pam.nix</code></a>
    declares the option <code class="literal">security.pam.services</code> that
    allows other modules (e.g.
    <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/networking/ssh/sshd.nix" target="_top"><code class="literal">sshd.nix</code></a>)
    to define PAM services; and it defines the option
    <code class="literal">environment.etc</code> (declared by
    <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/system/etc/etc.nix" target="_top"><code class="literal">etc.nix</code></a>)
    to cause files to be created in <code class="literal">/etc/pam.d</code>.
  </p><p>
    In <a class="xref" href="index.html#sec-configuration-syntax" title="Chapter 5. Configuration Syntax">Chapter 5, <em>Configuration Syntax</em></a>, we saw the following
    structure of NixOS modules:
  </p><pre class="programlisting">
{ config, pkgs, ... }:

{ option definitions
}
</pre><p>
    This is actually an <span class="emphasis"><em>abbreviated</em></span> form of module
    that only defines options, but does not declare any. The structure
    of full NixOS modules is shown in
    <a class="link" href="index.html#ex-module-syntax">Example: Structure of NixOS
    Modules</a>.
  </p><a id="ex-module-syntax"></a><p>
    <span class="strong"><strong>Example: Structure of NixOS
    Modules</strong></span>
  </p><pre class="programlisting">
{ config, pkgs, ... }:

{
  imports =
    [ paths of other modules
    ];

  options = {
    option declarations
  };

  config = {
    option definitions
  };
}
</pre><p>
    The meaning of each part is as follows.
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        The first line makes the current Nix expression a function. The
        variable <code class="literal">pkgs</code> contains Nixpkgs (by default,
        it takes the <code class="literal">nixpkgs</code> entry of
        <code class="literal">NIX_PATH</code>, see the
        <a class="link" href="https://nixos.org/manual/nix/stable/#sec-common-env" target="_top">Nix
        manual</a> for further details), while
        <code class="literal">config</code> contains the full system
        configuration. This line can be omitted if there is no reference
        to <code class="literal">pkgs</code> and <code class="literal">config</code> inside
        the module.
      </p></li><li class="listitem"><p>
        This <code class="literal">imports</code> list enumerates the paths to
        other NixOS modules that should be included in the evaluation of
        the system configuration. A default set of modules is defined in
        the file <code class="literal">modules/module-list.nix</code>. These don't
        need to be added in the import list.
      </p></li><li class="listitem"><p>
        The attribute <code class="literal">options</code> is a nested set of
        <span class="emphasis"><em>option declarations</em></span> (described below).
      </p></li><li class="listitem"><p>
        The attribute <code class="literal">config</code> is a nested set of
        <span class="emphasis"><em>option definitions</em></span> (also described below).
      </p></li></ul></div><p>
    <a class="link" href="index.html#locate-example">Example: NixOS Module for the
    <span class="quote">“<span class="quote">locate</span>”</span> Service</a> shows a module that handles the
    regular update of the <span class="quote">“<span class="quote">locate</span>”</span> database, an index of
    all files in the file system. This module declares two options that
    can be defined by other modules (typically the user’s
    <code class="literal">configuration.nix</code>):
    <code class="literal">services.locate.enable</code> (whether the database
    should be updated) and <code class="literal">services.locate.interval</code>
    (when the update should be done). It implements its functionality by
    defining two options declared by other modules:
    <code class="literal">systemd.services</code> (the set of all systemd
    services) and <code class="literal">systemd.timers</code> (the list of
    commands to be executed periodically by <code class="literal">systemd</code>).
  </p><p>
    Care must be taken when writing systemd services using
    <code class="literal">Exec*</code> directives. By default systemd performs
    substitution on <code class="literal">%&lt;char&gt;</code> specifiers in these
    directives, expands environment variables from
    <code class="literal">$FOO</code> and <code class="literal">${FOO}</code>, splits
    arguments on whitespace, and splits commands on
    <code class="literal">;</code>. All of these must be escaped to avoid
    unexpected substitution or splitting when interpolating into an
    <code class="literal">Exec*</code> directive, e.g. when using an
    <code class="literal">extraArgs</code> option to pass additional arguments to
    the service. The functions
    <code class="literal">utils.escapeSystemdExecArg</code> and
    <code class="literal">utils.escapeSystemdExecArgs</code> are provided for
    this, see <a class="link" href="index.html#exec-escaping-example">Example: Escaping in
    Exec directives</a> for an example. When using these functions
    system environment substitution should <span class="emphasis"><em>not</em></span> be
    disabled explicitly.
  </p><a id="locate-example"></a><p>
    <span class="strong"><strong>Example: NixOS Module for the
    <span class="quote">“<span class="quote">locate</span>”</span> Service</strong></span>
  </p><pre class="programlisting">
{ config, lib, pkgs, ... }:

with lib;

let
  cfg = config.services.locate;
in {
  options.services.locate = {
    enable = mkOption {
      type = types.bool;
      default = false;
      description = ''
        If enabled, NixOS will periodically update the database of
        files used by the locate command.
      '';
    };

    interval = mkOption {
      type = types.str;
      default = "02:15";
      example = "hourly";
      description = ''
        Update the locate database at this interval. Updates by
        default at 2:15 AM every day.

        The format is described in
        systemd.time(7).
      '';
    };

    # Other options omitted for documentation
  };

  config = {
    systemd.services.update-locatedb =
      { description = "Update Locate Database";
        path  = [ pkgs.su ];
        script =
          ''
            mkdir -m 0755 -p $(dirname ${toString cfg.output})
            exec updatedb \
              --localuser=${cfg.localuser} \
              ${optionalString (!cfg.includeStore) "--prunepaths='/nix/store'"} \
              --output=${toString cfg.output} ${concatStringsSep " " cfg.extraFlags}
          '';
      };

    systemd.timers.update-locatedb = mkIf cfg.enable
      { description = "Update timer for locate database";
        partOf      = [ "update-locatedb.service" ];
        wantedBy    = [ "timers.target" ];
        timerConfig.OnCalendar = cfg.interval;
      };
  };
}
</pre><a id="exec-escaping-example"></a><p>
    <span class="strong"><strong>Example: Escaping in Exec
    directives</strong></span>
  </p><pre class="programlisting">
{ config, lib, pkgs, utils, ... }:

with lib;

let
  cfg = config.services.echo;
  echoAll = pkgs.writeScript "echo-all" ''
    #! ${pkgs.runtimeShell}
    for s in "$@"; do
      printf '%s\n' "$s"
    done
  '';
  args = [ "a%Nything" "lang=\${LANG}" ";" "/bin/sh -c date" ];
in {
  systemd.services.echo =
    { description = "Echo to the journal";
      wantedBy = [ "multi-user.target" ];
      serviceConfig.Type = "oneshot";
      serviceConfig.ExecStart = ''
        ${echoAll} ${utils.escapeSystemdExecArgs args}
      '';
    };
}
</pre><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-option-declarations"></a>65.1. Option Declarations</h2></div></div></div><p>
    An option declaration specifies the name, type and description of a
    NixOS configuration option. It is invalid to define an option that
    hasn’t been declared in any module. An option declaration generally
    looks like this:
  </p><pre class="programlisting">
options = {
  name = mkOption {
    type = type specification;
    default = default value;
    example = example value;
    description = "Description for use in the NixOS manual.";
  };
};
</pre><p>
    The attribute names within the <code class="literal">name</code> attribute
    path must be camel cased in general but should, as an exception,
    match the
    <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-package-naming" target="_top">
    package attribute name</a> when referencing a Nixpkgs package.
    For example, the option
    <code class="literal">services.nix-serve.bindAddress</code> references the
    <code class="literal">nix-serve</code> Nixpkgs package.
  </p><p>
    The function <code class="literal">mkOption</code> accepts the following
    arguments.
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        <code class="literal">type</code>
      </span></dt><dd><p>
          The type of the option (see
          <a class="xref" href="index.html#sec-option-types" title="65.2. Options Types">Section 65.2, “Options Types”</a>). This argument is
          mandatory for nixpkgs modules. Setting this is highly
          recommended for the sake of documentation and type checking.
          In case it is not set, a fallback type with unspecified
          behavior is used.
        </p></dd><dt><span class="term">
        <code class="literal">default</code>
      </span></dt><dd><p>
          The default value used if no value is defined by any module. A
          default is not required; but if a default is not given, then
          users of the module will have to define the value of the
          option, otherwise an error will be thrown.
        </p></dd><dt><span class="term">
        <code class="literal">defaultText</code>
      </span></dt><dd><p>
          A textual representation of the default value to be rendered
          verbatim in the manual. Useful if the default value is a
          complex expression or depends on other values or packages. Use
          <code class="literal">lib.literalExpression</code> for a Nix expression,
          <code class="literal">lib.literalDocBook</code> for a plain English
          description in DocBook format.
        </p></dd><dt><span class="term">
        <code class="literal">example</code>
      </span></dt><dd><p>
          An example value that will be shown in the NixOS manual. You
          can use <code class="literal">lib.literalExpression</code> and
          <code class="literal">lib.literalDocBook</code> in the same way as in
          <code class="literal">defaultText</code>.
        </p></dd><dt><span class="term">
        <code class="literal">description</code>
      </span></dt><dd><p>
          A textual description of the option, in DocBook format, that
          will be included in the NixOS manual.
        </p></dd></dl></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-option-declarations-util"></a>65.1.1. Utility functions for common option patterns</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sec-option-declarations-util-mkEnableOption"></a>65.1.1.1. <code class="literal">mkEnableOption</code></h4></div></div></div><p>
        Creates an Option attribute set for a boolean value option i.e
        an option to be toggled on or off.
      </p><p>
        This function takes a single string argument, the name of the
        thing to be toggled.
      </p><p>
        The option’s description is <span class="quote">“<span class="quote">Whether to enable
        &lt;name&gt;.</span>”</span>.
      </p><p>
        For example:
      </p><a id="ex-options-declarations-util-mkEnableOption-magic"></a><pre class="programlisting">
lib.mkEnableOption "magic"
# is like
lib.mkOption {
  type = lib.types.bool;
  default = false;
  example = true;
  description = "Whether to enable magic.";
}
</pre><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="sec-option-declarations-util-mkPackageOption"></a>65.1.1.1.1. <code class="literal">mkPackageOption</code></h5></div></div></div><p>
          Usage:
        </p><pre class="programlisting">
mkPackageOption pkgs "name" { default = [ "path" "in" "pkgs" ]; example = "literal example"; }
</pre><p>
          Creates an Option attribute set for an option that specifies
          the package a module should use for some purpose.
        </p><p>
          <span class="strong"><strong>Note</strong></span>: You shouldn’t
          necessarily make package options for all of your modules. You
          can always overwrite a specific package throughout nixpkgs by
          using
          <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#chap-overlays" target="_top">nixpkgs
          overlays</a>.
        </p><p>
          The default package is specified as a list of strings
          representing its attribute path in nixpkgs. Because of this,
          you need to pass nixpkgs itself as the first argument.
        </p><p>
          The second argument is the name of the option, used in the
          description <span class="quote">“<span class="quote">The &lt;name&gt; package to use.</span>”</span>.
          You can also pass an example value, either a literal string or
          a package’s attribute path.
        </p><p>
          You can omit the default path if the name of the option is
          also attribute path in nixpkgs.
        </p><a id="ex-options-declarations-util-mkPackageOption"></a><p>
          Examples:
        </p><a id="ex-options-declarations-util-mkPackageOption-hello"></a><pre class="programlisting">
lib.mkPackageOption pkgs "hello" { }
# is like
lib.mkOption {
  type = lib.types.package;
  default = pkgs.hello;
  defaultText = lib.literalExpression "pkgs.hello";
  description = "The hello package to use.";
}
</pre><a id="ex-options-declarations-util-mkPackageOption-ghc"></a><pre class="programlisting">
lib.mkPackageOption pkgs "GHC" {
  default = [ "ghc" ];
  example = "pkgs.haskell.package.ghc922.ghc.withPackages (hkgs: [ hkgs.primes ])";
}
# is like
lib.mkOption {
  type = lib.types.package;
  default = pkgs.ghc;
  defaultText = lib.literalExpression "pkgs.ghc";
  example = lib.literalExpression "pkgs.haskell.package.ghc922.ghc.withPackages (hkgs: [ hkgs.primes ])";
  description = "The GHC package to use.";
}
</pre><div class="section"><div class="titlepage"><div><div><h6 class="title"><a id="sec-option-declarations-eot"></a>65.1.1.1.1.1. Extensible Option Types</h6></div></div></div><p>
            Extensible option types is a feature that allow to extend
            certain types declaration through multiple module files.
            This feature only work with a restricted set of types,
            namely <code class="literal">enum</code> and
            <code class="literal">submodules</code> and any composed forms of
            them.
          </p><p>
            Extensible option types can be used for
            <code class="literal">enum</code> options that affects multiple
            modules, or as an alternative to related
            <code class="literal">enable</code> options.
          </p><p>
            As an example, we will take the case of display managers.
            There is a central display manager module for generic
            display manager options and a module file per display
            manager backend (sddm, gdm ...).
          </p><p>
            There are two approaches we could take with this module
            structure:
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                Configuring the display managers independently by adding
                an enable option to every display manager module
                backend. (NixOS)
              </p></li><li class="listitem"><p>
                Configuring the display managers in the central module
                by adding an option to select which display manager
                backend to use.
              </p></li></ul></div><p>
            Both approaches have problems.
          </p><p>
            Making backends independent can quickly become hard to
            manage. For display managers, there can only be one enabled
            at a time, but the type system cannot enforce this
            restriction as there is no relation between each backend’s
            <code class="literal">enable</code> option. As a result, this
            restriction has to be done explicitly by adding assertions
            in each display manager backend module.
          </p><p>
            On the other hand, managing the display manager backends in
            the central module will require changing the central module
            option every time a new backend is added or removed.
          </p><p>
            By using extensible option types, it is possible to create a
            placeholder option in the central module
            (<a class="link" href="index.html#ex-option-declaration-eot-service">Example:
            Extensible type placeholder in the service module</a>),
            and to extend it in each backend module
            (<a class="link" href="index.html#ex-option-declaration-eot-backend-gdm">Example:
            Extending
            <code class="literal">services.xserver.displayManager.enable</code> in
            the <code class="literal">gdm</code> module</a>,
            <a class="link" href="index.html#ex-option-declaration-eot-backend-sddm">Example:
            Extending
            <code class="literal">services.xserver.displayManager.enable</code> in
            the <code class="literal">sddm</code> module</a>).
          </p><p>
            As a result, <code class="literal">displayManager.enable</code> option
            values can be added without changing the main service module
            file and the type system automatically enforces that there
            can only be a single display manager enabled.
          </p><a id="ex-option-declaration-eot-service"></a><p>
            <span class="strong"><strong>Example: Extensible type placeholder
            in the service module</strong></span>
          </p><pre class="programlisting">
services.xserver.displayManager.enable = mkOption {
  description = "Display manager to use";
  type = with types; nullOr (enum [ ]);
};
</pre><a id="ex-option-declaration-eot-backend-gdm"></a><p>
            <span class="strong"><strong>Example: Extending
            <code class="literal">services.xserver.displayManager.enable</code> in
            the <code class="literal">gdm</code> module</strong></span>
          </p><pre class="programlisting">
services.xserver.displayManager.enable = mkOption {
  type = with types; nullOr (enum [ "gdm" ]);
};
</pre><a id="ex-option-declaration-eot-backend-sddm"></a><p>
            <span class="strong"><strong>Example: Extending
            <code class="literal">services.xserver.displayManager.enable</code> in
            the <code class="literal">sddm</code> module</strong></span>
          </p><pre class="programlisting">
services.xserver.displayManager.enable = mkOption {
  type = with types; nullOr (enum [ "sddm" ]);
};
</pre><p>
            The placeholder declaration is a standard
            <code class="literal">mkOption</code> declaration, but it is important
            that extensible option declarations only use the
            <code class="literal">type</code> argument.
          </p><p>
            Extensible option types work with any of the composed
            variants of <code class="literal">enum</code> such as
            <code class="literal">with types; nullOr (enum [ "foo" "bar" ])</code>
            or
            <code class="literal">with types; listOf (enum [ "foo" "bar" ])</code>.
          </p></div></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-option-types"></a>65.2. Options Types</h2></div></div></div><p>
    Option types are a way to put constraints on the values a module
    option can take. Types are also responsible of how values are merged
    in case of multiple value definitions.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-option-types-basic"></a>65.2.1. Basic Types</h3></div></div></div><p>
      Basic types are the simplest available types in the module system.
      Basic types include multiple string types that mainly differ in
      how definition merging is handled.
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="literal">types.bool</code>
        </span></dt><dd><p>
            A boolean, its values can be <code class="literal">true</code> or
            <code class="literal">false</code>.
          </p></dd><dt><span class="term">
          <code class="literal">types.path</code>
        </span></dt><dd><p>
            A filesystem path is anything that starts with a slash when
            coerced to a string. Even if derivations can be considered
            as paths, the more specific <code class="literal">types.package</code>
            should be preferred.
          </p></dd><dt><span class="term">
          <code class="literal">types.package</code>
        </span></dt><dd><p>
            A top-level store path. This can be an attribute set
            pointing to a store path, like a derivation or a flake
            input.
          </p></dd><dt><span class="term">
          <code class="literal">types.anything</code>
        </span></dt><dd><p>
            A type that accepts any value and recursively merges
            attribute sets together. This type is recommended when the
            option type is unknown.
          </p><a id="ex-types-anything"></a><p>
            <span class="strong"><strong>Example:
            <code class="literal">types.anything</code> Example</strong></span>
          </p><p>
            Two definitions of this type like
          </p><pre class="programlisting">
{
  str = lib.mkDefault "foo";
  pkg.hello = pkgs.hello;
  fun.fun = x: x + 1;
}
</pre><pre class="programlisting">
{
  str = lib.mkIf true "bar";
  pkg.gcc = pkgs.gcc;
  fun.fun = lib.mkForce (x: x + 2);
}
</pre><p>
            will get merged to
          </p><pre class="programlisting">
{
  str = "bar";
  pkg.gcc = pkgs.gcc;
  pkg.hello = pkgs.hello;
  fun.fun = x: x + 2;
}
</pre></dd><dt><span class="term">
          <code class="literal">types.raw</code>
        </span></dt><dd><p>
            A type which doesn’t do any checking, merging or nested
            evaluation. It accepts a single arbitrary value that is not
            recursed into, making it useful for values coming from
            outside the module system, such as package sets or arbitrary
            data. Options of this type are still evaluated according to
            priorities and conditionals, so <code class="literal">mkForce</code>,
            <code class="literal">mkIf</code> and co. still work on the option
            value itself, but not for any value nested within it. This
            type should only be used when checking, merging and nested
            evaluation are not desirable.
          </p></dd><dt><span class="term">
          <code class="literal">types.optionType</code>
        </span></dt><dd><p>
            The type of an option’s type. Its merging operation ensures
            that nested options have the correct file location
            annotated, and that if possible, multiple option definitions
            are correctly merged together. The main use case is as the
            type of the <code class="literal">_module.freeformType</code> option.
          </p></dd><dt><span class="term">
          <code class="literal">types.attrs</code>
        </span></dt><dd><p>
            A free-form attribute set.
          </p><div class="warning"><h3 class="title">Warning</h3><p>
              This type will be deprecated in the future because it
              doesn't recurse into attribute sets, silently drops
              earlier attribute definitions, and doesn't discharge
              <code class="literal">lib.mkDefault</code>,
              <code class="literal">lib.mkIf</code> and co. For allowing arbitrary
              attribute sets, prefer
              <code class="literal">types.attrsOf types.anything</code> instead
              which doesn't have these problems.
            </p></div></dd></dl></div><p>
      Integer-related types:
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="literal">types.int</code>
        </span></dt><dd><p>
            A signed integer.
          </p></dd><dt><span class="term">
          <code class="literal">types.ints.{s8, s16, s32}</code>
        </span></dt><dd><p>
            Signed integers with a fixed length (8, 16 or 32 bits). They
            go from −2^n/2 to 2^n/2−1 respectively (e.g.
            <code class="literal">−128</code> to <code class="literal">127</code> for 8
            bits).
          </p></dd><dt><span class="term">
          <code class="literal">types.ints.unsigned</code>
        </span></dt><dd><p>
            An unsigned integer (that is &gt;= 0).
          </p></dd><dt><span class="term">
          <code class="literal">types.ints.{u8, u16, u32}</code>
        </span></dt><dd><p>
            Unsigned integers with a fixed length (8, 16 or 32 bits).
            They go from 0 to 2^n−1 respectively (e.g.
            <code class="literal">0</code> to <code class="literal">255</code> for 8 bits).
          </p></dd><dt><span class="term">
          <code class="literal">types.ints.positive</code>
        </span></dt><dd><p>
            A positive integer (that is &gt; 0).
          </p></dd><dt><span class="term">
          <code class="literal">types.port</code>
        </span></dt><dd><p>
            A port number. This type is an alias to
            <code class="literal">types.ints.u16</code>.
          </p></dd></dl></div><p>
      String-related types:
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="literal">types.str</code>
        </span></dt><dd><p>
            A string. Multiple definitions cannot be merged.
          </p></dd><dt><span class="term">
          <code class="literal">types.lines</code>
        </span></dt><dd><p>
            A string. Multiple definitions are concatenated with a new
            line <code class="literal">"\n"</code>.
          </p></dd><dt><span class="term">
          <code class="literal">types.commas</code>
        </span></dt><dd><p>
            A string. Multiple definitions are concatenated with a comma
            <code class="literal">","</code>.
          </p></dd><dt><span class="term">
          <code class="literal">types.envVar</code>
        </span></dt><dd><p>
            A string. Multiple definitions are concatenated with a
            collon <code class="literal">":"</code>.
          </p></dd><dt><span class="term">
          <code class="literal">types.strMatching</code>
        </span></dt><dd><p>
            A string matching a specific regular expression. Multiple
            definitions cannot be merged. The regular expression is
            processed using <code class="literal">builtins.match</code>.
          </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-option-types-value"></a>65.2.2. Value Types</h3></div></div></div><p>
      Value types are types that take a value parameter.
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="literal">types.enum</code>
          <span class="emphasis"><em><code class="literal">l</code></em></span>
        </span></dt><dd><p>
            One element of the list
            <span class="emphasis"><em><code class="literal">l</code></em></span>, e.g.
            <code class="literal">types.enum [ "left" "right" ]</code>.
            Multiple definitions cannot be merged.
          </p></dd><dt><span class="term">
          <code class="literal">types.separatedString</code>
          <span class="emphasis"><em><code class="literal">sep</code></em></span>
        </span></dt><dd><p>
            A string with a custom separator
            <span class="emphasis"><em><code class="literal">sep</code></em></span>, e.g.
            <code class="literal">types.separatedString "|"</code>.
          </p></dd><dt><span class="term">
          <code class="literal">types.ints.between</code>
          <span class="emphasis"><em><code class="literal">lowest highest</code></em></span>
        </span></dt><dd><p>
            An integer between
            <span class="emphasis"><em><code class="literal">lowest</code></em></span> and
            <span class="emphasis"><em><code class="literal">highest</code></em></span> (both
            inclusive). Useful for creating types like
            <code class="literal">types.port</code>.
          </p></dd><dt><span class="term">
          <code class="literal">types.submodule</code>
          <span class="emphasis"><em><code class="literal">o</code></em></span>
        </span></dt><dd><p>
            A set of sub options
            <span class="emphasis"><em><code class="literal">o</code></em></span>.
            <span class="emphasis"><em><code class="literal">o</code></em></span> can be an
            attribute set, a function returning an attribute set, or a
            path to a file containing such a value. Submodules are used
            in composed types to create modular options. This is
            equivalent to
            <code class="literal">types.submoduleWith { modules = toList o; shorthandOnlyDefinesConfig = true; }</code>.
            Submodules are detailed in
            <a class="link" href="index.html#section-option-types-submodule" title="65.2.4. Submodule">Submodule</a>.
          </p></dd><dt><span class="term">
          <code class="literal">types.submoduleWith</code> {
          <span class="emphasis"><em><code class="literal">modules</code></em></span>,
          <span class="emphasis"><em><code class="literal">specialArgs</code></em></span> ? {},
          <span class="emphasis"><em><code class="literal">shorthandOnlyDefinesConfig</code></em></span>
          ? false }
        </span></dt><dd><p>
            Like <code class="literal">types.submodule</code>, but more flexible
            and with better defaults. It has parameters
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                <span class="emphasis"><em><code class="literal">modules</code></em></span> A list
                of modules to use by default for this submodule type.
                This gets combined with all option definitions to build
                the final list of modules that will be included.
              </p><div class="note"><h3 class="title">Note</h3><p>
                  Only options defined with this argument are included
                  in rendered documentation.
                </p></div></li><li class="listitem"><p>
                <span class="emphasis"><em><code class="literal">specialArgs</code></em></span> An
                attribute set of extra arguments to be passed to the
                module functions. The option
                <code class="literal">_module.args</code> should be used instead
                for most arguments since it allows overriding.
                <span class="emphasis"><em><code class="literal">specialArgs</code></em></span>
                should only be used for arguments that can't go through
                the module fixed-point, because of infinite recursion or
                other problems. An example is overriding the
                <code class="literal">lib</code> argument, because
                <code class="literal">lib</code> itself is used to define
                <code class="literal">_module.args</code>, which makes using
                <code class="literal">_module.args</code> to define it impossible.
              </p></li><li class="listitem"><p>
                <span class="emphasis"><em><code class="literal">shorthandOnlyDefinesConfig</code></em></span>
                Whether definitions of this type should default to the
                <code class="literal">config</code> section of a module (see
                <a class="link" href="index.html#ex-module-syntax">Example: Structure of
                NixOS Modules</a>) if it is an attribute set.
                Enabling this only has a benefit when the submodule
                defines an option named <code class="literal">config</code> or
                <code class="literal">options</code>. In such a case it would
                allow the option to be set with
                <code class="literal">the-submodule.config = "value"</code>
                instead of requiring
                <code class="literal">the-submodule.config.config = "value"</code>.
                This is because only when modules
                <span class="emphasis"><em>don't</em></span> set the
                <code class="literal">config</code> or <code class="literal">options</code>
                keys, all keys are interpreted as option definitions in
                the <code class="literal">config</code> section. Enabling this
                option implicitly puts all attributes in the
                <code class="literal">config</code> section.
              </p><p>
                With this option enabled, defining a
                non-<code class="literal">config</code> section requires using a
                function:
                <code class="literal">the-submodule = { ... }: { options = { ... }; }</code>.
              </p></li></ul></div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-option-types-composed"></a>65.2.3. Composed Types</h3></div></div></div><p>
      Composed types are types that take a type as parameter.
      <code class="literal">listOf int</code> and
      <code class="literal">either int str</code> are examples of composed types.
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="literal">types.listOf</code>
          <span class="emphasis"><em><code class="literal">t</code></em></span>
        </span></dt><dd><p>
            A list of <span class="emphasis"><em><code class="literal">t</code></em></span> type,
            e.g. <code class="literal">types.listOf int</code>. Multiple
            definitions are merged with list concatenation.
          </p></dd><dt><span class="term">
          <code class="literal">types.attrsOf</code>
          <span class="emphasis"><em><code class="literal">t</code></em></span>
        </span></dt><dd><p>
            An attribute set of where all the values are of
            <span class="emphasis"><em><code class="literal">t</code></em></span> type. Multiple
            definitions result in the joined attribute set.
          </p><div class="note"><h3 class="title">Note</h3><p>
              This type is <span class="emphasis"><em>strict</em></span> in its values,
              which in turn means attributes cannot depend on other
              attributes. See <code class="literal"> types.lazyAttrsOf</code> for
              a lazy version.
            </p></div></dd><dt><span class="term">
          <code class="literal">types.lazyAttrsOf</code>
          <span class="emphasis"><em><code class="literal">t</code></em></span>
        </span></dt><dd><p>
            An attribute set of where all the values are of
            <span class="emphasis"><em><code class="literal">t</code></em></span> type. Multiple
            definitions result in the joined attribute set. This is the
            lazy version of <code class="literal">types.attrsOf </code>, allowing
            attributes to depend on each other.
          </p><div class="warning"><h3 class="title">Warning</h3><p>
              This version does not fully support conditional
              definitions! With an option <code class="literal">foo</code> of this
              type and a definition
              <code class="literal">foo.attr = lib.mkIf false 10</code>,
              evaluating <code class="literal">foo ? attr</code> will return
              <code class="literal">true</code> even though it should be false.
              Accessing the value will then throw an error. For types
              <span class="emphasis"><em><code class="literal">t</code></em></span> that have an
              <code class="literal">emptyValue</code> defined, that value will be
              returned instead of throwing an error. So if the type of
              <code class="literal">foo.attr</code> was
              <code class="literal">lazyAttrsOf (nullOr int)</code>,
              <code class="literal">null</code> would be returned instead for the
              same <code class="literal">mkIf false</code> definition.
            </p></div></dd><dt><span class="term">
          <code class="literal">types.nullOr</code>
          <span class="emphasis"><em><code class="literal">t</code></em></span>
        </span></dt><dd><p>
            <code class="literal">null</code> or type
            <span class="emphasis"><em><code class="literal">t</code></em></span>. Multiple
            definitions are merged according to type
            <span class="emphasis"><em><code class="literal">t</code></em></span>.
          </p></dd><dt><span class="term">
          <code class="literal">types.uniq</code>
          <span class="emphasis"><em><code class="literal">t</code></em></span>
        </span></dt><dd><p>
            Ensures that type <span class="emphasis"><em><code class="literal">t</code></em></span>
            cannot be merged. It is used to ensure option definitions
            are declared only once.
          </p></dd><dt><span class="term">
          <code class="literal">types.unique</code>
          <code class="literal">{ message = m }</code>
          <span class="emphasis"><em><code class="literal">t</code></em></span>
        </span></dt><dd><p>
            Ensures that type <span class="emphasis"><em><code class="literal">t</code></em></span>
            cannot be merged. Prints the message
            <span class="emphasis"><em><code class="literal">m</code></em></span>, after the line
            <code class="literal">The option &lt;option path&gt; is defined multiple times.</code>
            and before a list of definition locations.
          </p></dd><dt><span class="term">
          <code class="literal">types.either</code>
          <span class="emphasis"><em><code class="literal">t1 t2</code></em></span>
        </span></dt><dd><p>
            Type <span class="emphasis"><em><code class="literal">t1</code></em></span> or type
            <span class="emphasis"><em><code class="literal">t2</code></em></span>, e.g.
            <code class="literal">with types; either int str</code>. Multiple
            definitions cannot be merged.
          </p></dd><dt><span class="term">
          <code class="literal">types.oneOf</code> [
          <span class="emphasis"><em><code class="literal">t1 t2</code></em></span> ... ]
        </span></dt><dd><p>
            Type <span class="emphasis"><em><code class="literal">t1</code></em></span> or type
            <span class="emphasis"><em><code class="literal">t2</code></em></span> and so forth,
            e.g. <code class="literal">with types; oneOf [ int str bool ]</code>.
            Multiple definitions cannot be merged.
          </p></dd><dt><span class="term">
          <code class="literal">types.coercedTo</code>
          <span class="emphasis"><em><code class="literal">from f to</code></em></span>
        </span></dt><dd><p>
            Type <span class="emphasis"><em><code class="literal">to</code></em></span> or type
            <span class="emphasis"><em><code class="literal">from</code></em></span> which will be
            coerced to type <span class="emphasis"><em><code class="literal">to</code></em></span>
            using function <span class="emphasis"><em><code class="literal">f</code></em></span>
            which takes an argument of type
            <span class="emphasis"><em><code class="literal">from</code></em></span> and return a
            value of type <span class="emphasis"><em><code class="literal">to</code></em></span>.
            Can be used to preserve backwards compatibility of an option
            if its type was changed.
          </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="section-option-types-submodule"></a>65.2.4. Submodule</h3></div></div></div><p>
      <code class="literal">submodule</code> is a very powerful type that defines
      a set of sub-options that are handled like a separate module.
    </p><p>
      It takes a parameter <span class="emphasis"><em><code class="literal">o</code></em></span>,
      that should be a set, or a function returning a set with an
      <code class="literal">options</code> key defining the sub-options. Submodule
      option definitions are type-checked accordingly to the
      <code class="literal">options</code> declarations. Of course, you can nest
      submodule option definitons for even higher modularity.
    </p><p>
      The option set can be defined directly
      (<a class="link" href="index.html#ex-submodule-direct">Example: Directly defined
      submodule</a>) or as reference
      (<a class="link" href="index.html#ex-submodule-reference">Example: Submodule defined
      as a reference</a>).
    </p><a id="ex-submodule-direct"></a><p>
      <span class="strong"><strong>Example: Directly defined
      submodule</strong></span>
    </p><pre class="programlisting">
options.mod = mkOption {
  description = "submodule example";
  type = with types; submodule {
    options = {
      foo = mkOption {
        type = int;
      };
      bar = mkOption {
        type = str;
      };
    };
  };
};
</pre><a id="ex-submodule-reference"></a><p>
      <span class="strong"><strong>Example: Submodule defined as a
      reference</strong></span>
    </p><pre class="programlisting">
let
  modOptions = {
    options = {
      foo = mkOption {
        type = int;
      };
      bar = mkOption {
        type = int;
      };
    };
  };
in
options.mod = mkOption {
  description = "submodule example";
  type = with types; submodule modOptions;
};
</pre><p>
      The <code class="literal">submodule</code> type is especially interesting
      when used with composed types like <code class="literal">attrsOf</code> or
      <code class="literal">listOf</code>. When composed with
      <code class="literal">listOf</code>
      (<a class="link" href="index.html#ex-submodule-listof-declaration">Example:
      Declaration of a list of submodules</a>),
      <code class="literal">submodule</code> allows multiple definitions of the
      submodule option set
      (<a class="link" href="index.html#ex-submodule-listof-definition">Example:
      Definition of a list of submodules</a>).
    </p><a id="ex-submodule-listof-declaration"></a><p>
      <span class="strong"><strong>Example: Declaration of a list of
      submodules</strong></span>
    </p><pre class="programlisting">
options.mod = mkOption {
  description = "submodule example";
  type = with types; listOf (submodule {
    options = {
      foo = mkOption {
        type = int;
      };
      bar = mkOption {
        type = str;
      };
    };
  });
};
</pre><a id="ex-submodule-listof-definition"></a><p>
      <span class="strong"><strong>Example: Definition of a list of
      submodules</strong></span>
    </p><pre class="programlisting">
config.mod = [
  { foo = 1; bar = "one"; }
  { foo = 2; bar = "two"; }
];
</pre><p>
      When composed with <code class="literal">attrsOf</code>
      (<a class="link" href="index.html#ex-submodule-attrsof-declaration">Example:
      Declaration of attribute sets of submodules</a>),
      <code class="literal">submodule</code> allows multiple named definitions of
      the submodule option set
      (<a class="link" href="index.html#ex-submodule-attrsof-definition">Example:
      Definition of attribute sets of submodules</a>).
    </p><a id="ex-submodule-attrsof-declaration"></a><p>
      <span class="strong"><strong>Example: Declaration of attribute sets of
      submodules</strong></span>
    </p><pre class="programlisting">
options.mod = mkOption {
  description = "submodule example";
  type = with types; attrsOf (submodule {
    options = {
      foo = mkOption {
        type = int;
      };
      bar = mkOption {
        type = str;
      };
    };
  });
};
</pre><a id="ex-submodule-attrsof-definition"></a><p>
      <span class="strong"><strong>Example: Definition of attribute sets of
      submodules</strong></span>
    </p><pre class="programlisting">
config.mod.one = { foo = 1; bar = "one"; };
config.mod.two = { foo = 2; bar = "two"; };
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-option-types-extending"></a>65.2.5. Extending types</h3></div></div></div><p>
      Types are mainly characterized by their <code class="literal">check</code>
      and <code class="literal">merge</code> functions.
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="literal">check</code>
        </span></dt><dd><p>
            The function to type check the value. Takes a value as
            parameter and return a boolean. It is possible to extend a
            type check with the <code class="literal">addCheck</code> function
            (<a class="link" href="index.html#ex-extending-type-check-1">Example: Adding a
            type check</a>), or to fully override the check function
            (<a class="link" href="index.html#ex-extending-type-check-2">Example:
            Overriding a type check</a>).
          </p><a id="ex-extending-type-check-1"></a><p>
            <span class="strong"><strong>Example: Adding a type
            check</strong></span>
          </p><pre class="programlisting">
byte = mkOption {
  description = "An integer between 0 and 255.";
  type = types.addCheck types.int (x: x &gt;= 0 &amp;&amp; x &lt;= 255);
};
</pre><a id="ex-extending-type-check-2"></a><p>
            <span class="strong"><strong>Example: Overriding a type
            check</strong></span>
          </p><pre class="programlisting">
nixThings = mkOption {
  description = "words that start with 'nix'";
  type = types.str // {
    check = (x: lib.hasPrefix "nix" x)
  };
};
</pre></dd><dt><span class="term">
          <code class="literal">merge</code>
        </span></dt><dd><p>
            Function to merge the options values when multiple values
            are set. The function takes two parameters,
            <code class="literal">loc</code> the option path as a list of strings,
            and <code class="literal">defs</code> the list of defined values as a
            list. It is possible to override a type merge function for
            custom needs.
          </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-option-types-custom"></a>65.2.6. Custom Types</h3></div></div></div><p>
      Custom types can be created with the
      <code class="literal">mkOptionType</code> function. As type creation
      includes some more complex topics such as submodule handling, it
      is recommended to get familiar with <code class="literal">types.nix</code>
      code before creating a new type.
    </p><p>
      The only required parameter is <code class="literal">name</code>.
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="literal">name</code>
        </span></dt><dd><p>
            A string representation of the type function name.
          </p></dd><dt><span class="term">
          <code class="literal">definition</code>
        </span></dt><dd><p>
            Description of the type used in documentation. Give
            information of the type and any of its arguments.
          </p></dd><dt><span class="term">
          <code class="literal">check</code>
        </span></dt><dd><p>
            A function to type check the definition value. Takes the
            definition value as a parameter and returns a boolean
            indicating the type check result, <code class="literal">true</code>
            for success and <code class="literal">false</code> for failure.
          </p></dd><dt><span class="term">
          <code class="literal">merge</code>
        </span></dt><dd><p>
            A function to merge multiple definitions values. Takes two
            parameters:
          </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
                <span class="emphasis"><em><code class="literal">loc</code></em></span>
              </span></dt><dd><p>
                  The option path as a list of strings, e.g.
                  <code class="literal">["boot" "loader "grub" "enable"]</code>.
                </p></dd><dt><span class="term">
                <span class="emphasis"><em><code class="literal">defs</code></em></span>
              </span></dt><dd><p>
                  The list of sets of defined <code class="literal">value</code>
                  and <code class="literal">file</code> where the value was
                  defined, e.g.
                  <code class="literal">[ { file = "/foo.nix"; value = 1; } { file = "/bar.nix"; value = 2 } ]</code>.
                  The <code class="literal">merge</code> function should return
                  the merged value or throw an error in case the values
                  are impossible or not meant to be merged.
                </p></dd></dl></div></dd><dt><span class="term">
          <code class="literal">getSubOptions</code>
        </span></dt><dd><p>
            For composed types that can take a submodule as type
            parameter, this function generate sub-options documentation.
            It takes the current option prefix as a list and return the
            set of sub-options. Usually defined in a recursive manner by
            adding a term to the prefix, e.g.
            <code class="literal">prefix: elemType.getSubOptions (prefix ++ ["prefix"])</code>
            where
            <span class="emphasis"><em><code class="literal">"prefix"</code></em></span>
            is the newly added prefix.
          </p></dd><dt><span class="term">
          <code class="literal">getSubModules</code>
        </span></dt><dd><p>
            For composed types that can take a submodule as type
            parameter, this function should return the type parameters
            submodules. If the type parameter is called
            <code class="literal">elemType</code>, the function should just
            recursively look into submodules by returning
            <code class="literal">elemType.getSubModules;</code>.
          </p></dd><dt><span class="term">
          <code class="literal">substSubModules</code>
        </span></dt><dd><p>
            For composed types that can take a submodule as type
            parameter, this function can be used to substitute the
            parameter of a submodule type. It takes a module as
            parameter and return the type with the submodule options
            substituted. It is usually defined as a type function call
            with a recursive call to <code class="literal">substSubModules</code>,
            e.g for a type <code class="literal">composedType</code> that take an
            <code class="literal">elemtype</code> type parameter, this function
            should be defined as
            <code class="literal">m: composedType (elemType.substSubModules m)</code>.
          </p></dd><dt><span class="term">
          <code class="literal">typeMerge</code>
        </span></dt><dd><p>
            A function to merge multiple type declarations. Takes the
            type to merge <code class="literal">functor</code> as parameter. A
            <code class="literal">null</code> return value means that type cannot
            be merged.
          </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
                <span class="emphasis"><em><code class="literal">f</code></em></span>
              </span></dt><dd><p>
                  The type to merge <code class="literal">functor</code>.
                </p></dd></dl></div><p>
            Note: There is a generic <code class="literal">defaultTypeMerge</code>
            that work with most of value and composed types.
          </p></dd><dt><span class="term">
          <code class="literal">functor</code>
        </span></dt><dd><p>
            An attribute set representing the type. It is used for type
            operations and has the following keys:
          </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
                <code class="literal">type</code>
              </span></dt><dd><p>
                  The type function.
                </p></dd><dt><span class="term">
                <code class="literal">wrapped</code>
              </span></dt><dd><p>
                  Holds the type parameter for composed types.
                </p></dd><dt><span class="term">
                <code class="literal">payload</code>
              </span></dt><dd><p>
                  Holds the value parameter for value types. The types
                  that have a <code class="literal">payload</code> are the
                  <code class="literal">enum</code>,
                  <code class="literal">separatedString</code> and
                  <code class="literal">submodule</code> types.
                </p></dd><dt><span class="term">
                <code class="literal">binOp</code>
              </span></dt><dd><p>
                  A binary operation that can merge the payloads of two
                  same types. Defined as a function that take two
                  payloads as parameters and return the payloads merged.
                </p></dd></dl></div></dd></dl></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-option-definitions"></a>65.3. Option Definitions</h2></div></div></div><p>
    Option definitions are generally straight-forward bindings of values
    to option names, like
  </p><pre class="programlisting">
config = {
  services.httpd.enable = true;
};
</pre><p>
    However, sometimes you need to wrap an option definition or set of
    option definitions in a <span class="emphasis"><em>property</em></span> to achieve
    certain effects:
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-option-definitions-delaying-conditionals"></a>65.3.1. Delaying Conditionals</h3></div></div></div><p>
      If a set of option definitions is conditional on the value of
      another option, you may need to use <code class="literal">mkIf</code>.
      Consider, for instance:
    </p><pre class="programlisting">
config = if config.services.httpd.enable then {
  environment.systemPackages = [ ... ];
  ...
} else {};
</pre><p>
      This definition will cause Nix to fail with an <span class="quote">“<span class="quote">infinite
      recursion</span>”</span> error. Why? Because the value of
      <code class="literal">config.services.httpd.enable</code> depends on the
      value being constructed here. After all, you could also write the
      clearly circular and contradictory:
    </p><pre class="programlisting">
config = if config.services.httpd.enable then {
  services.httpd.enable = false;
} else {
  services.httpd.enable = true;
};
</pre><p>
      The solution is to write:
    </p><pre class="programlisting">
config = mkIf config.services.httpd.enable {
  environment.systemPackages = [ ... ];
  ...
};
</pre><p>
      The special function <code class="literal">mkIf</code> causes the evaluation
      of the conditional to be <span class="quote">“<span class="quote">pushed down</span>”</span> into the
      individual definitions, as if you had written:
    </p><pre class="programlisting">
config = {
  environment.systemPackages = if config.services.httpd.enable then [ ... ] else [];
  ...
};
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-option-definitions-setting-priorities"></a>65.3.2. Setting Priorities</h3></div></div></div><p>
      A module can override the definitions of an option in other
      modules by setting a <span class="emphasis"><em>priority</em></span>. All option
      definitions that do not have the lowest priority value are
      discarded. By default, option definitions have priority 1000. You
      can specify an explicit priority by using
      <code class="literal">mkOverride</code>, e.g.
    </p><pre class="programlisting">
services.openssh.enable = mkOverride 10 false;
</pre><p>
      This definition causes all other definitions with priorities above
      10 to be discarded. The function <code class="literal">mkForce</code> is
      equal to <code class="literal">mkOverride 50</code>.
    </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-option-definitions-merging"></a>65.3.3. Merging Configurations</h3></div></div></div><p>
      In conjunction with <code class="literal">mkIf</code>, it is sometimes
      useful for a module to return multiple sets of option definitions,
      to be merged together as if they were declared in separate
      modules. This can be done using <code class="literal">mkMerge</code>:
    </p><pre class="programlisting">
config = mkMerge
  [ # Unconditional stuff.
    { environment.systemPackages = [ ... ];
    }
    # Conditional stuff.
    (mkIf config.services.bla.enable {
      environment.systemPackages = [ ... ];
    })
  ];
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-assertions"></a>65.4. Warnings and Assertions</h2></div></div></div><p>
    When configuration problems are detectable in a module, it is a good
    idea to write an assertion or warning. Doing so provides clear
    feedback to the user and prevents errors after the build.
  </p><p>
    Although Nix has the <code class="literal">abort</code> and
    <code class="literal">builtins.trace</code>
    <a class="link" href="https://nixos.org/nix/manual/#ssec-builtins" target="_top">functions</a>
    to perform such tasks, they are not ideally suited for NixOS
    modules. Instead of these functions, you can declare your warnings
    and assertions using the NixOS module system.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-assertions-warnings"></a>65.4.1. Warnings</h3></div></div></div><p>
      This is an example of using <code class="literal">warnings</code>.
    </p><pre class="programlisting">
{ config, lib, ... }:
{
  config = lib.mkIf config.services.foo.enable {
    warnings =
      if config.services.foo.bar
      then [ ''You have enabled the bar feature of the foo service.
               This is known to cause some specific problems in certain situations.
               '' ]
      else [];
  }
}
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-assertions-assetions"></a>65.4.2. Assertions</h3></div></div></div><p>
      This example, extracted from the
      <a class="link" href="https://github.com/NixOS/nixpkgs/blob/release-17.09/nixos/modules/services/logging/syslogd.nix" target="_top"><code class="literal">syslogd</code>
      module</a> shows how to use <code class="literal">assertions</code>.
      Since there can only be one active syslog daemon at a time, an
      assertion is useful to prevent such a broken system from being
      built.
    </p><pre class="programlisting">
{ config, lib, ... }:
{
  config = lib.mkIf config.services.syslogd.enable {
    assertions =
      [ { assertion = !config.services.rsyslogd.enable;
          message = "rsyslogd conflicts with syslogd";
        }
      ];
  }
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-meta-attributes"></a>65.5. Meta Attributes</h2></div></div></div><p>
    Like Nix packages, NixOS modules can declare meta-attributes to
    provide extra information. Module meta attributes are defined in the
    <code class="literal">meta.nix</code> special module.
  </p><p>
    <code class="literal">meta</code> is a top level attribute like
    <code class="literal">options</code> and <code class="literal">config</code>. Available
    meta-attributes are <code class="literal">maintainers</code>,
    <code class="literal">doc</code>, and <code class="literal">buildDocsInSandbox</code>.
  </p><p>
    Each of the meta-attributes must be defined at most once per module
    file.
  </p><pre class="programlisting">
{ config, lib, pkgs, ... }:
{
  options = {
    ...
  };

  config = {
    ...
  };

  meta = {
    maintainers = with lib.maintainers; [ ericsagnes ];
    doc = ./default.xml;
    buildDocsInSandbox = true;
  };
}
</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">maintainers</code> contains a list of the module
        maintainers.
      </p></li><li class="listitem"><p>
        <code class="literal">doc</code> points to a valid DocBook file containing
        the module documentation. Its contents is automatically added to
        <a class="xref" href="index.html#ch-configuration" title="Part II. Configuration">Part II, “Configuration”</a>. Changes to a module
        documentation have to be checked to not break building the NixOS
        manual:
      </p><pre class="programlisting">
$ nix-build nixos/release.nix -A manual.x86_64-linux
</pre></li><li class="listitem"><p>
        <code class="literal">buildDocsInSandbox</code> indicates whether the
        option documentation for the module can be built in a derivation
        sandbox. This option is currently only honored for modules
        shipped by nixpkgs. User modules and modules taken from
        <code class="literal">NIXOS_EXTRA_MODULE_PATH</code> are always built
        outside of the sandbox, as has been the case in previous
        releases.
      </p><p>
        Building NixOS option documentation in a sandbox allows caching
        of the built documentation, which greatly decreases the amount
        of time needed to evaluate a system configuration that has NixOS
        documentation enabled. The sandbox also restricts which
        attributes may be referenced by documentation attributes (such
        as option descriptions) to the <code class="literal">options</code> and
        <code class="literal">lib</code> module arguments and the
        <code class="literal">pkgs.formats</code> attribute of the
        <code class="literal">pkgs</code> argument, <code class="literal">config</code> and
        the rest of <code class="literal">pkgs</code> are disallowed and will
        cause doc build failures when used. This restriction is
        necessary because we cannot reproduce the full nixpkgs
        instantiation with configuration and overlays from a system
        configuration inside the sandbox. The <code class="literal">options</code>
        argument only includes options of modules that are also built
        inside the sandbox, referencing an option of a module that isn’t
        built in the sandbox is also forbidden.
      </p><p>
        The default is <code class="literal">true</code> and should usually not be
        changed; set it to <code class="literal">false</code> only if the module
        requires access to <code class="literal">pkgs</code> in its documentation
        (e.g. because it loads information from a linked package to
        build an option type) or if its documentation depends on other
        modules that also aren’t sandboxed (e.g. by using types defined
        in the other module).
      </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-importing-modules"></a>65.6. Importing Modules</h2></div></div></div><p>
    Sometimes NixOS modules need to be used in configuration but exist
    outside of Nixpkgs. These modules can be imported:
  </p><pre class="programlisting">
{ config, lib, pkgs, ... }:

{
  imports =
    [ # Use a locally-available module definition in
      # ./example-module/default.nix
        ./example-module
    ];

  services.exampleModule.enable = true;
}
</pre><p>
    The environment variable <code class="literal">NIXOS_EXTRA_MODULE_PATH</code>
    is an absolute path to a NixOS module that is included alongside the
    Nixpkgs NixOS modules. Like any NixOS module, this module can import
    additional modules:
  </p><pre class="programlisting">
# ./module-list/default.nix
[
  ./example-module1
  ./example-module2
]
</pre><pre class="programlisting">
# ./extra-module/default.nix
{ imports = import ./module-list.nix; }
</pre><pre class="programlisting">
# NIXOS_EXTRA_MODULE_PATH=/absolute/path/to/extra-module
{ config, lib, pkgs, ... }:

{
  # No `imports` needed

  services.exampleModule1.enable = true;
}
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-replace-modules"></a>65.7. Replace Modules</h2></div></div></div><p>
    Modules that are imported can also be disabled. The option
    declarations, config implementation and the imports of a disabled
    module will be ignored, allowing another to take it's place. This
    can be used to import a set of modules from another channel while
    keeping the rest of the system on a stable release.
  </p><p>
    <code class="literal">disabledModules</code> is a top level attribute like
    <code class="literal">imports</code>, <code class="literal">options</code> and
    <code class="literal">config</code>. It contains a list of modules that will
    be disabled. This can either be the full path to the module or a
    string with the filename relative to the modules path (eg.
    &lt;nixpkgs/nixos/modules&gt; for nixos).
  </p><p>
    This example will replace the existing postgresql module with the
    version defined in the nixos-unstable channel while keeping the rest
    of the modules and packages from the original nixos channel. This
    only overrides the module definition, this won't use postgresql from
    nixos-unstable unless explicitly configured to do so.
  </p><pre class="programlisting">
{ config, lib, pkgs, ... }:

{
  disabledModules = [ "services/databases/postgresql.nix" ];

  imports =
    [ # Use postgresql service from nixos-unstable channel.
      # sudo nix-channel --add https://nixos.org/channels/nixos-unstable nixos-unstable
      &lt;nixos-unstable/nixos/modules/services/databases/postgresql.nix&gt;
    ];

  services.postgresql.enable = true;
}
</pre><p>
    This example shows how to define a custom module as a replacement
    for an existing module. Importing this module will disable the
    original module without having to know it's implementation details.
  </p><pre class="programlisting">
{ config, lib, pkgs, ... }:

with lib;

let
  cfg = config.programs.man;
in

{
  disabledModules = [ "services/programs/man.nix" ];

  options = {
    programs.man.enable = mkOption {
      type = types.bool;
      default = true;
      description = "Whether to enable manual pages.";
    };
  };

  config = mkIf cfg.enabled {
    warnings = [ "disabled manpages for production deployments." ];
  };
}
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-freeform-modules"></a>65.8. Freeform modules</h2></div></div></div><p>
    Freeform modules allow you to define values for option paths that
    have not been declared explicitly. This can be used to add
    attribute-specific types to what would otherwise have to be
    <code class="literal">attrsOf</code> options in order to accept all attribute
    names.
  </p><p>
    This feature can be enabled by using the attribute
    <code class="literal">freeformType</code> to define a freeform type. By doing
    this, all assignments without an associated option will be merged
    using the freeform type and combined into the resulting
    <code class="literal">config</code> set. Since this feature nullifies name
    checking for entire option trees, it is only recommended for use in
    submodules.
  </p><a id="ex-freeform-module"></a><p>
    <span class="strong"><strong>Example: Freeform submodule</strong></span>
  </p><p>
    The following shows a submodule assigning a freeform type that
    allows arbitrary attributes with <code class="literal">str</code> values below
    <code class="literal">settings</code>, but also declares an option for the
    <code class="literal">settings.port</code> attribute to have it type-checked
    and assign a default value. See
    <a class="link" href="index.html#ex-settings-typed-attrs">Example: Declaring a
    type-checked <code class="literal">settings</code> attribute</a> for a more
    complete example.
  </p><pre class="programlisting">
{ lib, config, ... }: {

  options.settings = lib.mkOption {
    type = lib.types.submodule {

      freeformType = with lib.types; attrsOf str;

      # We want this attribute to be checked for the correct type
      options.port = lib.mkOption {
        type = lib.types.port;
        # Declaring the option also allows defining a default value
        default = 8080;
      };

    };
  };
}
</pre><p>
    And the following shows what such a module then allows
  </p><pre class="programlisting">
{
  # Not a declared option, but the freeform type allows this
  settings.logLevel = "debug";

  # Not allowed because the the freeform type only allows strings
  # settings.enable = true;

  # Allowed because there is a port option declared
  settings.port = 80;

  # Not allowed because the port option doesn't allow strings
  # settings.port = "443";
}
</pre><div class="note"><h3 class="title">Note</h3><p>
      Freeform attributes cannot depend on other attributes of the same
      set without infinite recursion:
    </p><pre class="programlisting">
{
  # This throws infinite recursion encountered
  settings.logLevel = lib.mkIf (config.settings.port == 80) "debug";
}
</pre><p>
      To prevent this, declare options for all attributes that need to
      depend on others. For above example this means to declare
      <code class="literal">logLevel</code> to be an option.
    </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-settings-options"></a>65.9. Options for Program Settings</h2></div></div></div><p>
    Many programs have configuration files where program-specific
    settings can be declared. File formats can be separated into two
    categories:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        Nix-representable ones: These can trivially be mapped to a
        subset of Nix syntax. E.g. JSON is an example, since its values
        like <code class="literal">{"foo":{"bar":10}}</code>
        can be mapped directly to Nix:
        <code class="literal">{ foo = { bar = 10; }; }</code>. Other examples are
        INI, YAML and TOML. The following section explains the
        convention for these settings.
      </p></li><li class="listitem"><p>
        Non-nix-representable ones: These can't be trivially mapped to a
        subset of Nix syntax. Most generic programming languages are in
        this group, e.g. bash, since the statement
        <code class="literal">if true; then echo hi; fi</code> doesn't have a
        trivial representation in Nix.
      </p><p>
        Currently there are no fixed conventions for these, but it is
        common to have a <code class="literal">configFile</code> option for
        setting the configuration file path directly. The default value
        of <code class="literal">configFile</code> can be an auto-generated file,
        with convenient options for controlling the contents. For
        example an option of type <code class="literal">attrsOf str</code> can be
        used for representing environment variables which generates a
        section like <code class="literal">export FOO="foo"</code>.
        Often it can also be useful to also include an
        <code class="literal">extraConfig</code> option of type
        <code class="literal">lines</code> to allow arbitrary text after the
        autogenerated part of the file.
      </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-settings-nix-representable"></a>65.9.1. Nix-representable Formats (JSON, YAML, TOML, INI,
    ...)</h3></div></div></div><p>
      By convention, formats like this are handled with a generic
      <code class="literal">settings</code> option, representing the full program
      configuration as a Nix value. The type of this option should
      represent the format. The most common formats have a predefined
      type and string generator already declared under
      <code class="literal">pkgs.formats</code>:
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="literal">pkgs.formats.json</code> { }
        </span></dt><dd><p>
            A function taking an empty attribute set (for future
            extensibility) and returning a set with JSON-specific
            attributes <code class="literal">type</code> and
            <code class="literal">generate</code> as specified
            <a class="link" href="index.html#pkgs-formats-result">below</a>.
          </p></dd><dt><span class="term">
          <code class="literal">pkgs.formats.yaml</code> { }
        </span></dt><dd><p>
            A function taking an empty attribute set (for future
            extensibility) and returning a set with YAML-specific
            attributes <code class="literal">type</code> and
            <code class="literal">generate</code> as specified
            <a class="link" href="index.html#pkgs-formats-result">below</a>.
          </p></dd><dt><span class="term">
          <code class="literal">pkgs.formats.ini</code> {
          <span class="emphasis"><em><code class="literal">listsAsDuplicateKeys</code></em></span> ?
          false, <span class="emphasis"><em><code class="literal">listToValue</code></em></span> ?
          null, ... }
        </span></dt><dd><p>
            A function taking an attribute set with values
          </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
                <code class="literal">listsAsDuplicateKeys</code>
              </span></dt><dd><p>
                  A boolean for controlling whether list values can be
                  used to represent duplicate INI keys
                </p></dd><dt><span class="term">
                <code class="literal">listToValue</code>
              </span></dt><dd><p>
                  A function for turning a list of values into a single
                  value.
                </p></dd></dl></div><p>
            It returns a set with INI-specific attributes
            <code class="literal">type</code> and <code class="literal">generate</code> as
            specified <a class="link" href="index.html#pkgs-formats-result">below</a>.
          </p></dd><dt><span class="term">
          <code class="literal">pkgs.formats.toml</code> { }
        </span></dt><dd><p>
            A function taking an empty attribute set (for future
            extensibility) and returning a set with TOML-specific
            attributes <code class="literal">type</code> and
            <code class="literal">generate</code> as specified
            <a class="link" href="index.html#pkgs-formats-result">below</a>.
          </p></dd><dt><span class="term">
          <code class="literal">pkgs.formats.elixirConf { elixir ? pkgs.elixir }</code>
        </span></dt><dd><p>
            A function taking an attribute set with values
          </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
                <code class="literal">elixir</code>
              </span></dt><dd><p>
                  The Elixir package which will be used to format the
                  generated output
                </p></dd></dl></div><p>
            It returns a set with Elixir-Config-specific attributes
            <code class="literal">type</code>, <code class="literal">lib</code>, and
            <code class="literal">generate</code> as specified
            <a class="link" href="index.html#pkgs-formats-result">below</a>.
          </p><p>
            The <code class="literal">lib</code> attribute contains functions to
            be used in settings, for generating special Elixir values:
          </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
                <code class="literal">mkRaw elixirCode</code>
              </span></dt><dd><p>
                  Outputs the given string as raw Elixir code
                </p></dd><dt><span class="term">
                <code class="literal">mkGetEnv { envVariable, fallback ? null }</code>
              </span></dt><dd><p>
                  Makes the configuration fetch an environment variable
                  at runtime
                </p></dd><dt><span class="term">
                <code class="literal">mkAtom atom</code>
              </span></dt><dd><p>
                  Outputs the given string as an Elixir atom, instead of
                  the default Elixir binary string. Note: lowercase
                  atoms still needs to be prefixed with
                  <code class="literal">:</code>
                </p></dd><dt><span class="term">
                <code class="literal">mkTuple array</code>
              </span></dt><dd><p>
                  Outputs the given array as an Elixir tuple, instead of
                  the default Elixir list
                </p></dd><dt><span class="term">
                <code class="literal">mkMap attrset</code>
              </span></dt><dd><p>
                  Outputs the given attribute set as an Elixir map,
                  instead of the default Elixir keyword list
                </p></dd></dl></div></dd></dl></div><p><a id="pkgs-formats-result"></a>
      These functions all return an attribute set with these values:
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="literal">type</code>
        </span></dt><dd><p>
            A module system type representing a value of the format
          </p></dd><dt><span class="term">
          <code class="literal">lib</code>
        </span></dt><dd><p>
            Utility functions for convenience, or special interactions
            with the format. This attribute is optional. It may contain
            inside a <code class="literal">types</code> attribute containing types
            specific to this format.
          </p></dd><dt><span class="term">
          <code class="literal">generate</code>
          <span class="emphasis"><em><code class="literal">filename jsonValue</code></em></span>
        </span></dt><dd><p>
            A function that can render a value of the format to a file.
            Returns a file path.
          </p><div class="note"><h3 class="title">Note</h3><p>
              This function puts the value contents in the Nix store. So
              this should be avoided for secrets.
            </p></div></dd></dl></div><a id="ex-settings-nix-representable"></a><p>
      <span class="strong"><strong>Example: Module with conventional
      <code class="literal">settings</code> option</strong></span>
    </p><p>
      The following shows a module for an example program that uses a
      JSON configuration file. It demonstrates how above values can be
      used, along with some other related best practices. See the
      comments for explanations.
    </p><pre class="programlisting">
{ options, config, lib, pkgs, ... }:
let
  cfg = config.services.foo;
  # Define the settings format used for this program
  settingsFormat = pkgs.formats.json {};
in {

  options.services.foo = {
    enable = lib.mkEnableOption "foo service";

    settings = lib.mkOption {
      # Setting this type allows for correct merging behavior
      type = settingsFormat.type;
      default = {};
      description = ''
        Configuration for foo, see
        &lt;link xlink:href="https://example.com/docs/foo"/&gt;
        for supported settings.
      '';
    };
  };

  config = lib.mkIf cfg.enable {
    # We can assign some default settings here to make the service work by just
    # enabling it. We use `mkDefault` for values that can be changed without
    # problems
    services.foo.settings = {
      # Fails at runtime without any value set
      log_level = lib.mkDefault "WARN";

      # We assume systemd's `StateDirectory` is used, so we require this value,
      # therefore no mkDefault
      data_path = "/var/lib/foo";

      # Since we use this to create a user we need to know the default value at
      # eval time
      user = lib.mkDefault "foo";
    };

    environment.etc."foo.json".source =
      # The formats generator function takes a filename and the Nix value
      # representing the format value and produces a filepath with that value
      # rendered in the format
      settingsFormat.generate "foo-config.json" cfg.settings;

    # We know that the `user` attribute exists because we set a default value
    # for it above, allowing us to use it without worries here
    users.users.${cfg.settings.user} = { isSystemUser = true; };

    # ...
  };
}
</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="sec-settings-attrs-options"></a>65.9.1.1. Option declarations for attributes</h4></div></div></div><p>
        Some <code class="literal">settings</code> attributes may deserve some
        extra care. They may need a different type, default or merging
        behavior, or they are essential options that should show their
        documentation in the manual. This can be done using
        <a class="xref" href="index.html#sec-freeform-modules" title="65.8. Freeform modules">Section 65.8, “Freeform modules”</a>.
      </p><p>
        We extend above example using freeform modules to declare an
        option for the port, which will enforce it to be a valid integer
        and make it show up in the manual.
      </p><a id="ex-settings-typed-attrs"></a><p>
        <span class="strong"><strong>Example: Declaring a type-checked
        <code class="literal">settings</code> attribute</strong></span>
      </p><pre class="programlisting">
settings = lib.mkOption {
  type = lib.types.submodule {

    freeformType = settingsFormat.type;

    # Declare an option for the port such that the type is checked and this option
    # is shown in the manual.
    options.port = lib.mkOption {
      type = lib.types.port;
      default = 8080;
      description = ''
        Which port this service should listen on.
      '';
    };

  };
  default = {};
  description = ''
    Configuration for Foo, see
    &lt;link xlink:href="https://example.com/docs/foo"/&gt;
    for supported values.
  '';
};
</pre></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-building-parts"></a>Chapter 66. Building Specific Parts of NixOS</h2></div></div></div><p>
    With the command <code class="literal">nix-build</code>, you can build
    specific parts of your NixOS configuration. This is done as follows:
  </p><pre class="programlisting">
$ cd /path/to/nixpkgs/nixos
$ nix-build -A config.option
</pre><p>
    where <code class="literal">option</code> is a NixOS option with type
    <span class="quote">“<span class="quote">derivation</span>”</span> (i.e. something that can be built).
    Attributes of interest include:
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        <code class="literal">system.build.toplevel</code>
      </span></dt><dd><p>
          The top-level option that builds the entire NixOS system.
          Everything else in your configuration is indirectly pulled in
          by this option. This is what <code class="literal">nixos-rebuild</code>
          builds and what <code class="literal">/run/current-system</code> points
          to afterwards.
        </p><p>
          A shortcut to build this is:
        </p><pre class="programlisting">
$ nix-build -A system
</pre></dd><dt><span class="term">
        <code class="literal">system.build.manual.manualHTML</code>
      </span></dt><dd><p>
          The NixOS manual.
        </p></dd><dt><span class="term">
        <code class="literal">system.build.etc</code>
      </span></dt><dd><p>
          A tree of symlinks that form the static parts of
          <code class="literal">/etc</code>.
        </p></dd><dt><span class="term">
        <code class="literal">system.build.initialRamdisk</code> ,
        <code class="literal">system.build.kernel</code>
      </span></dt><dd><p>
          The initial ramdisk and kernel of the system. This allows a
          quick way to test whether the kernel and the initial ramdisk
          boot correctly, by using QEMU’s <code class="literal">-kernel</code> and
          <code class="literal">-initrd</code> options:
        </p><pre class="programlisting">
$ nix-build -A config.system.build.initialRamdisk -o initrd
$ nix-build -A config.system.build.kernel -o kernel
$ qemu-system-x86_64 -kernel ./kernel/bzImage -initrd ./initrd/initrd -hda /dev/null
</pre></dd><dt><span class="term">
        <code class="literal">system.build.nixos-rebuild</code> ,
        <code class="literal">system.build.nixos-install</code> ,
        <code class="literal">system.build.nixos-generate-config</code>
      </span></dt><dd><p>
          These build the corresponding NixOS commands.
        </p></dd><dt><span class="term">
        <code class="literal">systemd.units.unit-name.unit</code>
      </span></dt><dd><p>
          This builds the unit with the specified name. Note that since
          unit names contain dots (e.g.
          <code class="literal">httpd.service</code>), you need to put them
          between quotes, like this:
        </p><pre class="programlisting">
$ nix-build -A 'config.systemd.units."httpd.service".unit'
</pre><p>
          You can also test individual units, without rebuilding the
          whole system, by putting them in
          <code class="literal">/run/systemd/system</code>:
        </p><pre class="programlisting">
$ cp $(nix-build -A 'config.systemd.units."httpd.service".unit')/httpd.service \
    /run/systemd/system/tmp-httpd.service
# systemctl daemon-reload
# systemctl start tmp-httpd.service
</pre><p>
          Note that the unit must not have the same name as any unit in
          <code class="literal">/etc/systemd/system</code> since those take
          precedence over <code class="literal">/run/systemd/system</code>. That’s
          why the unit is installed as
          <code class="literal">tmp-httpd.service</code> here.
        </p></dd></dl></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-switching-systems"></a>Chapter 67. What happens during a system switch?</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-unit-handling">67.1. Unit handling</a></span></dt><dt><span class="section"><a href="index.html#sec-activation-script">67.2. Activation script</a></span></dt></dl></div><p>
    Running <code class="literal">nixos-rebuild switch</code> is one of the more
    common tasks under NixOS. This chapter explains some of the
    internals of this command to make it simpler for new module
    developers to configure their units correctly and to make it easier
    to understand what is happening and why for curious administrators.
  </p><p>
    <code class="literal">nixos-rebuild</code>, like many deployment solutions,
    calls <code class="literal">switch-to-configuration</code> which resides in a
    NixOS system at <code class="literal">$out/bin/switch-to-configuration</code>.
    The script is called with the action that is to be performed like
    <code class="literal">switch</code>, <code class="literal">test</code>,
    <code class="literal">boot</code>. There is also the
    <code class="literal">dry-activate</code> action which does not really perform
    the actions but rather prints what it would do if you called it with
    <code class="literal">test</code>. This feature can be used to check what
    service states would be changed if the configuration was switched
    to.
  </p><p>
    If the action is <code class="literal">switch</code> or
    <code class="literal">boot</code>, the bootloader is updated first so the
    configuration will be the next one to boot. Unless
    <code class="literal">NIXOS_NO_SYNC</code> is set to <code class="literal">1</code>,
    <code class="literal">/nix/store</code> is synced to disk.
  </p><p>
    If the action is <code class="literal">switch</code> or
    <code class="literal">test</code>, the currently running system is inspected
    and the actions to switch to the new system are calculated. This
    process takes two data sources into account:
    <code class="literal">/etc/fstab</code> and the current systemd status. Mounts
    and swaps are read from <code class="literal">/etc/fstab</code> and the
    corresponding actions are generated. If a new mount is added, for
    example, the proper <code class="literal">.mount</code> unit is marked to be
    started. The current systemd state is inspected, the difference
    between the current system and the desired configuration is
    calculated and actions are generated to get to this state. There are
    a lot of nuances that can be controlled by the units which are
    explained here.
  </p><p>
    After calculating what should be done, the actions are carried out.
    The order of actions is always the same:
  </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        Stop units (<code class="literal">systemctl stop</code>)
      </p></li><li class="listitem"><p>
        Run activation script (<code class="literal">$out/activate</code>)
      </p></li><li class="listitem"><p>
        See if the activation script requested more units to restart
      </p></li><li class="listitem"><p>
        Restart systemd if needed
        (<code class="literal">systemd daemon-reexec</code>)
      </p></li><li class="listitem"><p>
        Forget about the failed state of units
        (<code class="literal">systemctl reset-failed</code>)
      </p></li><li class="listitem"><p>
        Reload systemd (<code class="literal">systemctl daemon-reload</code>)
      </p></li><li class="listitem"><p>
        Reload systemd user instances
        (<code class="literal">systemctl --user daemon-reload</code>)
      </p></li><li class="listitem"><p>
        Set up tmpfiles (<code class="literal">systemd-tmpfiles --create</code>)
      </p></li><li class="listitem"><p>
        Reload units (<code class="literal">systemctl reload</code>)
      </p></li><li class="listitem"><p>
        Restart units (<code class="literal">systemctl restart</code>)
      </p></li><li class="listitem"><p>
        Start units (<code class="literal">systemctl start</code>)
      </p></li><li class="listitem"><p>
        Inspect what changed during these actions and print units that
        failed and that were newly started
      </p></li></ul></div><p>
    Most of these actions are either self-explaining but some of them
    have to do with our units or the activation script. For this reason,
    these topics are explained in the next sections.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-unit-handling"></a>67.1. Unit handling</h2></div></div></div><p>
    To figure out what units need to be
    started/stopped/restarted/reloaded, the script first checks the
    current state of the system, similar to what
    <code class="literal">systemctl list-units</code> shows. For each of the
    units, the script goes through the following checks:
  </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        Is the unit file still in the new system? If not,
        <span class="strong"><strong>stop</strong></span> the service unless it
        sets <code class="literal">X-StopOnRemoval</code> in the
        <code class="literal">[Unit]</code> section to <code class="literal">false</code>.
      </p></li><li class="listitem"><p>
        Is it a <code class="literal">.target</code> unit? If so,
        <span class="strong"><strong>start</strong></span> it unless it sets
        <code class="literal">RefuseManualStart</code> in the
        <code class="literal">[Unit]</code> section to <code class="literal">true</code> or
        <code class="literal">X-OnlyManualStart</code> in the
        <code class="literal">[Unit]</code> section to <code class="literal">true</code>.
        Also <span class="strong"><strong>stop</strong></span> the unit again
        unless it sets <code class="literal">X-StopOnReconfiguration</code> to
        <code class="literal">false</code>.
      </p></li><li class="listitem"><p>
        Are the contents of the unit files different? They are compared
        by parsing them and comparing their contents. If they are
        different but only <code class="literal">X-Reload-Triggers</code> in the
        <code class="literal">[Unit]</code> section is changed,
        <span class="strong"><strong>reload</strong></span> the unit. The NixOS
        module system allows setting these triggers with the option
        <a class="link" href="options.html#opt-systemd.services">systemd.services.&lt;name&gt;.reloadTriggers</a>.
        There are some additional keys in the <code class="literal">[Unit]</code>
        section that are ignored as well. If the unit files differ in
        any way, the following actions are performed:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
            <code class="literal">.path</code> and <code class="literal">.slice</code> units
            are ignored. There is no need to restart them since changes
            in their values are applied by systemd when systemd is
            reloaded.
          </p></li><li class="listitem"><p>
            <code class="literal">.mount</code> units are
            <span class="strong"><strong>reload</strong></span>ed. These mostly
            come from the <code class="literal">/etc/fstab</code> parser.
          </p></li><li class="listitem"><p>
            <code class="literal">.socket</code> units are currently ignored. This
            is to be fixed at a later point.
          </p></li><li class="listitem"><p>
            The rest of the units (mostly <code class="literal">.service</code>
            units) are then <span class="strong"><strong>reload</strong></span>ed
            if <code class="literal">X-ReloadIfChanged</code> in the
            <code class="literal">[Service]</code> section is set to
            <code class="literal">true</code> (exposed via
            <a class="link" href="options.html#opt-systemd.services">systemd.services.&lt;name&gt;.reloadIfChanged</a>).
            A little exception is done for units that were deactivated
            in the meantime, for example because they require a unit
            that got stopped before. These are
            <span class="strong"><strong>start</strong></span>ed instead of
            reloaded.
          </p></li><li class="listitem"><p>
            If the reload flag is not set, some more flags decide if the
            unit is skipped. These flags are
            <code class="literal">X-RestartIfChanged</code> in the
            <code class="literal">[Service]</code> section (exposed via
            <a class="link" href="options.html#opt-systemd.services">systemd.services.&lt;name&gt;.restartIfChanged</a>),
            <code class="literal">RefuseManualStop</code> in the
            <code class="literal">[Unit]</code> section, and
            <code class="literal">X-OnlyManualStart</code> in the
            <code class="literal">[Unit]</code> section.
          </p></li><li class="listitem"><p>
            Further behavior depends on the unit having
            <code class="literal">X-StopIfChanged</code> in the
            <code class="literal">[Service]</code> section set to
            <code class="literal">true</code> (exposed via
            <a class="link" href="options.html#opt-systemd.services">systemd.services.&lt;name&gt;.stopIfChanged</a>).
            This is set to <code class="literal">true</code> by default and must
            be explicitly turned off if not wanted. If the flag is
            enabled, the unit is
            <span class="strong"><strong>stop</strong></span>ped and then
            <span class="strong"><strong>start</strong></span>ed. If not, the unit
            is <span class="strong"><strong>restart</strong></span>ed. The goal of
            the flag is to make sure that the new unit never runs in the
            old environment which is still in place before the
            activation script is run. This behavior is different when
            the service is socket-activated, as outlined in the
            following steps.
          </p></li><li class="listitem"><p>
            The last thing that is taken into account is whether the
            unit is a service and socket-activated. If
            <code class="literal">X-StopIfChanged</code> is
            <span class="strong"><strong>not</strong></span> set, the service is
            <span class="strong"><strong>restart</strong></span>ed with the
            others. If it is set, both the service and the socket are
            <span class="strong"><strong>stop</strong></span>ped and the socket is
            <span class="strong"><strong>start</strong></span>ed, leaving socket
            activation to start the service when it’s needed.
          </p></li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-activation-script"></a>67.2. Activation script</h2></div></div></div><p>
    The activation script is a bash script called to activate the new
    configuration which resides in a NixOS system in
    <code class="literal">$out/activate</code>. Since its contents depend on your
    system configuration, the contents may differ. This chapter explains
    how the script works in general and some common NixOS snippets.
    Please be aware that the script is executed on every boot and system
    switch, so tasks that can be performed in other places should be
    performed there (for example letting a directory of a service be
    created by systemd using mechanisms like
    <code class="literal">StateDirectory</code>,
    <code class="literal">CacheDirectory</code>, … or if that’s not possible using
    <code class="literal">preStart</code> of the service).
  </p><p>
    Activation scripts are defined as snippets using
    <a class="xref" href="options.html#opt-system.activationScripts"><code class="option">system.activationScripts</code></a>. They can either be
    a simple multiline string or an attribute set that can depend on
    other snippets. The builder for the activation script will take
    these dependencies into account and order the snippets accordingly.
    As a simple example:
  </p><pre class="programlisting">
system.activationScripts.my-activation-script = {
  deps = [ "etc" ];
  # supportsDryActivation = true;
  text = ''
    echo "Hallo i bims"
  '';
};
</pre><p>
    This example creates an activation script snippet that is run after
    the <code class="literal">etc</code> snippet. The special variable
    <code class="literal">supportsDryActivation</code> can be set so the snippet
    is also run when <code class="literal">nixos-rebuild dry-activate</code> is
    run. To differentiate between real and dry activation, the
    <code class="literal">$NIXOS_ACTION</code> environment variable can be read
    which is set to <code class="literal">dry-activate</code> when a dry
    activation is done.
  </p><p>
    An activation script can write to special files instructing
    <code class="literal">switch-to-configuration</code> to restart/reload units.
    The script will take these requests into account and will
    incorperate the unit configuration as described above. This means
    that the activation script will <span class="quote">“<span class="quote">fake</span>”</span> a modified unit
    file and <code class="literal">switch-to-configuration</code> will act
    accordingly. By doing so, configuration like
    <a class="link" href="options.html#opt-systemd.services">systemd.services.&lt;name&gt;.restartIfChanged</a>
    is respected. Since the activation script is run
    <span class="strong"><strong>after</strong></span> services are already
    stopped,
    <a class="link" href="options.html#opt-systemd.services">systemd.services.&lt;name&gt;.stopIfChanged</a>
    cannot be taken into account anymore and the unit is always
    restarted instead of being stopped and started afterwards.
  </p><p>
    The files that can be written to are
    <code class="literal">/run/nixos/activation-restart-list</code> and
    <code class="literal">/run/nixos/activation-reload-list</code> with their
    respective counterparts for dry activation being
    <code class="literal">/run/nixos/dry-activation-restart-list</code> and
    <code class="literal">/run/nixos/dry-activation-reload-list</code>. Those
    files can contain newline-separated lists of unit names where
    duplicates are being ignored. These files are not create
    automatically and activation scripts must take the possiblility into
    account that they have to create them first.
  </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-activation-script-nixos-snippets"></a>67.2.1. NixOS snippets</h3></div></div></div><p>
      There are some snippets NixOS enables by default because disabling
      them would most likely break you system. This section lists a few
      of them and what they do:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="literal">binsh</code> creates <code class="literal">/bin/sh</code>
          which points to the runtime shell
        </p></li><li class="listitem"><p>
          <code class="literal">etc</code> sets up the contents of
          <code class="literal">/etc</code>, this includes systemd units and
          excludes <code class="literal">/etc/passwd</code>,
          <code class="literal">/etc/group</code>, and
          <code class="literal">/etc/shadow</code> (which are managed by the
          <code class="literal">users</code> snippet)
        </p></li><li class="listitem"><p>
          <code class="literal">hostname</code> sets the system’s hostname in the
          kernel (not in <code class="literal">/etc</code>)
        </p></li><li class="listitem"><p>
          <code class="literal">modprobe</code> sets the path to the
          <code class="literal">modprobe</code> binary for module auto-loading
        </p></li><li class="listitem"><p>
          <code class="literal">nix</code> prepares the nix store and adds a
          default initial channel
        </p></li><li class="listitem"><p>
          <code class="literal">specialfs</code> is responsible for mounting
          filesystems like <code class="literal">/proc</code> and
          <code class="literal">sys</code>
        </p></li><li class="listitem"><p>
          <code class="literal">users</code> creates and removes users and groups
          by managing <code class="literal">/etc/passwd</code>,
          <code class="literal">/etc/group</code> and
          <code class="literal">/etc/shadow</code>. This also creates home
          directories
        </p></li><li class="listitem"><p>
          <code class="literal">usrbinenv</code> creates
          <code class="literal">/usr/bin/env</code>
        </p></li><li class="listitem"><p>
          <code class="literal">var</code> creates some directories in
          <code class="literal">/var</code> that are not service-specific
        </p></li><li class="listitem"><p>
          <code class="literal">wrappers</code> creates setuid wrappers like
          <code class="literal">ping</code> and <code class="literal">sudo</code>
        </p></li></ul></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-writing-documentation"></a>Chapter 68. Writing NixOS Documentation</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-writing-docs-building-the-manual">68.1. Building the Manual</a></span></dt><dt><span class="section"><a href="index.html#sec-writing-docs-editing-docbook-xml">68.2. Editing DocBook XML</a></span></dt><dt><span class="section"><a href="index.html#sec-writing-docs-creating-a-topic">68.3. Creating a Topic</a></span></dt><dt><span class="section"><a href="index.html#sec-writing-docs-adding-a-topic">68.4. Adding a Topic to the Book</a></span></dt></dl></div><p>
    As NixOS grows, so too does the need for a catalogue and explanation
    of its extensive functionality. Collecting pertinent information
    from disparate sources and presenting it in an accessible style
    would be a worthy contribution to the project.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-writing-docs-building-the-manual"></a>68.1. Building the Manual</h2></div></div></div><p>
      The DocBook sources of the <a class="xref" href="index.html" title="NixOS Manual">NixOS Manual</a>
      are in the
      <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/doc/manual" target="_top"><code class="literal">nixos/doc/manual</code></a>
      subdirectory of the Nixpkgs repository.
    </p><p>
      You can quickly validate your edits with <code class="literal">make</code>:
    </p><pre class="programlisting">
$ cd /path/to/nixpkgs/nixos/doc/manual
$ nix-shell
nix-shell$ make
</pre><p>
      Once you are done making modifications to the manual, it's
      important to build it before committing. You can do that as
      follows:
    </p><pre class="programlisting">
nix-build nixos/release.nix -A manual.x86_64-linux
</pre><p>
      When this command successfully finishes, it will tell you where
      the manual got generated. The HTML will be accessible through the
      <code class="literal">result</code> symlink at
      <code class="literal">./result/share/doc/nixos/index.html</code>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-writing-docs-editing-docbook-xml"></a>68.2. Editing DocBook XML</h2></div></div></div><p>
      For general information on how to write in DocBook, see
      <a class="link" href="http://www.docbook.org/tdg5/en/html/docbook.html" target="_top">DocBook
      5: The Definitive Guide</a>.
    </p><p>
      Emacs nXML Mode is very helpful for editing DocBook XML because it
      validates the document as you write, and precisely locates errors.
      To use it, see <a class="xref" href="index.html#sec-emacs-docbook-xml" title="43.3.3. Editing DocBook 5 XML Documents">Section 43.3.3, “Editing DocBook 5 XML Documents”</a>.
    </p><p>
      <a class="link" href="http://pandoc.org" target="_top">Pandoc</a> can generate
      DocBook XML from a multitude of formats, which makes a good
      starting point. Here is an example of Pandoc invocation to convert
      GitHub-Flavoured MarkDown to DocBook 5 XML:
    </p><pre class="programlisting">
pandoc -f markdown_github -t docbook5 docs.md -o my-section.md
</pre><p>
      Pandoc can also quickly convert a single
      <code class="literal">section.xml</code> to HTML, which is helpful when
      drafting.
    </p><p>
      Sometimes writing valid DocBook is simply too difficult. In this
      case, submit your documentation updates in a
      <a class="link" href="https://github.com/NixOS/nixpkgs/issues/new" target="_top">GitHub
      Issue</a> and someone will handle the conversion to XML for
      you.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-writing-docs-creating-a-topic"></a>68.3. Creating a Topic</h2></div></div></div><p>
      You can use an existing topic as a basis for the new topic or
      create a topic from scratch.
    </p><p>
      Keep the following guidelines in mind when you create and add a
      topic:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          The NixOS
          <a class="link" href="http://www.docbook.org/tdg5/en/html/book.html" target="_top"><code class="literal">book</code></a>
          element is in <code class="literal">nixos/doc/manual/manual.xml</code>.
          It includes several
          <a class="link" href="http://www.docbook.org/tdg5/en/html/book.html" target="_top"><code class="literal">parts</code></a>
          which are in subdirectories.
        </p></li><li class="listitem"><p>
          Store the topic file in the same directory as the
          <code class="literal">part</code> to which it belongs. If your topic is
          about configuring a NixOS module, then the XML file can be
          stored alongside the module definition <code class="literal">nix</code>
          file.
        </p></li><li class="listitem"><p>
          If you include multiple words in the file name, separate the
          words with a dash. For example:
          <code class="literal">ipv6-config.xml</code>.
        </p></li><li class="listitem"><p>
          Make sure that the <code class="literal">xml:id</code> value is unique.
          You can use abbreviations if the ID is too long. For example:
          <code class="literal">nixos-config</code>.
        </p></li><li class="listitem"><p>
          Determine whether your topic is a chapter or a section. If you
          are unsure, open an existing topic file and check whether the
          main element is chapter or section.
        </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-writing-docs-adding-a-topic"></a>68.4. Adding a Topic to the Book</h2></div></div></div><p>
      Open the parent XML file and add an <code class="literal">xi:include</code>
      element to the list of chapters with the file name of the topic
      that you created. If you created a <code class="literal">section</code>, you
      add the file to the <code class="literal">chapter</code> file. If you
      created a <code class="literal">chapter</code>, you add the file to the
      <code class="literal">part</code> file.
    </p><p>
      If the topic is about configuring a NixOS module, it can be
      automatically included in the manual by using the
      <code class="literal">meta.doc</code> attribute. See
      <a class="xref" href="index.html#sec-meta-attributes" title="65.5. Meta Attributes">Section 65.5, “Meta Attributes”</a> for an explanation.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-building-image"></a>Chapter 69. Building a NixOS (Live) ISO</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-building-image-instructions">69.1. Practical Instructions</a></span></dt><dt><span class="section"><a href="index.html#sec-building-image-tech-notes">69.2. Technical Notes</a></span></dt></dl></div><p>
    Default live installer configurations are available inside
    <code class="literal">nixos/modules/installer/cd-dvd</code>. For building
    other system images,
    <a class="link" href="https://github.com/nix-community/nixos-generators" target="_top">nixos-generators</a>
    is a good place to start looking at.
  </p><p>
    You have two options:
  </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        Use any of those default configurations as is
      </p></li><li class="listitem"><p>
        Combine them with (any of) your host config(s)
      </p></li></ul></div><p>
    System images, such as the live installer ones, know how to enforce
    configuration settings on wich they immediately depend in order to
    work correctly.
  </p><p>
    However, if you are confident, you can opt to override those
    enforced values with <code class="literal">mkForce</code>.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-building-image-instructions"></a>69.1. Practical Instructions</h2></div></div></div><pre class="programlisting">
$ git clone https://github.com/NixOS/nixpkgs.git
$ cd nixpkgs/nixos
$ nix-build -A config.system.build.isoImage -I nixos-config=modules/installer/cd-dvd/installation-cd-minimal.nix default.nix
</pre><p>
      To check the content of an ISO image, mount it like so:
    </p><pre class="programlisting">
# mount -o loop -t iso9660 ./result/iso/cd.iso /mnt/iso
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-building-image-tech-notes"></a>69.2. Technical Notes</h2></div></div></div><p>
      The config value enforcement is implemented via
      <code class="literal">mkImageMediaOverride = mkOverride 60;</code> and
      therefore primes over simple value assignments, but also yields to
      <code class="literal">mkForce</code>.
    </p><p>
      This property allows image designers to implement in semantically
      correct ways those configuration values upon which the correct
      functioning of the image depends.
    </p><p>
      For example, the iso base image overrides those file systems which
      it needs at a minimum for correct functioning, while the installer
      base image overrides the entire file system layout because there
      can’t be any other guarantees on a live medium than those given by
      the live medium itself. The latter is especially true befor
      formatting the target block device(s). On the other hand, the
      netboot iso only overrides its minimum dependencies since netboot
      images are always made-to-target.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="sec-nixos-tests"></a>Chapter 70. NixOS Tests</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#sec-writing-nixos-tests">70.1. Writing Tests</a></span></dt><dt><span class="section"><a href="index.html#sec-running-nixos-tests">70.2. Running Tests</a></span></dt><dt><span class="section"><a href="index.html#sec-running-nixos-tests-interactively">70.3. Running Tests interactively</a></span></dt><dt><span class="section"><a href="index.html#sec-linking-nixos-tests-to-packages">70.4. Linking NixOS tests to packages</a></span></dt></dl></div><p>
    When you add some feature to NixOS, you should write a test for it.
    NixOS tests are kept in the directory
    <code class="literal">nixos/tests</code>, and are executed (using Nix) by a
    testing framework that automatically starts one or more virtual
    machines containing the NixOS system(s) required for the test.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-writing-nixos-tests"></a>70.1. Writing Tests</h2></div></div></div><p>
    A NixOS test is a Nix expression that has the following structure:
  </p><pre class="programlisting">
import ./make-test-python.nix {

  # One or more machines:
  nodes =
    { machine =
        { config, pkgs, ... }: { … };
      machine2 =
        { config, pkgs, ... }: { … };
      …
    };

  testScript =
    ''
      Python code…
    '';
}
</pre><p>
    The attribute <code class="literal">testScript</code> is a bit of Python code
    that executes the test (described below). During the test, it will
    start one or more virtual machines, the configuration of which is
    described by the attribute <code class="literal">nodes</code>.
  </p><p>
    An example of a single-node test is
    <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/login.nix" target="_top"><code class="literal">login.nix</code></a>.
    It only needs a single machine to test whether users can log in on
    the virtual console, whether device ownership is correctly
    maintained when switching between consoles, and so on. An
    interesting multi-node test is
    <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/nfs/simple.nix" target="_top"><code class="literal">nfs/simple.nix</code></a>.
    It uses two client nodes to test correct locking across server
    crashes.
  </p><p>
    There are a few special NixOS configuration options for test VMs:
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        <code class="literal">virtualisation.memorySize</code>
      </span></dt><dd><p>
          The memory of the VM in megabytes.
        </p></dd><dt><span class="term">
        <code class="literal">virtualisation.vlans</code>
      </span></dt><dd><p>
          The virtual networks to which the VM is connected. See
          <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/nat.nix" target="_top"><code class="literal">nat.nix</code></a>
          for an example.
        </p></dd><dt><span class="term">
        <code class="literal">virtualisation.writableStore</code>
      </span></dt><dd><p>
          By default, the Nix store in the VM is not writable. If you
          enable this option, a writable union file system is mounted on
          top of the Nix store to make it appear writable. This is
          necessary for tests that run Nix operations that modify the
          store.
        </p></dd></dl></div><p>
    For more options, see the module
    <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/virtualisation/qemu-vm.nix" target="_top"><code class="literal">qemu-vm.nix</code></a>.
  </p><p>
    The test script is a sequence of Python statements that perform
    various actions, such as starting VMs, executing commands in the
    VMs, and so on. Each virtual machine is represented as an object
    stored in the variable <code class="literal">name</code> if this is also the
    identifier of the machine in the declarative config. If you
    specified a node <code class="literal">nodes.machine</code>, the following
    example starts the machine, waits until it has finished booting,
    then executes a command and checks that the output is more-or-less
    correct:
  </p><pre class="programlisting">
machine.start()
machine.wait_for_unit("default.target")
if not "Linux" in machine.succeed("uname"):
  raise Exception("Wrong OS")
</pre><p>
    The first line is technically unnecessary; machines are implicitly
    started when you first execute an action on them (such as
    <code class="literal">wait_for_unit</code> or <code class="literal">succeed</code>). If
    you have multiple machines, you can speed up the test by starting
    them in parallel:
  </p><pre class="programlisting">
start_all()
</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-machine-objects"></a>70.1.1. Machine objects</h3></div></div></div><p>
      The following methods are available on machine objects:
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
          <code class="literal">start</code>
        </span></dt><dd><p>
            Start the virtual machine. This method is asynchronous — it
            does not wait for the machine to finish booting.
          </p></dd><dt><span class="term">
          <code class="literal">shutdown</code>
        </span></dt><dd><p>
            Shut down the machine, waiting for the VM to exit.
          </p></dd><dt><span class="term">
          <code class="literal">crash</code>
        </span></dt><dd><p>
            Simulate a sudden power failure, by telling the VM to exit
            immediately.
          </p></dd><dt><span class="term">
          <code class="literal">block</code>
        </span></dt><dd><p>
            Simulate unplugging the Ethernet cable that connects the
            machine to the other machines.
          </p></dd><dt><span class="term">
          <code class="literal">unblock</code>
        </span></dt><dd><p>
            Undo the effect of <code class="literal">block</code>.
          </p></dd><dt><span class="term">
          <code class="literal">screenshot</code>
        </span></dt><dd><p>
            Take a picture of the display of the virtual machine, in PNG
            format. The screenshot is linked from the HTML log.
          </p></dd><dt><span class="term">
          <code class="literal">get_screen_text_variants</code>
        </span></dt><dd><p>
            Return a list of different interpretations of what is
            currently visible on the machine's screen using optical
            character recognition. The number and order of the
            interpretations is not specified and is subject to change,
            but if no exception is raised at least one will be returned.
          </p><div class="note"><h3 class="title">Note</h3><p>
              This requires passing <code class="literal">enableOCR</code> to the
              test attribute set.
            </p></div></dd><dt><span class="term">
          <code class="literal">get_screen_text</code>
        </span></dt><dd><p>
            Return a textual representation of what is currently visible
            on the machine's screen using optical character recognition.
          </p><div class="note"><h3 class="title">Note</h3><p>
              This requires passing <code class="literal">enableOCR</code> to the
              test attribute set.
            </p></div></dd><dt><span class="term">
          <code class="literal">send_monitor_command</code>
        </span></dt><dd><p>
            Send a command to the QEMU monitor. This is rarely used, but
            allows doing stuff such as attaching virtual USB disks to a
            running machine.
          </p></dd><dt><span class="term">
          <code class="literal">send_key</code>
        </span></dt><dd><p>
            Simulate pressing keys on the virtual keyboard, e.g.,
            <code class="literal">send_key("ctrl-alt-delete")</code>.
          </p></dd><dt><span class="term">
          <code class="literal">send_chars</code>
        </span></dt><dd><p>
            Simulate typing a sequence of characters on the virtual
            keyboard, e.g.,
            <code class="literal">send_chars("foobar\n")</code> will
            type the string <code class="literal">foobar</code> followed by the
            Enter key.
          </p></dd><dt><span class="term">
          <code class="literal">send_console</code>
        </span></dt><dd><p>
            Send keys to the kernel console. This allows interaction
            with the systemd emergency mode, for example. Takes a string
            that is sent, e.g.,
            <code class="literal">send_console("\n\nsystemctl default\n")</code>.
          </p></dd><dt><span class="term">
          <code class="literal">execute</code>
        </span></dt><dd><p>
            Execute a shell command, returning a list
            <code class="literal">(status, stdout)</code>. If the command
            detaches, it must close stdout, as
            <code class="literal">execute</code> will wait for this to consume all
            output reliably. This can be achieved by redirecting stdout
            to stderr <code class="literal">&gt;&amp;2</code>, to
            <code class="literal">/dev/console</code>,
            <code class="literal">/dev/null</code> or a file. Examples of
            detaching commands are <code class="literal">sleep 365d &amp;</code>,
            where the shell forks a new process that can write to stdout
            and <code class="literal">xclip -i</code>, where the
            <code class="literal">xclip</code> command itself forks without
            closing stdout. Takes an optional parameter
            <code class="literal">check_return</code> that defaults to
            <code class="literal">True</code>. Setting this parameter to
            <code class="literal">False</code> will not check for the return code
            and return -1 instead. This can be used for commands that
            shut down the VM and would therefore break the pipe that
            would be used for retrieving the return code.
          </p></dd><dt><span class="term">
          <code class="literal">succeed</code>
        </span></dt><dd><p>
            Execute a shell command, raising an exception if the exit
            status is not zero, otherwise returning the standard output.
            Commands are run with <code class="literal">set -euo pipefail</code>
            set:
          </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                If several commands are separated by
                <code class="literal">;</code> and one fails, the command as a
                whole will fail.
              </p></li><li class="listitem"><p>
                For pipelines, the last non-zero exit status will be
                returned (if there is one, zero will be returned
                otherwise).
              </p></li><li class="listitem"><p>
                Dereferencing unset variables fail the command.
              </p></li><li class="listitem"><p>
                It will wait for stdout to be closed. See
                <code class="literal">execute</code> for the implications.
              </p></li></ul></div></dd><dt><span class="term">
          <code class="literal">fail</code>
        </span></dt><dd><p>
            Like <code class="literal">succeed</code>, but raising an exception if
            the command returns a zero status.
          </p></dd><dt><span class="term">
          <code class="literal">wait_until_succeeds</code>
        </span></dt><dd><p>
            Repeat a shell command with 1-second intervals until it
            succeeds.
          </p></dd><dt><span class="term">
          <code class="literal">wait_until_fails</code>
        </span></dt><dd><p>
            Repeat a shell command with 1-second intervals until it
            fails.
          </p></dd><dt><span class="term">
          <code class="literal">wait_for_unit</code>
        </span></dt><dd><p>
            Wait until the specified systemd unit has reached the
            <span class="quote">“<span class="quote">active</span>”</span> state.
          </p></dd><dt><span class="term">
          <code class="literal">wait_for_file</code>
        </span></dt><dd><p>
            Wait until the specified file exists.
          </p></dd><dt><span class="term">
          <code class="literal">wait_for_open_port</code>
        </span></dt><dd><p>
            Wait until a process is listening on the given TCP port (on
            <code class="literal">localhost</code>, at least).
          </p></dd><dt><span class="term">
          <code class="literal">wait_for_closed_port</code>
        </span></dt><dd><p>
            Wait until nobody is listening on the given TCP port.
          </p></dd><dt><span class="term">
          <code class="literal">wait_for_x</code>
        </span></dt><dd><p>
            Wait until the X11 server is accepting connections.
          </p></dd><dt><span class="term">
          <code class="literal">wait_for_text</code>
        </span></dt><dd><p>
            Wait until the supplied regular expressions matches the
            textual contents of the screen by using optical character
            recognition (see <code class="literal">get_screen_text</code> and
            <code class="literal">get_screen_text_variants</code>).
          </p><div class="note"><h3 class="title">Note</h3><p>
              This requires passing <code class="literal">enableOCR</code> to the
              test attribute set.
            </p></div></dd><dt><span class="term">
          <code class="literal">wait_for_console_text</code>
        </span></dt><dd><p>
            Wait until the supplied regular expressions match a line of
            the serial console output. This method is useful when OCR is
            not possibile or accurate enough.
          </p></dd><dt><span class="term">
          <code class="literal">wait_for_window</code>
        </span></dt><dd><p>
            Wait until an X11 window has appeared whose name matches the
            given regular expression, e.g.,
            <code class="literal">wait_for_window("Terminal")</code>.
          </p></dd><dt><span class="term">
          <code class="literal">copy_from_host</code>
        </span></dt><dd><p>
            Copies a file from host to machine, e.g.,
            <code class="literal">copy_from_host("myfile", "/etc/my/important/file")</code>.
          </p><p>
            The first argument is the file on the host. The file needs
            to be accessible while building the nix derivation. The
            second argument is the location of the file on the machine.
          </p></dd><dt><span class="term">
          <code class="literal">systemctl</code>
        </span></dt><dd><p>
            Runs <code class="literal">systemctl</code> commands with optional
            support for <code class="literal">systemctl --user</code>
          </p><pre class="programlisting">
machine.systemctl("list-jobs --no-pager") # runs `systemctl list-jobs --no-pager`
machine.systemctl("list-jobs --no-pager", "any-user") # spawns a shell for `any-user` and runs `systemctl --user list-jobs --no-pager`
</pre></dd><dt><span class="term">
          <code class="literal">shell_interact</code>
        </span></dt><dd><p>
            Allows you to directly interact with the guest shell. This
            should only be used during test development, not in
            production tests. Killing the interactive session with
            <code class="literal">Ctrl-d</code> or <code class="literal">Ctrl-c</code> also
            ends the guest session.
          </p></dd><dt><span class="term">
          <code class="literal">console_interact</code>
        </span></dt><dd><p>
            Allows you to directly interact with QEMU’s stdin. This
            should only be used during test development, not in
            production tests. Output from QEMU is only read line-wise.
            <code class="literal">Ctrl-c</code> kills QEMU and
            <code class="literal">Ctrl-d</code> closes console and returns to the
            test runner.
          </p></dd></dl></div><p>
      To test user units declared by
      <code class="literal">systemd.user.services</code> the optional
      <code class="literal">user</code> argument can be used:
    </p><pre class="programlisting">
machine.start()
machine.wait_for_x()
machine.wait_for_unit("xautolock.service", "x-session-user")
</pre><p>
      This applies to <code class="literal">systemctl</code>,
      <code class="literal">get_unit_info</code>,
      <code class="literal">wait_for_unit</code>, <code class="literal">start_job</code> and
      <code class="literal">stop_job</code>.
    </p><p>
      For faster dev cycles it's also possible to disable the
      code-linters (this shouldn't be commited though):
    </p><pre class="programlisting">
import ./make-test-python.nix {
  skipLint = true;
  nodes.machine =
    { config, pkgs, ... }:
    { configuration…
    };

  testScript =
    ''
      Python code…
    '';
}
</pre><p>
      This will produce a Nix warning at evaluation time. To fully
      disable the linter, wrap the test script in comment directives to
      disable the Black linter directly (again, don't commit this within
      the Nixpkgs repository):
    </p><pre class="programlisting">
  testScript =
    ''
      # fmt: off
      Python code…
      # fmt: on
    '';
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-failing-tests-early"></a>70.1.2. Failing tests early</h3></div></div></div><p>
      To fail tests early when certain invariables are no longer met
      (instead of waiting for the build to time out), the decorator
      <code class="literal">polling_condition</code> is provided. For example, if
      we are testing a program <code class="literal">foo</code> that should not
      quit after being started, we might write the following:
    </p><pre class="programlisting">
@polling_condition
def foo_running():
    machine.succeed("pgrep -x foo")


machine.succeed("foo --start")
machine.wait_until_succeeds("pgrep -x foo")

with foo_running:
    ...  # Put `foo` through its paces
</pre><p>
      <code class="literal">polling_condition</code> takes the following
      (optional) arguments:
    </p><p>
      <code class="literal">seconds_interval</code>
    </p><p>
      : specifies how often the condition should be polled:
    </p><pre class="programlisting">
```py
@polling_condition(seconds_interval=10)
def foo_running():
    machine.succeed("pgrep -x foo")
```
</pre><p>
      <code class="literal">description</code>
    </p><p>
      : is used in the log when the condition is checked. If this is not
      provided, the description is pulled from the docstring of the
      function. These two are therefore equivalent:
    </p><pre class="programlisting">
```py
@polling_condition
def foo_running():
    "check that foo is running"
    machine.succeed("pgrep -x foo")
```

```py
@polling_condition(description="check that foo is running")
def foo_running():
    machine.succeed("pgrep -x foo")
```
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-running-nixos-tests"></a>70.2. Running Tests</h2></div></div></div><p>
    You can run tests using <code class="literal">nix-build</code>. For example,
    to run the test
    <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/login.nix" target="_top"><code class="literal">login.nix</code></a>,
    you just do:
  </p><pre class="programlisting">
$ nix-build '&lt;nixpkgs/nixos/tests/login.nix&gt;'
</pre><p>
    or, if you don’t want to rely on <code class="literal">NIX_PATH</code>:
  </p><pre class="programlisting">
$ cd /my/nixpkgs/nixos/tests
$ nix-build login.nix
…
running the VM test script
machine: QEMU running (pid 8841)
…
6 out of 6 tests succeeded
</pre><p>
    After building/downloading all required dependencies, this will
    perform a build that starts a QEMU/KVM virtual machine containing a
    NixOS system. The virtual machine mounts the Nix store of the host;
    this makes VM creation very fast, as no disk image needs to be
    created. Afterwards, you can view a log of the test:
  </p><pre class="programlisting">
$ nix-store --read-log result
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-running-nixos-tests-interactively"></a>70.3. Running Tests interactively</h2></div></div></div><p>
    The test itself can be run interactively. This is particularly
    useful when developing or debugging a test:
  </p><pre class="programlisting">
$ nix-build . -A nixosTests.login.driverInteractive
$ ./result/bin/nixos-test-driver
[...]
&gt;&gt;&gt;
</pre><p>
    You can then take any Python statement, e.g.
  </p><pre class="programlisting">
&gt;&gt;&gt; start_all()
&gt;&gt;&gt; test_script()
&gt;&gt;&gt; machine.succeed("touch /tmp/foo")
&gt;&gt;&gt; print(machine.succeed("pwd")) # Show stdout of command
</pre><p>
    The function <code class="literal">test_script</code> executes the entire test
    script and drops you back into the test driver command line upon its
    completion. This allows you to inspect the state of the VMs after
    the test (e.g. to debug the test script).
  </p><p>
    You can re-use the VM states coming from a previous run by setting
    the <code class="literal">--keep-vm-state</code> flag.
  </p><pre class="programlisting">
$ ./result/bin/nixos-test-driver --keep-vm-state
</pre><p>
    The machine state is stored in the
    <code class="literal">$TMPDIR/vm-state-machinename</code> directory.
  </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-linking-nixos-tests-to-packages"></a>70.4. Linking NixOS tests to packages</h2></div></div></div><p>
    You can link NixOS module tests to the packages that they exercised,
    so that the tests can be run automatically during code review when
    the package gets changed. This is
    <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#ssec-nixos-tests-linking" target="_top">described
    in the nixpkgs manual</a>.
  </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="ch-testing-installer"></a>Chapter 71. Testing the Installer</h2></div></div></div><p>
    Building, burning, and booting from an installation CD is rather
    tedious, so here is a quick way to see if the installer works
    properly:
  </p><pre class="programlisting">
# mount -t tmpfs none /mnt
# nixos-generate-config --root /mnt
$ nix-build '&lt;nixpkgs/nixos&gt;' -A config.system.build.nixos-install
# ./result/bin/nixos-install
</pre><p>
    To start a login shell in the new NixOS installation in
    <code class="literal">/mnt</code>:
  </p><pre class="programlisting">
$ nix-build '&lt;nixpkgs/nixos&gt;' -A config.system.build.nixos-enter
# ./result/bin/nixos-enter
</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="chap-contributing"></a>Chapter 72. Contributing to this manual</h1></div></div></div><p>
    The DocBook and CommonMark sources of NixOS’ manual are in the
    <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/doc/manual" target="_top">nixos/doc/manual</a>
    subdirectory of the
    <a class="link" href="https://github.com/NixOS/nixpkgs" target="_top">Nixpkgs</a>
    repository.
  </p><p>
    You can quickly check your edits with the following:
  </p><pre class="programlisting">
$ cd /path/to/nixpkgs
$ ./nixos/doc/manual/md-to-db.sh
$ nix-build nixos/release.nix -A manual.x86_64-linux
</pre><p>
    If the build succeeds, the manual will be in
    <code class="literal">./result/share/doc/nixos/index.html</code>.
  </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="options.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top"> </td><td width="20%" align="center"> </td><td width="40%" align="right" valign="top"> Appendix A. Configuration Options</td></tr></table></div></body></html>