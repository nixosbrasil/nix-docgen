<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Nixpkgs Manual</title><link rel="stylesheet" type="text/css" href="style.css" /><link rel="stylesheet" type="text/css" href="overrides.css" /><link rel="stylesheet" type="text/css" href="highlightjs/mono-blue.css" /><script src="./highlightjs/highlight.pack.js" type="text/javascript"></script><script src="./highlightjs/loader.js" type="text/javascript"></script><meta name="generator" content="DocBook XSL Stylesheets V1.79.2" /></head><body><div class="book"><div class="titlepage"><div><div><h1 class="title"><a id="idm140737322688656"></a>Nixpkgs Manual</h1></div><div><h2 class="subtitle">Version 21.05pre-git
  </h2></div></div><hr /></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="#preface">1. Preface</a></span></dt><dt><span class="part"><a href="#idm140737322633760">I. Using Nixpkgs</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chap-packageconfig">2. Global configuration</a></span></dt><dt><span class="chapter"><a href="#chap-overlays">3. Overlays</a></span></dt><dt><span class="chapter"><a href="#chap-overrides">4. Overriding</a></span></dt><dt><span class="chapter"><a href="#chap-functions">5. Functions reference</a></span></dt></dl></dd><dt><span class="part"><a href="#idm140737320519728">II. Standard environment</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chap-stdenv">6. The Standard Environment</a></span></dt><dt><span class="chapter"><a href="#chap-meta">7. Meta-attributes</a></span></dt><dt><span class="chapter"><a href="#chap-multiple-output">8. Multiple-output packages</a></span></dt><dt><span class="chapter"><a href="#chap-cross">9. Cross-compilation</a></span></dt><dt><span class="chapter"><a href="#chap-platform-notes">10. Platform Notes</a></span></dt></dl></dd><dt><span class="part"><a href="#idm140737319402416">III. Builders</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chap-pkgs-fetchers">11. Fetchers</a></span></dt><dt><span class="chapter"><a href="#chap-trivial-builders">12. Trivial builders</a></span></dt><dt><span class="chapter"><a href="#chap-special">13. Special builders</a></span></dt><dt><span class="chapter"><a href="#chap-images">14. Images</a></span></dt><dt><span class="chapter"><a href="#chap-language-support">15. Languages and frameworks</a></span></dt><dt><span class="chapter"><a href="#chap-packages">16. Packages</a></span></dt></dl></dd><dt><span class="part"><a href="#idm140737316362528">IV. Contributing to Nixpkgs</a></span></dt><dd><dl><dt><span class="chapter"><a href="#chap-quick-start">17. Quick Start to Adding a Package</a></span></dt><dt><span class="chapter"><a href="#chap-conventions">18. Coding conventions</a></span></dt><dt><span class="chapter"><a href="#chap-submitting-changes">19. Submitting changes</a></span></dt><dt><span class="chapter"><a href="#chap-vulnerability-roundup">20. Vulnerability Roundup</a></span></dt><dt><span class="chapter"><a href="#chap-reviewing-contributions">21. Reviewing contributions</a></span></dt><dt><span class="chapter"><a href="#chap-contributing">22. Contributing to this documentation</a></span></dt></dl></dd></dl></div><div class="list-of-figures"><p><strong>List of Figures</strong></p><dl><dt>19.1. <a href="#idm140737315839152">Staging workflow</a></dt></dl></div><div class="list-of-examples"><p><strong>List of Examples</strong></p><dl><dt>5.1. <a href="#function-library-lib.asserts.assertMsg-example-false">Printing when the predicate is false</a></dt><dt>5.2. <a href="#function-library-lib.asserts.assertOneOf-example">Ensuring a user provided a possible value</a></dt><dt>5.3. <a href="#function-library-lib.attrset.attrByPath-example-value-exists">Extracting a value from a nested attribute set</a></dt><dt>5.4. <a href="#function-library-lib.attrset.attrByPath-example-default-value">No value at the path, instead using the default</a></dt><dt>5.5. <a href="#function-library-lib.attrsets.hasAttrByPath-example">A nested value does exist inside a set</a></dt><dt>5.6. <a href="#function-library-lib.attrsets.setAttrByPath-example">Creating a new nested attribute set</a></dt><dt>5.7. <a href="#function-library-lib.attrsets.getAttrPath-example-success">Succesfully getting a value from an attribute set</a></dt><dt>5.8. <a href="#function-library-lib.attrsets.getAttrPath-example-throw">Throwing after failing to get a value from an attribute set</a></dt><dt>5.9. <a href="#function-library-lib.attrsets.attrVals-example-success">Getting several values from an attribute set</a></dt><dt>5.10. <a href="#function-library-lib.attrsets.attrVals-failure">Getting missing values from an attribute set</a></dt><dt>5.11. <a href="#function-library-lib.attrsets.attrValues-example"></a></dt><dt>5.12. <a href="#function-library-lib.attrsets.catAttrs-example">Collect an attribute from a list of attribute sets.</a></dt><dt>5.13. <a href="#function-library-lib.attrsets.filterAttrs-example">Filtering an attributeset</a></dt><dt>5.14. <a href="#function-library-lib.attrsets.filterAttrsRecursive-example">Recursively filtering an attribute set</a></dt><dt>5.15. <a href="#function-library-lib.attrsets.foldAttrs-example">Combining an attribute of lists in to one attribute set</a></dt><dt>5.16. <a href="#function-library-lib.attrsets.collect-example-lists">Collecting all lists from an attribute set</a></dt><dt>5.17. <a href="#function-library-lib.attrsets.collect-example-outpath">Collecting all attribute-sets which contain the <code class="literal">outPath</code> attribute name.</a></dt><dt>5.18. <a href="#function-library-lib.attrsets.nameValuePair-example">Creating a name value pair</a></dt><dt>5.19. <a href="#function-library-lib.attrsets.mapAttrs-example">Modifying each value of an attribute set</a></dt><dt>5.20. <a href="#function-library-lib.attrsets.mapAttrs-prime-example">Change the name and value of each attribute of an attribute set</a></dt><dt>5.21. <a href="#function-library-lib.attrsets.mapAttrsToList-example">Combine attribute values and names in to a list</a></dt><dt>5.22. <a href="#function-library-lib.attrsets.mapAttrsRecursive-example">A contrived example of using <code class="function">lib.attrsets.mapAttrsRecursive</code></a></dt><dt>5.23. <a href="#function-library-lib.attrsets.mapAttrsRecursiveCond-example">Only convert attribute values to JSON if the containing attribute set is marked for recursion</a></dt><dt>5.24. <a href="#function-library-lib.attrsets.genAttrs-example">Generate an attrset based on names only</a></dt><dt>5.25. <a href="#function-library-lib.attrsets.isDerivation-example-true">A package is a derivation</a></dt><dt>5.26. <a href="#function-library-lib.attrsets.isDerivation-example-false">Anything else is not a derivation</a></dt><dt>5.27. <a href="#function-library-lib.attrsets.optionalAttrs-example-true">Return the provided attribute set when <code class="varname">cond</code> is true</a></dt><dt>5.28. <a href="#function-library-lib.attrsets.optionalAttrs-example-false">Return an empty attribute set when <code class="varname">cond</code> is false</a></dt><dt>5.29. <a href="#function-library-lib.attrsets.zipAttrsWithNames-example">Summing a list of attribute sets of numbers</a></dt><dt>5.30. <a href="#function-library-lib.attrsets.zipAttrsWith-example">Summing a list of attribute sets of numbers</a></dt><dt>5.31. <a href="#function-library-lib.attrsets.zipAttrs-example">Combining a list of attribute sets</a></dt><dt>5.32. <a href="#function-library-lib.attrsets.recursiveUpdateUntil-example">Recursively merging two attribute sets</a></dt><dt>5.33. <a href="#function-library-lib.attrsets.recursiveUpdate-example">Recursively merging two attribute sets</a></dt><dt>5.34. <a href="#function-library-lib.attrsets.recurseIntoAttrs-example">Making Nix look inside an attribute set</a></dt><dt>5.35. <a href="#function-library-lib.attrsets.cartesianProductOfSets-example">Creating the cartesian product of a list of attribute values</a></dt><dt>5.36. <a href="#idm140737321906560"><code class="function">lib.strings.concatStrings</code> usage example</a></dt><dt>5.37. <a href="#idm140737321895248"><code class="function">lib.strings.concatMapStrings</code> usage example</a></dt><dt>5.38. <a href="#idm140737321883856"><code class="function">lib.strings.concatImapStrings</code> usage example</a></dt><dt>5.39. <a href="#idm140737321872448"><code class="function">lib.strings.intersperse</code> usage example</a></dt><dt>5.40. <a href="#idm140737321865664"><code class="function">lib.strings.concatStringsSep</code> usage example</a></dt><dt>5.41. <a href="#idm140737321852160"><code class="function">lib.strings.concatMapStringsSep</code> usage example</a></dt><dt>5.42. <a href="#idm140737321838720"><code class="function">lib.strings.concatImapStringsSep</code> usage example</a></dt><dt>5.43. <a href="#idm140737321827312"><code class="function">lib.strings.makeSearchPath</code> usage example</a></dt><dt>5.44. <a href="#idm140737321814048"><code class="function">lib.strings.makeSearchPathOutput</code> usage example</a></dt><dt>5.45. <a href="#idm140737321807904"><code class="function">lib.strings.makeLibraryPath</code> usage example</a></dt><dt>5.46. <a href="#idm140737321801744"><code class="function">lib.strings.makeBinPath</code> usage example</a></dt><dt>5.47. <a href="#idm140737321790320"><code class="function">lib.strings.optionalString</code> usage example</a></dt><dt>5.48. <a href="#idm140737321779072"><code class="function">lib.strings.hasPrefix</code> usage example</a></dt><dt>5.49. <a href="#idm140737321767920"><code class="function">lib.strings.hasSuffix</code> usage example</a></dt><dt>5.50. <a href="#idm140737321756720"><code class="function">lib.strings.hasInfix</code> usage example</a></dt><dt>5.51. <a href="#idm140737321747424"><code class="function">lib.strings.stringToCharacters</code> usage example</a></dt><dt>5.52. <a href="#idm140737321736048"><code class="function">lib.strings.stringAsChars</code> usage example</a></dt><dt>5.53. <a href="#idm140737321726640"><code class="function">lib.strings.escape</code> usage example</a></dt><dt>5.54. <a href="#idm140737321717328"><code class="function">lib.strings.escapeShellArg</code> usage example</a></dt><dt>5.55. <a href="#idm140737321710512"><code class="function">lib.strings.escapeShellArgs</code> usage example</a></dt><dt>5.56. <a href="#idm140737321701184"><code class="function">lib.strings.escapeNixString</code> usage example</a></dt><dt>5.57. <a href="#idm140737321694384"><code class="function">lib.strings.escapeRegex</code> usage example</a></dt><dt>5.58. <a href="#idm140737321685136"><code class="function">lib.strings.escapeNixIdentifier</code> usage example</a></dt><dt>5.59. <a href="#idm140737321678400"><code class="function">lib.strings.toLower</code> usage example</a></dt><dt>5.60. <a href="#idm140737321671760"><code class="function">lib.strings.toUpper</code> usage example</a></dt><dt>5.61. <a href="#idm140737321660496"><code class="function">lib.strings.addContextFrom</code> usage example</a></dt><dt>5.62. <a href="#idm140737321649920"><code class="function">lib.strings.splitString</code> usage example</a></dt><dt>5.63. <a href="#idm140737321638576"><code class="function">lib.strings.removePrefix</code> usage example</a></dt><dt>5.64. <a href="#idm140737321627248"><code class="function">lib.strings.removeSuffix</code> usage example</a></dt><dt>5.65. <a href="#idm140737321616752"><code class="function">lib.strings.versionOlder</code> usage example</a></dt><dt>5.66. <a href="#idm140737321606336"><code class="function">lib.strings.versionAtLeast</code> usage example</a></dt><dt>5.67. <a href="#idm140737321597792"><code class="function">lib.strings.getName</code> usage example</a></dt><dt>5.68. <a href="#idm140737321589264"><code class="function">lib.strings.getVersion</code> usage example</a></dt><dt>5.69. <a href="#idm140737321578832"><code class="function">lib.strings.nameFromURL</code> usage example</a></dt><dt>5.70. <a href="#idm140737321568208"><code class="function">lib.strings.enableFeature</code> usage example</a></dt><dt>5.71. <a href="#idm140737321555248"><code class="function">lib.strings.enableFeatureAs</code> usage example</a></dt><dt>5.72. <a href="#idm140737321544400"><code class="function">lib.strings.withFeature</code> usage example</a></dt><dt>5.73. <a href="#idm140737321531760"><code class="function">lib.strings.withFeatureAs</code> usage example</a></dt><dt>5.74. <a href="#idm140737321517680"><code class="function">lib.strings.fixedWidthString</code> usage example</a></dt><dt>5.75. <a href="#idm140737321507264"><code class="function">lib.strings.fixedWidthNumber</code> usage example</a></dt><dt>5.76. <a href="#idm140737321498704"><code class="function">lib.strings.floatToString</code> usage example</a></dt><dt>5.77. <a href="#idm140737321483312"><code class="function">lib.strings.isStorePath</code> usage example</a></dt><dt>5.78. <a href="#idm140737321473920"><code class="function">lib.strings.toInt</code> usage example</a></dt><dt>5.79. <a href="#idm140737321467264"><code class="function">lib.strings.readPathsFromFile</code> usage example</a></dt><dt>5.80. <a href="#idm140737321457632"><code class="function">lib.strings.fileContents</code> usage example</a></dt><dt>5.81. <a href="#idm140737321448320"><code class="function">lib.strings.sanitizeDerivationName</code> usage example</a></dt><dt>5.82. <a href="#idm140737321425872"><code class="function">lib.trivial.const</code> usage example</a></dt><dt>5.83. <a href="#idm140737321414544"><code class="function">lib.trivial.pipe</code> usage example</a></dt><dt>5.84. <a href="#idm140737321351008"><code class="function">lib.trivial.mergeAttrs</code> usage example</a></dt><dt>5.85. <a href="#idm140737321337760"><code class="function">lib.trivial.flip</code> usage example</a></dt><dt>5.86. <a href="#idm140737321327456"><code class="function">lib.trivial.mapNullable</code> usage example</a></dt><dt>5.87. <a href="#idm140737321268704"><code class="function">lib.trivial.mod</code> usage example</a></dt><dt>5.88. <a href="#idm140737321241776"><code class="function">lib.trivial.splitByAndCompare</code> usage example</a></dt><dt>5.89. <a href="#idm140737321172064"><code class="function">lib.lists.singleton</code> usage example</a></dt><dt>5.90. <a href="#idm140737321161008"><code class="function">lib.lists.forEach</code> usage example</a></dt><dt>5.91. <a href="#idm140737321147408"><code class="function">lib.lists.foldr</code> usage example</a></dt><dt>5.92. <a href="#idm140737321129648"><code class="function">lib.lists.foldl</code> usage example</a></dt><dt>5.93. <a href="#idm140737321112640"><code class="function">lib.lists.imap0</code> usage example</a></dt><dt>5.94. <a href="#idm140737321101360"><code class="function">lib.lists.imap1</code> usage example</a></dt><dt>5.95. <a href="#idm140737321094592"><code class="function">lib.lists.concatMap</code> usage example</a></dt><dt>5.96. <a href="#idm140737321086096"><code class="function">lib.lists.flatten</code> usage example</a></dt><dt>5.97. <a href="#idm140737321076800"><code class="function">lib.lists.remove</code> usage example</a></dt><dt>5.98. <a href="#idm140737321061344"><code class="function">lib.lists.findSingle</code> usage example</a></dt><dt>5.99. <a href="#idm140737321047648"><code class="function">lib.lists.findFirst</code> usage example</a></dt><dt>5.100. <a href="#idm140737321040768"><code class="function">lib.lists.any</code> usage example</a></dt><dt>5.101. <a href="#idm140737321033920"><code class="function">lib.lists.all</code> usage example</a></dt><dt>5.102. <a href="#idm140737321024752"><code class="function">lib.lists.count</code> usage example</a></dt><dt>5.103. <a href="#idm140737321013568"><code class="function">lib.lists.optional</code> usage example</a></dt><dt>5.104. <a href="#idm140737321002320"><code class="function">lib.lists.optionals</code> usage example</a></dt><dt>5.105. <a href="#idm140737320994000"><code class="function">lib.lists.toList</code> usage example</a></dt><dt>5.106. <a href="#idm140737320982688"><code class="function">lib.lists.range</code> usage example</a></dt><dt>5.107. <a href="#idm140737320975856"><code class="function">lib.lists.partition</code> usage example</a></dt><dt>5.108. <a href="#idm140737320960720"><code class="function">lib.lists.groupBy'</code> usage example</a></dt><dt>5.109. <a href="#idm140737320945904"><code class="function">lib.lists.zipListsWith</code> usage example</a></dt><dt>5.110. <a href="#idm140737320939008"><code class="function">lib.lists.zipLists</code> usage example</a></dt><dt>5.111. <a href="#idm140737320929760"><code class="function">lib.lists.reverseList</code> usage example</a></dt><dt>5.112. <a href="#idm140737320916736"><code class="function">lib.lists.listDfs</code> usage example</a></dt><dt>5.113. <a href="#idm140737320904896"><code class="function">lib.lists.toposort</code> usage example</a></dt><dt>5.114. <a href="#idm140737320898032"><code class="function">lib.lists.sort</code> usage example</a></dt><dt>5.115. <a href="#idm140737320885792"><code class="function">lib.lists.compareLists</code> usage example</a></dt><dt>5.116. <a href="#idm140737320877024"><code class="function">lib.lists.naturalSort</code> usage example</a></dt><dt>5.117. <a href="#idm140737320867616"><code class="function">lib.lists.take</code> usage example</a></dt><dt>5.118. <a href="#idm140737320856416"><code class="function">lib.lists.drop</code> usage example</a></dt><dt>5.119. <a href="#idm140737320843040"><code class="function">lib.lists.sublist</code> usage example</a></dt><dt>5.120. <a href="#idm140737320833232"><code class="function">lib.lists.last</code> usage example</a></dt><dt>5.121. <a href="#idm140737320823424"><code class="function">lib.lists.init</code> usage example</a></dt><dt>5.122. <a href="#idm140737320817440"><code class="function">lib.lists.crossLists</code> usage example</a></dt><dt>5.123. <a href="#idm140737320810592"><code class="function">lib.lists.unique</code> usage example</a></dt><dt>5.124. <a href="#idm140737320802176"><code class="function">lib.lists.intersectLists</code> usage example</a></dt><dt>5.125. <a href="#idm140737320793648"><code class="function">lib.lists.subtractLists</code> usage example</a></dt><dt>5.126. <a href="#idm140737320768864"><code class="function">lib.debug.traceIf</code> usage example</a></dt><dt>5.127. <a href="#idm140737320757600"><code class="function">lib.debug.traceValFn</code> usage example</a></dt><dt>5.128. <a href="#idm140737320750768"><code class="function">lib.debug.traceVal</code> usage example</a></dt><dt>5.129. <a href="#idm140737320739552"><code class="function">lib.debug.traceSeq</code> usage example</a></dt><dt>5.130. <a href="#idm140737320726896"><code class="function">lib.debug.traceSeqN</code> usage example</a></dt><dt>5.131. <a href="#idm140737320683344"><code class="function">lib.debug.traceFnSeqN</code> usage example</a></dt><dt>5.132. <a href="#idm140737320666432"><code class="function">lib.debug.testAllTrue</code> usage example</a></dt><dt>5.133. <a href="#idm140737320656960"><code class="function">lib.options.isOption</code> usage example</a></dt><dt>5.134. <a href="#idm140737320625040"><code class="function">lib.options.mkOption</code> usage example</a></dt><dt>5.135. <a href="#idm140737320616368"><code class="function">lib.options.mkEnableOption</code> usage example</a></dt><dt>5.136. <a href="#idm140737320593056"><code class="function">lib.options.getValues</code> usage example</a></dt><dt>5.137. <a href="#idm140737320586176"><code class="function">lib.options.getFiles</code> usage example</a></dt><dt>5.138. <a href="#idm140737320563472"><code class="function">lib.options.showOption</code> usage example</a></dt></dl></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="preface"></a>Chapter 1. Preface</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#overview-of-nixpkgs">1.1. Overview of Nixpkgs</a></span></dt></dl></div><p>
   The Nix Packages collection (Nixpkgs) is a set of thousands of packages for the <a class="link" href="https://nixos.org/nix/" target="_top">Nix package manager</a>, released under a <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/COPYING" target="_top">permissive MIT/X11 license</a>. Packages are available for several platforms, and can be used with the Nix package manager on most GNU/Linux distributions as well as <a class="link" href="https://nixos.org/nixos" target="_top">NixOS</a>.
  </p><p>
   This manual primarily describes how to write packages for the Nix Packages collection (Nixpkgs). Thus it’s mainly for packagers and developers who want to add packages to Nixpkgs. If you like to learn more about the Nix package manager and the Nix expression language, then you are kindly referred to the <a class="link" href="https://nixos.org/nix/manual/" target="_top">Nix manual</a>. The NixOS distribution is documented in the <a class="link" href="https://nixos.org/nixos/manual/" target="_top">NixOS manual</a>.
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="overview-of-nixpkgs"></a>1.1. Overview of Nixpkgs</h2></div></div></div><p>
    Nix expressions describe how to build packages from source and are collected in the <a class="link" href="https://github.com/NixOS/nixpkgs" target="_top">nixpkgs repository</a>. Also included in the collection are Nix expressions for <a class="link" href="https://nixos.org/nixos/manual/index.html#sec-writing-modules" target="_top">NixOS modules</a>. With these expressions the Nix package manager can build binary packages.
   </p><p>
    Packages, including the Nix packages collection, are distributed through <a class="link" href="https://nixos.org/nix/manual/#sec-channels" target="_top">channels</a>. The collection is distributed for users of Nix on non-NixOS distributions through the channel <code class="literal">nixpkgs</code>. Users of NixOS generally use one of the <code class="literal">nixos-*</code> channels, e.g. <code class="literal">nixos-19.09</code>, which includes all packages and modules for the stable NixOS 19.09. Stable NixOS releases are generally only given security updates. More up to date packages and modules are available via the <code class="literal">nixos-unstable</code> channel.
   </p><p>
    Both <code class="literal">nixos-unstable</code> and <code class="literal">nixpkgs</code> follow the <code class="literal">master</code> branch of the Nixpkgs repository, although both do lag the <code class="literal">master</code> branch by generally <a class="link" href="https://status.nixos.org/" target="_top">a couple of days</a>. Updates to a channel are distributed as soon as all tests for that channel pass, e.g. <a class="link" href="https://hydra.nixos.org/job/nixpkgs/trunk/unstable#tabs-constituents" target="_top">this table</a> shows the status of tests for the <code class="literal">nixpkgs</code> channel.
   </p><p>
    The tests are conducted by a cluster called <a class="link" href="https://nixos.org/hydra/" target="_top">Hydra</a>, which also builds binary packages from the Nix expressions in Nixpkgs for <code class="literal">x86_64-linux</code>, <code class="literal">i686-linux</code> and <code class="literal">x86_64-darwin</code>. The binaries are made available via a <a class="link" href="https://cache.nixos.org" target="_top">binary cache</a>.
   </p><p>
    The current Nix expressions of the channels are available in the <a class="link" href="https://github.com/NixOS/nixpkgs" target="_top"><code class="literal">nixpkgs</code></a> repository in branches that correspond to the channel names (e.g. <code class="literal">nixos-19.09-small</code>).
   </p></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="idm140737322633760"></a>Part I. Using Nixpkgs</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="#chap-packageconfig">2. Global configuration</a></span></dt><dt><span class="chapter"><a href="#chap-overlays">3. Overlays</a></span></dt><dt><span class="chapter"><a href="#chap-overrides">4. Overriding</a></span></dt><dt><span class="chapter"><a href="#chap-functions">5. Functions reference</a></span></dt></dl></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-packageconfig"></a>Chapter 2. Global configuration</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-allow-broken">2.1. Installing broken packages</a></span></dt><dt><span class="section"><a href="#sec-allow-unsupported-system">2.2. Installing packages on unsupported systems</a></span></dt><dt><span class="section"><a href="#sec-allow-unfree">2.3. Installing unfree packages</a></span></dt><dt><span class="section"><a href="#sec-allow-insecure">2.4. Installing insecure packages</a></span></dt><dt><span class="section"><a href="#sec-modify-via-packageOverrides">2.5. Modify packages via <code class="literal">packageOverrides</code></a></span></dt><dt><span class="section"><a href="#sec-declarative-package-management">2.6. Declarative Package Management</a></span></dt></dl></div><p>
    Nix comes with certain defaults about what packages can and cannot be installed, based on a package's metadata. By default, Nix will prevent installation if any of the following criteria are true:
   </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
      The package is thought to be broken, and has had its <code class="literal">meta.broken</code> set to <code class="literal">true</code>.
     </p></li><li class="listitem"><p>
      The package isn't intended to run on the given system, as none of its <code class="literal">meta.platforms</code> match the given system.
     </p></li><li class="listitem"><p>
      The package's <code class="literal">meta.license</code> is set to a license which is considered to be unfree.
     </p></li><li class="listitem"><p>
      The package has known security vulnerabilities but has not or can not be updated for some reason, and a list of issues has been entered in to the package's <code class="literal">meta.knownVulnerabilities</code>.
     </p></li></ul></div><p>
    Note that all this is checked during evaluation already, and the check includes any package that is evaluated. In particular, all build-time dependencies are checked. <code class="literal">nix-env -qa</code> will (attempt to) hide any packages that would be refused.
   </p><p>
    Each of these criteria can be altered in the nixpkgs configuration.
   </p><p>
    The nixpkgs configuration for a NixOS system is set in the <code class="literal">configuration.nix</code>, as in the following example:
</p><pre class="programlisting">
{
  nixpkgs.config = {
    allowUnfree = true;
  };
}
</pre><p>
    However, this does not allow unfree software for individual users. Their configurations are managed separately.
   </p><p>
    A user's nixpkgs configuration is stored in a user-specific configuration file located at <code class="filename">~/.config/nixpkgs/config.nix</code>. For example:
</p><pre class="programlisting">
{
  allowUnfree = true;
}
</pre><p>
   </p><p>
    Note that we are not able to test or build unfree software on Hydra due to policy. Most unfree licenses prohibit us from either executing or distributing the software.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-allow-broken"></a>2.1. Installing broken packages</h2></div></div></div><p>
     There are two ways to try compiling a package which has been marked as broken.
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       For allowing the build of a broken package once, you can use an environment variable for a single invocation of the nix tools:
</p><pre class="screen"><code class="prompt">$ </code>export NIXPKGS_ALLOW_BROKEN=1</pre><p>
      </p></li><li class="listitem"><p>
       For permanently allowing broken packages to be built, you may add <code class="literal">allowBroken = true;</code> to your user's configuration file, like this:
</p><pre class="programlisting">
{
  allowBroken = true;
}
</pre><p>
      </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-allow-unsupported-system"></a>2.2. Installing packages on unsupported systems</h2></div></div></div><p>
     There are also two ways to try compiling a package which has been marked as unsupported for the given system.
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       For allowing the build of an unsupported package once, you can use an environment variable for a single invocation of the nix tools:
</p><pre class="screen"><code class="prompt">$ </code>export NIXPKGS_ALLOW_UNSUPPORTED_SYSTEM=1</pre><p>
      </p></li><li class="listitem"><p>
       For permanently allowing unsupported packages to be built, you may add <code class="literal">allowUnsupportedSystem = true;</code> to your user's configuration file, like this:
</p><pre class="programlisting">
{
  allowUnsupportedSystem = true;
}
</pre><p>
      </p></li></ul></div><p>
     The difference between a package being unsupported on some system and being broken is admittedly a bit fuzzy. If a program <span class="emphasis"><em>ought</em></span> to work on a certain platform, but doesn't, the platform should be included in <code class="literal">meta.platforms</code>, but marked as broken with e.g. <code class="literal">meta.broken = !hostPlatform.isWindows</code>. Of course, this begs the question of what "ought" means exactly. That is left to the package maintainer.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-allow-unfree"></a>2.3. Installing unfree packages</h2></div></div></div><p>
     There are several ways to tweak how Nix handles a package which has been marked as unfree.
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       To temporarily allow all unfree packages, you can use an environment variable for a single invocation of the nix tools:
</p><pre class="screen"><code class="prompt">$ </code>export NIXPKGS_ALLOW_UNFREE=1</pre><p>
      </p></li><li class="listitem"><p>
       It is possible to permanently allow individual unfree packages, while still blocking unfree packages by default using the <code class="literal">allowUnfreePredicate</code> configuration option in the user configuration file.
      </p><p>
       This option is a function which accepts a package as a parameter, and returns a boolean. The following example configuration accepts a package and always returns false:
</p><pre class="programlisting">
{
  allowUnfreePredicate = (pkg: false);
}
</pre><p>
      </p><p>
       For a more useful example, try the following. This configuration only allows unfree packages named roon-server and visual studio code:
</p><pre class="programlisting">
{
  allowUnfreePredicate = pkg: builtins.elem (lib.getName pkg) [
    "roon-server"
    "vscode"
  ];
}
</pre><p>
      </p></li><li class="listitem"><p>
       It is also possible to allow and block licenses that are specifically acceptable or not acceptable, using <code class="literal">allowlistedLicenses</code> and <code class="literal">blocklistedLicenses</code>, respectively.
      </p><p>
       The following example configuration allowlists the licenses <code class="literal">amd</code> and <code class="literal">wtfpl</code>:
</p><pre class="programlisting">
{
  allowlistedLicenses = with lib.licenses; [ amd wtfpl ];
}
</pre><p>
      </p><p>
       The following example configuration blocklists the <code class="literal">gpl3Only</code> and <code class="literal">agpl3Only</code> licenses:
</p><pre class="programlisting">
{
  blocklistedLicenses = with lib.licenses; [ agpl3Only gpl3Only ];
}
</pre><p>
      </p><p>
       Note that <code class="literal">allowlistedLicenses</code> only applies to unfree licenses unless <code class="literal">allowUnfree</code> is enabled. It is not a generic allowlist for all types of licenses. <code class="literal">blocklistedLicenses</code> applies to all licenses.
      </p></li></ul></div><p>
     A complete list of licenses can be found in the file <code class="filename">lib/licenses.nix</code> of the nixpkgs tree.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-allow-insecure"></a>2.4. Installing insecure packages</h2></div></div></div><p>
     There are several ways to tweak how Nix handles a package which has been marked as insecure.
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       To temporarily allow all insecure packages, you can use an environment variable for a single invocation of the nix tools:
</p><pre class="screen"><code class="prompt">$ </code>export NIXPKGS_ALLOW_INSECURE=1</pre><p>
      </p></li><li class="listitem"><p>
       It is possible to permanently allow individual insecure packages, while still blocking other insecure packages by default using the <code class="literal">permittedInsecurePackages</code> configuration option in the user configuration file.
      </p><p>
       The following example configuration permits the installation of the hypothetically insecure package <code class="literal">hello</code>, version <code class="literal">1.2.3</code>:
</p><pre class="programlisting">
{
  permittedInsecurePackages = [
    "hello-1.2.3"
  ];
}
</pre><p>
      </p></li><li class="listitem"><p>
       It is also possible to create a custom policy around which insecure packages to allow and deny, by overriding the <code class="literal">allowInsecurePredicate</code> configuration option.
      </p><p>
       The <code class="literal">allowInsecurePredicate</code> option is a function which accepts a package and returns a boolean, much like <code class="literal">allowUnfreePredicate</code>.
      </p><p>
       The following configuration example only allows insecure packages with very short names:
</p><pre class="programlisting">
{
  allowInsecurePredicate = pkg: builtins.stringLength (lib.getName pkg) &lt;= 5;
}
</pre><p>
      </p><p>
       Note that <code class="literal">permittedInsecurePackages</code> is only checked if <code class="literal">allowInsecurePredicate</code> is not specified.
      </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-modify-via-packageOverrides"></a>2.5. Modify packages via <code class="literal">packageOverrides</code></h2></div></div></div><p>
     You can define a function called <code class="varname">packageOverrides</code> in your local <code class="filename">~/.config/nixpkgs/config.nix</code> to override Nix packages. It must be a function that takes pkgs as an argument and returns a modified set of packages.
</p><pre class="programlisting">
{
  packageOverrides = pkgs: rec {
    foo = pkgs.foo.override { ... };
  };
}
</pre><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-declarative-package-management"></a>2.6. Declarative Package Management</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-building-environment"></a>2.6.1. Build an environment</h3></div></div></div><p>
      Using <code class="literal">packageOverrides</code>, it is possible to manage packages declaratively. This means that we can list all of our desired packages within a declarative Nix expression. For example, to have <code class="literal">aspell</code>, <code class="literal">bc</code>, <code class="literal">ffmpeg</code>, <code class="literal">coreutils</code>, <code class="literal">gdb</code>, <code class="literal">nixUnstable</code>, <code class="literal">emscripten</code>, <code class="literal">jq</code>, <code class="literal">nox</code>, and <code class="literal">silver-searcher</code>, we could use the following in <code class="filename">~/.config/nixpkgs/config.nix</code>:
     </p><pre class="screen">
{
  packageOverrides = pkgs: with pkgs; {
    myPackages = pkgs.buildEnv {
      name = "my-packages";
      paths = [
        aspell
        bc
        coreutils
        gdb
        ffmpeg
        nixUnstable
        emscripten
        jq
        nox
        silver-searcher
      ];
    };
  };
}
</pre><p>
      To install it into our environment, you can just run <code class="literal">nix-env -iA nixpkgs.myPackages</code>. If you want to load the packages to be built from a working copy of <code class="literal">nixpkgs</code> you just run <code class="literal">nix-env -f. -iA myPackages</code>. To explore what's been installed, just look through <code class="filename">~/.nix-profile/</code>. You can see that a lot of stuff has been installed. Some of this stuff is useful some of it isn't. Let's tell Nixpkgs to only link the stuff that we want:
     </p><pre class="screen">
{
  packageOverrides = pkgs: with pkgs; {
    myPackages = pkgs.buildEnv {
      name = "my-packages";
      paths = [
        aspell
        bc
        coreutils
        gdb
        ffmpeg
        nixUnstable
        emscripten
        jq
        nox
        silver-searcher
      ];
      pathsToLink = [ "/share" "/bin" ];
    };
  };
}
</pre><p>
      <code class="literal">pathsToLink</code> tells Nixpkgs to only link the paths listed which gets rid of the extra stuff in the profile. <code class="filename">/bin</code> and <code class="filename">/share</code> are good defaults for a user environment, getting rid of the clutter. If you are running on Nix on MacOS, you may want to add another path as well, <code class="filename">/Applications</code>, that makes GUI apps available.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-getting-documentation"></a>2.6.2. Getting documentation</h3></div></div></div><p>
      After building that new environment, look through <code class="filename">~/.nix-profile</code> to make sure everything is there that we wanted. Discerning readers will note that some files are missing. Look inside <code class="filename">~/.nix-profile/share/man/man1/</code> to verify this. There are no man pages for any of the Nix tools! This is because some packages like Nix have multiple outputs for things like documentation (see section 4). Let's make Nix install those as well.
     </p><pre class="screen">
{
  packageOverrides = pkgs: with pkgs; {
    myPackages = pkgs.buildEnv {
      name = "my-packages";
      paths = [
        aspell
        bc
        coreutils
        ffmpeg
        nixUnstable
        emscripten
        jq
        nox
        silver-searcher
      ];
      pathsToLink = [ "/share/man" "/share/doc" "/bin" ];
      extraOutputsToInstall = [ "man" "doc" ];
    };
  };
}
</pre><p>
      This provides us with some useful documentation for using our packages. However, if we actually want those manpages to be detected by man, we need to set up our environment. This can also be managed within Nix expressions.
     </p><pre class="screen">
{
  packageOverrides = pkgs: with pkgs; rec {
    myProfile = writeText "my-profile" ''
      export PATH=$HOME/.nix-profile/bin:/nix/var/nix/profiles/default/bin:/sbin:/bin:/usr/sbin:/usr/bin
      export MANPATH=$HOME/.nix-profile/share/man:/nix/var/nix/profiles/default/share/man:/usr/share/man
    '';
    myPackages = pkgs.buildEnv {
      name = "my-packages";
      paths = [
        (runCommand "profile" {} ''
          mkdir -p $out/etc/profile.d
          cp ${myProfile} $out/etc/profile.d/my-profile.sh
        '')
        aspell
        bc
        coreutils
        ffmpeg
        man
        nixUnstable
        emscripten
        jq
        nox
        silver-searcher
      ];
      pathsToLink = [ "/share/man" "/share/doc" "/bin" "/etc" ];
      extraOutputsToInstall = [ "man" "doc" ];
    };
  };
}
</pre><p>
      For this to work fully, you must also have this script sourced when you are logged in. Try adding something like this to your <code class="filename">~/.profile</code> file:
     </p><pre class="screen">
#!/bin/sh
if [ -d $HOME/.nix-profile/etc/profile.d ]; then
  for i in $HOME/.nix-profile/etc/profile.d/*.sh; do
    if [ -r $i ]; then
      . $i
    fi
  done
fi
</pre><p>
      Now just run <code class="literal">source $HOME/.profile</code> and you can starting loading man pages from your environment.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-gnu-info-setup"></a>2.6.3. GNU info setup</h3></div></div></div><p>
      Configuring GNU info is a little bit trickier than man pages. To work correctly, info needs a database to be generated. This can be done with some small modifications to our environment scripts.
     </p><pre class="screen">
{
  packageOverrides = pkgs: with pkgs; rec {
    myProfile = writeText "my-profile" ''
      export PATH=$HOME/.nix-profile/bin:/nix/var/nix/profiles/default/bin:/sbin:/bin:/usr/sbin:/usr/bin
      export MANPATH=$HOME/.nix-profile/share/man:/nix/var/nix/profiles/default/share/man:/usr/share/man
      export INFOPATH=$HOME/.nix-profile/share/info:/nix/var/nix/profiles/default/share/info:/usr/share/info
    '';
    myPackages = pkgs.buildEnv {
      name = "my-packages";
      paths = [
        (runCommand "profile" {} ''
          mkdir -p $out/etc/profile.d
          cp ${myProfile} $out/etc/profile.d/my-profile.sh
        '')
        aspell
        bc
        coreutils
        ffmpeg
        man
        nixUnstable
        emscripten
        jq
        nox
        silver-searcher
        texinfoInteractive
      ];
      pathsToLink = [ "/share/man" "/share/doc" "/share/info" "/bin" "/etc" ];
      extraOutputsToInstall = [ "man" "doc" "info" ];
      postBuild = ''
        if [ -x $out/bin/install-info -a -w $out/share/info ]; then
          shopt -s nullglob
          for i in $out/share/info/*.info $out/share/info/*.info.gz; do
              $out/bin/install-info $i $out/share/info/dir
          done
        fi
      '';
    };
  };
}
</pre><p>
      <code class="literal">postBuild</code> tells Nixpkgs to run a command after building the environment. In this case, <code class="literal">install-info</code> adds the installed info pages to <code class="literal">dir</code> which is GNU info's default root node. Note that <code class="literal">texinfoInteractive</code> is added to the environment to give the <code class="literal">install-info</code> command.
     </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-overlays"></a>Chapter 3. Overlays</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-overlays-install">3.1. Installing overlays</a></span></dt><dt><span class="section"><a href="#sec-overlays-definition">3.2. Defining overlays</a></span></dt><dt><span class="section"><a href="#sec-overlays-alternatives">3.3. Using overlays to configure alternatives</a></span></dt></dl></div><p>
    This chapter describes how to extend and change Nixpkgs using overlays. Overlays are used to add layers in the fixed-point used by Nixpkgs to compose the set of all packages.
   </p><p>
    Nixpkgs can be configured with a list of overlays, which are applied in order. This means that the order of the overlays can be significant if multiple layers override the same package.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-overlays-install"></a>3.1. Installing overlays</h2></div></div></div><p>
     The list of overlays can be set either explicitly in a Nix expression, or through <code class="literal">&lt;nixpkgs-overlays&gt;</code> or user configuration files.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-overlays-argument"></a>3.1.1. Set overlays in NixOS or Nix expressions</h3></div></div></div><p>
      On a NixOS system the value of the <code class="literal">nixpkgs.overlays</code> option, if present, is passed to the system Nixpkgs directly as an argument. Note that this does not affect the overlays for non-NixOS operations (e.g. <code class="literal">nix-env</code>), which are <a class="link" href="#sec-overlays-lookup" title="3.1.2. Install overlays via configuration lookup">looked</a> up independently.
     </p><p>
      The list of overlays can be passed explicitly when importing nixpkgs, for example <code class="literal">import &lt;nixpkgs&gt; { overlays = [ overlay1 overlay2 ]; }</code>.
     </p><p>
      NOTE: DO NOT USE THIS in nixpkgs. Further overlays can be added by calling the <code class="literal">pkgs.extend</code> or <code class="literal">pkgs.appendOverlays</code>, although it is often preferable to avoid these functions, because they recompute the Nixpkgs fixpoint, which is somewhat expensive to do.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-overlays-lookup"></a>3.1.2. Install overlays via configuration lookup</h3></div></div></div><p>
      The list of overlays is determined as follows.
     </p><p>
      </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
         First, if an <a class="link" href="#sec-overlays-argument" title="3.1.1. Set overlays in NixOS or Nix expressions"><code class="varname">overlays</code> argument</a> to the Nixpkgs function itself is given, then that is used and no path lookup will be performed.
        </p></li><li class="listitem"><p>
         Otherwise, if the Nix path entry <code class="literal">&lt;nixpkgs-overlays&gt;</code> exists, we look for overlays at that path, as described below.
        </p><p>
         See the section on <code class="literal">NIX_PATH</code> in the Nix manual for more details on how to set a value for <code class="literal">&lt;nixpkgs-overlays&gt;.</code>
        </p></li><li class="listitem"><p>
         If one of <code class="filename">~/.config/nixpkgs/overlays.nix</code> and <code class="filename">~/.config/nixpkgs/overlays/</code> exists, then we look for overlays at that path, as described below. It is an error if both exist.
        </p></li></ol></div><p>
     </p><p>
      If we are looking for overlays at a path, then there are two cases:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
         If the path is a file, then the file is imported as a Nix expression and used as the list of overlays.
        </p></li><li class="listitem"><p>
         If the path is a directory, then we take the content of the directory, order it lexicographically, and attempt to interpret each as an overlay by:
         </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
            Importing the file, if it is a <code class="literal">.nix</code> file.
           </p></li><li class="listitem"><p>
            Importing a top-level <code class="filename">default.nix</code> file, if it is a directory.
           </p></li></ul></div><p>
        </p></li></ul></div><p>
     </p><p>
      Because overlays that are set in NixOS configuration do not affect non-NixOS operations such as <code class="literal">nix-env</code>, the <code class="filename">overlays.nix</code> option provides a convenient way to use the same overlays for a NixOS system configuration and user configuration: the same file can be used as <code class="filename">overlays.nix</code> and imported as the value of <code class="literal">nixpkgs.overlays</code>.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-overlays-definition"></a>3.2. Defining overlays</h2></div></div></div><p>
     Overlays are Nix functions which accept two arguments, conventionally called <code class="varname">self</code> and <code class="varname">super</code>, and return a set of packages. For example, the following is a valid overlay.
    </p><pre class="programlisting">
self: super:

{
  boost = super.boost.override {
    python = self.python3;
  };
  rr = super.callPackage ./pkgs/rr {
    stdenv = self.stdenv_32bit;
  };
}
</pre><p>
     The first argument (<code class="varname">self</code>) corresponds to the final package set. You should use this set for the dependencies of all packages specified in your overlay. For example, all the dependencies of <code class="varname">rr</code> in the example above come from <code class="varname">self</code>, as well as the overridden dependencies used in the <code class="varname">boost</code> override.
    </p><p>
     The second argument (<code class="varname">super</code>) corresponds to the result of the evaluation of the previous stages of Nixpkgs. It does not contain any of the packages added by the current overlay, nor any of the following overlays. This set should be used either to refer to packages you wish to override, or to access functions defined in Nixpkgs. For example, the original recipe of <code class="varname">boost</code> in the above example, comes from <code class="varname">super</code>, as well as the <code class="varname">callPackage</code> function.
    </p><p>
     The value returned by this function should be a set similar to <code class="filename">pkgs/top-level/all-packages.nix</code>, containing overridden and/or new packages.
    </p><p>
     Overlays are similar to other methods for customizing Nixpkgs, in particular the <code class="literal">packageOverrides</code> attribute described in <a class="xref" href="#sec-modify-via-packageOverrides" title="2.5. Modify packages via packageOverrides">Section 2.5, “Modify packages via <code class="literal">packageOverrides</code>”</a>. Indeed, <code class="literal">packageOverrides</code> acts as an overlay with only the <code class="varname">super</code> argument. It is therefore appropriate for basic use, but overlays are more powerful and easier to distribute.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-overlays-alternatives"></a>3.3. Using overlays to configure alternatives</h2></div></div></div><p>
     Certain software packages have different implementations of the same interface. Other distributions have functionality to switch between these. For example, Debian provides <a class="link" href="https://wiki.debian.org/DebianAlternatives" target="_top">DebianAlternatives</a>. Nixpkgs has what we call <code class="literal">alternatives</code>, which are configured through overlays.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-overlays-alternatives-blas-lapack"></a>3.3.1. BLAS/LAPACK</h3></div></div></div><p>
      In Nixpkgs, we have multiple implementations of the BLAS/LAPACK numerical linear algebra interfaces. They are:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <a class="link" href="https://www.openblas.net/" target="_top">OpenBLAS</a>
       </p><p>
        The Nixpkgs attribute is <code class="literal">openblas</code> for ILP64 (integer width = 64 bits) and <code class="literal">openblasCompat</code> for LP64 (integer width = 32 bits). <code class="literal">openblasCompat</code> is the default.
       </p></li><li class="listitem"><p>
        <a class="link" href="http://www.netlib.org/lapack/" target="_top">LAPACK reference</a> (also provides BLAS)
       </p><p>
        The Nixpkgs attribute is <code class="literal">lapack-reference</code>.
       </p></li><li class="listitem"><p>
        <a class="link" href="https://software.intel.com/en-us/mkl" target="_top">Intel MKL</a> (only works on the x86_64 architecture, unfree)
       </p><p>
        The Nixpkgs attribute is <code class="literal">mkl</code>.
       </p></li><li class="listitem"><p>
        <a class="link" href="https://github.com/flame/blis" target="_top">BLIS</a>
       </p><p>
        BLIS, available through the attribute <code class="literal">blis</code>, is a framework for linear algebra kernels. In addition, it implements the BLAS interface.
       </p></li><li class="listitem"><p>
        <a class="link" href="https://developer.amd.com/amd-aocl/blas-library/" target="_top">AMD BLIS/LIBFLAME</a> (optimized for modern AMD x86_64 CPUs)
       </p><p>
        The AMD fork of the BLIS library, with attribute <code class="literal">amd-blis</code>, extends BLIS with optimizations for modern AMD CPUs. The changes are usually submitted to the upstream BLIS project after some time. However, AMD BLIS typically provides some performance improvements on AMD Zen CPUs. The complementary AMD LIBFLAME library, with attribute <code class="literal">amd-libflame</code>, provides a LAPACK implementation.
       </p></li></ul></div><p>
      Introduced in <a class="link" href="https://github.com/NixOS/nixpkgs/pull/83888" target="_top">PR #83888</a>, we are able to override the <code class="literal">blas</code> and <code class="literal">lapack</code> packages to use different implementations, through the <code class="literal">blasProvider</code> and <code class="literal">lapackProvider</code> argument. This can be used to select a different provider. BLAS providers will have symlinks in <code class="literal">$out/lib/libblas.so.3</code> and <code class="literal">$out/lib/libcblas.so.3</code> to their respective BLAS libraries. Likewise, LAPACK providers will have symlinks in <code class="literal">$out/lib/liblapack.so.3</code> and <code class="literal">$out/lib/liblapacke.so.3</code> to their respective LAPACK libraries. For example, Intel MKL is both a BLAS and LAPACK provider. An overlay can be created to use Intel MKL that looks like:
     </p><pre class="programlisting">
self: super:

{
  blas = super.blas.override {
    blasProvider = self.mkl;
  };

  lapack = super.lapack.override {
    lapackProvider = self.mkl;
  };
}
</pre><p>
      This overlay uses Intel’s MKL library for both BLAS and LAPACK interfaces. Note that the same can be accomplished at runtime using <code class="literal">LD_LIBRARY_PATH</code> of <code class="literal">libblas.so.3</code> and <code class="literal">liblapack.so.3</code>. For instance:
     </p><pre class="screen">
<code class="prompt">$ </code>LD_LIBRARY_PATH=$(nix-build -A mkl)/lib:$LD_LIBRARY_PATH nix-shell -p octave --run octave
</pre><p>
      Intel MKL requires an <code class="literal">openmp</code> implementation when running with multiple processors. By default, <code class="literal">mkl</code> will use Intel’s <code class="literal">iomp</code> implementation if no other is specified, but this is a runtime-only dependency and binary compatible with the LLVM implementation. To use that one instead, Intel recommends users set it with <code class="literal">LD_PRELOAD</code>. Note that <code class="literal">mkl</code> is only available on <code class="literal">x86_64-linux</code> and <code class="literal">x86_64-darwin</code>. Moreover, Hydra is not building and distributing pre-compiled binaries using it.
     </p><p>
      For BLAS/LAPACK switching to work correctly, all packages must depend on <code class="literal">blas</code> or <code class="literal">lapack</code>. This ensures that only one BLAS/LAPACK library is used at one time. There are two versions of BLAS/LAPACK currently in the wild, <code class="literal">LP64</code> (integer size = 32 bits) and <code class="literal">ILP64</code> (integer size = 64 bits). Some software needs special flags or patches to work with <code class="literal">ILP64</code>. You can check if <code class="literal">ILP64</code> is used in Nixpkgs with <code class="varname">blas.isILP64</code> and <code class="varname">lapack.isILP64</code>. Some software does NOT work with <code class="literal">ILP64</code>, and derivations need to specify an assertion to prevent this. You can prevent <code class="literal">ILP64</code> from being used with the following:
     </p><pre class="programlisting">
{ stdenv, blas, lapack, ... }:

assert (!blas.isILP64) &amp;&amp; (!lapack.isILP64);

stdenv.mkDerivation {
  ...
}
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-overlays-alternatives-mpi"></a>3.3.2. Switching the MPI implementation</h3></div></div></div><p>
      All programs that are built with <a class="link" href="https://en.wikipedia.org/wiki/Message_Passing_Interface" target="_top">MPI</a> support use the generic attribute <code class="varname">mpi</code> as an input. At the moment Nixpkgs natively provides two different MPI implementations:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
         <a class="link" href="https://www.open-mpi.org/" target="_top">Open MPI</a> (default), attribute name <code class="varname">openmpi</code>
        </p></li><li class="listitem"><p>
         <a class="link" href="https://www.mpich.org/" target="_top">MPICH</a>, attribute name <code class="varname">mpich</code>
        </p></li></ul></div><p>
     </p><p>
      To provide MPI enabled applications that use <code class="literal">MPICH</code>, instead of the default <code class="literal">Open MPI</code>, simply use the following overlay:
     </p><pre class="programlisting">
self: super:

{
  mpi = self.mpich;
}
     </pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-overrides"></a>Chapter 4. Overriding</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-pkg-override">4.1. &lt;pkg&gt;.override</a></span></dt><dt><span class="section"><a href="#sec-pkg-overrideAttrs">4.2. &lt;pkg&gt;.overrideAttrs</a></span></dt><dt><span class="section"><a href="#sec-pkg-overrideDerivation">4.3. &lt;pkg&gt;.overrideDerivation</a></span></dt><dt><span class="section"><a href="#sec-lib-makeOverridable">4.4. lib.makeOverridable</a></span></dt></dl></div><p>
    Sometimes one wants to override parts of <code class="literal">nixpkgs</code>, e.g. derivation attributes, the results of derivations.
   </p><p>
    These functions are used to make changes to packages, returning only single packages. <a class="link" href="#chap-overlays" title="Chapter 3. Overlays">Overlays</a>, on the other hand, can be used to combine the overridden packages across the entire package set of Nixpkgs.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pkg-override"></a>4.1. &lt;pkg&gt;.override</h2></div></div></div><p>
     The function <code class="varname">override</code> is usually available for all the derivations in the nixpkgs expression (<code class="varname">pkgs</code>).
    </p><p>
     It is used to override the arguments passed to a function.
    </p><p>
     Example usages:
</p><pre class="programlisting">pkgs.foo.override { arg1 = val1; arg2 = val2; ... }</pre><p>

</p><pre class="programlisting">
import pkgs.path { overlays = [ (self: super: {
  foo = super.foo.override { barSupport = true ; };
  })]};
</pre><p>
</p><pre class="programlisting">
mypkg = pkgs.callPackage ./mypkg.nix {
  mydep = pkgs.mydep.override { ... };
  }
</pre><p>
    </p><p>
     In the first example, <code class="varname">pkgs.foo</code> is the result of a function call with some default arguments, usually a derivation. Using <code class="varname">pkgs.foo.override</code> will call the same function with the given new arguments.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pkg-overrideAttrs"></a>4.2. &lt;pkg&gt;.overrideAttrs</h2></div></div></div><p>
     The function <code class="varname">overrideAttrs</code> allows overriding the attribute set passed to a <code class="varname">stdenv.mkDerivation</code> call, producing a new derivation based on the original one. This function is available on all derivations produced by the <code class="varname">stdenv.mkDerivation</code> function, which is most packages in the nixpkgs expression <code class="varname">pkgs</code>.
    </p><p>
     Example usage:
</p><pre class="programlisting">
helloWithDebug = pkgs.hello.overrideAttrs (oldAttrs: rec {
  separateDebugInfo = true;
});
</pre><p>
    </p><p>
     In the above example, the <code class="varname">separateDebugInfo</code> attribute is overridden to be true, thus building debug info for <code class="varname">helloWithDebug</code>, while all other attributes will be retained from the original <code class="varname">hello</code> package.
    </p><p>
     The argument <code class="varname">oldAttrs</code> is conventionally used to refer to the attr set originally passed to <code class="varname">stdenv.mkDerivation</code>.
    </p><div class="note"><h3 class="title">Note</h3><p>
      Note that <code class="varname">separateDebugInfo</code> is processed only by the <code class="varname">stdenv.mkDerivation</code> function, not the generated, raw Nix derivation. Thus, using <code class="varname">overrideDerivation</code> will not work in this case, as it overrides only the attributes of the final derivation. It is for this reason that <code class="varname">overrideAttrs</code> should be preferred in (almost) all cases to <code class="varname">overrideDerivation</code>, i.e. to allow using <code class="varname">stdenv.mkDerivation</code> to process input arguments, as well as the fact that it is easier to use (you can use the same attribute names you see in your Nix code, instead of the ones generated (e.g. <code class="varname">buildInputs</code> vs <code class="varname">nativeBuildInputs</code>), and it involves less typing).
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pkg-overrideDerivation"></a>4.3. &lt;pkg&gt;.overrideDerivation</h2></div></div></div><div class="warning"><h3 class="title">Warning</h3><p>
      You should prefer <code class="varname">overrideAttrs</code> in almost all cases, see its documentation for the reasons why. <code class="varname">overrideDerivation</code> is not deprecated and will continue to work, but is less nice to use and does not have as many abilities as <code class="varname">overrideAttrs</code>.
     </p></div><div class="warning"><h3 class="title">Warning</h3><p>
      Do not use this function in Nixpkgs as it evaluates a Derivation before modifying it, which breaks package abstraction and removes error-checking of function arguments. In addition, this evaluation-per-function application incurs a performance penalty, which can become a problem if many overrides are used. It is only intended for ad-hoc customisation, such as in <code class="filename">~/.config/nixpkgs/config.nix</code>.
     </p></div><p>
     The function <code class="varname">overrideDerivation</code> creates a new derivation based on an existing one by overriding the original's attributes with the attribute set produced by the specified function. This function is available on all derivations defined using the <code class="varname">makeOverridable</code> function. Most standard derivation-producing functions, such as <code class="varname">stdenv.mkDerivation</code>, are defined using this function, which means most packages in the nixpkgs expression, <code class="varname">pkgs</code>, have this function.
    </p><p>
     Example usage:
</p><pre class="programlisting">
mySed = pkgs.gnused.overrideDerivation (oldAttrs: {
  name = "sed-4.2.2-pre";
  src = fetchurl {
    url = ftp://alpha.gnu.org/gnu/sed/sed-4.2.2-pre.tar.bz2;
    sha256 = "11nq06d131y4wmf3drm0yk502d2xc6n5qy82cg88rb9nqd2lj41k";
  };
  patches = [];
});
</pre><p>
    </p><p>
     In the above example, the <code class="varname">name</code>, <code class="varname">src</code>, and <code class="varname">patches</code> of the derivation will be overridden, while all other attributes will be retained from the original derivation.
    </p><p>
     The argument <code class="varname">oldAttrs</code> is used to refer to the attribute set of the original derivation.
    </p><div class="note"><h3 class="title">Note</h3><p>
      A package's attributes are evaluated *before* being modified by the <code class="varname">overrideDerivation</code> function. For example, the <code class="varname">name</code> attribute reference in <code class="varname">url = "mirror://gnu/hello/${name}.tar.gz";</code> is filled-in *before* the <code class="varname">overrideDerivation</code> function modifies the attribute set. This means that overriding the <code class="varname">name</code> attribute, in this example, *will not* change the value of the <code class="varname">url</code> attribute. Instead, we need to override both the <code class="varname">name</code> *and* <code class="varname">url</code> attributes.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-lib-makeOverridable"></a>4.4. lib.makeOverridable</h2></div></div></div><p>
     The function <code class="varname">lib.makeOverridable</code> is used to make the result of a function easily customizable. This utility only makes sense for functions that accept an argument set and return an attribute set.
    </p><p>
     Example usage:
</p><pre class="programlisting">
f = { a, b }: { result = a+b; };
c = lib.makeOverridable f { a = 1; b = 2; };
</pre><p>
    </p><p>
     The variable <code class="varname">c</code> is the value of the <code class="varname">f</code> function applied with some default arguments. Hence the value of <code class="varname">c.result</code> is <code class="literal">3</code>, in this example.
    </p><p>
     The variable <code class="varname">c</code> however also has some additional functions, like <a class="link" href="#sec-pkg-override" title="4.1. &lt;pkg&gt;.override">c.override</a> which can be used to override the default arguments. In this example the value of <code class="varname">(c.override { a = 4; }).result</code> is 6.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-functions"></a>Chapter 5. Functions reference</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-functions-library">5.1. Nixpkgs Library Functions</a></span></dt><dt><span class="section"><a href="#sec-generators">5.2. Generators</a></span></dt><dt><span class="section"><a href="#sec-debug">5.3. Debugging Nix Expressions</a></span></dt><dt><span class="section"><a href="#sec-prefer-remote-fetch">5.4. prefer-remote-fetch overlay</a></span></dt><dt><span class="section"><a href="#sec-pkgs-nix-gitignore">5.5. pkgs.nix-gitignore</a></span></dt></dl></div><p>
    The nixpkgs repository has several utility functions to manipulate Nix expressions.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-functions-library"></a>5.1. Nixpkgs Library Functions</h2></div></div></div><p>
     Nixpkgs provides a standard library at <code class="varname">pkgs.lib</code>, or through <code class="code">import &lt;nixpkgs/lib&gt;</code>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-functions-library-asserts"></a>5.1.1. Assert functions</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.asserts.assertMsg"></a>5.1.1.1. <code class="function">lib.asserts.assertMsg</code></h4></div><div><h5 class="subtitle"><code class="literal">assertMsg :: Bool -&gt; String -&gt; Bool</code>
      </h5></div></div></div><p><a id="lib.asserts.assertMsg"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/asserts.nix#L21" target="_top">lib/asserts.nix:21</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Print a trace message if <code class="literal">pred</code> is false.
      </p><p>
       Intended to be used to augment asserts with helpful error messages.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">pred</code>
        </span></dt><dd><p>
          Condition under which the <code class="varname">msg</code> should <span class="emphasis"><em>not</em></span> be printed.
         </p></dd><dt><span class="term">
         <code class="varname">msg</code>
        </span></dt><dd><p>
          Message to print.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.asserts.assertMsg-example-false"></a><p class="title"><strong>Example 5.1. Printing when the predicate is false</strong></p><div class="example-contents"><pre class="programlisting">
assert lib.asserts.assertMsg ("foo" == "bar") "foo is not bar, silly"
stderr&gt; trace: foo is not bar, silly
stderr&gt; assert failed
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.asserts.assertOneOf"></a>5.1.1.2. <code class="function">lib.asserts.assertOneOf</code></h4></div><div><h5 class="subtitle"><code class="literal">assertOneOf :: String -&gt; String -&gt;
      StringList -&gt; Bool</code>
      </h5></div></div></div><p><a id="lib.asserts.assertOneOf"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/asserts.nix#L38" target="_top">lib/asserts.nix:38</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Specialized <code class="function">asserts.assertMsg</code> for checking if <code class="varname">val</code> is one of the elements of <code class="varname">xs</code>. Useful for checking enums.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">name</code>
        </span></dt><dd><p>
          The name of the variable the user entered <code class="varname">val</code> into, for inclusion in the error message.
         </p></dd><dt><span class="term">
         <code class="varname">val</code>
        </span></dt><dd><p>
          The value of what the user provided, to be compared against the values in <code class="varname">xs</code>.
         </p></dd><dt><span class="term">
         <code class="varname">xs</code>
        </span></dt><dd><p>
          The list of valid values.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.asserts.assertOneOf-example"></a><p class="title"><strong>Example 5.2. Ensuring a user provided a possible value</strong></p><div class="example-contents"><pre class="programlisting">
let sslLibrary = "bearssl";
in lib.asserts.assertOneOf "sslLibrary" sslLibrary [ "openssl" "libressl" ];
=&gt; false
stderr&gt; trace: sslLibrary must be one of "openssl", "libressl", but is: "bearssl"
        </pre></div></div><br class="example-break" /></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-functions-library-attrset"></a>5.1.2. Attribute-Set Functions</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.attrByPath"></a>5.1.2.1. <code class="function">lib.attrset.attrByPath</code></h4></div><div><h5 class="subtitle"><code class="literal">attrByPath :: [String] -&gt; Any -&gt; AttrSet -&gt; Any</code>
      </h5></div></div></div><p><a id="lib.attrsets.attrByPath"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L24" target="_top">lib/attrsets.nix:24</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Return an attribute from within nested attribute sets.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">attrPath</code>
        </span></dt><dd><p>
          A list of strings representing the path through the nested attribute set <code class="varname">set</code>.
         </p></dd><dt><span class="term">
         <code class="varname">default</code>
        </span></dt><dd><p>
          Default value if <code class="varname">attrPath</code> does not resolve to an existing value.
         </p></dd><dt><span class="term">
         <code class="varname">set</code>
        </span></dt><dd><p>
          The nested attributeset to select values from.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrset.attrByPath-example-value-exists"></a><p class="title"><strong>Example 5.3. Extracting a value from a nested attribute set</strong></p><div class="example-contents"><pre class="programlisting">
let set = { a = { b = 3; }; };
in lib.attrsets.attrByPath [ "a" "b" ] 0 set
=&gt; 3
</pre></div></div><br class="example-break" /><div class="example"><a id="function-library-lib.attrset.attrByPath-example-default-value"></a><p class="title"><strong>Example 5.4. No value at the path, instead using the default</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.attrByPath [ "a" "b" ] 0 {}
=&gt; 0
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.hasAttrByPath"></a>5.1.2.2. <code class="function">lib.attrsets.hasAttrByPath</code></h4></div><div><h5 class="subtitle"><code class="literal">hasAttrByPath :: [String] -&gt; AttrSet -&gt; Bool</code>
      </h5></div></div></div><p><a id="lib.attrsets.hasAttrByPath"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L42" target="_top">lib/attrsets.nix:42</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Determine if an attribute exists within a nested attribute set.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">attrPath</code>
        </span></dt><dd><p>
          A list of strings representing the path through the nested attribute set <code class="varname">set</code>.
         </p></dd><dt><span class="term">
         <code class="varname">set</code>
        </span></dt><dd><p>
          The nested attributeset to check.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.hasAttrByPath-example"></a><p class="title"><strong>Example 5.5. A nested value does exist inside a set</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.hasAttrByPath
  [ "a" "b" "c" "d" ]
  { a = { b = { c = { d = 123; }; }; }; }
=&gt; true
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.setAttrByPath"></a>5.1.2.3. <code class="function">lib.attrsets.setAttrByPath</code></h4></div><div><h5 class="subtitle"><code class="literal">setAttrByPath :: [String] -&gt; Any -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.setAttrByPath"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L57" target="_top">lib/attrsets.nix:57</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Create a new attribute set with <code class="varname">value</code> set at the nested attribute location specified in <code class="varname">attrPath</code>.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">attrPath</code>
        </span></dt><dd><p>
          A list of strings representing the path through the nested attribute set.
         </p></dd><dt><span class="term">
         <code class="varname">value</code>
        </span></dt><dd><p>
          The value to set at the location described by <code class="varname">attrPath</code>.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.setAttrByPath-example"></a><p class="title"><strong>Example 5.6. Creating a new nested attribute set</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.setAttrByPath [ "a" "b" ] 3
=&gt; { a = { b = 3; }; }
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.getAttrFromPath"></a>5.1.2.4. <code class="function">lib.attrsets.getAttrFromPath</code></h4></div><div><h5 class="subtitle"><code class="literal">getAttrFromPath :: [String] -&gt; AttrSet -&gt; Value</code>
      </h5></div></div></div><p><a id="lib.attrsets.getAttrFromPath"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L73" target="_top">lib/attrsets.nix:73</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Like <a class="xref" href="#function-library-lib.attrsets.attrByPath" title="5.1.2.1. lib.attrset.attrByPath">Section 5.1.2.1, “<code class="function">lib.attrset.attrByPath</code>”</a> except without a default, and it will throw if the value doesn't exist.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">attrPath</code>
        </span></dt><dd><p>
          A list of strings representing the path through the nested attribute set <code class="varname">set</code>.
         </p></dd><dt><span class="term">
         <code class="varname">set</code>
        </span></dt><dd><p>
          The nested attribute set to find the value in.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.getAttrPath-example-success"></a><p class="title"><strong>Example 5.7. Succesfully getting a value from an attribute set</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.getAttrFromPath [ "a" "b" ] { a = { b = 3; }; }
=&gt; 3
</pre></div></div><br class="example-break" /><div class="example"><a id="function-library-lib.attrsets.getAttrPath-example-throw"></a><p class="title"><strong>Example 5.8. Throwing after failing to get a value from an attribute set</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.getAttrFromPath [ "x" "y" ] { }
=&gt; error: cannot find attribute `x.y'
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.attrVals"></a>5.1.2.5. <code class="function">lib.attrsets.attrVals</code></h4></div><div><h5 class="subtitle"><code class="literal">attrVals :: [String] -&gt; AttrSet -&gt; [Any]</code>
      </h5></div></div></div><p><a id="lib.attrsets.attrVals"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L84" target="_top">lib/attrsets.nix:84</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Return the specified attributes from a set. All values must exist.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">nameList</code>
        </span></dt><dd><p>
          The list of attributes to fetch from <code class="varname">set</code>. Each attribute name must exist on the attrbitue set.
         </p></dd><dt><span class="term">
         <code class="varname">set</code>
        </span></dt><dd><p>
          The set to get attribute values from.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.attrVals-example-success"></a><p class="title"><strong>Example 5.9. Getting several values from an attribute set</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.attrVals [ "a" "b" "c" ] { a = 1; b = 2; c = 3; }
=&gt; [ 1 2 3 ]
</pre></div></div><br class="example-break" /><div class="example"><a id="function-library-lib.attrsets.attrVals-failure"></a><p class="title"><strong>Example 5.10. Getting missing values from an attribute set</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.attrVals [ "d" ] { }
error: attribute 'd' missing
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.attrValues"></a>5.1.2.6. <code class="function">lib.attrsets.attrValues</code></h4></div><div><h5 class="subtitle"><code class="literal">attrValues :: AttrSet -&gt; [Any]</code>
      </h5></div></div></div><p><a id="lib.attrsets.attrValues"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L94" target="_top">lib/attrsets.nix:94</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Get all the attribute values from an attribute set.
      </p><p>
       Provides a backwards-compatible interface of <code class="function">builtins.attrValues</code> for Nix version older than 1.8.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">attrs</code>
        </span></dt><dd><p>
          The attribute set.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.attrValues-example"></a><p class="title"><strong>Example 5.11. </strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.attrValues { a = 1; b = 2; c = 3; }
=&gt; [ 1 2 3 ]
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.catAttrs"></a>5.1.2.7. <code class="function">lib.attrsets.catAttrs</code></h4></div><div><h5 class="subtitle"><code class="literal">catAttrs :: String -&gt; [AttrSet] -&gt; [Any]</code>
      </h5></div></div></div><p><a id="lib.attrsets.catAttrs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L113" target="_top">lib/attrsets.nix:113</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Collect each attribute named `attr' from the list of attribute sets, <code class="varname">sets</code>. Sets that don't contain the named attribute are ignored.
      </p><p>
       Provides a backwards-compatible interface of <code class="function">builtins.catAttrs</code> for Nix version older than 1.9.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">attr</code>
        </span></dt><dd><p>
          Attribute name to select from each attribute set in <code class="varname">sets</code>.
         </p></dd><dt><span class="term">
         <code class="varname">sets</code>
        </span></dt><dd><p>
          The list of attribute sets to select <code class="varname">attr</code> from.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.catAttrs-example"></a><p class="title"><strong>Example 5.12. Collect an attribute from a list of attribute sets.</strong></p><div class="example-contents"><p>
        Attribute sets which don't have the attribute are ignored.
       </p><pre class="programlisting">
catAttrs "a" [{a = 1;} {b = 0;} {a = 2;}]
=&gt; [ 1 2 ]
      </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.filterAttrs"></a>5.1.2.8. <code class="function">lib.attrsets.filterAttrs</code></h4></div><div><h5 class="subtitle"><code class="literal">filterAttrs :: (String -&gt; Any -&gt; Bool) -&gt; AttrSet -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.filterAttrs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L124" target="_top">lib/attrsets.nix:124</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Filter an attribute set by removing all attributes for which the given predicate return false.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">pred</code>
        </span></dt><dd><p>
          <code class="literal">String -&gt; Any -&gt; Bool</code>
         </p><p>
          Predicate which returns true to include an attribute, or returns false to exclude it.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">name</code>
           </span></dt><dd><p>
             The attribute's name
            </p></dd><dt><span class="term">
            <code class="varname">value</code>
           </span></dt><dd><p>
             The attribute's value
            </p></dd></dl></div><p>
          Returns <code class="literal">true</code> to include the attribute, <code class="literal">false</code> to exclude the attribute.
         </p></dd><dt><span class="term">
         <code class="varname">set</code>
        </span></dt><dd><p>
          The attribute set to filter
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.filterAttrs-example"></a><p class="title"><strong>Example 5.13. Filtering an attributeset</strong></p><div class="example-contents"><pre class="programlisting">
filterAttrs (n: v: n == "foo") { foo = 1; bar = 2; }
=&gt; { foo = 1; }
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.filterAttrsRecursive"></a>5.1.2.9. <code class="function">lib.attrsets.filterAttrsRecursive</code></h4></div><div><h5 class="subtitle"><code class="literal">filterAttrsRecursive :: (String -&gt; Any -&gt; Bool) -&gt; AttrSet -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.filterAttrsRecursive"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L135" target="_top">lib/attrsets.nix:135</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Filter an attribute set recursively by removing all attributes for which the given predicate return false.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">pred</code>
        </span></dt><dd><p>
          <code class="literal">String -&gt; Any -&gt; Bool</code>
         </p><p>
          Predicate which returns true to include an attribute, or returns false to exclude it.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">name</code>
           </span></dt><dd><p>
             The attribute's name
            </p></dd><dt><span class="term">
            <code class="varname">value</code>
           </span></dt><dd><p>
             The attribute's value
            </p></dd></dl></div><p>
          Returns <code class="literal">true</code> to include the attribute, <code class="literal">false</code> to exclude the attribute.
         </p></dd><dt><span class="term">
         <code class="varname">set</code>
        </span></dt><dd><p>
          The attribute set to filter
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.filterAttrsRecursive-example"></a><p class="title"><strong>Example 5.14. Recursively filtering an attribute set</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.filterAttrsRecursive
  (n: v: v != null)
  {
    levelA = {
      example = "hi";
      levelB = {
        hello = "there";
        this-one-is-present = {
          this-is-excluded = null;
        };
      };
      this-one-is-also-excluded = null;
    };
    also-excluded = null;
  }
=&gt; {
     levelA = {
       example = "hi";
       levelB = {
         hello = "there";
         this-one-is-present = { };
       };
     };
   }
     </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.foldAttrs"></a>5.1.2.10. <code class="function">lib.attrsets.foldAttrs</code></h4></div><div><h5 class="subtitle"><code class="literal">foldAttrs :: (Any -&gt; Any -&gt; Any) -&gt; Any -&gt; [AttrSets] -&gt; Any</code>
      </h5></div></div></div><p><a id="lib.attrsets.foldAttrs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L154" target="_top">lib/attrsets.nix:154</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Apply fold function to values grouped by key.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">op</code>
        </span></dt><dd><p>
          <code class="literal">Any -&gt; Any -&gt; Any</code>
         </p><p>
          Given a value <code class="varname">val</code> and a collector <code class="varname">col</code>, combine the two.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">val</code>
           </span></dt><dd><p>
             An attribute's value
            </p></dd><dt><span class="term">
            <code class="varname">col</code>
           </span></dt><dd><p>
             The result of previous <code class="function">op</code> calls with other values and <code class="function">nul</code>.
            </p></dd></dl></div></dd><dt><span class="term">
         <code class="varname">nul</code>
        </span></dt><dd><p>
          The null-value, the starting value.
         </p></dd><dt><span class="term">
         <code class="varname">list_of_attrs</code>
        </span></dt><dd><p>
          A list of attribute sets to fold together by key.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.foldAttrs-example"></a><p class="title"><strong>Example 5.15. Combining an attribute of lists in to one attribute set</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.foldAttrs
  (n: a: [n] ++ a) []
  [
    { a = 2; b = 7; }
    { a = 3; }
    { b = 6; }
  ]
=&gt; { a = [ 2 3 ]; b = [ 7 6 ]; }
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.collect"></a>5.1.2.11. <code class="function">lib.attrsets.collect</code></h4></div><div><h5 class="subtitle"><code class="literal">collect :: (Any -&gt; Bool) -&gt; AttrSet -&gt; [Any]</code>
      </h5></div></div></div><p><a id="lib.attrsets.collect"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L178" target="_top">lib/attrsets.nix:178</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Recursively collect sets that verify a given predicate named <code class="varname">pred</code> from the set <code class="varname">attrs</code>. The recursion stops when <code class="varname">pred</code> returns <code class="literal">true</code>.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">pred</code>
        </span></dt><dd><p>
          <code class="literal">Any -&gt; Bool</code>
         </p><p>
          Given an attribute's value, determine if recursion should stop.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">value</code>
           </span></dt><dd><p>
             The attribute set value.
            </p></dd></dl></div></dd><dt><span class="term">
         <code class="varname">attrs</code>
        </span></dt><dd><p>
          The attribute set to recursively collect.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.collect-example-lists"></a><p class="title"><strong>Example 5.16. Collecting all lists from an attribute set</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.collect isList { a = { b = ["b"]; }; c = [1]; }
=&gt; [["b"] [1]]
</pre></div></div><br class="example-break" /><div class="example"><a id="function-library-lib.attrsets.collect-example-outpath"></a><p class="title"><strong>Example 5.17. Collecting all attribute-sets which contain the <code class="literal">outPath</code> attribute name.</strong></p><div class="example-contents"><pre class="programlisting">
collect (x: x ? outPath)
  { a = { outPath = "a/"; }; b = { outPath = "b/"; }; }
=&gt; [{ outPath = "a/"; } { outPath = "b/"; }]
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.nameValuePair"></a>5.1.2.12. <code class="function">lib.attrsets.nameValuePair</code></h4></div><div><h5 class="subtitle"><code class="literal">nameValuePair :: String -&gt; Any -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.nameValuePair"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L212" target="_top">lib/attrsets.nix:212</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Utility function that creates a <code class="literal">{name, value}</code> pair as expected by <code class="function">builtins.listToAttrs</code>.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">name</code>
        </span></dt><dd><p>
          The attribute name.
         </p></dd><dt><span class="term">
         <code class="varname">value</code>
        </span></dt><dd><p>
          The attribute value.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.nameValuePair-example"></a><p class="title"><strong>Example 5.18. Creating a name value pair</strong></p><div class="example-contents"><pre class="programlisting">
nameValuePair "some" 6
=&gt; { name = "some"; value = 6; }
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.mapAttrs"></a>5.1.2.13. <code class="function">lib.attrsets.mapAttrs</code></h4></div><div><h5 class="subtitle"><code class="literal"></code>
      </h5></div></div></div><p><a id="lib.attrsets.mapAttrs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L225" target="_top">lib/attrsets.nix:225</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Apply a function to each element in an attribute set, creating a new attribute set.
      </p><p>
       Provides a backwards-compatible interface of <code class="function">builtins.mapAttrs</code> for Nix version older than 2.1.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">fn</code>
        </span></dt><dd><p>
          <code class="literal">String -&gt; Any -&gt; Any</code>
         </p><p>
          Given an attribute's name and value, return a new value.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">name</code>
           </span></dt><dd><p>
             The name of the attribute.
            </p></dd><dt><span class="term">
            <code class="varname">value</code>
           </span></dt><dd><p>
             The attribute's value.
            </p></dd></dl></div></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.mapAttrs-example"></a><p class="title"><strong>Example 5.19. Modifying each value of an attribute set</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.mapAttrs
  (name: value: name + "-" value)
  { x = "foo"; y = "bar"; }
=&gt; { x = "x-foo"; y = "y-bar"; }
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.mapAttrs-prime"></a>5.1.2.14. <code class="function">lib.attrsets.mapAttrs'</code></h4></div><div><h5 class="subtitle"><code class="literal">mapAttrs' :: (String -&gt; Any -&gt; { name = String; value = Any }) -&gt; AttrSet -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.mapAttrs-prime"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L239" target="_top">lib/attrsets.nix:239</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Like <code class="function">mapAttrs</code>, but allows the name of each attribute to be changed in addition to the value. The applied function should return both the new name and value as a <code class="function">nameValuePair</code>.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">fn</code>
        </span></dt><dd><p>
          <code class="literal">String -&gt; Any -&gt; { name = String; value = Any }</code>
         </p><p>
          Given an attribute's name and value, return a new <a class="link" href="#function-library-lib.attrsets.nameValuePair" title="5.1.2.12. lib.attrsets.nameValuePair">name value pair</a>.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">name</code>
           </span></dt><dd><p>
             The name of the attribute.
            </p></dd><dt><span class="term">
            <code class="varname">value</code>
           </span></dt><dd><p>
             The attribute's value.
            </p></dd></dl></div></dd><dt><span class="term">
         <code class="varname">set</code>
        </span></dt><dd><p>
          The attribute set to map over.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.mapAttrs-prime-example"></a><p class="title"><strong>Example 5.20. Change the name and value of each attribute of an attribute set</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.mapAttrs' (name: value: lib.attrsets.nameValuePair ("foo_" + name) ("bar-" + value))
   { x = "a"; y = "b"; }
=&gt; { foo_x = "bar-a"; foo_y = "bar-b"; }

    </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.mapAttrsToList"></a>5.1.2.15. <code class="function">lib.attrsets.mapAttrsToList</code></h4></div><div><h5 class="subtitle"><code class="literal">mapAttrsToList :: (String -&gt; Any -&gt; Any) -&gt;
   AttrSet -&gt; [Any]</code>
      </h5></div></div></div><p><a id="lib.attrsets.mapAttrsToList"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L255" target="_top">lib/attrsets.nix:255</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Call <code class="varname">fn</code> for each attribute in the given <code class="varname">set</code> and return the result in a list.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">fn</code>
        </span></dt><dd><p>
          <code class="literal">String -&gt; Any -&gt; Any</code>
         </p><p>
          Given an attribute's name and value, return a new value.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">name</code>
           </span></dt><dd><p>
             The name of the attribute.
            </p></dd><dt><span class="term">
            <code class="varname">value</code>
           </span></dt><dd><p>
             The attribute's value.
            </p></dd></dl></div></dd><dt><span class="term">
         <code class="varname">set</code>
        </span></dt><dd><p>
          The attribute set to map over.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.mapAttrsToList-example"></a><p class="title"><strong>Example 5.21. Combine attribute values and names in to a list</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.mapAttrsToList (name: value: "${name}=${value}")
   { x = "a"; y = "b"; }
=&gt; [ "x=a" "y=b" ]
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.mapAttrsRecursive"></a>5.1.2.16. <code class="function">lib.attrsets.mapAttrsRecursive</code></h4></div><div><h5 class="subtitle"><code class="literal">mapAttrsRecursive :: ([String] &gt; Any -&gt; Any) -&gt; AttrSet -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.mapAttrsRecursive"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L272" target="_top">lib/attrsets.nix:272</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Like <code class="function">mapAttrs</code>, except that it recursively applies itself to attribute sets. Also, the first argument of the argument function is a <span class="emphasis"><em>list</em></span> of the names of the containing attributes.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          <code class="literal">[ String ] -&gt; Any -&gt; Any</code>
         </p><p>
          Given a list of attribute names and value, return a new value.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">name_path</code>
           </span></dt><dd><p>
             The list of attribute names to this value.
            </p><p>
             For example, the <code class="varname">name_path</code> for the <code class="literal">example</code> string in the attribute set <code class="literal">{ foo = { bar = "example"; }; }</code> is <code class="literal">[ "foo" "bar" ]</code>.
            </p></dd><dt><span class="term">
            <code class="varname">value</code>
           </span></dt><dd><p>
             The attribute's value.
            </p></dd></dl></div></dd><dt><span class="term">
         <code class="varname">set</code>
        </span></dt><dd><p>
          The attribute set to recursively map over.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.mapAttrsRecursive-example"></a><p class="title"><strong>Example 5.22. A contrived example of using <code class="function">lib.attrsets.mapAttrsRecursive</code></strong></p><div class="example-contents"><pre class="programlisting">
mapAttrsRecursive
  (path: value: concatStringsSep "-" (path ++ [value]))
  {
    n = {
      a = "A";
      m = {
        b = "B";
        c = "C";
      };
    };
    d = "D";
  }
=&gt; {
     n = {
       a = "n-a-A";
       m = {
         b = "n-m-b-B";
         c = "n-m-c-C";
       };
     };
     d = "d-D";
   }
    </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.mapAttrsRecursiveCond"></a>5.1.2.17. <code class="function">lib.attrsets.mapAttrsRecursiveCond</code></h4></div><div><h5 class="subtitle"><code class="literal">mapAttrsRecursiveCond :: (AttrSet -&gt; Bool) -&gt; ([ String ] -&gt; Any -&gt; Any) -&gt; AttrSet -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.mapAttrsRecursiveCond"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L293" target="_top">lib/attrsets.nix:293</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Like <code class="function">mapAttrsRecursive</code>, but it takes an additional predicate function that tells it whether to recursive into an attribute set. If it returns false, <code class="function">mapAttrsRecursiveCond</code> does not recurse, but does apply the map function. It is returns true, it does recurse, and does not apply the map function.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">cond</code>
        </span></dt><dd><p>
          <code class="literal">(AttrSet -&gt; Bool)</code>
         </p><p>
          Determine if <code class="function">mapAttrsRecursive</code> should recurse deeper in to the attribute set.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">attributeset</code>
           </span></dt><dd><p>
             An attribute set.
            </p></dd></dl></div></dd><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          <code class="literal">[ String ] -&gt; Any -&gt; Any</code>
         </p><p>
          Given a list of attribute names and value, return a new value.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">name_path</code>
           </span></dt><dd><p>
             The list of attribute names to this value.
            </p><p>
             For example, the <code class="varname">name_path</code> for the <code class="literal">example</code> string in the attribute set <code class="literal">{ foo = { bar = "example"; }; }</code> is <code class="literal">[ "foo" "bar" ]</code>.
            </p></dd><dt><span class="term">
            <code class="varname">value</code>
           </span></dt><dd><p>
             The attribute's value.
            </p></dd></dl></div></dd><dt><span class="term">
         <code class="varname">set</code>
        </span></dt><dd><p>
          The attribute set to recursively map over.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.mapAttrsRecursiveCond-example"></a><p class="title"><strong>Example 5.23. Only convert attribute values to JSON if the containing attribute set is marked for recursion</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.mapAttrsRecursiveCond
  ({ recurse ? false, ... }: recurse)
  (name: value: builtins.toJSON value)
  {
    dorecur = {
      recurse = true;
      hello = "there";
    };
    dontrecur = {
      converted-to- = "json";
    };
  }
=&gt; {
     dorecur = {
       hello = "\"there\"";
       recurse = "true";
     };
     dontrecur = "{\"converted-to\":\"json\"}";
   }
    </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.genAttrs"></a>5.1.2.18. <code class="function">lib.attrsets.genAttrs</code></h4></div><div><h5 class="subtitle"><code class="literal">genAttrs :: [ String ] -&gt; (String -&gt; Any) -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.genAttrs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L313" target="_top">lib/attrsets.nix:313</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Generate an attribute set by mapping a function over a list of attribute names.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">names</code>
        </span></dt><dd><p>
          Names of values in the resulting attribute set.
         </p></dd><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          <code class="literal">String -&gt; Any</code>
         </p><p>
          Takes the name of the attribute and return the attribute's value.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">name</code>
           </span></dt><dd><p>
             The name of the attribute to generate a value for.
            </p></dd></dl></div></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.genAttrs-example"></a><p class="title"><strong>Example 5.24. Generate an attrset based on names only</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.genAttrs [ "foo" "bar" ] (name: "x_${name}")
=&gt; { foo = "x_foo"; bar = "x_bar"; }
     </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.isDerivation"></a>5.1.2.19. <code class="function">lib.attrsets.isDerivation</code></h4></div><div><h5 class="subtitle"><code class="literal">isDerivation :: Any -&gt; Bool</code>
      </h5></div></div></div><p><a id="lib.attrsets.isDerivation"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L327" target="_top">lib/attrsets.nix:327</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Check whether the argument is a derivation. Any set with <code class="code">{ type = "derivation"; }</code> counts as a derivation.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">value</code>
        </span></dt><dd><p>
          The value which is possibly a derivation.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.isDerivation-example-true"></a><p class="title"><strong>Example 5.25. A package is a derivation</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.isDerivation (import &lt;nixpkgs&gt; {}).ruby
=&gt; true
     </pre></div></div><br class="example-break" /><div class="example"><a id="function-library-lib.attrsets.isDerivation-example-false"></a><p class="title"><strong>Example 5.26. Anything else is not a derivation</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.isDerivation "foobar"
=&gt; false
     </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.toDerivation"></a>5.1.2.20. <code class="function">lib.attrsets.toDerivation</code></h4></div><div><h5 class="subtitle"><code class="literal">toDerivation :: Path -&gt; Derivation</code>
      </h5></div></div></div><p><a id="lib.attrsets.toDerivation"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L330" target="_top">lib/attrsets.nix:330</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Converts a store path to a fake derivation.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">path</code>
        </span></dt><dd><p>
          A store path to convert to a derivation.
         </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.optionalAttrs"></a>5.1.2.21. <code class="function">lib.attrsets.optionalAttrs</code></h4></div><div><h5 class="subtitle"><code class="literal">optionalAttrs :: Bool -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.optionalAttrs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L353" target="_top">lib/attrsets.nix:353</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Conditionally return an attribute set or an empty attribute set.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">cond</code>
        </span></dt><dd><p>
          Condition under which the <code class="varname">as</code> attribute set is returned.
         </p></dd><dt><span class="term">
         <code class="varname">as</code>
        </span></dt><dd><p>
          The attribute set to return if <code class="varname">cond</code> is true.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.optionalAttrs-example-true"></a><p class="title"><strong>Example 5.27. Return the provided attribute set when <code class="varname">cond</code> is true</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.optionalAttrs true { my = "set"; }
=&gt; { my = "set"; }
     </pre></div></div><br class="example-break" /><div class="example"><a id="function-library-lib.attrsets.optionalAttrs-example-false"></a><p class="title"><strong>Example 5.28. Return an empty attribute set when <code class="varname">cond</code> is false</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.optionalAttrs false { my = "set"; }
=&gt; { }
     </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.zipAttrsWithNames"></a>5.1.2.22. <code class="function">lib.attrsets.zipAttrsWithNames</code></h4></div><div><h5 class="subtitle"><code class="literal">zipAttrsWithNames :: [ String ] -&gt; (String -&gt; [ Any ] -&gt; Any) -&gt; [ AttrSet ] -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.zipAttrsWithNames"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L363" target="_top">lib/attrsets.nix:363</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Merge sets of attributes and use the function <code class="varname">f</code> to merge attribute values where the attribute name is in <code class="varname">names</code>.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">names</code>
        </span></dt><dd><p>
          A list of attribute names to zip.
         </p></dd><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          <code class="literal">(String -&gt; [ Any ] -&gt; Any</code>
         </p><p>
          Accepts an attribute name, all the values, and returns a combined value.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">name</code>
           </span></dt><dd><p>
             The name of the attribute each value came from.
            </p></dd><dt><span class="term">
            <code class="varname">vs</code>
           </span></dt><dd><p>
             A list of values collected from the list of attribute sets.
            </p></dd></dl></div></dd><dt><span class="term">
         <code class="varname">sets</code>
        </span></dt><dd><p>
          A list of attribute sets to zip together.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.zipAttrsWithNames-example"></a><p class="title"><strong>Example 5.29. Summing a list of attribute sets of numbers</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.zipAttrsWithNames
  [ "a" "b" ]
  (name: vals: "${name} ${toString (builtins.foldl' (a: b: a + b) 0 vals)}")
  [
    { a = 1; b = 1; c = 1; }
    { a = 10; }
    { b = 100; }
    { c = 1000; }
  ]
=&gt; { a = "a 11"; b = "b 101"; }
     </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.zipAttrsWith"></a>5.1.2.23. <code class="function">lib.attrsets.zipAttrsWith</code></h4></div><div><h5 class="subtitle"><code class="literal">zipAttrsWith :: (String -&gt; [ Any ] -&gt; Any) -&gt; [ AttrSet ] -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.zipAttrsWith"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L378" target="_top">lib/attrsets.nix:378</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Merge sets of attributes and use the function <code class="varname">f</code> to merge attribute values. Similar to <a class="xref" href="#function-library-lib.attrsets.zipAttrsWithNames" title="5.1.2.22. lib.attrsets.zipAttrsWithNames">Section 5.1.2.22, “<code class="function">lib.attrsets.zipAttrsWithNames</code>”</a> where all key names are passed for <code class="varname">names</code>.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          <code class="literal">(String -&gt; [ Any ] -&gt; Any</code>
         </p><p>
          Accepts an attribute name, all the values, and returns a combined value.
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">name</code>
           </span></dt><dd><p>
             The name of the attribute each value came from.
            </p></dd><dt><span class="term">
            <code class="varname">vs</code>
           </span></dt><dd><p>
             A list of values collected from the list of attribute sets.
            </p></dd></dl></div></dd><dt><span class="term">
         <code class="varname">sets</code>
        </span></dt><dd><p>
          A list of attribute sets to zip together.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.zipAttrsWith-example"></a><p class="title"><strong>Example 5.30. Summing a list of attribute sets of numbers</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.zipAttrsWith
  (name: vals: "${name} ${toString (builtins.foldl' (a: b: a + b) 0 vals)}")
  [
    { a = 1; b = 1; c = 1; }
    { a = 10; }
    { b = 100; }
    { c = 1000; }
  ]
=&gt; { a = "a 11"; b = "b 101"; c = "c 1001"; }
     </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.zipAttrs"></a>5.1.2.24. <code class="function">lib.attrsets.zipAttrs</code></h4></div><div><h5 class="subtitle"><code class="literal">zipAttrsWith :: [ AttrSet ] -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.zipAttrs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L385" target="_top">lib/attrsets.nix:385</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Merge sets of attributes and combine each attribute value in to a list. Similar to <a class="xref" href="#function-library-lib.attrsets.zipAttrsWith" title="5.1.2.23. lib.attrsets.zipAttrsWith">Section 5.1.2.23, “<code class="function">lib.attrsets.zipAttrsWith</code>”</a> where the merge function returns a list of all values.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">sets</code>
        </span></dt><dd><p>
          A list of attribute sets to zip together.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.zipAttrs-example"></a><p class="title"><strong>Example 5.31. Combining a list of attribute sets</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.zipAttrs
  [
    { a = 1; b = 1; c = 1; }
    { a = 10; }
    { b = 100; }
    { c = 1000; }
  ]
=&gt; { a = [ 1 10 ]; b = [ 1 100 ]; c = [ 1 1000 ]; }
     </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.recursiveUpdateUntil"></a>5.1.2.25. <code class="function">lib.attrsets.recursiveUpdateUntil</code></h4></div><div><h5 class="subtitle"><code class="literal">recursiveUpdateUntil :: ( [ String ] -&gt; AttrSet -&gt; AttrSet -&gt; Bool ) -&gt; AttrSet -&gt; AttrSet -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.recursiveUpdateUntil"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L415" target="_top">lib/attrsets.nix:415</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Does the same as the update operator <code class="literal">//</code> except that attributes are merged until the given predicate is verified. The predicate should accept 3 arguments which are the path to reach the attribute, a part of the first attribute set and a part of the second attribute set. When the predicate is verified, the value of the first attribute set is replaced by the value of the second attribute set.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">pred</code>
        </span></dt><dd><p>
          <code class="literal">[ String ] -&gt; AttrSet -&gt; AttrSet -&gt; Bool</code>
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">path</code>
           </span></dt><dd><p>
             The path to the values in the left and right hand sides.
            </p></dd><dt><span class="term">
            <code class="varname">l</code>
           </span></dt><dd><p>
             The left hand side value.
            </p></dd><dt><span class="term">
            <code class="varname">r</code>
           </span></dt><dd><p>
             The right hand side value.
            </p></dd></dl></div></dd><dt><span class="term">
         <code class="varname">lhs</code>
        </span></dt><dd><p>
          The left hand attribute set of the merge.
         </p></dd><dt><span class="term">
         <code class="varname">rhs</code>
        </span></dt><dd><p>
          The right hand attribute set of the merge.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.recursiveUpdateUntil-example"></a><p class="title"><strong>Example 5.32. Recursively merging two attribute sets</strong></p><div class="example-contents"><pre class="programlisting">
lib.attrsets.recursiveUpdateUntil (path: l: r: path == ["foo"])
  {
    # first attribute set
    foo.bar = 1;
    foo.baz = 2;
    bar = 3;
  }
  {
    #second attribute set
    foo.bar = 1;
    foo.quz = 2;
    baz = 4;
  }
=&gt; {
  foo.bar = 1; # 'foo.*' from the second set
  foo.quz = 2; #
  bar = 3;     # 'bar' from the first set
  baz = 4;     # 'baz' from the second set
}
     </pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.recursiveUpdate"></a>5.1.2.26. <code class="function">lib.attrsets.recursiveUpdate</code></h4></div><div><h5 class="subtitle"><code class="literal">recursiveUpdate :: AttrSet -&gt; AttrSet -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.recursiveUpdate"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L446" target="_top">lib/attrsets.nix:446</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       A recursive variant of the update operator <code class="literal">//</code>. The recursion stops when one of the attribute values is not an attribute set, in which case the right hand side value takes precedence over the left hand side value.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">lhs</code>
        </span></dt><dd><p>
          The left hand attribute set of the merge.
         </p></dd><dt><span class="term">
         <code class="varname">rhs</code>
        </span></dt><dd><p>
          The right hand attribute set of the merge.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.recursiveUpdate-example"></a><p class="title"><strong>Example 5.33. Recursively merging two attribute sets</strong></p><div class="example-contents"><pre class="programlisting">
recursiveUpdate
  {
    boot.loader.grub.enable = true;
    boot.loader.grub.device = "/dev/hda";
  }
  {
    boot.loader.grub.device = "";
  }
=&gt; {
  boot.loader.grub.enable = true;
  boot.loader.grub.device = "";
}
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.recurseIntoAttrs"></a>5.1.2.27. <code class="function">lib.attrsets.recurseIntoAttrs</code></h4></div><div><h5 class="subtitle"><code class="literal">recurseIntoAttrs :: AttrSet -&gt; AttrSet</code>
      </h5></div></div></div><p><a id="lib.attrsets.recurseIntoAttrs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L505" target="_top">lib/attrsets.nix:505</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Make various Nix tools consider the contents of the resulting attribute set when looking for what to build, find, etc.
      </p><p>
       This function only affects a single attribute set; it does not apply itself recursively for nested attribute sets.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">attrs</code>
        </span></dt><dd><p>
          An attribute set to scan for derivations.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.recurseIntoAttrs-example"></a><p class="title"><strong>Example 5.34. Making Nix look inside an attribute set</strong></p><div class="example-contents"><pre class="programlisting">
{ pkgs ? import &lt;nixpkgs&gt; {} }:
{
  myTools = pkgs.lib.recurseIntoAttrs {
    inherit (pkgs) hello figlet;
  };
}
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.attrsets.cartesianProductOfSets"></a>5.1.2.28. <code class="function">lib.attrsets.cartesianProductOfSets</code></h4></div><div><h5 class="subtitle"><code class="literal">cartesianProductOfSets :: AttrSet -&gt; [ AttrSet ]</code>
      </h5></div></div></div><p><a id="lib.attrsets.cartesianProductOfSets"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/attrsets.nix#L197" target="_top">lib/attrsets.nix:197</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p><p>
       Return the cartesian product of attribute set value combinations.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">set</code>
        </span></dt><dd><p>
          An attribute set with attributes that carry lists of values.
         </p></dd></dl></div><div class="example"><a id="function-library-lib.attrsets.cartesianProductOfSets-example"></a><p class="title"><strong>Example 5.35. Creating the cartesian product of a list of attribute values</strong></p><div class="example-contents"><pre class="programlisting">
cartesianProductOfSets { a = [ 1 2 ]; b = [ 10 20 ]; }
=&gt; [
     { a = 1; b = 10; }
     { a = 1; b = 20; }
     { a = 2; b = 10; }
     { a = 2; b = 20; }
   ]
</pre></div></div><br class="example-break" /></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-functions-library-strings"></a>5.1.3. String manipulation functions</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.concatStrings"></a>5.1.3.1. <code class="function">lib.strings.concatStrings</code></h4></div><div><h5 class="subtitle"><code class="literal">concatStrings :: [string] -&gt; string</code>
      </h5></div></div></div><p>
       Concatenate a list of strings.
      </p><div class="example"><a id="idm140737321906560"></a><p class="title"><strong>Example 5.36. <code class="function">lib.strings.concatStrings</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
concatStrings ["foo" "bar"]
=&gt; "foobar"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.concatStrings"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L43" target="_top">lib/strings.nix:43</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.concatMapStrings"></a>5.1.3.2. <code class="function">lib.strings.concatMapStrings</code></h4></div><div><h5 class="subtitle"><code class="literal">concatMapStrings :: (a -&gt; string) -&gt; [a] -&gt; string</code>
      </h5></div></div></div><p>
       Map a function over a list and concatenate the resulting strings.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321895248"></a><p class="title"><strong>Example 5.37. <code class="function">lib.strings.concatMapStrings</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
concatMapStrings (x: "a" + x) ["foo" "bar"]
=&gt; "afooabar"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.concatMapStrings"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L53" target="_top">lib/strings.nix:53</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.concatImapStrings"></a>5.1.3.3. <code class="function">lib.strings.concatImapStrings</code></h4></div><div><h5 class="subtitle"><code class="literal">concatImapStrings :: (int -&gt; a -&gt; string) -&gt; [a] -&gt; string</code>
      </h5></div></div></div><p>
       Like `concatMapStrings` except that the f functions also gets the position as a parameter.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321883856"></a><p class="title"><strong>Example 5.38. <code class="function">lib.strings.concatImapStrings</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
concatImapStrings (pos: x: "${toString pos}-${x}") ["foo" "bar"]
=&gt; "1-foo2-bar"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.concatImapStrings"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L64" target="_top">lib/strings.nix:64</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.intersperse"></a>5.1.3.4. <code class="function">lib.strings.intersperse</code></h4></div><div><h5 class="subtitle"><code class="literal">intersperse :: a -&gt; [a] -&gt; [a]</code>
      </h5></div></div></div><p>
       Place an element between each element of a list
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">separator</code>
        </span></dt><dd><p>
          Separator to add between elements
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Input list
         </p></dd></dl></div><div class="example"><a id="idm140737321872448"></a><p class="title"><strong>Example 5.39. <code class="function">lib.strings.intersperse</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
intersperse "/" ["usr" "local" "bin"]
=&gt; ["usr" "/" "local" "/" "bin"].
</pre></div></div><br class="example-break" /><p><a id="lib.strings.intersperse"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L74" target="_top">lib/strings.nix:74</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.concatStringsSep"></a>5.1.3.5. <code class="function">lib.strings.concatStringsSep</code></h4></div><div><h5 class="subtitle"><code class="literal">concatStringsSep :: string -&gt; [string] -&gt; string</code>
      </h5></div></div></div><p>
       Concatenate a list of strings with a separator between each element
      </p><div class="example"><a id="idm140737321865664"></a><p class="title"><strong>Example 5.40. <code class="function">lib.strings.concatStringsSep</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
concatStringsSep "/" ["usr" "local" "bin"]
=&gt; "usr/local/bin"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.concatStringsSep"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L91" target="_top">lib/strings.nix:91</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.concatMapStringsSep"></a>5.1.3.6. <code class="function">lib.strings.concatMapStringsSep</code></h4></div><div><h5 class="subtitle"><code class="literal">concatMapStringsSep :: string -&gt; (string -&gt; string) -&gt; [string] -&gt; string</code>
      </h5></div></div></div><p>
       Maps a function over a list of strings and then concatenates the result with the specified separator interspersed between elements.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">sep</code>
        </span></dt><dd><p>
          Separator to add between elements
         </p></dd><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function to map over the list
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          List of input strings
         </p></dd></dl></div><div class="example"><a id="idm140737321852160"></a><p class="title"><strong>Example 5.41. <code class="function">lib.strings.concatMapStringsSep</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
concatMapStringsSep "-" (x: toUpper x)  ["foo" "bar" "baz"]
=&gt; "FOO-BAR-BAZ"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.concatMapStringsSep"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L104" target="_top">lib/strings.nix:104</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.concatImapStringsSep"></a>5.1.3.7. <code class="function">lib.strings.concatImapStringsSep</code></h4></div><div><h5 class="subtitle"><code class="literal">concatIMapStringsSep :: string -&gt; (int -&gt; string -&gt; string) -&gt; [string] -&gt; string</code>
      </h5></div></div></div><p>
       Same as `concatMapStringsSep`, but the mapping function additionally receives the position of its argument.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">sep</code>
        </span></dt><dd><p>
          Separator to add between elements
         </p></dd><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function that receives elements and their positions
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          List of input strings
         </p></dd></dl></div><div class="example"><a id="idm140737321838720"></a><p class="title"><strong>Example 5.42. <code class="function">lib.strings.concatImapStringsSep</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
concatImapStringsSep "-" (pos: x: toString (x / pos)) [ 6 6 6 ]
=&gt; "6-3-2"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.concatImapStringsSep"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L121" target="_top">lib/strings.nix:121</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.makeSearchPath"></a>5.1.3.8. <code class="function">lib.strings.makeSearchPath</code></h4></div><div><h5 class="subtitle"><code class="literal">makeSearchPath :: string -&gt; [string] -&gt; string</code>
      </h5></div></div></div><p>
       Construct a Unix-style, colon-separated search path consisting of the given `subDir` appended to each of the given paths.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">subDir</code>
        </span></dt><dd><p>
          Directory name to append
         </p></dd><dt><span class="term">
         <code class="varname">paths</code>
        </span></dt><dd><p>
          List of base paths
         </p></dd></dl></div><div class="example"><a id="idm140737321827312"></a><p class="title"><strong>Example 5.43. <code class="function">lib.strings.makeSearchPath</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
makeSearchPath "bin" ["/root" "/usr" "/usr/local"]
=&gt; "/root/bin:/usr/bin:/usr/local/bin"
makeSearchPath "bin" [""]
=&gt; "/bin"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.makeSearchPath"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L140" target="_top">lib/strings.nix:140</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.makeSearchPathOutput"></a>5.1.3.9. <code class="function">lib.strings.makeSearchPathOutput</code></h4></div><div><h5 class="subtitle"><code class="literal">string -&gt; string -&gt; [package] -&gt; string</code>
      </h5></div></div></div><p>
       Construct a Unix-style search path by appending the given `subDir` to the specified `output` of each of the packages. If no output by the given name is found, fallback to `.out` and then to the default.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">output</code>
        </span></dt><dd><p>
          Package output to use
         </p></dd><dt><span class="term">
         <code class="varname">subDir</code>
        </span></dt><dd><p>
          Directory name to append
         </p></dd><dt><span class="term">
         <code class="varname">pkgs</code>
        </span></dt><dd><p>
          List of packages
         </p></dd></dl></div><div class="example"><a id="idm140737321814048"></a><p class="title"><strong>Example 5.44. <code class="function">lib.strings.makeSearchPathOutput</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
makeSearchPathOutput "dev" "bin" [ pkgs.openssl pkgs.zlib ]
=&gt; "/nix/store/9rz8gxhzf8sw4kf2j2f1grr49w8zx5vj-openssl-1.0.1r-dev/bin:/nix/store/wwh7mhwh269sfjkm6k5665b5kgp7jrk2-zlib-1.2.8/bin"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.makeSearchPathOutput"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L158" target="_top">lib/strings.nix:158</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.makeLibraryPath"></a>5.1.3.10. <code class="function">lib.strings.makeLibraryPath</code></h4></div></div></div><p>
       Construct a library search path (such as RPATH) containing the libraries for a set of packages
      </p><div class="example"><a id="idm140737321807904"></a><p class="title"><strong>Example 5.45. <code class="function">lib.strings.makeLibraryPath</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
makeLibraryPath [ "/usr" "/usr/local" ]
=&gt; "/usr/lib:/usr/local/lib"
pkgs = import &lt;nixpkgs&gt; { }
makeLibraryPath [ pkgs.openssl pkgs.zlib ]
=&gt; "/nix/store/9rz8gxhzf8sw4kf2j2f1grr49w8zx5vj-openssl-1.0.1r/lib:/nix/store/wwh7mhwh269sfjkm6k5665b5kgp7jrk2-zlib-1.2.8/lib"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.makeLibraryPath"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L176" target="_top">lib/strings.nix:176</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.makeBinPath"></a>5.1.3.11. <code class="function">lib.strings.makeBinPath</code></h4></div></div></div><p>
       Construct a binary search path (such as $PATH) containing the binaries for a set of packages.
      </p><div class="example"><a id="idm140737321801744"></a><p class="title"><strong>Example 5.46. <code class="function">lib.strings.makeBinPath</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
makeBinPath ["/root" "/usr" "/usr/local"]
=&gt; "/root/bin:/usr/bin:/usr/local/bin"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.makeBinPath"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L185" target="_top">lib/strings.nix:185</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.optionalString"></a>5.1.3.12. <code class="function">lib.strings.optionalString</code></h4></div><div><h5 class="subtitle"><code class="literal">optionalString :: bool -&gt; string -&gt; string</code>
      </h5></div></div></div><p>
       Depending on the boolean `cond', return either the given string or the empty string. Useful to concatenate against a bigger string.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">cond</code>
        </span></dt><dd><p>
          Condition
         </p></dd><dt><span class="term">
         <code class="varname">string</code>
        </span></dt><dd><p>
          String to return if condition is true
         </p></dd></dl></div><div class="example"><a id="idm140737321790320"></a><p class="title"><strong>Example 5.47. <code class="function">lib.strings.optionalString</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
optionalString true "some-string"
=&gt; "some-string"
optionalString false "some-string"
=&gt; ""
</pre></div></div><br class="example-break" /><p><a id="lib.strings.optionalString"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L198" target="_top">lib/strings.nix:198</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.hasPrefix"></a>5.1.3.13. <code class="function">lib.strings.hasPrefix</code></h4></div><div><h5 class="subtitle"><code class="literal">hasPrefix :: string -&gt; string -&gt; bool</code>
      </h5></div></div></div><p>
       Determine whether a string has given prefix.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">pref</code>
        </span></dt><dd><p>
          Prefix to check for
         </p></dd><dt><span class="term">
         <code class="varname">str</code>
        </span></dt><dd><p>
          Input string
         </p></dd></dl></div><div class="example"><a id="idm140737321779072"></a><p class="title"><strong>Example 5.48. <code class="function">lib.strings.hasPrefix</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
hasPrefix "foo" "foobar"
=&gt; true
hasPrefix "foo" "barfoo"
=&gt; false
</pre></div></div><br class="example-break" /><p><a id="lib.strings.hasPrefix"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L214" target="_top">lib/strings.nix:214</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.hasSuffix"></a>5.1.3.14. <code class="function">lib.strings.hasSuffix</code></h4></div><div><h5 class="subtitle"><code class="literal">hasSuffix :: string -&gt; string -&gt; bool</code>
      </h5></div></div></div><p>
       Determine whether a string has given suffix.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">suffix</code>
        </span></dt><dd><p>
          Suffix to check for
         </p></dd><dt><span class="term">
         <code class="varname">content</code>
        </span></dt><dd><p>
          Input string
         </p></dd></dl></div><div class="example"><a id="idm140737321767920"></a><p class="title"><strong>Example 5.49. <code class="function">lib.strings.hasSuffix</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
hasSuffix "foo" "foobar"
=&gt; false
hasSuffix "foo" "barfoo"
=&gt; true
</pre></div></div><br class="example-break" /><p><a id="lib.strings.hasSuffix"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L230" target="_top">lib/strings.nix:230</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.hasInfix"></a>5.1.3.15. <code class="function">lib.strings.hasInfix</code></h4></div><div><h5 class="subtitle"><code class="literal">hasInfix :: string -&gt; string -&gt; bool</code>
      </h5></div></div></div><p>
       Determine whether a string contains the given infix
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">infix</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">content</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321756720"></a><p class="title"><strong>Example 5.50. <code class="function">lib.strings.hasInfix</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
hasInfix "bc" "abcd"
=&gt; true
hasInfix "ab" "abcd"
=&gt; true
hasInfix "cd" "abcd"
=&gt; true
hasInfix "foo" "abcd"
=&gt; false
</pre></div></div><br class="example-break" /><p><a id="lib.strings.hasInfix"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L255" target="_top">lib/strings.nix:255</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.stringToCharacters"></a>5.1.3.16. <code class="function">lib.strings.stringToCharacters</code></h4></div><div><h5 class="subtitle"><code class="literal">stringToCharacters :: string -&gt; [string]</code>
      </h5></div></div></div><p>
       Convert a string to a list of characters (i.e. singleton strings). This allows you to, e.g., map a function over each character. However, note that this will likely be horribly inefficient; Nix is not a general purpose programming language. Complex string manipulations should, if appropriate, be done in a derivation. Also note that Nix treats strings as a list of bytes and thus doesn't handle unicode.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">s</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321747424"></a><p class="title"><strong>Example 5.51. <code class="function">lib.strings.stringToCharacters</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
stringToCharacters ""
=&gt; [ ]
stringToCharacters "abc"
=&gt; [ "a" "b" "c" ]
stringToCharacters "💩"
=&gt; [ "�" "�" "�" "�" ]
</pre></div></div><br class="example-break" /><p><a id="lib.strings.stringToCharacters"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L279" target="_top">lib/strings.nix:279</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.stringAsChars"></a>5.1.3.17. <code class="function">lib.strings.stringAsChars</code></h4></div><div><h5 class="subtitle"><code class="literal">stringAsChars :: (string -&gt; string) -&gt; string -&gt; string</code>
      </h5></div></div></div><p>
       Manipulate a string character by character and replace them by strings before concatenating the results.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function to map over each individual character
         </p></dd><dt><span class="term">
         <code class="varname">s</code>
        </span></dt><dd><p>
          Input string
         </p></dd></dl></div><div class="example"><a id="idm140737321736048"></a><p class="title"><strong>Example 5.52. <code class="function">lib.strings.stringAsChars</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
stringAsChars (x: if x == "a" then "i" else x) "nax"
=&gt; "nix"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.stringAsChars"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L291" target="_top">lib/strings.nix:291</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.escape"></a>5.1.3.18. <code class="function">lib.strings.escape</code></h4></div><div><h5 class="subtitle"><code class="literal">escape :: [string] -&gt; string -&gt; string</code>
      </h5></div></div></div><p>
       Escape occurrence of the elements of `list` in `string` by prefixing it with a backslash.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321726640"></a><p class="title"><strong>Example 5.53. <code class="function">lib.strings.escape</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
escape ["(" ")"] "(foo)"
=&gt; "\\(foo\\)"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.escape"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L308" target="_top">lib/strings.nix:308</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.escapeShellArg"></a>5.1.3.19. <code class="function">lib.strings.escapeShellArg</code></h4></div><div><h5 class="subtitle"><code class="literal">escapeShellArg :: string -&gt; string</code>
      </h5></div></div></div><p>
       Quote string to be used safely within the Bourne shell.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">arg</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321717328"></a><p class="title"><strong>Example 5.54. <code class="function">lib.strings.escapeShellArg</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
escapeShellArg "esc'ape\nme"
=&gt; "'esc'\\''ape\nme'"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.escapeShellArg"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L318" target="_top">lib/strings.nix:318</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.escapeShellArgs"></a>5.1.3.20. <code class="function">lib.strings.escapeShellArgs</code></h4></div><div><h5 class="subtitle"><code class="literal">escapeShellArgs :: [string] -&gt; string</code>
      </h5></div></div></div><p>
       Quote all arguments to be safely passed to the Bourne shell.
      </p><div class="example"><a id="idm140737321710512"></a><p class="title"><strong>Example 5.55. <code class="function">lib.strings.escapeShellArgs</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
escapeShellArgs ["one" "two three" "four'five"]
=&gt; "'one' 'two three' 'four'\\''five'"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.escapeShellArgs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L328" target="_top">lib/strings.nix:328</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.escapeNixString"></a>5.1.3.21. <code class="function">lib.strings.escapeNixString</code></h4></div><div><h5 class="subtitle"><code class="literal">string -&gt; string</code>
      </h5></div></div></div><p>
       Turn a string into a Nix expression representing that string
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">s</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321701184"></a><p class="title"><strong>Example 5.56. <code class="function">lib.strings.escapeNixString</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
escapeNixString "hello\${}\n"
=&gt; "\"hello\\\${}\\n\""
</pre></div></div><br class="example-break" /><p><a id="lib.strings.escapeNixString"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L338" target="_top">lib/strings.nix:338</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.escapeRegex"></a>5.1.3.22. <code class="function">lib.strings.escapeRegex</code></h4></div><div><h5 class="subtitle"><code class="literal">string -&gt; string</code>
      </h5></div></div></div><p>
       Turn a string into an exact regular expression
      </p><div class="example"><a id="idm140737321694384"></a><p class="title"><strong>Example 5.57. <code class="function">lib.strings.escapeRegex</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
escapeRegex "[^a-z]*"
=&gt; "\\[\\^a-z]\\*"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.escapeRegex"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L348" target="_top">lib/strings.nix:348</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.escapeNixIdentifier"></a>5.1.3.23. <code class="function">lib.strings.escapeNixIdentifier</code></h4></div><div><h5 class="subtitle"><code class="literal">string -&gt; string</code>
      </h5></div></div></div><p>
       Quotes a string if it can't be used as an identifier directly.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">s</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321685136"></a><p class="title"><strong>Example 5.58. <code class="function">lib.strings.escapeNixIdentifier</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
escapeNixIdentifier "hello"
=&gt; "hello"
escapeNixIdentifier "0abc"
=&gt; "\"0abc\""
</pre></div></div><br class="example-break" /><p><a id="lib.strings.escapeNixIdentifier"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L360" target="_top">lib/strings.nix:360</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.toLower"></a>5.1.3.24. <code class="function">lib.strings.toLower</code></h4></div><div><h5 class="subtitle"><code class="literal">toLower :: string -&gt; string</code>
      </h5></div></div></div><p>
       Converts an ASCII string to lower-case.
      </p><div class="example"><a id="idm140737321678400"></a><p class="title"><strong>Example 5.59. <code class="function">lib.strings.toLower</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
toLower "HOME"
=&gt; "home"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.toLower"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L391" target="_top">lib/strings.nix:391</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.toUpper"></a>5.1.3.25. <code class="function">lib.strings.toUpper</code></h4></div><div><h5 class="subtitle"><code class="literal">toUpper :: string -&gt; string</code>
      </h5></div></div></div><p>
       Converts an ASCII string to upper-case.
      </p><div class="example"><a id="idm140737321671760"></a><p class="title"><strong>Example 5.60. <code class="function">lib.strings.toUpper</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
toUpper "home"
=&gt; "HOME"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.toUpper"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L401" target="_top">lib/strings.nix:401</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.addContextFrom"></a>5.1.3.26. <code class="function">lib.strings.addContextFrom</code></h4></div></div></div><p>
       Appends string context from another string. This is an implementation detail of Nix.
      </p><p>
       Strings in Nix carry an invisible `context` which is a list of strings representing store paths. If the string is later used in a derivation attribute, the derivation will properly populate the inputDrvs and inputSrcs.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">a</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">b</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321660496"></a><p class="title"><strong>Example 5.61. <code class="function">lib.strings.addContextFrom</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
pkgs = import &lt;nixpkgs&gt; { };
addContextFrom pkgs.coreutils "bar"
=&gt; "bar"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.addContextFrom"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L416" target="_top">lib/strings.nix:416</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.splitString"></a>5.1.3.27. <code class="function">lib.strings.splitString</code></h4></div></div></div><p>
       Cut a string with a separator and produces a list of strings which were separated by this separator.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">_sep</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">_s</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321649920"></a><p class="title"><strong>Example 5.62. <code class="function">lib.strings.splitString</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
splitString "." "foo.bar.baz"
=&gt; [ "foo" "bar" "baz" ]
splitString "/" "/usr/local/bin"
=&gt; [ "" "usr" "local" "bin" ]
</pre></div></div><br class="example-break" /><p><a id="lib.strings.splitString"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L427" target="_top">lib/strings.nix:427</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.removePrefix"></a>5.1.3.28. <code class="function">lib.strings.removePrefix</code></h4></div><div><h5 class="subtitle"><code class="literal">string -&gt; string -&gt; string</code>
      </h5></div></div></div><p>
       Return a string without the specified prefix, if the prefix matches.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">prefix</code>
        </span></dt><dd><p>
          Prefix to remove if it matches
         </p></dd><dt><span class="term">
         <code class="varname">str</code>
        </span></dt><dd><p>
          Input string
         </p></dd></dl></div><div class="example"><a id="idm140737321638576"></a><p class="title"><strong>Example 5.63. <code class="function">lib.strings.removePrefix</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
removePrefix "foo." "foo.bar.baz"
=&gt; "bar.baz"
removePrefix "xxx" "foo.bar.baz"
=&gt; "foo.bar.baz"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.removePrefix"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L445" target="_top">lib/strings.nix:445</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.removeSuffix"></a>5.1.3.29. <code class="function">lib.strings.removeSuffix</code></h4></div><div><h5 class="subtitle"><code class="literal">string -&gt; string -&gt; string</code>
      </h5></div></div></div><p>
       Return a string without the specified suffix, if the suffix matches.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">suffix</code>
        </span></dt><dd><p>
          Suffix to remove if it matches
         </p></dd><dt><span class="term">
         <code class="varname">str</code>
        </span></dt><dd><p>
          Input string
         </p></dd></dl></div><div class="example"><a id="idm140737321627248"></a><p class="title"><strong>Example 5.64. <code class="function">lib.strings.removeSuffix</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
removeSuffix "front" "homefront"
=&gt; "home"
removeSuffix "xxx" "homefront"
=&gt; "homefront"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.removeSuffix"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L469" target="_top">lib/strings.nix:469</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.versionOlder"></a>5.1.3.30. <code class="function">lib.strings.versionOlder</code></h4></div></div></div><p>
       Return true if string v1 denotes a version older than v2.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">v1</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">v2</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321616752"></a><p class="title"><strong>Example 5.65. <code class="function">lib.strings.versionOlder</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
versionOlder "1.1" "1.2"
=&gt; true
versionOlder "1.1" "1.1"
=&gt; false
</pre></div></div><br class="example-break" /><p><a id="lib.strings.versionOlder"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L491" target="_top">lib/strings.nix:491</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.versionAtLeast"></a>5.1.3.31. <code class="function">lib.strings.versionAtLeast</code></h4></div></div></div><p>
       Return true if string v1 denotes a version equal to or newer than v2.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">v1</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">v2</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321606336"></a><p class="title"><strong>Example 5.66. <code class="function">lib.strings.versionAtLeast</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
versionAtLeast "1.1" "1.0"
=&gt; true
versionAtLeast "1.1" "1.1"
=&gt; true
versionAtLeast "1.1" "1.2"
=&gt; false
</pre></div></div><br class="example-break" /><p><a id="lib.strings.versionAtLeast"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L503" target="_top">lib/strings.nix:503</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.getName"></a>5.1.3.32. <code class="function">lib.strings.getName</code></h4></div></div></div><p>
       This function takes an argument that's either a derivation or a derivation's "name" attribute and extracts the name part from that argument.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321597792"></a><p class="title"><strong>Example 5.67. <code class="function">lib.strings.getName</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
getName "youtube-dl-2016.01.01"
=&gt; "youtube-dl"
getName pkgs.youtube-dl
=&gt; "youtube-dl"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.getName"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L515" target="_top">lib/strings.nix:515</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.getVersion"></a>5.1.3.33. <code class="function">lib.strings.getVersion</code></h4></div></div></div><p>
       This function takes an argument that's either a derivation or a derivation's "name" attribute and extracts the version part from that argument.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321589264"></a><p class="title"><strong>Example 5.68. <code class="function">lib.strings.getVersion</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
getVersion "youtube-dl-2016.01.01"
=&gt; "2016.01.01"
getVersion pkgs.youtube-dl
=&gt; "2016.01.01"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.getVersion"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L532" target="_top">lib/strings.nix:532</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.nameFromURL"></a>5.1.3.34. <code class="function">lib.strings.nameFromURL</code></h4></div></div></div><p>
       Extract name with version from URL. Ask for separator which is supposed to start extension.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">url</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">sep</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321578832"></a><p class="title"><strong>Example 5.69. <code class="function">lib.strings.nameFromURL</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
nameFromURL "https://nixos.org/releases/nix/nix-1.7/nix-1.7-x86_64-linux.tar.bz2" "-"
=&gt; "nix"
nameFromURL "https://nixos.org/releases/nix/nix-1.7/nix-1.7-x86_64-linux.tar.bz2" "_"
=&gt; "nix-1.7-x86"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.nameFromURL"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L548" target="_top">lib/strings.nix:548</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.enableFeature"></a>5.1.3.35. <code class="function">lib.strings.enableFeature</code></h4></div></div></div><p>
       Create an --{enable,disable}-&lt;feat&gt; string that can be passed to standard GNU Autoconf scripts.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">enable</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">feat</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321568208"></a><p class="title"><strong>Example 5.70. <code class="function">lib.strings.enableFeature</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
enableFeature true "shared"
=&gt; "--enable-shared"
enableFeature false "shared"
=&gt; "--disable-shared"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.enableFeature"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L564" target="_top">lib/strings.nix:564</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.enableFeatureAs"></a>5.1.3.36. <code class="function">lib.strings.enableFeatureAs</code></h4></div></div></div><p>
       Create an --{enable-&lt;feat&gt;=&lt;value&gt;,disable-&lt;feat&gt;} string that can be passed to standard GNU Autoconf scripts.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">enable</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">feat</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">value</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321555248"></a><p class="title"><strong>Example 5.71. <code class="function">lib.strings.enableFeatureAs</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
enableFeatureAs true "shared" "foo"
=&gt; "--enable-shared=foo"
enableFeatureAs false "shared" (throw "ignored")
=&gt; "--disable-shared"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.enableFeatureAs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L577" target="_top">lib/strings.nix:577</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.withFeature"></a>5.1.3.37. <code class="function">lib.strings.withFeature</code></h4></div></div></div><p>
       Create an --{with,without}-&lt;feat&gt; string that can be passed to standard GNU Autoconf scripts.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">with_</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">feat</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321544400"></a><p class="title"><strong>Example 5.72. <code class="function">lib.strings.withFeature</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
withFeature true "shared"
=&gt; "--with-shared"
withFeature false "shared"
=&gt; "--without-shared"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.withFeature"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L588" target="_top">lib/strings.nix:588</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.withFeatureAs"></a>5.1.3.38. <code class="function">lib.strings.withFeatureAs</code></h4></div></div></div><p>
       Create an --{with-&lt;feat&gt;=&lt;value&gt;,without-&lt;feat&gt;} string that can be passed to standard GNU Autoconf scripts.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">with_</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">feat</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">value</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321531760"></a><p class="title"><strong>Example 5.73. <code class="function">lib.strings.withFeatureAs</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
withFeatureAs true "shared" "foo"
=&gt; "--with-shared=foo"
withFeatureAs false "shared" (throw "ignored")
=&gt; "--without-shared"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.withFeatureAs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L601" target="_top">lib/strings.nix:601</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.fixedWidthString"></a>5.1.3.39. <code class="function">lib.strings.fixedWidthString</code></h4></div><div><h5 class="subtitle"><code class="literal">fixedWidthString :: int -&gt; string -&gt; string -&gt; string</code>
      </h5></div></div></div><p>
       Create a fixed width string with additional prefix to match required width.
      </p><p>
       This function will fail if the input string is longer than the requested length.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">width</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">filler</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">str</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321517680"></a><p class="title"><strong>Example 5.74. <code class="function">lib.strings.fixedWidthString</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
fixedWidthString 5 "0" (toString 15)
=&gt; "00015"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.fixedWidthString"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L615" target="_top">lib/strings.nix:615</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.fixedWidthNumber"></a>5.1.3.40. <code class="function">lib.strings.fixedWidthNumber</code></h4></div></div></div><p>
       Format a number adding leading zeroes up to fixed width.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">width</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">n</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321507264"></a><p class="title"><strong>Example 5.75. <code class="function">lib.strings.fixedWidthNumber</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
fixedWidthNumber 5 15
=&gt; "00015"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.fixedWidthNumber"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L632" target="_top">lib/strings.nix:632</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.floatToString"></a>5.1.3.41. <code class="function">lib.strings.floatToString</code></h4></div></div></div><p>
       Convert a float to a string, but emit a warning when precision is lost during the conversion
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">float</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321498704"></a><p class="title"><strong>Example 5.76. <code class="function">lib.strings.floatToString</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
floatToString 0.000001
=&gt; "0.000001"
floatToString 0.0000001
=&gt; trace: warning: Imprecise conversion from float to string 0.000000
"0.000000"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.floatToString"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L644" target="_top">lib/strings.nix:644</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.isCoercibleToString"></a>5.1.3.42. <code class="function">lib.strings.isCoercibleToString</code></h4></div></div></div><p>
       Check whether a value can be coerced to a string
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.strings.isCoercibleToString"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L651" target="_top">lib/strings.nix:651</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.isStorePath"></a>5.1.3.43. <code class="function">lib.strings.isStorePath</code></h4></div></div></div><p>
       Check whether a value is a store path.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321483312"></a><p class="title"><strong>Example 5.77. <code class="function">lib.strings.isStorePath</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
isStorePath "/nix/store/d945ibfx9x185xf04b890y4f9g3cbb63-python-2.7.11/bin/python"
=&gt; false
isStorePath "/nix/store/d945ibfx9x185xf04b890y4f9g3cbb63-python-2.7.11"
=&gt; true
isStorePath pkgs.python
=&gt; true
isStorePath [] || isStorePath 42 || isStorePath {} || …
=&gt; false
</pre></div></div><br class="example-break" /><p><a id="lib.strings.isStorePath"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L669" target="_top">lib/strings.nix:669</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.toInt"></a>5.1.3.44. <code class="function">lib.strings.toInt</code></h4></div><div><h5 class="subtitle"><code class="literal">string -&gt; int</code>
      </h5></div></div></div><p>
       Parse a string as an int.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">str</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321473920"></a><p class="title"><strong>Example 5.78. <code class="function">lib.strings.toInt</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
toInt "1337"
=&gt; 1337
toInt "-4"
=&gt; -4
toInt "3.14"
=&gt; error: floating point JSON numbers are not supported
</pre></div></div><br class="example-break" /><p><a id="lib.strings.toInt"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L690" target="_top">lib/strings.nix:690</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.readPathsFromFile"></a>5.1.3.45. <code class="function">lib.strings.readPathsFromFile</code></h4></div></div></div><p>
       Read a list of paths from `file`, relative to the `rootPath`. Lines beginning with `#` are treated as comments and ignored. Whitespace is significant.
      </p><p>
       NOTE: This function is not performant and should be avoided.
      </p><div class="example"><a id="idm140737321467264"></a><p class="title"><strong>Example 5.79. <code class="function">lib.strings.readPathsFromFile</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
readPathsFromFile /prefix
./pkgs/development/libraries/qt-5/5.4/qtbase/series
=&gt; [ "/prefix/dlopen-resolv.patch" "/prefix/tzdir.patch"
"/prefix/dlopen-libXcursor.patch" "/prefix/dlopen-openssl.patch"
"/prefix/dlopen-dbus.patch" "/prefix/xdg-config-dirs.patch"
"/prefix/nix-profiles-library-paths.patch"
"/prefix/compose-search-path.patch" ]
</pre></div></div><br class="example-break" /><p><a id="lib.strings.readPathsFromFile"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L711" target="_top">lib/strings.nix:711</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.fileContents"></a>5.1.3.46. <code class="function">lib.strings.fileContents</code></h4></div><div><h5 class="subtitle"><code class="literal">fileContents :: path -&gt; string</code>
      </h5></div></div></div><p>
       Read the contents of a file removing the trailing \n
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">file</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321457632"></a><p class="title"><strong>Example 5.80. <code class="function">lib.strings.fileContents</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
$ echo "1.0" &gt; ./version

fileContents ./version
=&gt; "1.0"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.fileContents"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L731" target="_top">lib/strings.nix:731</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.strings.sanitizeDerivationName"></a>5.1.3.47. <code class="function">lib.strings.sanitizeDerivationName</code></h4></div><div><h5 class="subtitle"><code class="literal">sanitizeDerivationName :: String -&gt; String</code>
      </h5></div></div></div><p>
       Creates a valid derivation name from a potentially invalid one.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">string</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321448320"></a><p class="title"><strong>Example 5.81. <code class="function">lib.strings.sanitizeDerivationName</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
sanitizeDerivationName "../hello.bar # foo"
=&gt; "-hello.bar-foo"
sanitizeDerivationName ""
=&gt; "unknown"
sanitizeDerivationName pkgs.hello
=&gt; "-nix-store-2g75chlbpxlrqn15zlby2dfh8hr9qwbk-hello-2.10"
</pre></div></div><br class="example-break" /><p><a id="lib.strings.sanitizeDerivationName"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/strings.nix#L746" target="_top">lib/strings.nix:746</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-functions-library-trivial"></a>5.1.4. Miscellaneous functions</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.id"></a>5.1.4.1. <code class="function">lib.trivial.id</code></h4></div><div><h5 class="subtitle"><code class="literal">id :: a -&gt; a</code>
      </h5></div></div></div><p>
       The identity function For when you need a function that does “nothing”.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          The value to return
         </p></dd></dl></div><p><a id="lib.trivial.id"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L12" target="_top">lib/trivial.nix:12</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.const"></a>5.1.4.2. <code class="function">lib.trivial.const</code></h4></div><div><h5 class="subtitle"><code class="literal">const :: a -&gt; b -&gt; a</code>
      </h5></div></div></div><p>
       The constant function
      </p><p>
       Ignores the second argument. If called with only one argument, constructs a function that always returns a static value.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Value to return
         </p></dd><dt><span class="term">
         <code class="varname">y</code>
        </span></dt><dd><p>
          Value to ignore
         </p></dd></dl></div><div class="example"><a id="idm140737321425872"></a><p class="title"><strong>Example 5.82. <code class="function">lib.trivial.const</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
let f = const 5; in f 10
=&gt; 5
</pre></div></div><br class="example-break" /><p><a id="lib.trivial.const"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L26" target="_top">lib/trivial.nix:26</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.pipe"></a>5.1.4.3. <code class="function">lib.trivial.pipe</code></h4></div><div><h5 class="subtitle"><code class="literal">pipe :: a -&gt; [&lt;functions&gt;] -&gt; &lt;return type of last function&gt;</code>
      </h5></div></div></div><p>
       Pipes a value through a list of functions, left to right.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">val</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">functions</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321414544"></a><p class="title"><strong>Example 5.83. <code class="function">lib.trivial.pipe</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
pipe 2 [
(x: x + 2)  # 2 + 2 = 4
(x: x * 2)  # 4 * 2 = 8
]
=&gt; 8

# ideal to do text transformations
pipe [ "a/b" "a/c" ] [

# create the cp command
(map (file: ''cp "${src}/${file}" $out\n''))

# concatenate all commands into one string
lib.concatStrings

# make that string into a nix derivation
(pkgs.runCommand "copy-to-out" {})

]
=&gt; &lt;drv which copies all files to $out&gt;

The output type of each function has to be the input type
of the next function, and the last function returns the
final value.
</pre></div></div><br class="example-break" /><p><a id="lib.trivial.pipe"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L61" target="_top">lib/trivial.nix:61</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.concat"></a>5.1.4.4. <code class="function">lib.trivial.concat</code></h4></div></div></div><p>
       note please don’t add a function like `compose = flip pipe`. This would confuse users, because the order of the functions in the list is not clear. With pipe, it’s obvious that it goes first-to-last. With `compose`, not so much.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">y</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.concat"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L80" target="_top">lib/trivial.nix:80</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.or"></a>5.1.4.5. <code class="function">lib.trivial.or</code></h4></div></div></div><p>
       boolean “or”
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">y</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.or"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L83" target="_top">lib/trivial.nix:83</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.and"></a>5.1.4.6. <code class="function">lib.trivial.and</code></h4></div></div></div><p>
       boolean “and”
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">y</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.and"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L86" target="_top">lib/trivial.nix:86</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.bitAnd"></a>5.1.4.7. <code class="function">lib.trivial.bitAnd</code></h4></div></div></div><p>
       bitwise “and”
      </p><p><a id="lib.trivial.bitAnd"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L89" target="_top">lib/trivial.nix:89</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.bitOr"></a>5.1.4.8. <code class="function">lib.trivial.bitOr</code></h4></div></div></div><p>
       bitwise “or”
      </p><p><a id="lib.trivial.bitOr"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L94" target="_top">lib/trivial.nix:94</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.bitXor"></a>5.1.4.9. <code class="function">lib.trivial.bitXor</code></h4></div></div></div><p>
       bitwise “xor”
      </p><p><a id="lib.trivial.bitXor"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L99" target="_top">lib/trivial.nix:99</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.bitNot"></a>5.1.4.10. <code class="function">lib.trivial.bitNot</code></h4></div></div></div><p>
       bitwise “not”
      </p><p><a id="lib.trivial.bitNot"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L104" target="_top">lib/trivial.nix:104</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.boolToString"></a>5.1.4.11. <code class="function">lib.trivial.boolToString</code></h4></div><div><h5 class="subtitle"><code class="literal">boolToString :: bool -&gt; string</code>
      </h5></div></div></div><p>
       Convert a boolean to a string.
      </p><p>
       This function uses the strings "true" and "false" to represent boolean values. Calling `toString` on a bool instead returns "1" and "" (sic!).
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">b</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.boolToString"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L114" target="_top">lib/trivial.nix:114</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.mergeAttrs"></a>5.1.4.12. <code class="function">lib.trivial.mergeAttrs</code></h4></div></div></div><p>
       Merge two attribute sets shallowly, right side trumps left
      </p><p>
       mergeAttrs :: attrs -&gt; attrs -&gt; attrs
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Left attribute set
         </p></dd><dt><span class="term">
         <code class="varname">y</code>
        </span></dt><dd><p>
          Right attribute set (higher precedence for equal keys)
         </p></dd></dl></div><div class="example"><a id="idm140737321351008"></a><p class="title"><strong>Example 5.84. <code class="function">lib.trivial.mergeAttrs</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
mergeAttrs { a = 1; b = 2; } { b = 3; c = 4; }
=&gt; { a = 1; b = 3; c = 4; }
</pre></div></div><br class="example-break" /><p><a id="lib.trivial.mergeAttrs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L124" target="_top">lib/trivial.nix:124</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.flip"></a>5.1.4.13. <code class="function">lib.trivial.flip</code></h4></div><div><h5 class="subtitle"><code class="literal">flip :: (a -&gt; b -&gt; c) -&gt; (b -&gt; a -&gt; c)</code>
      </h5></div></div></div><p>
       Flip the order of the arguments of a binary function.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">a</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">b</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321337760"></a><p class="title"><strong>Example 5.85. <code class="function">lib.trivial.flip</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
flip concat [1] [2]
=&gt; [ 2 1 ]
</pre></div></div><br class="example-break" /><p><a id="lib.trivial.flip"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L138" target="_top">lib/trivial.nix:138</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.mapNullable"></a>5.1.4.14. <code class="function">lib.trivial.mapNullable</code></h4></div></div></div><p>
       Apply function if the supplied argument is non-null.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function to call
         </p></dd><dt><span class="term">
         <code class="varname">a</code>
        </span></dt><dd><p>
          Argument to check for null before passing it to `f`
         </p></dd></dl></div><div class="example"><a id="idm140737321327456"></a><p class="title"><strong>Example 5.86. <code class="function">lib.trivial.mapNullable</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
mapNullable (x: x+1) null
=&gt; null
mapNullable (x: x+1) 22
=&gt; 23
</pre></div></div><br class="example-break" /><p><a id="lib.trivial.mapNullable"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L148" target="_top">lib/trivial.nix:148</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.version"></a>5.1.4.15. <code class="function">lib.trivial.version</code></h4></div></div></div><p>
       Returns the current full nixpkgs version number.
      </p><p><a id="lib.trivial.version"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L164" target="_top">lib/trivial.nix:164</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.release"></a>5.1.4.16. <code class="function">lib.trivial.release</code></h4></div></div></div><p>
       Returns the current nixpkgs release number as string.
      </p><p><a id="lib.trivial.release"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L167" target="_top">lib/trivial.nix:167</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.codeName"></a>5.1.4.17. <code class="function">lib.trivial.codeName</code></h4></div></div></div><p>
       Returns the current nixpkgs release code name.
      </p><p>
       On each release the first letter is bumped and a new animal is chosen starting with that new letter.
      </p><p><a id="lib.trivial.codeName"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L174" target="_top">lib/trivial.nix:174</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.versionSuffix"></a>5.1.4.18. <code class="function">lib.trivial.versionSuffix</code></h4></div></div></div><p>
       Returns the current nixpkgs version suffix as string.
      </p><p><a id="lib.trivial.versionSuffix"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L177" target="_top">lib/trivial.nix:177</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.revisionWithDefault"></a>5.1.4.19. <code class="function">lib.trivial.revisionWithDefault</code></h4></div><div><h5 class="subtitle"><code class="literal">revisionWithDefault :: string -&gt; string</code>
      </h5></div></div></div><p>
       Attempts to return the the current revision of nixpkgs and returns the supplied default value otherwise.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">default</code>
        </span></dt><dd><p>
          Default value to return if revision can not be determined
         </p></dd></dl></div><p><a id="lib.trivial.revisionWithDefault"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L188" target="_top">lib/trivial.nix:188</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.inNixShell"></a>5.1.4.20. <code class="function">lib.trivial.inNixShell</code></h4></div><div><h5 class="subtitle"><code class="literal">inNixShell :: bool</code>
      </h5></div></div></div><p>
       Determine whether the function is being called from inside a Nix shell.
      </p><p><a id="lib.trivial.inNixShell"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L206" target="_top">lib/trivial.nix:206</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.min"></a>5.1.4.21. <code class="function">lib.trivial.min</code></h4></div></div></div><p>
       Return minimum of two numbers.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">y</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.min"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L212" target="_top">lib/trivial.nix:212</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.max"></a>5.1.4.22. <code class="function">lib.trivial.max</code></h4></div></div></div><p>
       Return maximum of two numbers.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">y</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.max"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L215" target="_top">lib/trivial.nix:215</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.mod"></a>5.1.4.23. <code class="function">lib.trivial.mod</code></h4></div></div></div><p>
       Integer modulus
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">base</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">int</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321268704"></a><p class="title"><strong>Example 5.87. <code class="function">lib.trivial.mod</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
mod 11 10
=&gt; 1
mod 1 10
=&gt; 1
</pre></div></div><br class="example-break" /><p><a id="lib.trivial.mod"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L225" target="_top">lib/trivial.nix:225</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.compare"></a>5.1.4.24. <code class="function">lib.trivial.compare</code></h4></div></div></div><p>
       C-style comparisons
      </p><p>
       a &lt; b, compare a b =&gt; -1 a == b, compare a b =&gt; 0 a &gt; b, compare a b =&gt; 1
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">a</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">b</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.compare"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L236" target="_top">lib/trivial.nix:236</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.splitByAndCompare"></a>5.1.4.25. <code class="function">lib.trivial.splitByAndCompare</code></h4></div><div><h5 class="subtitle"><code class="literal">(a -&gt; bool) -&gt; (a -&gt; a -&gt; int) -&gt; (a -&gt; a -&gt; int) -&gt; (a -&gt; a -&gt; int)</code>
      </h5></div></div></div><p>
       Split type into two subtypes by predicate `p`, take all elements of the first subtype to be less than all the elements of the second subtype, compare elements of a single subtype with `yes` and `no` respectively.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">p</code>
        </span></dt><dd><p>
          Predicate
         </p></dd><dt><span class="term">
         <code class="varname">yes</code>
        </span></dt><dd><p>
          Comparison function if predicate holds for both values
         </p></dd><dt><span class="term">
         <code class="varname">no</code>
        </span></dt><dd><p>
          Comparison function if predicate holds for neither value
         </p></dd><dt><span class="term">
         <code class="varname">a</code>
        </span></dt><dd><p>
          First value to compare
         </p></dd><dt><span class="term">
         <code class="varname">b</code>
        </span></dt><dd><p>
          Second value to compare
         </p></dd></dl></div><div class="example"><a id="idm140737321241776"></a><p class="title"><strong>Example 5.88. <code class="function">lib.trivial.splitByAndCompare</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
let cmp = splitByAndCompare (hasPrefix "foo") compare compare; in

cmp "a" "z" =&gt; -1
cmp "fooa" "fooz" =&gt; -1

cmp "f" "a" =&gt; 1
cmp "fooa" "a" =&gt; -1
# while
compare "fooa" "a" =&gt; 1
</pre></div></div><br class="example-break" /><p><a id="lib.trivial.splitByAndCompare"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L261" target="_top">lib/trivial.nix:261</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.importJSON"></a>5.1.4.26. <code class="function">lib.trivial.importJSON</code></h4></div></div></div><p>
       Reads a JSON file.
      </p><p>
       Type :: path -&gt; any
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">path</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.importJSON"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L281" target="_top">lib/trivial.nix:281</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.importTOML"></a>5.1.4.27. <code class="function">lib.trivial.importTOML</code></h4></div></div></div><p>
       Reads a TOML file.
      </p><p>
       Type :: path -&gt; any
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">path</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.importTOML"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L288" target="_top">lib/trivial.nix:288</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.setFunctionArgs"></a>5.1.4.28. <code class="function">lib.trivial.setFunctionArgs</code></h4></div></div></div><p>
       Add metadata about expected function arguments to a function. The metadata should match the format given by builtins.functionArgs, i.e. a set from expected argument to a bool representing whether that argument has a default or not. setFunctionArgs : (a → b) → Map String Bool → (a → b)
      </p><p>
       This function is necessary because you can't dynamically create a function of the { a, b ? foo, ... }: format, but some facilities like callPackage expect to be able to query expected arguments.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">args</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.setFunctionArgs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L325" target="_top">lib/trivial.nix:325</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.functionArgs"></a>5.1.4.29. <code class="function">lib.trivial.functionArgs</code></h4></div></div></div><p>
       Extract the expected function arguments from a function. This works both with nix-native { a, b ? foo, ... }: style functions and functions with args set with 'setFunctionArgs'. It has the same return type and semantics as builtins.functionArgs. setFunctionArgs : (a → b) → Map String Bool.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.functionArgs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L337" target="_top">lib/trivial.nix:337</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.isFunction"></a>5.1.4.30. <code class="function">lib.trivial.isFunction</code></h4></div></div></div><p>
       Check whether something is a function or something annotated with function args.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.isFunction"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L345" target="_top">lib/trivial.nix:345</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.toHexString"></a>5.1.4.31. <code class="function">lib.trivial.toHexString</code></h4></div></div></div><p>
       Convert the given positive integer to a string of its hexadecimal representation. For example:
      </p><p>
       toHexString 0 =&gt; "0"
      </p><p>
       toHexString 16 =&gt; "10"
      </p><p>
       toHexString 250 =&gt; "FA"
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">i</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.toHexString"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L357" target="_top">lib/trivial.nix:357</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.trivial.toBaseDigits"></a>5.1.4.32. <code class="function">lib.trivial.toBaseDigits</code></h4></div></div></div><p>
       `toBaseDigits base i` converts the positive integer i to a list of its digits in the given base. For example:
      </p><p>
       toBaseDigits 10 123 =&gt; [ 1 2 3 ]
      </p><p>
       toBaseDigits 2 6 =&gt; [ 1 1 0 ]
      </p><p>
       toBaseDigits 16 250 =&gt; [ 15 10 ]
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">base</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">i</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.trivial.toBaseDigits"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix#L383" target="_top">lib/trivial.nix:383</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-functions-library-lists"></a>5.1.5. List manipulation functions</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.singleton"></a>5.1.5.1. <code class="function">lib.lists.singleton</code></h4></div><div><h5 class="subtitle"><code class="literal">singleton :: a -&gt; [a]</code>
      </h5></div></div></div><p>
       Create a list consisting of a single element. `singleton x` is sometimes more convenient with respect to indentation than `[x]` when x spans multiple lines.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321172064"></a><p class="title"><strong>Example 5.89. <code class="function">lib.lists.singleton</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
singleton "foo"
=&gt; [ "foo" ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.singleton"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L22" target="_top">lib/lists.nix:22</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.forEach"></a>5.1.5.2. <code class="function">lib.lists.forEach</code></h4></div><div><h5 class="subtitle"><code class="literal">forEach :: [a] -&gt; (a -&gt; b) -&gt; [b]</code>
      </h5></div></div></div><p>
       Apply the function to each element in the list. Same as `map`, but arguments flipped.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">xs</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321161008"></a><p class="title"><strong>Example 5.90. <code class="function">lib.lists.forEach</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
forEach [ 1 2 ] (x:
toString x
)
=&gt; [ "1" "2" ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.forEach"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L35" target="_top">lib/lists.nix:35</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.foldr"></a>5.1.5.3. <code class="function">lib.lists.foldr</code></h4></div><div><h5 class="subtitle"><code class="literal">foldr :: (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b</code>
      </h5></div></div></div><p>
       “right fold” a binary function `op` between successive elements of `list` with `nul' as the starting value, i.e., `foldr op nul [x_1 x_2 ... x_n] == op x_1 (op x_2 ... (op x_n nul))`.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">op</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">nul</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321147408"></a><p class="title"><strong>Example 5.91. <code class="function">lib.lists.foldr</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
concat = foldr (a: b: a + b) "z"
concat [ "a" "b" "c" ]
=&gt; "abcz"
# different types
strange = foldr (int: str: toString (int + 1) + str) "a"
strange [ 1 2 3 4 ]
=&gt; "2345a"
</pre></div></div><br class="example-break" /><p><a id="lib.lists.foldr"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L52" target="_top">lib/lists.nix:52</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.fold"></a>5.1.5.4. <code class="function">lib.lists.fold</code></h4></div></div></div><p>
       `fold` is an alias of `foldr` for historic reasons
      </p><p><a id="lib.lists.fold"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L63" target="_top">lib/lists.nix:63</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.foldl"></a>5.1.5.5. <code class="function">lib.lists.foldl</code></h4></div><div><h5 class="subtitle"><code class="literal">foldl :: (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b</code>
      </h5></div></div></div><p>
       “left fold”, like `foldr`, but from the left: `foldl op nul [x_1 x_2 ... x_n] == op (... (op (op nul x_1) x_2) ... x_n)`.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">op</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">nul</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321129648"></a><p class="title"><strong>Example 5.92. <code class="function">lib.lists.foldl</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
lconcat = foldl (a: b: a + b) "z"
lconcat [ "a" "b" "c" ]
=&gt; "zabc"
# different types
lstrange = foldl (str: int: str + toString (int + 1)) "a"
lstrange [ 1 2 3 4 ]
=&gt; "a2345"
</pre></div></div><br class="example-break" /><p><a id="lib.lists.foldl"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L80" target="_top">lib/lists.nix:80</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.foldl-prime"></a>5.1.5.6. <code class="function">lib.lists.foldl'</code></h4></div><div><h5 class="subtitle"><code class="literal">foldl' :: (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b</code>
      </h5></div></div></div><p>
       Strict version of `foldl`.
      </p><p>
       The difference is that evaluation is forced upon access. Usually used with small whole results (in contrast with lazily-generated list or large lists where only a part is consumed.)
      </p><p><a id="lib.lists.foldl-prime"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L96" target="_top">lib/lists.nix:96</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.imap0"></a>5.1.5.7. <code class="function">lib.lists.imap0</code></h4></div><div><h5 class="subtitle"><code class="literal">imap0 :: (int -&gt; a -&gt; b) -&gt; [a] -&gt; [b]</code>
      </h5></div></div></div><p>
       Map with index starting from 0
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321112640"></a><p class="title"><strong>Example 5.93. <code class="function">lib.lists.imap0</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
imap0 (i: v: "${v}-${toString i}") ["a" "b"]
=&gt; [ "a-0" "b-1" ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.imap0"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L106" target="_top">lib/lists.nix:106</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.imap1"></a>5.1.5.8. <code class="function">lib.lists.imap1</code></h4></div><div><h5 class="subtitle"><code class="literal">imap1 :: (int -&gt; a -&gt; b) -&gt; [a] -&gt; [b]</code>
      </h5></div></div></div><p>
       Map with index starting from 1
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321101360"></a><p class="title"><strong>Example 5.94. <code class="function">lib.lists.imap1</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
imap1 (i: v: "${v}-${toString i}") ["a" "b"]
=&gt; [ "a-1" "b-2" ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.imap1"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L116" target="_top">lib/lists.nix:116</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.concatMap"></a>5.1.5.9. <code class="function">lib.lists.concatMap</code></h4></div><div><h5 class="subtitle"><code class="literal">concatMap :: (a -&gt; [b]) -&gt; [a] -&gt; [b]</code>
      </h5></div></div></div><p>
       Map and concatenate the result.
      </p><div class="example"><a id="idm140737321094592"></a><p class="title"><strong>Example 5.95. <code class="function">lib.lists.concatMap</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
concatMap (x: [x] ++ ["z"]) ["a" "b"]
=&gt; [ "a" "z" "b" "z" ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.concatMap"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L126" target="_top">lib/lists.nix:126</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.flatten"></a>5.1.5.10. <code class="function">lib.lists.flatten</code></h4></div></div></div><p>
       Flatten the argument into a single list; that is, nested lists are spliced into the top-level lists.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321086096"></a><p class="title"><strong>Example 5.96. <code class="function">lib.lists.flatten</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
flatten [1 [2 [3] 4] 5]
=&gt; [1 2 3 4 5]
flatten 1
=&gt; [1]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.flatten"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L137" target="_top">lib/lists.nix:137</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.remove"></a>5.1.5.11. <code class="function">lib.lists.remove</code></h4></div><div><h5 class="subtitle"><code class="literal">remove :: a -&gt; [a] -&gt; [a]</code>
      </h5></div></div></div><p>
       Remove elements equal to 'e' from a list. Useful for buildInputs.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">e</code>
        </span></dt><dd><p>
          Element to remove from the list
         </p></dd></dl></div><div class="example"><a id="idm140737321076800"></a><p class="title"><strong>Example 5.97. <code class="function">lib.lists.remove</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
remove 3 [ 1 3 4 3 ]
=&gt; [ 1 4 ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.remove"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L150" target="_top">lib/lists.nix:150</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.findSingle"></a>5.1.5.12. <code class="function">lib.lists.findSingle</code></h4></div><div><h5 class="subtitle"><code class="literal">findSingle :: (a -&gt; bool) -&gt; a -&gt; a -&gt; [a] -&gt; a</code>
      </h5></div></div></div><p>
       Find the sole element in the list matching the specified predicate, returns `default` if no such element exists, or `multiple` if there are multiple matching elements.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">pred</code>
        </span></dt><dd><p>
          Predicate
         </p></dd><dt><span class="term">
         <code class="varname">default</code>
        </span></dt><dd><p>
          Default value to return if element was not found.
         </p></dd><dt><span class="term">
         <code class="varname">multiple</code>
        </span></dt><dd><p>
          Default value to return if more than one element was found
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Input list
         </p></dd></dl></div><div class="example"><a id="idm140737321061344"></a><p class="title"><strong>Example 5.98. <code class="function">lib.lists.findSingle</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
findSingle (x: x == 3) "none" "multiple" [ 1 3 3 ]
=&gt; "multiple"
findSingle (x: x == 3) "none" "multiple" [ 1 3 ]
=&gt; 3
findSingle (x: x == 3) "none" "multiple" [ 1 9 ]
=&gt; "none"
</pre></div></div><br class="example-break" /><p><a id="lib.lists.findSingle"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L168" target="_top">lib/lists.nix:168</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.findFirst"></a>5.1.5.13. <code class="function">lib.lists.findFirst</code></h4></div><div><h5 class="subtitle"><code class="literal">findFirst :: (a -&gt; bool) -&gt; a -&gt; [a] -&gt; a</code>
      </h5></div></div></div><p>
       Find the first element in the list matching the specified predicate or return `default` if no such element exists.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">pred</code>
        </span></dt><dd><p>
          Predicate
         </p></dd><dt><span class="term">
         <code class="varname">default</code>
        </span></dt><dd><p>
          Default value to return
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Input list
         </p></dd></dl></div><div class="example"><a id="idm140737321047648"></a><p class="title"><strong>Example 5.99. <code class="function">lib.lists.findFirst</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
findFirst (x: x &gt; 3) 7 [ 1 6 4 ]
=&gt; 6
findFirst (x: x &gt; 9) 7 [ 1 6 4 ]
=&gt; 7
</pre></div></div><br class="example-break" /><p><a id="lib.lists.findFirst"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L193" target="_top">lib/lists.nix:193</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.any"></a>5.1.5.14. <code class="function">lib.lists.any</code></h4></div><div><h5 class="subtitle"><code class="literal">any :: (a -&gt; bool) -&gt; [a] -&gt; bool</code>
      </h5></div></div></div><p>
       Return true if function `pred` returns true for at least one element of `list`.
      </p><div class="example"><a id="idm140737321040768"></a><p class="title"><strong>Example 5.100. <code class="function">lib.lists.any</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
any isString [ 1 "a" { } ]
=&gt; true
any isString [ 1 { } ]
=&gt; false
</pre></div></div><br class="example-break" /><p><a id="lib.lists.any"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L214" target="_top">lib/lists.nix:214</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.all"></a>5.1.5.15. <code class="function">lib.lists.all</code></h4></div><div><h5 class="subtitle"><code class="literal">all :: (a -&gt; bool) -&gt; [a] -&gt; bool</code>
      </h5></div></div></div><p>
       Return true if function `pred` returns true for all elements of `list`.
      </p><div class="example"><a id="idm140737321033920"></a><p class="title"><strong>Example 5.101. <code class="function">lib.lists.all</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
all (x: x &lt; 3) [ 1 2 ]
=&gt; true
all (x: x &lt; 3) [ 1 2 3 ]
=&gt; false
</pre></div></div><br class="example-break" /><p><a id="lib.lists.all"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L227" target="_top">lib/lists.nix:227</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.count"></a>5.1.5.16. <code class="function">lib.lists.count</code></h4></div><div><h5 class="subtitle"><code class="literal">count :: (a -&gt; bool) -&gt; [a] -&gt; int</code>
      </h5></div></div></div><p>
       Count how many elements of `list` match the supplied predicate function.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">pred</code>
        </span></dt><dd><p>
          Predicate
         </p></dd></dl></div><div class="example"><a id="idm140737321024752"></a><p class="title"><strong>Example 5.102. <code class="function">lib.lists.count</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
count (x: x == 3) [ 3 2 3 4 6 ]
=&gt; 2
</pre></div></div><br class="example-break" /><p><a id="lib.lists.count"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L238" target="_top">lib/lists.nix:238</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.optional"></a>5.1.5.17. <code class="function">lib.lists.optional</code></h4></div><div><h5 class="subtitle"><code class="literal">optional :: bool -&gt; a -&gt; [a]</code>
      </h5></div></div></div><p>
       Return a singleton list or an empty list, depending on a boolean value. Useful when building lists with optional elements (e.g. `++ optional (system == "i686-linux") firefox').
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">cond</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">elem</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737321013568"></a><p class="title"><strong>Example 5.103. <code class="function">lib.lists.optional</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
optional true "foo"
=&gt; [ "foo" ]
optional false "foo"
=&gt; [ ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.optional"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L254" target="_top">lib/lists.nix:254</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.optionals"></a>5.1.5.18. <code class="function">lib.lists.optionals</code></h4></div><div><h5 class="subtitle"><code class="literal">optionals :: bool -&gt; [a] -&gt; [a]</code>
      </h5></div></div></div><p>
       Return a list or an empty list, depending on a boolean value.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">cond</code>
        </span></dt><dd><p>
          Condition
         </p></dd><dt><span class="term">
         <code class="varname">elems</code>
        </span></dt><dd><p>
          List to return if condition is true
         </p></dd></dl></div><div class="example"><a id="idm140737321002320"></a><p class="title"><strong>Example 5.104. <code class="function">lib.lists.optionals</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
optionals true [ 2 3 ]
=&gt; [ 2 3 ]
optionals false [ 2 3 ]
=&gt; [ ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.optionals"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L266" target="_top">lib/lists.nix:266</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.toList"></a>5.1.5.19. <code class="function">lib.lists.toList</code></h4></div></div></div><p>
       If argument is a list, return it; else, wrap it in a singleton list. If you're using this, you should almost certainly reconsider if there isn't a more "well-typed" approach.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320994000"></a><p class="title"><strong>Example 5.105. <code class="function">lib.lists.toList</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
toList [ 1 2 ]
=&gt; [ 1 2 ]
toList "hi"
=&gt; [ "hi "]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.toList"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L283" target="_top">lib/lists.nix:283</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.range"></a>5.1.5.20. <code class="function">lib.lists.range</code></h4></div><div><h5 class="subtitle"><code class="literal">range :: int -&gt; int -&gt; [int]</code>
      </h5></div></div></div><p>
       Return a list of integers from `first' up to and including `last'.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">first</code>
        </span></dt><dd><p>
          First integer in the range
         </p></dd><dt><span class="term">
         <code class="varname">last</code>
        </span></dt><dd><p>
          Last integer in the range
         </p></dd></dl></div><div class="example"><a id="idm140737320982688"></a><p class="title"><strong>Example 5.106. <code class="function">lib.lists.range</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
range 2 4
=&gt; [ 2 3 4 ]
range 3 2
=&gt; [ ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.range"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L295" target="_top">lib/lists.nix:295</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.partition"></a>5.1.5.21. <code class="function">lib.lists.partition</code></h4></div><div><h5 class="subtitle"><code class="literal">(a -&gt; bool) -&gt; [a] -&gt; { right :: [a], wrong :: [a] }</code>
      </h5></div></div></div><p>
       Splits the elements of a list in two lists, `right` and `wrong`, depending on the evaluation of a predicate.
      </p><div class="example"><a id="idm140737320975856"></a><p class="title"><strong>Example 5.107. <code class="function">lib.lists.partition</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
partition (x: x &gt; 2) [ 5 1 2 3 4 ]
=&gt; { right = [ 5 3 4 ]; wrong = [ 1 2 ]; }
</pre></div></div><br class="example-break" /><p><a id="lib.lists.partition"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L314" target="_top">lib/lists.nix:314</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.groupBy-prime"></a>5.1.5.22. <code class="function">lib.lists.groupBy'</code></h4></div></div></div><p>
       Splits the elements of a list into many lists, using the return value of a predicate. Predicate should return a string which becomes keys of attrset `groupBy' returns.
      </p><p>
       `groupBy'` allows to customise the combining function and initial value
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">op</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">nul</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">pred</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">lst</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320960720"></a><p class="title"><strong>Example 5.108. <code class="function">lib.lists.groupBy'</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
groupBy (x: boolToString (x &gt; 2)) [ 5 1 2 3 4 ]
=&gt; { true = [ 5 3 4 ]; false = [ 1 2 ]; }
groupBy (x: x.name) [ {name = "icewm"; script = "icewm &amp;";}
{name = "xfce";  script = "xfce4-session &amp;";}
{name = "icewm"; script = "icewmbg &amp;";}
{name = "mate";  script = "gnome-session &amp;";}
]
=&gt; { icewm = [ { name = "icewm"; script = "icewm &amp;"; }
{ name = "icewm"; script = "icewmbg &amp;"; } ];
mate  = [ { name = "mate";  script = "gnome-session &amp;"; } ];
xfce  = [ { name = "xfce";  script = "xfce4-session &amp;"; } ];
}

groupBy' builtins.add 0 (x: boolToString (x &gt; 2)) [ 5 1 2 3 4 ]
=&gt; { true = 12; false = 3; }
</pre></div></div><br class="example-break" /><p><a id="lib.lists.groupBy-prime"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L343" target="_top">lib/lists.nix:343</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.zipListsWith"></a>5.1.5.23. <code class="function">lib.lists.zipListsWith</code></h4></div><div><h5 class="subtitle"><code class="literal">zipListsWith :: (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]</code>
      </h5></div></div></div><p>
       Merges two lists of the same size together. If the sizes aren't the same the merging stops at the shortest. How both lists are merged is defined by the first argument.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function to zip elements of both lists
         </p></dd><dt><span class="term">
         <code class="varname">fst</code>
        </span></dt><dd><p>
          First list
         </p></dd><dt><span class="term">
         <code class="varname">snd</code>
        </span></dt><dd><p>
          Second list
         </p></dd></dl></div><div class="example"><a id="idm140737320945904"></a><p class="title"><strong>Example 5.109. <code class="function">lib.lists.zipListsWith</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
zipListsWith (a: b: a + b) ["h" "l"] ["e" "o"]
=&gt; ["he" "lo"]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.zipListsWith"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L363" target="_top">lib/lists.nix:363</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.zipLists"></a>5.1.5.24. <code class="function">lib.lists.zipLists</code></h4></div><div><h5 class="subtitle"><code class="literal">zipLists :: [a] -&gt; [b] -&gt; [{ fst :: a, snd :: b}]</code>
      </h5></div></div></div><p>
       Merges two lists of the same size together. If the sizes aren't the same the merging stops at the shortest.
      </p><div class="example"><a id="idm140737320939008"></a><p class="title"><strong>Example 5.110. <code class="function">lib.lists.zipLists</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
zipLists [ 1 2 ] [ "a" "b" ]
=&gt; [ { fst = 1; snd = "a"; } { fst = 2; snd = "b"; } ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.zipLists"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L382" target="_top">lib/lists.nix:382</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.reverseList"></a>5.1.5.25. <code class="function">lib.lists.reverseList</code></h4></div><div><h5 class="subtitle"><code class="literal">reverseList :: [a] -&gt; [a]</code>
      </h5></div></div></div><p>
       Reverse the order of the elements of a list.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">xs</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320929760"></a><p class="title"><strong>Example 5.111. <code class="function">lib.lists.reverseList</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">

reverseList [ "b" "o" "j" ]
=&gt; [ "j" "o" "b" ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.reverseList"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L393" target="_top">lib/lists.nix:393</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.listDfs"></a>5.1.5.26. <code class="function">lib.lists.listDfs</code></h4></div></div></div><p>
       Depth-First Search (DFS) for lists `list != []`.
      </p><p>
       `before a b == true` means that `b` depends on `a` (there's an edge from `b` to `a`).
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">stopOnCycles</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">before</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320916736"></a><p class="title"><strong>Example 5.112. <code class="function">lib.lists.listDfs</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
listDfs true hasPrefix [ "/home/user" "other" "/" "/home" ]
== { minimal = "/";                  # minimal element
visited = [ "/home/user" ];     # seen elements (in reverse order)
rest    = [ "/home" "other" ];  # everything else
}

listDfs true hasPrefix [ "/home/user" "other" "/" "/home" "/" ]
== { cycle   = "/";                  # cycle encountered at this element
loops   = [ "/" ];              # and continues to these elements
visited = [ "/" "/home/user" ]; # elements leading to the cycle (in reverse order)
rest    = [ "/home" "other" ];  # everything else
</pre></div></div><br class="example-break" /><p><a id="lib.lists.listDfs"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L415" target="_top">lib/lists.nix:415</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.toposort"></a>5.1.5.27. <code class="function">lib.lists.toposort</code></h4></div></div></div><p>
       Sort a list based on a partial ordering using DFS. This implementation is O(N^2), if your ordering is linear, use `sort` instead.
      </p><p>
       `before a b == true` means that `b` should be after `a` in the result.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">before</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320904896"></a><p class="title"><strong>Example 5.113. <code class="function">lib.lists.toposort</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">

toposort hasPrefix [ "/home/user" "other" "/" "/home" ]
== { result = [ "/" "/home" "/home/user" "other" ]; }

toposort hasPrefix [ "/home/user" "other" "/" "/home" "/" ]
== { cycle = [ "/home/user" "/" "/" ]; # path leading to a cycle
loops = [ "/" ]; }                # loops back to these elements

toposort hasPrefix [ "other" "/home/user" "/home" "/" ]
== { result = [ "other" "/" "/home" "/home/user" ]; }

toposort (a: b: a &lt; b) [ 3 2 1 ] == { result = [ 1 2 3 ]; }
</pre></div></div><br class="example-break" /><p><a id="lib.lists.toposort"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L454" target="_top">lib/lists.nix:454</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.sort"></a>5.1.5.28. <code class="function">lib.lists.sort</code></h4></div></div></div><p>
       Sort a list based on a comparator function which compares two elements and returns true if the first argument is strictly below the second argument. The returned list is sorted in an increasing order. The implementation does a quick-sort.
      </p><div class="example"><a id="idm140737320898032"></a><p class="title"><strong>Example 5.114. <code class="function">lib.lists.sort</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
sort (a: b: a &lt; b) [ 5 3 7 ]
=&gt; [ 3 5 7 ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.sort"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L482" target="_top">lib/lists.nix:482</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.compareLists"></a>5.1.5.29. <code class="function">lib.lists.compareLists</code></h4></div></div></div><p>
       Compare two lists element-by-element.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">cmp</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">a</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">b</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320885792"></a><p class="title"><strong>Example 5.115. <code class="function">lib.lists.compareLists</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
compareLists compare [] []
=&gt; 0
compareLists compare [] [ "a" ]
=&gt; -1
compareLists compare [ "a" ] []
=&gt; 1
compareLists compare [ "a" "b" ] [ "a" "c" ]
=&gt; 1
</pre></div></div><br class="example-break" /><p><a id="lib.lists.compareLists"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L511" target="_top">lib/lists.nix:511</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.naturalSort"></a>5.1.5.30. <code class="function">lib.lists.naturalSort</code></h4></div></div></div><p>
       Sort list using "Natural sorting". Numeric portions of strings are sorted in numeric order.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">lst</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320877024"></a><p class="title"><strong>Example 5.116. <code class="function">lib.lists.naturalSort</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
naturalSort ["disk11" "disk8" "disk100" "disk9"]
=&gt; ["disk8" "disk9" "disk11" "disk100"]
naturalSort ["10.46.133.149" "10.5.16.62" "10.54.16.25"]
=&gt; ["10.5.16.62" "10.46.133.149" "10.54.16.25"]
naturalSort ["v0.2" "v0.15" "v0.0.9"]
=&gt; [ "v0.0.9" "v0.2" "v0.15" ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.naturalSort"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L534" target="_top">lib/lists.nix:534</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.take"></a>5.1.5.31. <code class="function">lib.lists.take</code></h4></div><div><h5 class="subtitle"><code class="literal">take :: int -&gt; [a] -&gt; [a]</code>
      </h5></div></div></div><p>
       Return the first (at most) N elements of a list.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">count</code>
        </span></dt><dd><p>
          Number of elements to take
         </p></dd></dl></div><div class="example"><a id="idm140737320867616"></a><p class="title"><strong>Example 5.117. <code class="function">lib.lists.take</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
take 2 [ "a" "b" "c" "d" ]
=&gt; [ "a" "b" ]
take 2 [ ]
=&gt; [ ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.take"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L552" target="_top">lib/lists.nix:552</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.drop"></a>5.1.5.32. <code class="function">lib.lists.drop</code></h4></div><div><h5 class="subtitle"><code class="literal">drop :: int -&gt; [a] -&gt; [a]</code>
      </h5></div></div></div><p>
       Remove the first (at most) N elements of a list.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">count</code>
        </span></dt><dd><p>
          Number of elements to drop
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Input list
         </p></dd></dl></div><div class="example"><a id="idm140737320856416"></a><p class="title"><strong>Example 5.118. <code class="function">lib.lists.drop</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
drop 2 [ "a" "b" "c" "d" ]
=&gt; [ "c" "d" ]
drop 2 [ ]
=&gt; [ ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.drop"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L566" target="_top">lib/lists.nix:566</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.sublist"></a>5.1.5.33. <code class="function">lib.lists.sublist</code></h4></div><div><h5 class="subtitle"><code class="literal">sublist :: int -&gt; int -&gt; [a] -&gt; [a]</code>
      </h5></div></div></div><p>
       Return a list consisting of at most `count` elements of `list`, starting at index `start`.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">start</code>
        </span></dt><dd><p>
          Index at which to start the sublist
         </p></dd><dt><span class="term">
         <code class="varname">count</code>
        </span></dt><dd><p>
          Number of elements to take
         </p></dd><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Input list
         </p></dd></dl></div><div class="example"><a id="idm140737320843040"></a><p class="title"><strong>Example 5.119. <code class="function">lib.lists.sublist</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
sublist 1 3 [ "a" "b" "c" "d" "e" ]
=&gt; [ "b" "c" "d" ]
sublist 1 3 [ ]
=&gt; [ ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.sublist"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L583" target="_top">lib/lists.nix:583</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.last"></a>5.1.5.34. <code class="function">lib.lists.last</code></h4></div><div><h5 class="subtitle"><code class="literal">last :: [a] -&gt; a</code>
      </h5></div></div></div><p>
       Return the last element of a list.
      </p><p>
       This function throws an error if the list is empty.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320833232"></a><p class="title"><strong>Example 5.120. <code class="function">lib.lists.last</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
last [ 1 2 3 ]
=&gt; 3
</pre></div></div><br class="example-break" /><p><a id="lib.lists.last"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L607" target="_top">lib/lists.nix:607</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.init"></a>5.1.5.35. <code class="function">lib.lists.init</code></h4></div><div><h5 class="subtitle"><code class="literal">init :: [a] -&gt; [a]</code>
      </h5></div></div></div><p>
       Return all elements but the last.
      </p><p>
       This function throws an error if the list is empty.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">list</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320823424"></a><p class="title"><strong>Example 5.121. <code class="function">lib.lists.init</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
init [ 1 2 3 ]
=&gt; [ 1 2 ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.init"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L621" target="_top">lib/lists.nix:621</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.crossLists"></a>5.1.5.36. <code class="function">lib.lists.crossLists</code></h4></div></div></div><p>
       Return the image of the cross product of some lists by a function.
      </p><div class="example"><a id="idm140737320817440"></a><p class="title"><strong>Example 5.122. <code class="function">lib.lists.crossLists</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
crossLists (x:y: "${toString x}${toString y}") [[1 2] [3 4]]
=&gt; [ "13" "14" "23" "24" ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.crossLists"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L632" target="_top">lib/lists.nix:632</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.unique"></a>5.1.5.37. <code class="function">lib.lists.unique</code></h4></div><div><h5 class="subtitle"><code class="literal">unique :: [a] -&gt; [a]</code>
      </h5></div></div></div><p>
       Remove duplicate elements from the list. O(n^2) complexity.
      </p><div class="example"><a id="idm140737320810592"></a><p class="title"><strong>Example 5.123. <code class="function">lib.lists.unique</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
unique [ 3 2 3 4 ]
=&gt; [ 3 2 4 ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.unique"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L645" target="_top">lib/lists.nix:645</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.intersectLists"></a>5.1.5.38. <code class="function">lib.lists.intersectLists</code></h4></div></div></div><p>
       Intersects list 'e' and another list. O(nm) complexity.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">e</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320802176"></a><p class="title"><strong>Example 5.124. <code class="function">lib.lists.intersectLists</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
intersectLists [ 1 2 3 ] [ 6 3 2 ]
=&gt; [ 3 2 ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.intersectLists"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L653" target="_top">lib/lists.nix:653</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.subtractLists"></a>5.1.5.39. <code class="function">lib.lists.subtractLists</code></h4></div></div></div><p>
       Subtracts list 'e' from another list. O(nm) complexity.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">e</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320793648"></a><p class="title"><strong>Example 5.125. <code class="function">lib.lists.subtractLists</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
subtractLists [ 3 2 ] [ 1 2 3 4 5 3 ]
=&gt; [ 1 4 5 ]
</pre></div></div><br class="example-break" /><p><a id="lib.lists.subtractLists"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L661" target="_top">lib/lists.nix:661</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.lists.mutuallyExclusive"></a>5.1.5.40. <code class="function">lib.lists.mutuallyExclusive</code></h4></div></div></div><p>
       Test if two lists have no common element. It should be slightly more efficient than (intersectLists a b == [])
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">a</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">b</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.lists.mutuallyExclusive"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/lists.nix#L666" target="_top">lib/lists.nix:666</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-functions-library-debug"></a>5.1.6. Debugging functions</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.traceIf"></a>5.1.6.1. <code class="function">lib.debug.traceIf</code></h4></div><div><h5 class="subtitle"><code class="literal">traceIf :: bool -&gt; string -&gt; a -&gt; a</code>
      </h5></div></div></div><p>
       Conditionally trace the supplied message, based on a predicate.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">pred</code>
        </span></dt><dd><p>
          Predicate to check
         </p></dd><dt><span class="term">
         <code class="varname">msg</code>
        </span></dt><dd><p>
          Message that should be traced
         </p></dd><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Value to return
         </p></dd></dl></div><div class="example"><a id="idm140737320768864"></a><p class="title"><strong>Example 5.126. <code class="function">lib.debug.traceIf</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
traceIf true "hello" 3
trace: hello
=&gt; 3
</pre></div></div><br class="example-break" /><p><a id="lib.debug.traceIf"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L51" target="_top">lib/debug.nix:51</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.traceValFn"></a>5.1.6.2. <code class="function">lib.debug.traceValFn</code></h4></div><div><h5 class="subtitle"><code class="literal">traceValFn :: (a -&gt; b) -&gt; a -&gt; a</code>
      </h5></div></div></div><p>
       Trace the supplied value after applying a function to it, and return the original value.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function to apply
         </p></dd><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Value to trace and return
         </p></dd></dl></div><div class="example"><a id="idm140737320757600"></a><p class="title"><strong>Example 5.127. <code class="function">lib.debug.traceValFn</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
traceValFn (v: "mystring ${v}") "foo"
trace: mystring foo
=&gt; "foo"
</pre></div></div><br class="example-break" /><p><a id="lib.debug.traceValFn"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L69" target="_top">lib/debug.nix:69</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.traceVal"></a>5.1.6.3. <code class="function">lib.debug.traceVal</code></h4></div><div><h5 class="subtitle"><code class="literal">traceVal :: a -&gt; a</code>
      </h5></div></div></div><p>
       Trace the supplied value and return it.
      </p><div class="example"><a id="idm140737320750768"></a><p class="title"><strong>Example 5.128. <code class="function">lib.debug.traceVal</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
traceVal 42
# trace: 42
=&gt; 42
</pre></div></div><br class="example-break" /><p><a id="lib.debug.traceVal"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L84" target="_top">lib/debug.nix:84</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.traceSeq"></a>5.1.6.4. <code class="function">lib.debug.traceSeq</code></h4></div><div><h5 class="subtitle"><code class="literal">traceSeq :: a -&gt; b -&gt; b</code>
      </h5></div></div></div><p>
       `builtins.trace`, but the value is `builtins.deepSeq`ed first.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          The value to trace
         </p></dd><dt><span class="term">
         <code class="varname">y</code>
        </span></dt><dd><p>
          The value to return
         </p></dd></dl></div><div class="example"><a id="idm140737320739552"></a><p class="title"><strong>Example 5.129. <code class="function">lib.debug.traceSeq</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
trace { a.b.c = 3; } null
trace: { a = &lt;CODE&gt;; }
=&gt; null
traceSeq { a.b.c = 3; } null
trace: { a = { b = { c = 3; }; }; }
=&gt; null
</pre></div></div><br class="example-break" /><p><a id="lib.debug.traceSeq"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L98" target="_top">lib/debug.nix:98</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.traceSeqN"></a>5.1.6.5. <code class="function">lib.debug.traceSeqN</code></h4></div></div></div><p>
       Like `traceSeq`, but only evaluate down to depth n. This is very useful because lots of `traceSeq` usages lead to an infinite recursion.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">depth</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">y</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320726896"></a><p class="title"><strong>Example 5.130. <code class="function">lib.debug.traceSeqN</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
traceSeqN 2 { a.b.c = 3; } null
trace: { a = { b = {…}; }; }
=&gt; null
</pre></div></div><br class="example-break" /><p><a id="lib.debug.traceSeqN"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L113" target="_top">lib/debug.nix:113</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.traceValSeqFn"></a>5.1.6.6. <code class="function">lib.debug.traceValSeqFn</code></h4></div></div></div><p>
       A combination of `traceVal` and `traceSeq` that applies a provided function to the value to be traced after `deepSeq`ing it.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function to apply
         </p></dd><dt><span class="term">
         <code class="varname">v</code>
        </span></dt><dd><p>
          Value to trace
         </p></dd></dl></div><p><a id="lib.debug.traceValSeqFn"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L130" target="_top">lib/debug.nix:130</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.traceValSeq"></a>5.1.6.7. <code class="function">lib.debug.traceValSeq</code></h4></div></div></div><p>
       A combination of `traceVal` and `traceSeq`.
      </p><p><a id="lib.debug.traceValSeq"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L137" target="_top">lib/debug.nix:137</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.traceValSeqNFn"></a>5.1.6.8. <code class="function">lib.debug.traceValSeqNFn</code></h4></div></div></div><p>
       A combination of `traceVal` and `traceSeqN` that applies a provided function to the value to be traced.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function to apply
         </p></dd><dt><span class="term">
         <code class="varname">depth</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">v</code>
        </span></dt><dd><p>
          Value to trace
         </p></dd></dl></div><p><a id="lib.debug.traceValSeqNFn"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L141" target="_top">lib/debug.nix:141</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.traceValSeqN"></a>5.1.6.9. <code class="function">lib.debug.traceValSeqN</code></h4></div></div></div><p>
       A combination of `traceVal` and `traceSeqN`.
      </p><p><a id="lib.debug.traceValSeqN"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L149" target="_top">lib/debug.nix:149</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.traceFnSeqN"></a>5.1.6.10. <code class="function">lib.debug.traceFnSeqN</code></h4></div></div></div><p>
       Trace the input and output of a function `f` named `name`, both down to `depth`.
      </p><p>
       This is useful for adding around a function call, to see the before/after of values as they are transformed.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">depth</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">name</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">f</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">v</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320683344"></a><p class="title"><strong>Example 5.131. <code class="function">lib.debug.traceFnSeqN</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
traceFnSeqN 2 "id" (x: x) { a.b.c = 3; }
trace: { fn = "id"; from = { a.b = {…}; }; to = { a.b = {…}; }; }
=&gt; { a.b.c = 3; }
</pre></div></div><br class="example-break" /><p><a id="lib.debug.traceFnSeqN"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L162" target="_top">lib/debug.nix:162</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.runTests"></a>5.1.6.11. <code class="function">lib.debug.runTests</code></h4></div></div></div><p>
       Evaluate a set of tests. A test is an attribute set `{expr, expected}`, denoting an expression and its expected result. The result is a list of failed tests, each represented as `{name, expected, actual}`, denoting the attribute name of the failing test and its expected and actual results.
      </p><p>
       Used for regression testing of the functions in lib; see tests.nix for an example. Only tests having names starting with "test" are run.
      </p><p>
       Add attr { tests = ["testName"]; } to run these tests only.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">tests</code>
        </span></dt><dd><p>
          Tests to run
         </p></dd></dl></div><p><a id="lib.debug.runTests"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L188" target="_top">lib/debug.nix:188</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.debug.testAllTrue"></a>5.1.6.12. <code class="function">lib.debug.testAllTrue</code></h4></div></div></div><p>
       Create a test assuming that list elements are `true`.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">expr</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320666432"></a><p class="title"><strong>Example 5.132. <code class="function">lib.debug.testAllTrue</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
{ testX = allTrue [ true ]; }
</pre></div></div><br class="example-break" /><p><a id="lib.debug.testAllTrue"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/debug.nix#L204" target="_top">lib/debug.nix:204</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-functions-library-options"></a>5.1.7. NixOS / nixpkgs option handling</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.options.isOption"></a>5.1.7.1. <code class="function">lib.options.isOption</code></h4></div><div><h5 class="subtitle"><code class="literal">isOption :: a -&gt; bool</code>
      </h5></div></div></div><p>
       Returns true when the given argument is an option
      </p><div class="example"><a id="idm140737320656960"></a><p class="title"><strong>Example 5.133. <code class="function">lib.options.isOption</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
isOption 1             // =&gt; false
isOption (mkOption {}) // =&gt; true
</pre></div></div><br class="example-break" /><p><a id="lib.options.isOption"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/options.nix#L48" target="_top">lib/options.nix:48</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.options.mkOption"></a>5.1.7.2. <code class="function">lib.options.mkOption</code></h4></div></div></div><p>
       Creates an Option attribute set. mkOption accepts an attribute set with the following keys:
      </p><p>
       All keys default to `null` when not given.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">pattern</code>
        </span></dt><dd><p>
          Structured function argument
         </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
            <code class="varname">default</code>
           </span></dt><dd><p>
             Default value used when no definition is given in the configuration.
            </p></dd><dt><span class="term">
            <code class="varname">defaultText</code>
           </span></dt><dd><p>
             Textual representation of the default, for the manual.
            </p></dd><dt><span class="term">
            <code class="varname">example</code>
           </span></dt><dd><p>
             Example value used in the manual.
            </p></dd><dt><span class="term">
            <code class="varname">description</code>
           </span></dt><dd><p>
             String describing the option.
            </p></dd><dt><span class="term">
            <code class="varname">relatedPackages</code>
           </span></dt><dd><p>
             Related packages used in the manual (see `genRelatedPackages` in ../nixos/lib/make-options-doc/default.nix).
            </p></dd><dt><span class="term">
            <code class="varname">type</code>
           </span></dt><dd><p>
             Option type, providing type-checking and value merging.
            </p></dd><dt><span class="term">
            <code class="varname">apply</code>
           </span></dt><dd><p>
             Function that converts the option value to something else.
            </p></dd><dt><span class="term">
            <code class="varname">internal</code>
           </span></dt><dd><p>
             Whether the option is for NixOS developers only.
            </p></dd><dt><span class="term">
            <code class="varname">visible</code>
           </span></dt><dd><p>
             Whether the option shows up in the manual.
            </p></dd><dt><span class="term">
            <code class="varname">readOnly</code>
           </span></dt><dd><p>
             Whether the option can be set only once
            </p></dd><dt><span class="term">
            <code class="varname">options</code>
           </span></dt><dd><p>
             Deprecated, used by types.optionSet.
            </p></dd></dl></div></dd></dl></div><div class="example"><a id="idm140737320625040"></a><p class="title"><strong>Example 5.134. <code class="function">lib.options.mkOption</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
mkOption { }  // =&gt; { _type = "option"; }
mkOption { defaultText = "foo"; } // =&gt; { _type = "option"; defaultText = "foo"; }
</pre></div></div><br class="example-break" /><p><a id="lib.options.mkOption"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/options.nix#L58" target="_top">lib/options.nix:58</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.options.mkEnableOption"></a>5.1.7.3. <code class="function">lib.options.mkEnableOption</code></h4></div></div></div><p>
       Creates an Option attribute set for a boolean value option i.e an option to be toggled on or off:
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">name</code>
        </span></dt><dd><p>
          Name for the created option
         </p></dd></dl></div><div class="example"><a id="idm140737320616368"></a><p class="title"><strong>Example 5.135. <code class="function">lib.options.mkEnableOption</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
mkEnableOption "foo"
=&gt; { _type = "option"; default = false; description = "Whether to enable foo."; example = true; type = { ... }; }
</pre></div></div><br class="example-break" /><p><a id="lib.options.mkEnableOption"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/options.nix#L92" target="_top">lib/options.nix:92</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.options.mkSinkUndeclaredOptions"></a>5.1.7.4. <code class="function">lib.options.mkSinkUndeclaredOptions</code></h4></div></div></div><p>
       This option accepts anything, but it does not produce any result.
      </p><p>
       This is useful for sharing a module across different module sets without having to implement similar features as long as the values of the options are not accessed.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">attrs</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.options.mkSinkUndeclaredOptions"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/options.nix#L106" target="_top">lib/options.nix:106</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.options.mergeEqualOption"></a>5.1.7.5. <code class="function">lib.options.mergeEqualOption</code></h4></div></div></div><p>
       "Merge" option definitions by checking that they all have the same value.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">loc</code>
        </span></dt><dd><p>
          Function argument
         </p></dd><dt><span class="term">
         <code class="varname">defs</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.options.mergeEqualOption"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/options.nix#L137" target="_top">lib/options.nix:137</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.options.getValues"></a>5.1.7.6. <code class="function">lib.options.getValues</code></h4></div><div><h5 class="subtitle"><code class="literal">getValues :: [ { value :: a } ] -&gt; [a]</code>
      </h5></div></div></div><p>
       Extracts values of all "value" keys of the given list.
      </p><div class="example"><a id="idm140737320593056"></a><p class="title"><strong>Example 5.136. <code class="function">lib.options.getValues</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
getValues [ { value = 1; } { value = 2; } ] // =&gt; [ 1 2 ]
getValues [ ]                               // =&gt; [ ]
</pre></div></div><br class="example-break" /><p><a id="lib.options.getValues"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/options.nix#L157" target="_top">lib/options.nix:157</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.options.getFiles"></a>5.1.7.7. <code class="function">lib.options.getFiles</code></h4></div><div><h5 class="subtitle"><code class="literal">getFiles :: [ { file :: a } ] -&gt; [a]</code>
      </h5></div></div></div><p>
       Extracts values of all "file" keys of the given list
      </p><div class="example"><a id="idm140737320586176"></a><p class="title"><strong>Example 5.137. <code class="function">lib.options.getFiles</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
getFiles [ { file = "file1"; } { file = "file2"; } ] // =&gt; [ "file1" "file2" ]
getFiles [ ]                                         // =&gt; [ ]
</pre></div></div><br class="example-break" /><p><a id="lib.options.getFiles"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/options.nix#L167" target="_top">lib/options.nix:167</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.options.scrubOptionValue"></a>5.1.7.8. <code class="function">lib.options.scrubOptionValue</code></h4></div></div></div><p>
       This function recursively removes all derivation attributes from `x` except for the `name` attribute.
      </p><p>
       This is to make the generation of `options.xml` much more efficient: the XML representation of derivations is very large (on the order of megabytes) and is not actually used by the manual generator.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">x</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.options.scrubOptionValue"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/options.nix#L206" target="_top">lib/options.nix:206</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.options.literalExample"></a>5.1.7.9. <code class="function">lib.options.literalExample</code></h4></div></div></div><p>
       For use in the `example` option attribute. It causes the given text to be included verbatim in documentation. This is necessary for example values that are not simple values, e.g., functions.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">text</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><p><a id="lib.options.literalExample"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/options.nix#L218" target="_top">lib/options.nix:218</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="function-library-lib.options.showOption"></a>5.1.7.10. <code class="function">lib.options.showOption</code></h4></div></div></div><p>
       Convert an option, described as a list of the option parts in to a safe, human readable version.
      </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
         <code class="varname">parts</code>
        </span></dt><dd><p>
          Function argument
         </p></dd></dl></div><div class="example"><a id="idm140737320563472"></a><p class="title"><strong>Example 5.138. <code class="function">lib.options.showOption</code> usage example</strong></p><div class="example-contents"><pre class="programlisting">
(showOption ["foo" "bar" "baz"]) == "foo.bar.baz"
(showOption ["foo" "bar.baz" "tux"]) == "foo.bar.baz.tux"

Placeholders will not be quoted as they are not actual values:
(showOption ["foo" "*" "bar"]) == "foo.*.bar"
(showOption ["foo" "&lt;name&gt;" "bar"]) == "foo.&lt;name&gt;.bar"

Unlike attributes, options can also start with numbers:
(showOption ["windowManager" "2bwm" "enable"]) == "windowManager.2bwm.enable"
</pre></div></div><br class="example-break" /><p><a id="lib.options.showOption"></a>
       Located at <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/options.nix#L240" target="_top">lib/options.nix:240</a> in <code class="literal">&lt;nixpkgs&gt;</code>.
      </p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-generators"></a>5.2. Generators</h2></div></div></div><p>
     Generators are functions that create file formats from nix data structures, e. g. for configuration files. There are generators available for: <code class="literal">INI</code>, <code class="literal">JSON</code> and <code class="literal">YAML</code>
    </p><p>
     All generators follow a similar call interface: <code class="code">generatorName configFunctions data</code>, where <code class="literal">configFunctions</code> is an attrset of user-defined functions that format nested parts of the content. They each have common defaults, so often they do not need to be set manually. An example is <code class="code">mkSectionName ? (name: libStr.escape [ "[" "]" ] name)</code> from the <code class="literal">INI</code> generator. It receives the name of a section and sanitizes it. The default <code class="literal">mkSectionName</code> escapes <code class="literal">[</code> and <code class="literal">]</code> with a backslash.
    </p><p>
     Generators can be fine-tuned to produce exactly the file format required by your application/service. One example is an INI-file format which uses <code class="literal">: </code> as separator, the strings <code class="literal">"yes"</code>/<code class="literal">"no"</code> as boolean values and requires all string values to be quoted:
    </p><pre class="programlisting">
with lib;
let
  customToINI = generators.toINI {
    # specifies how to format a key/value pair
    mkKeyValue = generators.mkKeyValueDefault {
      # specifies the generated string for a subset of nix values
      mkValueString = v:
             if v == true then ''"yes"''
        else if v == false then ''"no"''
        else if isString v then ''"${v}"''
        # and delegats all other values to the default generator
        else generators.mkValueStringDefault {} v;
    } ":";
  };

# the INI file can now be given as plain old nix values
in customToINI {
  main = {
    pushinfo = true;
    autopush = false;
    host = "localhost";
    port = 42;
  };
  mergetool = {
    merge = "diff3";
  };
}
</pre><p>
     This will produce the following INI file as nix string:
    </p><pre class="programlisting">
[main]
autopush:"no"
host:"localhost"
port:42
pushinfo:"yes"
str\:ange:"very::strange"

[mergetool]
merge:"diff3"
</pre><div class="note"><h3 class="title">Note</h3><p>
      Nix store paths can be converted to strings by enclosing a derivation attribute like so: <code class="code">"${drv}"</code>.
     </p></div><p>
     Detailed documentation for each generator can be found in <code class="literal">lib/generators.nix</code>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-debug"></a>5.3. Debugging Nix Expressions</h2></div></div></div><p>
     Nix is a unityped, dynamic language, this means every value can potentially appear anywhere. Since it is also non-strict, evaluation order and what ultimately is evaluated might surprise you. Therefore it is important to be able to debug nix expressions.
    </p><p>
     In the <code class="literal">lib/debug.nix</code> file you will find a number of functions that help (pretty-)printing values while evaluation is runnnig. You can even specify how deep these values should be printed recursively, and transform them on the fly. Please consult the docstrings in <code class="literal">lib/debug.nix</code> for usage information.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-prefer-remote-fetch"></a>5.4. prefer-remote-fetch overlay</h2></div></div></div><p>
     <code class="function">prefer-remote-fetch</code> is an overlay that download sources on remote builder. This is useful when the evaluating machine has a slow upload while the builder can fetch faster directly from the source. To use it, put the following snippet as a new overlay:
</p><pre class="programlisting">
self: super:
  (super.prefer-remote-fetch self super)
</pre><p>
     A full configuration example for that sets the overlay up for your own account, could look like this
</p><pre class="screen">
<code class="prompt">$ </code>mkdir ~/.config/nixpkgs/overlays/
<code class="prompt">$ </code>cat &gt; ~/.config/nixpkgs/overlays/prefer-remote-fetch.nix &lt;&lt;EOF
  self: super: super.prefer-remote-fetch self super
EOF
</pre><p>
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pkgs-nix-gitignore"></a>5.5. pkgs.nix-gitignore</h2></div></div></div><p>
     <code class="function">pkgs.nix-gitignore</code> is a function that acts similarly to <code class="literal">builtins.filterSource</code> but also allows filtering with the help of the gitignore format.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-pkgs-nix-gitignore-usage"></a>5.5.1. Usage</h3></div></div></div><p>
      <code class="literal">pkgs.nix-gitignore</code> exports a number of functions, but you'll most likely need either <code class="literal">gitignoreSource</code> or <code class="literal">gitignoreSourcePure</code>. As their first argument, they both accept either 1. a file with gitignore lines or 2. a string with gitignore lines, or 3. a list of either of the two. They will be concatenated into a single big string.
     </p><pre class="programlisting">
{ pkgs ? import &lt;nixpkgs&gt; {} }:

 nix-gitignore.gitignoreSource [] ./source
     # Simplest version

 nix-gitignore.gitignoreSource "supplemental-ignores\n" ./source
     # This one reads the ./source/.gitignore and concats the auxiliary ignores

 nix-gitignore.gitignoreSourcePure "ignore-this\nignore-that\n" ./source
     # Use this string as gitignore, don't read ./source/.gitignore.

 nix-gitignore.gitignoreSourcePure ["ignore-this\nignore-that\n", ~/.gitignore] ./source
     # It also accepts a list (of strings and paths) that will be concatenated
     # once the paths are turned to strings via readFile.
  </pre><p>
      These functions are derived from the <code class="literal">Filter</code> functions by setting the first filter argument to <code class="literal">(_: _: true)</code>:
     </p><pre class="programlisting">
gitignoreSourcePure = gitignoreFilterSourcePure (_: _: true);
gitignoreSource = gitignoreFilterSource (_: _: true);
  </pre><p>
      Those filter functions accept the same arguments the <code class="literal">builtins.filterSource</code> function would pass to its filters, thus <code class="literal">fn: gitignoreFilterSourcePure fn ""</code> should be extensionally equivalent to <code class="literal">filterSource</code>. The file is blacklisted iff it's blacklisted by either your filter or the gitignoreFilter.
     </p><p>
      If you want to make your own filter from scratch, you may use
     </p><pre class="programlisting">
gitignoreFilter = ign: root: filterPattern (gitignoreToPatterns ign) root;
  </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-pkgs-nix-gitignore-usage-recursive"></a>5.5.2. gitignore files in subdirectories</h3></div></div></div><p>
      If you wish to use a filter that would search for .gitignore files in subdirectories, just like git does by default, use this function:
     </p><pre class="programlisting">
gitignoreFilterRecursiveSource = filter: patterns: root:
# OR
gitignoreRecursiveSource = gitignoreFilterSourcePure (_: _: true);
  </pre></div></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="idm140737320519728"></a>Part II. Standard environment</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="#chap-stdenv">6. The Standard Environment</a></span></dt><dt><span class="chapter"><a href="#chap-meta">7. Meta-attributes</a></span></dt><dt><span class="chapter"><a href="#chap-multiple-output">8. Multiple-output packages</a></span></dt><dt><span class="chapter"><a href="#chap-cross">9. Cross-compilation</a></span></dt><dt><span class="chapter"><a href="#chap-platform-notes">10. Platform Notes</a></span></dt></dl></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-stdenv"></a>Chapter 6. The Standard Environment</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-using-stdenv">6.1. Using <code class="literal">stdenv</code></a></span></dt><dt><span class="section"><a href="#sec-tools-of-stdenv">6.2. Tools provided by <code class="literal">stdenv</code></a></span></dt><dt><span class="section"><a href="#ssec-stdenv-dependencies">6.3. Specifying dependencies</a></span></dt><dt><span class="section"><a href="#ssec-stdenv-attributes">6.4. Attributes</a></span></dt><dt><span class="section"><a href="#sec-stdenv-phases">6.5. Phases</a></span></dt><dt><span class="section"><a href="#ssec-stdenv-functions">6.6. Shell functions</a></span></dt><dt><span class="section"><a href="#ssec-setup-hooks">6.7. Package setup hooks</a></span></dt><dt><span class="section"><a href="#sec-purity-in-nixpkgs">6.8. Purity in Nixpkgs</a></span></dt><dt><span class="section"><a href="#sec-hardening-in-nixpkgs">6.9. Hardening in Nixpkgs</a></span></dt></dl></div><p>
    The standard build environment in the Nix Packages collection provides an environment for building Unix packages that does a lot of common build tasks automatically. In fact, for Unix packages that use the standard <code class="literal">./configure; make; make install</code> build interface, you don’t need to write a build script at all; the standard environment does everything automatically. If <code class="literal">stdenv</code> doesn’t do what you need automatically, you can easily customise or override the various build phases.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-using-stdenv"></a>6.1. Using <code class="literal">stdenv</code></h2></div></div></div><p>
     To build a package with the standard environment, you use the function <code class="literal">stdenv.mkDerivation</code>, instead of the primitive built-in function <code class="literal">derivation</code>, e.g.
    </p><pre class="programlisting">
stdenv.mkDerivation {
  name = "libfoo-1.2.3";
  src = fetchurl {
    url = "http://example.org/libfoo-1.2.3.tar.bz2";
    sha256 = "0x2g1jqygyr5wiwg4ma1nd7w4ydpy82z9gkcv8vh2v8dn3y58v5m";
  };
}
</pre><p>
     (<code class="literal">stdenv</code> needs to be in scope, so if you write this in a separate Nix expression from <code class="literal">pkgs/all-packages.nix</code>, you need to pass it as a function argument.) Specifying a <code class="literal">name</code> and a <code class="literal">src</code> is the absolute minimum Nix requires. For convenience, you can also use <code class="literal">pname</code> and <code class="literal">version</code> attributes and <code class="literal">mkDerivation</code> will automatically set <code class="literal">name</code> to <code class="literal">"${pname}-${version}"</code> by default. Since <a class="link" href="https://github.com/NixOS/rfcs/pull/35" target="_top">RFC 0035</a>, this is preferred for packages in Nixpkgs, as it allows us to reuse the version easily:
    </p><pre class="programlisting">
stdenv.mkDerivation rec {
  pname = "libfoo";
  version = "1.2.3";
  src = fetchurl {
    url = "http://example.org/libfoo-source-${version}.tar.bz2";
    sha256 = "0x2g1jqygyr5wiwg4ma1nd7w4ydpy82z9gkcv8vh2v8dn3y58v5m";
  };
}
</pre><p>
     Many packages have dependencies that are not provided in the standard environment. It’s usually sufficient to specify those dependencies in the <code class="literal">buildInputs</code> attribute:
    </p><pre class="programlisting">
stdenv.mkDerivation {
  name = "libfoo-1.2.3";
  ...
  buildInputs = [libbar perl ncurses];
}
</pre><p>
     This attribute ensures that the <code class="literal">bin</code> subdirectories of these packages appear in the <code class="literal">PATH</code> environment variable during the build, that their <code class="literal">include</code> subdirectories are searched by the C compiler, and so on. (See <a class="xref" href="#ssec-setup-hooks" title="6.7. Package setup hooks">Section 6.7, “Package setup hooks”</a> for details.)
    </p><p>
     Often it is necessary to override or modify some aspect of the build. To make this easier, the standard environment breaks the package build into a number of <span class="emphasis"><em>phases</em></span>, all of which can be overridden or modified individually: unpacking the sources, applying patches, configuring, building, and installing. (There are some others; see <a class="xref" href="#sec-stdenv-phases" title="6.5. Phases">Section 6.5, “Phases”</a>.) For instance, a package that doesn’t supply a makefile but instead has to be compiled <span class="quote">“<span class="quote">manually</span>”</span> could be handled like this:
    </p><pre class="programlisting">
stdenv.mkDerivation {
  name = "fnord-4.5";
  ...
  buildPhase = ''
    gcc foo.c -o foo
  '';
  installPhase = ''
    mkdir -p $out/bin
    cp foo $out/bin
  '';
}
</pre><p>
     (Note the use of <code class="literal">''</code>-style string literals, which are very convenient for large multi-line script fragments because they don’t need escaping of <code class="literal">"</code> and <code class="literal">\</code>, and because indentation is intelligently removed.)
    </p><p>
     There are many other attributes to customise the build. These are listed in <a class="xref" href="#ssec-stdenv-attributes" title="6.4. Attributes">Section 6.4, “Attributes”</a>.
    </p><p>
     While the standard environment provides a generic builder, you can still supply your own build script:
    </p><pre class="programlisting">
stdenv.mkDerivation {
  name = "libfoo-1.2.3";
  ...
  builder = ./builder.sh;
}
</pre><p>
     where the builder can do anything it wants, but typically starts with
    </p><pre class="programlisting">
source $stdenv/setup
</pre><p>
     to let <code class="literal">stdenv</code> set up the environment (e.g., process the <code class="literal">buildInputs</code>). If you want, you can still use <code class="literal">stdenv</code>’s generic builder:
    </p><pre class="programlisting">
source $stdenv/setup

buildPhase() {
  echo "... this is my custom build phase ..."
  gcc foo.c -o foo
}

installPhase() {
  mkdir -p $out/bin
  cp foo $out/bin
}

genericBuild
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-tools-of-stdenv"></a>6.2. Tools provided by <code class="literal">stdenv</code></h2></div></div></div><p>
     The standard environment provides the following packages:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       The GNU C Compiler, configured with C and C++ support.
      </p></li><li class="listitem"><p>
       GNU coreutils (contains a few dozen standard Unix commands).
      </p></li><li class="listitem"><p>
       GNU findutils (contains <code class="literal">find</code>).
      </p></li><li class="listitem"><p>
       GNU diffutils (contains <code class="literal">diff</code>, <code class="literal">cmp</code>).
      </p></li><li class="listitem"><p>
       GNU <code class="literal">sed</code>.
      </p></li><li class="listitem"><p>
       GNU <code class="literal">grep</code>.
      </p></li><li class="listitem"><p>
       GNU <code class="literal">awk</code>.
      </p></li><li class="listitem"><p>
       GNU <code class="literal">tar</code>.
      </p></li><li class="listitem"><p>
       <code class="literal">gzip</code>, <code class="literal">bzip2</code> and <code class="literal">xz</code>.
      </p></li><li class="listitem"><p>
       GNU Make.
      </p></li><li class="listitem"><p>
       Bash. This is the shell used for all builders in the Nix Packages collection. Not using <code class="literal">/bin/sh</code> removes a large source of portability problems.
      </p></li><li class="listitem"><p>
       The <code class="literal">patch</code> command.
      </p></li></ul></div><p>
     On Linux, <code class="literal">stdenv</code> also includes the <code class="literal">patchelf</code> utility.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ssec-stdenv-dependencies"></a>6.3. Specifying dependencies</h2></div></div></div><p>
     As described in the Nix manual, almost any <code class="literal">*.drv</code> store path in a derivation’s attribute set will induce a dependency on that derivation. <code class="literal">mkDerivation</code>, however, takes a few attributes intended to, between them, include all the dependencies of a package. This is done both for structure and consistency, but also so that certain other setup can take place. For example, certain dependencies need their bin directories added to the <code class="literal">PATH</code>. That is built-in, but other setup is done via a pluggable mechanism that works in conjunction with these dependency attributes. See <a class="xref" href="#ssec-setup-hooks" title="6.7. Package setup hooks">Section 6.7, “Package setup hooks”</a> for details.
    </p><p>
     Dependencies can be broken down along three axes: their host and target platforms relative to the new derivation’s, and whether they are propagated. The platform distinctions are motivated by cross compilation; see <a class="xref" href="#chap-cross" title="Chapter 9. Cross-compilation">Chapter 9, <em>Cross-compilation</em></a> for exactly what each platform means.
     <a href="#ftn.idm140737320465264" class="footnote" id="idm140737320465264"><sup class="footnote">[1]</sup></a>
     But even if one is not cross compiling, the platforms imply whether or not the dependency is needed at run-time or build-time, a concept that makes perfect sense outside of cross compilation. By default, the run-time/build-time distinction is just a hint for mental clarity, but with <code class="literal">strictDeps</code> set it is mostly enforced even in the native case.
    </p><p>
     The extension of <code class="literal">PATH</code> with dependencies, alluded to above, proceeds according to the relative platforms alone. The process is carried out only for dependencies whose host platform matches the new derivation’s build platform i.e. dependencies which run on the platform where the new derivation will be built.
     <a href="#ftn.idm140737320461792" class="footnote" id="idm140737320461792"><sup class="footnote">[2]</sup></a>
     For each dependency &lt;dep&gt; of those dependencies, <code class="literal">dep/bin</code>, if present, is added to the <code class="literal">PATH</code> environment variable.
    </p><p>
     The dependency is propagated when it forces some of its other-transitive (non-immediate) downstream dependencies to also take it on as an immediate dependency. Nix itself already takes a package’s transitive dependencies into account, but this propagation ensures nixpkgs-specific infrastructure like setup hooks (mentioned above) also are run as if the propagated dependency.
    </p><p>
     It is important to note that dependencies are not necessarily propagated as the same sort of dependency that they were before, but rather as the corresponding sort so that the platform rules still line up. The exact rules for dependency propagation can be given by assigning to each dependency two integers based one how its host and target platforms are offset from the depending derivation’s platforms. Those offsets are given below in the descriptions of each dependency list attribute. Algorithmically, we traverse propagated inputs, accumulating every propagated dependency’s propagated dependencies and adjusting them to account for the <span class="quote">“<span class="quote">shift in perspective</span>”</span> described by the current dependency’s platform offsets. This results in sort a transitive closure of the dependency relation, with the offsets being approximately summed when two dependency links are combined. We also prune transitive dependencies whose combined offsets go out-of-bounds, which can be viewed as a filter over that transitive closure removing dependencies that are blatantly absurd.
    </p><p>
     We can define the process precisely with <a class="link" href="https://en.wikipedia.org/wiki/Natural_deduction" target="_top">Natural Deduction</a> using the inference rules. This probably seems a bit obtuse, but so is the bash code that actually implements it!
     <a href="#ftn.idm140737320453408" class="footnote" id="idm140737320453408"><sup class="footnote">[3]</sup></a>
     They’re confusing in very different ways so… hopefully if something doesn’t make sense in one presentation, it will in the other!
    </p><pre class="programlisting">
let mapOffset(h, t, i) = i + (if i &lt;= 0 then h else t - 1)

propagated-dep(h0, t0, A, B)
propagated-dep(h1, t1, B, C)
h0 + h1 in {-1, 0, 1}
h0 + t1 in {-1, 0, 1}
-------------------------------------- Transitive property
propagated-dep(mapOffset(h0, t0, h1),
               mapOffset(h0, t0, t1),
               A, C)
</pre><pre class="programlisting">
let mapOffset(h, t, i) = i + (if i &lt;= 0 then h else t - 1)

dep(h0, _, A, B)
propagated-dep(h1, t1, B, C)
h0 + h1 in {-1, 0, 1}
h0 + t1 in {-1, 0, -1}
----------------------------- Take immediate dependencies' propagated dependencies
propagated-dep(mapOffset(h0, t0, h1),
               mapOffset(h0, t0, t1),
               A, C)
</pre><pre class="programlisting">
propagated-dep(h, t, A, B)
----------------------------- Propagated dependencies count as dependencies
dep(h, t, A, B)
</pre><p>
     Some explanation of this monstrosity is in order. In the common case, the target offset of a dependency is the successor to the target offset: <code class="literal">t = h + 1</code>. That means that:
    </p><pre class="programlisting">
let f(h, t, i) = i + (if i &lt;= 0 then h else t - 1)
let f(h, h + 1, i) = i + (if i &lt;= 0 then h else (h + 1) - 1)
let f(h, h + 1, i) = i + (if i &lt;= 0 then h else h)
let f(h, h + 1, i) = i + h
</pre><p>
     This is where <span class="quote">“<span class="quote">sum-like</span>”</span> comes in from above: We can just sum all of the host offsets to get the host offset of the transitive dependency. The target offset is the transitive dependency is simply the host offset + 1, just as it was with the dependencies composed to make this transitive one; it can be ignored as it doesn’t add any new information.
    </p><p>
     Because of the bounds checks, the uncommon cases are <code class="literal">h = t</code> and <code class="literal">h + 2 = t</code>. In the former case, the motivation for <code class="literal">mapOffset</code> is that since its host and target platforms are the same, no transitive dependency of it should be able to <span class="quote">“<span class="quote">discover</span>”</span> an offset greater than its reduced target offsets. <code class="literal">mapOffset</code> effectively <span class="quote">“<span class="quote">squashes</span>”</span> all its transitive dependencies’ offsets so that none will ever be greater than the target offset of the original <code class="literal">h = t</code> package. In the other case, <code class="literal">h + 1</code> is skipped over between the host and target offsets. Instead of squashing the offsets, we need to <span class="quote">“<span class="quote">rip</span>”</span> them apart so no transitive dependencies’ offset is that one.
    </p><p>
     Overall, the unifying theme here is that propagation shouldn’t be introducing transitive dependencies involving platforms the depending package is unaware of. [One can imagine the dependending package asking for dependencies with the platforms it knows about; other platforms it doesn’t know how to ask for. The platform description in that scenario is a kind of unforagable capability.] The offset bounds checking and definition of <code class="literal">mapOffset</code> together ensure that this is the case. Discovering a new offset is discovering a new platform, and since those platforms weren’t in the derivation <span class="quote">“<span class="quote">spec</span>”</span> of the needing package, they cannot be relevant. From a capability perspective, we can imagine that the host and target platforms of a package are the capabilities a package requires, and the depending package must provide the capability to the dependency.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="variables-specifying-dependencies"></a>6.3.1. Variables specifying dependencies</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-depsBuildBuild"></a>6.3.1.1. <code class="literal">depsBuildBuild</code></h4></div></div></div><p>
       A list of dependencies whose host and target platforms are the new derivation’s build platform. This means a <code class="literal">-1</code> host and <code class="literal">-1</code> target offset from the new derivation’s platforms. These are programs and libraries used at build time that produce programs and libraries also used at build time. If the dependency doesn’t care about the target platform (i.e. isn’t a compiler or similar tool), put it in <code class="literal">nativeBuildInputs</code> instead. The most common use of this <code class="literal">buildPackages.stdenv.cc</code>, the default C compiler for this role. That example crops up more than one might think in old commonly used C libraries.
      </p><p>
       Since these packages are able to be run at build-time, they are always added to the <code class="literal">PATH</code>, as described above. But since these packages are only guaranteed to be able to run then, they shouldn’t persist as run-time dependencies. This isn’t currently enforced, but could be in the future.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-nativeBuildInputs"></a>6.3.1.2. <code class="literal">nativeBuildInputs</code></h4></div></div></div><p>
       A list of dependencies whose host platform is the new derivation’s build platform, and target platform is the new derivation’s host platform. This means a <code class="literal">-1</code> host offset and <code class="literal">0</code> target offset from the new derivation’s platforms. These are programs and libraries used at build-time that, if they are a compiler or similar tool, produce code to run at run-time—i.e. tools used to build the new derivation. If the dependency doesn’t care about the target platform (i.e. isn’t a compiler or similar tool), put it here, rather than in <code class="literal">depsBuildBuild</code> or <code class="literal">depsBuildTarget</code>. This could be called <code class="literal">depsBuildHost</code> but <code class="literal">nativeBuildInputs</code> is used for historical continuity.
      </p><p>
       Since these packages are able to be run at build-time, they are added to the <code class="literal">PATH</code>, as described above. But since these packages are only guaranteed to be able to run then, they shouldn’t persist as run-time dependencies. This isn’t currently enforced, but could be in the future.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-depsBuildTarget"></a>6.3.1.3. <code class="literal">depsBuildTarget</code></h4></div></div></div><p>
       A list of dependencies whose host platform is the new derivation’s build platform, and target platform is the new derivation’s target platform. This means a <code class="literal">-1</code> host offset and <code class="literal">1</code> target offset from the new derivation’s platforms. These are programs used at build time that produce code to run with code produced by the depending package. Most commonly, these are tools used to build the runtime or standard library that the currently-being-built compiler will inject into any code it compiles. In many cases, the currently-being-built-compiler is itself employed for that task, but when that compiler won’t run (i.e. its build and host platform differ) this is not possible. Other times, the compiler relies on some other tool, like binutils, that is always built separately so that the dependency is unconditional.
      </p><p>
       This is a somewhat confusing concept to wrap one’s head around, and for good reason. As the only dependency type where the platform offsets are not adjacent integers, it requires thinking of a bootstrapping stage <span class="emphasis"><em>two</em></span> away from the current one. It and its use-case go hand in hand and are both considered poor form: try to not need this sort of dependency, and try to avoid building standard libraries and runtimes in the same derivation as the compiler produces code using them. Instead strive to build those like a normal library, using the newly-built compiler just as a normal library would. In short, do not use this attribute unless you are packaging a compiler and are sure it is needed.
      </p><p>
       Since these packages are able to run at build time, they are added to the <code class="literal">PATH</code>, as described above. But since these packages are only guaranteed to be able to run then, they shouldn’t persist as run-time dependencies. This isn’t currently enforced, but could be in the future.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-depsHostHost"></a>6.3.1.4. <code class="literal">depsHostHost</code></h4></div></div></div><p>
       A list of dependencies whose host and target platforms match the new derivation’s host platform. This means a <code class="literal">0</code> host offset and <code class="literal">0</code> target offset from the new derivation’s host platform. These are packages used at run-time to generate code also used at run-time. In practice, this would usually be tools used by compilers for macros or a metaprogramming system, or libraries used by the macros or metaprogramming code itself. It’s always preferable to use a <code class="literal">depsBuildBuild</code> dependency in the derivation being built over a <code class="literal">depsHostHost</code> on the tool doing the building for this purpose.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-buildInputs"></a>6.3.1.5. <code class="literal">buildInputs</code></h4></div></div></div><p>
       A list of dependencies whose host platform and target platform match the new derivation’s. This means a <code class="literal">0</code> host offset and a <code class="literal">1</code> target offset from the new derivation’s host platform. This would be called <code class="literal">depsHostTarget</code> but for historical continuity. If the dependency doesn’t care about the target platform (i.e. isn’t a compiler or similar tool), put it here, rather than in <code class="literal">depsBuildBuild</code>.
      </p><p>
       These are often programs and libraries used by the new derivation at <span class="emphasis"><em>run</em></span>-time, but that isn’t always the case. For example, the machine code in a statically-linked library is only used at run-time, but the derivation containing the library is only needed at build-time. Even in the dynamic case, the library may also be needed at build-time to appease the linker.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-depsTargetTarget"></a>6.3.1.6. <code class="literal">depsTargetTarget</code></h4></div></div></div><p>
       A list of dependencies whose host platform matches the new derivation’s target platform. This means a <code class="literal">1</code> offset from the new derivation’s platforms. These are packages that run on the target platform, e.g. the standard library or run-time deps of standard library that a compiler insists on knowing about. It’s poor form in almost all cases for a package to depend on another from a future stage [future stage corresponding to positive offset]. Do not use this attribute unless you are packaging a compiler and are sure it is needed.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-depsBuildBuildPropagated"></a>6.3.1.7. <code class="literal">depsBuildBuildPropagated</code></h4></div></div></div><p>
       The propagated equivalent of <code class="literal">depsBuildBuild</code>. This perhaps never ought to be used, but it is included for consistency [see below for the others].
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-propagatedNativeBuildInputs"></a>6.3.1.8. <code class="literal">propagatedNativeBuildInputs</code></h4></div></div></div><p>
       The propagated equivalent of <code class="literal">nativeBuildInputs</code>. This would be called <code class="literal">depsBuildHostPropagated</code> but for historical continuity. For example, if package <code class="literal">Y</code> has <code class="literal">propagatedNativeBuildInputs = [X]</code>, and package <code class="literal">Z</code> has <code class="literal">buildInputs = [Y]</code>, then package <code class="literal">Z</code> will be built as if it included package <code class="literal">X</code> in its <code class="literal">nativeBuildInputs</code>. If instead, package <code class="literal">Z</code> has <code class="literal">nativeBuildInputs = [Y]</code>, then <code class="literal">Z</code> will be built as if it included <code class="literal">X</code> in the <code class="literal">depsBuildBuild</code> of package <code class="literal">Z</code>, because of the sum of the two <code class="literal">-1</code> host offsets.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-depsBuildTargetPropagated"></a>6.3.1.9. <code class="literal">depsBuildTargetPropagated</code></h4></div></div></div><p>
       The propagated equivalent of <code class="literal">depsBuildTarget</code>. This is prefixed for the same reason of alerting potential users.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-depsHostHostPropagated"></a>6.3.1.10. <code class="literal">depsHostHostPropagated</code></h4></div></div></div><p>
       The propagated equivalent of <code class="literal">depsHostHost</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-propagatedBuildInputs"></a>6.3.1.11. <code class="literal">propagatedBuildInputs</code></h4></div></div></div><p>
       The propagated equivalent of <code class="literal">buildInputs</code>. This would be called <code class="literal">depsHostTargetPropagated</code> but for historical continuity.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-depsTargetTargetPropagated"></a>6.3.1.12. <code class="literal">depsTargetTargetPropagated</code></h4></div></div></div><p>
       The propagated equivalent of <code class="literal">depsTargetTarget</code>. This is prefixed for the same reason of alerting potential users.
      </p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ssec-stdenv-attributes"></a>6.4. Attributes</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="variables-affecting-stdenv-initialisation"></a>6.4.1. Variables affecting <code class="literal">stdenv</code> initialisation</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-NIX_DEBUG"></a>6.4.1.1. <code class="literal">NIX_DEBUG</code></h4></div></div></div><p>
       A natural number indicating how much information to log. If set to 1 or higher, <code class="literal">stdenv</code> will print moderate debugging information during the build. In particular, the <code class="literal">gcc</code> and <code class="literal">ld</code> wrapper scripts will print out the complete command line passed to the wrapped tools. If set to 6 or higher, the <code class="literal">stdenv</code> setup script will be run with <code class="literal">set -x</code> tracing. If set to 7 or higher, the <code class="literal">gcc</code> and <code class="literal">ld</code> wrapper scripts will also be run with <code class="literal">set -x</code> tracing.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="attributes-affecting-build-properties"></a>6.4.2. Attributes affecting build properties</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-enableParallelBuilding"></a>6.4.2.1. <code class="literal">enableParallelBuilding</code></h4></div></div></div><p>
       If set to <code class="literal">true</code>, <code class="literal">stdenv</code> will pass specific flags to <code class="literal">make</code> and other build tools to enable parallel building with up to <code class="literal">build-cores</code> workers.
      </p><p>
       Unless set to <code class="literal">false</code>, some build systems with good support for parallel building including <code class="literal">cmake</code>, <code class="literal">meson</code>, and <code class="literal">qmake</code> will set it to <code class="literal">true</code>.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="special-variables"></a>6.4.3. Special variables</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-stdenv-passthru"></a>6.4.3.1. <code class="literal">passthru</code></h4></div></div></div><p>
       This is an attribute set which can be filled with arbitrary values. For example:
      </p><pre class="programlisting">
passthru = {
  foo = "bar";
  baz = {
    value1 = 4;
    value2 = 5;
  };
}
</pre><p>
       Values inside it are not passed to the builder, so you can change them without triggering a rebuild. However, they can be accessed outside of a derivation directly, as if they were set inside a derivation itself, e.g. <code class="literal">hello.baz.value1</code>. We don’t specify any usage or schema of <code class="literal">passthru</code> - it is meant for values that would be useful outside the derivation in other parts of a Nix expression (e.g. in other derivations). An example would be to convey some specific dependency of your derivation which contains a program with plugins support. Later, others who make derivations with plugins can use passed-through dependency to ensure that their plugin would be binary-compatible with built program.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-passthru-updateScript"></a>6.4.3.2. <code class="literal">passthru.updateScript</code></h4></div></div></div><p>
       A script to be run by <code class="literal">maintainers/scripts/update.nix</code> when the package is matched. It needs to be an executable file, either on the file system:
      </p><pre class="programlisting">
passthru.updateScript = ./update.sh;
</pre><p>
       or inside the expression itself:
      </p><pre class="programlisting">
passthru.updateScript = writeScript "update-zoom-us" ''
  #!/usr/bin/env nix-shell
  #!nix-shell -i bash -p curl pcre common-updater-scripts

  set -eu -o pipefail

  version="$(curl -sI https://zoom.us/client/latest/zoom_x86_64.tar.xz | grep -Fi 'Location:' | pcregrep -o1 '/(([0-9]\.?)+)/')"
  update-source-version zoom-us "$version"
'';
</pre><p>
       The attribute can also contain a list, a script followed by arguments to be passed to it:
      </p><pre class="programlisting">
passthru.updateScript = [ ../../update.sh pname "--requested-release=unstable" ];
</pre><p>
       The script will be run with <code class="literal">UPDATE_NIX_ATTR_PATH</code> environment variable set to the attribute path it is supposed to update.
      </p><div class="note"><h3 class="title">Note</h3><p>
        The script will be usually run from the root of the Nixpkgs repository but you should not rely on that. Also note that the update scripts will be run in parallel by default; you should avoid running <code class="literal">git commit</code> or any other commands that cannot handle that.
       </p></div><p>
       For information about how to run the updates, execute <code class="literal">nix-shell maintainers/scripts/update.nix</code>.
      </p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-stdenv-phases"></a>6.5. Phases</h2></div></div></div><p>
     The generic builder has a number of <span class="emphasis"><em>phases</em></span>. Package builds are split into phases to make it easier to override specific parts of the build (e.g., unpacking the sources or installing the binaries). Furthermore, it allows a nicer presentation of build logs in the Nix build farm.
    </p><p>
     Each phase can be overridden in its entirety either by setting the environment variable <code class="literal">namePhase</code> to a string containing some shell commands to be executed, or by redefining the shell function <code class="literal">namePhase</code>. The former is convenient to override a phase from the derivation, while the latter is convenient from a build script. However, typically one only wants to <span class="emphasis"><em>add</em></span> some commands to a phase, e.g. by defining <code class="literal">postInstall</code> or <code class="literal">preFixup</code>, as skipping some of the default actions may have unexpected consequences. The default script for each phase is defined in the file <code class="literal">pkgs/stdenv/generic/setup.sh</code>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-controlling-phases"></a>6.5.1. Controlling phases</h3></div></div></div><p>
      There are a number of variables that control what phases are executed and in what order:
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="variables-affecting-phase-control"></a>6.5.1.1. Variables affecting phase control</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-phases"></a>6.5.1.1.1. <code class="literal">phases</code></h5></div></div></div><p>
        Specifies the phases. You can change the order in which phases are executed, or add new phases, by setting this variable. If it’s not set, the default value is used, which is <code class="literal">$prePhases unpackPhase patchPhase $preConfigurePhases configurePhase $preBuildPhases buildPhase checkPhase $preInstallPhases installPhase fixupPhase installCheckPhase $preDistPhases distPhase $postPhases</code>.
       </p><p>
        Usually, if you just want to add a few phases, it’s more convenient to set one of the variables below (such as <code class="literal">preInstallPhases</code>), as you then don’t specify all the normal phases.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-prePhases"></a>6.5.1.1.2. <code class="literal">prePhases</code></h5></div></div></div><p>
        Additional phases executed before any of the default phases.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preConfigurePhases"></a>6.5.1.1.3. <code class="literal">preConfigurePhases</code></h5></div></div></div><p>
        Additional phases executed just before the configure phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preBuildPhases"></a>6.5.1.1.4. <code class="literal">preBuildPhases</code></h5></div></div></div><p>
        Additional phases executed just before the build phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preInstallPhases"></a>6.5.1.1.5. <code class="literal">preInstallPhases</code></h5></div></div></div><p>
        Additional phases executed just before the install phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preFixupPhases"></a>6.5.1.1.6. <code class="literal">preFixupPhases</code></h5></div></div></div><p>
        Additional phases executed just before the fixup phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preDistPhases"></a>6.5.1.1.7. <code class="literal">preDistPhases</code></h5></div></div></div><p>
        Additional phases executed just before the distribution phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-postPhases"></a>6.5.1.1.8. <code class="literal">postPhases</code></h5></div></div></div><p>
        Additional phases executed after any of the default phases.
       </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-unpack-phase"></a>6.5.2. The unpack phase</h3></div></div></div><p>
      The unpack phase is responsible for unpacking the source code of the package. The default implementation of <code class="literal">unpackPhase</code> unpacks the source files listed in the <code class="literal">src</code> environment variable to the current directory. It supports the following files by default:
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="tar-files"></a>6.5.2.1. Tar files</h4></div></div></div><p>
       These can optionally be compressed using <code class="literal">gzip</code> (<code class="literal">.tar.gz</code>, <code class="literal">.tgz</code> or <code class="literal">.tar.Z</code>), <code class="literal">bzip2</code> (<code class="literal">.tar.bz2</code>, <code class="literal">.tbz2</code> or <code class="literal">.tbz</code>) or <code class="literal">xz</code> (<code class="literal">.tar.xz</code>, <code class="literal">.tar.lzma</code> or <code class="literal">.txz</code>).
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="zip-files"></a>6.5.2.2. Zip files</h4></div></div></div><p>
       Zip files are unpacked using <code class="literal">unzip</code>. However, <code class="literal">unzip</code> is not in the standard environment, so you should add it to <code class="literal">nativeBuildInputs</code> yourself.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="directories-in-the-nix-store"></a>6.5.2.3. Directories in the Nix store</h4></div></div></div><p>
       These are simply copied to the current directory. The hash part of the file name is stripped, e.g. <code class="literal">/nix/store/1wydxgby13cz...-my-sources</code> would be copied to <code class="literal">my-sources</code>.
      </p><p>
       Additional file types can be supported by setting the <code class="literal">unpackCmd</code> variable (see below).
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="variables-controlling-the-unpack-phase"></a>6.5.2.4. Variables controlling the unpack phase</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-src"></a>6.5.2.4.1. <code class="literal">srcs</code> / <code class="literal">src</code></h5></div></div></div><p>
        The list of source files or directories to be unpacked or copied. One of these must be set.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-sourceRoot"></a>6.5.2.4.2. <code class="literal">sourceRoot</code></h5></div></div></div><p>
        After running <code class="literal">unpackPhase</code>, the generic builder changes the current directory to the directory created by unpacking the sources. If there are multiple source directories, you should set <code class="literal">sourceRoot</code> to the name of the intended directory.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-setSourceRoot"></a>6.5.2.4.3. <code class="literal">setSourceRoot</code></h5></div></div></div><p>
        Alternatively to setting <code class="literal">sourceRoot</code>, you can set <code class="literal">setSourceRoot</code> to a shell command to be evaluated by the unpack phase after the sources have been unpacked. This command must set <code class="literal">sourceRoot</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preUnpack"></a>6.5.2.4.4. <code class="literal">preUnpack</code></h5></div></div></div><p>
        Hook executed at the start of the unpack phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-postUnpack"></a>6.5.2.4.5. <code class="literal">postUnpack</code></h5></div></div></div><p>
        Hook executed at the end of the unpack phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontUnpack"></a>6.5.2.4.6. <code class="literal">dontUnpack</code></h5></div></div></div><p>
        Set to true to skip the unpack phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontMakeSourcesWritable"></a>6.5.2.4.7. <code class="literal">dontMakeSourcesWritable</code></h5></div></div></div><p>
        If set to <code class="literal">1</code>, the unpacked sources are <span class="emphasis"><em>not</em></span> made writable. By default, they are made writable to prevent problems with read-only sources. For example, copied store directories would be read-only without this.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-unpackCmd"></a>6.5.2.4.8. <code class="literal">unpackCmd</code></h5></div></div></div><p>
        The unpack phase evaluates the string <code class="literal">$unpackCmd</code> for any unrecognised file. The path to the current source file is contained in the <code class="literal">curSrc</code> variable.
       </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-patch-phase"></a>6.5.3. The patch phase</h3></div></div></div><p>
      The patch phase applies the list of patches defined in the <code class="literal">patches</code> variable.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="variables-controlling-the-patch-phase"></a>6.5.3.1. Variables controlling the patch phase</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontPatch"></a>6.5.3.1.1. <code class="literal">dontPatch</code></h5></div></div></div><p>
        Set to true to skip the patch phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-patches"></a>6.5.3.1.2. <code class="literal">patches</code></h5></div></div></div><p>
        The list of patches. They must be in the format accepted by the <code class="literal">patch</code> command, and may optionally be compressed using <code class="literal">gzip</code> (<code class="literal">.gz</code>), <code class="literal">bzip2</code> (<code class="literal">.bz2</code>) or <code class="literal">xz</code> (<code class="literal">.xz</code>).
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-patchFlags"></a>6.5.3.1.3. <code class="literal">patchFlags</code></h5></div></div></div><p>
        Flags to be passed to <code class="literal">patch</code>. If not set, the argument <code class="literal">-p1</code> is used, which causes the leading directory component to be stripped from the file names in each patch.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-prePatch"></a>6.5.3.1.4. <code class="literal">prePatch</code></h5></div></div></div><p>
        Hook executed at the start of the patch phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-postPatch"></a>6.5.3.1.5. <code class="literal">postPatch</code></h5></div></div></div><p>
        Hook executed at the end of the patch phase.
       </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-configure-phase"></a>6.5.4. The configure phase</h3></div></div></div><p>
      The configure phase prepares the source tree for building. The default <code class="literal">configurePhase</code> runs <code class="literal">./configure</code> (typically an Autoconf-generated script) if it exists.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="variables-controlling-the-configure-phase"></a>6.5.4.1. Variables controlling the configure phase</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-configureScript"></a>6.5.4.1.1. <code class="literal">configureScript</code></h5></div></div></div><p>
        The name of the configure script. It defaults to <code class="literal">./configure</code> if it exists; otherwise, the configure phase is skipped. This can actually be a command (like <code class="literal">perl ./Configure.pl</code>).
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-configureFlags"></a>6.5.4.1.2. <code class="literal">configureFlags</code></h5></div></div></div><p>
        A list of strings passed as additional arguments to the configure script.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontConfigure"></a>6.5.4.1.3. <code class="literal">dontConfigure</code></h5></div></div></div><p>
        Set to true to skip the configure phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-configureFlagsArray"></a>6.5.4.1.4. <code class="literal">configureFlagsArray</code></h5></div></div></div><p>
        A shell array containing additional arguments passed to the configure script. You must use this instead of <code class="literal">configureFlags</code> if the arguments contain spaces.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontAddPrefix"></a>6.5.4.1.5. <code class="literal">dontAddPrefix</code></h5></div></div></div><p>
        By default, the flag <code class="literal">--prefix=$prefix</code> is added to the configure flags. If this is undesirable, set this variable to true.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-prefix"></a>6.5.4.1.6. <code class="literal">prefix</code></h5></div></div></div><p>
        The prefix under which the package must be installed, passed via the <code class="literal">--prefix</code> option to the configure script. It defaults to <code class="literal">$out</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-prefixKey"></a>6.5.4.1.7. <code class="literal">prefixKey</code></h5></div></div></div><p>
        The key to use when specifying the prefix. By default, this is set to <code class="literal">--prefix=</code> as that is used by the majority of packages.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontAddDisableDepTrack"></a>6.5.4.1.8. <code class="literal">dontAddDisableDepTrack</code></h5></div></div></div><p>
        By default, the flag <code class="literal">--disable-dependency-tracking</code> is added to the configure flags to speed up Automake-based builds. If this is undesirable, set this variable to true.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontFixLibtool"></a>6.5.4.1.9. <code class="literal">dontFixLibtool</code></h5></div></div></div><p>
        By default, the configure phase applies some special hackery to all files called <code class="literal">ltmain.sh</code> before running the configure script in order to improve the purity of Libtool-based packages
        <a href="#ftn.idm140737320246752" class="footnote" id="idm140737320246752"><sup class="footnote">[4]</sup></a>
        . If this is undesirable, set this variable to true.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontDisableStatic"></a>6.5.4.1.10. <code class="literal">dontDisableStatic</code></h5></div></div></div><p>
        By default, when the configure script has <code class="literal">--enable-static</code>, the option <code class="literal">--disable-static</code> is added to the configure flags.
       </p><p>
        If this is undesirable, set this variable to true.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-configurePlatforms"></a>6.5.4.1.11. <code class="literal">configurePlatforms</code></h5></div></div></div><p>
        By default, when cross compiling, the configure script has <code class="literal">--build=...</code> and <code class="literal">--host=...</code> passed. Packages can instead pass <code class="literal">[ "build" "host" "target" ]</code> or a subset to control exactly which platform flags are passed. Compilers and other tools can use this to also pass the target platform.
        <a href="#ftn.idm140737320238384" class="footnote" id="idm140737320238384"><sup class="footnote">[5]</sup></a>
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preConfigure"></a>6.5.4.1.12. <code class="literal">preConfigure</code></h5></div></div></div><p>
        Hook executed at the start of the configure phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-postConfigure"></a>6.5.4.1.13. <code class="literal">postConfigure</code></h5></div></div></div><p>
        Hook executed at the end of the configure phase.
       </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="build-phase"></a>6.5.5. The build phase</h3></div></div></div><p>
      The build phase is responsible for actually building the package (e.g. compiling it). The default <code class="literal">buildPhase</code> simply calls <code class="literal">make</code> if a file named <code class="literal">Makefile</code>, <code class="literal">makefile</code> or <code class="literal">GNUmakefile</code> exists in the current directory (or the <code class="literal">makefile</code> is explicitly set); otherwise it does nothing.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="variables-controlling-the-build-phase"></a>6.5.5.1. Variables controlling the build phase</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontBuild"></a>6.5.5.1.1. <code class="literal">dontBuild</code></h5></div></div></div><p>
        Set to true to skip the build phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-makefile"></a>6.5.5.1.2. <code class="literal">makefile</code></h5></div></div></div><p>
        The file name of the Makefile.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-makeFlags"></a>6.5.5.1.3. <code class="literal">makeFlags</code></h5></div></div></div><p>
        A list of strings passed as additional flags to <code class="literal">make</code>. These flags are also used by the default install and check phase. For setting make flags specific to the build phase, use <code class="literal">buildFlags</code> (see below).
       </p><pre class="programlisting">
makeFlags = [ "PREFIX=$(out)" ];
</pre><div class="note"><h3 class="title">Note</h3><p>
         The flags are quoted in bash, but environment variables can be specified by using the make syntax.
        </p></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-makeFlagsArray"></a>6.5.5.1.4. <code class="literal">makeFlagsArray</code></h5></div></div></div><p>
        A shell array containing additional arguments passed to <code class="literal">make</code>. You must use this instead of <code class="literal">makeFlags</code> if the arguments contain spaces, e.g.
       </p><pre class="programlisting">
preBuild = ''
  makeFlagsArray+=(CFLAGS="-O0 -g" LDFLAGS="-lfoo -lbar")
'';
</pre><p>
        Note that shell arrays cannot be passed through environment variables, so you cannot set <code class="literal">makeFlagsArray</code> in a derivation attribute (because those are passed through environment variables): you have to define them in shell code.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-buildFlags"></a>6.5.5.1.5. <code class="literal">buildFlags</code> / <code class="literal">buildFlagsArray</code></h5></div></div></div><p>
        A list of strings passed as additional flags to <code class="literal">make</code>. Like <code class="literal">makeFlags</code> and <code class="literal">makeFlagsArray</code>, but only used by the build phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preBuild"></a>6.5.5.1.6. <code class="literal">preBuild</code></h5></div></div></div><p>
        Hook executed at the start of the build phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-postBuild"></a>6.5.5.1.7. <code class="literal">postBuild</code></h5></div></div></div><p>
        Hook executed at the end of the build phase.
       </p><p>
        You can set flags for <code class="literal">make</code> through the <code class="literal">makeFlags</code> variable.
       </p><p>
        Before and after running <code class="literal">make</code>, the hooks <code class="literal">preBuild</code> and <code class="literal">postBuild</code> are called, respectively.
       </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-check-phase"></a>6.5.6. The check phase</h3></div></div></div><p>
      The check phase checks whether the package was built correctly by running its test suite. The default <code class="literal">checkPhase</code> calls <code class="literal">make check</code>, but only if the <code class="literal">doCheck</code> variable is enabled.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="variables-controlling-the-check-phase"></a>6.5.6.1. Variables controlling the check phase</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-doCheck"></a>6.5.6.1.1. <code class="literal">doCheck</code></h5></div></div></div><p>
        Controls whether the check phase is executed. By default it is skipped, but if <code class="literal">doCheck</code> is set to true, the check phase is usually executed. Thus you should set
       </p><pre class="programlisting">
doCheck = true;
</pre><p>
        in the derivation to enable checks. The exception is cross compilation. Cross compiled builds never run tests, no matter how <code class="literal">doCheck</code> is set, as the newly-built program won’t run on the platform used to build it.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="makeflags-makeflagsarray-makefile"></a>6.5.6.1.2. <code class="literal">makeFlags</code> / <code class="literal">makeFlagsArray</code> / <code class="literal">makefile</code></h5></div></div></div><p>
        See the <a class="link" href="#var-stdenv-makeFlags" title="6.5.5.1.3. makeFlags">build phase</a> for details.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-checkTarget"></a>6.5.6.1.3. <code class="literal">checkTarget</code></h5></div></div></div><p>
        The make target that runs the tests. Defaults to <code class="literal">check</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-checkFlags"></a>6.5.6.1.4. <code class="literal">checkFlags</code> / <code class="literal">checkFlagsArray</code></h5></div></div></div><p>
        A list of strings passed as additional flags to <code class="literal">make</code>. Like <code class="literal">makeFlags</code> and <code class="literal">makeFlagsArray</code>, but only used by the check phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-checkInputs"></a>6.5.6.1.5. <code class="literal">checkInputs</code></h5></div></div></div><p>
        A list of dependencies used by the phase. This gets included in <code class="literal">nativeBuildInputs</code> when <code class="literal">doCheck</code> is set.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preCheck"></a>6.5.6.1.6. <code class="literal">preCheck</code></h5></div></div></div><p>
        Hook executed at the start of the check phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-postCheck"></a>6.5.6.1.7. <code class="literal">postCheck</code></h5></div></div></div><p>
        Hook executed at the end of the check phase.
       </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-install-phase"></a>6.5.7. The install phase</h3></div></div></div><p>
      The install phase is responsible for installing the package in the Nix store under <code class="literal">out</code>. The default <code class="literal">installPhase</code> creates the directory <code class="literal">$out</code> and calls <code class="literal">make install</code>.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="variables-controlling-the-install-phase"></a>6.5.7.1. Variables controlling the install phase</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontInstall"></a>6.5.7.1.1. <code class="literal">dontInstall</code></h5></div></div></div><p>
        Set to true to skip the install phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="makeflags-makeflagsarray-makefile-1"></a>6.5.7.1.2. <code class="literal">makeFlags</code> / <code class="literal">makeFlagsArray</code> / <code class="literal">makefile</code></h5></div></div></div><p>
        See the <a class="link" href="#var-stdenv-makeFlags" title="6.5.5.1.3. makeFlags">build phase</a> for details.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-installTargets"></a>6.5.7.1.3. <code class="literal">installTargets</code></h5></div></div></div><p>
        The make targets that perform the installation. Defaults to <code class="literal">install</code>. Example:
       </p><pre class="programlisting">
installTargets = "install-bin install-doc";
</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-installFlags"></a>6.5.7.1.4. <code class="literal">installFlags</code> / <code class="literal">installFlagsArray</code></h5></div></div></div><p>
        A list of strings passed as additional flags to <code class="literal">make</code>. Like <code class="literal">makeFlags</code> and <code class="literal">makeFlagsArray</code>, but only used by the install phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preInstall"></a>6.5.7.1.5. <code class="literal">preInstall</code></h5></div></div></div><p>
        Hook executed at the start of the install phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-postInstall"></a>6.5.7.1.6. <code class="literal">postInstall</code></h5></div></div></div><p>
        Hook executed at the end of the install phase.
       </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-fixup-phase"></a>6.5.8. The fixup phase</h3></div></div></div><p>
      The fixup phase performs some (Nix-specific) post-processing actions on the files installed under <code class="literal">$out</code> by the install phase. The default <code class="literal">fixupPhase</code> does the following:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        It moves the <code class="literal">man/</code>, <code class="literal">doc/</code> and <code class="literal">info/</code> subdirectories of <code class="literal">$out</code> to <code class="literal">share/</code>.
       </p></li><li class="listitem"><p>
        It strips libraries and executables of debug information.
       </p></li><li class="listitem"><p>
        On Linux, it applies the <code class="literal">patchelf</code> command to ELF executables and libraries to remove unused directories from the <code class="literal">RPATH</code> in order to prevent unnecessary runtime dependencies.
       </p></li><li class="listitem"><p>
        It rewrites the interpreter paths of shell scripts to paths found in <code class="literal">PATH</code>. E.g., <code class="literal">/usr/bin/perl</code> will be rewritten to <code class="literal">/nix/store/some-perl/bin/perl</code> found in <code class="literal">PATH</code>.
       </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="variables-controlling-the-fixup-phase"></a>6.5.8.1. Variables controlling the fixup phase</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontFixup"></a>6.5.8.1.1. <code class="literal">dontFixup</code></h5></div></div></div><p>
        Set to true to skip the fixup phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontStrip"></a>6.5.8.1.2. <code class="literal">dontStrip</code></h5></div></div></div><p>
        If set, libraries and executables are not stripped. By default, they are.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontStripHost"></a>6.5.8.1.3. <code class="literal">dontStripHost</code></h5></div></div></div><p>
        Like <code class="literal">dontStrip</code>, but only affects the <code class="literal">strip</code> command targetting the package’s host platform. Useful when supporting cross compilation, but otherwise feel free to ignore.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontStripTarget"></a>6.5.8.1.4. <code class="literal">dontStripTarget</code></h5></div></div></div><p>
        Like <code class="literal">dontStrip</code>, but only affects the <code class="literal">strip</code> command targetting the packages’ target platform. Useful when supporting cross compilation, but otherwise feel free to ignore.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontMoveSbin"></a>6.5.8.1.5. <code class="literal">dontMoveSbin</code></h5></div></div></div><p>
        If set, files in <code class="literal">$out/sbin</code> are not moved to <code class="literal">$out/bin</code>. By default, they are.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-stripAllList"></a>6.5.8.1.6. <code class="literal">stripAllList</code></h5></div></div></div><p>
        List of directories to search for libraries and executables from which <span class="emphasis"><em>all</em></span> symbols should be stripped. By default, it’s empty. Stripping all symbols is risky, since it may remove not just debug symbols but also ELF information necessary for normal execution.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-stripAllFlags"></a>6.5.8.1.7. <code class="literal">stripAllFlags</code></h5></div></div></div><p>
        Flags passed to the <code class="literal">strip</code> command applied to the files in the directories listed in <code class="literal">stripAllList</code>. Defaults to <code class="literal">-s</code> (i.e. <code class="literal">--strip-all</code>).
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-stripDebugList"></a>6.5.8.1.8. <code class="literal">stripDebugList</code></h5></div></div></div><p>
        List of directories to search for libraries and executables from which only debugging-related symbols should be stripped. It defaults to <code class="literal">lib lib32 lib64 libexec bin sbin</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-stripDebugFlags"></a>6.5.8.1.9. <code class="literal">stripDebugFlags</code></h5></div></div></div><p>
        Flags passed to the <code class="literal">strip</code> command applied to the files in the directories listed in <code class="literal">stripDebugList</code>. Defaults to <code class="literal">-S</code> (i.e. <code class="literal">--strip-debug</code>).
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontPatchELF"></a>6.5.8.1.10. <code class="literal">dontPatchELF</code></h5></div></div></div><p>
        If set, the <code class="literal">patchelf</code> command is not used to remove unnecessary <code class="literal">RPATH</code> entries. Only applies to Linux.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontPatchShebangs"></a>6.5.8.1.11. <code class="literal">dontPatchShebangs</code></h5></div></div></div><p>
        If set, scripts starting with <code class="literal">#!</code> do not have their interpreter paths rewritten to paths in the Nix store.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontPruneLibtoolFiles"></a>6.5.8.1.12. <code class="literal">dontPruneLibtoolFiles</code></h5></div></div></div><p>
        If set, libtool <code class="literal">.la</code> files associated with shared libraries won’t have their <code class="literal">dependency_libs</code> field cleared.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-forceShare"></a>6.5.8.1.13. <code class="literal">forceShare</code></h5></div></div></div><p>
        The list of directories that must be moved from <code class="literal">$out</code> to <code class="literal">$out/share</code>. Defaults to <code class="literal">man doc info</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-setupHook"></a>6.5.8.1.14. <code class="literal">setupHook</code></h5></div></div></div><p>
        A package can export a <a class="link" href="#ssec-setup-hooks" title="6.7. Package setup hooks">setup hook</a> by setting this variable. The setup hook, if defined, is copied to <code class="literal">$out/nix-support/setup-hook</code>. Environment variables are then substituted in it using <code class="literal">substituteAll</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preFixup"></a>6.5.8.1.15. <code class="literal">preFixup</code></h5></div></div></div><p>
        Hook executed at the start of the fixup phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-postFixup"></a>6.5.8.1.16. <code class="literal">postFixup</code></h5></div></div></div><p>
        Hook executed at the end of the fixup phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="stdenv-separateDebugInfo"></a>6.5.8.1.17. <code class="literal">separateDebugInfo</code></h5></div></div></div><p>
        If set to <code class="literal">true</code>, the standard environment will enable debug information in C/C++ builds. After installation, the debug information will be separated from the executables and stored in the output named <code class="literal">debug</code>. (This output is enabled automatically; you don’t need to set the <code class="literal">outputs</code> attribute explicitly.) To be precise, the debug information is stored in <code class="literal">debug/lib/debug/.build-id/XX/YYYY…</code>, where &lt;XXYYYY…&gt; is the &lt;build ID&gt; of the binary — a SHA-1 hash of the contents of the binary. Debuggers like GDB use the build ID to look up the separated debug information.
       </p><p>
        For example, with GDB, you can add
       </p><pre class="programlisting">
set debug-file-directory ~/.nix-profile/lib/debug
</pre><p>
        to <code class="literal">~/.gdbinit</code>. GDB will then be able to find debug information installed via <code class="literal">nix-env -i</code>.
       </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-installCheck-phase"></a>6.5.9. The installCheck phase</h3></div></div></div><p>
      The installCheck phase checks whether the package was installed correctly by running its test suite against the installed directories. The default <code class="literal">installCheck</code> calls <code class="literal">make installcheck</code>.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="variables-controlling-the-installcheck-phase"></a>6.5.9.1. Variables controlling the installCheck phase</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-doInstallCheck"></a>6.5.9.1.1. <code class="literal">doInstallCheck</code></h5></div></div></div><p>
        Controls whether the installCheck phase is executed. By default it is skipped, but if <code class="literal">doInstallCheck</code> is set to true, the installCheck phase is usually executed. Thus you should set
       </p><pre class="programlisting">
doInstallCheck = true;
</pre><p>
        in the derivation to enable install checks. The exception is cross compilation. Cross compiled builds never run tests, no matter how <code class="literal">doInstallCheck</code> is set, as the newly-built program won’t run on the platform used to build it.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-installCheckTarget"></a>6.5.9.1.2. <code class="literal">installCheckTarget</code></h5></div></div></div><p>
        The make target that runs the install tests. Defaults to <code class="literal">installcheck</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-installCheckFlags"></a>6.5.9.1.3. <code class="literal">installCheckFlags</code> / <code class="literal">installCheckFlagsArray</code></h5></div></div></div><p>
        A list of strings passed as additional flags to <code class="literal">make</code>. Like <code class="literal">makeFlags</code> and <code class="literal">makeFlagsArray</code>, but only used by the installCheck phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-installCheckInputs"></a>6.5.9.1.4. <code class="literal">installCheckInputs</code></h5></div></div></div><p>
        A list of dependencies used by the phase. This gets included in <code class="literal">nativeBuildInputs</code> when <code class="literal">doInstallCheck</code> is set.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preInstallCheck"></a>6.5.9.1.5. <code class="literal">preInstallCheck</code></h5></div></div></div><p>
        Hook executed at the start of the installCheck phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-postInstallCheck"></a>6.5.9.1.6. <code class="literal">postInstallCheck</code></h5></div></div></div><p>
        Hook executed at the end of the installCheck phase.
       </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-distribution-phase"></a>6.5.10. The distribution phase</h3></div></div></div><p>
      The distribution phase is intended to produce a source distribution of the package. The default <code class="literal">distPhase</code> first calls <code class="literal">make dist</code>, then it copies the resulting source tarballs to <code class="literal">$out/tarballs/</code>. This phase is only executed if the attribute <code class="literal">doDist</code> is set.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="variables-controlling-the-distribution-phase"></a>6.5.10.1. Variables controlling the distribution phase</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-distTarget"></a>6.5.10.1.1. <code class="literal">distTarget</code></h5></div></div></div><p>
        The make target that produces the distribution. Defaults to <code class="literal">dist</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-distFlags"></a>6.5.10.1.2. <code class="literal">distFlags</code> / <code class="literal">distFlagsArray</code></h5></div></div></div><p>
        Additional flags passed to <code class="literal">make</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-tarballs"></a>6.5.10.1.3. <code class="literal">tarballs</code></h5></div></div></div><p>
        The names of the source distribution files to be copied to <code class="literal">$out/tarballs/</code>. It can contain shell wildcards. The default is <code class="literal">*.tar.gz</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-dontCopyDist"></a>6.5.10.1.4. <code class="literal">dontCopyDist</code></h5></div></div></div><p>
        If set, no files are copied to <code class="literal">$out/tarballs/</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-preDist"></a>6.5.10.1.5. <code class="literal">preDist</code></h5></div></div></div><p>
        Hook executed at the start of the distribution phase.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="var-stdenv-postDist"></a>6.5.10.1.6. <code class="literal">postDist</code></h5></div></div></div><p>
        Hook executed at the end of the distribution phase.
       </p></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ssec-stdenv-functions"></a>6.6. Shell functions</h2></div></div></div><p>
     The standard environment provides a number of useful functions.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="fun-makeWrapper"></a>6.6.1. <code class="literal">makeWrapper</code> &lt;executable&gt; &lt;wrapperfile&gt; &lt;args&gt;</h3></div></div></div><p>
      Constructs a wrapper for a program with various possible arguments. For example:
     </p><pre class="programlisting">
# adds `FOOBAR=baz` to `$out/bin/foo`’s environment
makeWrapper $out/bin/foo $wrapperfile --set FOOBAR baz

# prefixes the binary paths of `hello` and `git`
# Be advised that paths often should be patched in directly
# (via string replacements or in `configurePhase`).
makeWrapper $out/bin/foo $wrapperfile --prefix PATH : ${lib.makeBinPath [ hello git ]}
</pre><p>
      There’s many more kinds of arguments, they are documented in <code class="literal">nixpkgs/pkgs/build-support/setup-hooks/make-wrapper.sh</code>.
     </p><p>
      <code class="literal">wrapProgram</code> is a convenience function you probably want to use most of the time.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="fun-substitute"></a>6.6.2. <code class="literal">substitute</code> &lt;infile&gt; &lt;outfile&gt; &lt;subs&gt;</h3></div></div></div><p>
      Performs string substitution on the contents of &lt;infile&gt;, writing the result to &lt;outfile&gt;. The substitutions in &lt;subs&gt; are of the following form:
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="replace-s1-s2"></a>6.6.2.1. <code class="literal">--replace</code> &lt;s1&gt; &lt;s2&gt;</h4></div></div></div><p>
       Replace every occurrence of the string &lt;s1&gt; by &lt;s2&gt;.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="subst-var-varname"></a>6.6.2.2. <code class="literal">--subst-var</code> &lt;varName&gt;</h4></div></div></div><p>
       Replace every occurrence of <code class="literal">@varName@</code> by the contents of the environment variable &lt;varName&gt;. This is useful for generating files from templates, using <code class="literal">@...@</code> in the template as placeholders.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="subst-var-by-varname-s"></a>6.6.2.3. <code class="literal">--subst-var-by</code> &lt;varName&gt; &lt;s&gt;</h4></div></div></div><p>
       Replace every occurrence of <code class="literal">@varName@</code> by the string &lt;s&gt;.
      </p><p>
       Example:
      </p><pre class="programlisting">
substitute ./foo.in ./foo.out \
    --replace /usr/bin/bar $bar/bin/bar \
    --replace "a string containing spaces" "some other text" \
    --subst-var someVar
</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="fun-substituteInPlace"></a>6.6.3. <code class="literal">substituteInPlace</code> &lt;file&gt; &lt;subs&gt;</h3></div></div></div><p>
      Like <code class="literal">substitute</code>, but performs the substitutions in place on the file &lt;file&gt;.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="fun-substituteAll"></a>6.6.4. <code class="literal">substituteAll</code> &lt;infile&gt; &lt;outfile&gt;</h3></div></div></div><p>
      Replaces every occurrence of <code class="literal">@varName@</code>, where &lt;varName&gt; is any environment variable, in &lt;infile&gt;, writing the result to &lt;outfile&gt;. For instance, if &lt;infile&gt; has the contents
     </p><pre class="programlisting">
#! @bash@/bin/sh
PATH=@coreutils@/bin
echo @foo@
</pre><p>
      and the environment contains <code class="literal">bash=/nix/store/bmwp0q28cf21...-bash-3.2-p39</code> and <code class="literal">coreutils=/nix/store/68afga4khv0w...-coreutils-6.12</code>, but does not contain the variable <code class="literal">foo</code>, then the output will be
     </p><pre class="programlisting">
#! /nix/store/bmwp0q28cf21...-bash-3.2-p39/bin/sh
PATH=/nix/store/68afga4khv0w...-coreutils-6.12/bin
echo @foo@
</pre><p>
      That is, no substitution is performed for undefined variables.
     </p><p>
      Environment variables that start with an uppercase letter or an underscore are filtered out, to prevent global variables (like <code class="literal">HOME</code>) or private variables (like <code class="literal">__ETC_PROFILE_DONE</code>) from accidentally getting substituted. The variables also have to be valid bash <span class="quote">“<span class="quote">names</span>”</span>, as defined in the bash manpage (alphanumeric or <code class="literal">_</code>, must not start with a number).
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="fun-substituteAllInPlace"></a>6.6.5. <code class="literal">substituteAllInPlace</code> &lt;file&gt;</h3></div></div></div><p>
      Like <code class="literal">substituteAll</code>, but performs the substitutions in place on the file &lt;file&gt;.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="fun-stripHash"></a>6.6.6. <code class="literal">stripHash</code> &lt;path&gt;</h3></div></div></div><p>
      Strips the directory and hash part of a store path, outputting the name part to <code class="literal">stdout</code>. For example:
     </p><pre class="programlisting">
# prints coreutils-8.24
stripHash "/nix/store/9s9r019176g7cvn2nvcw41gsp862y6b4-coreutils-8.24"
</pre><p>
      If you wish to store the result in another variable, then the following idiom may be useful:
     </p><pre class="programlisting">
name="/nix/store/9s9r019176g7cvn2nvcw41gsp862y6b4-coreutils-8.24"
someVar=$(stripHash $name)
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="fun-wrapProgram"></a>6.6.7. <code class="literal">wrapProgram</code> &lt;executable&gt; &lt;makeWrapperArgs&gt;</h3></div></div></div><p>
      Convenience function for <code class="literal">makeWrapper</code> that automatically creates a sane wrapper file. It takes all the same arguments as <code class="literal">makeWrapper</code>, except for <code class="literal">--argv0</code>.
     </p><p>
      It cannot be applied multiple times, since it will overwrite the wrapper file.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ssec-setup-hooks"></a>6.7. Package setup hooks</h2></div></div></div><p>
     Nix itself considers a build-time dependency as merely something that should previously be built and accessible at build time—packages themselves are on their own to perform any additional setup. In most cases, that is fine, and the downstream derivation can deal with its own dependencies. But for a few common tasks, that would result in almost every package doing the same sort of setup work—depending not on the package itself, but entirely on which dependencies were used.
    </p><p>
     In order to alleviate this burden, the setup hook mechanism was written, where any package can include a shell script that [by convention rather than enforcement by Nix], any downstream reverse-dependency will source as part of its build process. That allows the downstream dependency to merely specify its dependencies, and lets those dependencies effectively initialize themselves. No boilerplate mirroring the list of dependencies is needed.
    </p><p>
     The setup hook mechanism is a bit of a sledgehammer though: a powerful feature with a broad and indiscriminate area of effect. The combination of its power and implicit use may be expedient, but isn’t without costs. Nix itself is unchanged, but the spirit of added dependencies being effect-free is violated even if the letter isn’t. For example, if a derivation path is mentioned more than once, Nix itself doesn’t care and simply makes sure the dependency derivation is already built just the same—depending is just needing something to exist, and needing is idempotent. However, a dependency specified twice will have its setup hook run twice, and that could easily change the build environment (though a well-written setup hook will therefore strive to be idempotent so this is in fact not observable). More broadly, setup hooks are anti-modular in that multiple dependencies, whether the same or different, should not interfere and yet their setup hooks may well do so.
    </p><p>
     The most typical use of the setup hook is actually to add other hooks which are then run (i.e. after all the setup hooks) on each dependency. For example, the C compiler wrapper’s setup hook feeds itself flags for each dependency that contains relevant libraries and headers. This is done by defining a bash function, and appending its name to one of <code class="literal">envBuildBuildHooks</code>, <code class="literal">envBuildHostHooks</code>, <code class="literal">envBuildTargetHooks</code>, <code class="literal">envHostHostHooks</code>, <code class="literal">envHostTargetHooks</code>, or <code class="literal">envTargetTargetHooks</code>. These 6 bash variables correspond to the 6 sorts of dependencies by platform (there’s 12 total but we ignore the propagated/non-propagated axis).
    </p><p>
     Packages adding a hook should not hard code a specific hook, but rather choose a variable <span class="emphasis"><em>relative</em></span> to how they are included. Returning to the C compiler wrapper example, if the wrapper itself is an <code class="literal">n</code> dependency, then it only wants to accumulate flags from <code class="literal">n + 1</code> dependencies, as only those ones match the compiler’s target platform. The <code class="literal">hostOffset</code> variable is defined with the current dependency’s host offset <code class="literal">targetOffset</code> with its target offset, before its setup hook is sourced. Additionally, since most environment hooks don’t care about the target platform, that means the setup hook can append to the right bash array by doing something like
    </p><pre class="programlisting">
addEnvHooks "$hostOffset" myBashFunction
</pre><p>
     The <span class="emphasis"><em>existence</em></span> of setups hooks has long been documented and packages inside Nixpkgs are free to use this mechanism. Other packages, however, should not rely on these mechanisms not changing between Nixpkgs versions. Because of the existing issues with this system, there’s little benefit from mandating it be stable for any period of time.
    </p><p>
     First, let’s cover some setup hooks that are part of Nixpkgs default stdenv. This means that they are run for every package built using <code class="literal">stdenv.mkDerivation</code>. Some of these are platform specific, so they may run on Linux but not Darwin or vice-versa.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="move-docs.sh"></a>6.7.1. <code class="literal">move-docs.sh</code></h3></div></div></div><p>
      This setup hook moves any installed documentation to the <code class="literal">/share</code> subdirectory directory. This includes the man, doc and info directories. This is needed for legacy programs that do not know how to use the <code class="literal">share</code> subdirectory.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="compress-man-pages.sh"></a>6.7.2. <code class="literal">compress-man-pages.sh</code></h3></div></div></div><p>
      This setup hook compresses any man pages that have been installed. The compression is done using the gzip program. This helps to reduce the installed size of packages.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="strip.sh"></a>6.7.3. <code class="literal">strip.sh</code></h3></div></div></div><p>
      This runs the strip command on installed binaries and libraries. This removes unnecessary information like debug symbols when they are not needed. This also helps to reduce the installed size of packages.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="patch-shebangs.sh"></a>6.7.4. <code class="literal">patch-shebangs.sh</code></h3></div></div></div><p>
      This setup hook patches installed scripts to use the full path to the shebang interpreter. A shebang interpreter is the first commented line of a script telling the operating system which program will run the script (e.g <code class="literal">#!/bin/bash</code>). In Nix, we want an exact path to that interpreter to be used. This often replaces <code class="literal">/bin/sh</code> with a path in the Nix store.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="audit-tmpdir.sh"></a>6.7.5. <code class="literal">audit-tmpdir.sh</code></h3></div></div></div><p>
      This verifies that no references are left from the install binaries to the directory used to build those binaries. This ensures that the binaries do not need things outside the Nix store. This is currently supported in Linux only.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="multiple-outputs.sh"></a>6.7.6. <code class="literal">multiple-outputs.sh</code></h3></div></div></div><p>
      This setup hook adds configure flags that tell packages to install files into any one of the proper outputs listed in <code class="literal">outputs</code>. This behavior can be turned off by setting <code class="literal">setOutputFlags</code> to false in the derivation environment. See <a class="xref" href="#chap-multiple-output" title="Chapter 8. Multiple-output packages">Chapter 8, <em>Multiple-output packages</em></a> for more information.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="move-sbin.sh"></a>6.7.7. <code class="literal">move-sbin.sh</code></h3></div></div></div><p>
      This setup hook moves any binaries installed in the <code class="literal">sbin/</code> subdirectory into <code class="literal">bin/</code>. In addition, a link is provided from <code class="literal">sbin/</code> to <code class="literal">bin/</code> for compatibility.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="move-lib64.sh"></a>6.7.8. <code class="literal">move-lib64.sh</code></h3></div></div></div><p>
      This setup hook moves any libraries installed in the <code class="literal">lib64/</code> subdirectory into <code class="literal">lib/</code>. In addition, a link is provided from <code class="literal">lib64/</code> to <code class="literal">lib/</code> for compatibility.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="move-systemd-user-units.sh"></a>6.7.9. <code class="literal">move-systemd-user-units.sh</code></h3></div></div></div><p>
      This setup hook moves any systemd user units installed in the <code class="literal">lib/</code> subdirectory into <code class="literal">share/</code>. In addition, a link is provided from <code class="literal">share/</code> to <code class="literal">lib/</code> for compatibility. This is needed for systemd to find user services when installed into the user profile.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="set-source-date-epoch-to-latest.sh"></a>6.7.10. <code class="literal">set-source-date-epoch-to-latest.sh</code></h3></div></div></div><p>
      This sets <code class="literal">SOURCE_DATE_EPOCH</code> to the modification time of the most recent file.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="bintools-wrapper"></a>6.7.11. Bintools Wrapper</h3></div></div></div><p>
      The Bintools Wrapper wraps the binary utilities for a bunch of miscellaneous purposes. These are GNU Binutils when targetting Linux, and a mix of cctools and GNU binutils for Darwin. [The <span class="quote">“<span class="quote">Bintools</span>”</span> name is supposed to be a compromise between <span class="quote">“<span class="quote">Binutils</span>”</span> and <span class="quote">“<span class="quote">cctools</span>”</span> not denoting any specific implementation.] Specifically, the underlying bintools package, and a C standard library (glibc or Darwin’s libSystem, just for the dynamic loader) are all fed in, and dependency finding, hardening (see below), and purity checks for each are handled by the Bintools Wrapper. Packages typically depend on CC Wrapper, which in turn (at run time) depends on the Bintools Wrapper.
     </p><p>
      The Bintools Wrapper was only just recently split off from CC Wrapper, so the division of labor is still being worked out. For example, it shouldn’t care about the C standard library, but just take a derivation with the dynamic loader (which happens to be the glibc on linux). Dependency finding however is a task both wrappers will continue to need to share, and probably the most important to understand. It is currently accomplished by collecting directories of host-platform dependencies (i.e. <code class="literal">buildInputs</code> and <code class="literal">nativeBuildInputs</code>) in environment variables. The Bintools Wrapper’s setup hook causes any <code class="literal">lib</code> and <code class="literal">lib64</code> subdirectories to be added to <code class="literal">NIX_LDFLAGS</code>. Since the CC Wrapper and the Bintools Wrapper use the same strategy, most of the Bintools Wrapper code is sparsely commented and refers to the CC Wrapper. But the CC Wrapper’s code, by contrast, has quite lengthy comments. The Bintools Wrapper merely cites those, rather than repeating them, to avoid falling out of sync.
     </p><p>
      A final task of the setup hook is defining a number of standard environment variables to tell build systems which executables fulfill which purpose. They are defined to just be the base name of the tools, under the assumption that the Bintools Wrapper’s binaries will be on the path. Firstly, this helps poorly-written packages, e.g. ones that look for just <code class="literal">gcc</code> when <code class="literal">CC</code> isn’t defined yet <code class="literal">clang</code> is to be used. Secondly, this helps packages not get confused when cross-compiling, in which case multiple Bintools Wrappers may simultaneously be in use.
      <a href="#ftn.idm140737322705648" class="footnote" id="idm140737322705648"><sup class="footnote">[6]</sup></a>
      <code class="literal">BUILD_</code>- and <code class="literal">TARGET_</code>-prefixed versions of the normal environment variable are defined for additional Bintools Wrappers, properly disambiguating them.
     </p><p>
      A problem with this final task is that the Bintools Wrapper is honest and defines <code class="literal">LD</code> as <code class="literal">ld</code>. Most packages, however, firstly use the C compiler for linking, secondly use <code class="literal">LD</code> anyways, defining it as the C compiler, and thirdly, only so define <code class="literal">LD</code> when it is undefined as a fallback. This triple-threat means Bintools Wrapper will break those packages, as LD is already defined as the actual linker which the package won’t override yet doesn’t want to use. The workaround is to define, just for the problematic package, <code class="literal">LD</code> as the C compiler. A good way to do this would be <code class="literal">preConfigure = "LD=$CC"</code>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="cc-wrapper"></a>6.7.12. CC Wrapper</h3></div></div></div><p>
      The CC Wrapper wraps a C toolchain for a bunch of miscellaneous purposes. Specifically, a C compiler (GCC or Clang), wrapped binary tools, and a C standard library (glibc or Darwin’s libSystem, just for the dynamic loader) are all fed in, and dependency finding, hardening (see below), and purity checks for each are handled by the CC Wrapper. Packages typically depend on the CC Wrapper, which in turn (at run-time) depends on the Bintools Wrapper.
     </p><p>
      Dependency finding is undoubtedly the main task of the CC Wrapper. This works just like the Bintools Wrapper, except that any <code class="literal">include</code> subdirectory of any relevant dependency is added to <code class="literal">NIX_CFLAGS_COMPILE</code>. The setup hook itself contains some lengthy comments describing the exact convoluted mechanism by which this is accomplished.
     </p><p>
      Similarly, the CC Wrapper follows the Bintools Wrapper in defining standard environment variables with the names of the tools it wraps, for the same reasons described above. Importantly, while it includes a <code class="literal">cc</code> symlink to the c compiler for portability, the <code class="literal">CC</code> will be defined using the compiler’s <span class="quote">“<span class="quote">real name</span>”</span> (i.e. <code class="literal">gcc</code> or <code class="literal">clang</code>). This helps lousy build systems that inspect on the name of the compiler rather than run it.
     </p><p>
      Here are some more packages that provide a setup hook. Since the list of hooks is extensible, this is not an exhaustive list. The mechanism is only to be used as a last resort, so it might cover most uses.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setup-hook-perl"></a>6.7.13. Perl</h3></div></div></div><p>
      Adds the <code class="literal">lib/site_perl</code> subdirectory of each build input to the <code class="literal">PERL5LIB</code> environment variable. For instance, if <code class="literal">buildInputs</code> contains Perl, then the <code class="literal">lib/site_perl</code> subdirectory of each input is added to the <code class="literal">PERL5LIB</code> environment variable.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setup-hook-python"></a>6.7.14. Python</h3></div></div></div><p>
      Adds the <code class="literal">lib/${python.libPrefix}/site-packages</code> subdirectory of each build input to the <code class="literal">PYTHONPATH</code> environment variable.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setup-hook-pkg-config"></a>6.7.15. pkg-config</h3></div></div></div><p>
      Adds the <code class="literal">lib/pkgconfig</code> and <code class="literal">share/pkgconfig</code> subdirectories of each build input to the <code class="literal">PKG_CONFIG_PATH</code> environment variable.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setup-hook-automake"></a>6.7.16. Automake</h3></div></div></div><p>
      Adds the <code class="literal">share/aclocal</code> subdirectory of each build input to the <code class="literal">ACLOCAL_PATH</code> environment variable.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setup-hook-autoconf"></a>6.7.17. Autoconf</h3></div></div></div><p>
      The <code class="literal">autoreconfHook</code> derivation adds <code class="literal">autoreconfPhase</code>, which runs autoreconf, libtoolize and automake, essentially preparing the configure script in autotools-based builds. Most autotools-based packages come with the configure script pre-generated, but this hook is necessary for a few packages and when you need to patch the package’s configure scripts.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setup-hook-libxml2"></a>6.7.18. libxml2</h3></div></div></div><p>
      Adds every file named <code class="literal">catalog.xml</code> found under the <code class="literal">xml/dtd</code> and <code class="literal">xml/xsl</code> subdirectories of each build input to the <code class="literal">XML_CATALOG_FILES</code> environment variable.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="tetex-tex-live"></a>6.7.19. teTeX / TeX Live</h3></div></div></div><p>
      Adds the <code class="literal">share/texmf-nix</code> subdirectory of each build input to the <code class="literal">TEXINPUTS</code> environment variable.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="qt-4"></a>6.7.20. Qt 4</h3></div></div></div><p>
      Sets the <code class="literal">QTDIR</code> environment variable to Qt’s path.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setup-hook-gdk-pixbuf"></a>6.7.21. gdk-pixbuf</h3></div></div></div><p>
      Exports <code class="literal">GDK_PIXBUF_MODULE_FILE</code> environment variable to the builder. Add librsvg package to <code class="literal">buildInputs</code> to get svg support. See also the <a class="link" href="#ssec-gnome-hooks-gdk-pixbuf">setup hook description in GNOME platform docs</a>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ghc"></a>6.7.22. GHC</h3></div></div></div><p>
      Creates a temporary package database and registers every Haskell build input in it (TODO: how?).
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="gnome-platform"></a>6.7.23. GNOME platform</h3></div></div></div><p>
      Hooks related to GNOME platform and related libraries like GLib, GTK and GStreamer are described in <a class="xref" href="#sec-language-gnome" title="15.9. GNOME">Section 15.9, “GNOME”</a>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setup-hook-autopatchelfhook"></a>6.7.24. autoPatchelfHook</h3></div></div></div><p>
      This is a special setup hook which helps in packaging proprietary software in that it automatically tries to find missing shared library dependencies of ELF files based on the given <code class="literal">buildInputs</code> and <code class="literal">nativeBuildInputs</code>.
     </p><p>
      You can also specify a <code class="literal">runtimeDependencies</code> variable which lists dependencies to be unconditionally added to rpath of all executables. This is useful for programs that use dlopen 3 to load libraries at runtime.
     </p><p>
      In certain situations you may want to run the main command (<code class="literal">autoPatchelf</code>) of the setup hook on a file or a set of directories instead of unconditionally patching all outputs. This can be done by setting the <code class="literal">dontAutoPatchelf</code> environment variable to a non-empty value.
     </p><p>
      By default <code class="literal">autoPatchelf</code> will fail as soon as any ELF file requires a dependency which cannot be resolved via the given build inputs. In some situations you might prefer to just leave missing dependencies unpatched and continue to patch the rest. This can be achieved by setting the <code class="literal">autoPatchelfIgnoreMissingDeps</code> environment variable to a non-empty value.
     </p><p>
      The <code class="literal">autoPatchelf</code> command also recognizes a <code class="literal">--no-recurse</code> command line flag, which prevents it from recursing into subdirectories.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="breakpointhook"></a>6.7.25. breakpointHook</h3></div></div></div><p>
      This hook will make a build pause instead of stopping when a failure happens. It prevents nix from cleaning up the build environment immediately and allows the user to attach to a build environment using the <code class="literal">cntr</code> command. Upon build error it will print instructions on how to use <code class="literal">cntr</code>, which can be used to enter the environment for debugging. Installing cntr and running the command will provide shell access to the build sandbox of failed build. At <code class="literal">/var/lib/cntr</code> the sandboxed filesystem is mounted. All commands and files of the system are still accessible within the shell. To execute commands from the sandbox use the cntr exec subcommand. <code class="literal">cntr</code> is only supported on Linux-based platforms. To use it first add <code class="literal">cntr</code> to your <code class="literal">environment.systemPackages</code> on NixOS or alternatively to the root user on non-NixOS systems. Then in the package that is supposed to be inspected, add <code class="literal">breakpointHook</code> to <code class="literal">nativeBuildInputs</code>.
     </p><pre class="programlisting">
nativeBuildInputs = [ breakpointHook ];
</pre><p>
      When a build failure happens there will be an instruction printed that shows how to attach with <code class="literal">cntr</code> to the build sandbox.
     </p><div class="note"><h3 class="title">Caution with remote builds</h3><p>
       This won’t work with remote builds as the build environment is on a different machine and can’t be accessed by <code class="literal">cntr</code>. Remote builds can be turned off by setting <code class="literal">--option builders ''</code> for <code class="literal">nix-build</code> or <code class="literal">--builders ''</code> for <code class="literal">nix build</code>.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="installshellfiles"></a>6.7.26. installShellFiles</h3></div></div></div><p>
      This hook helps with installing manpages and shell completion files. It exposes 2 shell functions <code class="literal">installManPage</code> and <code class="literal">installShellCompletion</code> that can be used from your <code class="literal">postInstall</code> hook.
     </p><p>
      The <code class="literal">installManPage</code> function takes one or more paths to manpages to install. The manpages must have a section suffix, and may optionally be compressed (with <code class="literal">.gz</code> suffix). This function will place them into the correct directory.
     </p><p>
      The <code class="literal">installShellCompletion</code> function takes one or more paths to shell completion files. By default it will autodetect the shell type from the completion file extension, but you may also specify it by passing one of <code class="literal">--bash</code>, <code class="literal">--fish</code>, or <code class="literal">--zsh</code>. These flags apply to all paths listed after them (up until another shell flag is given). Each path may also have a custom installation name provided by providing a flag <code class="literal">--name NAME</code> before the path. If this flag is not provided, zsh completions will be renamed automatically such that <code class="literal">foobar.zsh</code> becomes <code class="literal">_foobar</code>. A root name may be provided for all paths using the flag <code class="literal">--cmd NAME</code>; this synthesizes the appropriate name depending on the shell (e.g. <code class="literal">--cmd foo</code> will synthesize the name <code class="literal">foo.bash</code> for bash and <code class="literal">_foo</code> for zsh). The path may also be a fifo or named fd (such as produced by <code class="literal">&lt;(cmd)</code>), in which case the shell and name must be provided.
     </p><pre class="programlisting">
nativeBuildInputs = [ installShellFiles ];
postInstall = ''
  installManPage doc/foobar.1 doc/barfoo.3
  # explicit behavior
  installShellCompletion --bash --name foobar.bash share/completions.bash
  installShellCompletion --fish --name foobar.fish share/completions.fish
  installShellCompletion --zsh --name _foobar share/completions.zsh
  # implicit behavior
  installShellCompletion share/completions/foobar.{bash,fish,zsh}
  # using named fd
  installShellCompletion --cmd foobar \
    --bash &lt;($out/bin/foobar --bash-completion) \
    --fish &lt;($out/bin/foobar --fish-completion) \
    --zsh &lt;($out/bin/foobar --zsh-completion)
'';
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="libiconv-libintl"></a>6.7.27. libiconv, libintl</h3></div></div></div><p>
      A few libraries automatically add to <code class="literal">NIX_LDFLAGS</code> their library, making their symbols automatically available to the linker. This includes libiconv and libintl (gettext). This is done to provide compatibility between GNU Linux, where libiconv and libintl are bundled in, and other systems where that might not be the case. Sometimes, this behavior is not desired. To disable this behavior, set <code class="literal">dontAddExtraLibs</code>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="validatepkgconfig"></a>6.7.28. validatePkgConfig</h3></div></div></div><p>
      The <code class="literal">validatePkgConfig</code> hook validates all pkg-config (<code class="literal">.pc</code>) files in a package. This helps catching some common errors in pkg-config files, such as undefined variables.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="cmake"></a>6.7.29. cmake</h3></div></div></div><p>
      Overrides the default configure phase to run the CMake command. By default, we use the Make generator of CMake. In addition, dependencies are added automatically to CMAKE_PREFIX_PATH so that packages are correctly detected by CMake. Some additional flags are passed in to give similar behavior to configure-based packages. You can disable this hook’s behavior by setting configurePhase to a custom value, or by setting dontUseCmakeConfigure. cmakeFlags controls flags passed only to CMake. By default, parallel building is enabled as CMake supports parallel building almost everywhere. When Ninja is also in use, CMake will detect that and use the ninja generator.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="xcbuildhook"></a>6.7.30. xcbuildHook</h3></div></div></div><p>
      Overrides the build and install phases to run the <span class="quote">“<span class="quote">xcbuild</span>”</span> command. This hook is needed when a project only comes with build files for the XCode build system. You can disable this behavior by setting buildPhase and configurePhase to a custom value. xcbuildFlags controls flags passed only to xcbuild.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="meson"></a>6.7.31. Meson</h3></div></div></div><p>
      Overrides the configure phase to run meson to generate Ninja files. To run these files, you should accompany Meson with ninja. By default, <code class="literal">enableParallelBuilding</code> is enabled as Meson supports parallel building almost everywhere.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="variables-controlling-meson"></a>6.7.31.1. Variables controlling Meson</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="mesonflags"></a>6.7.31.1.1. <code class="literal">mesonFlags</code></h5></div></div></div><p>
        Controls the flags passed to meson.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="mesonbuildtype"></a>6.7.31.1.2. <code class="literal">mesonBuildType</code></h5></div></div></div><p>
        Which <a class="link" href="https://mesonbuild.com/Builtin-options.html#core-options" target="_top"><code class="literal">--buildtype</code></a> to pass to Meson. We default to <code class="literal">plain</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="mesonautofeatures"></a>6.7.31.1.3. <code class="literal">mesonAutoFeatures</code></h5></div></div></div><p>
        What value to set <a class="link" href="https://mesonbuild.com/Builtin-options.html#core-options" target="_top"><code class="literal">-Dauto_features=</code></a> to. We default to <code class="literal">enabled</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="mesonwrapmode"></a>6.7.31.1.4. <code class="literal">mesonWrapMode</code></h5></div></div></div><p>
        What value to set <a class="link" href="https://mesonbuild.com/Builtin-options.html#core-options" target="_top"><code class="literal">-Dwrap_mode=</code></a> to. We default to <code class="literal">nodownload</code> as we disallow network access.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="dontusemesonconfigure"></a>6.7.31.1.5. <code class="literal">dontUseMesonConfigure</code></h5></div></div></div><p>
        Disables using Meson’s <code class="literal">configurePhase</code>.
       </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ninja"></a>6.7.32. ninja</h3></div></div></div><p>
      Overrides the build, install, and check phase to run ninja instead of make. You can disable this behavior with the <code class="literal">dontUseNinjaBuild</code>, <code class="literal">dontUseNinjaInstall</code>, and <code class="literal">dontUseNinjaCheck</code>, respectively. Parallel building is enabled by default in Ninja.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="unzip"></a>6.7.33. unzip</h3></div></div></div><p>
      This setup hook will allow you to unzip .zip files specified in <code class="literal">$src</code>. There are many similar packages like <code class="literal">unrar</code>, <code class="literal">undmg</code>, etc.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="wafhook"></a>6.7.34. wafHook</h3></div></div></div><p>
      Overrides the configure, build, and install phases. This will run the <span class="quote">“<span class="quote">waf</span>”</span> script used by many projects. If <code class="literal">wafPath</code> (default <code class="literal">./waf</code>) doesn’t exist, it will copy the version of waf available in Nixpkgs. <code class="literal">wafFlags</code> can be used to pass flags to the waf script.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="scons"></a>6.7.35. scons</h3></div></div></div><p>
      Overrides the build, install, and check phases. This uses the scons build system as a replacement for make. scons does not provide a configure phase, so everything is managed at build and install time.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-purity-in-nixpkgs"></a>6.8. Purity in Nixpkgs</h2></div></div></div><p>
     <span class="emphasis"><em>Measures taken to prevent dependencies on packages outside the store, and what you can do to prevent them.</em></span>
    </p><p>
     GCC doesn’t search in locations such as <code class="literal">/usr/include</code>. In fact, attempts to add such directories through the <code class="literal">-I</code> flag are filtered out. Likewise, the linker (from GNU binutils) doesn’t search in standard locations such as <code class="literal">/usr/lib</code>. Programs built on Linux are linked against a GNU C Library that likewise doesn’t search in the default system locations.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-hardening-in-nixpkgs"></a>6.9. Hardening in Nixpkgs</h2></div></div></div><p>
     There are flags available to harden packages at compile or link-time. These can be toggled using the <code class="literal">stdenv.mkDerivation</code> parameters <code class="literal">hardeningDisable</code> and <code class="literal">hardeningEnable</code>.
    </p><p>
     Both parameters take a list of flags as strings. The special <code class="literal">"all"</code> flag can be passed to <code class="literal">hardeningDisable</code> to turn off all hardening. These flags can also be used as environment variables for testing or development purposes.
    </p><p>
     The following flags are enabled by default and might require disabling with <code class="literal">hardeningDisable</code> if the program to package is incompatible.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="format"></a>6.9.1. <code class="literal">format</code></h3></div></div></div><p>
      Adds the <code class="literal">-Wformat -Wformat-security -Werror=format-security</code> compiler options. At present, this warns about calls to <code class="literal">printf</code> and <code class="literal">scanf</code> functions where the format string is not a string literal and there are no format arguments, as in <code class="literal">printf(foo);</code>. This may be a security hole if the format string came from untrusted input and contains <code class="literal">%n</code>.
     </p><p>
      This needs to be turned off or fixed for errors similar to:
     </p><pre class="programlisting">
/tmp/nix-build-zynaddsubfx-2.5.2.drv-0/zynaddsubfx-2.5.2/src/UI/guimain.cpp:571:28: error: format not a string literal and no format arguments [-Werror=format-security]
         printf(help_message);
                            ^
cc1plus: some warnings being treated as errors
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="stackprotector"></a>6.9.2. <code class="literal">stackprotector</code></h3></div></div></div><p>
      Adds the <code class="literal">-fstack-protector-strong --param ssp-buffer-size=4</code> compiler options. This adds safety checks against stack overwrites rendering many potential code injection attacks into aborting situations. In the best case this turns code injection vulnerabilities into denial of service or into non-issues (depending on the application).
     </p><p>
      This needs to be turned off or fixed for errors similar to:
     </p><pre class="programlisting">
bin/blib.a(bios_console.o): In function `bios_handle_cup':
/tmp/nix-build-ipxe-20141124-5cbdc41.drv-0/ipxe-5cbdc41/src/arch/i386/firmware/pcbios/bios_console.c:86: undefined reference to `__stack_chk_fail'
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="fortify"></a>6.9.3. <code class="literal">fortify</code></h3></div></div></div><p>
      Adds the <code class="literal">-O2 -D_FORTIFY_SOURCE=2</code> compiler options. During code generation the compiler knows a great deal of information about buffer sizes (where possible), and attempts to replace insecure unlimited length buffer function calls with length-limited ones. This is especially useful for old, crufty code. Additionally, format strings in writable memory that contain <code class="literal">%n</code> are blocked. If an application depends on such a format string, it will need to be worked around.
     </p><p>
      Additionally, some warnings are enabled which might trigger build failures if compiler warnings are treated as errors in the package build. In this case, set <code class="literal">NIX_CFLAGS_COMPILE</code> to <code class="literal">-Wno-error=warning-type</code>.
     </p><p>
      This needs to be turned off or fixed for errors similar to:
     </p><pre class="programlisting">
malloc.c:404:15: error: return type is an incomplete type
malloc.c:410:19: error: storage size of 'ms' isn't known

strdup.h:22:1: error: expected identifier or '(' before '__extension__'

strsep.c:65:23: error: register name not specified for 'delim'

installwatch.c:3751:5: error: conflicting types for '__open_2'

fcntl2.h:50:4: error: call to '__open_missing_mode' declared with attribute error: open with O_CREAT or O_TMPFILE in second argument needs 3 arguments
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="pic"></a>6.9.4. <code class="literal">pic</code></h3></div></div></div><p>
      Adds the <code class="literal">-fPIC</code> compiler options. This options adds support for position independent code in shared libraries and thus making ASLR possible.
     </p><p>
      Most notably, the Linux kernel, kernel modules and other code not running in an operating system environment like boot loaders won’t build with PIC enabled. The compiler will is most cases complain that PIC is not supported for a specific build.
     </p><p>
      This needs to be turned off or fixed for assembler errors similar to:
     </p><pre class="programlisting">
ccbLfRgg.s: Assembler messages:
ccbLfRgg.s:33: Error: missing or invalid displacement expression `private_key_len@GOTOFF'
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="strictoverflow"></a>6.9.5. <code class="literal">strictoverflow</code></h3></div></div></div><p>
      Signed integer overflow is undefined behaviour according to the C standard. If it happens, it is an error in the program as it should check for overflow before it can happen, not afterwards. GCC provides built-in functions to perform arithmetic with overflow checking, which are correct and faster than any custom implementation. As a workaround, the option <code class="literal">-fno-strict-overflow</code> makes gcc behave as if signed integer overflows were defined.
     </p><p>
      This flag should not trigger any build or runtime errors.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="relro"></a>6.9.6. <code class="literal">relro</code></h3></div></div></div><p>
      Adds the <code class="literal">-z relro</code> linker option. During program load, several ELF memory sections need to be written to by the linker, but can be turned read-only before turning over control to the program. This prevents some GOT (and .dtors) overwrite attacks, but at least the part of the GOT used by the dynamic linker (.got.plt) is still vulnerable.
     </p><p>
      This flag can break dynamic shared object loading. For instance, the module systems of Xorg and OpenCV are incompatible with this flag. In almost all cases the <code class="literal">bindnow</code> flag must also be disabled and incompatible programs typically fail with similar errors at runtime.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="bindnow"></a>6.9.7. <code class="literal">bindnow</code></h3></div></div></div><p>
      Adds the <code class="literal">-z bindnow</code> linker option. During program load, all dynamic symbols are resolved, allowing for the complete GOT to be marked read-only (due to <code class="literal">relro</code>). This prevents GOT overwrite attacks. For very large applications, this can incur some performance loss during initial load while symbols are resolved, but this shouldn’t be an issue for daemons.
     </p><p>
      This flag can break dynamic shared object loading. For instance, the module systems of Xorg and PHP are incompatible with this flag. Programs incompatible with this flag often fail at runtime due to missing symbols, like:
     </p><pre class="programlisting">
intel_drv.so: undefined symbol: vgaHWFreeHWRec
</pre><p>
      The following flags are disabled by default and should be enabled with <code class="literal">hardeningEnable</code> for packages that take untrusted input like network services.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="pie"></a>6.9.8. <code class="literal">pie</code></h3></div></div></div><p>
      Adds the <code class="literal">-fPIE</code> compiler and <code class="literal">-pie</code> linker options. Position Independent Executables are needed to take advantage of Address Space Layout Randomization, supported by modern kernel versions. While ASLR can already be enforced for data areas in the stack and heap (brk and mmap), the code areas must be compiled as position-independent. Shared libraries already do this with the <code class="literal">pic</code> flag, so they gain ASLR automatically, but binary .text regions need to be build with <code class="literal">pie</code> to gain ASLR. When this happens, ROP attacks are much harder since there are no static locations to bounce off of during a memory corruption attack.
     </p><p>
      For more in-depth information on these hardening flags and hardening in general, refer to the <a class="link" href="https://wiki.debian.org/Hardening" target="_top">Debian Wiki</a>, <a class="link" href="https://wiki.ubuntu.com/Security/Features" target="_top">Ubuntu Wiki</a>, <a class="link" href="https://wiki.gentoo.org/wiki/Project:Hardened" target="_top">Gentoo Wiki</a>, and the <a class="link" href="https://wiki.archlinux.org/index.php/DeveloperWiki:Security" target="_top">Arch Wiki</a>.
     </p></div></div><div class="footnotes"><br /><hr style="width:100; text-align:left;margin-left: 0" /><div id="ftn.idm140737320465264" class="footnote"><p><a href="#idm140737320465264" class="para"><sup class="para">[1] </sup></a>
       The build platform is ignored because it is a mere implementation detail of the package satisfying the dependency: As a general programming principle, dependencies are always <span class="emphasis"><em>specified</em></span> as interfaces, not concrete implementation.
      </p></div><div id="ftn.idm140737320461792" class="footnote"><p><a href="#idm140737320461792" class="para"><sup class="para">[2] </sup></a>
       Currently, this means for native builds all dependencies are put on the <code class="literal">PATH</code>. But in the future that may not be the case for sake of matching cross: the platforms would be assumed to be unique for native and cross builds alike, so only the <code class="literal">depsBuild*</code> and <code class="literal">nativeBuildInputs</code> would be added to the <code class="literal">PATH</code>.
      </p></div><div id="ftn.idm140737320453408" class="footnote"><p><a href="#idm140737320453408" class="para"><sup class="para">[3] </sup></a>
       The <code class="literal">findInputs</code> function, currently residing in <code class="literal">pkgs/stdenv/generic/setup.sh</code>, implements the propagation logic.
      </p></div><div id="ftn.idm140737320246752" class="footnote"><p><a href="#idm140737320246752" class="para"><sup class="para">[4] </sup></a>
          It clears the <code class="literal">sys_lib_*search_path</code> variables in the Libtool script to prevent Libtool from using libraries in <code class="literal">/usr/lib</code> and such.
         </p></div><div id="ftn.idm140737320238384" class="footnote"><p><a href="#idm140737320238384" class="para"><sup class="para">[5] </sup></a>
          Eventually these will be passed building natively as well, to improve determinism: build-time guessing, as is done today, is a risk of impurity.
         </p></div><div id="ftn.idm140737322705648" class="footnote"><p><a href="#idm140737322705648" class="para"><sup class="para">[6] </sup></a>
        Each wrapper targets a single platform, so if binaries for multiple platforms are needed, the underlying binaries must be wrapped multiple times. As this is a property of the wrapper itself, the multiple wrappings are needed whether or not the same underlying binaries can target multiple platforms.
       </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-meta"></a>Chapter 7. Meta-attributes</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-standard-meta-attributes">7.1. Standard meta-attributes</a></span></dt><dt><span class="section"><a href="#sec-meta-license">7.2. Licenses</a></span></dt></dl></div><p>
    Nix packages can declare <span class="emphasis"><em>meta-attributes</em></span> that contain information about a package such as a description, its homepage, its license, and so on. For instance, the GNU Hello package has a <code class="literal">meta</code> declaration like this:
   </p><pre class="programlisting">
meta = with lib; {
  description = "A program that produces a familiar, friendly greeting";
  longDescription = ''
    GNU Hello is a program that prints "Hello, world!" when you run it.
    It is fully customizable.
  '';
  homepage = "https://www.gnu.org/software/hello/manual/";
  license = licenses.gpl3Plus;
  maintainers = [ maintainers.eelco ];
  platforms = platforms.all;
};
</pre><p>
    Meta-attributes are not passed to the builder of the package. Thus, a change to a meta-attribute doesn’t trigger a recompilation of the package. The value of a meta-attribute must be a string.
   </p><p>
    The meta-attributes of a package can be queried from the command-line using <code class="literal">nix-env</code>:
   </p><pre class="programlisting">
$ nix-env -qa hello --json
{
    "hello": {
        "meta": {
            "description": "A program that produces a familiar, friendly greeting",
            "homepage": "https://www.gnu.org/software/hello/manual/",
            "license": {
                "fullName": "GNU General Public License version 3 or later",
                "shortName": "GPLv3+",
                "url": "http://www.fsf.org/licensing/licenses/gpl.html"
            },
            "longDescription": "GNU Hello is a program that prints \"Hello, world!\" when you run it.\nIt is fully customizable.\n",
            "maintainers": [
                "Ludovic Court\u00e8s &lt;ludo@gnu.org&gt;"
            ],
            "platforms": [
                "i686-linux",
                "x86_64-linux",
                "armv5tel-linux",
                "armv7l-linux",
                "mips32-linux",
                "x86_64-darwin",
                "i686-cygwin",
                "i686-freebsd",
                "x86_64-freebsd",
                "i686-openbsd",
                "x86_64-openbsd"
            ],
            "position": "/home/user/dev/nixpkgs/pkgs/applications/misc/hello/default.nix:14"
        },
        "name": "hello-2.9",
        "system": "x86_64-linux"
    }
}
</pre><p>
    <code class="literal">nix-env</code> knows about the <code class="literal">description</code> field specifically:
   </p><pre class="programlisting">
$ nix-env -qa hello --description
hello-2.3  A program that produces a familiar, friendly greeting
</pre><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-standard-meta-attributes"></a>7.1. Standard meta-attributes</h2></div></div></div><p>
     It is expected that each meta-attribute is one of the following:
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-description"></a>7.1.1. <code class="literal">description</code></h3></div></div></div><p>
      A short (one-line) description of the package. This is shown by <code class="literal">nix-env -q --description</code> and also on the Nixpkgs release pages.
     </p><p>
      Don’t include a period at the end. Don’t include newline characters. Capitalise the first character. For brevity, don’t repeat the name of package — just describe what it does.
     </p><p>
      Wrong: <code class="literal">"libpng is a library that allows you to decode PNG images."</code>
     </p><p>
      Right: <code class="literal">"A library for decoding PNG images"</code>
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-longDescription"></a>7.1.2. <code class="literal">longDescription</code></h3></div></div></div><p>
      An arbitrarily long description of the package.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-branch"></a>7.1.3. <code class="literal">branch</code></h3></div></div></div><p>
      Release branch. Used to specify that a package is not going to receive updates that are not in this branch; for example, Linux kernel 3.0 is supposed to be updated to 3.0.X, not 3.1.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-homepage"></a>7.1.4. <code class="literal">homepage</code></h3></div></div></div><p>
      The package’s homepage. Example: <code class="literal">https://www.gnu.org/software/hello/manual/</code>
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-downloadPage"></a>7.1.5. <code class="literal">downloadPage</code></h3></div></div></div><p>
      The page where a link to the current version can be found. Example: <code class="literal">https://ftp.gnu.org/gnu/hello/</code>
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-changelog"></a>7.1.6. <code class="literal">changelog</code></h3></div></div></div><p>
      A link or a list of links to the location of Changelog for a package. A link may use expansion to refer to the correct changelog version. Example: <code class="literal">"https://git.savannah.gnu.org/cgit/hello.git/plain/NEWS?h=v${version}"</code>
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-license"></a>7.1.7. <code class="literal">license</code></h3></div></div></div><p>
      The license, or licenses, for the package. One from the attribute set defined in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/licenses.nix" target="_top"><code class="literal">nixpkgs/lib/licenses.nix</code></a>. At this moment using both a list of licenses and a single license is valid. If the license field is in the form of a list representation, then it means that parts of the package are licensed differently. Each license should preferably be referenced by their attribute. The non-list attribute value can also be a space delimited string representation of the contained attribute <code class="literal">shortNames</code> or <code class="literal">spdxIds</code>. The following are all valid examples:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        Single license referenced by attribute (preferred) <code class="literal">lib.licenses.gpl3Only</code>.
       </p></li><li class="listitem"><p>
        Single license referenced by its attribute shortName (frowned upon) <code class="literal">"gpl3Only"</code>.
       </p></li><li class="listitem"><p>
        Single license referenced by its attribute spdxId (frowned upon) <code class="literal">"GPL-3.0-only"</code>.
       </p></li><li class="listitem"><p>
        Multiple licenses referenced by attribute (preferred) <code class="literal">with lib.licenses; [ asl20 free ofl ]</code>.
       </p></li><li class="listitem"><p>
        Multiple licenses referenced as a space delimited string of attribute shortNames (frowned upon) <code class="literal">"asl20 free ofl"</code>.
       </p></li></ul></div><p>
      For details, see <a class="link" href="#sec-meta-license" title="7.2. Licenses">Licenses</a>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-maintainers"></a>7.1.8. <code class="literal">maintainers</code></h3></div></div></div><p>
      A list of the maintainers of this Nix expression. Maintainers are defined in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/maintainers/maintainer-list.nix" target="_top"><code class="literal">nixpkgs/maintainers/maintainer-list.nix</code></a>. There is no restriction to becoming a maintainer, just add yourself to that list in a separate commit titled <span class="quote">“<span class="quote">maintainers: add alice</span>”</span>, and reference maintainers with <code class="literal">maintainers = with lib.maintainers; [ alice bob ]</code>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-priority"></a>7.1.9. <code class="literal">priority</code></h3></div></div></div><p>
      The <span class="emphasis"><em>priority</em></span> of the package, used by <code class="literal">nix-env</code> to resolve file name conflicts between packages. See the Nix manual page for <code class="literal">nix-env</code> for details. Example: <code class="literal">"10"</code> (a low-priority package).
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-platforms"></a>7.1.10. <code class="literal">platforms</code></h3></div></div></div><p>
      The list of Nix platform types on which the package is supported. Hydra builds packages according to the platform specified. If no platform is specified, the package does not have prebuilt binaries. An example is:
     </p><pre class="programlisting">
meta.platforms = lib.platforms.linux;
</pre><p>
      Attribute Set <code class="literal">lib.platforms</code> defines <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/systems/doubles.nix" target="_top">various common lists</a> of platforms types.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-tests"></a>7.1.11. <code class="literal">tests</code></h3></div></div></div><div class="warning"><h3 class="title">Warning</h3><p>
       This attribute is special in that it is not actually under the <code class="literal">meta</code> attribute set but rather under the <code class="literal">passthru</code> attribute set. This is due to how <code class="literal">meta</code> attributes work, and the fact that they are supposed to contain only metadata, not derivations.
      </p></div><p>
      An attribute set with as values tests. A test is a derivation, which builds successfully when the test passes, and fails to build otherwise. A derivation that is a test needs to have <code class="literal">meta.timeout</code> defined.
     </p><p>
      The NixOS tests are available as <code class="literal">nixosTests</code> in parameters of derivations. For instance, the OpenSMTPD derivation includes lines similar to:
     </p><pre class="programlisting">
{ /* ... */, nixosTests }:
{
  # ...
  passthru.tests = {
    basic-functionality-and-dovecot-integration = nixosTests.opensmtpd;
  };
}
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-timeout"></a>7.1.12. <code class="literal">timeout</code></h3></div></div></div><p>
      A timeout (in seconds) for building the derivation. If the derivation takes longer than this time to build, it can fail due to breaking the timeout. However, all computers do not have the same computing power, hence some builders may decide to apply a multiplicative factor to this value. When filling this value in, try to keep it approximately consistent with other values already present in <code class="literal">nixpkgs</code>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-hydraPlatforms"></a>7.1.13. <code class="literal">hydraPlatforms</code></h3></div></div></div><p>
      The list of Nix platform types for which the Hydra instance at <code class="literal">hydra.nixos.org</code> will build the package. (Hydra is the Nix-based continuous build system.) It defaults to the value of <code class="literal">meta.platforms</code>. Thus, the only reason to set <code class="literal">meta.hydraPlatforms</code> is if you want <code class="literal">hydra.nixos.org</code> to build the package on a subset of <code class="literal">meta.platforms</code>, or not at all, e.g.
     </p><pre class="programlisting">
meta.platforms = lib.platforms.linux;
meta.hydraPlatforms = [];
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-broken"></a>7.1.14. <code class="literal">broken</code></h3></div></div></div><p>
      If set to <code class="literal">true</code>, the package is marked as <span class="quote">“<span class="quote">broken</span>”</span>, meaning that it won’t show up in <code class="literal">nix-env -qa</code>, and cannot be built or installed. Such packages should be removed from Nixpkgs eventually unless they are fixed.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="var-meta-updateWalker"></a>7.1.15. <code class="literal">updateWalker</code></h3></div></div></div><p>
      If set to <code class="literal">true</code>, the package is tested to be updated correctly by the <code class="literal">update-walker.sh</code> script without additional settings. Such packages have <code class="literal">meta.version</code> set and their homepage (or the page specified by <code class="literal">meta.downloadPage</code>) contains a direct link to the package tarball.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-meta-license"></a>7.2. Licenses</h2></div></div></div><p>
     The <code class="literal">meta.license</code> attribute should preferably contain a value from <code class="literal">lib.licenses</code> defined in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/lib/licenses.nix" target="_top"><code class="literal">nixpkgs/lib/licenses.nix</code></a>, or in-place license description of the same format if the license is unlikely to be useful in another expression.
    </p><p>
     Although it’s typically better to indicate the specific license, a few generic options are available:
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="lib.licenses.free-free"></a>7.2.1. <code class="literal">lib.licenses.free</code>, <code class="literal">"free"</code></h3></div></div></div><p>
      Catch-all for free software licenses not listed above.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="lib.licenses.unfreeredistributable-unfree-redistributable"></a>7.2.2. <code class="literal">lib.licenses.unfreeRedistributable</code>, <code class="literal">"unfree-redistributable"</code></h3></div></div></div><p>
      Unfree package that can be redistributed in binary form. That is, it’s legal to redistribute the <span class="emphasis"><em>output</em></span> of the derivation. This means that the package can be included in the Nixpkgs channel.
     </p><p>
      Sometimes proprietary software can only be redistributed unmodified. Make sure the builder doesn’t actually modify the original binaries; otherwise we’re breaking the license. For instance, the NVIDIA X11 drivers can be redistributed unmodified, but our builder applies <code class="literal">patchelf</code> to make them work. Thus, its license is <code class="literal">"unfree"</code> and it cannot be included in the Nixpkgs channel.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="lib.licenses.unfree-unfree"></a>7.2.3. <code class="literal">lib.licenses.unfree</code>, <code class="literal">"unfree"</code></h3></div></div></div><p>
      Unfree package that cannot be redistributed. You can build it yourself, but you cannot redistribute the output of the derivation. Thus it cannot be included in the Nixpkgs channel.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="lib.licenses.unfreeredistributablefirmware-unfree-redistributable-firmware"></a>7.2.4. <code class="literal">lib.licenses.unfreeRedistributableFirmware</code>, <code class="literal">"unfree-redistributable-firmware"</code></h3></div></div></div><p>
      This package supplies unfree, redistributable firmware. This is a separate value from <code class="literal">unfree-redistributable</code> because not everybody cares whether firmware is free.
     </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-multiple-output"></a>Chapter 8. Multiple-output packages</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-multiple-outputs-introduction">8.1. Introduction</a></span></dt><dt><span class="section"><a href="#sec-multiple-outputs-installing">8.2. Installing a split package</a></span></dt><dt><span class="section"><a href="#sec-multiple-outputs-using-split-packages">8.3. Using a split package</a></span></dt><dt><span class="section"><a href="#sec-multiple-outputs-">8.4. Writing a split derivation</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-multiple-outputs-introduction"></a>8.1. Introduction</h2></div></div></div><p>
     The Nix language allows a derivation to produce multiple outputs, which is similar to what is utilized by other Linux distribution packaging systems. The outputs reside in separate Nix store paths, so they can be mostly handled independently of each other, including passing to build inputs, garbage collection or binary substitution. The exception is that building from source always produces all the outputs.
    </p><p>
     The main motivation is to save disk space by reducing runtime closure sizes; consequently also sizes of substituted binaries get reduced. Splitting can be used to have more granular runtime dependencies, for example the typical reduction is to split away development-only files, as those are typically not needed during runtime. As a result, closure sizes of many packages can get reduced to a half or even much less.
    </p><div class="note"><h3 class="title">Note</h3><p>
      The reduction effects could be instead achieved by building the parts in completely separate derivations. That would often additionally reduce build-time closures, but it tends to be much harder to write such derivations, as build systems typically assume all parts are being built at once. This compromise approach of single source package producing multiple binary packages is also utilized often by rpm and deb.
     </p></div><p>
     A number of attributes can be used to work with a derivation with multiple outputs. The attribute <code class="literal">outputs</code> is a list of strings, which are the names of the outputs. For each of these names, an identically named attribute is created, corresponding to that output. The attribute <code class="literal">meta.outputsToInstall</code> is used to determine the default set of outputs to install when using the derivation name unqualified.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-multiple-outputs-installing"></a>8.2. Installing a split package</h2></div></div></div><p>
     When installing a package with multiple outputs, the package’s <code class="literal">meta.outputsToInstall</code> attribute determines which outputs are actually installed. <code class="literal">meta.outputsToInstall</code> is a list whose <a class="link" href="https://github.com/NixOS/nixpkgs/blob/f1680774340d5443a1409c3421ced84ac1163ba9/pkgs/stdenv/generic/make-derivation.nix#L310-L320" target="_top">default installs binaries and the associated man pages</a>. The following sections describe ways to install different outputs.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-multiple-outputs-installing-nixos"></a>8.2.1. Selecting outputs to install via NixOS</h3></div></div></div><p>
      NixOS provides two ways to select the outputs to install for packages listed in <code class="literal">environment.systemPackages</code>:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        The configuration option <code class="literal">environment.extraOutputsToInstall</code> is appended to each package’s <code class="literal">meta.outputsToInstall</code> attribute to determine the outputs to install. It can for example be used to install <code class="literal">info</code> documentation or debug symbols for all packages.
       </p></li><li class="listitem"><p>
        The outputs can be listed as packages in <code class="literal">environment.systemPackages</code>. For example, the <code class="literal">"out"</code> and <code class="literal">"info"</code> outputs for the <code class="literal">coreutils</code> package can be installed by including <code class="literal">coreutils</code> and <code class="literal">coreutils.info</code> in <code class="literal">environment.systemPackages</code>.
       </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-multiple-outputs-installing-nix-env"></a>8.2.2. Selecting outputs to install via <code class="literal">nix-env</code></h3></div></div></div><p>
      <code class="literal">nix-env</code> lacks an easy way to select the outputs to install. When installing a package, <code class="literal">nix-env</code> always installs the outputs listed in <code class="literal">meta.outputsToInstall</code>, even when the user explicitly selects an output.
     </p><div class="warning"><h3 class="title">Warning</h3><p>
       <code class="literal">nix-env</code> silenty disregards the outputs selected by the user, and instead installs the outputs from <code class="literal">meta.outputsToInstall</code>. For example,
      </p><pre class="programlisting">
$ nix-env -iA nixpkgs.coreutils.info
</pre><p>
       installs the <code class="literal">"out"</code> output (<code class="literal">coreutils.meta.outputsToInstall</code> is <code class="literal">[ "out" ]</code>) instead of the requested <code class="literal">"info"</code>.
      </p></div><p>
      The only recourse to select an output with <code class="literal">nix-env</code> is to override the package’s <code class="literal">meta.outputsToInstall</code>, using the functions described in <a class="xref" href="#chap-overrides" title="Chapter 4. Overriding">Chapter 4, <em>Overriding</em></a>. For example, the following overlay adds the <code class="literal">"info"</code> output for the <code class="literal">coreutils</code> package:
     </p><pre class="programlisting">
self: super:
{
  coreutils = super.coreutils.overrideAttrs (oldAttrs: {
    meta = oldAttrs.meta // { outputsToInstall = oldAttrs.meta.outputsToInstall or [ "out" ] ++ [ "info" ]; };
  });
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-multiple-outputs-using-split-packages"></a>8.3. Using a split package</h2></div></div></div><p>
     In the Nix language the individual outputs can be reached explicitly as attributes, e.g. <code class="literal">coreutils.info</code>, but the typical case is just using packages as build inputs.
    </p><p>
     When a multiple-output derivation gets into a build input of another derivation, the <code class="literal">dev</code> output is added if it exists, otherwise the first output is added. In addition to that, <code class="literal">propagatedBuildOutputs</code> of that package which by default contain <code class="literal">$outputBin</code> and <code class="literal">$outputLib</code> are also added. (See <a class="xref" href="#multiple-output-file-type-groups" title="8.4.2. File type groups">Section 8.4.2, “File type groups”</a>.)
    </p><p>
     In some cases it may be desirable to combine different outputs under a single store path. A function <code class="literal">symlinkJoin</code> can be used to do this. (Note that it may negate some closure size benefits of using a multiple-output package.)
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-multiple-outputs-"></a>8.4. Writing a split derivation</h2></div></div></div><p>
     Here you find how to write a derivation that produces multiple outputs.
    </p><p>
     In nixpkgs there is a framework supporting multiple-output derivations. It tries to cover most cases by default behavior. You can find the source separated in <code class="literal">&lt;nixpkgs/pkgs/build-support/setup-hooks/multiple-outputs.sh&gt;</code>; it’s relatively well-readable. The whole machinery is triggered by defining the <code class="literal">outputs</code> attribute to contain the list of desired output names (strings).
    </p><pre class="programlisting">
outputs = [ "bin" "dev" "out" "doc" ];
</pre><p>
     Often such a single line is enough. For each output an equally named environment variable is passed to the builder and contains the path in nix store for that output. Typically you also want to have the main <code class="literal">out</code> output, as it catches any files that didn’t get elsewhere.
    </p><div class="note"><h3 class="title">Note</h3><p>
      There is a special handling of the <code class="literal">debug</code> output, described at <a class="xref" href="#stdenv-separateDebugInfo" title="6.5.8.1.17. separateDebugInfo">Section 6.5.8.1.17, “<code class="literal">separateDebugInfo</code>”</a>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="multiple-output-file-binaries-first-convention"></a>8.4.1. <span class="quote">“<span class="quote">Binaries first</span>”</span></h3></div></div></div><p>
      A commonly adopted convention in <code class="literal">nixpkgs</code> is that executables provided by the package are contained within its first output. This convention allows the dependent packages to reference the executables provided by packages in a uniform manner. For instance, provided with the knowledge that the <code class="literal">perl</code> package contains a <code class="literal">perl</code> executable it can be referenced as <code class="literal">${pkgs.perl}/bin/perl</code> within a Nix derivation that needs to execute a Perl script.
     </p><p>
      The <code class="literal">glibc</code> package is a deliberate single exception to the <span class="quote">“<span class="quote">binaries first</span>”</span> convention. The <code class="literal">glibc</code> has <code class="literal">libs</code> as its first output allowing the libraries provided by <code class="literal">glibc</code> to be referenced directly (e.g. <code class="literal">${stdenv.glibc}/lib/ld-linux-x86-64.so.2</code>). The executables provided by <code class="literal">glibc</code> can be accessed via its <code class="literal">bin</code> attribute (e.g. <code class="literal">${stdenv.glibc.bin}/bin/ldd</code>).
     </p><p>
      The reason for why <code class="literal">glibc</code> deviates from the convention is because referencing a library provided by <code class="literal">glibc</code> is a very common operation among Nix packages. For instance, third-party executables packaged by Nix are typically patched and relinked with the relevant version of <code class="literal">glibc</code> libraries from Nix packages (please see the documentation on <a class="link" href="https://github.com/NixOS/patchelf/blob/master/README" target="_top">patchelf</a> for more details).
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="multiple-output-file-type-groups"></a>8.4.2. File type groups</h3></div></div></div><p>
      The support code currently recognizes some particular kinds of outputs and either instructs the build system of the package to put files into their desired outputs or it moves the files during the fixup phase. Each group of file types has an <code class="literal">outputFoo</code> variable specifying the output name where they should go. If that variable isn’t defined by the derivation writer, it is guessed – a default output name is defined, falling back to other possibilities if the output isn’t defined.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="outputdev"></a>8.4.2.1. <code class="literal">$outputDev</code></h4></div></div></div><p>
       is for development-only files. These include C(++) headers (<code class="literal">include/</code>), pkg-config (<code class="literal">lib/pkgconfig/</code>), cmake (<code class="literal">lib/cmake/</code>) and aclocal files (<code class="literal">share/aclocal/</code>). They go to <code class="literal">dev</code> or <code class="literal">out</code> by default.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="outputbin"></a>8.4.2.2. <code class="literal">$outputBin</code></h4></div></div></div><p>
       is meant for user-facing binaries, typically residing in <code class="literal">bin/</code>. They go to <code class="literal">bin</code> or <code class="literal">out</code> by default.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="outputlib"></a>8.4.2.3. <code class="literal">$outputLib</code></h4></div></div></div><p>
       is meant for libraries, typically residing in <code class="literal">lib/</code> and <code class="literal">libexec/</code>. They go to <code class="literal">lib</code> or <code class="literal">out</code> by default.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="outputdoc"></a>8.4.2.4. <code class="literal">$outputDoc</code></h4></div></div></div><p>
       is for user documentation, typically residing in <code class="literal">share/doc/</code>. It goes to <code class="literal">doc</code> or <code class="literal">out</code> by default.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="outputdevdoc"></a>8.4.2.5. <code class="literal">$outputDevdoc</code></h4></div></div></div><p>
       is for <span class="emphasis"><em>developer</em></span> documentation. Currently we count gtk-doc and devhelp books, typically residing in <code class="literal">share/gtk-doc/</code> and <code class="literal">share/devhelp/</code>, in there. It goes to <code class="literal">devdoc</code> or is removed (!) by default. This is because e.g. gtk-doc tends to be rather large and completely unused by nixpkgs users.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="outputman"></a>8.4.2.6. <code class="literal">$outputMan</code></h4></div></div></div><p>
       is for man pages (except for section 3), typically residing in <code class="literal">share/man/man[0-9]/</code>. They go to <code class="literal">man</code> or <code class="literal">$outputBin</code> by default.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="outputdevman"></a>8.4.2.7. <code class="literal">$outputDevman</code></h4></div></div></div><p>
       is for section 3 man pages, typically residing in <code class="literal">share/man/man[0-9]/</code>. They go to <code class="literal">devman</code> or <code class="literal">$outputMan</code> by default.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="outputinfo"></a>8.4.2.8. <code class="literal">$outputInfo</code></h4></div></div></div><p>
       is for info pages, typically residing in <code class="literal">share/info/</code>. They go to <code class="literal">info</code> or <code class="literal">$outputBin</code> by default.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-multiple-outputs-caveats"></a>8.4.3. Common caveats</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        Some configure scripts don’t like some of the parameters passed by default by the framework, e.g. <code class="literal">--docdir=/foo/bar</code>. You can disable this by setting <code class="literal">setOutputFlags = false;</code>.
       </p></li><li class="listitem"><p>
        The outputs of a single derivation can retain references to each other, but note that circular references are not allowed. (And each strongly-connected component would act as a single output anyway.)
       </p></li><li class="listitem"><p>
        Most of split packages contain their core functionality in libraries. These libraries tend to refer to various kind of data that typically gets into <code class="literal">out</code>, e.g. locale strings, so there is often no advantage in separating the libraries into <code class="literal">lib</code>, as keeping them in <code class="literal">out</code> is easier.
       </p></li><li class="listitem"><p>
        Some packages have hidden assumptions on install paths, which complicates splitting.
       </p></li></ul></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-cross"></a>Chapter 9. Cross-compilation</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-cross-intro">9.1. Introduction</a></span></dt><dt><span class="section"><a href="#sec-cross-packaging">9.2. Packaging in a cross-friendly manner</a></span></dt><dt><span class="section"><a href="#sec-cross-usage">9.3. Cross-building packages</a></span></dt><dt><span class="section"><a href="#sec-cross-infra">9.4. Cross-compilation infrastructure</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-cross-intro"></a>9.1. Introduction</h2></div></div></div><p>
     <span class="quote">“<span class="quote">Cross-compilation</span>”</span> means compiling a program on one machine for another type of machine. For example, a typical use of cross-compilation is to compile programs for embedded devices. These devices often don’t have the computing power and memory to compile their own programs. One might think that cross-compilation is a fairly niche concern. However, there are significant advantages to rigorously distinguishing between build-time and run-time environments! Significant, because the benefits apply even when one is developing and deploying on the same machine. Nixpkgs is increasingly adopting the opinion that packages should be written with cross-compilation in mind, and Nixpkgs should evaluate in a similar way (by minimizing cross-compilation-specific special cases) whether or not one is cross-compiling.
    </p><p>
     This chapter will be organized in three parts. First, it will describe the basics of how to package software in a way that supports cross-compilation. Second, it will describe how to use Nixpkgs when cross-compiling. Third, it will describe the internal infrastructure supporting cross-compilation.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-cross-packaging"></a>9.2. Packaging in a cross-friendly manner</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-cross-platform-parameters"></a>9.2.1. Platform parameters</h3></div></div></div><p>
      Nixpkgs follows the <a class="link" href="https://gcc.gnu.org/onlinedocs/gccint/Configure-Terms.html" target="_top">conventions of GNU autoconf</a>. We distinguish between 3 types of platforms when building a derivation: <span class="emphasis"><em>build</em></span>, <span class="emphasis"><em>host</em></span>, and <span class="emphasis"><em>target</em></span>. In summary, <span class="emphasis"><em>build</em></span> is the platform on which a package is being built, <span class="emphasis"><em>host</em></span> is the platform on which it will run. The third attribute, <span class="emphasis"><em>target</em></span>, is relevant only for certain specific compilers and build tools.
     </p><p>
      In Nixpkgs, these three platforms are defined as attribute sets under the names <code class="literal">buildPlatform</code>, <code class="literal">hostPlatform</code>, and <code class="literal">targetPlatform</code>. They are always defined as attributes in the standard environment. That means one can access them like:
     </p><pre class="programlisting">
{ stdenv, fooDep, barDep, ... }: ...stdenv.buildPlatform...
</pre><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        <code class="literal">buildPlatform</code>
       </span></dt><dd><p>
         The <span class="quote">“<span class="quote">build platform</span>”</span> is the platform on which a package is built. Once someone has a built package, or pre-built binary package, the build platform should not matter and can be ignored.
        </p></dd><dt><span class="term">
        <code class="literal">hostPlatform</code>
       </span></dt><dd><p>
         The <span class="quote">“<span class="quote">host platform</span>”</span> is the platform on which a package will be run. This is the simplest platform to understand, but also the one with the worst name.
        </p></dd><dt><span class="term">
        <code class="literal">targetPlatform</code>
       </span></dt><dd><p>
         The <span class="quote">“<span class="quote">target platform</span>”</span> attribute is, unlike the other two attributes, not actually fundamental to the process of building software. Instead, it is only relevant for compatibility with building certain specific compilers and build tools. It can be safely ignored for all other packages.
        </p><p>
         The build process of certain compilers is written in such a way that the compiler resulting from a single build can itself only produce binaries for a single platform. The task of specifying this single <span class="quote">“<span class="quote">target platform</span>”</span> is thus pushed to build time of the compiler. The root cause of this is that the compiler (which will be run on the host) and the standard library/runtime (which will be run on the target) are built by a single build process.
        </p><p>
         There is no fundamental need to think about a single target ahead of time like this. If the tool supports modular or pluggable backends, both the need to specify the target at build time and the constraint of having only a single target disappear. An example of such a tool is LLVM.
        </p><p>
         Although the existence of a <span class="quote">“<span class="quote">target platform</span>”</span> is arguably a historical mistake, it is a common one: examples of tools that suffer from it are GCC, Binutils, GHC and Autoconf. Nixpkgs tries to avoid sharing in the mistake where possible. Still, because the concept of a target platform is so ingrained, it is best to support it as is.
        </p></dd></dl></div><p>
      The exact schema these fields follow is a bit ill-defined due to a long and convoluted evolution, but this is slowly being cleaned up. You can see examples of ones used in practice in <code class="literal">lib.systems.examples</code>; note how they are not all very consistent. For now, here are few fields can count on them containing:
     </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        <code class="literal">system</code>
       </span></dt><dd><p>
         This is a two-component shorthand for the platform. Examples of this would be <span class="quote">“<span class="quote">x86_64-darwin</span>”</span> and <span class="quote">“<span class="quote">i686-linux</span>”</span>; see <code class="literal">lib.systems.doubles</code> for more. The first component corresponds to the CPU architecture of the platform and the second to the operating system of the platform (<code class="literal">[cpu]-[os]</code>). This format has built-in support in Nix, such as the <code class="literal">builtins.currentSystem</code> impure string.
        </p></dd><dt><span class="term">
        <code class="literal">config</code>
       </span></dt><dd><p>
         This is a 3- or 4- component shorthand for the platform. Examples of this would be <code class="literal">x86_64-unknown-linux-gnu</code> and <code class="literal">aarch64-apple-darwin14</code>. This is a standard format called the <span class="quote">“<span class="quote">LLVM target triple</span>”</span>, as they are pioneered by LLVM. In the 4-part form, this corresponds to <code class="literal">[cpu]-[vendor]-[os]-[abi]</code>. This format is strictly more informative than the <span class="quote">“<span class="quote">Nix host double</span>”</span>, as the previous format could analogously be termed. This needs a better name than <code class="literal">config</code>!
        </p></dd><dt><span class="term">
        <code class="literal">parsed</code>
       </span></dt><dd><p>
         This is a Nix representation of a parsed LLVM target triple with white-listed components. This can be specified directly, or actually parsed from the <code class="literal">config</code>. See <code class="literal">lib.systems.parse</code> for the exact representation.
        </p></dd><dt><span class="term">
        <code class="literal">libc</code>
       </span></dt><dd><p>
         This is a string identifying the standard C library used. Valid identifiers include <span class="quote">“<span class="quote">glibc</span>”</span> for GNU libc, <span class="quote">“<span class="quote">libSystem</span>”</span> for Darwin’s Libsystem, and <span class="quote">“<span class="quote">uclibc</span>”</span> for µClibc. It should probably be refactored to use the module system, like <code class="literal">parse</code>.
        </p></dd><dt><span class="term">
        <code class="literal">is*</code>
       </span></dt><dd><p>
         These predicates are defined in <code class="literal">lib.systems.inspect</code>, and slapped onto every platform. They are superior to the ones in <code class="literal">stdenv</code> as they force the user to be explicit about which platform they are inspecting. Please use these instead of those.
        </p></dd><dt><span class="term">
        <code class="literal">platform</code>
       </span></dt><dd><p>
         This is, quite frankly, a dumping ground of ad-hoc settings (it’s an attribute set). See <code class="literal">lib.systems.platforms</code> for examples—there’s hopefully one in there that will work verbatim for each platform that is working. Please help us triage these flags and give them better homes!
        </p></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-cross-dependency-categorization"></a>9.2.2. Theory of dependency categorization</h3></div></div></div><div class="note"><h3 class="title">Note</h3><p>
       This is a rather philosophical description that isn’t very Nixpkgs-specific. For an overview of all the relevant attributes given to <code class="literal">mkDerivation</code>, see <a class="xref" href="#ssec-stdenv-dependencies" title="6.3. Specifying dependencies">Section 6.3, “Specifying dependencies”</a>. For a description of how everything is implemented, see <a class="xref" href="#ssec-cross-dependency-implementation" title="9.4.1. Implementation of dependencies">Section 9.4.1, “Implementation of dependencies”</a>.
      </p></div><p>
      In this section we explore the relationship between both runtime and build-time dependencies and the 3 Autoconf platforms.
     </p><p>
      A run time dependency between two packages requires that their host platforms match. This is directly implied by the meaning of <span class="quote">“<span class="quote">host platform</span>”</span> and <span class="quote">“<span class="quote">runtime dependency</span>”</span>: The package dependency exists while both packages are running on a single host platform.
     </p><p>
      A build time dependency, however, has a shift in platforms between the depending package and the depended-on package. <span class="quote">“<span class="quote">build time dependency</span>”</span> means that to build the depending package we need to be able to run the depended-on’s package. The depending package’s build platform is therefore equal to the depended-on package’s host platform.
     </p><p>
      If both the dependency and depending packages aren’t compilers or other machine-code-producing tools, we’re done. And indeed <code class="literal">buildInputs</code> and <code class="literal">nativeBuildInputs</code> have covered these simpler cases for many years. But if the dependency does produce machine code, we might need to worry about its target platform too. In principle, that target platform might be any of the depending package’s build, host, or target platforms, but we prohibit dependencies from a <span class="quote">“<span class="quote">later</span>”</span> platform to an earlier platform to limit confusion because we’ve never seen a legitimate use for them.
     </p><p>
      Finally, if the depending package is a compiler or other machine-code-producing tool, it might need dependencies that run at <span class="quote">“<span class="quote">emit time</span>”</span>. This is for compilers that (regrettably) insist on being built together with their source languages’ standard libraries. Assuming build != host != target, a run-time dependency of the standard library cannot be run at the compiler’s build time or run time, but only at the run time of code emitted by the compiler.
     </p><p>
      Putting this all together, that means we have dependencies in the form <span class="quote">“<span class="quote">host → target</span>”</span>, in at most the following six combinations:
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="possible-dependency-types"></a>9.2.2.1. Possible dependency types</h4></div></div></div><div class="informaltable"><table class="informaltable" border="1"><colgroup><col align="left" /><col align="left" /></colgroup><thead><tr><th align="left">
                  Dependency’s host platform
                </th><th align="left">
                  Dependency’s target platform
                </th></tr></thead><tbody><tr><td align="left">
                  build
                </td><td align="left">
                  build
                </td></tr><tr><td align="left">
                  build
                </td><td align="left">
                  host
                </td></tr><tr><td align="left">
                  build
                </td><td align="left">
                  target
                </td></tr><tr><td align="left">
                  host
                </td><td align="left">
                  host
                </td></tr><tr><td align="left">
                  host
                </td><td align="left">
                  target
                </td></tr><tr><td align="left">
                  target
                </td><td align="left">
                  target
                </td></tr></tbody></table></div><p>
       Some examples will make this table clearer. Suppose there’s some package that is being built with a <code class="literal">(build, host, target)</code> platform triple of <code class="literal">(foo, bar, baz)</code>. If it has a build-time library dependency, that would be a <span class="quote">“<span class="quote">host → build</span>”</span> dependency with a triple of <code class="literal">(foo, foo, *)</code> (the target platform is irrelevant). If it needs a compiler to be built, that would be a <span class="quote">“<span class="quote">build → host</span>”</span> dependency with a triple of <code class="literal">(foo, foo, *)</code> (the target platform is irrelevant). That compiler, would be built with another compiler, also <span class="quote">“<span class="quote">build → host</span>”</span> dependency, with a triple of <code class="literal">(foo, foo, foo)</code>.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-cross-cookbook"></a>9.2.3. Cross packaging cookbook</h3></div></div></div><p>
      Some frequently encountered problems when packaging for cross-compilation should be answered here. Ideally, the information above is exhaustive, so this section cannot provide any new information, but it is ludicrous and cruel to expect everyone to spend effort working through the interaction of many features just to figure out the same answer to the same common problem. Feel free to add to this list!
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="cross-qa-fails-to-find-binutils"></a>9.2.3.1. My package fails to find a binutils command (<code class="literal">cc</code>/<code class="literal">ar</code>/<code class="literal">ld</code> etc.)</h4></div></div></div><p>
       Many packages assume that an unprefixed binutils (<code class="literal">cc</code>/<code class="literal">ar</code>/<code class="literal">ld</code> etc.) is available, but Nix doesn’t provide one. It only provides a prefixed one, just as it only does for all the other binutils programs. It may be necessary to patch the package to fix the build system to use a prefix. For instance, instead of <code class="literal">cc</code>, use <code class="literal">${stdenv.cc.targetPrefix}cc</code>.
      </p><pre class="programlisting">
makeFlags = [ "CC=${stdenv.cc.targetPrefix}cc" ];
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="cross-qa-avoid-compiling-gcc-cross-compiler"></a>9.2.3.2. How do I avoid compiling a GCC cross-compiler from source?</h4></div></div></div><p>
       On less powerful machines, it can be inconvenient to cross-compile a package only to find out that GCC has to be compiled from source, which could take up to several hours. Nixpkgs maintains a limited <a class="link" href="https://hydra.nixos.org/jobset/nixpkgs/cross-trunk" target="_top">cross-related jobset on Hydra</a>, which tests cross-compilation to various platforms from build platforms <span class="quote">“<span class="quote">x86_64-darwin</span>”</span>, <span class="quote">“<span class="quote">x86_64-linux</span>”</span>, and <span class="quote">“<span class="quote">aarch64-linux</span>”</span>. See <code class="literal">pkgs/top-level/release-cross.nix</code> for the full list of target platforms and packages. For instance, the following invocation fetches the pre-built cross-compiled GCC for <code class="literal">armv6l-unknown-linux-gnueabihf</code> and builds GNU Hello from source.
      </p><pre class="programlisting">
$ nix-build '&lt;nixpkgs&gt;' -A pkgsCross.raspberryPi.hello
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="cross-qa-build-c-program-in-build-environment"></a>9.2.3.3. What if my package’s build system needs to build a C program to be run under the build environment?</h4></div></div></div><p>
       Add the following to your <code class="literal">mkDerivation</code> invocation.
      </p><pre class="programlisting">
depsBuildBuild = [ buildPackages.stdenv.cc ];
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="cross-testsuite-runs-host-code"></a>9.2.3.4. My package’s testsuite needs to run host platform code.</h4></div></div></div><p>
       Add the following to your <code class="literal">mkDerivation</code> invocation.
      </p><pre class="programlisting">
doCheck = stdenv.hostPlatform == stdenv.buildPlatform;
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-cross-usage"></a>9.3. Cross-building packages</h2></div></div></div><p>
     Nixpkgs can be instantiated with <code class="literal">localSystem</code> alone, in which case there is no cross-compiling and everything is built by and for that system, or also with <code class="literal">crossSystem</code>, in which case packages run on the latter, but all building happens on the former. Both parameters take the same schema as the 3 (build, host, and target) platforms defined in the previous section. As mentioned above, <code class="literal">lib.systems.examples</code> has some platforms which are used as arguments for these parameters in practice. You can use them programmatically, or on the command line:
    </p><pre class="programlisting">
$ nix-build '&lt;nixpkgs&gt;' --arg crossSystem '(import &lt;nixpkgs/lib&gt;).systems.examples.fooBarBaz' -A whatever
</pre><div class="note"><h3 class="title">Note</h3><p>
      Eventually we would like to make these platform examples an unnecessary convenience so that
     </p><pre class="programlisting">
$ nix-build '&lt;nixpkgs&gt;' --arg crossSystem '{ config = "&lt;arch&gt;-&lt;os&gt;-&lt;vendor&gt;-&lt;abi&gt;"; }' -A whatever
</pre><p>
      works in the vast majority of cases. The problem today is dependencies on other sorts of configuration which aren’t given proper defaults. We rely on the examples to crudely to set those configuration parameters in some vaguely sane manner on the users behalf. Issue <a class="link" href="https://github.com/NixOS/nixpkgs/issues/34274" target="_top">#34274</a> tracks this inconvenience along with its root cause in crufty configuration options.
     </p></div><p>
     While one is free to pass both parameters in full, there’s a lot of logic to fill in missing fields. As discussed in the previous section, only one of <code class="literal">system</code>, <code class="literal">config</code>, and <code class="literal">parsed</code> is needed to infer the other two. Additionally, <code class="literal">libc</code> will be inferred from <code class="literal">parse</code>. Finally, <code class="literal">localSystem.system</code> is also <span class="emphasis"><em>impurely</em></span> inferred based on the platform evaluation occurs. This means it is often not necessary to pass <code class="literal">localSystem</code> at all, as in the command-line example in the previous paragraph.
    </p><div class="note"><h3 class="title">Note</h3><p>
      Many sources (manual, wiki, etc) probably mention passing <code class="literal">system</code>, <code class="literal">platform</code>, along with the optional <code class="literal">crossSystem</code> to Nixpkgs: <code class="literal">import &lt;nixpkgs&gt; { system = ..; platform = ..; crossSystem = ..; }</code>. Passing those two instead of <code class="literal">localSystem</code> is still supported for compatibility, but is discouraged. Indeed, much of the inference we do for these parameters is motivated by compatibility as much as convenience.
     </p></div><p>
     One would think that <code class="literal">localSystem</code> and <code class="literal">crossSystem</code> overlap horribly with the three <code class="literal">*Platforms</code> (<code class="literal">buildPlatform</code>, <code class="literal">hostPlatform,</code> and <code class="literal">targetPlatform</code>; see <code class="literal">stage.nix</code> or the manual). Actually, those identifiers are purposefully not used here to draw a subtle but important distinction: While the granularity of having 3 platforms is necessary to properly <span class="emphasis"><em>build</em></span> packages, it is overkill for specifying the user’s <span class="emphasis"><em>intent</em></span> when making a build plan or package set. A simple <span class="quote">“<span class="quote">build vs deploy</span>”</span> dichotomy is adequate: the sliding window principle described in the previous section shows how to interpolate between the these two <span class="quote">“<span class="quote">end points</span>”</span> to get the 3 platform triple for each bootstrapping stage. That means for any package a given package set, even those not bound on the top level but only reachable via dependencies or <code class="literal">buildPackages</code>, the three platforms will be defined as one of <code class="literal">localSystem</code> or <code class="literal">crossSystem</code>, with the former replacing the latter as one traverses build-time dependencies. A last simple difference is that <code class="literal">crossSystem</code> should be null when one doesn’t want to cross-compile, while the <code class="literal">*Platform</code>s are always non-null. <code class="literal">localSystem</code> is always non-null.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-cross-infra"></a>9.4. Cross-compilation infrastructure</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-cross-dependency-implementation"></a>9.4.1. Implementation of dependencies</h3></div></div></div><p>
      The categories of dependencies developed in <a class="xref" href="#ssec-cross-dependency-categorization" title="9.2.2. Theory of dependency categorization">Section 9.2.2, “Theory of dependency categorization”</a> are specified as lists of derivations given to <code class="literal">mkDerivation</code>, as documented in <a class="xref" href="#ssec-stdenv-dependencies" title="6.3. Specifying dependencies">Section 6.3, “Specifying dependencies”</a>. In short, each list of dependencies for <span class="quote">“<span class="quote">host → target</span>”</span> of <span class="quote">“<span class="quote">foo → bar</span>”</span> is called <code class="literal">depsFooBar</code>, with exceptions for backwards compatibility that <code class="literal">depsBuildHost</code> is instead called <code class="literal">nativeBuildInputs</code> and <code class="literal">depsHostTarget</code> is instead called <code class="literal">buildInputs</code>. Nixpkgs is now structured so that each <code class="literal">depsFooBar</code> is automatically taken from <code class="literal">pkgsFooBar</code>. (These <code class="literal">pkgsFooBar</code>s are quite new, so there is no special case for <code class="literal">nativeBuildInputs</code> and <code class="literal">buildInputs</code>.) For example, <code class="literal">pkgsBuildHost.gcc</code> should be used at build-time, while <code class="literal">pkgsHostTarget.gcc</code> should be used at run-time.
     </p><p>
      Now, for most of Nixpkgs’s history, there were no <code class="literal">pkgsFooBar</code> attributes, and most packages have not been refactored to use it explicitly. Prior to those, there were just <code class="literal">buildPackages</code>, <code class="literal">pkgs</code>, and <code class="literal">targetPackages</code>. Those are now redefined as aliases to <code class="literal">pkgsBuildHost</code>, <code class="literal">pkgsHostTarget</code>, and <code class="literal">pkgsTargetTarget</code>. It is acceptable, even recommended, to use them for libraries to show that the host platform is irrelevant.
     </p><p>
      But before that, there was just <code class="literal">pkgs</code>, even though both <code class="literal">buildInputs</code> and <code class="literal">nativeBuildInputs</code> existed. [Cross barely worked, and those were implemented with some hacks on <code class="literal">mkDerivation</code> to override dependencies.] What this means is the vast majority of packages do not use any explicit package set to populate their dependencies, just using whatever <code class="literal">callPackage</code> gives them even if they do correctly sort their dependencies into the multiple lists described above. And indeed, asking that users both sort their dependencies, <span class="emphasis"><em>and</em></span> take them from the right attribute set, is both too onerous and redundant, so the recommended approach (for now) is to continue just categorizing by list and not using an explicit package set.
     </p><p>
      To make this work, we <span class="quote">“<span class="quote">splice</span>”</span> together the six <code class="literal">pkgsFooBar</code> package sets and have <code class="literal">callPackage</code> actually take its arguments from that. This is currently implemented in <code class="literal">pkgs/top-level/splice.nix</code>. <code class="literal">mkDerivation</code> then, for each dependency attribute, pulls the right derivation out from the splice. This splicing can be skipped when not cross-compiling as the package sets are the same, but still is a bit slow for cross-compiling. We’d like to do something better, but haven’t come up with anything yet.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-bootstrapping"></a>9.4.2. Bootstrapping</h3></div></div></div><p>
      Each of the package sets described above come from a single bootstrapping stage. While <code class="literal">pkgs/top-level/default.nix</code>, coordinates the composition of stages at a high level, <code class="literal">pkgs/top-level/stage.nix</code> <span class="quote">“<span class="quote">ties the knot</span>”</span> (creates the fixed point) of each stage. The package sets are defined per-stage however, so they can be thought of as edges between stages (the nodes) in a graph. Compositions like <code class="literal">pkgsBuildTarget.targetPackages</code> can be thought of as paths to this graph.
     </p><p>
      While there are many package sets, and thus many edges, the stages can also be arranged in a linear chain. In other words, many of the edges are redundant as far as connectivity is concerned. This hinges on the type of bootstrapping we do. Currently for cross it is:
     </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
        <code class="literal">(native, native, native)</code>
       </p></li><li class="listitem"><p>
        <code class="literal">(native, native, foreign)</code>
       </p></li><li class="listitem"><p>
        <code class="literal">(native, foreign, foreign)</code>
       </p></li></ol></div><p>
      In each stage, <code class="literal">pkgsBuildHost</code> refers to the previous stage, <code class="literal">pkgsBuildBuild</code> refers to the one before that, and <code class="literal">pkgsHostTarget</code> refers to the current one, and <code class="literal">pkgsTargetTarget</code> refers to the next one. When there is no previous or next stage, they instead refer to the current stage. Note how all the invariants regarding the mapping between dependency and depending packages’ build host and target platforms are preserved. <code class="literal">pkgsBuildTarget</code> and <code class="literal">pkgsHostHost</code> are more complex in that the stage fitting the requirements isn’t always a fixed chain of <span class="quote">“<span class="quote">prevs</span>”</span> and <span class="quote">“<span class="quote">nexts</span>”</span> away (modulo the <span class="quote">“<span class="quote">saturating</span>”</span> self-references at the ends). We just special case each instead. All the primary edges are implemented is in <code class="literal">pkgs/stdenv/booter.nix</code>, and secondarily aliases in <code class="literal">pkgs/top-level/stage.nix</code>.
     </p><div class="note"><h3 class="title">Note</h3><p>
       The native stages are bootstrapped in legacy ways that predate the current cross implementation. This is why the bootstrapping stages leading up to the final stages are ignored in the previous paragraph.
      </p></div><p>
      If one looks at the 3 platform triples, one can see that they overlap such that one could put them together into a chain like:
     </p><pre class="programlisting">
(native, native, native, foreign, foreign)
</pre><p>
      If one imagines the saturating self references at the end being replaced with infinite stages, and then overlays those platform triples, one ends up with the infinite tuple:
     </p><pre class="programlisting">
(native..., native, native, native, foreign, foreign, foreign...)
</pre><p>
      One can then imagine any sequence of platforms such that there are bootstrap stages with their 3 platforms determined by <span class="quote">“<span class="quote">sliding a window</span>”</span> that is the 3 tuple through the sequence. This was the original model for bootstrapping. Without a target platform (assume a better world where all compilers are multi-target and all standard libraries are built in their own derivation), this is sufficient. Conversely if one wishes to cross compile <span class="quote">“<span class="quote">faster</span>”</span>, with a <span class="quote">“<span class="quote">Canadian Cross</span>”</span> bootstrapping stage where <code class="literal">build != host != target</code>, more bootstrapping stages are needed since no sliding window provides the pesky <code class="literal">pkgsBuildTarget</code> package set since it skips the Canadian cross stage’s <span class="quote">“<span class="quote">host</span>”</span>.
     </p><div class="note"><h3 class="title">Note</h3><p>
       It is much better to refer to <code class="literal">buildPackages</code> than <code class="literal">targetPackages</code>, or more broadly package sets that do not mention <span class="quote">“<span class="quote">target</span>”</span>. There are three reasons for this.
      </p><p>
       First, it is because bootstrapping stages do not have a unique <code class="literal">targetPackages</code>. For example a <code class="literal">(x86-linux, x86-linux, arm-linux)</code> and <code class="literal">(x86-linux, x86-linux, x86-windows)</code> package set both have a <code class="literal">(x86-linux, x86-linux, x86-linux)</code> package set. Because there is no canonical <code class="literal">targetPackages</code> for such a native (<code class="literal">build == host == target</code>) package set, we set their <code class="literal">targetPackages</code>
      </p><p>
       Second, it is because this is a frequent source of hard-to-follow <span class="quote">“<span class="quote">infinite recursions</span>”</span> / cycles. When only package sets that don’t mention target are used, the package set forms a directed acyclic graph. This means that all cycles that exist are confined to one stage. This means they are a lot smaller, and easier to follow in the code or a backtrace. It also means they are present in native and cross builds alike, and so more likely to be caught by CI and other users.
      </p><p>
       Thirdly, it is because everything target-mentioning only exists to accommodate compilers with lousy build systems that insist on the compiler itself and standard library being built together. Of course that is bad because bigger derivations means longer rebuilds. It is also problematic because it tends to make the standard libraries less like other libraries than they could be, complicating code and build systems alike. Because of the other problems, and because of these innate disadvantages, compilers ought to be packaged another way where possible.
      </p></div><div class="note"><h3 class="title">Note</h3><p>
       If one explores Nixpkgs, they will see derivations with names like <code class="literal">gccCross</code>. Such <code class="literal">*Cross</code> derivations is a holdover from before we properly distinguished between the host and target platforms—the derivation with <span class="quote">“<span class="quote">Cross</span>”</span> in the name covered the <code class="literal">build = host != target</code> case, while the other covered the <code class="literal">host = target</code>, with build platform the same or not based on whether one was using its <code class="literal">.nativeDrv</code> or <code class="literal">.crossDrv</code>. This ugliness will disappear soon.
      </p></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-platform-notes"></a>Chapter 10. Platform Notes</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-darwin">10.1. Darwin (macOS)</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-darwin"></a>10.1. Darwin (macOS)</h2></div></div></div><p>
     Some common issues when packaging software for Darwin:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       The Darwin <code class="literal">stdenv</code> uses clang instead of gcc. When referring to the compiler <code class="literal">$CC</code> or <code class="literal">cc</code> will work in both cases. Some builds hardcode gcc/g++ in their build scripts, that can usually be fixed with using something like <code class="literal">makeFlags = [ "CC=cc" ];</code> or by patching the build scripts.
      </p><pre class="programlisting">
stdenv.mkDerivation {
  name = "libfoo-1.2.3";
  # ...
  buildPhase = ''
    $CC -o hello hello.c
  '';
}
</pre></li><li class="listitem"><p>
       On Darwin, libraries are linked using absolute paths, libraries are resolved by their <code class="literal">install_name</code> at link time. Sometimes packages won’t set this correctly causing the library lookups to fail at runtime. This can be fixed by adding extra linker flags or by running <code class="literal">install_name_tool -id</code> during the <code class="literal">fixupPhase</code>.
      </p><pre class="programlisting">
stdenv.mkDerivation {
  name = "libfoo-1.2.3";
  # ...
  makeFlags = lib.optional stdenv.isDarwin "LDFLAGS=-Wl,-install_name,$(out)/lib/libfoo.dylib";
}
</pre></li><li class="listitem"><p>
       Even if the libraries are linked using absolute paths and resolved via their <code class="literal">install_name</code> correctly, tests can sometimes fail to run binaries. This happens because the <code class="literal">checkPhase</code> runs before the libraries are installed.
      </p><p>
       This can usually be solved by running the tests after the <code class="literal">installPhase</code> or alternatively by using <code class="literal">DYLD_LIBRARY_PATH</code>. More information about this variable can be found in the <span class="emphasis"><em>dyld(1)</em></span> manpage.
      </p><pre class="programlisting">
dyld: Library not loaded: /nix/store/7hnmbscpayxzxrixrgxvvlifzlxdsdir-jq-1.5-lib/lib/libjq.1.dylib
Referenced from: /private/tmp/nix-build-jq-1.5.drv-0/jq-1.5/tests/../jq
Reason: image not found
./tests/jqtest: line 5: 75779 Abort trap: 6
</pre><pre class="programlisting">
stdenv.mkDerivation {
  name = "libfoo-1.2.3";
  # ...
  doInstallCheck = true;
  installCheckTarget = "check";
}
</pre></li><li class="listitem"><p>
       Some packages assume xcode is available and use <code class="literal">xcrun</code> to resolve build tools like <code class="literal">clang</code>, etc. This causes errors like <code class="literal">xcode-select: error: no developer tools were found at '/Applications/Xcode.app'</code> while the build doesn’t actually depend on xcode.
      </p><pre class="programlisting">
stdenv.mkDerivation {
  name = "libfoo-1.2.3";
  # ...
  prePatch = ''
    substituteInPlace Makefile \
        --replace '/usr/bin/xcrun clang' clang
  '';
}
</pre><p>
       The package <code class="literal">xcbuild</code> can be used to build projects that really depend on Xcode. However, this replacement is not 100% compatible with Xcode and can occasionally cause issues.
      </p></li></ul></div></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="idm140737319402416"></a>Part III. Builders</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="#chap-pkgs-fetchers">11. Fetchers</a></span></dt><dt><span class="chapter"><a href="#chap-trivial-builders">12. Trivial builders</a></span></dt><dt><span class="chapter"><a href="#chap-special">13. Special builders</a></span></dt><dt><span class="chapter"><a href="#chap-images">14. Images</a></span></dt><dt><span class="chapter"><a href="#chap-language-support">15. Languages and frameworks</a></span></dt><dt><span class="chapter"><a href="#chap-packages">16. Packages</a></span></dt></dl></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-pkgs-fetchers"></a>Chapter 11. Fetchers</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#fetchsvn">11.1. <code class="literal">fetchsvn</code></a></span></dt><dt><span class="section"><a href="#fetchgit">11.2. <code class="literal">fetchgit</code></a></span></dt><dt><span class="section"><a href="#fetchfossil">11.3. <code class="literal">fetchfossil</code></a></span></dt><dt><span class="section"><a href="#fetchcvs">11.4. <code class="literal">fetchcvs</code></a></span></dt><dt><span class="section"><a href="#fetchhg">11.5. <code class="literal">fetchhg</code></a></span></dt><dt><span class="section"><a href="#fetchfromgithub">11.6. <code class="literal">fetchFromGitHub</code></a></span></dt><dt><span class="section"><a href="#fetchfromgitlab">11.7. <code class="literal">fetchFromGitLab</code></a></span></dt><dt><span class="section"><a href="#fetchfromgitiles">11.8. <code class="literal">fetchFromGitiles</code></a></span></dt><dt><span class="section"><a href="#fetchfrombitbucket">11.9. <code class="literal">fetchFromBitbucket</code></a></span></dt><dt><span class="section"><a href="#fetchfromsavannah">11.10. <code class="literal">fetchFromSavannah</code></a></span></dt><dt><span class="section"><a href="#fetchfromrepoorcz">11.11. <code class="literal">fetchFromRepoOrCz</code></a></span></dt><dt><span class="section"><a href="#fetchfromsourcehut">11.12. <code class="literal">fetchFromSourcehut</code></a></span></dt></dl></div><p>
    When using Nix, you will frequently need to download source code and other files from the internet. Nixpkgs comes with a few helper functions that allow you to fetch fixed-output derivations in a structured way.
   </p><p>
    The two fetcher primitives are <code class="literal">fetchurl</code> and <code class="literal">fetchzip</code>. Both of these have two required arguments, a URL and a hash. The hash is typically <code class="literal">sha256</code>, although many more hash algorithms are supported. Nixpkgs contributors are currently recommended to use <code class="literal">sha256</code>. This hash will be used by Nix to identify your source. A typical usage of fetchurl is provided below.
   </p><pre class="programlisting">
{ stdenv, fetchurl }:

stdenv.mkDerivation {
  name = "hello";
  src = fetchurl {
    url = "http://www.example.org/hello.tar.gz";
    sha256 = "1111111111111111111111111111111111111111111111111111";
  };
}
</pre><p>
    The main difference between <code class="literal">fetchurl</code> and <code class="literal">fetchzip</code> is in how they store the contents. <code class="literal">fetchurl</code> will store the unaltered contents of the URL within the Nix store. <code class="literal">fetchzip</code> on the other hand will decompress the archive for you, making files and directories directly accessible in the future. <code class="literal">fetchzip</code> can only be used with archives. Despite the name, <code class="literal">fetchzip</code> is not limited to .zip files and can also be used with any tarball.
   </p><p>
    <code class="literal">fetchpatch</code> works very similarly to <code class="literal">fetchurl</code> with the same arguments expected. It expects patch files as a source and performs normalization on them before computing the checksum. For example it will remove comments or other unstable parts that are sometimes added by version control systems and can change over time.
   </p><p>
    Other fetcher functions allow you to add source code directly from a VCS such as subversion or git. These are mostly straightforward nambes based on the name of the command used with the VCS system. Because they give you a working repository, they act most like <code class="literal">fetchzip</code>.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchsvn"></a>11.1. <code class="literal">fetchsvn</code></h2></div></div></div><p>
     Used with Subversion. Expects <code class="literal">url</code> to a Subversion directory, <code class="literal">rev</code>, and <code class="literal">sha256</code>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchgit"></a>11.2. <code class="literal">fetchgit</code></h2></div></div></div><p>
     Used with Git. Expects <code class="literal">url</code> to a Git repo, <code class="literal">rev</code>, and <code class="literal">sha256</code>. <code class="literal">rev</code> in this case can be full the git commit id (SHA1 hash) or a tag name like <code class="literal">refs/tags/v1.0</code>.
    </p><p>
     Additionally the following optional arguments can be given: <code class="literal">fetchSubmodules = true</code> makes <code class="literal">fetchgit</code> also fetch the submodules of a repository. If <code class="literal">deepClone</code> is set to true, the entire repository is cloned as opposing to just creating a shallow clone. <code class="literal">deepClone = true</code> also implies <code class="literal">leaveDotGit = true</code> which means that the <code class="literal">.git</code> directory of the clone won’t be removed after checkout.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchfossil"></a>11.3. <code class="literal">fetchfossil</code></h2></div></div></div><p>
     Used with Fossil. Expects <code class="literal">url</code> to a Fossil archive, <code class="literal">rev</code>, and <code class="literal">sha256</code>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchcvs"></a>11.4. <code class="literal">fetchcvs</code></h2></div></div></div><p>
     Used with CVS. Expects <code class="literal">cvsRoot</code>, <code class="literal">tag</code>, and <code class="literal">sha256</code>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchhg"></a>11.5. <code class="literal">fetchhg</code></h2></div></div></div><p>
     Used with Mercurial. Expects <code class="literal">url</code>, <code class="literal">rev</code>, and <code class="literal">sha256</code>.
    </p><p>
     A number of fetcher functions wrap part of <code class="literal">fetchurl</code> and <code class="literal">fetchzip</code>. They are mainly convenience functions intended for commonly used destinations of source code in Nixpkgs. These wrapper fetchers are listed below.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchfromgithub"></a>11.6. <code class="literal">fetchFromGitHub</code></h2></div></div></div><p>
     <code class="literal">fetchFromGitHub</code> expects four arguments. <code class="literal">owner</code> is a string corresponding to the GitHub user or organization that controls this repository. <code class="literal">repo</code> corresponds to the name of the software repository. These are located at the top of every GitHub HTML page as <code class="literal">owner</code>/<code class="literal">repo</code>. <code class="literal">rev</code> corresponds to the Git commit hash or tag (e.g <code class="literal">v1.0</code>) that will be downloaded from Git. Finally, <code class="literal">sha256</code> corresponds to the hash of the extracted directory. Again, other hash algorithms are also available but <code class="literal">sha256</code> is currently preferred.
    </p><p>
     <code class="literal">fetchFromGitHub</code> uses <code class="literal">fetchzip</code> to download the source archive generated by GitHub for the specified revision. If <code class="literal">leaveDotGit</code>, <code class="literal">deepClone</code> or <code class="literal">fetchSubmodules</code> are set to <code class="literal">true</code>, <code class="literal">fetchFromGitHub</code> will use <code class="literal">fetchgit</code> instead. Refer to its section for documentation of these options.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchfromgitlab"></a>11.7. <code class="literal">fetchFromGitLab</code></h2></div></div></div><p>
     This is used with GitLab repositories. The arguments expected are very similar to fetchFromGitHub above.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchfromgitiles"></a>11.8. <code class="literal">fetchFromGitiles</code></h2></div></div></div><p>
     This is used with Gitiles repositories. The arguments expected are similar to fetchgit.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchfrombitbucket"></a>11.9. <code class="literal">fetchFromBitbucket</code></h2></div></div></div><p>
     This is used with BitBucket repositories. The arguments expected are very similar to fetchFromGitHub above.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchfromsavannah"></a>11.10. <code class="literal">fetchFromSavannah</code></h2></div></div></div><p>
     This is used with Savannah repositories. The arguments expected are very similar to fetchFromGitHub above.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchfromrepoorcz"></a>11.11. <code class="literal">fetchFromRepoOrCz</code></h2></div></div></div><p>
     This is used with repo.or.cz repositories. The arguments expected are very similar to fetchFromGitHub above.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="fetchfromsourcehut"></a>11.12. <code class="literal">fetchFromSourcehut</code></h2></div></div></div><p>
     This is used with sourcehut repositories. The arguments expected are very similar to fetchFromGitHub above. Don’t forget the tilde (~) in front of the user name!
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-trivial-builders"></a>Chapter 12. Trivial builders</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#trivial-builder-runCommand">12.1. <code class="literal">runCommand</code></a></span></dt><dt><span class="section"><a href="#trivial-builder-runCommandCC">12.2. <code class="literal">runCommandCC</code></a></span></dt><dt><span class="section"><a href="#trivial-builder-runCommandLocal">12.3. <code class="literal">runCommandLocal</code></a></span></dt><dt><span class="section"><a href="#trivial-builder-writeText">12.4. <code class="literal">writeTextFile</code>, <code class="literal">writeText</code>, <code class="literal">writeTextDir</code>, <code class="literal">writeScript</code>, <code class="literal">writeScriptBin</code></a></span></dt><dt><span class="section"><a href="#trivial-builder-symlinkJoin">12.5. <code class="literal">symlinkJoin</code></a></span></dt><dt><span class="section"><a href="#trivial-builder-writeReferencesToFile">12.6. <code class="literal">writeReferencesToFile</code></a></span></dt><dt><span class="section"><a href="#trivial-builder-writeDirectReferencesToFile">12.7. <code class="literal">writeDirectReferencesToFile</code></a></span></dt></dl></div><p>
    Nixpkgs provides a couple of functions that help with building derivations. The most important one, <code class="literal">stdenv.mkDerivation</code>, has already been documented above. The following functions wrap <code class="literal">stdenv.mkDerivation</code>, making it easier to use in certain cases.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="trivial-builder-runCommand"></a>12.1. <code class="literal">runCommand</code></h2></div></div></div><p>
     This takes three arguments, <code class="literal">name</code>, <code class="literal">env</code>, and <code class="literal">buildCommand</code>. <code class="literal">name</code> is just the name that Nix will append to the store path in the same way that <code class="literal">stdenv.mkDerivation</code> uses its <code class="literal">name</code> attribute. <code class="literal">env</code> is an attribute set specifying environment variables that will be set for this derivation. These attributes are then passed to the wrapped <code class="literal">stdenv.mkDerivation</code>. <code class="literal">buildCommand</code> specifies the commands that will be run to create this derivation. Note that you will need to create <code class="literal">$out</code> for Nix to register the command as successful.
    </p><p>
     An example of using <code class="literal">runCommand</code> is provided below.
    </p><pre class="programlisting">
(import &lt;nixpkgs&gt; {}).runCommand "my-example" {} ''
  echo My example command is running

  mkdir $out

  echo I can write data to the Nix store &gt; $out/message

  echo I can also run basic commands like:

  echo ls
  ls

  echo whoami
  whoami

  echo date
  date
''
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="trivial-builder-runCommandCC"></a>12.2. <code class="literal">runCommandCC</code></h2></div></div></div><p>
     This works just like <code class="literal">runCommand</code>. The only difference is that it also provides a C compiler in <code class="literal">buildCommand</code>’s environment. To minimize your dependencies, you should only use this if you are sure you will need a C compiler as part of running your command.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="trivial-builder-runCommandLocal"></a>12.3. <code class="literal">runCommandLocal</code></h2></div></div></div><p>
     Variant of <code class="literal">runCommand</code> that forces the derivation to be built locally, it is not substituted. This is intended for very cheap commands (&lt;1s execution time). It saves on the network roundrip and can speed up a build.
    </p><div class="note"><h3 class="title">Note</h3><p>
      This sets <a class="link" href="https://nixos.org/nix/manual/#adv-attr-allowSubstitutes" target="_top"><code class="literal">allowSubstitutes</code> to <code class="literal">false</code></a>, so only use <code class="literal">runCommandLocal</code> if you are certain the user will always have a builder for the <code class="literal">system</code> of the derivation. This should be true for most trivial use cases (e.g. just copying some files to a different location or adding symlinks), because there the <code class="literal">system</code> is usually the same as <code class="literal">builtins.currentSystem</code>.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="trivial-builder-writeText"></a>12.4. <code class="literal">writeTextFile</code>, <code class="literal">writeText</code>, <code class="literal">writeTextDir</code>, <code class="literal">writeScript</code>, <code class="literal">writeScriptBin</code></h2></div></div></div><p>
     These functions write <code class="literal">text</code> to the Nix store. This is useful for creating scripts from Nix expressions. <code class="literal">writeTextFile</code> takes an attribute set and expects two arguments, <code class="literal">name</code> and <code class="literal">text</code>. <code class="literal">name</code> corresponds to the name used in the Nix store path. <code class="literal">text</code> will be the contents of the file. You can also set <code class="literal">executable</code> to true to make this file have the executable bit set.
    </p><p>
     Many more commands wrap <code class="literal">writeTextFile</code> including <code class="literal">writeText</code>, <code class="literal">writeTextDir</code>, <code class="literal">writeScript</code>, and <code class="literal">writeScriptBin</code>. These are convenience functions over <code class="literal">writeTextFile</code>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="trivial-builder-symlinkJoin"></a>12.5. <code class="literal">symlinkJoin</code></h2></div></div></div><p>
     This can be used to put many derivations into the same directory structure. It works by creating a new derivation and adding symlinks to each of the paths listed. It expects two arguments, <code class="literal">name</code>, and <code class="literal">paths</code>. <code class="literal">name</code> is the name used in the Nix store path for the created derivation. <code class="literal">paths</code> is a list of paths that will be symlinked. These paths can be to Nix store derivations or any other subdirectory contained within.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="trivial-builder-writeReferencesToFile"></a>12.6. <code class="literal">writeReferencesToFile</code></h2></div></div></div><p>
     Writes the closure of transitive dependencies to a file.
    </p><p>
     This produces the equivalent of <code class="literal">nix-store -q --requisites</code>.
    </p><p>
     For example,
    </p><pre class="programlisting">
writeReferencesToFile (writeScriptBin "hi" ''${hello}/bin/hello'')
</pre><p>
     produces an output path <code class="literal">/nix/store/&lt;hash&gt;-runtime-deps</code> containing
    </p><pre class="programlisting">
/nix/store/&lt;hash&gt;-hello-2.10
/nix/store/&lt;hash&gt;-hi
/nix/store/&lt;hash&gt;-libidn2-2.3.0
/nix/store/&lt;hash&gt;-libunistring-0.9.10
/nix/store/&lt;hash&gt;-glibc-2.32-40
</pre><p>
     You can see that this includes <code class="literal">hi</code>, the original input path, <code class="literal">hello</code>, which is a direct reference, but also the other paths that are indirectly required to run <code class="literal">hello</code>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="trivial-builder-writeDirectReferencesToFile"></a>12.7. <code class="literal">writeDirectReferencesToFile</code></h2></div></div></div><p>
     Writes the set of references to the output file, that is, their immediate dependencies.
    </p><p>
     This produces the equivalent of <code class="literal">nix-store -q --references</code>.
    </p><p>
     For example,
    </p><pre class="programlisting">
writeDirectReferencesToFile (writeScriptBin "hi" ''${hello}/bin/hello'')
</pre><p>
     produces an output path <code class="literal">/nix/store/&lt;hash&gt;-runtime-references</code> containing
    </p><pre class="programlisting">
/nix/store/&lt;hash&gt;-hello-2.10
</pre><p>
     but none of <code class="literal">hello</code>’s dependencies, because those are not referenced directly by <code class="literal">hi</code>’s output.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-special"></a>Chapter 13. Special builders</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-fhs-environments">13.1. buildFHSUserEnv</a></span></dt><dt><span class="section"><a href="#sec-pkgs-mkShell">13.2. pkgs.mkShell</a></span></dt></dl></div><p>
    This chapter describes several special builders.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-fhs-environments"></a>13.1. buildFHSUserEnv</h2></div></div></div><p>
     <code class="literal">buildFHSUserEnv</code> provides a way to build and run FHS-compatible lightweight sandboxes. It creates an isolated root with bound <code class="literal">/nix/store</code>, so its footprint in terms of disk space needed is quite small. This allows one to run software which is hard or unfeasible to patch for NixOS – 3rd-party source trees with FHS assumptions, games distributed as tarballs, software with integrity checking and/or external self-updated binaries. It uses Linux namespaces feature to create temporary lightweight environments which are destroyed after all child processes exit, without root user rights requirement. Accepted arguments are:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       <code class="literal">name</code> Environment name.
      </p></li><li class="listitem"><p>
       <code class="literal">targetPkgs</code> Packages to be installed for the main host’s architecture (i.e. x86_64 on x86_64 installations). Along with libraries binaries are also installed.
      </p></li><li class="listitem"><p>
       <code class="literal">multiPkgs</code> Packages to be installed for all architectures supported by a host (i.e. i686 and x86_64 on x86_64 installations). Only libraries are installed by default.
      </p></li><li class="listitem"><p>
       <code class="literal">extraBuildCommands</code> Additional commands to be executed for finalizing the directory structure.
      </p></li><li class="listitem"><p>
       <code class="literal">extraBuildCommandsMulti</code> Like <code class="literal">extraBuildCommands</code>, but executed only on multilib architectures.
      </p></li><li class="listitem"><p>
       <code class="literal">extraOutputsToInstall</code> Additional derivation outputs to be linked for both target and multi-architecture packages.
      </p></li><li class="listitem"><p>
       <code class="literal">extraInstallCommands</code> Additional commands to be executed for finalizing the derivation with runner script.
      </p></li><li class="listitem"><p>
       <code class="literal">runScript</code> A command that would be executed inside the sandbox and passed all the command line arguments. It defaults to <code class="literal">bash</code>.
      </p></li></ul></div><p>
     One can create a simple environment using a <code class="literal">shell.nix</code> like that:
    </p><pre class="programlisting">
{ pkgs ? import &lt;nixpkgs&gt; {} }:

(pkgs.buildFHSUserEnv {
  name = "simple-x11-env";
  targetPkgs = pkgs: (with pkgs;
    [ udev
      alsaLib
    ]) ++ (with pkgs.xorg;
    [ libX11
      libXcursor
      libXrandr
    ]);
  multiPkgs = pkgs: (with pkgs;
    [ udev
      alsaLib
    ]);
  runScript = "bash";
}).env
</pre><p>
     Running <code class="literal">nix-shell</code> would then drop you into a shell with these libraries and binaries available. You can use this to run closed-source applications which expect FHS structure without hassles: simply change <code class="literal">runScript</code> to the application path, e.g. <code class="literal">./bin/start.sh</code> – relative paths are supported.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pkgs-mkShell"></a>13.2. pkgs.mkShell</h2></div></div></div><p>
     <code class="literal">pkgs.mkShell</code> is a special kind of derivation that is only useful when using it combined with <code class="literal">nix-shell</code>. It will in fact fail to instantiate when invoked with <code class="literal">nix-build</code>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-pkgs-mkShell-usage"></a>13.2.1. Usage</h3></div></div></div><pre class="programlisting">
{ pkgs ? import &lt;nixpkgs&gt; {} }:
pkgs.mkShell {
  # specify which packages to add to the shell environment
  packages = [ pkgs.gnumake ];
  # add all the dependencies, of the given packages, to the shell environment
  inputsFrom = with pkgs; [ hello gnutar ];
}
</pre></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-images"></a>Chapter 14. Images</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-pkgs-appimageTools">14.1. pkgs.appimageTools</a></span></dt><dt><span class="section"><a href="#sec-pkgs-dockerTools">14.2. pkgs.dockerTools</a></span></dt><dt><span class="section"><a href="#sec-pkgs-ociTools">14.3. pkgs.ociTools</a></span></dt><dt><span class="section"><a href="#sec-pkgs-snapTools">14.4. pkgs.snapTools</a></span></dt></dl></div><p>
    This chapter describes tools for creating various types of images.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pkgs-appimageTools"></a>14.1. pkgs.appimageTools</h2></div></div></div><p>
     <code class="literal">pkgs.appimageTools</code> is a set of functions for extracting and wrapping <a class="link" href="https://appimage.org/" target="_top">AppImage</a> files. They are meant to be used if traditional packaging from source is infeasible, or it would take too long. To quickly run an AppImage file, <code class="literal">pkgs.appimage-run</code> can be used as well.
    </p><div class="warning"><h3 class="title">Warning</h3><p>
      The <code class="literal">appimageTools</code> API is unstable and may be subject to backwards-incompatible changes in the future.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-appimageTools-formats"></a>14.1.1. AppImage formats</h3></div></div></div><p>
      There are different formats for AppImages, see <a class="link" href="https://github.com/AppImage/AppImageSpec/blob/74ad9ca2f94bf864a4a0dac1f369dd4f00bd1c28/draft.md#image-format" target="_top">the specification</a> for details.
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        Type 1 images are ISO 9660 files that are also ELF executables.
       </p></li><li class="listitem"><p>
        Type 2 images are ELF executables with an appended filesystem.
       </p></li></ul></div><p>
      They can be told apart with <code class="literal">file -k</code>:
     </p><pre class="programlisting">
$ file -k type1.AppImage
type1.AppImage: ELF 64-bit LSB executable, x86-64, version 1 (SYSV) ISO 9660 CD-ROM filesystem data 'AppImage' (Lepton 3.x), scale 0-0,
spot sensor temperature 0.000000, unit celsius, color scheme 0, calibration: offset 0.000000, slope 0.000000, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.18, BuildID[sha1]=d629f6099d2344ad82818172add1d38c5e11bc6d, stripped\012- data

$ file -k type2.AppImage
type2.AppImage: ELF 64-bit LSB executable, x86-64, version 1 (SYSV) (Lepton 3.x), scale 232-60668, spot sensor temperature -4.187500, color scheme 15, show scale bar, calibration: offset -0.000000, slope 0.000000 (Lepton 2.x), scale 4111-45000, spot sensor temperature 412442.250000, color scheme 3, minimum point enabled, calibration: offset -75402534979642766821519867692934234112.000000, slope 5815371847733706829839455140374904832.000000, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.18, BuildID[sha1]=79dcc4e55a61c293c5e19edbd8d65b202842579f, stripped\012- data
</pre><p>
      Note how the type 1 AppImage is described as an <code class="literal">ISO 9660 CD-ROM filesystem</code>, and the type 2 AppImage is not.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-appimageTools-wrapping"></a>14.1.2. Wrapping</h3></div></div></div><p>
      Depending on the type of AppImage you’re wrapping, you’ll have to use <code class="literal">wrapType1</code> or <code class="literal">wrapType2</code>.
     </p><pre class="programlisting">
appimageTools.wrapType2 { # or wrapType1
  name = "patchwork";
  src = fetchurl {
    url = "https://github.com/ssbc/patchwork/releases/download/v3.11.4/Patchwork-3.11.4-linux-x86_64.AppImage";
    sha256 = "1blsprpkvm0ws9b96gb36f0rbf8f5jgmw4x6dsb1kswr4ysf591s";
  };
  extraPkgs = pkgs: with pkgs; [ ];
}
</pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">name</code> specifies the name of the resulting image.
       </p></li><li class="listitem"><p>
        <code class="literal">src</code> specifies the AppImage file to extract.
       </p></li><li class="listitem"><p>
        <code class="literal">extraPkgs</code> allows you to pass a function to include additional packages inside the FHS environment your AppImage is going to run in. There are a few ways to learn which dependencies an application needs:
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          Looking through the extracted AppImage files, reading its scripts and running <code class="literal">patchelf</code> and <code class="literal">ldd</code> on its executables. This can also be done in <code class="literal">appimage-run</code>, by setting <code class="literal">APPIMAGE_DEBUG_EXEC=bash</code>.
         </p></li><li class="listitem"><p>
          Running <code class="literal">strace -vfefile</code> on the wrapped executable, looking for libraries that can’t be found.
         </p></li></ul></div></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pkgs-dockerTools"></a>14.2. pkgs.dockerTools</h2></div></div></div><p>
     <code class="literal">pkgs.dockerTools</code> is a set of functions for creating and manipulating Docker images according to the <a class="link" href="https://github.com/moby/moby/blob/master/image/spec/v1.2.md#docker-image-specification-v120" target="_top">Docker Image Specification v1.2.0</a>. Docker itself is not used to perform any of the operations done by these functions.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-dockerTools-buildImage"></a>14.2.1. buildImage</h3></div></div></div><p>
      This function is analogous to the <code class="literal">docker build</code> command, in that it can be used to build a Docker-compatible repository tarball containing a single image with one or multiple layers. As such, the result is suitable for being loaded in Docker with <code class="literal">docker load</code>.
     </p><p>
      The parameters of <code class="literal">buildImage</code> with relative example values are described below:
     </p><p>
      <a id="ex-dockerTools-buildImage"></a>
      <a id="ex-dockerTools-buildImage-runAsRoot"></a>
     </p><pre class="programlisting">
buildImage {
  name = "redis";
  tag = "latest";

  fromImage = someBaseImage;
  fromImageName = null;
  fromImageTag = "latest";

  contents = pkgs.redis;
  runAsRoot = ''
    #!${pkgs.runtimeShell}
    mkdir -p /data
  '';

  config = {
    Cmd = [ "/bin/redis-server" ];
    WorkingDir = "/data";
    Volumes = { "/data" = { }; };
  };
}
</pre><p>
      The above example will build a Docker image <code class="literal">redis/latest</code> from the given base image. Loading and running this image in Docker results in <code class="literal">redis-server</code> being started automatically.
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">name</code> specifies the name of the resulting image. This is the only required argument for <code class="literal">buildImage</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">tag</code> specifies the tag of the resulting image. By default it’s <code class="literal">null</code>, which indicates that the nix output hash will be used as tag.
       </p></li><li class="listitem"><p>
        <code class="literal">fromImage</code> is the repository tarball containing the base image. It must be a valid Docker image, such as exported by <code class="literal">docker save</code>. By default it’s <code class="literal">null</code>, which can be seen as equivalent to <code class="literal">FROM scratch</code> of a <code class="literal">Dockerfile</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">fromImageName</code> can be used to further specify the base image within the repository, in case it contains multiple images. By default it’s <code class="literal">null</code>, in which case <code class="literal">buildImage</code> will peek the first image available in the repository.
       </p></li><li class="listitem"><p>
        <code class="literal">fromImageTag</code> can be used to further specify the tag of the base image within the repository, in case an image contains multiple tags. By default it’s <code class="literal">null</code>, in which case <code class="literal">buildImage</code> will peek the first tag available for the base image.
       </p></li><li class="listitem"><p>
        <code class="literal">contents</code> is a derivation that will be copied in the new layer of the resulting image. This can be similarly seen as <code class="literal">ADD contents/ /</code> in a <code class="literal">Dockerfile</code>. By default it’s <code class="literal">null</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">runAsRoot</code> is a bash script that will run as root in an environment that overlays the existing layers of the base image with the new resulting layer, including the previously copied <code class="literal">contents</code> derivation. This can be similarly seen as <code class="literal">RUN ...</code> in a <code class="literal">Dockerfile</code>.
       </p></li></ul></div><div class="blockquote"><blockquote class="blockquote"><p>
       <span class="strong"><strong><span class="emphasis"><em>NOTE:</em></span></strong></span> Using this parameter requires the <code class="literal">kvm</code> device to be available.
      </p></blockquote></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">config</code> is used to specify the configuration of the containers that will be started off the built image in Docker. The available options are listed in the <a class="link" href="https://github.com/moby/moby/blob/master/image/spec/v1.2.md#image-json-field-descriptions" target="_top">Docker Image Specification v1.2.0</a>.
       </p></li></ul></div><p>
      After the new layer has been created, its closure (to which <code class="literal">contents</code>, <code class="literal">config</code> and <code class="literal">runAsRoot</code> contribute) will be copied in the layer itself. Only new dependencies that are not already in the existing layers will be copied.
     </p><p>
      At the end of the process, only one new single layer will be produced and added to the resulting image.
     </p><p>
      The resulting repository will only list the single image <code class="literal">image/tag</code>. In the case of <a class="link" href="#ex-dockerTools-buildImage">the <code class="literal">buildImage</code> example</a> it would be <code class="literal">redis/latest</code>.
     </p><p>
      It is possible to inspect the arguments with which an image was built using its <code class="literal">buildArgs</code> attribute.
     </p><div class="blockquote"><blockquote class="blockquote"><p>
       <span class="strong"><strong><span class="emphasis"><em>NOTE:</em></span></strong></span> If you see errors similar to <code class="literal">getProtocolByName: does not exist (no such protocol name: tcp)</code> you may need to add <code class="literal">pkgs.iana-etc</code> to <code class="literal">contents</code>.
      </p></blockquote></div><div class="blockquote"><blockquote class="blockquote"><p>
       <span class="strong"><strong><span class="emphasis"><em>NOTE:</em></span></strong></span> If you see errors similar to <code class="literal">Error_Protocol ("certificate has unknown CA",True,UnknownCa)</code> you may need to add <code class="literal">pkgs.cacert</code> to <code class="literal">contents</code>.
      </p></blockquote></div><p>
      By default <code class="literal">buildImage</code> will use a static date of one second past the UNIX Epoch. This allows <code class="literal">buildImage</code> to produce binary reproducible images. When listing images with <code class="literal">docker images</code>, the newly created images will be listed like this:
     </p><pre class="programlisting">
$ docker images
REPOSITORY   TAG      IMAGE ID       CREATED        SIZE
hello        latest   08c791c7846e   48 years ago   25.2MB
</pre><p>
      You can break binary reproducibility but have a sorted, meaningful <code class="literal">CREATED</code> column by setting <code class="literal">created</code> to <code class="literal">now</code>.
     </p><pre class="programlisting">
pkgs.dockerTools.buildImage {
  name = "hello";
  tag = "latest";
  created = "now";
  contents = pkgs.hello;

  config.Cmd = [ "/bin/hello" ];
}
</pre><p>
      and now the Docker CLI will display a reasonable date and sort the images as expected:
     </p><pre class="programlisting">
$ docker images
REPOSITORY   TAG      IMAGE ID       CREATED              SIZE
hello        latest   de2bf4786de6   About a minute ago   25.2MB
</pre><p>
      however, the produced images will not be binary reproducible.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-dockerTools-buildLayeredImage"></a>14.2.2. buildLayeredImage</h3></div></div></div><p>
      Create a Docker image with many of the store paths being on their own layer to improve sharing between images. The image is realized into the Nix store as a gzipped tarball. Depending on the intended usage, many users might prefer to use <code class="literal">streamLayeredImage</code> instead, which this function uses internally.
     </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">
        <code class="literal">name</code>
       </span></dt><dd><p>
         The name of the resulting image.
        </p></dd><dt><span class="term">
        <code class="literal">tag</code> <span class="emphasis"><em>optional</em></span>
       </span></dt><dd><p>
         Tag of the generated image.
        </p><p>
         <span class="emphasis"><em>Default:</em></span> the output path’s hash
        </p></dd><dt><span class="term">
        <code class="literal">fromImage</code> <span class="emphasis"><em>optional</em></span>
       </span></dt><dd><p>
         The repository tarball containing the base image. It must be a valid Docker image, such as one exported by <code class="literal">docker save</code>.
        </p><p>
         <span class="emphasis"><em>Default:</em></span> <code class="literal">null</code>, which can be seen as equivalent to <code class="literal">FROM scratch</code> of a <code class="literal">Dockerfile</code>.
        </p></dd><dt><span class="term">
        <code class="literal">contents</code> <span class="emphasis"><em>optional</em></span>
       </span></dt><dd><p>
         Top level paths in the container. Either a single derivation, or a list of derivations.
        </p><p>
         <span class="emphasis"><em>Default:</em></span> <code class="literal">[]</code>
        </p></dd><dt><span class="term">
        <code class="literal">config</code> <span class="emphasis"><em>optional</em></span>
       </span></dt><dd><p>
         Run-time configuration of the container. A full list of the options are available at in the <a class="link" href="https://github.com/moby/moby/blob/master/image/spec/v1.2.md#image-json-field-descriptions" target="_top">Docker Image Specification v1.2.0</a>.
        </p><p>
         <span class="emphasis"><em>Default:</em></span> <code class="literal">{}</code>
        </p></dd><dt><span class="term">
        <code class="literal">created</code> <span class="emphasis"><em>optional</em></span>
       </span></dt><dd><p>
         Date and time the layers were created. Follows the same <code class="literal">now</code> exception supported by <code class="literal">buildImage</code>.
        </p><p>
         <span class="emphasis"><em>Default:</em></span> <code class="literal">1970-01-01T00:00:01Z</code>
        </p></dd><dt><span class="term">
        <code class="literal">maxLayers</code> <span class="emphasis"><em>optional</em></span>
       </span></dt><dd><p>
         Maximum number of layers to create.
        </p><p>
         <span class="emphasis"><em>Default:</em></span> <code class="literal">100</code>
        </p><p>
         <span class="emphasis"><em>Maximum:</em></span> <code class="literal">125</code>
        </p></dd><dt><span class="term">
        <code class="literal">extraCommands</code> <span class="emphasis"><em>optional</em></span>
       </span></dt><dd><p>
         Shell commands to run while building the final layer, without access to most of the layer contents. Changes to this layer are <span class="quote">“<span class="quote">on top</span>”</span> of all the other layers, so can create additional directories and files.
        </p></dd><dt><span class="term">
        <code class="literal">fakeRootCommands</code> <span class="emphasis"><em>optional</em></span>
       </span></dt><dd><p>
         Shell commands to run while creating the archive for the final layer in a fakeroot environment. Unlike <code class="literal">extraCommands</code>, you can run <code class="literal">chown</code> to change the owners of the files in the archive, changing fakeroot’s state instead of the real filesystem. The latter would require privileges that the build user does not have. Static binaries do not interact with the fakeroot environment. By default all files in the archive will be owned by root.
        </p></dd></dl></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="dockerTools-buildLayeredImage-arg-contents"></a>14.2.2.1. Behavior of <code class="literal">contents</code> in the final image</h4></div></div></div><p>
       Each path directly listed in <code class="literal">contents</code> will have a symlink in the root of the image.
      </p><p>
       For example:
      </p><pre class="programlisting">
pkgs.dockerTools.buildLayeredImage {
  name = "hello";
  contents = [ pkgs.hello ];
}
</pre><p>
       will create symlinks for all the paths in the <code class="literal">hello</code> package:
      </p><pre class="programlisting">
/bin/hello -&gt; /nix/store/h1zb1padqbbb7jicsvkmrym3r6snphxg-hello-2.10/bin/hello
/share/info/hello.info -&gt; /nix/store/h1zb1padqbbb7jicsvkmrym3r6snphxg-hello-2.10/share/info/hello.info
/share/locale/bg/LC_MESSAGES/hello.mo -&gt; /nix/store/h1zb1padqbbb7jicsvkmrym3r6snphxg-hello-2.10/share/locale/bg/LC_MESSAGES/hello.mo
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="dockerTools-buildLayeredImage-arg-config"></a>14.2.2.2. Automatic inclusion of <code class="literal">config</code> references</h4></div></div></div><p>
       The closure of <code class="literal">config</code> is automatically included in the closure of the final image.
      </p><p>
       This allows you to make very simple Docker images with very little code. This container will start up and run <code class="literal">hello</code>:
      </p><pre class="programlisting">
pkgs.dockerTools.buildLayeredImage {
  name = "hello";
  config.Cmd = [ "${pkgs.hello}/bin/hello" ];
}
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="dockerTools-buildLayeredImage-arg-maxLayers"></a>14.2.2.3. Adjusting <code class="literal">maxLayers</code></h4></div></div></div><p>
       Increasing the <code class="literal">maxLayers</code> increases the number of layers which have a chance to be shared between different images.
      </p><p>
       Modern Docker installations support up to 128 layers, however older versions support as few as 42.
      </p><p>
       If the produced image will not be extended by other Docker builds, it is safe to set <code class="literal">maxLayers</code> to <code class="literal">128</code>. However it will be impossible to extend the image further.
      </p><p>
       The first (<code class="literal">maxLayers-2</code>) most <span class="quote">“<span class="quote">popular</span>”</span> paths will have their own individual layers, then layer #<code class="literal">maxLayers-1</code> will contain all the remaining <span class="quote">“<span class="quote">unpopular</span>”</span> paths, and finally layer #<code class="literal">maxLayers</code> will contain the Image configuration.
      </p><p>
       Docker’s Layers are not inherently ordered, they are content-addressable and are not explicitly layered until they are composed in to an Image.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-dockerTools-streamLayeredImage"></a>14.2.3. streamLayeredImage</h3></div></div></div><p>
      Builds a script which, when run, will stream an uncompressed tarball of a Docker image to stdout. The arguments to this function are as for <code class="literal">buildLayeredImage</code>. This method of constructing an image does not realize the image into the Nix store, so it saves on IO and disk/cache space, particularly with large images.
     </p><p>
      The image produced by running the output script can be piped directly into <code class="literal">docker load</code>, to load it into the local docker daemon:
     </p><pre class="programlisting">
$(nix-build) | docker load
</pre><p>
      Alternatively, the image be piped via <code class="literal">gzip</code> into <code class="literal">skopeo</code>, e.g. to copy it into a registry:
     </p><pre class="programlisting">
$(nix-build) | gzip --fast | skopeo copy docker-archive:/dev/stdin docker://some_docker_registry/myimage:tag
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-dockerTools-fetchFromRegistry"></a>14.2.4. pullImage</h3></div></div></div><p>
      This function is analogous to the <code class="literal">docker pull</code> command, in that it can be used to pull a Docker image from a Docker registry. By default <a class="link" href="https://hub.docker.com/" target="_top">Docker Hub</a> is used to pull images.
     </p><p>
      Its parameters are described in the example below:
     </p><pre class="programlisting">
pullImage {
  imageName = "nixos/nix";
  imageDigest =
    "sha256:20d9485b25ecfd89204e843a962c1bd70e9cc6858d65d7f5fadc340246e2116b";
  finalImageName = "nix";
  finalImageTag = "1.11";
  sha256 = "0mqjy3zq2v6rrhizgb9nvhczl87lcfphq9601wcprdika2jz7qh8";
  os = "linux";
  arch = "x86_64";
}
</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">imageName</code> specifies the name of the image to be downloaded, which can also include the registry namespace (e.g. <code class="literal">nixos</code>). This argument is required.
       </p></li><li class="listitem"><p>
        <code class="literal">imageDigest</code> specifies the digest of the image to be downloaded. This argument is required.
       </p></li><li class="listitem"><p>
        <code class="literal">finalImageName</code>, if specified, this is the name of the image to be created. Note it is never used to fetch the image since we prefer to rely on the immutable digest ID. By default it’s equal to <code class="literal">imageName</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">finalImageTag</code>, if specified, this is the tag of the image to be created. Note it is never used to fetch the image since we prefer to rely on the immutable digest ID. By default it’s <code class="literal">latest</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">sha256</code> is the checksum of the whole fetched image. This argument is required.
       </p></li><li class="listitem"><p>
        <code class="literal">os</code>, if specified, is the operating system of the fetched image. By default it’s <code class="literal">linux</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">arch</code>, if specified, is the cpu architecture of the fetched image. By default it’s <code class="literal">x86_64</code>.
       </p></li></ul></div><p>
      <code class="literal">nix-prefetch-docker</code> command can be used to get required image parameters:
     </p><pre class="programlisting">
$ nix run nixpkgs.nix-prefetch-docker -c nix-prefetch-docker --image-name mysql --image-tag 5
</pre><p>
      Since a given <code class="literal">imageName</code> may transparently refer to a manifest list of images which support multiple architectures and/or operating systems, you can supply the <code class="literal">--os</code> and <code class="literal">--arch</code> arguments to specify exactly which image you want. By default it will match the OS and architecture of the host the command is run on.
     </p><pre class="programlisting">
$ nix-prefetch-docker --image-name mysql --image-tag 5 --arch x86_64 --os linux
</pre><p>
      Desired image name and tag can be set using <code class="literal">--final-image-name</code> and <code class="literal">--final-image-tag</code> arguments:
     </p><pre class="programlisting">
$ nix-prefetch-docker --image-name mysql --image-tag 5 --final-image-name eu.gcr.io/my-project/mysql --final-image-tag prod
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-dockerTools-exportImage"></a>14.2.5. exportImage</h3></div></div></div><p>
      This function is analogous to the <code class="literal">docker export</code> command, in that it can be used to flatten a Docker image that contains multiple layers. It is in fact the result of the merge of all the layers of the image. As such, the result is suitable for being imported in Docker with <code class="literal">docker import</code>.
     </p><div class="blockquote"><blockquote class="blockquote"><p>
       <span class="strong"><strong><span class="emphasis"><em>NOTE:</em></span></strong></span> Using this function requires the <code class="literal">kvm</code> device to be available.
      </p></blockquote></div><p>
      The parameters of <code class="literal">exportImage</code> are the following:
     </p><pre class="programlisting">
exportImage {
  fromImage = someLayeredImage;
  fromImageName = null;
  fromImageTag = null;

  name = someLayeredImage.name;
}
</pre><p>
      The parameters relative to the base image have the same synopsis as described in <a class="link" href="#ssec-pkgs-dockerTools-buildImage" title="14.2.1. buildImage">buildImage</a>, except that <code class="literal">fromImage</code> is the only required argument in this case.
     </p><p>
      The <code class="literal">name</code> argument is the name of the derivation output, which defaults to <code class="literal">fromImage.name</code>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-dockerTools-shadowSetup"></a>14.2.6. shadowSetup</h3></div></div></div><p>
      This constant string is a helper for setting up the base files for managing users and groups, only if such files don’t exist already. It is suitable for being used in a <a class="link" href="#ex-dockerTools-buildImage-runAsRoot"><code class="literal">buildImage</code> <code class="literal">runAsRoot</code></a> script for cases like in the example below:
     </p><pre class="programlisting">
buildImage {
  name = "shadow-basic";

  runAsRoot = ''
    #!${pkgs.runtimeShell}
    ${shadowSetup}
    groupadd -r redis
    useradd -r -g redis redis
    mkdir /data
    chown redis:redis /data
  '';
}
</pre><p>
      Creating base files like <code class="literal">/etc/passwd</code> or <code class="literal">/etc/login.defs</code> is necessary for shadow-utils to manipulate users and groups.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pkgs-ociTools"></a>14.3. pkgs.ociTools</h2></div></div></div><p>
     <code class="literal">pkgs.ociTools</code> is a set of functions for creating containers according to the <a class="link" href="https://github.com/opencontainers/runtime-spec" target="_top">OCI container specification v1.0.0</a>. Beyond that it makes no assumptions about the container runner you choose to use to run the created container.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-ociTools-buildContainer"></a>14.3.1. buildContainer</h3></div></div></div><p>
      This function creates a simple OCI container that runs a single command inside of it. An OCI container consists of a <code class="literal">config.json</code> and a rootfs directory.The nix store of the container will contain all referenced dependencies of the given command.
     </p><p>
      The parameters of <code class="literal">buildContainer</code> with an example value are described below:
     </p><pre class="programlisting">
buildContainer {
  args = [
    (with pkgs;
      writeScript "run.sh" ''
        #!${bash}/bin/bash
        exec ${bash}/bin/bash
      '').outPath
  ];

  mounts = {
    "/data" = {
      type = "none";
      source = "/var/lib/mydata";
      options = [ "bind" ];
    };
  };

  readonly = false;
}
</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">args</code> specifies a set of arguments to run inside the container. This is the only required argument for <code class="literal">buildContainer</code>. All referenced packages inside the derivation will be made available inside the container
       </p></li><li class="listitem"><p>
        <code class="literal">mounts</code> specifies additional mount points chosen by the user. By default only a minimal set of necessary filesystems are mounted into the container (e.g procfs, cgroupfs)
       </p></li><li class="listitem"><p>
        <code class="literal">readonly</code> makes the container's rootfs read-only if it is set to true. The default value is false <code class="literal">false</code>.
       </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-pkgs-snapTools"></a>14.4. pkgs.snapTools</h2></div></div></div><p>
     <code class="literal">pkgs.snapTools</code> is a set of functions for creating Snapcraft images. Snap and Snapcraft is not used to perform these operations.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-snapTools-makeSnap-signature"></a>14.4.1. The makeSnap Function</h3></div></div></div><p>
      <code class="literal">makeSnap</code> takes a single named argument, <code class="literal">meta</code>. This argument mirrors <a class="link" href="https://docs.snapcraft.io/snap-format" target="_top">the upstream <code class="literal">snap.yaml</code> format</a> exactly.
     </p><p>
      The <code class="literal">base</code> should not be specified, as <code class="literal">makeSnap</code> will force set it.
     </p><p>
      Currently, <code class="literal">makeSnap</code> does not support creating GUI stubs.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-snapTools-build-a-snap-hello"></a>14.4.2. Build a Hello World Snap</h3></div></div></div><p>
      The following expression packages GNU Hello as a Snapcraft snap.
     </p><pre class="programlisting">
let
  inherit (import &lt;nixpkgs&gt; { }) snapTools hello;
in snapTools.makeSnap {
  meta = {
    name = "hello";
    summary = hello.meta.description;
    description = hello.meta.longDescription;
    architectures = [ "amd64" ];
    confinement = "strict";
    apps.hello.command = "${hello}/bin/hello";
  };
}
</pre><p>
      <code class="literal">nix-build</code> this expression and install it with <code class="literal">snap install ./result --dangerous</code>. <code class="literal">hello</code> will now be the Snapcraft version of the package.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-pkgs-snapTools-build-a-snap-firefox"></a>14.4.3. Build a Graphical Snap</h3></div></div></div><p>
      Graphical programs require many more integrations with the host. This example uses Firefox as an example, because it is one of the most complicated programs we could package.
     </p><pre class="programlisting">
let
  inherit (import &lt;nixpkgs&gt; { }) snapTools firefox;
in snapTools.makeSnap {
  meta = {
    name = "nix-example-firefox";
    summary = firefox.meta.description;
    architectures = [ "amd64" ];
    apps.nix-example-firefox = {
      command = "${firefox}/bin/firefox";
      plugs = [
        "pulseaudio"
        "camera"
        "browser-support"
        "avahi-observe"
        "cups-control"
        "desktop"
        "desktop-legacy"
        "gsettings"
        "home"
        "network"
        "mount-observe"
        "removable-media"
        "x11"
      ];
    };
    confinement = "strict";
  };
}
</pre><p>
      <code class="literal">nix-build</code> this expression and install it with <code class="literal">snap install ./result --dangerous</code>. <code class="literal">nix-example-firefox</code> will now be the Snapcraft version of the Firefox package.
     </p><p>
      The specific meaning behind plugs can be looked up in the <a class="link" href="https://docs.snapcraft.io/supported-interfaces" target="_top">Snapcraft interface documentation</a>.
     </p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-language-support"></a>Chapter 15. Languages and frameworks</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#agda">15.1. Agda</a></span></dt><dt><span class="section"><a href="#android">15.2. Android</a></span></dt><dt><span class="section"><a href="#sec-beam">15.3. BEAM Languages (Erlang, Elixir &amp; LFE)</a></span></dt><dt><span class="section"><a href="#sec-bower">15.4. Bower</a></span></dt><dt><span class="section"><a href="#sec-language-coq">15.5. Coq and coq packages</a></span></dt><dt><span class="section"><a href="#crystal">15.6. Crystal</a></span></dt><dt><span class="section"><a href="#sec-language-dhall">15.7. Dhall</a></span></dt><dt><span class="section"><a href="#emscripten">15.8. Emscripten</a></span></dt><dt><span class="section"><a href="#sec-language-gnome">15.9. GNOME</a></span></dt><dt><span class="section"><a href="#sec-language-go">15.10. Go</a></span></dt><dt><span class="section"><a href="#haskell">15.11. Haskell</a></span></dt><dt><span class="section"><a href="#idris">15.12. Idris</a></span></dt><dt><span class="section"><a href="#ios">15.13. iOS</a></span></dt><dt><span class="section"><a href="#sec-language-java">15.14. Java</a></span></dt><dt><span class="section"><a href="#users-guide-to-lua-infrastructure">15.15. User’s Guide to Lua Infrastructure</a></span></dt><dt><span class="section"><a href="#maven">15.16. Maven</a></span></dt><dt><span class="section"><a href="#node.js">15.17. Node.js</a></span></dt><dt><span class="section"><a href="#sec-language-ocaml">15.18. OCaml</a></span></dt><dt><span class="section"><a href="#sec-language-perl">15.19. Perl</a></span></dt><dt><span class="section"><a href="#sec-php">15.20. PHP</a></span></dt><dt><span class="section"><a href="#python">15.21. Python</a></span></dt><dt><span class="section"><a href="#sec-language-qt">15.22. Qt</a></span></dt><dt><span class="section"><a href="#r">15.23. R</a></span></dt><dt><span class="section"><a href="#sec-language-ruby">15.24. Ruby</a></span></dt><dt><span class="section"><a href="#rust">15.25. Rust</a></span></dt><dt><span class="section"><a href="#sec-language-texlive">15.26. TeX Live</a></span></dt><dt><span class="section"><a href="#titanium">15.27. Titanium</a></span></dt><dt><span class="section"><a href="#vim">15.28. Vim</a></span></dt></dl></div><p>
    The <a class="link" href="#chap-stdenv" title="Chapter 6. The Standard Environment">standard build environment</a> makes it easy to build typical Autotools-based packages with very little code. Any other kind of package can be accomodated by overriding the appropriate phases of <code class="literal">stdenv</code>. However, there are specialised functions in Nixpkgs to easily build packages for other programming languages, such as Perl or Haskell. These are described in this chapter.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="agda"></a>15.1. Agda</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="how-to-use-agda"></a>15.1.1. How to use Agda</h3></div></div></div><p>
      Agda is available as the <a class="link" href="https://search.nixos.org/packages?channel=unstable&amp;show=agda&amp;from=0&amp;size=30&amp;sort=relevance&amp;query=agda" target="_top">agda</a> package.
     </p><p>
      The <code class="literal">agda</code> package installs an Agda-wrapper, which calls <code class="literal">agda</code> with <code class="literal">--library-file</code> set to a generated library-file within the nix store, this means your library-file in <code class="literal">$HOME/.agda/libraries</code> will be ignored. By default the agda package installs Agda with no libraries, i.e. the generated library-file is empty. To use Agda with libraries, the <code class="literal">agda.withPackages</code> function can be used. This function either takes:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        A list of packages,
       </p></li><li class="listitem"><p>
        or a function which returns a list of packages when given the <code class="literal">agdaPackages</code> attribute set,
       </p></li><li class="listitem"><p>
        or an attribute set containing a list of packages and a GHC derivation for compilation (see below).
       </p></li><li class="listitem"><p>
        or an attribute set containing a function which returns a list of packages when given the <code class="literal">agdaPackages</code> attribute set and a GHC derivation for compilation (see below).
       </p></li></ul></div><p>
      For example, suppose we wanted a version of Agda which has access to the standard library. This can be obtained with the expressions:
     </p><pre class="programlisting">
agda.withPackages [ agdaPackages.standard-library ]
</pre><p>
      or
     </p><pre class="programlisting">
agda.withPackages (p: [ p.standard-library ])
</pre><p>
      or can be called as in the <a class="link" href="#compiling-agda" title="15.1.2. Compiling Agda">Compiling Agda</a> section.
     </p><p>
      If you want to use a different version of a library (for instance a development version) override the <code class="literal">src</code> attribute of the package to point to your local repository
     </p><pre class="programlisting">
agda.withPackages (p: [
  (p.standard-library.overrideAttrs (oldAttrs: {
    version = "local version";
    src = /path/to/local/repo/agda-stdlib;
  }))
])
</pre><p>
      You can also reference a GitHub repository
     </p><pre class="programlisting">
agda.withPackages (p: [
  (p.standard-library.overrideAttrs (oldAttrs: {
    version = "1.5";
    src =  fetchFromGitHub {
      repo = "agda-stdlib";
      owner = "agda";
      rev = "v1.5";
      sha256 = "16fcb7ssj6kj687a042afaa2gq48rc8abihpm14k684ncihb2k4w";
    };
  }))
])
</pre><p>
      If you want to use a library not added to Nixpkgs, you can add a dependency to a local library by calling <code class="literal">agdaPackages.mkDerivation</code>.
     </p><pre class="programlisting">
agda.withPackages (p: [
  (p.mkDerivation {
    pname = "your-agda-lib";
    version = "1.0.0";
    src = /path/to/your-agda-lib;
  })
])
</pre><p>
      Again you can reference GitHub
     </p><pre class="programlisting">
agda.withPackages (p: [
  (p.mkDerivation {
    pname = "your-agda-lib";
    version = "1.0.0";
    src = fetchFromGitHub {
      repo = "repo";
      owner = "owner";
      version = "...";
      rev = "...";
      sha256 = "...";
    };
  })
])
</pre><p>
      See <a class="link" href="#building-agda-packages" title="15.1.3.1. Building Agda packages">Building Agda Packages</a> for more information on <code class="literal">mkDerivation</code>.
     </p><p>
      Agda will not by default use these libraries. To tell Agda to use a library we have some options:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        Call <code class="literal">agda</code> with the library flag:
       </p></li></ul></div><pre class="programlisting">
$ agda -l standard-library -i . MyFile.agda
</pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        Write a <code class="literal">my-library.agda-lib</code> file for the project you are working on which may look like:
       </p></li></ul></div><pre class="programlisting">
name: my-library
include: .
depend: standard-library
</pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        Create the file <code class="literal">~/.agda/defaults</code> and add any libraries you want to use by default.
       </p></li></ul></div><p>
      More information can be found in the <a class="link" href="https://agda.readthedocs.io/en/v2.6.1/tools/package-system.html" target="_top">official Agda documentation on library management</a>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="compiling-agda"></a>15.1.2. Compiling Agda</h3></div></div></div><p>
      Agda modules can be compiled using the GHC backend with the <code class="literal">--compile</code> flag. A version of <code class="literal">ghc</code> with <code class="literal">ieee754</code> is made available to the Agda program via the <code class="literal">--with-compiler</code> flag. This can be overridden by a different version of <code class="literal">ghc</code> as follows:
     </p><pre class="programlisting">
agda.withPackages {
  pkgs = [ ... ];
  ghc = haskell.compiler.ghcHEAD;
}
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="writing-agda-packages"></a>15.1.3. Writing Agda packages</h3></div></div></div><p>
      To write a nix derivation for an Agda library, first check that the library has a <code class="literal">*.agda-lib</code> file.
     </p><p>
      A derivation can then be written using <code class="literal">agdaPackages.mkDerivation</code>. This has similar arguments to <code class="literal">stdenv.mkDerivation</code> with the following additions:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">everythingFile</code> can be used to specify the location of the <code class="literal">Everything.agda</code> file, defaulting to <code class="literal">./Everything.agda</code>. If this file does not exist then either it should be patched in or the <code class="literal">buildPhase</code> should be overridden (see below).
       </p></li><li class="listitem"><p>
        <code class="literal">libraryName</code> should be the name that appears in the <code class="literal">*.agda-lib</code> file, defaulting to <code class="literal">pname</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">libraryFile</code> should be the file name of the <code class="literal">*.agda-lib</code> file, defaulting to <code class="literal">${libraryName}.agda-lib</code>.
       </p></li></ul></div><p>
      Here is an example <code class="literal">default.nix</code>
     </p><pre class="programlisting">
{ nixpkgs ?  &lt;nixpkgs&gt; }:
with (import nixpkgs {});
agdaPackages.mkDerivation {
  version = "1.0";
  pname = "my-agda-lib";
  src = ./.;
  buildInputs = [
    agdaPackages.standard-library
  ];
}
</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="building-agda-packages"></a>15.1.3.1. Building Agda packages</h4></div></div></div><p>
       The default build phase for <code class="literal">agdaPackages.mkDerivation</code> simply runs <code class="literal">agda</code> on the <code class="literal">Everything.agda</code> file. If something else is needed to build the package (e.g. <code class="literal">make</code>) then the <code class="literal">buildPhase</code> should be overridden. Additionally, a <code class="literal">preBuild</code> or <code class="literal">configurePhase</code> can be used if there are steps that need to be done prior to checking the <code class="literal">Everything.agda</code> file. <code class="literal">agda</code> and the Agda libraries contained in <code class="literal">buildInputs</code> are made available during the build phase.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="installing-agda-packages"></a>15.1.3.2. Installing Agda packages</h4></div></div></div><p>
       The default install phase copies Agda source files, Agda interface files (<code class="literal">*.agdai</code>) and <code class="literal">*.agda-lib</code> files to the output directory. This can be overridden.
      </p><p>
       By default, Agda sources are files ending on <code class="literal">.agda</code>, or literate Agda files ending on <code class="literal">.lagda</code>, <code class="literal">.lagda.tex</code>, <code class="literal">.lagda.org</code>, <code class="literal">.lagda.md</code>, <code class="literal">.lagda.rst</code>. The list of recognised Agda source extensions can be extended by setting the <code class="literal">extraExtensions</code> config variable.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding-agda-packages-to-nixpkgs"></a>15.1.4. Adding Agda packages to Nixpkgs</h3></div></div></div><p>
      To add an Agda package to <code class="literal">nixpkgs</code>, the derivation should be written to <code class="literal">pkgs/development/libraries/agda/${library-name}/</code> and an entry should be added to <code class="literal">pkgs/top-level/agda-packages.nix</code>. Here it is called in a scope with access to all other Agda libraries, so the top line of the <code class="literal">default.nix</code> can look like:
     </p><pre class="programlisting">
{ mkDerivation, standard-library, fetchFromGitHub }:
</pre><p>
      Note that the derivation function is called with <code class="literal">mkDerivation</code> set to <code class="literal">agdaPackages.mkDerivation</code>, therefore you could use a similar set as in your <code class="literal">default.nix</code> from <a class="link" href="#writing-agda-packages" title="15.1.3. Writing Agda packages">Writing Agda Packages</a> with <code class="literal">agdaPackages.mkDerivation</code> replaced with <code class="literal">mkDerivation</code>.
     </p><p>
      Here is an example skeleton derivation for iowa-stdlib:
     </p><pre class="programlisting">
mkDerivation {
  version = "1.5.0";
  pname = "iowa-stdlib";

  src = ...

  libraryFile = "";
  libraryName = "IAL-1.3";

  buildPhase = ''
    patchShebangs find-deps.sh
    make
  '';
}
</pre><p>
      This library has a file called <code class="literal">.agda-lib</code>, and so we give an empty string to <code class="literal">libraryFile</code> as nothing precedes <code class="literal">.agda-lib</code> in the filename. This file contains <code class="literal">name: IAL-1.3</code>, and so we let <code class="literal">libraryName = "IAL-1.3"</code>. This library does not use an <code class="literal">Everything.agda</code> file and instead has a Makefile, so there is no need to set <code class="literal">everythingFile</code> and we set a custom <code class="literal">buildPhase</code>.
     </p><p>
      When writing an Agda package it is essential to make sure that no <code class="literal">.agda-lib</code> file gets added to the store as a single file (for example by using <code class="literal">writeText</code>). This causes Agda to think that the nix store is a Agda library and it will attempt to write to it whenever it typechecks something. See <a class="link" href="https://github.com/agda/agda/issues/4613" target="_top">https://github.com/agda/agda/issues/4613</a>.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="android"></a>15.2. Android</h2></div></div></div><p>
     The Android build environment provides three major features and a number of supporting features.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="deploying-an-android-sdk-installation-with-plugins"></a>15.2.1. Deploying an Android SDK installation with plugins</h3></div></div></div><p>
      The first use case is deploying the SDK with a desired set of plugins or subsets of an SDK.
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

let
  androidComposition = androidenv.composeAndroidPackages {
    toolsVersion = "26.1.1";
    platformToolsVersion = "30.0.5";
    buildToolsVersions = [ "30.0.3" ];
    includeEmulator = false;
    emulatorVersion = "30.3.4";
    platformVersions = [ "28" "29" "30" ];
    includeSources = false;
    includeSystemImages = false;
    systemImageTypes = [ "google_apis_playstore" ];
    abiVersions = [ "armeabi-v7a" "arm64-v8a" ];
    cmakeVersions = [ "3.10.2" ];
    includeNDK = true;
    ndkVersions = ["22.0.7026061"];
    useGoogleAPIs = false;
    useGoogleTVAddOns = false;
    includeExtras = [
      "extras;google;gcm"
    ];
  };
in
androidComposition.androidsdk
</pre><p>
      The above function invocation states that we want an Android SDK with the above specified plugin versions. By default, most plugins are disabled. Notable exceptions are the tools, platform-tools and build-tools sub packages.
     </p><p>
      The following parameters are supported:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">toolsVersion</code>, specifies the version of the tools package to use
       </p></li><li class="listitem"><p>
        <code class="literal">platformsToolsVersion</code> specifies the version of the <code class="literal">platform-tools</code> plugin
       </p></li><li class="listitem"><p>
        <code class="literal">buildToolsVersions</code> specifies the versions of the <code class="literal">build-tools</code> plugins to use.
       </p></li><li class="listitem"><p>
        <code class="literal">includeEmulator</code> specifies whether to deploy the emulator package (<code class="literal">false</code> by default). When enabled, the version of the emulator to deploy can be specified by setting the <code class="literal">emulatorVersion</code> parameter.
       </p></li><li class="listitem"><p>
        <code class="literal">cmakeVersions</code> specifies which CMake versions should be deployed.
       </p></li><li class="listitem"><p>
        <code class="literal">includeNDK</code> specifies that the Android NDK bundle should be included. Defaults to: <code class="literal">false</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">ndkVersions</code> specifies the NDK versions that we want to use. These are linked under the <code class="literal">ndk</code> directory of the SDK root, and the first is linked under the <code class="literal">ndk-bundle</code> directory.
       </p></li><li class="listitem"><p>
        <code class="literal">ndkVersion</code> is equivalent to specifying one entry in <code class="literal">ndkVersions</code>, and <code class="literal">ndkVersions</code> overrides this parameter if provided.
       </p></li><li class="listitem"><p>
        <code class="literal">includeExtras</code> is an array of identifier strings referring to arbitrary add-on packages that should be installed.
       </p></li><li class="listitem"><p>
        <code class="literal">platformVersions</code> specifies which platform SDK versions should be included.
       </p></li></ul></div><p>
      For each platform version that has been specified, we can apply the following options:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">includeSystemImages</code> specifies whether a system image for each platform SDK should be included.
       </p></li><li class="listitem"><p>
        <code class="literal">includeSources</code> specifies whether the sources for each SDK version should be included.
       </p></li><li class="listitem"><p>
        <code class="literal">useGoogleAPIs</code> specifies that for each selected platform version the Google API should be included.
       </p></li><li class="listitem"><p>
        <code class="literal">useGoogleTVAddOns</code> specifies that for each selected platform version the Google TV add-on should be included.
       </p></li></ul></div><p>
      For each requested system image we can specify the following options:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">systemImageTypes</code> specifies what kind of system images should be included. Defaults to: <code class="literal">default</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">abiVersions</code> specifies what kind of ABI version of each system image should be included. Defaults to: <code class="literal">armeabi-v7a</code>.
       </p></li></ul></div><p>
      Most of the function arguments have reasonable default settings.
     </p><p>
      You can specify license names:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">extraLicenses</code> is a list of license names. You can get these names from repo.json or <code class="literal">querypackages.sh licenses</code>. The SDK license (<code class="literal">android-sdk-license</code>) is accepted for you if you set accept_license to true. If you are doing something like working with preview SDKs, you will want to add <code class="literal">android-sdk-preview-license</code> or whichever license applies here.
       </p></li></ul></div><p>
      Additionally, you can override the repositories that composeAndroidPackages will pull from:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">repoJson</code> specifies a path to a generated repo.json file. You can generate this by running <code class="literal">generate.sh</code>, which in turn will call into <code class="literal">mkrepo.rb</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">repoXmls</code> is an attribute set containing paths to repo XML files. If specified, it takes priority over <code class="literal">repoJson</code>, and will trigger a local build writing out a repo.json to the Nix store based on the given repository XMLs.
       </p></li></ul></div><pre class="programlisting">
repoXmls = {
  packages = [ ./xml/repository2-1.xml ];
  images = [
    ./xml/android-sys-img2-1.xml
    ./xml/android-tv-sys-img2-1.xml
    ./xml/android-wear-sys-img2-1.xml
    ./xml/android-wear-cn-sys-img2-1.xml
    ./xml/google_apis-sys-img2-1.xml
    ./xml/google_apis_playstore-sys-img2-1.xml
  ];
  addons = [ ./xml/addon2-1.xml ];
};
</pre><p>
      When building the above expression with:
     </p><pre class="programlisting">
$ nix-build
</pre><p>
      The Android SDK gets deployed with all desired plugin versions.
     </p><p>
      We can also deploy subsets of the Android SDK. For example, to only the <code class="literal">platform-tools</code> package, you can evaluate the following expression:
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

let
  androidComposition = androidenv.composeAndroidPackages {
    # ...
  };
in
androidComposition.platform-tools
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="using-predefined-android-package-compositions"></a>15.2.2. Using predefined Android package compositions</h3></div></div></div><p>
      In addition to composing an Android package set manually, it is also possible to use a predefined composition that contains all basic packages for a specific Android version, such as version 9.0 (API-level 28).
     </p><p>
      The following Nix expression can be used to deploy the entire SDK with all basic plugins:
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

androidenv.androidPkgs_9_0.androidsdk
</pre><p>
      It is also possible to use one plugin only:
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

androidenv.androidPkgs_9_0.platform-tools
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="building-an-android-application"></a>15.2.3. Building an Android application</h3></div></div></div><p>
      In addition to the SDK, it is also possible to build an Ant-based Android project and automatically deploy all the Android plugins that a project requires.
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

androidenv.buildApp {
  name = "MyAndroidApp";
  src = ./myappsources;
  release = true;

  # If release is set to true, you need to specify the following parameters
  keyStore = ./keystore;
  keyAlias = "myfirstapp";
  keyStorePassword = "mykeystore";
  keyAliasPassword = "myfirstapp";

  # Any Android SDK parameters that install all the relevant plugins that a
  # build requires
  platformVersions = [ "24" ];

  # When we include the NDK, then ndk-build is invoked before Ant gets invoked
  includeNDK = true;
}
</pre><p>
      Aside from the app-specific build parameters (<code class="literal">name</code>, <code class="literal">src</code>, <code class="literal">release</code> and keystore parameters), the <code class="literal">buildApp {}</code> function supports all the function parameters that the SDK composition function (the function shown in the previous section) supports.
     </p><p>
      This build function is particularly useful when it is desired to use <a class="link" href="https://nixos.org/hydra" target="_top">Hydra</a>: the Nix-based continuous integration solution to build Android apps. An Android APK gets exposed as a build product and can be installed on any Android device with a web browser by navigating to the build result page.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="spawning-emulator-instances"></a>15.2.4. Spawning emulator instances</h3></div></div></div><p>
      For testing purposes, it can also be quite convenient to automatically generate scripts that spawn emulator instances with all desired configuration settings.
     </p><p>
      An emulator spawn script can be configured by invoking the <code class="literal">emulateApp {}</code> function:
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

androidenv.emulateApp {
  name = "emulate-MyAndroidApp";
  platformVersion = "28";
  abiVersion = "x86"; # armeabi-v7a, mips, x86_64
  systemImageType = "google_apis_playstore";
}
</pre><p>
      Additional flags may be applied to the Android SDK’s emulator through the runtime environment variable <code class="literal">$NIX_ANDROID_EMULATOR_FLAGS</code>.
     </p><p>
      It is also possible to specify an APK to deploy inside the emulator and the package and activity names to launch it:
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

androidenv.emulateApp {
  name = "emulate-MyAndroidApp";
  platformVersion = "24";
  abiVersion = "armeabi-v7a"; # mips, x86, x86_64
  systemImageType = "default";
  useGoogleAPIs = false;
  app = ./MyApp.apk;
  package = "MyApp";
  activity = "MainActivity";
}
</pre><p>
      In addition to prebuilt APKs, you can also bind the APK parameter to a <code class="literal">buildApp {}</code> function invocation shown in the previous example.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="notes-on-environment-variables-in-android-projects"></a>15.2.5. Notes on environment variables in Android projects</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">ANDROID_SDK_ROOT</code> should point to the Android SDK. In your Nix expressions, this should be <code class="literal">${androidComposition.androidsdk}/libexec/android-sdk</code>. Note that <code class="literal">ANDROID_HOME</code> is deprecated, but if you rely on tools that need it, you can export it too.
       </p></li><li class="listitem"><p>
        <code class="literal">ANDROID_NDK_ROOT</code> should point to the Android NDK, if you’re doing NDK development. In your Nix expressions, this should be <code class="literal">${ANDROID_SDK_ROOT}/ndk-bundle</code>.
       </p></li></ul></div><p>
      If you are running the Android Gradle plugin, you need to export GRADLE_OPTS to override aapt2 to point to the aapt2 binary in the Nix store as well, or use a FHS environment so the packaged aapt2 can run. If you don’t want to use a FHS environment, something like this should work:
     </p><pre class="programlisting">
let
  buildToolsVersion = "30.0.3";

  # Use buildToolsVersion when you define androidComposition
  androidComposition = &lt;...&gt;;
in
pkgs.mkShell rec {
  ANDROID_SDK_ROOT = "${androidComposition.androidsdk}/libexec/android-sdk";
  ANDROID_NDK_ROOT = "${ANDROID_SDK_ROOT}/ndk-bundle";

  # Use the same buildToolsVersion here
  GRADLE_OPTS = "-Dorg.gradle.project.android.aapt2FromMavenOverride=${ANDROID_SDK_ROOT}/build-tools/${buildToolsVersion}/aapt2";
}
</pre><p>
      If you are using cmake, you need to add it to PATH in a shell hook or FHS env profile. The path is suffixed with a build number, but properly prefixed with the version. So, something like this should suffice:
     </p><pre class="programlisting">
let
  cmakeVersion = "3.10.2";

  # Use cmakeVersion when you define androidComposition
  androidComposition = &lt;...&gt;;
in
pkgs.mkShell rec {
  ANDROID_SDK_ROOT = "${androidComposition.androidsdk}/libexec/android-sdk";
  ANDROID_NDK_ROOT = "${ANDROID_SDK_ROOT}/ndk-bundle";

  # Use the same cmakeVersion here
  shellHook = ''
    export PATH="$(echo "$ANDROID_SDK_ROOT/cmake/${cmakeVersion}".*/bin):$PATH"
  '';
}
</pre><p>
      Note that running Android Studio with ANDROID_SDK_ROOT set will automatically write a <code class="literal">local.properties</code> file with <code class="literal">sdk.dir</code> set to $ANDROID_SDK_ROOT if one does not already exist. If you are using the NDK as well, you may have to add <code class="literal">ndk.dir</code> to this file.
     </p><p>
      An example shell.nix that does all this for you is provided in examples/shell.nix. This shell.nix includes a shell hook that overwrites local.properties with the correct sdk.dir and ndk.dir values. This will ensure that the SDK and NDK directories will both be correct when you run Android Studio inside nix-shell.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="notes-on-improving-build.gradle-compatibility"></a>15.2.6. Notes on improving build.gradle compatibility</h3></div></div></div><p>
      Ensure that your buildToolsVersion and ndkVersion match what is declared in androidenv. If you are using cmake, make sure its declared version is correct too.
     </p><p>
      Otherwise, you may get cryptic errors from aapt2 and the Android Gradle plugin warning that it cannot install the build tools because the SDK directory is not writeable.
     </p><pre class="programlisting">
android {
    buildToolsVersion "30.0.3"
    ndkVersion = "22.0.7026061"
    externalNativeBuild {
        cmake {
            version "3.10.2"
        }
    }
}
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="querying-the-available-versions-of-each-plugin"></a>15.2.7. Querying the available versions of each plugin</h3></div></div></div><p>
      repo.json provides all the options in one file now.
     </p><p>
      A shell script in the <code class="literal">pkgs/development/mobile/androidenv/</code> subdirectory can be used to retrieve all possible options:
     </p><pre class="programlisting">
./querypackages.sh packages
</pre><p>
      The above command-line instruction queries all package versions in repo.json.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="updating-the-generated-expressions"></a>15.2.8. Updating the generated expressions</h3></div></div></div><p>
      repo.json is generated from XML files that the Android Studio package manager uses. To update the expressions run the <code class="literal">generate.sh</code> script that is stored in the <code class="literal">pkgs/development/mobile/androidenv/</code> subdirectory:
     </p><pre class="programlisting">
./generate.sh
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-beam"></a>15.3. BEAM Languages (Erlang, Elixir &amp; LFE)</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="beam-introduction"></a>15.3.1. Introduction</h3></div></div></div><p>
      In this document and related Nix expressions, we use the term, <span class="emphasis"><em>BEAM</em></span>, to describe the environment. BEAM is the name of the Erlang Virtual Machine and, as far as we’re concerned, from a packaging perspective, all languages that run on the BEAM are interchangeable. That which varies, like the build system, is transparent to users of any given BEAM package, so we make no distinction.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="beam-structure"></a>15.3.2. Structure</h3></div></div></div><p>
      All BEAM-related expressions are available via the top-level <code class="literal">beam</code> attribute, which includes:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">interpreters</code>: a set of compilers running on the BEAM, including multiple Erlang/OTP versions (<code class="literal">beam.interpreters.erlangR22</code>, etc), Elixir (<code class="literal">beam.interpreters.elixir</code>) and LFE (Lisp Flavoured Erlang) (<code class="literal">beam.interpreters.lfe</code>).
       </p></li><li class="listitem"><p>
        <code class="literal">packages</code>: a set of package builders (Mix and rebar3), each compiled with a specific Erlang/OTP version, e.g. <code class="literal">beam.packages.erlang22</code>.
       </p></li></ul></div><p>
      The default Erlang compiler, defined by <code class="literal">beam.interpreters.erlang</code>, is aliased as <code class="literal">erlang</code>. The default BEAM package set is defined by <code class="literal">beam.packages.erlang</code> and aliased at the top level as <code class="literal">beamPackages</code>.
     </p><p>
      To create a package builder built with a custom Erlang version, use the lambda, <code class="literal">beam.packagesWith</code>, which accepts an Erlang/OTP derivation and produces a package builder similar to <code class="literal">beam.packages.erlang</code>.
     </p><p>
      Many Erlang/OTP distributions available in <code class="literal">beam.interpreters</code> have versions with ODBC and/or Java enabled or without wx (no observer support). For example, there’s <code class="literal">beam.interpreters.erlangR22_odbc_javac</code>, which corresponds to <code class="literal">beam.interpreters.erlangR22</code> and <code class="literal">beam.interpreters.erlangR22_nox</code>, which corresponds to <code class="literal">beam.interpreters.erlangR22</code>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="build-tools"></a>15.3.3. Build Tools</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="build-tools-rebar3"></a>15.3.3.1. Rebar3</h4></div></div></div><p>
       We provide a version of Rebar3, under <code class="literal">rebar3</code>. We also provide a helper to fetch Rebar3 dependencies from a lockfile under <code class="literal">fetchRebar3Deps</code>.
      </p><p>
       We also provide a version on Rebar3 with plugins included, under <code class="literal">rebar3WithPlugins</code>. This package is a function which takes two arguments: <code class="literal">plugins</code>, a list of nix derivations to include as plugins (loaded only when specified in <code class="literal">rebar.config</code>), and <code class="literal">globalPlugins</code>, which should always be loaded by rebar3. Example: <code class="literal">rebar3WithPlugins { globalPlugins = [beamPackages.pc]; }</code>.
      </p><p>
       When adding a new plugin it is important that the <code class="literal">packageName</code> attribute is the same as the atom used by rebar3 to refer to the plugin.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="build-tools-other"></a>15.3.3.2. Mix &amp; Erlang.mk</h4></div></div></div><p>
       Erlang.mk works exactly as expected. There is a bootstrap process that needs to be run, which is supported by the <code class="literal">buildErlangMk</code> derivation.
      </p><p>
       For Elixir applications use <code class="literal">mixRelease</code> to make a release. See examples for more details.
      </p><p>
       There is also a <code class="literal">buildMix</code> helper, whose behavior is closer to that of <code class="literal">buildErlangMk</code> and <code class="literal">buildRebar3</code>. The primary difference is that mixRelease makes a release, while buildMix only builds the package, making it useful for libraries and other dependencies.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="how-to-install-beam-packages"></a>15.3.4. How to Install BEAM Packages</h3></div></div></div><p>
      BEAM builders are not registered at the top level, simply because they are not relevant to the vast majority of Nix users. To install any of those builders into your profile, refer to them by their attribute path <code class="literal">beamPackages.rebar3</code>:
     </p><pre class="programlisting">
$ nix-env -f "&lt;nixpkgs&gt;" -iA beamPackages.rebar3
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="packaging-beam-applications"></a>15.3.5. Packaging BEAM Applications</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="packaging-erlang-applications"></a>15.3.5.1. Erlang Applications</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="rebar3-packages"></a>15.3.5.1.1. Rebar3 Packages</h5></div></div></div><p>
        The Nix function, <code class="literal">buildRebar3</code>, defined in <code class="literal">beam.packages.erlang.buildRebar3</code> and aliased at the top level, can be used to build a derivation that understands how to build a Rebar3 project.
       </p><p>
        If a package needs to compile native code via Rebar3’s port compilation mechanism, add <code class="literal">compilePort = true;</code> to the derivation.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="erlang-mk-packages"></a>15.3.5.1.2. Erlang.mk Packages</h5></div></div></div><p>
        Erlang.mk functions similarly to Rebar3, except we use <code class="literal">buildErlangMk</code> instead of <code class="literal">buildRebar3</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="mix-packages"></a>15.3.5.1.3. Mix Packages</h5></div></div></div><p>
        <code class="literal">mixRelease</code> is used to make a release in the mix sense. Dependencies will need to be fetched with <code class="literal">fetchMixDeps</code> and passed to it.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="mixrelease---elixir-phoenix-example"></a>15.3.5.1.4. mixRelease - Elixir Phoenix example</h5></div></div></div><p>
        Here is how your <code class="literal">default.nix</code> file would look.
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; { };

let
  packages = beam.packagesWith beam.interpreters.erlang;
  src = builtins.fetchgit {
    url = "ssh://git@github.com/your_id/your_repo";
    rev = "replace_with_your_commit";
  };

  pname = "your_project";
  version = "0.0.1";
  mixEnv = "prod";

  mixDeps = packages.fetchMixDeps {
    pname = "mix-deps-${pname}";
    inherit src mixEnv version;
    # nix will complain and tell you the right value to replace this with
    sha256 = lib.fakeSha256;
    # if you have build time environment variables add them here
    MY_ENV_VAR="my_value";
  };

  nodeDependencies = (pkgs.callPackage ./assets/default.nix { }).shell.nodeDependencies;

  frontEndFiles = stdenvNoCC.mkDerivation {
    pname = "frontend-${pname}";

    nativeBuildInputs = [ nodejs ];

    inherit version src;

    buildPhase = ''
      cp -r ./assets $TEMPDIR

      mkdir -p $TEMPDIR/assets/node_modules/.cache
      cp -r ${nodeDependencies}/lib/node_modules $TEMPDIR/assets
      export PATH="${nodeDependencies}/bin:$PATH"

      cd $TEMPDIR/assets
      webpack --config ./webpack.config.js
      cd ..
    '';

    installPhase = ''
      cp -r ./priv/static $out/
    '';

    outputHashAlgo = "sha256";
    outputHashMode = "recursive";
    # nix will complain and tell you the right value to replace this with
    outputHash = lib.fakeSha256;

    impureEnvVars = lib.fetchers.proxyImpureEnvVars;
  };


in packages.mixRelease {
  inherit src pname version mixEnv mixDeps;
  # if you have build time environment variables add them here
  MY_ENV_VAR="my_value";
  preInstall = ''
    mkdir -p ./priv/static
    cp -r ${frontEndFiles} ./priv/static
  '';
}
</pre><p>
        Setup will require the following steps:
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          Move your secrets to runtime environment variables. For more information refer to the <a class="link" href="https://hexdocs.pm/mix/Mix.Tasks.Release.html#module-runtime-configuration" target="_top">runtime.exs docs</a>. On a fresh Phoenix build that would mean that both <code class="literal">DATABASE_URL</code> and <code class="literal">SECRET_KEY</code> need to be moved to <code class="literal">runtime.exs</code>.
         </p></li><li class="listitem"><p>
          <code class="literal">cd assets</code> and <code class="literal">nix-shell -p node2nix --run node2nix --development</code> will generate a Nix expression containing your frontend dependencies
         </p></li><li class="listitem"><p>
          commit and push those changes
         </p></li><li class="listitem"><p>
          you can now <code class="literal">nix-build .</code>
         </p></li><li class="listitem"><p>
          To run the release, set the <code class="literal">RELEASE_TMP</code> environment variable to a directory that your program has write access to. It will be used to store the BEAM settings.
         </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="example-of-creating-a-service-for-an-elixir---phoenix-project"></a>15.3.5.1.5. Example of creating a service for an Elixir - Phoenix project</h5></div></div></div><p>
        In order to create a service with your release, you could add a <code class="literal">service.nix</code> in your project with the following
       </p><pre class="programlisting">
{config, pkgs, lib, ...}:

let
  release = pkgs.callPackage ./default.nix;
  release_name = "app";
  working_directory = "/home/app";
in
{
  systemd.services.${release_name} = {
    wantedBy = [ "multi-user.target" ];
    after = [ "network.target" "postgresql.service" ];
    requires = [ "network-online.target" "postgresql.service" ];
    description = "my app";
    environment = {
      # RELEASE_TMP is used to write the state of the
      # VM configuration when the system is running
      # it needs to be a writable directory
      RELEASE_TMP = working_directory;
      # can be generated in an elixir console with
      # Base.encode32(:crypto.strong_rand_bytes(32))
      RELEASE_COOKIE = "my_cookie";
      MY_VAR = "my_var";
    };
    serviceConfig = {
      Type = "exec";
      DynamicUser = true;
      WorkingDirectory = working_directory;
      # Implied by DynamicUser, but just to emphasize due to RELEASE_TMP
      PrivateTmp = true;
      ExecStart = ''
        ${release}/bin/${release_name} start
      '';
      ExecStop = ''
        ${release}/bin/${release_name} stop
      '';
      ExecReload = ''
        ${release}/bin/${release_name} restart
      '';
      Restart = "on-failure";
      RestartSec = 5;
      StartLimitBurst = 3;
      StartLimitInterval = 10;
    };
    # disksup requires bash
    path = [ pkgs.bash ];
  };

  environment.systemPackages = [ release ];
}
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="how-to-develop"></a>15.3.6. How to Develop</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="creating-a-shell"></a>15.3.6.1. Creating a Shell</h4></div></div></div><p>
       Usually, we need to create a <code class="literal">shell.nix</code> file and do our development inside of the environment specified therein. Just install your version of Erlang and any other interpreters, and then use your normal build tools. As an example with Elixir:
      </p><pre class="programlisting">
{ pkgs ? import "&lt;nixpkgs"&gt; {} }:

with pkgs;

let

  elixir = beam.packages.erlangR22.elixir_1_9;

in
mkShell {
  buildInputs = [ elixir ];

  ERL_INCLUDE_PATH="${erlang}/lib/erlang/usr/include";
}
</pre><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="elixir---phoenix-project"></a>15.3.6.1.1. Elixir - Phoenix project</h5></div></div></div><p>
        Here is an example <code class="literal">shell.nix</code>.
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; { };

let
  # define packages to install
  basePackages = [
    git
    # replace with beam.packages.erlang.elixir_1_11 if you need
    beam.packages.erlang.elixir
    nodejs
    postgresql_13
    # only used for frontend dependencies
    # you are free to use yarn2nix as well
    nodePackages.node2nix
    # formatting js file
    nodePackages.prettier
  ];

  inputs = basePackages ++ lib.optionals stdenv.isLinux [ inotify-tools ]
    ++ lib.optionals stdenv.isDarwin
    (with darwin.apple_sdk.frameworks; [ CoreFoundation CoreServices ]);

  # define shell startup command
  hooks = ''
    # this allows mix to work on the local directory
    mkdir -p .nix-mix .nix-hex
    export MIX_HOME=$PWD/.nix-mix
    export HEX_HOME=$PWD/.nix-mix
    export PATH=$MIX_HOME/bin:$HEX_HOME/bin:$PATH
    # TODO: not sure how to make hex available without installing it afterwards.
    mix local.hex --if-missing
    export LANG=en_US.UTF-8
    export ERL_AFLAGS="-kernel shell_history enabled"

    # postges related
    # keep all your db data in a folder inside the project
    export PGDATA="$PWD/db"

    # phoenix related env vars
    export POOL_SIZE=15
    export DB_URL="postgresql://postgres:postgres@localhost:5432/db"
    export PORT=4000
    export MIX_ENV=dev
    # add your project env vars here, word readable in the nix store.
    export ENV_VAR="your_env_var"
  '';

in mkShell {
  buildInputs = inputs;
  shellHook = hooks;
}
</pre><p>
        Initializing the project will require the following steps:
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          create the db directory <code class="literal">initdb ./db</code> (inside your mix project folder)
         </p></li><li class="listitem"><p>
          create the postgres user <code class="literal">createuser postgres -ds</code>
         </p></li><li class="listitem"><p>
          create the db <code class="literal">createdb db</code>
         </p></li><li class="listitem"><p>
          start the postgres instance <code class="literal">pg_ctl -l "$PGDATA/server.log" start</code>
         </p></li><li class="listitem"><p>
          add the <code class="literal">/db</code> folder to your <code class="literal">.gitignore</code>
         </p></li><li class="listitem"><p>
          you can start your phoenix server and get a shell with <code class="literal">iex -S mix phx.server</code>
         </p></li></ul></div></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-bower"></a>15.4. Bower</h2></div></div></div><p>
     <a class="link" href="https://bower.io" target="_top">Bower</a> is a package manager for web site front-end components. Bower packages (comprising of build artefacts and sometimes sources) are stored in <code class="literal">git</code> repositories, typically on Github. The package registry is run by the Bower team with package metadata coming from the <code class="literal">bower.json</code> file within each package.
    </p><p>
     The end result of running Bower is a <code class="literal">bower_components</code> directory which can be included in the web app’s build process.
    </p><p>
     Bower can be run interactively, by installing <code class="literal">nodePackages.bower</code>. More interestingly, the Bower components can be declared in a Nix derivation, with the help of <code class="literal">nodePackages.bower2nix</code>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-bower2nix-usage"></a>15.4.1. bower2nix usage</h3></div></div></div><p>
      Suppose you have a <code class="literal">bower.json</code> with the following contents:
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ex-bowerJson"></a>15.4.1.1. Example bower.json</h4></div></div></div><pre class="programlisting">
  "name": "my-web-app",
  "dependencies": {
    "angular": "~1.5.0",
    "bootstrap": "~3.3.6"
  }
</pre><p>
       Running <code class="literal">bower2nix</code> will produce something like the following output:
      </p><pre class="programlisting">
{ fetchbower, buildEnv }:
buildEnv { name = "bower-env"; ignoreCollisions = true; paths = [
  (fetchbower "angular" "1.5.3" "~1.5.0" "1749xb0firxdra4rzadm4q9x90v6pzkbd7xmcyjk6qfza09ykk9y")
  (fetchbower "bootstrap" "3.3.6" "~3.3.6" "1vvqlpbfcy0k5pncfjaiskj3y6scwifxygfqnw393sjfxiviwmbv")
  (fetchbower "jquery" "2.2.2" "1.9.1 - 2" "10sp5h98sqwk90y4k6hbdviwqzvzwqf47r3r51pakch5ii2y7js1")
];
</pre><p>
       Using the <code class="literal">bower2nix</code> command line arguments, the output can be redirected to a file. A name like <code class="literal">bower-packages.nix</code> would be fine.
      </p><p>
       The resulting derivation is a union of all the downloaded Bower packages (and their dependencies). To use it, they still need to be linked together by Bower, which is where <code class="literal">buildBowerComponents</code> is useful.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-build-bower-components"></a>15.4.2. buildBowerComponents function</h3></div></div></div><p>
      The function is implemented in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/bower-modules/generic/default.nix" target="_top">pkgs/development/bower-modules/generic/default.nix</a>.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ex-buildBowerComponents"></a>15.4.2.1. Example buildBowerComponents</h4></div></div></div><pre class="programlisting">
      bowerComponents = buildBowerComponents {
        name = "my-web-app";
        generated = ./bower-packages.nix; <a id="ex-buildBowerComponents-1"></a><span><img src="images/callouts/1.svg" alt="1" border="0" /></span>
        src = myWebApp; <a id="ex-buildBowerComponents-2"></a><span><img src="images/callouts/2.svg" alt="2" border="0" /></span>
      };
      </pre><p>
       In <a class="link" href="#ex-buildBowerComponents" title="15.4.2.1. Example buildBowerComponents"><span class="quote">“<span class="quote">buildBowerComponents</span>”</span> example</a> the following arguments are of special significance to the function:
      </p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#ex-buildBowerComponents-1"><span><img src="images/callouts/1.svg" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
         <code class="varname">generated</code> specifies the file which was created by <span class="command"><strong>bower2nix</strong></span>.
        </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#ex-buildBowerComponents-2"><span><img src="images/callouts/2.svg" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
         <code class="varname">src</code> is your project's sources. It needs to contain a <code class="filename">bower.json</code> file.
        </p></td></tr></table></div><p>
       <code class="literal">buildBowerComponents</code> will run Bower to link together the output of <code class="literal">bower2nix</code>, resulting in a <code class="literal">bower_components</code> directory which can be used.
      </p><p>
       Here is an example of a web frontend build process using <code class="literal">gulp</code>. You might use <code class="literal">grunt</code>, or anything else.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ex-bowerGulpFile"></a>15.4.2.2. Example build script (gulpfile.js)</h4></div></div></div><pre class="programlisting">
var gulp = require('gulp');

gulp.task('default', [], function () {
  gulp.start('build');
});

gulp.task('build', [], function () {
  console.log("Just a dummy gulp build");
  gulp
    .src(["./bower_components/**/*"])
    .pipe(gulp.dest("./gulpdist/"));
});
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ex-buildBowerComponentsDefaultNix"></a>15.4.2.3. Example Full example — default.nix</h4></div></div></div><pre class="programlisting">
      { myWebApp ? { outPath = ./.; name = "myWebApp"; }
      , pkgs ? import &lt;nixpkgs&gt; {}
      }:

      pkgs.stdenv.mkDerivation {
        name = "my-web-app-frontend";
        src = myWebApp;

        buildInputs = [ pkgs.nodePackages.gulp ];

        bowerComponents = pkgs.buildBowerComponents { <a id="ex-buildBowerComponentsDefault-1"></a><span><img src="images/callouts/1.svg" alt="1" border="0" /></span>
          name = "my-web-app";
          generated = ./bower-packages.nix;
          src = myWebApp;
        };

        buildPhase = ''
          cp --reflink=auto --no-preserve=mode -R $bowerComponents/bower_components . <a id="ex-buildBowerComponentsDefault-2"></a><span><img src="images/callouts/2.svg" alt="2" border="0" /></span>
          export HOME=$PWD <a id="ex-buildBowerComponentsDefault-3"></a><span><img src="images/callouts/3.svg" alt="3" border="0" /></span>
          ${pkgs.nodePackages.gulp}/bin/gulp build <a id="ex-buildBowerComponentsDefault-4"></a><span><img src="images/callouts/4.svg" alt="4" border="0" /></span>
        '';

        installPhase = "mv gulpdist $out";
      }
      </pre><p>
       A few notes about <a class="link" href="#ex-buildBowerComponentsDefaultNix" title="15.4.2.3. Example Full example — default.nix">Full example — <code class="literal">default.nix</code></a>:
      </p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#ex-buildBowerComponentsDefault-1"><span><img src="images/callouts/1.svg" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
         The result of <code class="varname">buildBowerComponents</code> is an input to the frontend build.
        </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#ex-buildBowerComponentsDefault-2"><span><img src="images/callouts/2.svg" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
         Whether to symlink or copy the <code class="filename">bower_components</code> directory depends on the build tool in use. In this case a copy is used to avoid <span class="command"><strong>gulp</strong></span> silliness with permissions.
        </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#ex-buildBowerComponentsDefault-3"><span><img src="images/callouts/3.svg" alt="3" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
         <span class="command"><strong>gulp</strong></span> requires <code class="varname">HOME</code> to refer to a writeable directory.
        </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#ex-buildBowerComponentsDefault-4"><span><img src="images/callouts/4.svg" alt="4" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
         The actual build command. Other tools could be used.
        </p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-bower2nix-troubleshooting"></a>15.4.3. Troubleshooting</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="enocache-errors-from-buildbowercomponents"></a>15.4.3.1. ENOCACHE errors from buildBowerComponents</h4></div></div></div><p>
       This means that Bower was looking for a package version which doesn’t exist in the generated <code class="literal">bower-packages.nix</code>.
      </p><p>
       If <code class="literal">bower.json</code> has been updated, then run <code class="literal">bower2nix</code> again.
      </p><p>
       It could also be a bug in <code class="literal">bower2nix</code> or <code class="literal">fetchbower</code>. If possible, try reformulating the version specification in <code class="literal">bower.json</code>.
      </p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-language-coq"></a>15.5. Coq and coq packages</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="coq-derivation-coq"></a>15.5.1. Coq derivation: <code class="literal">coq</code></h3></div></div></div><p>
      The Coq derivation is overridable through the <code class="literal">coq.override overrides</code>, where overrides is an attribute set which contains the arguments to override. We recommend overriding either of the following
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">version</code> (optional, defaults to the latest version of Coq selected for nixpkgs, see <code class="literal">pkgs/top-level/coq-packages</code> to witness this choice), which follows the conventions explained in the <code class="literal">coqPackages</code> section below,
       </p></li><li class="listitem"><p>
        <code class="literal">customOCamlPackage</code> (optional, defaults to <code class="literal">null</code>, which lets Coq choose a version automatically), which can be set to any of the ocaml packages attribute of <code class="literal">ocaml-ng</code> (such as <code class="literal">ocaml-ng.ocamlPackages_4_10</code> which is the default for Coq 8.11 for example).
       </p></li><li class="listitem"><p>
        <code class="literal">coq-version</code> (optional, defaults to the short version e.g. <span class="quote">“<span class="quote">8.10</span>”</span>), is a version number of the form <span class="quote">“<span class="quote">x.y</span>”</span> that indicates which Coq’s version build behavior to mimic when using a source which is not a release. E.g. <code class="literal">coq.override { version = "d370a9d1328a4e1cdb9d02ee032f605a9d94ec7a"; coq-version = "8.10"; }</code>.
       </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="coq-packages-attribute-sets-coqpackages"></a>15.5.2. Coq packages attribute sets: <code class="literal">coqPackages</code></h3></div></div></div><p>
      The recommended way of defining a derivation for a Coq library, is to use the <code class="literal">coqPackages.mkCoqDerivation</code> function, which is essentially a specialization of <code class="literal">mkDerivation</code> taking into account most of the specifics of Coq libraries. The following attributes are supported:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">pname</code> (required) is the name of the package,
       </p></li><li class="listitem"><p>
        <code class="literal">version</code> (optional, defaults to <code class="literal">null</code>), is the version to fetch and build, this attribute is interpreted in several ways depending on its type and pattern:
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          if it is a known released version string, i.e. from the <code class="literal">release</code> attribute below, the according release is picked, and the <code class="literal">version</code> attribute of the resulting derivation is set to this release string,
         </p></li><li class="listitem"><p>
          if it is a majorMinor <code class="literal">"x.y"</code> prefix of a known released version (as defined above), then the latest <code class="literal">"x.y.z"</code> known released version is selected (for the ordering given by <code class="literal">versionAtLeast</code>),
         </p></li><li class="listitem"><p>
          if it is a path or a string representing an absolute path (i.e. starting with <code class="literal">"/"</code>), the provided path is selected as a source, and the <code class="literal">version</code> attribute of the resulting derivation is set to <code class="literal">"dev"</code>,
         </p></li><li class="listitem"><p>
          if it is a string of the form <code class="literal">owner:branch</code> then it tries to download the <code class="literal">branch</code> of owner <code class="literal">owner</code> for a project of the same name using the same vcs, and the <code class="literal">version</code> attribute of the resulting derivation is set to <code class="literal">"dev"</code>, additionally if the owner is not provided (i.e. if the <code class="literal">owner:</code> prefix is missing), it defaults to the original owner of the package (see below),
         </p></li><li class="listitem"><p>
          if it is a string of the form <code class="literal">"#N"</code>, and the domain is github, then it tries to download the current head of the pull request <code class="literal">#N</code> from github,
         </p></li></ul></div></li><li class="listitem"><p>
        <code class="literal">defaultVersion</code> (optional). Coq libraries may be compatible with some specific versions of Coq only. The <code class="literal">defaultVersion</code> attribute is used when no <code class="literal">version</code> is provided (or if <code class="literal">version = null</code>) to select the version of the library to use by default, depending on the context. This selection will mainly depend on a <code class="literal">coq</code> version number but also possibly on other packages versions (e.g. <code class="literal">mathcomp</code>). If its value ends up to be <code class="literal">null</code>, the package is marked for removal in end-user <code class="literal">coqPackages</code> attribute set.
       </p></li><li class="listitem"><p>
        <code class="literal">release</code> (optional, defaults to <code class="literal">{}</code>), lists all the known releases of the library and for each of them provides an attribute set with at least a <code class="literal">sha256</code> attribute (you may put the empty string <code class="literal">""</code> in order to automatically insert a fake sha256, this will trigger an error which will allow you to find the correct sha256), each attribute set of the list of releases also takes optional overloading arguments for the fetcher as below (i.e.<code class="literal">domain</code>, <code class="literal">owner</code>, <code class="literal">repo</code>, <code class="literal">rev</code> assuming the default fetcher is used) and optional overrides for the result of the fetcher (i.e. <code class="literal">version</code> and <code class="literal">src</code>).
       </p></li><li class="listitem"><p>
        <code class="literal">fetcher</code> (optional, defaults to a generic fetching mechanism supporting github or gitlab based infrastructures), is a function that takes at least an <code class="literal">owner</code>, a <code class="literal">repo</code>, a <code class="literal">rev</code>, and a <code class="literal">sha256</code> and returns an attribute set with a <code class="literal">version</code> and <code class="literal">src</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">repo</code> (optional, defaults to the value of <code class="literal">pname</code>),
       </p></li><li class="listitem"><p>
        <code class="literal">owner</code> (optional, defaults to <code class="literal">"coq-community"</code>).
       </p></li><li class="listitem"><p>
        <code class="literal">domain</code> (optional, defaults to <code class="literal">"github.com"</code>), domains including the strings <code class="literal">"github"</code> or <code class="literal">"gitlab"</code> in their names are automatically supported, otherwise, one must change the <code class="literal">fetcher</code> argument to support them (cf <code class="literal">pkgs/development/coq-modules/heq/default.nix</code> for an example),
       </p></li><li class="listitem"><p>
        <code class="literal">releaseRev</code> (optional, defaults to <code class="literal">(v: v)</code>), provides a default mapping from release names to revision hashes/branch names/tags,
       </p></li><li class="listitem"><p>
        <code class="literal">displayVersion</code> (optional), provides a way to alter the computation of <code class="literal">name</code> from <code class="literal">pname</code>, by explaining how to display version numbers,
       </p></li><li class="listitem"><p>
        <code class="literal">namePrefix</code> (optional), provides a way to alter the computation of <code class="literal">name</code> from <code class="literal">pname</code>, by explaining which dependencies must occur in <code class="literal">name</code>,
       </p></li><li class="listitem"><p>
        <code class="literal">extraBuildInputs</code> (optional), by default <code class="literal">buildInputs</code> just contains <code class="literal">coq</code>, this allows to add more build inputs,
       </p></li><li class="listitem"><p>
        <code class="literal">mlPlugin</code> (optional, defaults to <code class="literal">false</code>). Some extensions (plugins) might require OCaml and sometimes other OCaml packages. Standard dependencies can be added by setting the current option to <code class="literal">true</code>. For a finer grain control, the <code class="literal">coq.ocamlPackages</code> attribute can be used in <code class="literal">extraBuildInputs</code> to depend on the same package set Coq was built against.
       </p></li><li class="listitem"><p>
        <code class="literal">useDune2ifVersion</code> (optional, default to <code class="literal">(x: false)</code> uses Dune2 to build the package if the provided predicate evaluates to true on the version, e.g. <code class="literal">useDune2if = versions.isGe "1.1"</code> will use dune if the version of the package is greater or equal to <code class="literal">"1.1"</code>,
       </p></li><li class="listitem"><p>
        <code class="literal">useDune2</code> (optional, defaults to <code class="literal">false</code>) uses Dune2 to build the package if set to true, the presence of this attribute overrides the behavior of the previous one.
       </p></li><li class="listitem"><p>
        <code class="literal">enableParallelBuilding</code> (optional, defaults to <code class="literal">true</code>), since it is activated by default, we provide a way to disable it.
       </p></li><li class="listitem"><p>
        <code class="literal">extraInstallFlags</code> (optional), allows to extend <code class="literal">installFlags</code> which initializes the variable <code class="literal">COQMF_COQLIB</code> so as to install in the proper subdirectory. Indeed Coq libraries should be installed in <code class="literal">$(out)/lib/coq/${coq.coq-version}/user-contrib/</code>. Such directories are automatically added to the <code class="literal">$COQPATH</code> environment variable by the hook defined in the Coq derivation.
       </p></li><li class="listitem"><p>
        <code class="literal">setCOQBIN</code> (optional, defaults to <code class="literal">true</code>), by default, the environment variable <code class="literal">$COQBIN</code> is set to the current Coq’s binary, but one can disable this behavior by setting it to <code class="literal">false</code>,
       </p></li><li class="listitem"><p>
        <code class="literal">useMelquiondRemake</code> (optional, default to <code class="literal">null</code>) is an attribute set, which, if given, overloads the <code class="literal">preConfigurePhases</code>, <code class="literal">configureFlags</code>, <code class="literal">buildPhase</code>, and <code class="literal">installPhase</code> attributes of the derivation for a specific use in libraries using <code class="literal">remake</code> as set up by Guillaume Melquiond for <code class="literal">flocq</code>, <code class="literal">gappalib</code>, <code class="literal">interval</code>, and <code class="literal">coquelicot</code> (see the corresponding derivation for concrete examples of use of this option). For backward compatibility, the attribute <code class="literal">useMelquiondRemake.logpath</code> must be set to the logical root of the library (otherwise, one can pass <code class="literal">useMelquiondRemake = {}</code> to activate this without backward compatibility).
       </p></li><li class="listitem"><p>
        <code class="literal">dropAttrs</code>, <code class="literal">keepAttrs</code>, <code class="literal">dropDerivationAttrs</code> are all optional and allow to tune which attribute is added or removed from the final call to <code class="literal">mkDerivation</code>.
       </p></li></ul></div><p>
      It also takes other standard <code class="literal">mkDerivation</code> attributes, they are added as such, except for <code class="literal">meta</code> which extends an automatically computed <code class="literal">meta</code> (where the <code class="literal">platform</code> is the same as <code class="literal">coq</code> and the homepage is automatically computed).
     </p><p>
      Here is a simple package example. It is a pure Coq library, thus it depends on Coq. It builds on the Mathematical Components library, thus it also takes some <code class="literal">mathcomp</code> derivations as <code class="literal">extraBuildInputs</code>.
     </p><pre class="programlisting">
{ lib, mkCoqDerivation, version ? null
, coq, mathcomp, mathcomp-finmap, mathcomp-bigenough }:
with lib; mkCoqDerivation {
  /* namePrefix leads to e.g. `name = coq8.11-mathcomp1.11-multinomials-1.5.2` */
  namePrefix = [ "coq" "mathcomp" ];
  pname = "multinomials";
  owner = "math-comp";
  inherit version;
  defaultVersion =  with versions; switch [ coq.version mathcomp.version ] [
      { cases = [ (range "8.7" "8.12")  "1.11.0" ];             out = "1.5.2"; }
      { cases = [ (range "8.7" "8.11")  (range "1.8" "1.10") ]; out = "1.5.0"; }
      { cases = [ (range "8.7" "8.10")  (range "1.8" "1.10") ]; out = "1.4"; }
      { cases = [ "8.6"                 (range "1.6" "1.7") ];  out = "1.1"; }
    ] null;
  release = {
    "1.5.2".sha256 = "15aspf3jfykp1xgsxf8knqkxv8aav2p39c2fyirw7pwsfbsv2c4s";
    "1.5.1".sha256 = "13nlfm2wqripaq671gakz5mn4r0xwm0646araxv0nh455p9ndjs3";
    "1.5.0".sha256 = "064rvc0x5g7y1a0nip6ic91vzmq52alf6in2bc2dmss6dmzv90hw";
    "1.5.0".rev    = "1.5";
    "1.4".sha256   = "0vnkirs8iqsv8s59yx1fvg1nkwnzydl42z3scya1xp1b48qkgn0p";
    "1.3".sha256   = "0l3vi5n094nx3qmy66hsv867fnqm196r8v605kpk24gl0aa57wh4";
    "1.2".sha256   = "1mh1w339dslgv4f810xr1b8v2w7rpx6fgk9pz96q0fyq49fw2xcq";
    "1.1".sha256   = "1q8alsm89wkc0lhcvxlyn0pd8rbl2nnxg81zyrabpz610qqjqc3s";
    "1.0".sha256   = "1qmbxp1h81cy3imh627pznmng0kvv37k4hrwi2faa101s6bcx55m";
  };

  propagatedBuildInputs =
    [ mathcomp.ssreflect mathcomp.algebra mathcomp-finmap mathcomp-bigenough ];

  meta = {
    description = "A Coq/SSReflect Library for Monoidal Rings and Multinomials";
    license = licenses.cecill-c;
  };
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="crystal"></a>15.6. Crystal</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="building-a-crystal-package"></a>15.6.1. Building a Crystal package</h3></div></div></div><p>
      This section uses <a class="link" href="https://github.com/mint-lang/mint" target="_top">Mint</a> as an example for how to build a Crystal package.
     </p><p>
      If the Crystal project has any dependencies, the first step is to get a <code class="literal">shards.nix</code> file encoding those. Get a copy of the project and go to its root directory such that its <code class="literal">shard.lock</code> file is in the current directory, then run <code class="literal">crystal2nix</code> in it
     </p><pre class="programlisting">
$ git clone https://github.com/mint-lang/mint
$ cd mint
$ git checkout 0.5.0
$ nix-shell -p crystal2nix --run crystal2nix
</pre><p>
      This should have generated a <code class="literal">shards.nix</code> file.
     </p><p>
      Next create a Nix file for your derivation and use <code class="literal">pkgs.crystal.buildCrystalPackage</code> as follows:
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};
crystal.buildCrystalPackage rec {
  pname = "mint";
  version = "0.5.0";

  src = fetchFromGitHub {
    owner = "mint-lang";
    repo = "mint";
    rev = version;
    sha256 = "0vxbx38c390rd2ysvbwgh89v2232sh5rbsp3nk9wzb70jybpslvl";
  };

  # Insert the path to your shards.nix file here
  shardsFile = ./shards.nix;

  ...
}
</pre><p>
      This won’t build anything yet, because we haven’t told it what files build. We can specify a mapping from binary names to source files with the <code class="literal">crystalBinaries</code> attribute. The project’s compilation instructions should show this. For Mint, the binary is called <span class="quote">“<span class="quote">mint</span>”</span>, which is compiled from the source file <code class="literal">src/mint.cr</code>, so we’ll specify this as follows:
     </p><pre class="programlisting">
  crystalBinaries.mint.src = "src/mint.cr";

  # ...
</pre><p>
      Additionally you can override the default <code class="literal">crystal build</code> options (which are currently <code class="literal">--release --progress --no-debug --verbose</code>) with
     </p><pre class="programlisting">
  crystalBinaries.mint.options = [ "--release" "--verbose" ];
</pre><p>
      Depending on the project, you might need additional steps to get it to compile successfully. In Mint’s case, we need to link against openssl, so in the end the Nix file looks as follows:
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};
crystal.buildCrystalPackage rec {
  version = "0.5.0";
  pname = "mint";
  src = fetchFromGitHub {
    owner = "mint-lang";
    repo = "mint";
    rev = version;
    sha256 = "0vxbx38c390rd2ysvbwgh89v2232sh5rbsp3nk9wzb70jybpslvl";
  };

  shardsFile = ./shards.nix;
  crystalBinaries.mint.src = "src/mint.cr";

  buildInputs = [ openssl ];
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-language-dhall"></a>15.7. Dhall</h2></div></div></div><p>
     The Nixpkgs support for Dhall assumes some familiarity with Dhall’s language support for importing Dhall expressions, which is documented here:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       <a class="link" href="https://docs.dhall-lang.org/tutorials/Language-Tour.html#installing-packages" target="_top"><code class="literal">dhall-lang.org</code> - Installing packages</a>
      </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-dhall-remote-imports"></a>15.7.1. Remote imports</h3></div></div></div><p>
      Nixpkgs bypasses Dhall’s support for remote imports using Dhall’s semantic integrity checks. Specifically, any Dhall import can be protected by an integrity check like:
     </p><pre class="programlisting">
https://prelude.dhall-lang.org/v20.1.0/package.dhall
  sha256:26b0ef498663d269e4dc6a82b0ee289ec565d683ef4c00d0ebdd25333a5a3c98
</pre><p>
      … and if the import is cached then the interpreter will load the import from cache instead of fetching the URL.
     </p><p>
      Nixpkgs uses this trick to add all of a Dhall expression’s dependencies into the cache so that the Dhall interpreter never needs to resolve any remote URLs. In fact, Nixpkgs uses a Dhall interpreter with remote imports disabled when packaging Dhall expressions to enforce that the interpreter never resolves a remote import. This means that Nixpkgs only supports building Dhall expressions if all of their remote imports are protected by semantic integrity checks.
     </p><p>
      Instead of remote imports, Nixpkgs uses Nix to fetch remote Dhall code. For example, the Prelude Dhall package uses <code class="literal">pkgs.fetchFromGitHub</code> to fetch the <code class="literal">dhall-lang</code> repository containing the Prelude. Relying exclusively on Nix to fetch Dhall code ensures that Dhall packages built using Nix remain pure and also behave well when built within a sandbox.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-dhall-packaging-expression"></a>15.7.2. Packaging a Dhall expression from scratch</h3></div></div></div><p>
      We can illustrate how Nixpkgs integrates Dhall by beginning from the following trivial Dhall expression with one dependency (the Prelude):
     </p><pre class="programlisting">
-- ./true.dhall

let Prelude = https://prelude.dhall-lang.org/v20.1.0/package.dhall

in  Prelude.Bool.not False
</pre><p>
      As written, this expression cannot be built using Nixpkgs because the expression does not protect the Prelude import with a semantic integrity check, so the first step is to freeze the expression using <code class="literal">dhall freeze</code>, like this:
     </p><pre class="programlisting">
$ dhall freeze --inplace ./true.dhall
</pre><p>
      … which gives us:
     </p><pre class="programlisting">
-- ./true.dhall

let Prelude =
      https://prelude.dhall-lang.org/v20.1.0/package.dhall
        sha256:26b0ef498663d269e4dc6a82b0ee289ec565d683ef4c00d0ebdd25333a5a3c98

in  Prelude.Bool.not False
</pre><p>
      To package that expression, we create a <code class="literal">./true.nix</code> file containing the following specification for the Dhall package:
     </p><pre class="programlisting">
# ./true.nix

{ buildDhallPackage, Prelude }:

buildDhallPackage {
  name = "true";
  code = ./true.dhall;
  dependencies = [ Prelude ];
  source = true;
}
</pre><p>
      … and we complete the build by incorporating that Dhall package into the <code class="literal">pkgs.dhallPackages</code> hierarchy using an overlay, like this:
     </p><pre class="programlisting">
# ./example.nix

let
  nixpkgs = builtins.fetchTarball {
    url    = "https://github.com/NixOS/nixpkgs/archive/94b2848559b12a8ed1fe433084686b2a81123c99.tar.gz";
    sha256 = "1pbl4c2dsaz2lximgd31m96jwbps6apn3anx8cvvhk1gl9rkg107";
  };

  dhallOverlay = self: super: {
    true = self.callPackage ./true.nix { };
  };

  overlay = self: super: {
    dhallPackages = super.dhallPackages.override (old: {
      overrides =
        self.lib.composeExtensions (old.overrides or (_: _: {})) dhallOverlay;
    });
  };

  pkgs = import nixpkgs { config = {}; overlays = [ overlay ]; };

in
  pkgs
</pre><p>
      … which we can then build using this command:
     </p><pre class="programlisting">
$ nix build --file ./example.nix dhallPackages.true
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-dhall-package-contents"></a>15.7.3. Contents of a Dhall package</h3></div></div></div><p>
      The above package produces the following directory tree:
     </p><pre class="programlisting">
$ tree -a ./result
result
├── .cache
│   └── dhall
│       └── 122027abdeddfe8503496adeb623466caa47da5f63abd2bc6fa19f6cfcb73ecfed70
├── binary.dhall
└── source.dhall
</pre><p>
      … where:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">source.dhall</code> contains the result of interpreting our Dhall package:
       </p><pre class="programlisting">
$ cat ./result/source.dhall
True
</pre></li><li class="listitem"><p>
        The <code class="literal">.cache</code> subdirectory contains one binary cache product encoding the same result as <code class="literal">source.dhall</code>:
       </p><pre class="programlisting">
$ dhall decode &lt; ./result/.cache/dhall/122027abdeddfe8503496adeb623466caa47da5f63abd2bc6fa19f6cfcb73ecfed70
True
</pre></li><li class="listitem"><p>
        <code class="literal">binary.dhall</code> contains a Dhall expression which handles fetching and decoding the same cache product:
       </p><pre class="programlisting">
$ cat ./result/binary.dhall
missing sha256:27abdeddfe8503496adeb623466caa47da5f63abd2bc6fa19f6cfcb73ecfed70
$ cp -r ./result/.cache .cache

$ chmod -R u+w .cache

$ XDG_CACHE_HOME=.cache dhall --file ./result/binary.dhall
True
</pre></li></ul></div><p>
      The <code class="literal">source.dhall</code> file is only present for packages that specify <code class="literal">source = true;</code>. By default, Dhall packages omit the <code class="literal">source.dhall</code> in order to conserve disk space when they are used exclusively as dependencies. For example, if we build the Prelude package it will only contain the binary encoding of the expression:
     </p><pre class="programlisting">
$ nix build --file ./example.nix dhallPackages.Prelude

$ tree -a result
result
├── .cache
│   └── dhall
│       └── 122026b0ef498663d269e4dc6a82b0ee289ec565d683ef4c00d0ebdd25333a5a3c98
└── binary.dhall

2 directories, 2 files
</pre><p>
      Typically, you only specify <code class="literal">source = true;</code> for the top-level Dhall expression of interest (such as our example <code class="literal">true.nix</code> Dhall package). However, if you wish to specify <code class="literal">source = true</code> for all Dhall packages, then you can amend the Dhall overlay like this:
     </p><pre class="programlisting">
  dhallOverrides = self: super: {
    # Enable source for all Dhall packages
    buildDhallPackage =
      args: super.buildDhallPackage (args // { source = true; });

    true = self.callPackage ./true.nix { };
  };
</pre><p>
      … and now the Prelude will contain the fully decoded result of interpreting the Prelude:
     </p><pre class="programlisting">
$ nix build --file ./example.nix dhallPackages.Prelude

$ tree -a result
result
├── .cache
│   └── dhall
│       └── 122026b0ef498663d269e4dc6a82b0ee289ec565d683ef4c00d0ebdd25333a5a3c98
├── binary.dhall
└── source.dhall

$ cat ./result/source.dhall
{ Bool =
  { and =
      \(_ : List Bool) -&gt;
        List/fold Bool _ Bool (\(_ : Bool) -&gt; \(_ : Bool) -&gt; _@1 &amp;&amp; _) True
  , build = \(_ : Type -&gt; _ -&gt; _@1 -&gt; _@2) -&gt; _ Bool True False
  , even =
      \(_ : List Bool) -&gt;
        List/fold Bool _ Bool (\(_ : Bool) -&gt; \(_ : Bool) -&gt; _@1 == _) True
  , fold =
      \(_ : Bool) -&gt;
…
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-dhall-packaging-functions"></a>15.7.4. Packaging functions</h3></div></div></div><p>
      We already saw an example of using <code class="literal">buildDhallPackage</code> to create a Dhall package from a single file, but most Dhall packages consist of more than one file and there are two derived utilities that you may find more useful when packaging multiple files:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">buildDhallDirectoryPackage</code> - build a Dhall package from a local directory
       </p></li><li class="listitem"><p>
        <code class="literal">buildDhallGitHubPackage</code> - build a Dhall package from a GitHub repository
       </p></li></ul></div><p>
      The <code class="literal">buildDhallPackage</code> is the lowest-level function and accepts the following arguments:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">name</code>: The name of the derivation
       </p></li><li class="listitem"><p>
        <code class="literal">dependencies</code>: Dhall dependencies to build and cache ahead of time
       </p></li><li class="listitem"><p>
        <code class="literal">code</code>: The top-level expression to build for this package
       </p><p>
        Note that the <code class="literal">code</code> field accepts an arbitrary Dhall expression. You’re not limited to just a file.
       </p></li><li class="listitem"><p>
        <code class="literal">source</code>: Set to <code class="literal">true</code> to include the decoded result as <code class="literal">source.dhall</code> in the build product, at the expense of requiring more disk space
       </p></li><li class="listitem"><p>
        <code class="literal">documentationRoot</code>: Set to the root directory of the package if you want <code class="literal">dhall-docs</code> to generate documentation underneath the <code class="literal">docs</code> subdirectory of the build product
       </p></li></ul></div><p>
      The <code class="literal">buildDhallDirectoryPackage</code> is a higher-level function implemented in terms of <code class="literal">buildDhallPackage</code> that accepts the following arguments:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">name</code>: Same as <code class="literal">buildDhallPackage</code>
       </p></li><li class="listitem"><p>
        <code class="literal">dependencies</code>: Same as <code class="literal">buildDhallPackage</code>
       </p></li><li class="listitem"><p>
        <code class="literal">source</code>: Same as <code class="literal">buildDhallPackage</code>
       </p></li><li class="listitem"><p>
        <code class="literal">src</code>: The directory containing Dhall code that you want to turn into a Dhall package
       </p></li><li class="listitem"><p>
        <code class="literal">file</code>: The top-level file (<code class="literal">package.dhall</code> by default) that is the entrypoint to the rest of the package
       </p></li><li class="listitem"><p>
        <code class="literal">document</code>: Set to <code class="literal">true</code> to generate documentation for the package
       </p></li></ul></div><p>
      The <code class="literal">buildDhallGitHubPackage</code> is another higher-level function implemented in terms of <code class="literal">buildDhallPackage</code> that accepts the following arguments:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">name</code>: Same as <code class="literal">buildDhallPackage</code>
       </p></li><li class="listitem"><p>
        <code class="literal">dependencies</code>: Same as <code class="literal">buildDhallPackage</code>
       </p></li><li class="listitem"><p>
        <code class="literal">source</code>: Same as <code class="literal">buildDhallPackage</code>
       </p></li><li class="listitem"><p>
        <code class="literal">owner</code>: The owner of the repository
       </p></li><li class="listitem"><p>
        <code class="literal">repo</code>: The repository name
       </p></li><li class="listitem"><p>
        <code class="literal">rev</code>: The desired revision (or branch, or tag)
       </p></li><li class="listitem"><p>
        <code class="literal">directory</code>: The subdirectory of the Git repository to package (if a directory other than the root of the repository)
       </p></li><li class="listitem"><p>
        <code class="literal">file</code>: The top-level file (<code class="literal">${directory}/package.dhall</code> by default) that is the entrypoint to the rest of the package
       </p></li><li class="listitem"><p>
        <code class="literal">document</code>: Set to <code class="literal">true</code> to generate documentation for the package
       </p></li></ul></div><p>
      Additionally, <code class="literal">buildDhallGitHubPackage</code> accepts the same arguments as <code class="literal">fetchFromGitHub</code>, such as <code class="literal">sha256</code> or <code class="literal">fetchSubmodules</code>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-dhall-dhall-to-nixpkgs"></a>15.7.5. <code class="literal">dhall-to-nixpkgs</code></h3></div></div></div><p>
      You can use the <code class="literal">dhall-to-nixpkgs</code> command-line utility to automate packaging Dhall code. For example:
     </p><pre class="programlisting">
$ nix-env --install --attr haskellPackages.dhall-nixpkgs

$ nix-env --install --attr nix-prefetch-git  # Used by dhall-to-nixpkgs

$ dhall-to-nixpkgs github https://github.com/Gabriel439/dhall-semver.git
{ buildDhallGitHubPackage, Prelude }:
  buildDhallGitHubPackage {
    name = "dhall-semver";
    githubBase = "github.com";
    owner = "Gabriel439";
    repo = "dhall-semver";
    rev = "2d44ae605302ce5dc6c657a1216887fbb96392a4";
    fetchSubmodules = false;
    sha256 = "0y8shvp8srzbjjpmnsvz9c12ciihnx1szs0yzyi9ashmrjvd0jcz";
    directory = "";
    file = "package.dhall";
    source = false;
    document = false;
    dependencies = [ (Prelude.overridePackage { file = "package.dhall"; }) ];
    }
</pre><p>
      The utility takes care of automatically detecting remote imports and converting them to package dependencies. You can also use the utility on local Dhall directories, too:
     </p><pre class="programlisting">
$ dhall-to-nixpkgs directory ~/proj/dhall-semver
{ buildDhallDirectoryPackage, Prelude }:
  buildDhallDirectoryPackage {
    name = "proj";
    src = /Users/gabriel/proj/dhall-semver;
    file = "package.dhall";
    source = false;
    document = false;
    dependencies = [ (Prelude.overridePackage { file = "package.dhall"; }) ];
    }
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-dhall-overriding-dependency-versions"></a>15.7.6. Overriding dependency versions</h3></div></div></div><p>
      Suppose that we change our <code class="literal">true.dhall</code> example expression to depend on an older version of the Prelude (19.0.0):
     </p><pre class="programlisting">
-- ./true.dhall

let Prelude =
      https://prelude.dhall-lang.org/v19.0.0/package.dhall
        sha256:eb693342eb769f782174157eba9b5924cf8ac6793897fc36a31ccbd6f56dafe2

in  Prelude.Bool.not False
</pre><p>
      If we try to rebuild that expression the build will fail:
     </p><pre class="programlisting">
$ nix build --file ./example.nix dhallPackages.true
builder for '/nix/store/0f1hla7ff1wiaqyk1r2ky4wnhnw114fi-true.drv' failed with exit code 1; last 10 log lines:

  Dhall was compiled without the 'with-http' flag.

  The requested URL was: https://prelude.dhall-lang.org/v19.0.0/package.dhall


  4│       https://prelude.dhall-lang.org/v19.0.0/package.dhall
  5│         sha256:eb693342eb769f782174157eba9b5924cf8ac6793897fc36a31ccbd6f56dafe2

  /nix/store/rsab4y99h14912h4zplqx2iizr5n4rc2-true.dhall:4:7
[1 built (1 failed), 0.0 MiB DL]
error: build of '/nix/store/0f1hla7ff1wiaqyk1r2ky4wnhnw114fi-true.drv' failed
</pre><p>
      … because the default Prelude selected by Nixpkgs revision <code class="literal">94b2848559b12a8ed1fe433084686b2a81123c99is</code> is version 20.1.0, which doesn’t have the same integrity check as version 19.0.0. This means that version 19.0.0 is not cached and the interpreter is not allowed to fall back to importing the URL.
     </p><p>
      However, we can override the default Prelude version by using <code class="literal">dhall-to-nixpkgs</code> to create a Dhall package for our desired Prelude:
     </p><pre class="programlisting">
$ dhall-to-nixpkgs github https://github.com/dhall-lang/dhall-lang.git \
    --name Prelude \
    --directory Prelude \
    --rev v19.0.0 \
    &gt; Prelude.nix
</pre><p>
      … and then referencing that package in our Dhall overlay, by either overriding the Prelude globally for all packages, like this:
     </p><pre class="programlisting">
  dhallOverrides = self: super: {
    true = self.callPackage ./true.nix { };

    Prelude = self.callPackage ./Prelude.nix { };
  };
</pre><p>
      … or selectively overriding the Prelude dependency for just the <code class="literal">true</code> package, like this:
     </p><pre class="programlisting">
  dhallOverrides = self: super: {
    true = self.callPackage ./true.nix {
      Prelude = self.callPackage ./Prelude.nix { };
    };
  };
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-dhall-overrides"></a>15.7.7. Overrides</h3></div></div></div><p>
      You can override any of the arguments to <code class="literal">buildDhallGitHubPackage</code> or <code class="literal">buildDhallDirectoryPackage</code> using the <code class="literal">overridePackage</code> attribute of a package. For example, suppose we wanted to selectively enable <code class="literal">source = true</code> just for the Prelude. We can do that like this:
     </p><pre class="programlisting">
  dhallOverrides = self: super: {
    Prelude = super.Prelude.overridePackage { source = true; };

    …
  };
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="emscripten"></a>15.8. Emscripten</h2></div></div></div><p>
     <a class="link" href="https://github.com/kripken/emscripten" target="_top">Emscripten</a>: An LLVM-to-JavaScript Compiler
    </p><p>
     This section of the manual covers how to use <code class="literal">emscripten</code> in nixpkgs.
    </p><p>
     Minimal requirements:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       nix
      </p></li><li class="listitem"><p>
       nixpkgs
      </p></li></ul></div><p>
     Modes of use of <code class="literal">emscripten</code>:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       <span class="strong"><strong>Imperative usage</strong></span> (on the command line):
      </p><p>
       If you want to work with <code class="literal">emcc</code>, <code class="literal">emconfigure</code> and <code class="literal">emmake</code> as you are used to from Ubuntu and similar distributions you can use these commands:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         <code class="literal">nix-env -i emscripten</code>
        </p></li><li class="listitem"><p>
         <code class="literal">nix-shell -p emscripten</code>
        </p></li></ul></div></li><li class="listitem"><p>
       <span class="strong"><strong>Declarative usage</strong></span>:
      </p><p>
       This mode is far more power full since this makes use of <code class="literal">nix</code> for dependency management of emscripten libraries and targets by using the <code class="literal">mkDerivation</code> which is implemented by <code class="literal">pkgs.emscriptenStdenv</code> and <code class="literal">pkgs.buildEmscriptenPackage</code>. The source for the packages is in <code class="literal">pkgs/top-level/emscripten-packages.nix</code> and the abstraction behind it in <code class="literal">pkgs/development/em-modules/generic/default.nix</code>.
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         build and install all packages:
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
           <code class="literal">nix-env -iA emscriptenPackages</code>
          </p></li></ul></div></li><li class="listitem"><p>
         dev-shell for zlib implementation hacking:
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
           <code class="literal">nix-shell -A emscriptenPackages.zlib</code>
          </p></li></ul></div></li></ul></div></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="imperative-usage"></a>15.8.1. Imperative usage</h3></div></div></div><p>
      A few things to note:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">export EMCC_DEBUG=2</code> is nice for debugging
       </p></li><li class="listitem"><p>
        <code class="literal">~/.emscripten</code>, the build artifact cache sometimes creates issues and needs to be removed from time to time
       </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="declarative-usage"></a>15.8.2. Declarative usage</h3></div></div></div><p>
      Let’s see two different examples from <code class="literal">pkgs/top-level/emscripten-packages.nix</code>:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">pkgs.zlib.override</code>
       </p></li><li class="listitem"><p>
        <code class="literal">pkgs.buildEmscriptenPackage</code>
       </p></li></ul></div><p>
      Both are interesting concepts.
     </p><p>
      A special requirement of the <code class="literal">pkgs.buildEmscriptenPackage</code> is the <code class="literal">doCheck = true</code> is a default meaning that each emscriptenPackage requires a <code class="literal">checkPhase</code> implemented.
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        Use <code class="literal">export EMCC_DEBUG=2</code> from within a emscriptenPackage’s <code class="literal">phase</code> to get more detailed debug output what is going wrong.
       </p></li><li class="listitem"><p>
        ~/.emscripten cache is requiring us to set <code class="literal">HOME=$TMPDIR</code> in individual phases. This makes compilation slower but also makes it more deterministic.
       </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="usage-1-pkgs.zlib.override"></a>15.8.2.1. Usage 1: pkgs.zlib.override</h4></div></div></div><p>
       This example uses <code class="literal">zlib</code> from nixpkgs but instead of compiling <span class="strong"><strong>C</strong></span> to <span class="strong"><strong>ELF</strong></span> it compiles <span class="strong"><strong>C</strong></span> to <span class="strong"><strong>JS</strong></span> since we were using <code class="literal">pkgs.zlib.override</code> and changed stdenv to <code class="literal">pkgs.emscriptenStdenv</code>. A few adaptions and hacks were set in place to make it working. One advantage is that when <code class="literal">pkgs.zlib</code> is updated, it will automatically update this package as well. However, this can also be the downside…
      </p><p>
       See the <code class="literal">zlib</code> example:
      </p><pre class="programlisting">
zlib = (pkgs.zlib.override {
  stdenv = pkgs.emscriptenStdenv;
}).overrideDerivation
(old: rec {
  buildInputs = old.buildInputs ++ [ pkg-config ];
  # we need to reset this setting!
  NIX_CFLAGS_COMPILE="";
  configurePhase = ''
    # FIXME: Some tests require writing at $HOME
    HOME=$TMPDIR
    runHook preConfigure

    #export EMCC_DEBUG=2
    emconfigure ./configure --prefix=$out --shared

    runHook postConfigure
  '';
  dontStrip = true;
  outputs = [ "out" ];
  buildPhase = ''
    emmake make
  '';
  installPhase = ''
    emmake make install
  '';
  checkPhase = ''
    echo "================= testing zlib using node ================="

    echo "Compiling a custom test"
    set -x
    emcc -O2 -s EMULATE_FUNCTION_POINTER_CASTS=1 test/example.c -DZ_SOLO \
    libz.so.${old.version} -I . -o example.js

    echo "Using node to execute the test"
    ${pkgs.nodejs}/bin/node ./example.js

    set +x
    if [ $? -ne 0 ]; then
      echo "test failed for some reason"
      exit 1;
    else
      echo "it seems to work! very good."
    fi
    echo "================= /testing zlib using node ================="
  '';

  postPatch = pkgs.lib.optionalString pkgs.stdenv.isDarwin ''
    substituteInPlace configure \
      --replace '/usr/bin/libtool' 'ar' \
      --replace 'AR="libtool"' 'AR="ar"' \
      --replace 'ARFLAGS="-o"' 'ARFLAGS="-r"'
  '';
});
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="usage-2-pkgs.buildemscriptenpackage"></a>15.8.2.2. Usage 2: pkgs.buildEmscriptenPackage</h4></div></div></div><p>
       This <code class="literal">xmlmirror</code> example features a emscriptenPackage which is defined completely from this context and no <code class="literal">pkgs.zlib.override</code> is used.
      </p><pre class="programlisting">
xmlmirror = pkgs.buildEmscriptenPackage rec {
  name = "xmlmirror";

  buildInputs = [ pkg-config autoconf automake libtool gnumake libxml2 nodejs openjdk json_c ];
  nativeBuildInputs = [ pkg-config zlib ];

  src = pkgs.fetchgit {
    url = "https://gitlab.com/odfplugfest/xmlmirror.git";
    rev = "4fd7e86f7c9526b8f4c1733e5c8b45175860a8fd";
    sha256 = "1jasdqnbdnb83wbcnyrp32f36w3xwhwp0wq8lwwmhqagxrij1r4b";
  };

  configurePhase = ''
    rm -f fastXmlLint.js*
    # a fix for ERROR:root:For asm.js, TOTAL_MEMORY must be a multiple of 16MB, was 234217728
    # https://gitlab.com/odfplugfest/xmlmirror/issues/8
    sed -e "s/TOTAL_MEMORY=234217728/TOTAL_MEMORY=268435456/g" -i Makefile.emEnv
    # https://github.com/kripken/emscripten/issues/6344
    # https://gitlab.com/odfplugfest/xmlmirror/issues/9
    sed -e "s/\$(JSONC_LDFLAGS) \$(ZLIB_LDFLAGS) \$(LIBXML20_LDFLAGS)/\$(JSONC_LDFLAGS) \$(LIBXML20_LDFLAGS) \$(ZLIB_LDFLAGS) /g" -i Makefile.emEnv
    # https://gitlab.com/odfplugfest/xmlmirror/issues/11
    sed -e "s/-o fastXmlLint.js/-s EXTRA_EXPORTED_RUNTIME_METHODS='[\"ccall\", \"cwrap\"]' -o fastXmlLint.js/g" -i Makefile.emEnv
  '';

  buildPhase = ''
    HOME=$TMPDIR
    make -f Makefile.emEnv
  '';

  outputs = [ "out" "doc" ];

  installPhase = ''
    mkdir -p $out/share
    mkdir -p $doc/share/${name}

    cp Demo* $out/share
    cp -R codemirror-5.12 $out/share
    cp fastXmlLint.js* $out/share
    cp *.xsd $out/share
    cp *.js $out/share
    cp *.xhtml $out/share
    cp *.html $out/share
    cp *.json $out/share
    cp *.rng $out/share
    cp README.md $doc/share/${name}
  '';
  checkPhase = ''

  '';
};
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="declarative-debugging"></a>15.8.2.3. Declarative debugging</h4></div></div></div><p>
       Use <code class="literal">nix-shell -I nixpkgs=/some/dir/nixpkgs -A emscriptenPackages.libz</code> and from there you can go trough the individual steps. This makes it easy to build a good <code class="literal">unit test</code> or list the files of the project.
      </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
         <code class="literal">nix-shell -I nixpkgs=/some/dir/nixpkgs -A emscriptenPackages.libz</code>
        </p></li><li class="listitem"><p>
         <code class="literal">cd /tmp/</code>
        </p></li><li class="listitem"><p>
         <code class="literal">unpackPhase</code>
        </p></li><li class="listitem"><p>
         cd libz-1.2.3
        </p></li><li class="listitem"><p>
         <code class="literal">configurePhase</code>
        </p></li><li class="listitem"><p>
         <code class="literal">buildPhase</code>
        </p></li><li class="listitem"><p>
         … happy hacking…
        </p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="summary"></a>15.8.3. Summary</h3></div></div></div><p>
      Using this toolchain makes it easy to leverage <code class="literal">nix</code> from NixOS, MacOSX or even Windows (WSL+ubuntu+nix). This toolchain is reproducible, behaves like the rest of the packages from nixpkgs and contains a set of well working examples to learn and adapt from.
     </p><p>
      If in trouble, ask the maintainers.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-language-gnome"></a>15.9. GNOME</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-gnome-packaging"></a>15.9.1. Packaging GNOME applications</h3></div></div></div><p>
      Programs in the GNOME universe are written in various languages but they all use GObject-based libraries like GLib, GTK or GStreamer. These libraries are often modular, relying on looking into certain directories to find their modules. However, due to Nix’s specific file system organization, this will fail without our intervention. Fortunately, the libraries usually allow overriding the directories through environment variables, either natively or thanks to a patch in nixpkgs. <a class="link" href="#fun-wrapProgram" title="6.6.7. wrapProgram &lt;executable&gt; &lt;makeWrapperArgs&gt;">Wrapping</a> the executables to ensure correct paths are available to the application constitutes a significant part of packaging a modern desktop application. In this section, we will describe various modules needed by such applications, environment variables needed to make the modules load, and finally a script that will do the work for us.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-settings"></a>15.9.1.1. Settings</h4></div></div></div><p>
       <a class="link" href="https://developer.gnome.org/gio/stable/GSettings.html" target="_top">GSettings</a> API is often used for storing settings. GSettings schemas are required, to know the type and other metadata of the stored values. GLib looks for <code class="literal">glib-2.0/schemas/gschemas.compiled</code> files inside the directories of <code class="literal">XDG_DATA_DIRS</code>.
      </p><p>
       On Linux, GSettings API is implemented using <a class="link" href="https://wiki.gnome.org/Projects/dconf" target="_top">dconf</a> backend. You will need to add <code class="literal">dconf</code> <a class="link" href="#ssec-gnome-gio-modules" title="15.9.1.2. GIO modules">GIO module</a> to <code class="literal">GIO_EXTRA_MODULES</code> variable, otherwise the <code class="literal">memory</code> backend will be used and the saved settings will not be persistent.
      </p><p>
       Last you will need the dconf database D-Bus service itself. You can enable it using <code class="literal">programs.dconf.enable</code>.
      </p><p>
       Some applications will also require <code class="literal">gsettings-desktop-schemas</code> for things like reading proxy configuration or user interface customization. This dependency is often not mentioned by upstream, you should grep for <code class="literal">org.gnome.desktop</code> and <code class="literal">org.gnome.system</code> to see if the schemas are needed.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-gio-modules"></a>15.9.1.2. GIO modules</h4></div></div></div><p>
       GLib’s <a class="link" href="https://developer.gnome.org/gio/stable/ch01.html" target="_top">GIO</a> library supports several <a class="link" href="https://developer.gnome.org/gio/stable/extending-gio.html" target="_top">extension points</a>. Notably, they allow:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         implementing settings backends (already <a class="link" href="#ssec-gnome-settings" title="15.9.1.1. Settings">mentioned</a>)
        </p></li><li class="listitem"><p>
         adding TLS support
        </p></li><li class="listitem"><p>
         proxy settings
        </p></li><li class="listitem"><p>
         virtual file systems
        </p></li></ul></div><p>
       The modules are typically installed to <code class="literal">lib/gio/modules/</code> directory of a package and you need to add them to <code class="literal">GIO_EXTRA_MODULES</code> if you need any of those features.
      </p><p>
       In particular, we recommend:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         adding <code class="literal">dconf.lib</code> for any software on Linux that reads <a class="link" href="#ssec-gnome-settings" title="15.9.1.1. Settings">GSettings</a> (even transitivily through e.g. GTK’s file manager)
        </p></li><li class="listitem"><p>
         adding <code class="literal">glib-networking</code> for any software that accesses network using GIO or libsoup – glib-networking contains a module that implements TLS support and loads system-wide proxy settings
        </p></li></ul></div><p>
       To allow software to use various virtual file systems, <code class="literal">gvfs</code> package can be also added. But that is usually an optional feature so we typically use <code class="literal">gvfs</code> from the system (e.g. installed globally using NixOS module).
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-gdk-pixbuf-loaders"></a>15.9.1.3. GdkPixbuf loaders</h4></div></div></div><p>
       GTK applications typically use <a class="link" href="https://developer.gnome.org/gdk-pixbuf/stable/" target="_top">GdkPixbuf</a> to load images. But <code class="literal">gdk-pixbuf</code> package only supports basic bitmap formats like JPEG, PNG or TIFF, requiring to use third-party loader modules for other formats. This is especially painful since GTK itself includes SVG icons, which cannot be rendered without a loader provided by <code class="literal">librsvg</code>.
      </p><p>
       Unlike other libraries mentioned in this section, GdkPixbuf only supports a single value in its controlling environment variable <code class="literal">GDK_PIXBUF_MODULE_FILE</code>. It is supposed to point to a cache file containing information about the available loaders. Each loader package will contain a <code class="literal">lib/gdk-pixbuf-2.0/2.10.0/loaders.cache</code> file describing the default loaders in <code class="literal">gdk-pixbuf</code> package plus the loader contained in the package itself. If you want to use multiple third-party loaders, you will need to create your own cache file manually. Fortunately, this is pretty rare as <a class="link" href="https://gitlab.gnome.org/federico/gdk-pixbuf-survey/blob/master/src/modules.md" target="_top">not many loaders exist</a>.
      </p><p>
       <code class="literal">gdk-pixbuf</code> contains <a class="link" href="#ssec-gnome-hooks-gdk-pixbuf">a setup hook</a> that sets <code class="literal">GDK_PIXBUF_MODULE_FILE</code> from dependencies but as mentioned in further section, it is pretty limited. Loaders should propagate this setup hook.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-icons"></a>15.9.1.4. Icons</h4></div></div></div><p>
       When an application uses icons, an icon theme should be available in <code class="literal">XDG_DATA_DIRS</code> during runtime. The package for the default, icon-less <a class="link" href="https://www.freedesktop.org/wiki/Software/icon-theme/" target="_top">hicolor-icon-theme</a> (should be propagated by every icon theme) contains <a class="link" href="#ssec-gnome-hooks-hicolor-icon-theme">a setup hook</a> that will pick up icon themes from <code class="literal">buildInputs</code> and pass it to our wrapper. Unfortunately, relying on that would mean every user has to download the theme included in the package expression no matter their preference. For that reason, we leave the installation of icon theme on the user. If you use one of the desktop environments, you probably already have an icon theme installed.
      </p><p>
       To avoid costly file system access when locating icons, GTK, <a class="link" href="https://woboq.com/blog/qicon-reads-gtk-icon-cache-in-qt57.html" target="_top">as well as Qt</a>, can rely on <code class="literal">icon-theme.cache</code> files from the themes’ top-level directories. These files are generated using <code class="literal">gtk-update-icon-cache</code>, which is expected to be run whenever an icon is added or removed to an icon theme (typically an application icon into <code class="literal">hicolor</code> theme) and some programs do indeed run this after icon installation. However, since packages are installed into their own prefix by Nix, this would lead to conflicts. For that reason, <code class="literal">gtk3</code> provides a <a class="link" href="#ssec-gnome-hooks-gtk-drop-icon-theme-cache">setup hook</a> that will clean the file from installation. Since most applications only ship their own icon that will be loaded on start-up, it should not affect them too much. On the other hand, icon themes are much larger and more widely used so we need to cache them. Because we recommend installing icon themes globally, we will generate the cache files from all packages in a profile using a NixOS module. You can enable the cache generation using <code class="literal">gtk.iconCache.enable</code> option if your desktop environment does not already do that.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-icon-theme-packaging"></a>15.9.1.5. Packaging icon themes</h4></div></div></div><p>
       Icon themes may inherit from other icon themes. The inheritance is specified using the <code class="literal">Inherits</code> key in the <code class="literal">index.theme</code> file distributed with the icon theme. According to the <a class="link" href="https://specifications.freedesktop.org/icon-theme-spec/icon-theme-spec-latest.html" target="_top">icon theme specification</a>, icons not provided by the theme are looked for in its parent icon themes. Therefore the parent themes should be installed as dependencies for a more complete experience regarding the icon sets used.
      </p><p>
       The package <code class="literal">hicolor-icon-theme</code> provides a setup hook which makes symbolic links for the parent themes into the directory <code class="literal">share/icons</code> of the current theme directory in the nix store, making sure they can be found at runtime. For that to work the packages providing parent icon themes should be listed as propagated build dependencies, together with <code class="literal">hicolor-icon-theme</code>.
      </p><p>
       Also make sure that <code class="literal">icon-theme.cache</code> is installed for each theme provided by the package, and set <code class="literal">dontDropIconThemeCache</code> to <code class="literal">true</code> so that the cache file is not removed by the <code class="literal">gtk3</code> setup hook.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-themes"></a>15.9.1.6. GTK Themes</h4></div></div></div><p>
       Previously, a GTK theme needed to be in <code class="literal">XDG_DATA_DIRS</code>. This is no longer necessary for most programs since GTK incorporated Adwaita theme. Some programs (for example, those designed for <a class="link" href="https://elementary.io/docs/human-interface-guidelines#human-interface-guidelines" target="_top">elementary HIG</a>) might require a special theme like <code class="literal">pantheon.elementary-gtk-theme</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-typelibs"></a>15.9.1.7. GObject introspection typelibs</h4></div></div></div><p>
       <a class="link" href="https://wiki.gnome.org/Projects/GObjectIntrospection" target="_top">GObject introspection</a> allows applications to use C libraries in other languages easily. It does this through <code class="literal">typelib</code> files searched in <code class="literal">GI_TYPELIB_PATH</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-plugins"></a>15.9.1.8. Various plug-ins</h4></div></div></div><p>
       If your application uses <a class="link" href="https://gstreamer.freedesktop.org/" target="_top">GStreamer</a> or <a class="link" href="https://wiki.gnome.org/Projects/Grilo" target="_top">Grilo</a>, you should set <code class="literal">GST_PLUGIN_SYSTEM_PATH_1_0</code> and <code class="literal">GRL_PLUGIN_PATH</code>, respectively.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-gnome-hooks"></a>15.9.2. Onto <code class="literal">wrapGAppsHook</code></h3></div></div></div><p>
      Given the requirements above, the package expression would become messy quickly:
     </p><pre class="programlisting">
preFixup = ''
  for f in $(find $out/bin/ $out/libexec/ -type f -executable); do
    wrapProgram "$f" \
      --prefix GIO_EXTRA_MODULES : "${getLib dconf}/lib/gio/modules" \
      --prefix XDG_DATA_DIRS : "$out/share" \
      --prefix XDG_DATA_DIRS : "$out/share/gsettings-schemas/${name}" \
      --prefix XDG_DATA_DIRS : "${gsettings-desktop-schemas}/share/gsettings-schemas/${gsettings-desktop-schemas.name}" \
      --prefix XDG_DATA_DIRS : "${hicolor-icon-theme}/share" \
      --prefix GI_TYPELIB_PATH : "${lib.makeSearchPath "lib/girepository-1.0" [ pango json-glib ]}"
  done
'';
</pre><p>
      Fortunately, there is
      <a id="ssec-gnome-hooks-wrapgappshook"></a>
      <code class="literal">wrapGAppsHook</code>. It works in conjunction with other setup hooks that populate environment variables, and it will then wrap all executables in <code class="literal">bin</code> and <code class="literal">libexec</code> directories using said variables.
     </p><p>
      For convenience, it also adds <code class="literal">dconf.lib</code> for a GIO module implementing a GSettings backend using <code class="literal">dconf</code>, <code class="literal">gtk3</code> for GSettings schemas, and <code class="literal">librsvg</code> for GdkPixbuf loader to the closure. There is also
      <a id="ssec-gnome-hooks-wrapgappshook4"></a>
      <code class="literal">wrapGAppsHook4</code>, which replaces GTK 3 with GTK 4. And in case you are packaging a program without a graphical interface, you might want to use
      <a id="ssec-gnome-hooks-wrapgappsnoguihook"></a>
      <code class="literal">wrapGAppsNoGuiHook</code>, which runs the same script as <code class="literal">wrapGAppsHook</code> but does not bring <code class="literal">gtk3</code> and <code class="literal">librsvg</code> into the closure.
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">wrapGAppsHook</code> itself will add the package’s <code class="literal">share</code> directory to <code class="literal">XDG_DATA_DIRS</code>.
       </p></li><li class="listitem"><p>
        <a id="ssec-gnome-hooks-glib"></a>
        <code class="literal">glib</code> setup hook will populate <code class="literal">GSETTINGS_SCHEMAS_PATH</code> and then <code class="literal">wrapGAppsHook</code> will prepend it to <code class="literal">XDG_DATA_DIRS</code>.
       </p></li><li class="listitem"><p>
        <a id="ssec-gnome-hooks-gdk-pixbuf"></a>
        <code class="literal">gdk-pixbuf</code> setup hook will populate <code class="literal">GDK_PIXBUF_MODULE_FILE</code> with the path to biggest <code class="literal">loaders.cache</code> file from the dependencies containing <a class="link" href="ssec-gnome-gdk-pixbuf-loaders" target="_top">GdkPixbuf loaders</a>. This works fine when there are only two packages containing loaders (<code class="literal">gdk-pixbuf</code> and e.g. <code class="literal">librsvg</code>) – it will choose the second one, reasonably expecting that it will be bigger since it describes extra loader in addition to the default ones. But when there are more than two loader packages, this logic will break. One possible solution would be constructing a custom cache file for each package containing a program like <code class="literal">services/x11/gdk-pixbuf.nix</code> NixOS module does. <code class="literal">wrapGAppsHook</code> copies the <code class="literal">GDK_PIXBUF_MODULE_FILE</code> environment variable into the produced wrapper.
       </p></li><li class="listitem"><p>
        <a id="ssec-gnome-hooks-gtk-drop-icon-theme-cache"></a>
        One of <code class="literal">gtk3</code>’s setup hooks will remove <code class="literal">icon-theme.cache</code> files from package’s icon theme directories to avoid conflicts. Icon theme packages should prevent this with <code class="literal">dontDropIconThemeCache = true;</code>.
       </p></li><li class="listitem"><p>
        <a id="ssec-gnome-hooks-dconf"></a>
        <code class="literal">dconf.lib</code> is a dependency of <code class="literal">wrapGAppsHook</code>, which then also adds it to the <code class="literal">GIO_EXTRA_MODULES</code> variable.
       </p></li><li class="listitem"><p>
        <a id="ssec-gnome-hooks-hicolor-icon-theme"></a>
        <code class="literal">hicolor-icon-theme</code>’s setup hook will add icon themes to <code class="literal">XDG_ICON_DIRS</code> which is prepended to <code class="literal">XDG_DATA_DIRS</code> by <code class="literal">wrapGAppsHook</code>.
       </p></li><li class="listitem"><p>
        <a id="ssec-gnome-hooks-gobject-introspection"></a>
        <code class="literal">gobject-introspection</code> setup hook populates <code class="literal">GI_TYPELIB_PATH</code> variable with <code class="literal">lib/girepository-1.0</code> directories of dependencies, which is then added to wrapper by <code class="literal">wrapGAppsHook</code>. It also adds <code class="literal">share</code> directories of dependencies to <code class="literal">XDG_DATA_DIRS</code>, which is intended to promote GIR files but it also <a class="link" href="https://github.com/NixOS/nixpkgs/issues/32790" target="_top">pollutes the closures</a> of packages using <code class="literal">wrapGAppsHook</code>.
       </p><div class="warning"><h3 class="title">Warning</h3><p>
         The setup hook <a class="link" href="https://github.com/NixOS/nixpkgs/issues/56943" target="_top">currently</a> does not work in expressions with <code class="literal">strictDeps</code> enabled, like Python packages. In those cases, you will need to disable it with <code class="literal">strictDeps = false;</code>.
        </p></div></li><li class="listitem"><p>
        <a id="ssec-gnome-hooks-gst-grl-plugins"></a>
        Setup hooks of <code class="literal">gst_all_1.gstreamer</code> and <code class="literal">grilo</code> will populate the <code class="literal">GST_PLUGIN_SYSTEM_PATH_1_0</code> and <code class="literal">GRL_PLUGIN_PATH</code> variables, respectively, which will then be added to the wrapper by <code class="literal">wrapGAppsHook</code>.
       </p></li></ul></div><p>
      You can also pass additional arguments to <code class="literal">makeWrapper</code> using <code class="literal">gappsWrapperArgs</code> in <code class="literal">preFixup</code> hook:
     </p><pre class="programlisting">
preFixup = ''
  gappsWrapperArgs+=(
    # Thumbnailers
    --prefix XDG_DATA_DIRS : "${gdk-pixbuf}/share"
    --prefix XDG_DATA_DIRS : "${librsvg}/share"
    --prefix XDG_DATA_DIRS : "${shared-mime-info}/share"
  )
'';
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-gnome-updating"></a>15.9.3. Updating GNOME packages</h3></div></div></div><p>
      Most GNOME package offer <a class="link" href="#var-passthru-updateScript" title="6.4.3.2. passthru.updateScript"><code class="literal">updateScript</code></a>, it is therefore possible to update to latest source tarball by running <code class="literal">nix-shell maintainers/scripts/update.nix --argstr package gnome.nautilus</code> or even en masse with <code class="literal">nix-shell maintainers/scripts/update.nix --argstr path gnome</code>. Read the package’s <code class="literal">NEWS</code> file to see what changed.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-gnome-common-issues"></a>15.9.4. Frequently encountered issues</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-common-issues-no-schemas"></a>15.9.4.1. <code class="literal">GLib-GIO-ERROR **: 06:04:50.903: No GSettings schemas are installed on the system</code></h4></div></div></div><p>
       There are no schemas available in <code class="literal">XDG_DATA_DIRS</code>. Temporarily add a random package containing schemas like <code class="literal">gsettings-desktop-schemas</code> to <code class="literal">buildInputs</code>. <a class="link" href="#ssec-gnome-hooks-glib"><code class="literal">glib</code></a> and <a class="link" href="#ssec-gnome-hooks-wrapgappshook"><code class="literal">wrapGAppsHook</code></a> setup hooks will take care of making the schemas available to application and you will see the actual missing schemas with the <a class="link" href="#ssec-gnome-common-issues-missing-schema" title="15.9.4.2. GLib-GIO-ERROR **: 06:04:50.903: Settings schema ‘org.gnome.foo’ is not installed">next error</a>. Or you can try looking through the source code for the actual schemas used.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-common-issues-missing-schema"></a>15.9.4.2. <code class="literal">GLib-GIO-ERROR **: 06:04:50.903: Settings schema ‘org.gnome.foo’ is not installed</code></h4></div></div></div><p>
       Package is missing some GSettings schemas. You can find out the package containing the schema with <code class="literal">nix-locate org.gnome.foo.gschema.xml</code> and let the hooks handle the wrapping as <a class="link" href="#ssec-gnome-common-issues-no-schemas" title="15.9.4.1. GLib-GIO-ERROR **: 06:04:50.903: No GSettings schemas are installed on the system">above</a>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-common-issues-double-wrapped"></a>15.9.4.3. When using <code class="literal">wrapGAppsHook</code> with special derivers you can end up with double wrapped binaries.</h4></div></div></div><p>
       This is because derivers like <code class="literal">python.pkgs.buildPythonApplication</code> or <code class="literal">qt5.mkDerivation</code> have setup-hooks automatically added that produce wrappers with makeWrapper. The simplest way to workaround that is to disable the <code class="literal">wrapGAppsHook</code> automatic wrapping with <code class="literal">dontWrapGApps = true;</code> and pass the arguments it intended to pass to makeWrapper to another.
      </p><p>
       In the case of a Python application it could look like:
      </p><pre class="programlisting">
python3.pkgs.buildPythonApplication {
  pname = "gnome-music";
  version = "3.32.2";

  nativeBuildInputs = [
    wrapGAppsHook
    gobject-introspection
    ...
  ];

  dontWrapGApps = true;

  # Arguments to be passed to `makeWrapper`, only used by buildPython*
  preFixup = ''
    makeWrapperArgs+=("''${gappsWrapperArgs[@]}")
  '';
}
</pre><p>
       And for a QT app like:
      </p><pre class="programlisting">
mkDerivation {
  pname = "calibre";
  version = "3.47.0";

  nativeBuildInputs = [
    wrapGAppsHook
    qmake
    ...
  ];

  dontWrapGApps = true;

  # Arguments to be passed to `makeWrapper`, only used by qt5’s mkDerivation
  preFixup = ''
    qtWrapperArgs+=("''${gappsWrapperArgs[@]}")
  '';
}
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-common-issues-unwrappable-package"></a>15.9.4.4. I am packaging a project that cannot be wrapped, like a library or GNOME Shell extension.</h4></div></div></div><p>
       You can rely on applications depending on the library setting the necessary environment variables but that is often easy to miss. Instead we recommend to patch the paths in the source code whenever possible. Here are some examples:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
         <a id="ssec-gnome-common-issues-unwrappable-package-gnome-shell-ext"></a>
         <a class="link" href="https://github.com/NixOS/nixpkgs/blob/7bb8f05f12ca3cff9da72b56caa2f7472d5732bc/pkgs/desktops/gnome-3/core/gnome-shell-extensions/default.nix#L21-L24" target="_top">Replacing a <code class="literal">GI_TYPELIB_PATH</code> in GNOME Shell extension</a> – we are using <code class="literal">substituteAll</code> to include the path to a typelib into a patch.
        </p></li><li class="listitem"><p>
         <a id="ssec-gnome-common-issues-unwrappable-package-gsettings"></a>
         The following examples are hardcoding GSettings schema paths. To get the schema paths we use the functions
        </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
           <code class="literal">glib.getSchemaPath</code> Takes a nix package attribute as an argument.
          </p></li><li class="listitem"><p>
           <code class="literal">glib.makeSchemaPath</code> Takes a package output like <code class="literal">$out</code> and a derivation name. You should use this if the schemas you need to hardcode are in the same derivation.
          </p></li></ul></div><p>
         <a id="ssec-gnome-common-issues-unwrappable-package-gsettings-vala"></a>
         <a class="link" href="https://github.com/NixOS/nixpkgs/blob/7bb8f05f12ca3cff9da72b56caa2f7472d5732bc/pkgs/desktops/pantheon/apps/elementary-files/default.nix#L78-L86" target="_top">Hard-coding GSettings schema path in Vala plug-in (dynamically loaded library)</a> – here, <code class="literal">substituteAll</code> cannot be used since the schema comes from the same package preventing us from pass its path to the function, probably due to a <a class="link" href="https://github.com/NixOS/nix/issues/1846" target="_top">Nix bug</a>.
        </p><p>
         <a id="ssec-gnome-common-issues-unwrappable-package-gsettings-c"></a>
         <a class="link" href="https://github.com/NixOS/nixpkgs/blob/29c120c065d03b000224872251bed93932d42412/pkgs/development/libraries/glib-networking/default.nix#L31-L34" target="_top">Hard-coding GSettings schema path in C library</a> – nothing special other than using <a class="link" href="https://github.com/NixOS/nixpkgs/pull/67957#issuecomment-527717467" target="_top">Coccinelle patch</a> to generate the patch itself.
        </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-gnome-common-issues-weird-location"></a>15.9.4.5. I need to wrap a binary outside <code class="literal">bin</code> and <code class="literal">libexec</code> directories.</h4></div></div></div><p>
       You can manually trigger the wrapping with <code class="literal">wrapGApp</code> in <code class="literal">preFixup</code> phase. It takes a path to a program as a first argument; the remaining arguments are passed directly to <a class="link" href="#fun-wrapProgram" title="6.6.7. wrapProgram &lt;executable&gt; &lt;makeWrapperArgs&gt;"><code class="literal">wrapProgram</code></a> function.
      </p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-language-go"></a>15.10. Go</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-language-go"></a>15.10.1. Go modules</h3></div></div></div><p>
      The function <code class="literal">buildGoModule</code> builds Go programs managed with Go modules. It builds a <a class="link" href="https://github.com/golang/go/wiki/Modules" target="_top">Go Modules</a> through a two phase build:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        An intermediate fetcher derivation. This derivation will be used to fetch all of the dependencies of the Go module.
       </p></li><li class="listitem"><p>
        A final derivation will use the output of the intermediate derivation to build the binaries and produce the final output.
       </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ex-buildGoModule"></a>15.10.1.1. Example for <code class="literal">buildGoModule</code></h4></div></div></div><p>
       In the following is an example expression using <code class="literal">buildGoModule</code>, the following arguments are of special significance to the function:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         <code class="literal">vendorSha256</code>: is the hash of the output of the intermediate fetcher derivation. <code class="literal">vendorSha256</code> can also take <code class="literal">null</code> as an input. When <code class="literal">null</code> is used as a value, rather than fetching the dependencies and vendoring them, we use the vendoring included within the source repo. If you’d like to not have to update this field on dependency changes, run <code class="literal">go mod vendor</code> in your source repo and set <code class="literal">vendorSha256 = null;</code>
        </p></li><li class="listitem"><p>
         <code class="literal">runVend</code>: runs the vend command to generate the vendor directory. This is useful if your code depends on c code and go mod tidy does not include the needed sources to build.
        </p></li></ul></div><pre class="programlisting">
pet = buildGoModule rec {
  pname = "pet";
  version = "0.3.4";

  src = fetchFromGitHub {
    owner = "knqyf263";
    repo = "pet";
    rev = "v${version}";
    sha256 = "0m2fzpqxk7hrbxsgqplkg7h2p7gv6s1miymv3gvw0cz039skag0s";
  };

  vendorSha256 = "1879j77k96684wi554rkjxydrj8g3hpp0kvxz03sd8dmwr3lh83j";

  runVend = true;

  meta = with lib; {
    description = "Simple command-line snippet manager, written in Go";
    homepage = "https://github.com/knqyf263/pet";
    license = licenses.mit;
    maintainers = with maintainers; [ kalbasit ];
    platforms = platforms.linux ++ platforms.darwin;
  };
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-go-legacy"></a>15.10.2. <code class="literal">buildGoPackage</code> (legacy)</h3></div></div></div><p>
      The function <code class="literal">buildGoPackage</code> builds legacy Go programs, not supporting Go modules.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="example-for-buildgopackage"></a>15.10.2.1. Example for <code class="literal">buildGoPackage</code></h4></div></div></div><p>
       In the following is an example expression using buildGoPackage, the following arguments are of special significance to the function:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         <code class="literal">goPackagePath</code> specifies the package’s canonical Go import path.
        </p></li><li class="listitem"><p>
         <code class="literal">goDeps</code> is where the Go dependencies of a Go program are listed as a list of package source identified by Go import path. It could be imported as a separate <code class="literal">deps.nix</code> file for readability. The dependency data structure is described below.
        </p></li></ul></div><pre class="programlisting">
deis = buildGoPackage rec {
  pname = "deis";
  version = "1.13.0";

  goPackagePath = "github.com/deis/deis";

  src = fetchFromGitHub {
    owner = "deis";
    repo = "deis";
    rev = "v${version}";
    sha256 = "1qv9lxqx7m18029lj8cw3k7jngvxs4iciwrypdy0gd2nnghc68sw";
  };

  goDeps = ./deps.nix;
}
</pre><p>
       The <code class="literal">goDeps</code> attribute can be imported from a separate <code class="literal">nix</code> file that defines which Go libraries are needed and should be included in <code class="literal">GOPATH</code> for <code class="literal">buildPhase</code>:
      </p><pre class="programlisting">
# deps.nix
[ # goDeps is a list of Go dependencies.
  {
    # goPackagePath specifies Go package import path.
    goPackagePath = "gopkg.in/yaml.v2";
    fetch = {
      # `fetch type` that needs to be used to get package source.
      # If `git` is used there should be `url`, `rev` and `sha256` defined next to it.
      type = "git";
      url = "https://gopkg.in/yaml.v2";
      rev = "a83829b6f1293c91addabc89d0571c246397bbf4";
      sha256 = "1m4dsmk90sbi17571h6pld44zxz7jc4lrnl4f27dpd1l8g5xvjhh";
    };
  }
  {
    goPackagePath = "github.com/docopt/docopt-go";
    fetch = {
      type = "git";
      url = "https://github.com/docopt/docopt-go";
      rev = "784ddc588536785e7299f7272f39101f7faccc3f";
      sha256 = "0wwz48jl9fvl1iknvn9dqr4gfy1qs03gxaikrxxp9gry6773v3sj";
    };
  }
]
</pre><p>
       To extract dependency information from a Go package in automated way use <a class="link" href="https://github.com/kamilchm/go2nix" target="_top">go2nix</a>. It can produce complete derivation and <code class="literal">goDeps</code> file for Go programs.
      </p><p>
       You may use Go packages installed into the active Nix profiles by adding the following to your ~/.bashrc:
      </p><pre class="programlisting">
for p in $NIX_PROFILES; do
    GOPATH="$p/share/go:$GOPATH"
done
</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-go-common-attributes"></a>15.10.3. Attributes used by the builders</h3></div></div></div><p>
      Both <code class="literal">buildGoModule</code> and <code class="literal">buildGoPackage</code> can be tweaked to behave slightly differently, if the following attributes are used:
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ex-goBuildFlags-noarray"></a>15.10.3.1. <code class="literal">buildFlagsArray</code> and <code class="literal">buildFlags</code>:</h4></div></div></div><p>
       These attributes set build flags supported by <code class="literal">go build</code>. We recommend using <code class="literal">buildFlagsArray</code>. The most common use case of these attributes is to make the resulting executable aware of its own version. For example:
      </p><pre class="programlisting">
  buildFlagsArray = [
    # Note: single quotes are not needed.
    "-ldflags=-X main.Version=${version} -X main.Commit=${version}"
  ];
</pre><pre class="programlisting">
  buildFlagsArray = ''
    -ldflags=
    -X main.Version=${version}
    -X main.Commit=${version}
  '';
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-go-deleteVendor"></a>15.10.3.2. <code class="literal">deleteVendor</code></h4></div></div></div><p>
       Removes the pre-existing vendor directory. This should only be used if the dependencies included in the vendor folder are broken or incomplete.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="var-go-subPackages"></a>15.10.3.3. <code class="literal">subPackages</code></h4></div></div></div><p>
       Limits the builder from building child packages that have not been listed. If <code class="varname">subPackages</code> is not specified, all child packages will be built.
      </p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="haskell"></a>15.11. Haskell</h2></div></div></div><p>
     The documentation for the Haskell infrastructure is published at <a class="link" href="https://haskell4nix.readthedocs.io/" target="_top">https://haskell4nix.readthedocs.io/</a>. The source code for that site lives in the <code class="literal">doc/</code> sub-directory of the <a class="link" href="https://github.com/NixOS/cabal2nix" target="_top"><code class="literal">cabal2nix</code> Git repository</a> and changes can be submitted there.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="idris"></a>15.12. Idris</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="installing-idris"></a>15.12.1. Installing Idris</h3></div></div></div><p>
      The easiest way to get a working idris version is to install the <code class="literal">idris</code> attribute:
     </p><pre class="programlisting">
$ # On NixOS
$ nix-env -i nixos.idris
$ # On non-NixOS
$ nix-env -i nixpkgs.idris
</pre><p>
      This however only provides the <code class="literal">prelude</code> and <code class="literal">base</code> libraries. To install idris with additional libraries, you can use the <code class="literal">idrisPackages.with-packages</code> function, e.g. in an overlay in <code class="literal">~/.config/nixpkgs/overlays/my-idris.nix</code>:
     </p><pre class="programlisting">
self: super: {
  myIdris = with self.idrisPackages; with-packages [ contrib pruviloj ];
}
</pre><p>
      And then:
     </p><pre class="programlisting">
$ # On NixOS
$ nix-env -iA nixos.myIdris
$ # On non-NixOS
$ nix-env -iA nixpkgs.myIdris
</pre><p>
      To see all available Idris packages:
     </p><pre class="programlisting">
$ # On NixOS
$ nix-env -qaPA nixos.idrisPackages
$ # On non-NixOS
$ nix-env -qaPA nixpkgs.idrisPackages
</pre><p>
      Similarly, entering a <code class="literal">nix-shell</code>:
     </p><pre class="programlisting">
$ nix-shell -p 'idrisPackages.with-packages (with idrisPackages; [ contrib pruviloj ])'
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="starting-idris-with-library-support"></a>15.12.2. Starting Idris with library support</h3></div></div></div><p>
      To have access to these libraries in idris, call it with an argument <code class="literal">-p &lt;library name&gt;</code> for each library:
     </p><pre class="programlisting">
$ nix-shell -p 'idrisPackages.with-packages (with idrisPackages; [ contrib pruviloj ])'
[nix-shell:~]$ idris -p contrib -p pruviloj
</pre><p>
      A listing of all available packages the Idris binary has access to is available via <code class="literal">--listlibs</code>:
     </p><pre class="programlisting">
$ idris --listlibs
00prelude-idx.ibc
pruviloj
base
contrib
prelude
00pruviloj-idx.ibc
00base-idx.ibc
00contrib-idx.ibc
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="building-an-idris-project-with-nix"></a>15.12.3. Building an Idris project with Nix</h3></div></div></div><p>
      As an example of how a Nix expression for an Idris package can be created, here is the one for <code class="literal">idrisPackages.yaml</code>:
     </p><pre class="programlisting">
{ lib
, build-idris-package
, fetchFromGitHub
, contrib
, lightyear
}:
build-idris-package  {
  name = "yaml";
  version = "2018-01-25";

  # This is the .ipkg file that should be built, defaults to the package name
  # In this case it should build `Yaml.ipkg` instead of `yaml.ipkg`
  # This is only necessary because the yaml packages ipkg file is
  # different from its package name here.
  ipkgName = "Yaml";
  # Idris dependencies to provide for the build
  idrisDeps = [ contrib lightyear ];

  src = fetchFromGitHub {
    owner = "Heather";
    repo = "Idris.Yaml";
    rev = "5afa51ffc839844862b8316faba3bafa15656db4";
    sha256 = "1g4pi0swmg214kndj85hj50ccmckni7piprsxfdzdfhg87s0avw7";
  };

  meta = with lib; {
    description = "Idris YAML lib";
    homepage = "https://github.com/Heather/Idris.Yaml";
    license = licenses.mit;
    maintainers = [ maintainers.brainrape ];
  };
}
</pre><p>
      Assuming this file is saved as <code class="literal">yaml.nix</code>, it’s buildable using
     </p><pre class="programlisting">
$ nix-build -E '(import &lt;nixpkgs&gt; {}).idrisPackages.callPackage ./yaml.nix {}'
</pre><p>
      Or it’s possible to use
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

{
  yaml = idrisPackages.callPackage ./yaml.nix {};
}
</pre><p>
      in another file (say <code class="literal">default.nix</code>) to be able to build it with
     </p><pre class="programlisting">
$ nix-build -A yaml
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="passing-options-to-idris-commands"></a>15.12.4. Passing options to <code class="literal">idris</code> commands</h3></div></div></div><p>
      The <code class="literal">build-idris-package</code> function provides also optional input values to set additional options for the used <code class="literal">idris</code> commands.
     </p><p>
      Specifically, you can set <code class="literal">idrisBuildOptions</code>, <code class="literal">idrisTestOptions</code>, <code class="literal">idrisInstallOptions</code> and <code class="literal">idrisDocOptions</code> to provide additional options to the <code class="literal">idris</code> command respectively when building, testing, installing and generating docs for your package.
     </p><p>
      For example you could set
     </p><pre class="programlisting">
build-idris-package {
  idrisBuildOptions = [ "--log" "1" "--verbose" ]

  ...
}
</pre><p>
      to require verbose output during <code class="literal">idris</code> build phase.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ios"></a>15.13. iOS</h2></div></div></div><p>
     This component is basically a wrapper/workaround that makes it possible to expose an Xcode installation as a Nix package by means of symlinking to the relevant executables on the host system.
    </p><p>
     Since Xcode can’t be packaged with Nix, nor we can publish it as a Nix package (because of its license) this is basically the only integration strategy making it possible to do iOS application builds that integrate with other components of the Nix ecosystem
    </p><p>
     The primary objective of this project is to use the Nix expression language to specify how iOS apps can be built from source code, and to automatically spawn iOS simulator instances for testing.
    </p><p>
     This component also makes it possible to use <a class="link" href="https://nixos.org/hydra" target="_top">Hydra</a>, the Nix-based continuous integration server to regularly build iOS apps and to do wireless ad-hoc installations of enterprise IPAs on iOS devices through Hydra.
    </p><p>
     The Xcode build environment implements a number of features.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="deploying-a-proxy-component-wrapper-exposing-xcode"></a>15.13.1. Deploying a proxy component wrapper exposing Xcode</h3></div></div></div><p>
      The first use case is deploying a Nix package that provides symlinks to the Xcode installation on the host system. This package can be used as a build input to any build function implemented in the Nix expression language that requires Xcode.
     </p><pre class="programlisting">
let
  pkgs = import &lt;nixpkgs&gt; {};

  xcodeenv = import ./xcodeenv {
    inherit (pkgs) stdenv;
  };
in
xcodeenv.composeXcodeWrapper {
  version = "9.2";
  xcodeBaseDir = "/Applications/Xcode.app";
}
</pre><p>
      By deploying the above expression with <code class="literal">nix-build</code> and inspecting its content you will notice that several Xcode-related executables are exposed as a Nix package:
     </p><pre class="programlisting">
$ ls result/bin
lrwxr-xr-x  1 sander  staff  94  1 jan  1970 Simulator -&gt; /Applications/Xcode.app/Contents/Developer/Applications/Simulator.app/Contents/MacOS/Simulator
lrwxr-xr-x  1 sander  staff  17  1 jan  1970 codesign -&gt; /usr/bin/codesign
lrwxr-xr-x  1 sander  staff  17  1 jan  1970 security -&gt; /usr/bin/security
lrwxr-xr-x  1 sander  staff  21  1 jan  1970 xcode-select -&gt; /usr/bin/xcode-select
lrwxr-xr-x  1 sander  staff  61  1 jan  1970 xcodebuild -&gt; /Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild
lrwxr-xr-x  1 sander  staff  14  1 jan  1970 xcrun -&gt; /usr/bin/xcrun
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="building-an-ios-application"></a>15.13.2. Building an iOS application</h3></div></div></div><p>
      We can build an iOS app executable for the simulator, or an IPA/xcarchive file for release purposes, e.g. ad-hoc, enterprise or store installations, by executing the <code class="literal">xcodeenv.buildApp {}</code> function:
     </p><pre class="programlisting">
let
  pkgs = import &lt;nixpkgs&gt; {};

  xcodeenv = import ./xcodeenv {
    inherit (pkgs) stdenv;
  };
in
xcodeenv.buildApp {
  name = "MyApp";
  src = ./myappsources;
  sdkVersion = "11.2";

  target = null; # Corresponds to the name of the app by default
  configuration = null; # Release for release builds, Debug for debug builds
  scheme = null; # -scheme will correspond to the app name by default
  sdk = null; # null will set it to 'iphonesimulator` for simulator builds or `iphoneos` to real builds
  xcodeFlags = "";

  release = true;
  certificateFile = ./mycertificate.p12;
  certificatePassword = "secret";
  provisioningProfile = ./myprovisioning.profile;
  signMethod = "ad-hoc"; # 'enterprise' or 'store'
  generateIPA = true;
  generateXCArchive = false;

  enableWirelessDistribution = true;
  installURL = "/installipa.php";
  bundleId = "mycompany.myapp";
  appVersion = "1.0";

  # Supports all xcodewrapper parameters as well
  xcodeBaseDir = "/Applications/Xcode.app";
}
</pre><p>
      The above function takes a variety of parameters: * The <code class="literal">name</code> and <code class="literal">src</code> parameters are mandatory and specify the name of the app and the location where the source code resides * <code class="literal">sdkVersion</code> specifies which version of the iOS SDK to use.
     </p><p>
      It also possile to adjust the <code class="literal">xcodebuild</code> parameters. This is only needed in rare circumstances. In most cases the default values should suffice:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        Specifies which <code class="literal">xcodebuild</code> target to build. By default it takes the target that has the same name as the app.
       </p></li><li class="listitem"><p>
        The <code class="literal">configuration</code> parameter can be overridden if desired. By default, it will do a debug build for the simulator and a release build for real devices.
       </p></li><li class="listitem"><p>
        The <code class="literal">scheme</code> parameter specifies which <code class="literal">-scheme</code> parameter to propagate to <code class="literal">xcodebuild</code>. By default, it corresponds to the app name.
       </p></li><li class="listitem"><p>
        The <code class="literal">sdk</code> parameter specifies which SDK to use. By default, it picks <code class="literal">iphonesimulator</code> for simulator builds and <code class="literal">iphoneos</code> for release builds.
       </p></li><li class="listitem"><p>
        The <code class="literal">xcodeFlags</code> parameter specifies arbitrary command line parameters that should be propagated to <code class="literal">xcodebuild</code>.
       </p></li></ul></div><p>
      By default, builds are carried out for the iOS simulator. To do release builds (builds for real iOS devices), you must set the <code class="literal">release</code> parameter to <code class="literal">true</code>. In addition, you need to set the following parameters:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">certificateFile</code> refers to a P12 certificate file.
       </p></li><li class="listitem"><p>
        <code class="literal">certificatePassword</code> specifies the password of the P12 certificate.
       </p></li><li class="listitem"><p>
        <code class="literal">provisioningProfile</code> refers to the provision profile needed to sign the app
       </p></li><li class="listitem"><p>
        <code class="literal">signMethod</code> should refer to <code class="literal">ad-hoc</code> for signing the app with an ad-hoc certificate, <code class="literal">enterprise</code> for enterprise certificates and <code class="literal">app-store</code> for App store certificates.
       </p></li><li class="listitem"><p>
        <code class="literal">generateIPA</code> specifies that we want to produce an IPA file (this is probably what you want)
       </p></li><li class="listitem"><p>
        <code class="literal">generateXCArchive</code> specifies thet we want to produce an xcarchive file.
       </p></li></ul></div><p>
      When building IPA files on Hydra and when it is desired to allow iOS devices to install IPAs by browsing to the Hydra build products page, you can enable the <code class="literal">enableWirelessDistribution</code> parameter.
     </p><p>
      When enabled, you need to configure the following options:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        The <code class="literal">installURL</code> parameter refers to the URL of a PHP script that composes the <code class="literal">itms-services://</code> URL allowing iOS devices to install the IPA file.
       </p></li><li class="listitem"><p>
        <code class="literal">bundleId</code> refers to the bundle ID value of the app
       </p></li><li class="listitem"><p>
        <code class="literal">appVersion</code> refers to the app’s version number
       </p></li></ul></div><p>
      To use wireless adhoc distributions, you must also install the corresponding PHP script on a web server (see section: <span class="quote">“<span class="quote">Installing the PHP script for wireless ad hoc installations from Hydra</span>”</span> for more information).
     </p><p>
      In addition to the build parameters, you can also specify any parameters that the <code class="literal">xcodeenv.composeXcodeWrapper {}</code> function takes. For example, the <code class="literal">xcodeBaseDir</code> parameter can be overridden to refer to a different Xcode version.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="spawning-simulator-instances"></a>15.13.3. Spawning simulator instances</h3></div></div></div><p>
      In addition to building iOS apps, we can also automatically spawn simulator instances:
     </p><pre class="programlisting">
let
  pkgs = import &lt;nixpkgs&gt; {};

  xcodeenv = import ./xcodeenv {
    inherit (pkgs) stdenv;
  };
in
xcode.simulateApp {
  name = "simulate";

  # Supports all xcodewrapper parameters as well
  xcodeBaseDir = "/Applications/Xcode.app";
}
</pre><p>
      The above expression produces a script that starts the simulator from the provided Xcode installation. The script can be started as follows:
     </p><pre class="programlisting">
./result/bin/run-test-simulator
</pre><p>
      By default, the script will show an overview of UDID for all available simulator instances and asks you to pick one. You can also provide a UDID as a command-line parameter to launch an instance automatically:
     </p><pre class="programlisting">
./result/bin/run-test-simulator 5C93129D-CF39-4B1A-955F-15180C3BD4B8
</pre><p>
      You can also extend the simulator script to automatically deploy and launch an app in the requested simulator instance:
     </p><pre class="programlisting">
let
  pkgs = import &lt;nixpkgs&gt; {};

  xcodeenv = import ./xcodeenv {
    inherit (pkgs) stdenv;
  };
in
xcode.simulateApp {
  name = "simulate";
  bundleId = "mycompany.myapp";
  app = xcode.buildApp {
    # ...
  };

  # Supports all xcodewrapper parameters as well
  xcodeBaseDir = "/Applications/Xcode.app";
}
</pre><p>
      By providing the result of an <code class="literal">xcode.buildApp {}</code> function and configuring the app bundle id, the app gets deployed automatically and started.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="troubleshooting"></a>15.13.4. Troubleshooting</h3></div></div></div><p>
      In some rare cases, it may happen that after a failure, changes are not picked up. Most likely, this is caused by a derived data cache that Xcode maintains. To wipe it you can run:
     </p><pre class="programlisting">
$ rm -rf ~/Library/Developer/Xcode/DerivedData
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-language-java"></a>15.14. Java</h2></div></div></div><p>
     Ant-based Java packages are typically built from source as follows:
    </p><pre class="programlisting">
stdenv.mkDerivation {
  name = "...";
  src = fetchurl { ... };

  nativeBuildInputs = [ jdk ant ];

  buildPhase = "ant";
}
</pre><p>
     Note that <code class="literal">jdk</code> is an alias for the OpenJDK (self-built where available, or pre-built via Zulu). Platforms with OpenJDK not (yet) in Nixpkgs (<code class="literal">Aarch32</code>, <code class="literal">Aarch64</code>) point to the (unfree) <code class="literal">oraclejdk</code>.
    </p><p>
     JAR files that are intended to be used by other packages should be installed in <code class="literal">$out/share/java</code>. JDKs have a stdenv setup hook that add any JARs in the <code class="literal">share/java</code> directories of the build inputs to the <code class="literal">CLASSPATH</code> environment variable. For instance, if the package <code class="literal">libfoo</code> installs a JAR named <code class="literal">foo.jar</code> in its <code class="literal">share/java</code> directory, and another package declares the attribute
    </p><pre class="programlisting">
buildInputs = [ libfoo ];
nativeBuildInputs = [ jdk ];
</pre><p>
     then <code class="literal">CLASSPATH</code> will be set to <code class="literal">/nix/store/...-libfoo/share/java/foo.jar</code>.
    </p><p>
     Private JARs should be installed in a location like <code class="literal">$out/share/package-name</code>.
    </p><p>
     If your Java package provides a program, you need to generate a wrapper script to run it using a JRE. You can use <code class="literal">makeWrapper</code> for this:
    </p><pre class="programlisting">
nativeBuildInputs = [ makeWrapper ];

installPhase = ''
  mkdir -p $out/bin
  makeWrapper ${jre}/bin/java $out/bin/foo \
    --add-flags "-cp $out/share/java/foo.jar org.foo.Main"
'';
</pre><p>
     Since the introduction of the Java Platform Module System in Java 9, Java distributions typically no longer ship with a general-purpose JRE: instead, they allow generating a JRE with only the modules required for your application(s). Because we can’t predict what modules will be needed on a general-purpose system, the default jre package is the full JDK. When building a minimal system/image, you can override the <code class="literal">modules</code> parameter on <code class="literal">jre_minimal</code> to build a JRE with only the modules relevant for you:
    </p><pre class="programlisting">
let
  my_jre = pkgs.jre_minimal.override {
    modules = [
      # The modules used by 'something' and 'other' combined:
      "java.base"
      "java.logging"
    ];
  };
  something = (pkgs.something.override { jre = my_jre; });
  other = (pkgs.other.override { jre = my_jre; });
in
  ...
</pre><p>
     Note all JDKs passthru <code class="literal">home</code>, so if your application requires environment variables like <code class="literal">JAVA_HOME</code> being set, that can be done in a generic fashion with the <code class="literal">--set</code> argument of <code class="literal">makeWrapper</code>:
    </p><pre class="programlisting">
--set JAVA_HOME ${jdk.home}
</pre><p>
     It is possible to use a different Java compiler than <code class="literal">javac</code> from the OpenJDK. For instance, to use the GNU Java Compiler:
    </p><pre class="programlisting">
nativeBuildInputs = [ gcj ant ];
</pre><p>
     Here, Ant will automatically use <code class="literal">gij</code> (the GNU Java Runtime) instead of the OpenJRE.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="users-guide-to-lua-infrastructure"></a>15.15. User’s Guide to Lua Infrastructure</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="using-lua"></a>15.15.1. Using Lua</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="overview-of-lua"></a>15.15.1.1. Overview of Lua</h4></div></div></div><p>
       Several versions of the Lua interpreter are available: luajit, lua 5.1, 5.2, 5.3. The attribute <code class="literal">lua</code> refers to the default interpreter, it is also possible to refer to specific versions, e.g. <code class="literal">lua5_2</code> refers to Lua 5.2.
      </p><p>
       Lua libraries are in separate sets, with one set per interpreter version.
      </p><p>
       The interpreters have several common attributes. One of these attributes is <code class="literal">pkgs</code>, which is a package set of Lua libraries for this specific interpreter. E.g., the <code class="literal">busted</code> package corresponding to the default interpreter is <code class="literal">lua.pkgs.busted</code>, and the lua 5.2 version is <code class="literal">lua5_2.pkgs.busted</code>. The main package set contains aliases to these package sets, e.g. <code class="literal">luaPackages</code> refers to <code class="literal">lua5_1.pkgs</code> and <code class="literal">lua52Packages</code> to <code class="literal">lua5_2.pkgs</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="installing-lua-and-packages"></a>15.15.1.2. Installing Lua and packages</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="lua-environment-defined-in-separate-.nix-file"></a>15.15.1.2.1. Lua environment defined in separate <code class="literal">.nix</code> file</h5></div></div></div><p>
        Create a file, e.g. <code class="literal">build.nix</code>, with the following expression
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

lua5_2.withPackages (ps: with ps; [ busted luafilesystem ])
</pre><p>
        and install it in your profile with
       </p><pre class="programlisting">
nix-env -if build.nix
</pre><p>
        Now you can use the Lua interpreter, as well as the extra packages (<code class="literal">busted</code>, <code class="literal">luafilesystem</code>) that you added to the environment.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="lua-environment-defined-in-.confignixpkgsconfig.nix"></a>15.15.1.2.2. Lua environment defined in <code class="literal">~/.config/nixpkgs/config.nix</code></h5></div></div></div><p>
        If you prefer to, you could also add the environment as a package override to the Nixpkgs set, e.g. using <code class="literal">config.nix</code>,
       </p><pre class="programlisting">
{ # ...

  packageOverrides = pkgs: with pkgs; {
    myLuaEnv = lua5_2.withPackages (ps: with ps; [ busted luafilesystem ]);
  };
}
</pre><p>
        and install it in your profile with
       </p><pre class="programlisting">
nix-env -iA nixpkgs.myLuaEnv
</pre><p>
        The environment is installed by referring to the attribute, and considering the <code class="literal">nixpkgs</code> channel was used.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="lua-environment-defined-in-etcnixosconfiguration.nix"></a>15.15.1.2.3. Lua environment defined in <code class="literal">/etc/nixos/configuration.nix</code></h5></div></div></div><p>
        For the sake of completeness, here’s another example how to install the environment system-wide.
       </p><pre class="programlisting">
{ # ...

  environment.systemPackages = with pkgs; [
    (lua.withPackages(ps: with ps; [ busted luafilesystem ]))
  ];
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="how-to-override-a-lua-package-using-overlays"></a>15.15.1.3. How to override a Lua package using overlays?</h4></div></div></div><p>
       Use the following overlay template:
      </p><pre class="programlisting">
final: prev:
{

  lua = prev.lua.override {
    packageOverrides = luaself: luaprev: {

      luarocks-nix = luaprev.luarocks-nix.overrideAttrs(oa: {
        pname = "luarocks-nix";
        src = /home/my_luarocks/repository;
      });
  };

  luaPackages = lua.pkgs;
}
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="temporary-lua-environment-with-nix-shell"></a>15.15.1.4. Temporary Lua environment with <code class="literal">nix-shell</code></h4></div></div></div><p>
       There are two methods for loading a shell with Lua packages. The first and recommended method is to create an environment with <code class="literal">lua.buildEnv</code> or <code class="literal">lua.withPackages</code> and load that. E.g.
      </p><pre class="programlisting">
$ nix-shell -p 'lua.withPackages(ps: with ps; [ busted luafilesystem ])'
</pre><p>
       opens a shell from which you can launch the interpreter
      </p><pre class="programlisting">
[nix-shell:~] lua
</pre><p>
       The other method, which is not recommended, does not create an environment and requires you to list the packages directly,
      </p><pre class="programlisting">
$ nix-shell -p lua.pkgs.busted lua.pkgs.luafilesystem
</pre><p>
       Again, it is possible to launch the interpreter from the shell. The Lua interpreter has the attribute <code class="literal">pkgs</code> which contains all Lua libraries for that specific interpreter.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="developing-with-lua"></a>15.15.2. Developing with Lua</h3></div></div></div><p>
      Now that you know how to get a working Lua environment with Nix, it is time to go forward and start actually developing with Lua. There are two ways to package lua software, either it is on luarocks and most of it can be taken care of by the luarocks2nix converter or the packaging has to be done manually. Let’s present the luarocks way first and the manual one in a second time.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="packaging-a-library-on-luarocks"></a>15.15.2.1. Packaging a library on luarocks</h4></div></div></div><p>
       <a class="link" href="www.luarocks.org" target="_top">Luarocks.org</a> is the main repository of lua packages. The site proposes two types of packages, the rockspec and the src.rock (equivalent of a <a class="link" href="https://github.com/luarocks/luarocks/wiki/Rockspec-format" target="_top">rockspec</a> but with the source). These packages can have different build types such as <code class="literal">cmake</code>, <code class="literal">builtin</code> etc .
      </p><p>
       Luarocks-based packages are generated in pkgs/development/lua-modules/generated-packages.nix from the whitelist maintainers/scripts/luarocks-packages.csv and updated by running maintainers/scripts/update-luarocks-packages.
      </p><p>
       <a class="link" href="https://github.com/nix-community/luarocks" target="_top">luarocks2nix</a> is a tool capable of generating nix derivations from both rockspec and src.rock (and favors the src.rock). The automation only goes so far though and some packages need to be customized. These customizations go in <code class="literal">pkgs/development/lua-modules/overrides.nix</code>. For instance if the rockspec defines <code class="literal">external_dependencies</code>, these need to be manually added in its rockspec file then it won’t work.
      </p><p>
       You can try converting luarocks packages to nix packages with the command <code class="literal">nix-shell -p luarocks-nix</code> and then <code class="literal">luarocks nix PKG_NAME</code>. Nix rely on luarocks to install lua packages, basically it runs: <code class="literal">luarocks make --deps-mode=none --tree $out</code>
      </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="packaging-a-library-manually"></a>15.15.2.1.1. Packaging a library manually</h5></div></div></div><p>
        You can develop your package as you usually would, just don’t forget to wrap it within a <code class="literal">toLuaModule</code> call, for instance
       </p><pre class="programlisting">
mynewlib = toLuaModule ( stdenv.mkDerivation { ... });
</pre><p>
        There is also the <code class="literal">buildLuaPackage</code> function that can be used when lua modules are not packaged for luarocks. You can see a few examples at <code class="literal">pkgs/top-level/lua-packages.nix</code>.
       </p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="lua-reference"></a>15.15.3. Lua Reference</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="lua-interpreters"></a>15.15.3.1. Lua interpreters</h4></div></div></div><p>
       Versions 5.1, 5.2 and 5.3 of the lua interpreter are available as respectively <code class="literal">lua5_1</code>, <code class="literal">lua5_2</code> and <code class="literal">lua5_3</code>. Luajit is available too. The Nix expressions for the interpreters can be found in <code class="literal">pkgs/development/interpreters/lua-5</code>.
      </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="attributes-on-lua-interpreters-packages"></a>15.15.3.1.1. Attributes on lua interpreters packages</h5></div></div></div><p>
        Each interpreter has the following attributes:
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="literal">interpreter</code>. Alias for <code class="literal">${pkgs.lua}/bin/lua</code>.
         </p></li><li class="listitem"><p>
          <code class="literal">buildEnv</code>. Function to build lua interpreter environments with extra packages bundled together. See section <span class="emphasis"><em>lua.buildEnv function</em></span> for usage and documentation.
         </p></li><li class="listitem"><p>
          <code class="literal">withPackages</code>. Simpler interface to <code class="literal">buildEnv</code>.
         </p></li><li class="listitem"><p>
          <code class="literal">pkgs</code>. Set of Lua packages for that specific interpreter. The package set can be modified by overriding the interpreter and passing <code class="literal">packageOverrides</code>.
         </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="buildluarockspackage-function"></a>15.15.3.1.2. <code class="literal">buildLuarocksPackage</code> function</h5></div></div></div><p>
        The <code class="literal">buildLuarocksPackage</code> function is implemented in <code class="literal">pkgs/development/interpreters/lua-5/build-lua-package.nix</code> The following is an example:
       </p><pre class="programlisting">
luaposix = buildLuarocksPackage {
  pname = "luaposix";
  version = "34.0.4-1";

  src = fetchurl {
    url    = "https://raw.githubusercontent.com/rocks-moonscript-org/moonrocks-mirror/master/luaposix-34.0.4-1.src.rock";
    sha256 = "0yrm5cn2iyd0zjd4liyj27srphvy0gjrjx572swar6zqr4dwjqp2";
  };
  disabled = (luaOlder "5.1") || (luaAtLeast "5.4");
  propagatedBuildInputs = [ bit32 lua std_normalize ];

  meta = with lib; {
    homepage = "https://github.com/luaposix/luaposix/";
    description = "Lua bindings for POSIX";
    maintainers = with maintainers; [ vyp lblasc ];
    license.fullName = "MIT/X11";
  };
};
</pre><p>
        The <code class="literal">buildLuarocksPackage</code> delegates most tasks to luarocks:
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          it adds <code class="literal">luarocks</code> as an unpacker for <code class="literal">src.rock</code> files (zip files really).
         </p></li><li class="listitem"><p>
          configurePhase<code class="literal">writes a temporary luarocks configuration file which location is exported via the environment variable</code>LUAROCKS_CONFIG`.
         </p></li><li class="listitem"><p>
          the <code class="literal">buildPhase</code> does nothing.
         </p></li><li class="listitem"><p>
          <code class="literal">installPhase</code> calls <code class="literal">luarocks make --deps-mode=none --tree $out</code> to build and install the package
         </p></li><li class="listitem"><p>
          In the <code class="literal">postFixup</code> phase, the <code class="literal">wrapLuaPrograms</code> bash function is called to wrap all programs in the <code class="literal">$out/bin/*</code> directory to include <code class="literal">$PATH</code> environment variable and add dependent libraries to script’s <code class="literal">LUA_PATH</code> and <code class="literal">LUA_CPATH</code>.
         </p></li></ul></div><p>
        By default <code class="literal">meta.platforms</code> is set to the same value as the interpreter unless overridden otherwise.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="buildluaapplication-function"></a>15.15.3.1.3. <code class="literal">buildLuaApplication</code> function</h5></div></div></div><p>
        The <code class="literal">buildLuaApplication</code> function is practically the same as <code class="literal">buildLuaPackage</code>. The difference is that <code class="literal">buildLuaPackage</code> by default prefixes the names of the packages with the version of the interpreter. Because with an application we’re not interested in multiple version the prefix is dropped.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="lua.withpackages-function"></a>15.15.3.1.4. lua.withPackages function</h5></div></div></div><p>
        The <code class="literal">lua.withPackages</code> takes a function as an argument that is passed the set of lua packages and returns the list of packages to be included in the environment. Using the <code class="literal">withPackages</code> function, the previous example for the luafilesystem environment can be written like this:
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

lua.withPackages (ps: [ps.luafilesystem])
</pre><p>
        <code class="literal">withPackages</code> passes the correct package set for the specific interpreter version as an argument to the function. In the above example, <code class="literal">ps</code> equals <code class="literal">luaPackages</code>. But you can also easily switch to using <code class="literal">lua5_2</code>:
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

lua5_2.withPackages (ps: [ps.lua])
</pre><p>
        Now, <code class="literal">ps</code> is set to <code class="literal">lua52Packages</code>, matching the version of the interpreter.
       </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="possible-todos"></a>15.15.3.2. Possible Todos</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         export/use version specific variables such as <code class="literal">LUA_PATH_5_2</code>/<code class="literal">LUAROCKS_CONFIG_5_2</code>
        </p></li><li class="listitem"><p>
         let luarocks check for dependencies via exporting the different rocktrees in temporary config
        </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="lua-contributing-guidelines"></a>15.15.3.3. Lua Contributing guidelines</h4></div></div></div><p>
       Following rules should be respected:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         Make sure libraries build for all Lua interpreters.
        </p></li><li class="listitem"><p>
         Commit names of Lua libraries should reflect that they are Lua libraries, so write for example <code class="literal">luaPackages.luafilesystem: 1.11 -&gt; 1.12</code>.
        </p></li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="maven"></a>15.16. Maven</h2></div></div></div><p>
     Maven is a well-known build tool for the Java ecosystem however it has some challenges when integrating into the Nix build system.
    </p><p>
     The following provides a list of common patterns with how to package a Maven project (or any JVM language that can export to Maven) as a Nix package.
    </p><p>
     For the purposes of this example let’s consider a very basic Maven project with the following <code class="literal">pom.xml</code> with a single dependency on <a class="link" href="https://github.com/vdurmont/emoji-java" target="_top">emoji-java</a>.
    </p><pre class="programlisting">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;io.github.fzakaria&lt;/groupId&gt;
  &lt;artifactId&gt;maven-demo&lt;/artifactId&gt;
  &lt;version&gt;1.0&lt;/version&gt;
  &lt;packaging&gt;jar&lt;/packaging&gt;
  &lt;name&gt;NixOS Maven Demo&lt;/name&gt;

  &lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.vdurmont&lt;/groupId&gt;
        &lt;artifactId&gt;emoji-java&lt;/artifactId&gt;
        &lt;version&gt;5.1.1&lt;/version&gt;
      &lt;/dependency&gt;
  &lt;/dependencies&gt;
&lt;/project&gt;
</pre><p>
     Our main class file will be very simple:
    </p><pre class="programlisting">
import com.vdurmont.emoji.EmojiParser;

public class Main {
  public static void main(String[] args) {
    String str = "NixOS :grinning: is super cool :smiley:!";
    String result = EmojiParser.parseToUnicode(str);
    System.out.println(result);
  }
}
</pre><p>
     You find this demo project at https://github.com/fzakaria/nixos-maven-example
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="solving-for-dependencies"></a>15.16.1. Solving for dependencies</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="buildmaven-with-nixosmvn2nix-maven-plugin"></a>15.16.1.1. buildMaven with NixOS/mvn2nix-maven-plugin</h4></div></div></div><div class="blockquote"><blockquote class="blockquote"><p>
        ⚠️ Although <code class="literal">buildMaven</code> is the <span class="quote">“<span class="quote">blessed</span>”</span> way within nixpkgs, as of 2020, it hasn’t seen much activity in quite a while.
       </p></blockquote></div><p>
       <code class="literal">buildMaven</code> is an alternative method that tries to follow similar patterns of other programming languages by generating a lock file. It relies on the maven plugin <a class="link" href="https://github.com/NixOS/mvn2nix-maven-plugin" target="_top">mvn2nix-maven-plugin</a>.
      </p><p>
       First you generate a <code class="literal">project-info.json</code> file using the maven plugin.
      </p><div class="blockquote"><blockquote class="blockquote"><p>
        This should be executed in the project’s source repository or be told which <code class="literal">pom.xml</code> to execute with.
       </p></blockquote></div><pre class="programlisting">
# run this step within the project's source repository
❯ mvn org.nixos.mvn2nix:mvn2nix-maven-plugin:mvn2nix

❯ cat project-info.json | jq | head
{
  "project": {
    "artifactId": "maven-demo",
    "groupId": "org.nixos",
    "version": "1.0",
    "classifier": "",
    "extension": "jar",
    "dependencies": [
      {
        "artifactId": "maven-resources-plugin",
</pre><p>
       This file is then given to the <code class="literal">buildMaven</code> function, and it returns 2 attributes.
      </p><p>
       <span class="strong"><strong><code class="literal">repo</code></strong></span>: A Maven repository that is a symlink farm of all the dependencies found in the <code class="literal">project-info.json</code>
      </p><p>
       <span class="strong"><strong><code class="literal">build</code></strong></span>: A simple derivation that runs through <code class="literal">mvn compile</code> &amp; <code class="literal">mvn package</code> to build the JAR. You may use this as inspiration for more complicated derivations.
      </p><p>
       Here is an <a class="link" href="https://github.com/fzakaria/nixos-maven-example/blob/main/build-maven-repository.nix" target="_top">example</a> of building the Maven repository
      </p><pre class="programlisting">
{ pkgs ? import &lt;nixpkgs&gt; { } }:
with pkgs;
(buildMaven ./project-info.json).repo
</pre><p>
       The benefit over the <span class="emphasis"><em>double invocation</em></span> as we will see below, is that the <span class="emphasis"><em>/nix/store</em></span> entry is a <span class="emphasis"><em>linkFarm</em></span> of every package, so that changes to your dependency set doesn’t involve downloading everything from scratch.
      </p><pre class="programlisting">
❯ tree $(nix-build --no-out-link build-maven-repository.nix) | head
/nix/store/g87va52nkc8jzbmi1aqdcf2f109r4dvn-maven-repository
├── antlr
│   └── antlr
│       └── 2.7.2
│           ├── antlr-2.7.2.jar -&gt; /nix/store/d027c8f2cnmj5yrynpbq2s6wmc9cb559-antlr-2.7.2.jar
│           └── antlr-2.7.2.pom -&gt; /nix/store/mv42fc5gizl8h5g5vpywz1nfiynmzgp2-antlr-2.7.2.pom
├── avalon-framework
│   └── avalon-framework
│       └── 4.1.3
│           ├── avalon-framework-4.1.3.jar -&gt; /nix/store/iv5fp3955w3nq28ff9xfz86wvxbiw6n9-avalon-framework-4.1.3.jar
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="double-invocation"></a>15.16.1.2. Double Invocation</h4></div></div></div><div class="blockquote"><blockquote class="blockquote"><p>
        ⚠️ This pattern is the simplest but may cause unnecessary rebuilds due to the output hash changing.
       </p></blockquote></div><p>
       The double invocation is a <span class="emphasis"><em>simple</em></span> way to get around the problem that <code class="literal">nix-build</code> may be sandboxed and have no Internet connectivity.
      </p><p>
       It treats the entire Maven repository as a single source to be downloaded, relying on Maven’s dependency resolution to satisfy the output hash. This is similar to fetchers like <code class="literal">fetchgit</code>, except it has to run a Maven build to determine what to download.
      </p><p>
       The first step will be to build the Maven project as a fixed-output derivation in order to collect the Maven repository – below is an <a class="link" href="https://github.com/fzakaria/nixos-maven-example/blob/main/double-invocation-repository.nix" target="_top">example</a>.
      </p><div class="blockquote"><blockquote class="blockquote"><p>
        Traditionally the Maven repository is at <code class="literal">~/.m2/repository</code>. We will override this to be the <code class="literal">$out</code> directory.
       </p></blockquote></div><pre class="programlisting">
{ lib, stdenv, maven }:
stdenv.mkDerivation {
  name = "maven-repository";
  buildInputs = [ maven ];
  src = ./.; # or fetchFromGitHub, cleanSourceWith, etc
  buildPhase = ''
    mvn package -Dmaven.repo.local=$out
  '';

  # keep only *.{pom,jar,sha1,nbm} and delete all ephemeral files with lastModified timestamps inside
  installPhase = ''
    find $out -type f \
      -name \*.lastUpdated -or \
      -name resolver-status.properties -or \
      -name _remote.repositories \
      -delete
  '';

  # don't do any fixup
  dontFixup = true;
  outputHashAlgo = "sha256";
  outputHashMode = "recursive";
  # replace this with the correct SHA256
  outputHash = lib.fakeSha256;
}
</pre><p>
       The build will fail, and tell you the expected <code class="literal">outputHash</code> to place. When you’ve set the hash, the build will return with a <code class="literal">/nix/store</code> entry whose contents are the full Maven repository.
      </p><div class="blockquote"><blockquote class="blockquote"><p>
        Some additional files are deleted that would cause the output hash to change potentially on subsequent runs.
       </p></blockquote></div><pre class="programlisting">
❯ tree $(nix-build --no-out-link double-invocation-repository.nix) | head
/nix/store/8kicxzp98j68xyi9gl6jda67hp3c54fq-maven-repository
├── backport-util-concurrent
│   └── backport-util-concurrent
│       └── 3.1
│           ├── backport-util-concurrent-3.1.pom
│           └── backport-util-concurrent-3.1.pom.sha1
├── classworlds
│   └── classworlds
│       ├── 1.1
│       │   ├── classworlds-1.1.jar
</pre><p>
       If your package uses <span class="emphasis"><em>SNAPSHOT</em></span> dependencies or <span class="emphasis"><em>version ranges</em></span>; there is a strong likelihood that over-time your output hash will change since the resolved dependencies may change. Hence this method is less recommended then using <code class="literal">buildMaven</code>.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="building-a-jar"></a>15.16.2. Building a JAR</h3></div></div></div><p>
      Regardless of which strategy is chosen above, the step to build the derivation is the same.
     </p><pre class="programlisting">
{ stdenv, maven, callPackage }:
# pick a repository derivation, here we will use buildMaven
let repository = callPackage ./build-maven-repository.nix { };
in stdenv.mkDerivation rec {
  pname = "maven-demo";
  version = "1.0";

  src = builtins.fetchTarball "https://github.com/fzakaria/nixos-maven-example/archive/main.tar.gz";
  buildInputs = [ maven ];

  buildPhase = ''
    echo "Using repository ${repository}"
    mvn --offline -Dmaven.repo.local=${repository} package;
  '';

  installPhase = ''
    install -Dm644 target/${pname}-${version}.jar $out/share/java
  '';
}
</pre><div class="blockquote"><blockquote class="blockquote"><p>
       We place the library in <code class="literal">$out/share/java</code> since JDK package has a <span class="emphasis"><em>stdenv setup hook</em></span> that adds any JARs in the <code class="literal">share/java</code> directories of the build inputs to the CLASSPATH environment.
      </p></blockquote></div><pre class="programlisting">
❯ tree $(nix-build --no-out-link build-jar.nix)
/nix/store/7jw3xdfagkc2vw8wrsdv68qpsnrxgvky-maven-demo-1.0
└── share
    └── java
        └── maven-demo-1.0.jar

2 directories, 1 file
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="runnable-jar"></a>15.16.3. Runnable JAR</h3></div></div></div><p>
      The previous example builds a <code class="literal">jar</code> file but that’s not a file one can run.
     </p><p>
      You need to use it with <code class="literal">java -jar $out/share/java/output.jar</code> and make sure to provide the required dependencies on the classpath.
     </p><p>
      The following explains how to use <code class="literal">makeWrapper</code> in order to make the derivation produce an executable that will run the JAR file you created.
     </p><p>
      We will use the same repository we built above (either <span class="emphasis"><em>double invocation</em></span> or <span class="emphasis"><em>buildMaven</em></span>) to setup a CLASSPATH for our JAR.
     </p><p>
      The following two methods are more suited to Nix then building an <a class="link" href="https://imagej.net/Uber-JAR" target="_top">UberJar</a> which may be the more traditional approach.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="classpath"></a>15.16.3.1. CLASSPATH</h4></div></div></div><div class="blockquote"><blockquote class="blockquote"><p>
        This is ideal if you are providing a derivation for <span class="emphasis"><em>nixpkgs</em></span> and don’t want to patch the project’s <code class="literal">pom.xml</code>.
       </p></blockquote></div><p>
       We will read the Maven repository and flatten it to a single list. This list will then be concatenated with the <span class="emphasis"><em>CLASSPATH</em></span> separator to create the full classpath.
      </p><p>
       We make sure to provide this classpath to the <code class="literal">makeWrapper</code>.
      </p><pre class="programlisting">
{ stdenv, maven, callPackage, makeWrapper, jre }:
let
  repository = callPackage ./build-maven-repository.nix { };
in stdenv.mkDerivation rec {
  pname = "maven-demo";
  version = "1.0";

  src = builtins.fetchTarball
    "https://github.com/fzakaria/nixos-maven-example/archive/main.tar.gz";
  buildInputs = [ maven makeWrapper ];

  buildPhase = ''
    echo "Using repository ${repository}"
    mvn --offline -Dmaven.repo.local=${repository} package;
  '';

  installPhase = ''
    mkdir -p $out/bin

    classpath=$(find ${repository} -name "*.jar" -printf ':%h/%f');
    install -Dm644 target/${pname}-${version}.jar $out/share/java
    # create a wrapper that will automatically set the classpath
    # this should be the paths from the dependency derivation
    makeWrapper ${jre}/bin/java $out/bin/${pname} \
          --add-flags "-classpath $out/share/java/${pname}-${version}.jar:''${classpath#:}" \
          --add-flags "Main"
  '';
}
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="manifest-file-via-maven-plugin"></a>15.16.3.2. MANIFEST file via Maven Plugin</h4></div></div></div><div class="blockquote"><blockquote class="blockquote"><p>
        This is ideal if you are the project owner and want to change your <code class="literal">pom.xml</code> to set the CLASSPATH within it.
       </p></blockquote></div><p>
       Augment the <code class="literal">pom.xml</code> to create a JAR with the following manifest:
      </p><pre class="programlisting">
&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
        &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
        &lt;configuration&gt;
            &lt;archive&gt;
                &lt;manifest&gt;
                    &lt;addClasspath&gt;true&lt;/addClasspath&gt;
                    &lt;classpathPrefix&gt;../../repository/&lt;/classpathPrefix&gt;
                    &lt;classpathLayoutType&gt;repository&lt;/classpathLayoutType&gt;
                    &lt;mainClass&gt;Main&lt;/mainClass&gt;
                &lt;/manifest&gt;
                &lt;manifestEntries&gt;
                    &lt;Class-Path&gt;.&lt;/Class-Path&gt;
                &lt;/manifestEntries&gt;
            &lt;/archive&gt;
        &lt;/configuration&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;
</pre><p>
       The above plugin instructs the JAR to look for the necessary dependencies in the <code class="literal">lib/</code> relative folder. The layout of the folder is also in the <span class="emphasis"><em>maven repository</em></span> style.
      </p><pre class="programlisting">
❯ unzip -q -c $(nix-build --no-out-link runnable-jar.nix)/share/java/maven-demo-1.0.jar META-INF/MANIFEST.MF

Manifest-Version: 1.0
Archiver-Version: Plexus Archiver
Built-By: nixbld
Class-Path: . ../../repository/com/vdurmont/emoji-java/5.1.1/emoji-jav
 a-5.1.1.jar ../../repository/org/json/json/20170516/json-20170516.jar
Created-By: Apache Maven 3.6.3
Build-Jdk: 1.8.0_265
Main-Class: Main
</pre><p>
       We will modify the derivation above to add a symlink to our repository so that it’s accessible to our JAR during the <code class="literal">installPhase</code>.
      </p><pre class="programlisting">
{ stdenv, maven, callPackage, makeWrapper, jre }:
# pick a repository derivation, here we will use buildMaven
let repository = callPackage ./build-maven-repository.nix { };
in stdenv.mkDerivation rec {
  pname = "maven-demo";
  version = "1.0";

  src = builtins.fetchTarball
    "https://github.com/fzakaria/nixos-maven-example/archive/main.tar.gz";
  buildInputs = [ maven makeWrapper ];

  buildPhase = ''
    echo "Using repository ${repository}"
    mvn --offline -Dmaven.repo.local=${repository} package;
  '';

  installPhase = ''
    mkdir -p $out/bin

    # create a symbolic link for the repository directory
    ln -s ${repository} $out/repository

    install -Dm644 target/${pname}-${version}.jar $out/share/java
    # create a wrapper that will automatically set the classpath
    # this should be the paths from the dependency derivation
    makeWrapper ${jre}/bin/java $out/bin/${pname} \
          --add-flags "-jar $out/share/java/${pname}-${version}.jar"
  '';
}
</pre><div class="blockquote"><blockquote class="blockquote"><p>
        Our script produces a dependency on <code class="literal">jre</code> rather than <code class="literal">jdk</code> to restrict the runtime closure necessary to run the application.
       </p></blockquote></div><p>
       This will give you an executable shell-script that launches your JAR with all the dependencies available.
      </p><pre class="programlisting">
❯ tree $(nix-build --no-out-link runnable-jar.nix)
/nix/store/8d4c3ibw8ynsn01ibhyqmc1zhzz75s26-maven-demo-1.0
├── bin
│   └── maven-demo
├── repository -&gt; /nix/store/g87va52nkc8jzbmi1aqdcf2f109r4dvn-maven-repository
└── share
    └── java
        └── maven-demo-1.0.jar

❯ $(nix-build --no-out-link --option tarball-ttl 1 runnable-jar.nix)/bin/maven-demo
NixOS 😀 is super cool 😃!
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="node.js"></a>15.17. Node.js</h2></div></div></div><p>
     The <code class="literal">pkgs/development/node-packages</code> folder contains a generated collection of <a class="link" href="https://npmjs.com/" target="_top">NPM packages</a> that can be installed with the Nix package manager.
    </p><p>
     As a rule of thumb, the package set should only provide <span class="emphasis"><em>end user</em></span> software packages, such as command-line utilities. Libraries should only be added to the package set if there is a non-NPM package that requires it.
    </p><p>
     When it is desired to use NPM libraries in a development project, use the <code class="literal">node2nix</code> generator directly on the <code class="literal">package.json</code> configuration file of the project.
    </p><p>
     The package set provides support for the official stable Node.js versions. The latest stable LTS release in <code class="literal">nodePackages</code>, as well as the latest stable Current release in <code class="literal">nodePackages_latest</code>.
    </p><p>
     If your package uses native addons, you need to examine what kind of native build system it uses. Here are some examples:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       <code class="literal">node-gyp</code>
      </p></li><li class="listitem"><p>
       <code class="literal">node-gyp-builder</code>
      </p></li><li class="listitem"><p>
       <code class="literal">node-pre-gyp</code>
      </p></li></ul></div><p>
     After you have identified the correct system, you need to override your package expression while adding in build system as a build input. For example, <code class="literal">dat</code> requires <code class="literal">node-gyp-build</code>, so <a class="link" href="https://github.com/NixOS/nixpkgs/blob/32f5e5da4a1b3f0595527f5195ac3a91451e9b56/pkgs/development/node-packages/default.nix#L37-L40" target="_top">we override</a> its expression in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/node-packages/default.nix" target="_top"><code class="literal">default.nix</code></a>:
    </p><pre class="programlisting">
    dat = super.dat.override {
      buildInputs = [ self.node-gyp-build pkgs.libtool pkgs.autoconf pkgs.automake ];
      meta.broken = since "12";
    };
</pre><p>
     To add a package from NPM to nixpkgs:
    </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
       Modify <code class="literal">pkgs/development/node-packages/node-packages.json</code> to add, update or remove package entries to have it included in <code class="literal">nodePackages</code> and <code class="literal">nodePackages_latest</code>.
      </p></li><li class="listitem"><p>
       Run the script: <code class="literal">(cd pkgs/development/node-packages &amp;&amp; ./generate.sh)</code>.
      </p></li><li class="listitem"><p>
       Build your new package to test your changes: <code class="literal">cd /path/to/nixpkgs &amp;&amp; nix-build -A nodePackages.&lt;new-or-updated-package&gt;</code>. To build against the latest stable Current Node.js version (e.g. 14.x): <code class="literal">nix-build -A nodePackages_latest.&lt;new-or-updated-package&gt;</code>
      </p></li><li class="listitem"><p>
       Add and commit all modified and generated files.
      </p></li></ol></div><p>
     For more information about the generation process, consult the <a class="link" href="https://github.com/svanderburg/node2nix" target="_top">README.md</a> file of the <code class="literal">node2nix</code> tool.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-language-ocaml"></a>15.18. OCaml</h2></div></div></div><p>
     OCaml libraries should be installed in <code class="literal">$(out)/lib/ocaml/${ocaml.version}/site-lib/</code>. Such directories are automatically added to the <code class="literal">$OCAMLPATH</code> environment variable when building another package that depends on them or when opening a <code class="literal">nix-shell</code>.
    </p><p>
     Given that most of the OCaml ecosystem is now built with dune, nixpkgs includes a convenience build support function called <code class="literal">buildDunePackage</code> that will build an OCaml package using dune, OCaml and findlib and any additional dependencies provided as <code class="literal">buildInputs</code> or <code class="literal">propagatedBuildInputs</code>.
    </p><p>
     Here is a simple package example. It defines an (optional) attribute <code class="literal">minimumOCamlVersion</code> that will be used to throw a descriptive evaluation error if building with an older OCaml is attempted. It uses the <code class="literal">fetchFromGitHub</code> fetcher to get its source. It sets the <code class="literal">doCheck</code> (optional) attribute to <code class="literal">true</code> which means that tests will be run with <code class="literal">dune runtest -p angstrom</code> after the build (<code class="literal">dune build -p angstrom</code>) is complete. It uses <code class="literal">alcotest</code> as a build input (because it is needed to run the tests) and <code class="literal">bigstringaf</code> and <code class="literal">result</code> as propagated build inputs (thus they will also be available to libraries depending on this library). The library will be installed using the <code class="literal">angstrom.install</code> file that dune generates.
    </p><pre class="programlisting">
{ lib
, fetchFromGitHub
, buildDunePackage
, alcotest
, result
, bigstringaf
}:

buildDunePackage rec {
  pname = "angstrom";
  version = "0.10.0";

  minimumOCamlVersion = "4.03";

  src = fetchFromGitHub {
    owner  = "inhabitedtype";
    repo   = pname;
    rev    = version;
    sha256 = "0lh6024yf9ds0nh9i93r9m6p5psi8nvrqxl5x7jwl13zb0r9xfpw";
  };

  buildInputs = [ alcotest ];
  propagatedBuildInputs = [ bigstringaf result ];
  doCheck = true;

  meta = with lib; {
    homepage = "https://github.com/inhabitedtype/angstrom";
    description = "OCaml parser combinators built for speed and memory efficiency";
    license = licenses.bsd3;
    maintainers = with maintainers; [ sternenseemann ];
  };
}
</pre><p>
     Here is a second example, this time using a source archive generated with <code class="literal">dune-release</code>. It is a good idea to use this archive when it is available as it will usually contain substituted variables such as a <code class="literal">%%VERSION%%</code> field. This library does not depend on any other OCaml library and no tests are run after building it.
    </p><pre class="programlisting">
{ lib
, fetchurl
, buildDunePackage
}:

buildDunePackage rec {
  pname = "wtf8";
  version = "1.0.1";

  minimumOCamlVersion = "4.01";

  src = fetchurl {
    url = "https://github.com/flowtype/ocaml-${pname}/releases/download/v${version}/${pname}-${version}.tbz";
    sha256 = "1msg3vycd3k8qqj61sc23qks541cxpb97vrnrvrhjnqxsqnh6ygq";
  };

  meta = with lib; {
    homepage = "https://github.com/flowtype/ocaml-wtf8";
    description = "WTF-8 is a superset of UTF-8 that allows unpaired surrogates.";
    license = licenses.mit;
    maintainers = [ maintainers.eqyiel ];
  };
}
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-language-perl"></a>15.19. Perl</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-perl-running"></a>15.19.1. Running perl programs on the shell</h3></div></div></div><p>
      When executing a Perl script, it is possible you get an error such as <code class="literal">./myscript.pl: bad interpreter: /usr/bin/perl: no such file or directory</code>. This happens when the script expects Perl to be installed at <code class="literal">/usr/bin/perl</code>, which is not the case when using Perl from nixpkgs. You can fix the script by changing the first line to:
     </p><pre class="programlisting">
#!/usr/bin/env perl
</pre><p>
      to take the Perl installation from the <code class="literal">PATH</code> environment variable, or invoke Perl directly with:
     </p><pre class="programlisting">
$ perl ./myscript.pl
</pre><p>
      When the script is using a Perl library that is not installed globally, you might get an error such as <code class="literal">Can't locate DB_File.pm in @INC (you may need to install the DB_File module)</code>. In that case, you can use <code class="literal">nix-shell</code> to start an ad-hoc shell with that library installed, for instance:
     </p><pre class="programlisting">
$ nix-shell -p perl perlPackages.DBFile --run ./myscript.pl
</pre><p>
      If you are always using the script in places where <code class="literal">nix-shell</code> is available, you can embed the <code class="literal">nix-shell</code> invocation in the shebang like this:
     </p><pre class="programlisting">
#!/usr/bin/env nix-shell
#! nix-shell -i perl -p perl perlPackages.DBFile
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-perl-packaging"></a>15.19.2. Packaging Perl programs</h3></div></div></div><p>
      Nixpkgs provides a function <code class="literal">buildPerlPackage</code>, a generic package builder function for any Perl package that has a standard <code class="literal">Makefile.PL</code>. It’s implemented in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/perl-modules/generic" target="_top">pkgs/development/perl-modules/generic</a>.
     </p><p>
      Perl packages from CPAN are defined in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/perl-packages.nix" target="_top">pkgs/top-level/perl-packages.nix</a> rather than <code class="literal">pkgs/all-packages.nix</code>. Most Perl packages are so straight-forward to build that they are defined here directly, rather than having a separate function for each package called from <code class="literal">perl-packages.nix</code>. However, more complicated packages should be put in a separate file, typically in <code class="literal">pkgs/development/perl-modules</code>. Here is an example of the former:
     </p><pre class="programlisting">
ClassC3 = buildPerlPackage rec {
  name = "Class-C3-0.21";
  src = fetchurl {
    url = "mirror://cpan/authors/id/F/FL/FLORA/${name}.tar.gz";
    sha256 = "1bl8z095y4js66pwxnm7s853pi9czala4sqc743fdlnk27kq94gz";
  };
};
</pre><p>
      Note the use of <code class="literal">mirror://cpan/</code>, and the <code class="literal">${name}</code> in the URL definition to ensure that the name attribute is consistent with the source that we’re actually downloading. Perl packages are made available in <code class="literal">all-packages.nix</code> through the variable <code class="literal">perlPackages</code>. For instance, if you have a package that needs <code class="literal">ClassC3</code>, you would typically write
     </p><pre class="programlisting">
foo = import ../path/to/foo.nix {
  inherit stdenv fetchurl ...;
  inherit (perlPackages) ClassC3;
};
</pre><p>
      in <code class="literal">all-packages.nix</code>. You can test building a Perl package as follows:
     </p><pre class="programlisting">
$ nix-build -A perlPackages.ClassC3
</pre><p>
      <code class="literal">buildPerlPackage</code> adds <code class="literal">perl-</code> to the start of the name attribute, so the package above is actually called <code class="literal">perl-Class-C3-0.21</code>. So to install it, you can say:
     </p><pre class="programlisting">
$ nix-env -i perl-Class-C3
</pre><p>
      (Of course you can also install using the attribute name: <code class="literal">nix-env -i -A perlPackages.ClassC3</code>.)
     </p><p>
      So what does <code class="literal">buildPerlPackage</code> do? It does the following:
     </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
        In the configure phase, it calls <code class="literal">perl Makefile.PL</code> to generate a Makefile. You can set the variable <code class="literal">makeMakerFlags</code> to pass flags to <code class="literal">Makefile.PL</code>
       </p></li><li class="listitem"><p>
        It adds the contents of the <code class="literal">PERL5LIB</code> environment variable to <code class="literal">#! .../bin/perl</code> line of Perl scripts as <code class="literal">-Idir</code> flags. This ensures that a script can find its dependencies. (This can cause this shebang line to become too long for Darwin to handle; see the note below.)
       </p></li><li class="listitem"><p>
        In the fixup phase, it writes the propagated build inputs (<code class="literal">propagatedBuildInputs</code>) to the file <code class="literal">$out/nix-support/propagated-user-env-packages</code>. <code class="literal">nix-env</code> recursively installs all packages listed in this file when you install a package that has it. This ensures that a Perl package can find its dependencies.
       </p></li></ol></div><p>
      <code class="literal">buildPerlPackage</code> is built on top of <code class="literal">stdenv</code>, so everything can be customised in the usual way. For instance, the <code class="literal">BerkeleyDB</code> module has a <code class="literal">preConfigure</code> hook to generate a configuration file used by <code class="literal">Makefile.PL</code>:
     </p><pre class="programlisting">
{ buildPerlPackage, fetchurl, db }:

buildPerlPackage rec {
  name = "BerkeleyDB-0.36";

  src = fetchurl {
    url = "mirror://cpan/authors/id/P/PM/PMQS/${name}.tar.gz";
    sha256 = "07xf50riarb60l1h6m2dqmql8q5dij619712fsgw7ach04d8g3z1";
  };

  preConfigure = ''
    echo "LIB = ${db.out}/lib" &gt; config.in
    echo "INCLUDE = ${db.dev}/include" &gt;&gt; config.in
  '';
}
</pre><p>
      Dependencies on other Perl packages can be specified in the <code class="literal">buildInputs</code> and <code class="literal">propagatedBuildInputs</code> attributes. If something is exclusively a build-time dependency, use <code class="literal">buildInputs</code>; if it’s (also) a runtime dependency, use <code class="literal">propagatedBuildInputs</code>. For instance, this builds a Perl module that has runtime dependencies on a bunch of other modules:
     </p><pre class="programlisting">
ClassC3Componentised = buildPerlPackage rec {
  name = "Class-C3-Componentised-1.0004";
  src = fetchurl {
    url = "mirror://cpan/authors/id/A/AS/ASH/${name}.tar.gz";
    sha256 = "0xql73jkcdbq4q9m0b0rnca6nrlvf5hyzy8is0crdk65bynvs8q1";
  };
  propagatedBuildInputs = [
    ClassC3 ClassInspector TestException MROCompat
  ];
};
</pre><p>
      On Darwin, if a script has too many <code class="literal">-Idir</code> flags in its first line (its <span class="quote">“<span class="quote">shebang line</span>”</span>), it will not run. This can be worked around by calling the <code class="literal">shortenPerlShebang</code> function from the <code class="literal">postInstall</code> phase:
     </p><pre class="programlisting">
{ lib, stdenv, buildPerlPackage, fetchurl, shortenPerlShebang }:

ImageExifTool = buildPerlPackage {
  pname = "Image-ExifTool";
  version = "11.50";

  src = fetchurl {
    url = "https://www.sno.phy.queensu.ca/~phil/exiftool/Image-ExifTool-11.50.tar.gz";
    sha256 = "0d8v48y94z8maxkmw1rv7v9m0jg2dc8xbp581njb6yhr7abwqdv3";
  };

  buildInputs = lib.optional stdenv.isDarwin shortenPerlShebang;
  postInstall = lib.optional stdenv.isDarwin ''
    shortenPerlShebang $out/bin/exiftool
  '';
};
</pre><p>
      This will remove the <code class="literal">-I</code> flags from the shebang line, rewrite them in the <code class="literal">use lib</code> form, and put them on the next line instead. This function can be given any number of Perl scripts as arguments; it will modify them in-place.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-generation-from-CPAN"></a>15.19.2.1. Generation from CPAN</h4></div></div></div><p>
       Nix expressions for Perl packages can be generated (almost) automatically from CPAN. This is done by the program <code class="literal">nix-generate-from-cpan</code>, which can be installed as follows:
      </p><pre class="programlisting">
$ nix-env -i nix-generate-from-cpan
</pre><p>
       This program takes a Perl module name, looks it up on CPAN, fetches and unpacks the corresponding package, and prints a Nix expression on standard output. For example:
      </p><pre class="programlisting">
$ nix-generate-from-cpan XML::Simple
  XMLSimple = buildPerlPackage rec {
    name = "XML-Simple-2.22";
    src = fetchurl {
      url = "mirror://cpan/authors/id/G/GR/GRANTM/${name}.tar.gz";
      sha256 = "b9450ef22ea9644ae5d6ada086dc4300fa105be050a2030ebd4efd28c198eb49";
    };
    propagatedBuildInputs = [ XMLNamespaceSupport XMLSAX XMLSAXExpat ];
    meta = {
      description = "An API for simple XML files";
      license = with lib.licenses; [ artistic1 gpl1Plus ];
    };
  };
</pre><p>
       The output can be pasted into <code class="literal">pkgs/top-level/perl-packages.nix</code> or wherever else you need it.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-perl-cross-compilation"></a>15.19.2.2. Cross-compiling modules</h4></div></div></div><p>
       Nixpkgs has experimental support for cross-compiling Perl modules. In many cases, it will just work out of the box, even for modules with native extensions. Sometimes, however, the Makefile.PL for a module may (indirectly) import a native module. In that case, you will need to make a stub for that module that will satisfy the Makefile.PL and install it into <code class="literal">lib/perl5/site_perl/cross_perl/${perl.version}</code>. See the <code class="literal">postInstall</code> for <code class="literal">DBI</code> for an example.
      </p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-php"></a>15.20. PHP</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-php-user-guide"></a>15.20.1. User Guide</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-php-user-guide-overview"></a>15.20.1.1. Overview</h4></div></div></div><p>
       Several versions of PHP are available on Nix, each of which having a wide variety of extensions and libraries available.
      </p><p>
       The different versions of PHP that nixpkgs provides are located under attributes named based on major and minor version number; e.g., <code class="literal">php74</code> is PHP 7.4.
      </p><p>
       Only versions of PHP that are supported by upstream for the entirety of a given NixOS release will be included in that release of NixOS. See <a class="link" href="https://www.php.net/supported-versions.php" target="_top">PHP Supported Versions</a>.
      </p><p>
       The attribute <code class="literal">php</code> refers to the version of PHP considered most stable and thoroughly tested in nixpkgs for any given release of NixOS - not necessarily the latest major release from upstream.
      </p><p>
       All available PHP attributes are wrappers around their respective binary PHP package and provide commonly used extensions this way. The real PHP 7.4 package, i.e. the unwrapped one, is available as <code class="literal">php74.unwrapped</code>; see the next section for more details.
      </p><p>
       Interactive tools built on PHP are put in <code class="literal">php.packages</code>; composer is for example available at <code class="literal">php.packages.composer</code>.
      </p><p>
       Most extensions that come with PHP, as well as some popular third-party ones, are available in <code class="literal">php.extensions</code>; for example, the opcache extension shipped with PHP is available at <code class="literal">php.extensions.opcache</code> and the third-party ImageMagick extension at <code class="literal">php.extensions.imagick</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-php-user-guide-installing-with-extensions"></a>15.20.1.2. Installing PHP with extensions</h4></div></div></div><p>
       A PHP package with specific extensions enabled can be built using <code class="literal">php.withExtensions</code>. This is a function which accepts an anonymous function as its only argument; the function should accept two named parameters: <code class="literal">enabled</code> - a list of currently enabled extensions and <code class="literal">all</code> - the set of all extensions, and return a list of wanted extensions. For example, a PHP package with all default extensions and ImageMagick enabled:
      </p><pre class="programlisting">
php.withExtensions ({ enabled, all }:
  enabled ++ [ all.imagick ])
</pre><p>
       To exclude some, but not all, of the default extensions, you can filter the <code class="literal">enabled</code> list like this:
      </p><pre class="programlisting">
php.withExtensions ({ enabled, all }:
  (lib.filter (e: e != php.extensions.opcache) enabled)
  ++ [ all.imagick ])
</pre><p>
       To build your list of extensions from the ground up, you can simply ignore <code class="literal">enabled</code>:
      </p><pre class="programlisting">
php.withExtensions ({ all, ... }: with all; [ imagick opcache ])
</pre><p>
       <code class="literal">php.withExtensions</code> provides extensions by wrapping a minimal php base package, providing a <code class="literal">php.ini</code> file listing all extensions to be loaded. You can access this package through the <code class="literal">php.unwrapped</code> attribute; useful if you, for example, need access to the <code class="literal">dev</code> output. The generated <code class="literal">php.ini</code> file can be accessed through the <code class="literal">php.phpIni</code> attribute.
      </p><p>
       If you want a PHP build with extra configuration in the <code class="literal">php.ini</code> file, you can use <code class="literal">php.buildEnv</code>. This function takes two named and optional parameters: <code class="literal">extensions</code> and <code class="literal">extraConfig</code>. <code class="literal">extensions</code> takes an extension specification equivalent to that of <code class="literal">php.withExtensions</code>, <code class="literal">extraConfig</code> a string of additional <code class="literal">php.ini</code> configuration parameters. For example, a PHP package with the opcache and ImageMagick extensions enabled, and <code class="literal">memory_limit</code> set to <code class="literal">256M</code>:
      </p><pre class="programlisting">
php.buildEnv {
  extensions = { all, ... }: with all; [ imagick opcache ];
  extraConfig = "memory_limit=256M";
}
</pre><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="ssec-php-user-guide-installing-with-extensions-phpfpm"></a>15.20.1.2.1. Example setup for <code class="literal">phpfpm</code></h5></div></div></div><p>
        You can use the previous examples in a <code class="literal">phpfpm</code> pool called <code class="literal">foo</code> as follows:
       </p><pre class="programlisting">
let
  myPhp = php.withExtensions ({ all, ... }: with all; [ imagick opcache ]);
in {
  services.phpfpm.pools."foo".phpPackage = myPhp;
};
</pre><pre class="programlisting">
let
  myPhp = php.buildEnv {
    extensions = { all, ... }: with all; [ imagick opcache ];
    extraConfig = "memory_limit=256M";
  };
in {
  services.phpfpm.pools."foo".phpPackage = myPhp;
};
</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="ssec-php-user-guide-installing-with-extensions-nix-shell"></a>15.20.1.2.2. Example usage with <code class="literal">nix-shell</code></h5></div></div></div><p>
        This brings up a temporary environment that contains a PHP interpreter with the extensions <code class="literal">imagick</code> and <code class="literal">opcache</code> enabled:
       </p><pre class="programlisting">
nix-shell -p 'php.withExtensions ({ all, ... }: with all; [ imagick opcache ])'
</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-php-user-guide-installing-packages-with-extensions"></a>15.20.1.3. Installing PHP packages with extensions</h4></div></div></div><p>
       All interactive tools use the PHP package you get them from, so all packages at <code class="literal">php.packages.*</code> use the <code class="literal">php</code> package with its default extensions. Sometimes this default set of extensions isn’t enough and you may want to extend it. A common case of this is the <code class="literal">composer</code> package: a project may depend on certain extensions and <code class="literal">composer</code> won’t work with that project unless those extensions are loaded.
      </p><p>
       Example of building <code class="literal">composer</code> with additional extensions:
      </p><pre class="programlisting">
(php.withExtensions ({ all, enabled }:
  enabled ++ (with all; [ imagick redis ]))
).packages.composer
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ssec-php-user-guide-overriding-packages"></a>15.20.1.4. Overriding PHP packages</h4></div></div></div><p>
       <code class="literal">php-packages.nix</code> form a scope, allowing us to override the packages defined within. For example, to apply a patch to a <code class="literal">mysqlnd</code> extension, you can simply pass an overlay-style function to <code class="literal">php</code>’s <code class="literal">packageOverrides</code> argument:
      </p><pre class="programlisting">
php.override {
  packageOverrides = final: prev: {
    extensions = prev.extensions // {
      mysqlnd = prev.extensions.mysqlnd.overrideAttrs (attrs: {
        patches = attrs.patches or [] ++ [
          …
        ];
      });
    };
  };
}
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="python"></a>15.21. Python</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="user-guide"></a>15.21.1. User Guide</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="using-python"></a>15.21.1.1. Using Python</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="overview"></a>15.21.1.1.1. Overview</h5></div></div></div><p>
        Several versions of the Python interpreter are available on Nix, as well as a high amount of packages. The attribute <code class="literal">python3</code> refers to the default interpreter, which is currently CPython 3.8. The attribute <code class="literal">python</code> refers to CPython 2.7 for backwards-compatibility. It is also possible to refer to specific versions, e.g. <code class="literal">python38</code> refers to CPython 3.8, and <code class="literal">pypy</code> refers to the default PyPy interpreter.
       </p><p>
        Python is used a lot, and in different ways. This affects also how it is packaged. In the case of Python on Nix, an important distinction is made between whether the package is considered primarily an application, or whether it should be used as a library, i.e., of primary interest are the modules in <code class="literal">site-packages</code> that should be importable.
       </p><p>
        In the Nixpkgs tree Python applications can be found throughout, depending on what they do, and are called from the main package set. Python libraries, however, are in separate sets, with one set per interpreter version.
       </p><p>
        The interpreters have several common attributes. One of these attributes is <code class="literal">pkgs</code>, which is a package set of Python libraries for this specific interpreter. E.g., the <code class="literal">toolz</code> package corresponding to the default interpreter is <code class="literal">python.pkgs.toolz</code>, and the CPython 3.8 version is <code class="literal">python38.pkgs.toolz</code>. The main package set contains aliases to these package sets, e.g. <code class="literal">pythonPackages</code> refers to <code class="literal">python.pkgs</code> and <code class="literal">python38Packages</code> to <code class="literal">python38.pkgs</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="installing-python-and-packages"></a>15.21.1.1.2. Installing Python and packages</h5></div></div></div><p>
        The Nix and NixOS manuals explain how packages are generally installed. In the case of Python and Nix, it is important to make a distinction between whether the package is considered an application or a library.
       </p><p>
        Applications on Nix are typically installed into your user profile imperatively using <code class="literal">nix-env -i</code>, and on NixOS declaratively by adding the package name to <code class="literal">environment.systemPackages</code> in <code class="literal">/etc/nixos/configuration.nix</code>. Dependencies such as libraries are automatically installed and should not be installed explicitly.
       </p><p>
        The same goes for Python applications. Python applications can be installed in your profile, and will be wrapped to find their exact library dependencies, without impacting other applications or polluting your user environment.
       </p><p>
        But Python libraries you would like to use for development cannot be installed, at least not individually, because they won’t be able to find each other resulting in import errors. Instead, it is possible to create an environment with <code class="literal">python.buildEnv</code> or <code class="literal">python.withPackages</code> where the interpreter and other executables are wrapped to be able to find each other and all of the modules.
       </p><p>
        In the following examples we will start by creating a simple, ad-hoc environment with a nix-shell that has <code class="literal">numpy</code> and <code class="literal">toolz</code> in Python 3.8; then we will create a re-usable environment in a single-file Python script; then we will create a full Python environment for development with this same environment.
       </p><p>
        Philosphically, this should be familiar to users who are used to a <code class="literal">venv</code> style of development: individual projects create their own Python environments without impacting the global environment or each other.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="ad-hoc-temporary-python-environment-with-nix-shell"></a>15.21.1.1.3. Ad-hoc temporary Python environment with <code class="literal">nix-shell</code></h5></div></div></div><p>
        The simplest way to start playing with the way nix wraps and sets up Python environments is with <code class="literal">nix-shell</code> at the cmdline. These environments create a temporary shell session with a Python and a <span class="emphasis"><em>precise</em></span> list of packages (plus their runtime dependencies), with no other Python packages in the Python interpreter’s scope.
       </p><p>
        To create a Python 3.8 session with <code class="literal">numpy</code> and <code class="literal">toolz</code> available, run:
       </p><pre class="programlisting">
$ nix-shell -p 'python38.withPackages(ps: with ps; [ numpy toolz ])'
</pre><p>
        By default <code class="literal">nix-shell</code> will start a <code class="literal">bash</code> session with this interpreter in our <code class="literal">PATH</code>, so if we then run:
       </p><p>
        <code class="literal">Python console [nix-shell:~/src/nixpkgs]$ python3 Python 3.8.1 (default, Dec 18 2019, 19:06:26) [GCC 9.2.0] on linux Type "help", "copyright", "credits" or "license" for more information. &gt;&gt;&gt; import numpy; import toolz</code>
       </p><p>
        Note that no other modules are in scope, even if they were imperatively installed into our user environment as a dependency of a Python application:
       </p><p>
        <code class="literal">Python console &gt;&gt;&gt; import requests Traceback (most recent call last): File "&lt;stdin&gt;", line 1, in &lt;module&gt; ModuleNotFoundError: No module named 'requests'</code>
       </p><p>
        We can add as many additional modules onto the <code class="literal">nix-shell</code> as we need, and we will still get 1 wrapped Python interpreter. We can start the interpreter directly like so:
       </p><pre class="programlisting">
$ nix-shell -p 'python38.withPackages(ps: with ps; [ numpy toolz requests ])' --run python3
these derivations will be built:
  /nix/store/xbdsrqrsfa1yva5s7pzsra8k08gxlbz1-python3-3.8.1-env.drv
building '/nix/store/xbdsrqrsfa1yva5s7pzsra8k08gxlbz1-python3-3.8.1-env.drv'...
created 277 symlinks in user environment
Python 3.8.1 (default, Dec 18 2019, 19:06:26)
[GCC 9.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; import requests
&gt;&gt;&gt;
</pre><p>
        Notice that this time it built a new Python environment, which now includes <code class="literal">requests</code>. Building an environment just creates wrapper scripts that expose the selected dependencies to the interpreter while re-using the actual modules. This means if any other env has installed <code class="literal">requests</code> or <code class="literal">numpy</code> in a different context, we don’t need to recompile them – we just recompile the wrapper script that sets up an interpreter pointing to them. This matters much more for <span class="quote">“<span class="quote">big</span>”</span> modules like <code class="literal">pytorch</code> or <code class="literal">tensorflow</code>.
       </p><p>
        Module names usually match their names on <a class="link" href="https://pypi.org/" target="_top">pypi.org</a>, but you can use the <a class="link" href="https://nixos.org/nixos/packages.html" target="_top">Nixpkgs search website</a> to find them as well (along with non-python packages).
       </p><p>
        At this point we can create throwaway experimental Python environments with arbitrary dependencies. This is a good way to get a feel for how the Python interpreter and dependencies work in Nix and NixOS, but to do some actual development, we’ll want to make it a bit more persistent.
       </p><div class="section"><div class="titlepage"><div><div><h6 class="title"><a id="running-python-scripts-and-using-nix-shell-as-shebang"></a>15.21.1.1.3.1. Running Python scripts and using <code class="literal">nix-shell</code> as shebang</h6></div></div></div><p>
         Sometimes, we have a script whose header looks like this:
        </p><pre class="programlisting">
#!/usr/bin/env python3
import numpy as np
a = np.array([1,2])
b = np.array([3,4])
print(f"The dot product of {a} and {b} is: {np.dot(a, b)}")
</pre><p>
         Executing this script requires a <code class="literal">python3</code> that has <code class="literal">numpy</code>. Using what we learned in the previous section, we could startup a shell and just run it like so:
        </p><pre class="programlisting">
$ nix-shell -p 'python38.withPackages(ps: with ps; [ numpy ])' --run 'python3 foo.py'
The dot product of [1 2] and [3 4] is: 11
</pre><p>
         But if we maintain the script ourselves, and if there are more dependencies, it may be nice to encode those dependencies in source to make the script re-usable without that bit of knowledge. That can be done by using <code class="literal">nix-shell</code> as a <a class="link" href="https://en.wikipedia.org/wiki/Shebang_(Unix)" target="_top">shebang</a>, like so:
        </p><pre class="programlisting">
#!/usr/bin/env nix-shell
#!nix-shell -i python3 -p "python3.withPackages(ps: [ ps.numpy ])"
import numpy as np
a = np.array([1,2])
b = np.array([3,4])
print(f"The dot product of {a} and {b} is: {np.dot(a, b)}")
</pre><p>
         Then we simply execute it, without requiring any environment setup at all!
        </p><pre class="programlisting">
$ ./foo.py
The dot product of [1 2] and [3 4] is: 11
</pre><p>
         If the dependencies are not available on the host where <code class="literal">foo.py</code> is executed, it will build or download them from a Nix binary cache prior to starting up, prior that it is executed on a machine with a multi-user nix installation.
        </p><p>
         This provides a way to ship a self bootstrapping Python script, akin to a statically linked binary, where it can be run on any machine (provided nix is installed) without having to assume that <code class="literal">numpy</code> is installed globally on the system.
        </p><p>
         By default it is pulling the import checkout of Nixpkgs itself from our nix channel, which is nice as it cache aligns with our other package builds, but we can make it fully reproducible by pinning the <code class="literal">nixpkgs</code> import:
        </p><pre class="programlisting">
#!/usr/bin/env nix-shell
#!nix-shell -i python3 -p "python3.withPackages(ps: [ ps.numpy ])"
#!nix-shell -I nixpkgs=https://github.com/NixOS/nixpkgs/archive/d373d80b1207d52621961b16aa4a3438e4f98167.tar.gz
import numpy as np
a = np.array([1,2])
b = np.array([3,4])
print(f"The dot product of {a} and {b} is: {np.dot(a, b)}")
</pre><p>
         This will execute with the exact same versions of Python 3.8, numpy, and system dependencies a year from now as it does today, because it will always use exactly git commit <code class="literal">d373d80b1207d52621961b16aa4a3438e4f98167</code> of Nixpkgs for all of the package versions.
        </p><p>
         This is also a great way to ensure the script executes identically on different servers.
        </p></div><div class="section"><div class="titlepage"><div><div><h6 class="title"><a id="load-environment-from-.nix-expression"></a>15.21.1.1.3.2. Load environment from <code class="literal">.nix</code> expression</h6></div></div></div><p>
         We’ve now seen how to create an ad-hoc temporary shell session, and how to create a single script with Python dependencies, but in the course of normal development we’re usually working in an entire package repository.
        </p><p>
         As explained in the Nix manual, <code class="literal">nix-shell</code> can also load an expression from a <code class="literal">.nix</code> file. Say we want to have Python 3.8, <code class="literal">numpy</code> and <code class="literal">toolz</code>, like before, in an environment. We can add a <code class="literal">shell.nix</code> file describing our dependencies:
        </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};
(python38.withPackages (ps: [ps.numpy ps.toolz])).env
</pre><p>
         And then at the command line, just typing <code class="literal">nix-shell</code> produces the same environment as before. In a normal project, we’ll likely have many more dependencies; this can provide a way for developers to share the environments with each other and with CI builders.
        </p><p>
         What’s happening here?
        </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
           We begin with importing the Nix Packages collections. <code class="literal">import &lt;nixpkgs&gt;</code> imports the <code class="literal">&lt;nixpkgs&gt;</code> function, <code class="literal">{}</code> calls it and the <code class="literal">with</code> statement brings all attributes of <code class="literal">nixpkgs</code> in the local scope. These attributes form the main package set.
          </p></li><li class="listitem"><p>
           Then we create a Python 3.8 environment with the <code class="literal">withPackages</code> function, as before.
          </p></li><li class="listitem"><p>
           The <code class="literal">withPackages</code> function expects us to provide a function as an argument that takes the set of all Python packages and returns a list of packages to include in the environment. Here, we select the packages <code class="literal">numpy</code> and <code class="literal">toolz</code> from the package set.
          </p></li></ol></div><p>
         To combine this with <code class="literal">mkShell</code> you can:
        </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};
let
  pythonEnv = python38.withPackages (ps: [
    ps.numpy
    ps.toolz
  ]);
in mkShell {
  packages = [
    pythonEnv

    black
    mypy

    libffi
    openssl
  ];
}
</pre><p>
         This will create a unified environment that has not just our Python interpreter and its Python dependencies, but also tools like <code class="literal">black</code> or <code class="literal">mypy</code> and libraries like <code class="literal">libffi</code> the <code class="literal">openssl</code> in scope. This is generic and can span any number of tools or languages across the Nixpkgs ecosystem.
        </p></div><div class="section"><div class="titlepage"><div><div><h6 class="title"><a id="installing-environments-globally-on-the-system"></a>15.21.1.1.3.3. Installing environments globally on the system</h6></div></div></div><p>
         Up to now, we’ve been creating environments scoped to an ad-hoc shell session, or a single script, or a single project. This is generally advisable, as it avoids pollution across contexts.
        </p><p>
         However, sometimes we know we will often want a Python with some basic packages, and want this available without having to enter into a shell or build context. This can be useful to have things like vim/emacs editors and plugins or shell tools <span class="quote">“<span class="quote">just work</span>”</span> without having to set them up, or when running other software that expects packages to be installed globally.
        </p><p>
         To create your own custom environment, create a file in <code class="literal">~/.config/nixpkgs/overlays/</code> that looks like this:
        </p><pre class="programlisting">
# ~/.config/nixpkgs/overlays/myEnv.nix
self: super: {
  myEnv = super.buildEnv {
    name = "myEnv";
    paths = [
      # A Python 3 interpreter with some packages
      (self.python3.withPackages (
        ps: with ps; [
          pyflakes
          pytest
          python-language-server
        ]
      ))

      # Some other packages we'd like as part of this env
      self.mypy
      self.black
      self.ripgrep
      self.tmux
    ];
  };
}
</pre><p>
         You can then build and install this to your profile with:
        </p><pre class="programlisting">
nix-env -iA myEnv
</pre><p>
         One limitation of this is that you can only have 1 Python env installed globally, since they conflict on the <code class="literal">python</code> to load out of your <code class="literal">PATH</code>.
        </p><p>
         If you get a conflict or prefer to keep the setup clean, you can have <code class="literal">nix-env</code> atomically <span class="emphasis"><em>uninstall</em></span> all other imperatively installed packages and replace your profile with just <code class="literal">myEnv</code> by using the <code class="literal">--replace</code> flag.
        </p></div><div class="section"><div class="titlepage"><div><div><h6 class="title"><a id="environment-defined-in-etcnixosconfiguration.nix"></a>15.21.1.1.3.4. Environment defined in <code class="literal">/etc/nixos/configuration.nix</code></h6></div></div></div><p>
         For the sake of completeness, here’s how to install the environment system-wide on NixOS.
        </p><pre class="programlisting">
{ # ...

  environment.systemPackages = with pkgs; [
    (python38.withPackages(ps: with ps; [ numpy toolz ]))
  ];
}
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="developing-with-python"></a>15.21.1.2. Developing with Python</h4></div></div></div><p>
       Above, we were mostly just focused on use cases and what to do to get started creating working Python environments in nix.
      </p><p>
       Now that you know the basics to be up and running, it is time to take a step back and take a deeper look at how Python packages are packaged on Nix. Then, we will look at how you can use development mode with your code.
      </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="python-library-packages-in-nixpkgs"></a>15.21.1.2.1. Python library packages in Nixpkgs</h5></div></div></div><p>
        With Nix all packages are built by functions. The main function in Nix for building Python libraries is <code class="literal">buildPythonPackage</code>. Let’s see how we can build the <code class="literal">toolz</code> package.
       </p><pre class="programlisting">
{ lib, buildPythonPackage, fetchPypi }:

buildPythonPackage rec {
  pname = "toolz";
  version = "0.10.0";

  src = fetchPypi {
    inherit pname version;
    sha256 = "08fdd5ef7c96480ad11c12d472de21acd32359996f69a5259299b540feba4560";
  };

  doCheck = false;

  meta = with lib; {
    homepage = "https://github.com/pytoolz/toolz";
    description = "List processing tools and functional utilities";
    license = licenses.bsd3;
    maintainers = with maintainers; [ fridh ];
  };
}
</pre><p>
        What happens here? The function <code class="literal">buildPythonPackage</code> is called and as argument it accepts a set. In this case the set is a recursive set, <code class="literal">rec</code>. One of the arguments is the name of the package, which consists of a basename (generally following the name on PyPi) and a version. Another argument, <code class="literal">src</code> specifies the source, which in this case is fetched from PyPI using the helper function <code class="literal">fetchPypi</code>. The argument <code class="literal">doCheck</code> is used to set whether tests should be run when building the package. Furthermore, we specify some (optional) meta information. The output of the function is a derivation.
       </p><p>
        An expression for <code class="literal">toolz</code> can be found in the Nixpkgs repository. As explained in the introduction of this Python section, a derivation of <code class="literal">toolz</code> is available for each interpreter version, e.g. <code class="literal">python38.pkgs.toolz</code> refers to the <code class="literal">toolz</code> derivation corresponding to the CPython 3.8 interpreter.
       </p><p>
        The above example works when you’re directly working on <code class="literal">pkgs/top-level/python-packages.nix</code> in the Nixpkgs repository. Often though, you will want to test a Nix expression outside of the Nixpkgs tree.
       </p><p>
        The following expression creates a derivation for the <code class="literal">toolz</code> package, and adds it along with a <code class="literal">numpy</code> package to a Python environment.
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

( let
    my_toolz = python38.pkgs.buildPythonPackage rec {
      pname = "toolz";
      version = "0.10.0";

      src = python38.pkgs.fetchPypi {
        inherit pname version;
        sha256 = "08fdd5ef7c96480ad11c12d472de21acd32359996f69a5259299b540feba4560";
      };

      doCheck = false;

      meta = {
        homepage = "https://github.com/pytoolz/toolz/";
        description = "List processing tools and functional utilities";
      };
    };

  in python38.withPackages (ps: [ps.numpy my_toolz])
).env
</pre><p>
        Executing <code class="literal">nix-shell</code> will result in an environment in which you can use Python 3.8 and the <code class="literal">toolz</code> package. As you can see we had to explicitly mention for which Python version we want to build a package.
       </p><p>
        So, what did we do here? Well, we took the Nix expression that we used earlier to build a Python environment, and said that we wanted to include our own version of <code class="literal">toolz</code>, named <code class="literal">my_toolz</code>. To introduce our own package in the scope of <code class="literal">withPackages</code> we used a <code class="literal">let</code> expression. You can see that we used <code class="literal">ps.numpy</code> to select numpy from the nixpkgs package set (<code class="literal">ps</code>). We did not take <code class="literal">toolz</code> from the Nixpkgs package set this time, but instead took our own version that we introduced with the <code class="literal">let</code> expression.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="handling-dependencies"></a>15.21.1.2.2. Handling dependencies</h5></div></div></div><p>
        Our example, <code class="literal">toolz</code>, does not have any dependencies on other Python packages or system libraries. According to the manual, <code class="literal">buildPythonPackage</code> uses the arguments <code class="literal">buildInputs</code> and <code class="literal">propagatedBuildInputs</code> to specify dependencies. If something is exclusively a build-time dependency, then the dependency should be included in <code class="literal">buildInputs</code>, but if it is (also) a runtime dependency, then it should be added to <code class="literal">propagatedBuildInputs</code>. Test dependencies are considered build-time dependencies and passed to <code class="literal">checkInputs</code>.
       </p><p>
        The following example shows which arguments are given to <code class="literal">buildPythonPackage</code> in order to build <a class="link" href="https://github.com/blaze/datashape" target="_top"><code class="literal">datashape</code></a>.
       </p><pre class="programlisting">
{ lib, buildPythonPackage, fetchPypi, numpy, multipledispatch, dateutil, pytest }:

buildPythonPackage rec {
  pname = "datashape";
  version = "0.4.7";

  src = fetchPypi {
    inherit pname version;
    sha256 = "14b2ef766d4c9652ab813182e866f493475e65e558bed0822e38bf07bba1a278";
  };

  checkInputs = [ pytest ];
  propagatedBuildInputs = [ numpy multipledispatch dateutil ];

  meta = with lib; {
    homepage = "https://github.com/ContinuumIO/datashape";
    description = "A data description language";
    license = licenses.bsd2;
    maintainers = with maintainers; [ fridh ];
  };
}
</pre><p>
        We can see several runtime dependencies, <code class="literal">numpy</code>, <code class="literal">multipledispatch</code>, and <code class="literal">dateutil</code>. Furthermore, we have one <code class="literal">checkInputs</code>, i.e. <code class="literal">pytest</code>. <code class="literal">pytest</code> is a test runner and is only used during the <code class="literal">checkPhase</code> and is therefore not added to <code class="literal">propagatedBuildInputs</code>.
       </p><p>
        In the previous case we had only dependencies on other Python packages to consider. Occasionally you have also system libraries to consider. E.g., <code class="literal">lxml</code> provides Python bindings to <code class="literal">libxml2</code> and <code class="literal">libxslt</code>. These libraries are only required when building the bindings and are therefore added as <code class="literal">buildInputs</code>.
       </p><pre class="programlisting">
{ lib, pkgs, buildPythonPackage, fetchPypi }:

buildPythonPackage rec {
  pname = "lxml";
  version = "3.4.4";

  src = fetchPypi {
    inherit pname version;
    sha256 = "16a0fa97hym9ysdk3rmqz32xdjqmy4w34ld3rm3jf5viqjx65lxk";
  };

  buildInputs = [ pkgs.libxml2 pkgs.libxslt ];

  meta = with lib; {
    description = "Pythonic binding for the libxml2 and libxslt libraries";
    homepage = "https://lxml.de";
    license = licenses.bsd3;
    maintainers = with maintainers; [ sjourdois ];
  };
}
</pre><p>
        In this example <code class="literal">lxml</code> and Nix are able to work out exactly where the relevant files of the dependencies are. This is not always the case.
       </p><p>
        The example below shows bindings to The Fastest Fourier Transform in the West, commonly known as FFTW. On Nix we have separate packages of FFTW for the different types of floats (<code class="literal">"single"</code>, <code class="literal">"double"</code>, <code class="literal">"long-double"</code>). The bindings need all three types, and therefore we add all three as <code class="literal">buildInputs</code>. The bindings don’t expect to find each of them in a different folder, and therefore we have to set <code class="literal">LDFLAGS</code> and <code class="literal">CFLAGS</code>.
       </p><pre class="programlisting">
{ lib, pkgs, buildPythonPackage, fetchPypi, numpy, scipy }:

buildPythonPackage rec {
  pname = "pyFFTW";
  version = "0.9.2";

  src = fetchPypi {
    inherit pname version;
    sha256 = "f6bbb6afa93085409ab24885a1a3cdb8909f095a142f4d49e346f2bd1b789074";
  };

  buildInputs = [ pkgs.fftw pkgs.fftwFloat pkgs.fftwLongDouble];

  propagatedBuildInputs = [ numpy scipy ];

  # Tests cannot import pyfftw. pyfftw works fine though.
  doCheck = false;

  preConfigure = ''
    export LDFLAGS="-L${pkgs.fftw.dev}/lib -L${pkgs.fftwFloat.out}/lib -L${pkgs.fftwLongDouble.out}/lib"
    export CFLAGS="-I${pkgs.fftw.dev}/include -I${pkgs.fftwFloat.dev}/include -I${pkgs.fftwLongDouble.dev}/include"
  '';

  meta = with lib; {
    description = "A pythonic wrapper around FFTW, the FFT library, presenting a unified interface for all the supported transforms";
    homepage = "http://hgomersall.github.com/pyFFTW";
    license = with licenses; [ bsd2 bsd3 ];
    maintainers = with maintainers; [ fridh ];
  };
}
</pre><p>
        Note also the line <code class="literal">doCheck = false;</code>, we explicitly disabled running the test-suite.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="testing-python-packages"></a>15.21.1.2.3. Testing Python Packages</h5></div></div></div><p>
        It is highly encouraged to have testing as part of the package build. This helps to avoid situations where the package was able to build and install, but is not usable at runtime. Currently, all packages will use the <code class="literal">test</code> command provided by the setup.py (i.e. <code class="literal">python setup.py test</code>). However, this is currently deprecated https://github.com/pypa/setuptools/pull/1878 and your package should provide its own checkPhase.
       </p><p>
        <span class="emphasis"><em>NOTE:</em></span> The <code class="literal">checkPhase</code> for python maps to the <code class="literal">installCheckPhase</code> on a normal derivation. This is due to many python packages not behaving well to the pre-installed version of the package. Version info, and natively compiled extensions generally only exist in the install directory, and thus can cause issues when a test suite asserts on that behavior.
       </p><p>
        <span class="emphasis"><em>NOTE:</em></span> Tests should only be disabled if they don’t agree with nix (e.g. external dependencies, network access, flakey tests), however, as many tests should be enabled as possible. Failing tests can still be a good indication that the package is not in a valid state.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="using-pytest"></a>15.21.1.2.4. Using pytest</h5></div></div></div><p>
        Pytest is the most common test runner for python repositories. A trivial test run would be:
       </p><pre class="programlisting">
  checkInputs = [ pytest ];
  checkPhase = "pytest";
</pre><p>
        However, many repositories’ test suites do not translate well to nix’s build sandbox, and will generally need many tests to be disabled.
       </p><p>
        To filter tests using pytest, one can do the following:
       </p><pre class="programlisting">
  checkInputs = [ pytest ];
  # avoid tests which need additional data or touch network
  checkPhase = ''
    pytest tests/ --ignore=tests/integration -k 'not download and not update'
  '';
</pre><p>
        <code class="literal">--ignore</code> will tell pytest to ignore that file or directory from being collected as part of a test run. This is useful is a file uses a package which is not available in nixpkgs, thus skipping that test file is much easier than having to create a new package.
       </p><p>
        <code class="literal">-k</code> is used to define a predicate for test names. In this example, we are filtering out tests which contain <code class="literal">download</code> or <code class="literal">update</code> in their test case name. Only one <code class="literal">-k</code> argument is allows, and thus a long predicate should be concatenated with "" and wrapped to the next line.
       </p><p>
        <span class="emphasis"><em>NOTE:</em></span> In pytest==6.0.1, the use of "" to continue a line (e.g. <code class="literal">-k 'not download \'</code>) has been removed, in this case, it’s recommended to use <code class="literal">pytestCheckHook</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="using-pytestcheckhook"></a>15.21.1.2.5. Using pytestCheckHook</h5></div></div></div><p>
        <code class="literal">pytestCheckHook</code> is a convenient hook which will substitute the setuptools <code class="literal">test</code> command for a checkPhase which runs <code class="literal">pytest</code>. This is also beneficial when a package may need many items disabled to run the test suite.
       </p><p>
        Using the example above, the analagous pytestCheckHook usage would be:
       </p><pre class="programlisting">
  checkInputs = [ pytestCheckHook ];

  # requires additional data
  pytestFlagsArray = [ "tests/" "--ignore=tests/integration" ];

  disabledTests = [
    # touches network
    "download"
    "update"
  ];

  disabledTestPaths = [
    "tests/test_failing.py"
  ];
</pre><p>
        This is expecially useful when tests need to be conditionallydisabled, for example:
       </p><pre class="programlisting">
  disabledTests = [
    # touches network
    "download"
    "update"
  ] ++ lib.optionals (pythonAtLeast "3.8") [
    # broken due to python3.8 async changes
    "async"
  ] ++ lib.optionals stdenv.isDarwin [
    # can fail when building with other packages
    "socket"
  ];
</pre><p>
        Trying to concatenate the related strings to disable tests in a regular checkPhase would be much harder to read. This also enables us to comment on why specific tests are disabled.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="using-pythonimportscheck"></a>15.21.1.2.6. Using pythonImportsCheck</h5></div></div></div><p>
        Although unit tests are highly prefered to validate correctness of a package, not all packages have test suites that can be ran easily, and some have none at all. To help ensure the package still works, <code class="literal">pythonImportsCheck</code> can attempt to import the listed modules.
       </p><pre class="programlisting">
  pythonImportsCheck = [ "requests" "urllib" ];
</pre><p>
        roughly translates to:
       </p><pre class="programlisting">
  postCheck = ''
    PYTHONPATH=$out/${python.sitePackages}:$PYTHONPATH
    python -c "import requests; import urllib"
  '';
</pre><p>
        However, this is done in it’s own phase, and not dependent on whether <code class="literal">doCheck = true;</code>
       </p><p>
        This can also be useful in verifying that the package doesn’t assume commonly present packages (e.g. <code class="literal">setuptools</code>)
       </p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="develop-local-package"></a>15.21.1.3. Develop local package</h4></div></div></div><p>
       As a Python developer you’re likely aware of <a class="link" href="http://setuptools.readthedocs.io/en/latest/setuptools.html#development-mode" target="_top">development mode</a> (<code class="literal">python setup.py develop</code>); instead of installing the package this command creates a special link to the project code. That way, you can run updated code without having to reinstall after each and every change you make. Development mode is also available. Let’s see how you can use it.
      </p><p>
       In the previous Nix expression the source was fetched from an url. We can also refer to a local source instead using <code class="literal">src = ./path/to/source/tree;</code>
      </p><p>
       If we create a <code class="literal">shell.nix</code> file which calls <code class="literal">buildPythonPackage</code>, and if <code class="literal">src</code> is a local source, and if the local source has a <code class="literal">setup.py</code>, then development mode is activated.
      </p><p>
       In the following example we create a simple environment that has a Python 3.8 version of our package in it, as well as its dependencies and other packages we like to have in the environment, all specified with <code class="literal">propagatedBuildInputs</code>. Indeed, we can just add any package we like to have in our environment to <code class="literal">propagatedBuildInputs</code>.
      </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};
with python38Packages;

buildPythonPackage rec {
  name = "mypackage";
  src = ./path/to/package/source;
  propagatedBuildInputs = [ pytest numpy pkgs.libsndfile ];
}
</pre><p>
       It is important to note that due to how development mode is implemented on Nix it is not possible to have multiple packages simultaneously in development mode.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="organising-your-packages"></a>15.21.1.4. Organising your packages</h4></div></div></div><p>
       So far we discussed how you can use Python on Nix, and how you can develop with it. We’ve looked at how you write expressions to package Python packages, and we looked at how you can create environments in which specified packages are available.
      </p><p>
       At some point you’ll likely have multiple packages which you would like to be able to use in different projects. In order to minimise unnecessary duplication we now look at how you can maintain a repository with your own packages. The important functions here are <code class="literal">import</code> and <code class="literal">callPackage</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="including-a-derivation-using-callpackage"></a>15.21.1.5. Including a derivation using <code class="literal">callPackage</code></h4></div></div></div><p>
       Earlier we created a Python environment using <code class="literal">withPackages</code>, and included the <code class="literal">toolz</code> package via a <code class="literal">let</code> expression. Let’s split the package definition from the environment definition.
      </p><p>
       We first create a function that builds <code class="literal">toolz</code> in <code class="literal">~/path/to/toolz/release.nix</code>
      </p><pre class="programlisting">
{ lib, buildPythonPackage }:

buildPythonPackage rec {
  pname = "toolz";
  version = "0.10.0";

  src = fetchPypi {
    inherit pname version;
    sha256 = "08fdd5ef7c96480ad11c12d472de21acd32359996f69a5259299b540feba4560";
  };

  meta = with lib; {
    homepage = "https://github.com/pytoolz/toolz/";
    description = "List processing tools and functional utilities";
    license = licenses.bsd3;
    maintainers = with maintainers; [ fridh ];
  };
}
</pre><p>
       It takes an argument <code class="literal">buildPythonPackage</code>. We now call this function using <code class="literal">callPackage</code> in the definition of our environment
      </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

( let
    toolz = callPackage /path/to/toolz/release.nix {
      buildPythonPackage = python38Packages.buildPythonPackage;
    };
  in python38.withPackages (ps: [ ps.numpy toolz ])
).env
</pre><p>
       Important to remember is that the Python version for which the package is made depends on the <code class="literal">python</code> derivation that is passed to <code class="literal">buildPythonPackage</code>. Nix tries to automatically pass arguments when possible, which is why generally you don’t explicitly define which <code class="literal">python</code> derivation should be used. In the above example we use <code class="literal">buildPythonPackage</code> that is part of the set <code class="literal">python38Packages</code>, and in this case the <code class="literal">python38</code> interpreter is automatically used.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="reference"></a>15.21.2. Reference</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="interpreters"></a>15.21.2.1. Interpreters</h4></div></div></div><p>
       Versions 2.7, 3.6, 3.7, 3.8 and 3.9 of the CPython interpreter are available as respectively <code class="literal">python27</code>, <code class="literal">python36</code>, <code class="literal">python37</code>, <code class="literal">python38</code> and <code class="literal">python39</code>. The aliases <code class="literal">python2</code> and <code class="literal">python3</code> correspond to respectively <code class="literal">python27</code> and <code class="literal">python39</code>. The attribute <code class="literal">python</code> maps to <code class="literal">python2</code>. The PyPy interpreters compatible with Python 2.7 and 3 are available as <code class="literal">pypy27</code> and <code class="literal">pypy3</code>, with aliases <code class="literal">pypy2</code> mapping to <code class="literal">pypy27</code> and <code class="literal">pypy</code> mapping to <code class="literal">pypy2</code>. The Nix expressions for the interpreters can be found in <code class="literal">pkgs/development/interpreters/python</code>.
      </p><p>
       All packages depending on any Python interpreter get appended <code class="literal">out/{python.sitePackages}</code> to <code class="literal">$PYTHONPATH</code> if such directory exists.
      </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="missing-tkinter-module-standard-library"></a>15.21.2.1.1. Missing <code class="literal">tkinter</code> module standard library</h5></div></div></div><p>
        To reduce closure size the <code class="literal">Tkinter</code>/<code class="literal">tkinter</code> is available as a separate package, <code class="literal">pythonPackages.tkinter</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="attributes-on-interpreters-packages"></a>15.21.2.1.2. Attributes on interpreters packages</h5></div></div></div><p>
        Each interpreter has the following attributes:
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="literal">libPrefix</code>. Name of the folder in <code class="literal">${python}/lib/</code> for corresponding interpreter.
         </p></li><li class="listitem"><p>
          <code class="literal">interpreter</code>. Alias for <code class="literal">${python}/bin/${executable}</code>.
         </p></li><li class="listitem"><p>
          <code class="literal">buildEnv</code>. Function to build python interpreter environments with extra packages bundled together. See section <span class="emphasis"><em>python.buildEnv function</em></span> for usage and documentation.
         </p></li><li class="listitem"><p>
          <code class="literal">withPackages</code>. Simpler interface to <code class="literal">buildEnv</code>. See section <span class="emphasis"><em>python.withPackages function</em></span> for usage and documentation.
         </p></li><li class="listitem"><p>
          <code class="literal">sitePackages</code>. Alias for <code class="literal">lib/${libPrefix}/site-packages</code>.
         </p></li><li class="listitem"><p>
          <code class="literal">executable</code>. Name of the interpreter executable, e.g. <code class="literal">python3.8</code>.
         </p></li><li class="listitem"><p>
          <code class="literal">pkgs</code>. Set of Python packages for that specific interpreter. The package set can be modified by overriding the interpreter and passing <code class="literal">packageOverrides</code>.
         </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="optimizations"></a>15.21.2.2. Optimizations</h4></div></div></div><p>
       The Python interpreters are by default not build with optimizations enabled, because the builds are in that case not reproducible. To enable optimizations, override the interpreter of interest, e.g using
      </p><pre class="programlisting">
let
  pkgs = import ./. {};
  mypython = pkgs.python3.override {
    enableOptimizations = true;
    reproducibleBuild = false;
    self = mypython;
  };
in mypython
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="building-packages-and-applications"></a>15.21.2.3. Building packages and applications</h4></div></div></div><p>
       Python libraries and applications that use <code class="literal">setuptools</code> or <code class="literal">distutils</code> are typically built with respectively the <code class="literal">buildPythonPackage</code> and <code class="literal">buildPythonApplication</code> functions. These two functions also support installing a <code class="literal">wheel</code>.
      </p><p>
       All Python packages reside in <code class="literal">pkgs/top-level/python-packages.nix</code> and all applications elsewhere. In case a package is used as both a library and an application, then the package should be in <code class="literal">pkgs/top-level/python-packages.nix</code> since only those packages are made available for all interpreter versions. The preferred location for library expressions is in <code class="literal">pkgs/development/python-modules</code>. It is important that these packages are called from <code class="literal">pkgs/top-level/python-packages.nix</code> and not elsewhere, to guarantee the right version of the package is built.
      </p><p>
       Based on the packages defined in <code class="literal">pkgs/top-level/python-packages.nix</code> an attribute set is created for each available Python interpreter. The available sets are
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         <code class="literal">pkgs.python27Packages</code>
        </p></li><li class="listitem"><p>
         <code class="literal">pkgs.python36Packages</code>
        </p></li><li class="listitem"><p>
         <code class="literal">pkgs.python37Packages</code>
        </p></li><li class="listitem"><p>
         <code class="literal">pkgs.python38Packages</code>
        </p></li><li class="listitem"><p>
         <code class="literal">pkgs.python39Packages</code>
        </p></li><li class="listitem"><p>
         <code class="literal">pkgs.pypyPackages</code>
        </p></li></ul></div><p>
       and the aliases
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         <code class="literal">pkgs.python2Packages</code> pointing to <code class="literal">pkgs.python27Packages</code>
        </p></li><li class="listitem"><p>
         <code class="literal">pkgs.python3Packages</code> pointing to <code class="literal">pkgs.python38Packages</code>
        </p></li><li class="listitem"><p>
         <code class="literal">pkgs.pythonPackages</code> pointing to <code class="literal">pkgs.python2Packages</code>
        </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="buildpythonpackage-function"></a>15.21.2.3.1. <code class="literal">buildPythonPackage</code> function</h5></div></div></div><p>
        The <code class="literal">buildPythonPackage</code> function is implemented in <code class="literal">pkgs/development/interpreters/python/mk-python-derivation</code> using setup hooks.
       </p><p>
        The following is an example:
       </p><pre class="programlisting">
{ lib, buildPythonPackage, fetchPypi, hypothesis, setuptools_scm, attrs, py, setuptools, six, pluggy }:

buildPythonPackage rec {
  pname = "pytest";
  version = "3.3.1";

  src = fetchPypi {
    inherit pname version;
    sha256 = "cf8436dc59d8695346fcd3ab296de46425ecab00d64096cebe79fb51ecb2eb93";
  };

  postPatch = ''
    # don't test bash builtins
    rm testing/test_argcomplete.py
  '';

  checkInputs = [ hypothesis ];
  nativeBuildInputs = [ setuptools_scm ];
  propagatedBuildInputs = [ attrs py setuptools six pluggy ];

  meta = with lib; {
    maintainers = with maintainers; [ domenkozar lovek323 madjar lsix ];
    description = "Framework for writing tests";
  };
}
</pre><p>
        The <code class="literal">buildPythonPackage</code> mainly does four things:
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          In the <code class="literal">buildPhase</code>, it calls <code class="literal">${python.interpreter} setup.py bdist_wheel</code> to build a wheel binary zipfile.
         </p></li><li class="listitem"><p>
          In the <code class="literal">installPhase</code>, it installs the wheel file using <code class="literal">pip install *.whl</code>.
         </p></li><li class="listitem"><p>
          In the <code class="literal">postFixup</code> phase, the <code class="literal">wrapPythonPrograms</code> bash function is called to wrap all programs in the <code class="literal">$out/bin/*</code> directory to include <code class="literal">$PATH</code> environment variable and add dependent libraries to script’s <code class="literal">sys.path</code>.
         </p></li><li class="listitem"><p>
          In the <code class="literal">installCheck</code> phase, <code class="literal">${python.interpreter} setup.py test</code> is ran.
         </p></li></ul></div><p>
        By default tests are run because <code class="literal">doCheck = true</code>. Test dependencies, like e.g. the test runner, should be added to <code class="literal">checkInputs</code>.
       </p><p>
        By default <code class="literal">meta.platforms</code> is set to the same value as the interpreter unless overridden otherwise.
       </p><div class="section"><div class="titlepage"><div><div><h6 class="title"><a id="buildpythonpackage-parameters"></a>15.21.2.3.1.1. <code class="literal">buildPythonPackage</code> parameters</h6></div></div></div><p>
         All parameters from <code class="literal">stdenv.mkDerivation</code> function are still supported. The following are specific to <code class="literal">buildPythonPackage</code>:
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
           <code class="literal">catchConflicts ? true</code>: If <code class="literal">true</code>, abort package build if a package name appears more than once in dependency tree. Default is <code class="literal">true</code>.
          </p></li><li class="listitem"><p>
           <code class="literal">disabled</code> ? false: If <code class="literal">true</code>, package is not built for the particular Python interpreter version.
          </p></li><li class="listitem"><p>
           <code class="literal">dontWrapPythonPrograms ? false</code>: Skip wrapping of Python programs.
          </p></li><li class="listitem"><p>
           <code class="literal">permitUserSite ? false</code>: Skip setting the <code class="literal">PYTHONNOUSERSITE</code> environment variable in wrapped programs.
          </p></li><li class="listitem"><p>
           <code class="literal">format ? "setuptools"</code>: Format of the source. Valid options are <code class="literal">"setuptools"</code>, <code class="literal">"pyproject"</code>, <code class="literal">"flit"</code>, <code class="literal">"wheel"</code>, and <code class="literal">"other"</code>. <code class="literal">"setuptools"</code> is for when the source has a <code class="literal">setup.py</code> and <code class="literal">setuptools</code> is used to build a wheel, <code class="literal">flit</code>, in case <code class="literal">flit</code> should be used to build a wheel, and <code class="literal">wheel</code> in case a wheel is provided. Use <code class="literal">other</code> when a custom <code class="literal">buildPhase</code> and/or <code class="literal">installPhase</code> is needed.
          </p></li><li class="listitem"><p>
           <code class="literal">makeWrapperArgs ? []</code>: A list of strings. Arguments to be passed to <code class="literal">makeWrapper</code>, which wraps generated binaries. By default, the arguments to <code class="literal">makeWrapper</code> set <code class="literal">PATH</code> and <code class="literal">PYTHONPATH</code> environment variables before calling the binary. Additional arguments here can allow a developer to set environment variables which will be available when the binary is run. For example, <code class="literal">makeWrapperArgs = ["--set FOO BAR" "--set BAZ QUX"]</code>.
          </p></li><li class="listitem"><p>
           <code class="literal">namePrefix</code>: Prepends text to <code class="literal">${name}</code> parameter. In case of libraries, this defaults to <code class="literal">"python3.8-"</code> for Python 3.8, etc., and in case of applications to <code class="literal">""</code>.
          </p></li><li class="listitem"><p>
           <code class="literal">pipInstallFlags ? []</code>: A list of strings. Arguments to be passed to <code class="literal">pip install</code>. To pass options to <code class="literal">python setup.py install</code>, use <code class="literal">--install-option</code>. E.g., <code class="literal">pipInstallFlags=["--install-option='--cpp_implementation'"]</code>.
          </p></li><li class="listitem"><p>
           <code class="literal">pythonPath ? []</code>: List of packages to be added into <code class="literal">$PYTHONPATH</code>. Packages in <code class="literal">pythonPath</code> are not propagated (contrary to <code class="literal">propagatedBuildInputs</code>).
          </p></li><li class="listitem"><p>
           <code class="literal">preShellHook</code>: Hook to execute commands before <code class="literal">shellHook</code>.
          </p></li><li class="listitem"><p>
           <code class="literal">postShellHook</code>: Hook to execute commands after <code class="literal">shellHook</code>.
          </p></li><li class="listitem"><p>
           <code class="literal">removeBinByteCode ? true</code>: Remove bytecode from <code class="literal">/bin</code>. Bytecode is only created when the filenames end with <code class="literal">.py</code>.
          </p></li><li class="listitem"><p>
           <code class="literal">setupPyGlobalFlags ? []</code>: List of flags passed to <code class="literal">setup.py</code> command.
          </p></li><li class="listitem"><p>
           <code class="literal">setupPyBuildFlags ? []</code>: List of flags passed to <code class="literal">setup.py build_ext</code> command.
          </p></li></ul></div><p>
         The <code class="literal">stdenv.mkDerivation</code> function accepts various parameters for describing build inputs (see <span class="quote">“<span class="quote">Specifying dependencies</span>”</span>). The following are of special interest for Python packages, either because these are primarily used, or because their behaviour is different:
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
           <code class="literal">nativeBuildInputs ? []</code>: Build-time only dependencies. Typically executables as well as the items listed in <code class="literal">setup_requires</code>.
          </p></li><li class="listitem"><p>
           <code class="literal">buildInputs ? []</code>: Build and/or run-time dependencies that need to be compiled for the host machine. Typically non-Python libraries which are being linked.
          </p></li><li class="listitem"><p>
           <code class="literal">checkInputs ? []</code>: Dependencies needed for running the <code class="literal">checkPhase</code>. These are added to <code class="literal">nativeBuildInputs</code> when <code class="literal">doCheck = true</code>. Items listed in <code class="literal">tests_require</code> go here.
          </p></li><li class="listitem"><p>
           <code class="literal">propagatedBuildInputs ? []</code>: Aside from propagating dependencies, <code class="literal">buildPythonPackage</code> also injects code into and wraps executables with the paths included in this list. Items listed in <code class="literal">install_requires</code> go here.
          </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h6 class="title"><a id="overriding-python-packages"></a>15.21.2.3.1.2. Overriding Python packages</h6></div></div></div><p>
         The <code class="literal">buildPythonPackage</code> function has a <code class="literal">overridePythonAttrs</code> method that can be used to override the package. In the following example we create an environment where we have the <code class="literal">blaze</code> package using an older version of <code class="literal">pandas</code>. We override first the Python interpreter and pass <code class="literal">packageOverrides</code> which contains the overrides for packages in the package set.
        </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

(let
  python = let
    packageOverrides = self: super: {
      pandas = super.pandas.overridePythonAttrs(old: rec {
        version = "0.19.1";
        src =  super.fetchPypi {
          pname = "pandas";
          inherit version;
          sha256 = "08blshqj9zj1wyjhhw3kl2vas75vhhicvv72flvf1z3jvapgw295";
        };
      });
    };
  in pkgs.python3.override {inherit packageOverrides; self = python;};

in python.withPackages(ps: [ps.blaze])).env
</pre></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="buildpythonapplication-function"></a>15.21.2.3.2. <code class="literal">buildPythonApplication</code> function</h5></div></div></div><p>
        The <code class="literal">buildPythonApplication</code> function is practically the same as <code class="literal">buildPythonPackage</code>. The main purpose of this function is to build a Python package where one is interested only in the executables, and not importable modules. For that reason, when adding this package to a <code class="literal">python.buildEnv</code>, the modules won’t be made available.
       </p><p>
        Another difference is that <code class="literal">buildPythonPackage</code> by default prefixes the names of the packages with the version of the interpreter. Because this is irrelevant for applications, the prefix is omitted.
       </p><p>
        When packaging a Python application with <code class="literal">buildPythonApplication</code>, it should be called with <code class="literal">callPackage</code> and passed <code class="literal">python</code> or <code class="literal">pythonPackages</code> (possibly specifying an interpreter version), like this:
       </p><pre class="programlisting">
{ lib, python3Packages }:

python3Packages.buildPythonApplication rec {
  pname = "luigi";
  version = "2.7.9";

  src = python3Packages.fetchPypi {
    inherit pname version;
    sha256 = "035w8gqql36zlan0xjrzz9j4lh9hs0qrsgnbyw07qs7lnkvbdv9x";
  };

  propagatedBuildInputs = with python3Packages; [ tornado_4 python-daemon ];

  meta = with lib; {
    ...
  };
}
</pre><p>
        This is then added to <code class="literal">all-packages.nix</code> just as any other application would be.
       </p><pre class="programlisting">
luigi = callPackage ../applications/networking/cluster/luigi { };
</pre><p>
        Since the package is an application, a consumer doesn’t need to care about Python versions or modules, which is why they don’t go in <code class="literal">pythonPackages</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="topythonapplication-function"></a>15.21.2.3.3. <code class="literal">toPythonApplication</code> function</h5></div></div></div><p>
        A distinction is made between applications and libraries, however, sometimes a package is used as both. In this case the package is added as a library to <code class="literal">python-packages.nix</code> and as an application to <code class="literal">all-packages.nix</code>. To reduce duplication the <code class="literal">toPythonApplication</code> can be used to convert a library to an application.
       </p><p>
        The Nix expression shall use <code class="literal">buildPythonPackage</code> and be called from <code class="literal">python-packages.nix</code>. A reference shall be created from <code class="literal">all-packages.nix</code> to the attribute in <code class="literal">python-packages.nix</code>, and the <code class="literal">toPythonApplication</code> shall be applied to the reference:
       </p><pre class="programlisting">
youtube-dl = with pythonPackages; toPythonApplication youtube-dl;
</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="topythonmodule-function"></a>15.21.2.3.4. <code class="literal">toPythonModule</code> function</h5></div></div></div><p>
        In some cases, such as bindings, a package is created using <code class="literal">stdenv.mkDerivation</code> and added as attribute in <code class="literal">all-packages.nix</code>. The Python bindings should be made available from <code class="literal">python-packages.nix</code>. The <code class="literal">toPythonModule</code> function takes a derivation and makes certain Python-specific modifications.
       </p><pre class="programlisting">
opencv = toPythonModule (pkgs.opencv.override {
  enablePython = true;
  pythonPackages = self;
});
</pre><p>
        Do pay attention to passing in the right Python version!
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="python.buildenv-function"></a>15.21.2.3.5. <code class="literal">python.buildEnv</code> function</h5></div></div></div><p>
        Python environments can be created using the low-level <code class="literal">pkgs.buildEnv</code> function. This example shows how to create an environment that has the Pyramid Web Framework. Saving the following as <code class="literal">default.nix</code>
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

python.buildEnv.override {
  extraLibs = [ pythonPackages.pyramid ];
  ignoreCollisions = true;
}
</pre><p>
        and running <code class="literal">nix-build</code> will create
       </p><pre class="programlisting">
/nix/store/cf1xhjwzmdki7fasgr4kz6di72ykicl5-python-2.7.8-env
</pre><p>
        with wrapped binaries in <code class="literal">bin/</code>.
       </p><p>
        You can also use the <code class="literal">env</code> attribute to create local environments with needed packages installed. This is somewhat comparable to <code class="literal">virtualenv</code>. For example, running <code class="literal">nix-shell</code> with the following <code class="literal">shell.nix</code>
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

(python3.buildEnv.override {
  extraLibs = with python3Packages; [ numpy requests ];
}).env
</pre><p>
        will drop you into a shell where Python will have the specified packages in its path.
       </p><div class="section"><div class="titlepage"><div><div><h6 class="title"><a id="python.buildenv-arguments"></a>15.21.2.3.5.1. <code class="literal">python.buildEnv</code> arguments</h6></div></div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
           <code class="literal">extraLibs</code>: List of packages installed inside the environment.
          </p></li><li class="listitem"><p>
           <code class="literal">postBuild</code>: Shell command executed after the build of environment.
          </p></li><li class="listitem"><p>
           <code class="literal">ignoreCollisions</code>: Ignore file collisions inside the environment (default is <code class="literal">false</code>).
          </p></li><li class="listitem"><p>
           <code class="literal">permitUserSite</code>: Skip setting the <code class="literal">PYTHONNOUSERSITE</code> environment variable in wrapped binaries in the environment.
          </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="python.withpackages-function"></a>15.21.2.3.6. <code class="literal">python.withPackages</code> function</h5></div></div></div><p>
        The <code class="literal">python.withPackages</code> function provides a simpler interface to the <code class="literal">python.buildEnv</code> functionality. It takes a function as an argument that is passed the set of python packages and returns the list of the packages to be included in the environment. Using the <code class="literal">withPackages</code> function, the previous example for the Pyramid Web Framework environment can be written like this:
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

python.withPackages (ps: [ps.pyramid])
</pre><p>
        <code class="literal">withPackages</code> passes the correct package set for the specific interpreter version as an argument to the function. In the above example, <code class="literal">ps</code> equals <code class="literal">pythonPackages</code>. But you can also easily switch to using python3:
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

python3.withPackages (ps: [ps.pyramid])
</pre><p>
        Now, <code class="literal">ps</code> is set to <code class="literal">python3Packages</code>, matching the version of the interpreter.
       </p><p>
        As <code class="literal">python.withPackages</code> simply uses <code class="literal">python.buildEnv</code> under the hood, it also supports the <code class="literal">env</code> attribute. The <code class="literal">shell.nix</code> file from the previous section can thus be also written like this:
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

(python38.withPackages (ps: [ps.numpy ps.requests])).env
</pre><p>
        In contrast to <code class="literal">python.buildEnv</code>, <code class="literal">python.withPackages</code> does not support the more advanced options such as <code class="literal">ignoreCollisions = true</code> or <code class="literal">postBuild</code>. If you need them, you have to use <code class="literal">python.buildEnv</code>.
       </p><p>
        Python 2 namespace packages may provide <code class="literal">__init__.py</code> that collide. In that case <code class="literal">python.buildEnv</code> should be used with <code class="literal">ignoreCollisions = true</code>.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="setup-hooks"></a>15.21.2.3.7. Setup hooks</h5></div></div></div><p>
        The following are setup hooks specifically for Python packages. Most of these are used in <code class="literal">buildPythonPackage</code>.
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          <code class="literal">eggUnpackhook</code> to move an egg to the correct folder so it can be installed with the <code class="literal">eggInstallHook</code>
         </p></li><li class="listitem"><p>
          <code class="literal">eggBuildHook</code> to skip building for eggs.
         </p></li><li class="listitem"><p>
          <code class="literal">eggInstallHook</code> to install eggs.
         </p></li><li class="listitem"><p>
          <code class="literal">flitBuildHook</code> to build a wheel using <code class="literal">flit</code>.
         </p></li><li class="listitem"><p>
          <code class="literal">pipBuildHook</code> to build a wheel using <code class="literal">pip</code> and PEP 517. Note a build system (e.g. <code class="literal">setuptools</code> or <code class="literal">flit</code>) should still be added as <code class="literal">nativeBuildInput</code>.
         </p></li><li class="listitem"><p>
          <code class="literal">pipInstallHook</code> to install wheels.
         </p></li><li class="listitem"><p>
          <code class="literal">pytestCheckHook</code> to run tests with <code class="literal">pytest</code>. See <a class="link" href="#using-pytestcheckhook" title="15.21.1.2.5. Using pytestCheckHook">example usage</a>.
         </p></li><li class="listitem"><p>
          <code class="literal">pythonCatchConflictsHook</code> to check whether a Python package is not already existing.
         </p></li><li class="listitem"><p>
          <code class="literal">pythonImportsCheckHook</code> to check whether importing the listed modules works.
         </p></li><li class="listitem"><p>
          <code class="literal">pythonRemoveBinBytecode</code> to remove bytecode from the <code class="literal">/bin</code> folder.
         </p></li><li class="listitem"><p>
          <code class="literal">setuptoolsBuildHook</code> to build a wheel using <code class="literal">setuptools</code>.
         </p></li><li class="listitem"><p>
          <code class="literal">setuptoolsCheckHook</code> to run tests with <code class="literal">python setup.py test</code>.
         </p></li><li class="listitem"><p>
          <code class="literal">venvShellHook</code> to source a Python 3 <code class="literal">venv</code> at the <code class="literal">venvDir</code> location. A <code class="literal">venv</code> is created if it does not yet exist. <code class="literal">postVenvCreation</code> can be used to to run commands only after venv is first created.
         </p></li><li class="listitem"><p>
          <code class="literal">wheelUnpackHook</code> to move a wheel to the correct folder so it can be installed with the <code class="literal">pipInstallHook</code>.
         </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="development-mode"></a>15.21.2.4. Development mode</h4></div></div></div><p>
       Development or editable mode is supported. To develop Python packages <code class="literal">buildPythonPackage</code> has additional logic inside <code class="literal">shellPhase</code> to run <code class="literal">pip install -e . --prefix $TMPDIR/</code>for the package.
      </p><p>
       Warning: <code class="literal">shellPhase</code> is executed only if <code class="literal">setup.py</code> exists.
      </p><p>
       Given a <code class="literal">default.nix</code>:
      </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

pythonPackages.buildPythonPackage {
  name = "myproject";
  buildInputs = with pythonPackages; [ pyramid ];

  src = ./.;
}
</pre><p>
       Running <code class="literal">nix-shell</code> with no arguments should give you the environment in which the package would be built with <code class="literal">nix-build</code>.
      </p><p>
       Shortcut to setup environments with C headers/libraries and Python packages:
      </p><pre class="programlisting">
nix-shell -p pythonPackages.pyramid zlib libjpeg git
</pre><p>
       Note: There is a boolean value <code class="literal">lib.inNixShell</code> set to <code class="literal">true</code> if nix-shell is invoked.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="tools"></a>15.21.2.5. Tools</h4></div></div></div><p>
       Packages inside nixpkgs are written by hand. However many tools exist in community to help save time. No tool is preferred at the moment.
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         <a class="link" href="https://github.com/nix-community/pypi2nix" target="_top">pypi2nix</a>: Generate Nix expressions for your Python project. Note that <a class="link" href="https://github.com/nix-community/pypi2nix/issues/222#issuecomment-443497376" target="_top">sharing derivations from pypi2nix with nixpkgs is possible but not encouraged</a>.
        </p></li><li class="listitem"><p>
         <a class="link" href="https://github.com/nix-community/nixpkgs-pytools" target="_top">nixpkgs-pytools</a>
        </p></li><li class="listitem"><p>
         <a class="link" href="https://github.com/nix-community/poetry2nix" target="_top">poetry2nix</a>
        </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="deterministic-builds"></a>15.21.2.6. Deterministic builds</h4></div></div></div><p>
       The Python interpreters are now built deterministically. Minor modifications had to be made to the interpreters in order to generate deterministic bytecode. This has security implications and is relevant for those using Python in a <code class="literal">nix-shell</code>.
      </p><p>
       When the environment variable <code class="literal">DETERMINISTIC_BUILD</code> is set, all bytecode will have timestamp 1. The <code class="literal">buildPythonPackage</code> function sets <code class="literal">DETERMINISTIC_BUILD=1</code> and <a class="link" href="https://docs.python.org/3.8/using/cmdline.html#envvar-PYTHONHASHSEED" target="_top">PYTHONHASHSEED=0</a>. Both are also exported in <code class="literal">nix-shell</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="automatic-tests"></a>15.21.2.7. Automatic tests</h4></div></div></div><p>
       It is recommended to test packages as part of the build process. Source distributions (<code class="literal">sdist</code>) often include test files, but not always.
      </p><p>
       By default the command <code class="literal">python setup.py test</code> is run as part of the <code class="literal">checkPhase</code>, but often it is necessary to pass a custom <code class="literal">checkPhase</code>. An example of such a situation is when <code class="literal">py.test</code> is used.
      </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="common-issues"></a>15.21.2.7.1. Common issues</h5></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
          Non-working tests can often be deselected. By default <code class="literal">buildPythonPackage</code> runs <code class="literal">python setup.py test</code>. Most Python modules follows the standard test protocol where the pytest runner can be used instead. <code class="literal">py.test</code> supports a <code class="literal">-k</code> parameter to ignore test methods or classes:
         </p><pre class="programlisting">
buildPythonPackage {
  # ...
  # assumes the tests are located in tests
  checkInputs = [ pytest ];
  checkPhase = ''
    py.test -k 'not function_name and not other_function' tests
  '';
}
</pre></li><li class="listitem"><p>
          Tests that attempt to access <code class="literal">$HOME</code> can be fixed by using the following work-around before running tests (e.g. <code class="literal">preCheck</code>): <code class="literal">export HOME=$(mktemp -d)</code>
         </p></li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="faq"></a>15.21.3. FAQ</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="how-to-solve-circular-dependencies"></a>15.21.3.1. How to solve circular dependencies?</h4></div></div></div><p>
       Consider the packages <code class="literal">A</code> and <code class="literal">B</code> that depend on each other. When packaging <code class="literal">B</code>, a solution is to override package <code class="literal">A</code> not to depend on <code class="literal">B</code> as an input. The same should also be done when packaging <code class="literal">A</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="how-to-override-a-python-package"></a>15.21.3.2. How to override a Python package?</h4></div></div></div><p>
       We can override the interpreter and pass <code class="literal">packageOverrides</code>. In the following example we rename the <code class="literal">pandas</code> package and build it.
      </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

(let
  python = let
    packageOverrides = self: super: {
      pandas = super.pandas.overridePythonAttrs(old: {name="foo";});
    };
  in pkgs.python38.override {inherit packageOverrides;};

in python.withPackages(ps: [ps.pandas])).env
</pre><p>
       Using <code class="literal">nix-build</code> on this expression will build an environment that contains the package <code class="literal">pandas</code> but with the new name <code class="literal">foo</code>.
      </p><p>
       All packages in the package set will use the renamed package. A typical use case is to switch to another version of a certain package. For example, in the Nixpkgs repository we have multiple versions of <code class="literal">django</code> and <code class="literal">scipy</code>. In the following example we use a different version of <code class="literal">scipy</code> and create an environment that uses it. All packages in the Python package set will now use the updated <code class="literal">scipy</code> version.
      </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

( let
    packageOverrides = self: super: {
      scipy = super.scipy_0_17;
    };
  in (pkgs.python38.override {inherit packageOverrides;}).withPackages (ps: [ps.blaze])
).env
</pre><p>
       The requested package <code class="literal">blaze</code> depends on <code class="literal">pandas</code> which itself depends on <code class="literal">scipy</code>.
      </p><p>
       If you want the whole of Nixpkgs to use your modifications, then you can use <code class="literal">overlays</code> as explained in this manual. In the following example we build a <code class="literal">inkscape</code> using a different version of <code class="literal">numpy</code>.
      </p><pre class="programlisting">
let
  pkgs = import &lt;nixpkgs&gt; {};
  newpkgs = import pkgs.path { overlays = [ (self: super: {
    python38 = let
      packageOverrides = python-self: python-super: {
        numpy = python-super.numpy_1_18;
      };
    in super.python38.override {inherit packageOverrides;};
  } ) ]; };
in newpkgs.inkscape
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="python-setup.py-bdist_wheel-cannot-create-.whl"></a>15.21.3.3. <code class="literal">python setup.py bdist_wheel</code> cannot create .whl</h4></div></div></div><p>
       Executing <code class="literal">python setup.py bdist_wheel</code> in a <code class="literal">nix-shell</code>fails with
      </p><pre class="programlisting">
ValueError: ZIP does not support timestamps before 1980
</pre><p>
       This is because files from the Nix store (which have a timestamp of the UNIX epoch of January 1, 1970) are included in the .ZIP, but .ZIP archives follow the DOS convention of counting timestamps from 1980.
      </p><p>
       The command <code class="literal">bdist_wheel</code> reads the <code class="literal">SOURCE_DATE_EPOCH</code> environment variable, which <code class="literal">nix-shell</code> sets to 1. Unsetting this variable or giving it a value corresponding to 1980 or later enables building wheels.
      </p><p>
       Use 1980 as timestamp:
      </p><pre class="programlisting">
nix-shell --run "SOURCE_DATE_EPOCH=315532800 python3 setup.py bdist_wheel"
</pre><p>
       or the current time:
      </p><pre class="programlisting">
nix-shell --run "SOURCE_DATE_EPOCH=$(date +%s) python3 setup.py bdist_wheel"
</pre><p>
       or unset <code class="literal">SOURCE_DATE_EPOCH</code>:
      </p><pre class="programlisting">
nix-shell --run "unset SOURCE_DATE_EPOCH; python3 setup.py bdist_wheel"
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="install_data-data_files-problems"></a>15.21.3.4. <code class="literal">install_data</code> / <code class="literal">data_files</code> problems</h4></div></div></div><p>
       If you get the following error:
      </p><pre class="programlisting">
could not create '/nix/store/6l1bvljpy8gazlsw2aw9skwwp4pmvyxw-python-2.7.8/etc':
Permission denied
</pre><p>
       This is a <a class="link" href="https://github.com/pypa/setuptools/issues/130" target="_top">known bug</a> in <code class="literal">setuptools</code>. Setuptools <code class="literal">install_data</code> does not respect <code class="literal">--prefix</code>. An example of such package using the feature is <code class="literal">pkgs/tools/X11/xpra/default.nix</code>.
      </p><p>
       As workaround install it as an extra <code class="literal">preInstall</code> step:
      </p><pre class="programlisting">
${python.interpreter} setup.py install_data --install-dir=$out --root=$out
sed -i '/ = data\_files/d' setup.py
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="rationale-of-non-existent-global-site-packages"></a>15.21.3.5. Rationale of non-existent global site-packages</h4></div></div></div><p>
       On most operating systems a global <code class="literal">site-packages</code> is maintained. This however becomes problematic if you want to run multiple Python versions or have multiple versions of certain libraries for your projects. Generally, you would solve such issues by creating virtual environments using <code class="literal">virtualenv</code>.
      </p><p>
       On Nix each package has an isolated dependency tree which, in the case of Python, guarantees the right versions of the interpreter and libraries or packages are available. There is therefore no need to maintain a global <code class="literal">site-packages</code>.
      </p><p>
       If you want to create a Python environment for development, then the recommended method is to use <code class="literal">nix-shell</code>, either with or without the <code class="literal">python.buildEnv</code> function.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="how-to-consume-python-modules-using-pip-in-a-virtual-environment-like-i-am-used-to-on-other-operating-systems"></a>15.21.3.6. How to consume Python modules using pip in a virtual environment like I am used to on other Operating Systems?</h4></div></div></div><p>
       While this approach is not very idiomatic from Nix perspective, it can still be useful when dealing with pre-existing projects or in situations where it’s not feasible or desired to write derivations for all required dependencies.
      </p><p>
       This is an example of a <code class="literal">default.nix</code> for a <code class="literal">nix-shell</code>, which allows to consume a virtual environment created by <code class="literal">venv</code>, and install Python modules through <code class="literal">pip</code> the traditional way.
      </p><p>
       Create this <code class="literal">default.nix</code> file, together with a <code class="literal">requirements.txt</code> and simply execute <code class="literal">nix-shell</code>.
      </p><pre class="programlisting">
with import &lt;nixpkgs&gt; { };

let
  pythonPackages = python3Packages;
in pkgs.mkShell rec {
  name = "impurePythonEnv";
  venvDir = "./.venv";
  buildInputs = [
    # A Python interpreter including the 'venv' module is required to bootstrap
    # the environment.
    pythonPackages.python

    # This execute some shell code to initialize a venv in $venvDir before
    # dropping into the shell
    pythonPackages.venvShellHook

    # Those are dependencies that we would like to use from nixpkgs, which will
    # add them to PYTHONPATH and thus make them accessible from within the venv.
    pythonPackages.numpy
    pythonPackages.requests

    # In this particular example, in order to compile any binary extensions they may
    # require, the Python modules listed in the hypothetical requirements.txt need
    # the following packages to be installed locally:
    taglib
    openssl
    git
    libxml2
    libxslt
    libzip
    zlib
  ];

  # Run this command, only after creating the virtual environment
  postVenvCreation = ''
    unset SOURCE_DATE_EPOCH
    pip install -r requirements.txt
  '';

  # Now we can execute any commands within the virtual environment.
  # This is optional and can be left out to run pip manually.
  postShellHook = ''
    # allow pip to install wheels
    unset SOURCE_DATE_EPOCH
  '';

}
</pre><p>
       In case the supplied venvShellHook is insufficient, or when Python 2 support is needed, you can define your own shell hook and adapt to your needs like in the following example:
      </p><pre class="programlisting">
with import &lt;nixpkgs&gt; { };

let
  venvDir = "./.venv";
  pythonPackages = python3Packages;
in pkgs.mkShell rec {
  name = "impurePythonEnv";
  buildInputs = [
    pythonPackages.python
    # Needed when using python 2.7
    # pythonPackages.virtualenv
    # ...
  ];

  # This is very close to how venvShellHook is implemented, but
  # adapted to use 'virtualenv'
  shellHook = ''
    SOURCE_DATE_EPOCH=$(date +%s)

    if [ -d "${venvDir}" ]; then
      echo "Skipping venv creation, '${venvDir}' already exists"
    else
      echo "Creating new venv environment in path: '${venvDir}'"
      # Note that the module venv was only introduced in python 3, so for 2.7
      # this needs to be replaced with a call to virtualenv
      ${pythonPackages.python.interpreter} -m venv "${venvDir}"
    fi

    # Under some circumstances it might be necessary to add your virtual
    # environment to PYTHONPATH, which you can do here too;
    # PYTHONPATH=$PWD/${venvDir}/${pythonPackages.python.sitePackages}/:$PYTHONPATH

    source "${venvDir}/bin/activate"

    # As in the previous example, this is optional.
    pip install -r requirements.txt
  '';
}
</pre><p>
       Note that the <code class="literal">pip install</code> is an imperative action. So every time <code class="literal">nix-shell</code> is executed it will attempt to download the Python modules listed in requirements.txt. However these will be cached locally within the <code class="literal">virtualenv</code> folder and not downloaded again.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="how-to-override-a-python-package-from-configuration.nix"></a>15.21.3.7. How to override a Python package from <code class="literal">configuration.nix</code>?</h4></div></div></div><p>
       If you need to change a package’s attribute(s) from <code class="literal">configuration.nix</code> you could do:
      </p><pre class="programlisting">
  nixpkgs.config.packageOverrides = super: {
    python = super.python.override {
      packageOverrides = python-self: python-super: {
        twisted = python-super.twisted.overrideAttrs (oldAttrs: {
          src = super.fetchPipy {
            pname = "twisted";
            version = "19.10.0";
            sha256 = "7394ba7f272ae722a74f3d969dcf599bc4ef093bc392038748a490f1724a515d";
            extension = "tar.bz2";
          };
        });
      };
    };
  };
</pre><p>
       <code class="literal">pythonPackages.twisted</code> is now globally overridden. All packages and also all NixOS services that reference <code class="literal">twisted</code> (such as <code class="literal">services.buildbot-worker</code>) now use the new definition. Note that <code class="literal">python-super</code> refers to the old package set and <code class="literal">python-self</code> to the new, overridden version.
      </p><p>
       To modify only a Python package set instead of a whole Python derivation, use this snippet:
      </p><pre class="programlisting">
  myPythonPackages = pythonPackages.override {
    overrides = self: super: {
      twisted = ...;
    };
  }
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="how-to-override-a-python-package-using-overlays"></a>15.21.3.8. How to override a Python package using overlays?</h4></div></div></div><p>
       Use the following overlay template:
      </p><pre class="programlisting">
self: super: {
  python = super.python.override {
    packageOverrides = python-self: python-super: {
      twisted = python-super.twisted.overrideAttrs (oldAttrs: {
        src = super.fetchPypi {
          pname = "twisted";
          version = "19.10.0";
          sha256 = "7394ba7f272ae722a74f3d969dcf599bc4ef093bc392038748a490f1724a515d";
          extension = "tar.bz2";
        };
      });
    };
  };
}
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="how-to-use-intels-mkl-with-numpy-and-scipy"></a>15.21.3.9. How to use Intel’s MKL with numpy and scipy?</h4></div></div></div><p>
       MKL can be configured using an overlay. See the section <span class="quote">“<span class="quote"><a class="link" href="#sec-overlays-alternatives-blas-lapack" title="3.3.1. BLAS/LAPACK">Using overlays to configure alternatives</a></span>”</span>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="what-inputs-do-setup_requires-install_requires-and-tests_require-map-to"></a>15.21.3.10. What inputs do <code class="literal">setup_requires</code>, <code class="literal">install_requires</code> and <code class="literal">tests_require</code> map to?</h4></div></div></div><p>
       In a <code class="literal">setup.py</code> or <code class="literal">setup.cfg</code> it is common to declare dependencies:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         <code class="literal">setup_requires</code> corresponds to <code class="literal">nativeBuildInputs</code>
        </p></li><li class="listitem"><p>
         <code class="literal">install_requires</code> corresponds to <code class="literal">propagatedBuildInputs</code>
        </p></li><li class="listitem"><p>
         <code class="literal">tests_require</code> corresponds to <code class="literal">checkInputs</code>
        </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="contributing"></a>15.21.4. Contributing</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="contributing-guidelines"></a>15.21.4.1. Contributing guidelines</h4></div></div></div><p>
       The following rules are desired to be respected:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         Python libraries are called from <code class="literal">python-packages.nix</code> and packaged with <code class="literal">buildPythonPackage</code>. The expression of a library should be in <code class="literal">pkgs/development/python-modules/&lt;name&gt;/default.nix</code>.
        </p></li><li class="listitem"><p>
         Python applications live outside of <code class="literal">python-packages.nix</code> and are packaged with <code class="literal">buildPythonApplication</code>.
        </p></li><li class="listitem"><p>
         Make sure libraries build for all Python interpreters.
        </p></li><li class="listitem"><p>
         By default we enable tests. Make sure the tests are found and, in the case of libraries, are passing for all interpreters. If certain tests fail they can be disabled individually. Try to avoid disabling the tests altogether. In any case, when you disable tests, leave a comment explaining why.
        </p></li><li class="listitem"><p>
         Commit names of Python libraries should reflect that they are Python libraries, so write for example <code class="literal">pythonPackages.numpy: 1.11 -&gt; 1.12</code>.
        </p></li><li class="listitem"><p>
         Attribute names in <code class="literal">python-packages.nix</code> as well as <code class="literal">pname</code>s should match the library’s name on PyPI, but be normalized according to <a class="link" href="https://www.python.org/dev/peps/pep-0503/#normalized-names" target="_top">PEP 0503</a>. This means that characters should be converted to lowercase and <code class="literal">.</code> and <code class="literal">_</code> should be replaced by a single <code class="literal">-</code> (foo-bar-baz instead of Foo__Bar.baz). If necessary, <code class="literal">pname</code> has to be given a different value within <code class="literal">fetchPypi</code>.
        </p></li><li class="listitem"><p>
         Attribute names in <code class="literal">python-packages.nix</code> should be sorted alphanumerically to avoid merge conflicts and ease locating attributes.
        </p></li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-language-qt"></a>15.22. Qt</h2></div></div></div><p>
     Writing Nix expressions for Qt libraries and applications is largely similar as for other C++ software. This section assumes some knowledge of the latter. There are two problems that the Nixpkgs Qt infrastructure addresses, which are not shared by other C++ software:
    </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
       There are usually multiple supported versions of Qt in Nixpkgs. All of a package’s dependencies must be built with the same version of Qt. This is similar to the version constraints imposed on interpreted languages like Python.
      </p></li><li class="listitem"><p>
       Qt makes extensive use of runtime dependency detection. Runtime dependencies are made into build dependencies through wrappers.
      </p></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="qt-default-nix"></a>15.22.1. Nix expression for a Qt package (default.nix)</h3></div></div></div><pre class="programlisting">
    { stdenv, lib, qtbase, wrapQtAppsHook }: <a id="qt-default-nix-co-1"></a><span><img src="images/callouts/1.svg" alt="1" border="0" /></span>

    stdenv.mkDerivation {
      pname = "myapp";
      version = "1.0";

      buildInputs = [ qtbase ];
      nativeBuildInputs = [ wrapQtAppsHook ]; <a id="qt-default-nix-co-2"></a><span><img src="images/callouts/2.svg" alt="2" border="0" /></span>
    }
    </pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#qt-default-nix-co-1"><span><img src="images/callouts/1.svg" alt="1" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
        Import Qt modules directly, that is: <code class="literal">qtbase</code>, <code class="literal">qtdeclarative</code>, etc. <span class="emphasis"><em>Do not</em></span> import Qt package sets such as <code class="literal">qt5</code> because the Qt versions of dependencies may not be coherent, causing build and runtime failures.
       </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#qt-default-nix-co-2"><span><img src="images/callouts/2.svg" alt="2" border="0" /></span></a> </p></td><td valign="top" align="left"><p>
        All Qt packages must include <code class="literal">wrapQtAppsHook</code> in <code class="literal">nativeBuildInputs</code>, or you must explicitly set <code class="literal">dontWrapQtApps</code>.
       </p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="qt-runtime-dependencies"></a>15.22.2. Locating runtime dependencies</h3></div></div></div><p>
      Qt applications must be wrapped to find runtime dependencies. Include <code class="literal">wrapQtAppsHook</code> in <code class="literal">nativeBuildInputs</code>:
     </p><pre class="programlisting">
{ stdenv, wrapQtAppsHook }:

stdenv.mkDerivation {
  # ...
  nativeBuildInputs = [ wrapQtAppsHook ];
}
</pre><p>
      Add entries to <code class="literal">qtWrapperArgs</code> are to modify the wrappers created by <code class="literal">wrapQtAppsHook</code>:
     </p><pre class="programlisting">
{ stdenv, wrapQtAppsHook }:

stdenv.mkDerivation {
  # ...
  nativeBuildInputs = [ wrapQtAppsHook ];
  qtWrapperArgs = [ ''--prefix PATH : /path/to/bin'' ];
}
</pre><p>
      The entries are passed as arguments to <a class="link" href="#fun-wrapProgram" title="6.6.7. wrapProgram &lt;executable&gt; &lt;makeWrapperArgs&gt;">wrapProgram</a>.
     </p><p>
      Set <code class="literal">dontWrapQtApps</code> to stop applications from being wrapped automatically. Wrap programs manually with <code class="literal">wrapQtApp</code>, using the syntax of <a class="link" href="#fun-wrapProgram" title="6.6.7. wrapProgram &lt;executable&gt; &lt;makeWrapperArgs&gt;">wrapProgram</a>:
     </p><pre class="programlisting">
{ stdenv, lib, wrapQtAppsHook }:

stdenv.mkDerivation {
  # ...
  nativeBuildInputs = [ wrapQtAppsHook ];
  dontWrapQtApps = true;
  preFixup = ''
      wrapQtApp "$out/bin/myapp" --prefix PATH : /path/to/bin
  '';
}
</pre><div class="note"><h3 class="title">Note</h3><p>
       <code class="literal">wrapQtAppsHook</code> ignores files that are non-ELF executables. This means that scripts won’t be automatically wrapped so you’ll need to manually wrap them as previously mentioned. An example of when you’d always need to do this is with Python applications that use PyQt.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding-a-library-to-nixpkgs"></a>15.22.3. Adding a library to Nixpkgs</h3></div></div></div><p>
      Add Qt libraries to <code class="literal">qt5-packages.nix</code> to make them available for every supported Qt version.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="qt-library-all-packages-nix"></a>15.22.3.1. Example adding a Qt library</h4></div></div></div><p>
       The following represents the contents of <code class="literal">qt5-packages.nix</code>.
      </p><pre class="programlisting">
{
  # ...

  mylib = callPackage ../path/to/mylib {};

  # ...
}
</pre><p>
       Libraries are built with every available version of Qt. Use the <code class="literal">meta.broken</code> attribute to disable the package for unsupported Qt versions:
      </p><pre class="programlisting">
{ stdenv, lib, qtbase }:

stdenv.mkDerivation {
  # ...
  # Disable this library with Qt &lt; 5.9.0
  meta.broken = lib.versionOlder qtbase.version "5.9.0";
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding-an-application-to-nixpkgs"></a>15.22.4. Adding an application to Nixpkgs</h3></div></div></div><p>
      Add Qt applications to <code class="literal">qt5-packages.nix</code>. Add an alias to <code class="literal">all-packages.nix</code> to select the Qt 5 version used for the application.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="qt-application-all-packages-nix"></a>15.22.4.1. Example adding a Qt application</h4></div></div></div><p>
       The following represents the contents of <code class="literal">qt5-packages.nix</code>.
      </p><pre class="programlisting">
{
  # ...

  myapp = callPackage ../path/to/myapp {};

  # ...
}
</pre><p>
       The following represents the contents of <code class="literal">all-packages.nix</code>.
      </p><pre class="programlisting">
{
  # ...

  myapp = libsForQt5.myapp;

  # ...
}
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="r"></a>15.23. R</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="installation"></a>15.23.1. Installation</h3></div></div></div><p>
      Define an environment for R that contains all the libraries that you’d like to use by adding the following snippet to your $HOME/.config/nixpkgs/config.nix file:
     </p><pre class="programlisting">
{
    packageOverrides = super: let self = super.pkgs; in
    {

        rEnv = super.rWrapper.override {
            packages = with self.rPackages; [
                devtools
                ggplot2
                reshape2
                yaml
                optparse
                ];
        };
    };
}
</pre><p>
      Then you can use <code class="literal">nix-env -f "&lt;nixpkgs&gt;" -iA rEnv</code> to install it into your user profile. The set of available libraries can be discovered by running the command <code class="literal">nix-env -f "&lt;nixpkgs&gt;" -qaP -A rPackages</code>. The first column from that output is the name that has to be passed to rWrapper in the code snipped above.
     </p><p>
      However, if you’d like to add a file to your project source to make the environment available for other contributors, you can create a <code class="literal">default.nix</code> file like so:
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};
{
  myProject = stdenv.mkDerivation {
    name = "myProject";
    version = "1";
    src = if lib.inNixShell then null else nix;

    buildInputs = with rPackages; [
      R
      ggplot2
      knitr
    ];
  };
}
</pre><p>
      and then run <code class="literal">nix-shell .</code> to be dropped into a shell with those packages available.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="rstudio"></a>15.23.2. RStudio</h3></div></div></div><p>
      RStudio uses a standard set of packages and ignores any custom R environments or installed packages you may have. To create a custom environment, see <code class="literal">rstudioWrapper</code>, which functions similarly to <code class="literal">rWrapper</code>:
     </p><pre class="programlisting">
{
    packageOverrides = super: let self = super.pkgs; in
    {

        rstudioEnv = super.rstudioWrapper.override {
            packages = with self.rPackages; [
                dplyr
                ggplot2
                reshape2
                ];
        };
    };
}
</pre><p>
      Then like above, <code class="literal">nix-env -f "&lt;nixpkgs&gt;" -iA rstudioEnv</code> will install this into your user profile.
     </p><p>
      Alternatively, you can create a self-contained <code class="literal">shell.nix</code> without the need to modify any configuration files:
     </p><pre class="programlisting">
{ pkgs ? import &lt;nixpkgs&gt; {}
}:

pkgs.rstudioWrapper.override {
  packages = with pkgs.rPackages; [ dplyr ggplot2 reshape2 ];
}
</pre><p>
      Executing <code class="literal">nix-shell</code> will then drop you into an environment equivalent to the one above. If you need additional packages just add them to the list and re-enter the shell.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="updating-the-package-set"></a>15.23.3. Updating the package set</h3></div></div></div><pre class="programlisting">
nix-shell generate-shell.nix

Rscript generate-r-packages.R cran  &gt; cran-packages.nix.new
mv cran-packages.nix.new cran-packages.nix

Rscript generate-r-packages.R bioc  &gt; bioc-packages.nix.new
mv bioc-packages.nix.new bioc-packages.nix

Rscript generate-r-packages.R bioc-annotation &gt; bioc-annotation-packages.nix.new
mv bioc-annotation-packages.nix.new bioc-annotation-packages.nix

Rscript generate-r-packages.R bioc-experiment &gt; bioc-experiment-packages.nix.new
mv bioc-experiment-packages.nix.new bioc-experiment-packages.nix
</pre><p>
      <code class="literal">generate-r-packages.R &lt;repo&gt;</code> reads <code class="literal">&lt;repo&gt;-packages.nix</code>, therefor the renaming.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="testing-if-the-nix-expression-could-be-evaluated"></a>15.23.4. Testing if the Nix-expression could be evaluated</h3></div></div></div><pre class="programlisting">
nix-build test-evaluation.nix --dry-run
</pre><p>
      If this exits fine, the expression is ok. If not, you have to edit <code class="literal">default.nix</code>
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-language-ruby"></a>15.24. Ruby</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="using-ruby"></a>15.24.1. Using Ruby</h3></div></div></div><p>
      Several versions of Ruby interpreters are available on Nix, as well as over 250 gems and many applications written in Ruby. The attribute <code class="literal">ruby</code> refers to the default Ruby interpreter, which is currently MRI 2.6. It’s also possible to refer to specific versions, e.g. <code class="literal">ruby_2_y</code>, <code class="literal">jruby</code>, or <code class="literal">mruby</code>.
     </p><p>
      In the Nixpkgs tree, Ruby packages can be found throughout, depending on what they do, and are called from the main package set. Ruby gems, however are separate sets, and there’s one default set for each interpreter (currently MRI only).
     </p><p>
      There are two main approaches for using Ruby with gems. One is to use a specifically locked <code class="literal">Gemfile</code> for an application that has very strict dependencies. The other is to depend on the common gems, which we’ll explain further down, and rely on them being updated regularly.
     </p><p>
      The interpreters have common attributes, namely <code class="literal">gems</code>, and <code class="literal">withPackages</code>. So you can refer to <code class="literal">ruby.gems.nokogiri</code>, or <code class="literal">ruby_2_6.gems.nokogiri</code> to get the Nokogiri gem already compiled and ready to use.
     </p><p>
      Since not all gems have executables like <code class="literal">nokogiri</code>, it’s usually more convenient to use the <code class="literal">withPackages</code> function like this: <code class="literal">ruby.withPackages (p: with p; [ nokogiri ])</code>. This will also make sure that the Ruby in your environment will be able to find the gem and it can be used in your Ruby code (for example via <code class="literal">ruby</code> or <code class="literal">irb</code> executables) via <code class="literal">require "nokogiri"</code> as usual.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="temporary-ruby-environment-with-nix-shell"></a>15.24.1.1. Temporary Ruby environment with <code class="literal">nix-shell</code></h4></div></div></div><p>
       Rather than having a single Ruby environment shared by all Ruby development projects on a system, Nix allows you to create separate environments per project. <code class="literal">nix-shell</code> gives you the possibility to temporarily load another environment akin to a combined <code class="literal">chruby</code> or <code class="literal">rvm</code> and <code class="literal">bundle exec</code>.
      </p><p>
       There are two methods for loading a shell with Ruby packages. The first and recommended method is to create an environment with <code class="literal">ruby.withPackages</code> and load that.
      </p><pre class="programlisting">
$ nix-shell -p "ruby.withPackages (ps: with ps; [ nokogiri pry ])"
</pre><p>
       The other method, which is not recommended, is to create an environment and list all the packages directly.
      </p><pre class="programlisting">
$ nix-shell -p ruby.gems.nokogiri ruby.gems.pry
</pre><p>
       Again, it’s possible to launch the interpreter from the shell. The Ruby interpreter has the attribute <code class="literal">gems</code> which contains all Ruby gems for that specific interpreter.
      </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="load-ruby-environment-from-.nix-expression"></a>15.24.1.1.1. Load Ruby environment from <code class="literal">.nix</code> expression</h5></div></div></div><p>
        As explained in the Nix manual, <code class="literal">nix-shell</code> can also load an expression from a <code class="literal">.nix</code> file. Say we want to have Ruby 2.6, <code class="literal">nokogori</code>, and <code class="literal">pry</code>. Consider a <code class="literal">shell.nix</code> file with:
       </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};
ruby.withPackages (ps: with ps; [ nokogiri pry ])
</pre><p>
        What’s happening here?
       </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
          We begin with importing the Nix Packages collections. <code class="literal">import &lt;nixpkgs&gt;</code> imports the <code class="literal">&lt;nixpkgs&gt;</code> function, <code class="literal">{}</code> calls it and the <code class="literal">with</code> statement brings all attributes of <code class="literal">nixpkgs</code> in the local scope. These attributes form the main package set.
         </p></li><li class="listitem"><p>
          Then we create a Ruby environment with the <code class="literal">withPackages</code> function.
         </p></li><li class="listitem"><p>
          The <code class="literal">withPackages</code> function expects us to provide a function as an argument that takes the set of all ruby gems and returns a list of packages to include in the environment. Here, we select the packages <code class="literal">nokogiri</code> and <code class="literal">pry</code> from the package set.
         </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="execute-command-with---run"></a>15.24.1.1.2. Execute command with <code class="literal">--run</code></h5></div></div></div><p>
        A convenient flag for <code class="literal">nix-shell</code> is <code class="literal">--run</code>. It executes a command in the <code class="literal">nix-shell</code>. We can e.g. directly open a <code class="literal">pry</code> REPL:
       </p><pre class="programlisting">
$ nix-shell -p "ruby.withPackages (ps: with ps; [ nokogiri pry ])" --run "pry"
</pre><p>
        Or immediately require <code class="literal">nokogiri</code> in pry:
       </p><pre class="programlisting">
$ nix-shell -p "ruby.withPackages (ps: with ps; [ nokogiri pry ])" --run "pry -rnokogiri"
</pre><p>
        Or run a script using this environment:
       </p><pre class="programlisting">
$ nix-shell -p "ruby.withPackages (ps: with ps; [ nokogiri pry ])" --run "ruby example.rb"
</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="using-nix-shell-as-shebang"></a>15.24.1.1.3. Using <code class="literal">nix-shell</code> as shebang</h5></div></div></div><p>
        In fact, for the last case, there is a more convenient method. You can add a <a class="link" href="https://en.wikipedia.org/wiki/Shebang_(Unix)" target="_top">shebang</a> to your script specifying which dependencies <code class="literal">nix-shell</code> needs. With the following shebang, you can just execute <code class="literal">./example.rb</code>, and it will run with all dependencies.
       </p><pre class="programlisting">
#! /usr/bin/env nix-shell
#! nix-shell -i ruby -p "ruby.withPackages (ps: with ps; [ nokogiri rest-client ])"

require 'nokogiri'
require 'rest-client'

body = RestClient.get('http://example.com').body
puts Nokogiri::HTML(body).at('h1').text
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="developing-with-ruby"></a>15.24.2. Developing with Ruby</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="using-an-existing-gemfile"></a>15.24.2.1. Using an existing Gemfile</h4></div></div></div><p>
       In most cases, you’ll already have a <code class="literal">Gemfile.lock</code> listing all your dependencies. This can be used to generate a <code class="literal">gemset.nix</code> which is used to fetch the gems and combine them into a single environment. The reason why you need to have a separate file for this, is that Nix requires you to have a checksum for each input to your build. Since the <code class="literal">Gemfile.lock</code> that <code class="literal">bundler</code> generates doesn’t provide us with checksums, we have to first download each gem, calculate its SHA256, and store it in this separate file.
      </p><p>
       So the steps from having just a <code class="literal">Gemfile</code> to a <code class="literal">gemset.nix</code> are:
      </p><pre class="programlisting">
$ bundle lock
$ bundix
</pre><p>
       If you already have a <code class="literal">Gemfile.lock</code>, you can simply run <code class="literal">bundix</code> and it will work the same.
      </p><p>
       To update the gems in your <code class="literal">Gemfile.lock</code>, you may use the <code class="literal">bundix -l</code> flag, which will create a new <code class="literal">Gemfile.lock</code> in case the <code class="literal">Gemfile</code> has a more recent time of modification.
      </p><p>
       Once the <code class="literal">gemset.nix</code> is generated, it can be used in a <code class="literal">bundlerEnv</code> derivation. Here is an example you could use for your <code class="literal">shell.nix</code>:
      </p><pre class="programlisting">
# ...
let
  gems = bundlerEnv {
    name = "gems-for-some-project";
    gemdir = ./.;
  };
in mkShell { packages = [ gems gems.wrappedRuby ]; }
</pre><p>
       With this file in your directory, you can run <code class="literal">nix-shell</code> to build and use the gems. The important parts here are <code class="literal">bundlerEnv</code> and <code class="literal">wrappedRuby</code>.
      </p><p>
       The <code class="literal">bundlerEnv</code> is a wrapper over all the gems in your gemset. This means that all the <code class="literal">/lib</code> and <code class="literal">/bin</code> directories will be available, and the executables of all gems (even of indirect dependencies) will end up in your <code class="literal">$PATH</code>. The <code class="literal">wrappedRuby</code> provides you with all executables that come with Ruby itself, but wrapped so they can easily find the gems in your gemset.
      </p><p>
       One common issue that you might have is that you have Ruby 2.6, but also <code class="literal">bundler</code> in your gemset. That leads to a conflict for <code class="literal">/bin/bundle</code> and <code class="literal">/bin/bundler</code>. You can resolve this by wrapping either your Ruby or your gems in a <code class="literal">lowPrio</code> call. So in order to give the <code class="literal">bundler</code> from your gemset priority, it would be used like this:
      </p><pre class="programlisting">
# ...
mkShell { buildInputs = [ gems (lowPrio gems.wrappedRuby) ]; }
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="gem-specific-configurations-and-workarounds"></a>15.24.2.2. Gem-specific configurations and workarounds</h4></div></div></div><p>
       In some cases, especially if the gem has native extensions, you might need to modify the way the gem is built.
      </p><p>
       This is done via a common configuration file that includes all of the workarounds for each gem.
      </p><p>
       This file lives at <code class="literal">/pkgs/development/ruby-modules/gem-config/default.nix</code>, since it already contains a lot of entries, it should be pretty easy to add the modifications you need for your needs.
      </p><p>
       In the meanwhile, or if the modification is for a private gem, you can also add the configuration to only your own environment.
      </p><p>
       Two places that allow this modification are the <code class="literal">ruby</code> derivation, or <code class="literal">bundlerEnv</code>.
      </p><p>
       Here’s the <code class="literal">ruby</code> one:
      </p><pre class="programlisting">
{ pg_version ? "10", pkgs ? import &lt;nixpkgs&gt; { } }:
let
  myRuby = pkgs.ruby.override {
    defaultGemConfig = pkgs.defaultGemConfig // {
      pg = attrs: {
        buildFlags =
        [ "--with-pg-config=${pkgs."postgresql_${pg_version}"}/bin/pg_config" ];
      };
    };
  };
in myRuby.withPackages (ps: with ps; [ pg ])
</pre><p>
       And an example with <code class="literal">bundlerEnv</code>:
      </p><pre class="programlisting">
{ pg_version ? "10", pkgs ? import &lt;nixpkgs&gt; { } }:
let
  gems = pkgs.bundlerEnv {
    name = "gems-for-some-project";
    gemdir = ./.;
    gemConfig = pkgs.defaultGemConfig // {
      pg = attrs: {
        buildFlags =
        [ "--with-pg-config=${pkgs."postgresql_${pg_version}"}/bin/pg_config" ];
      };
    };
  };
in mkShell { buildInputs = [ gems gems.wrappedRuby ]; }
</pre><p>
       And finally via overlays:
      </p><pre class="programlisting">
{ pg_version ? "10" }:
let
  pkgs = import &lt;nixpkgs&gt; {
    overlays = [
      (self: super: {
        defaultGemConfig = super.defaultGemConfig // {
          pg = attrs: {
            buildFlags = [
              "--with-pg-config=${
                pkgs."postgresql_${pg_version}"
              }/bin/pg_config"
            ];
          };
        };
      })
    ];
  };
in pkgs.ruby.withPackages (ps: with ps; [ pg ])
</pre><p>
       Then we can get whichever postgresql version we desire and the <code class="literal">pg</code> gem will always reference it correctly:
      </p><pre class="programlisting">
$ nix-shell --argstr pg_version 9_4 --run 'ruby -rpg -e "puts PG.library_version"'
90421

$ nix-shell --run 'ruby -rpg -e "puts PG.library_version"'
100007
</pre><p>
       Of course for this use-case one could also use overlays since the configuration for <code class="literal">pg</code> depends on the <code class="literal">postgresql</code> alias, but for demonstration purposes this has to suffice.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="adding-a-gem-to-the-default-gemset"></a>15.24.2.3. Adding a gem to the default gemset</h4></div></div></div><p>
       Now that you know how to get a working Ruby environment with Nix, it’s time to go forward and start actually developing with Ruby. We will first have a look at how Ruby gems are packaged on Nix. Then, we will look at how you can use development mode with your code.
      </p><p>
       All gems in the standard set are automatically generated from a single <code class="literal">Gemfile</code>. The dependency resolution is done with <code class="literal">bundler</code> and makes it more likely that all gems are compatible to each other.
      </p><p>
       In order to add a new gem to nixpkgs, you can put it into the <code class="literal">/pkgs/development/ruby-modules/with-packages/Gemfile</code> and run <code class="literal">./maintainers/scripts/update-ruby-packages</code>.
      </p><p>
       To test that it works, you can then try using the gem with:
      </p><pre class="programlisting">
NIX_PATH=nixpkgs=$PWD nix-shell -p "ruby.withPackages (ps: with ps; [ name-of-your-gem ])"
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="packaging-applications"></a>15.24.2.4. Packaging applications</h4></div></div></div><p>
       A common task is to add a ruby executable to nixpkgs, popular examples would be <code class="literal">chef</code>, <code class="literal">jekyll</code>, or <code class="literal">sass</code>. A good way to do that is to use the <code class="literal">bundlerApp</code> function, that allows you to make a package that only exposes the listed executables, otherwise the package may cause conflicts through common paths like <code class="literal">bin/rake</code> or <code class="literal">bin/bundler</code> that aren’t meant to be used.
      </p><p>
       The absolute easiest way to do that is to write a <code class="literal">Gemfile</code> along these lines:
      </p><pre class="programlisting">
source 'https://rubygems.org' do
  gem 'mdl'
end
</pre><p>
       If you want to package a specific version, you can use the standard Gemfile syntax for that, e.g. <code class="literal">gem 'mdl', '0.5.0'</code>, but if you want the latest stable version anyway, it’s easier to update by simply running the <code class="literal">bundle lock</code> and <code class="literal">bundix</code> steps again.
      </p><p>
       Now you can also make a <code class="literal">default.nix</code> that looks like this:
      </p><pre class="programlisting">
{ bundlerApp }:

bundlerApp {
  pname = "mdl";
  gemdir = ./.;
  exes = [ "mdl" ];
}
</pre><p>
       All that’s left to do is to generate the corresponding <code class="literal">Gemfile.lock</code> and <code class="literal">gemset.nix</code> as described above in the <code class="literal">Using an existing Gemfile</code> section.
      </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="packaging-executables-that-require-wrapping"></a>15.24.2.4.1. Packaging executables that require wrapping</h5></div></div></div><p>
        Sometimes your app will depend on other executables at runtime, and tries to find it through the <code class="literal">PATH</code> environment variable.
       </p><p>
        In this case, you can provide a <code class="literal">postBuild</code> hook to <code class="literal">bundlerApp</code> that wraps the gem in another script that prefixes the <code class="literal">PATH</code>.
       </p><p>
        Of course you could also make a custom <code class="literal">gemConfig</code> if you know exactly how to patch it, but it’s usually much easier to maintain with a simple wrapper so the patch doesn’t have to be adjusted for each version.
       </p><p>
        Here’s another example:
       </p><pre class="programlisting">
{ lib, bundlerApp, makeWrapper, git, gnutar, gzip }:

bundlerApp {
  pname = "r10k";
  gemdir = ./.;
  exes = [ "r10k" ];

  buildInputs = [ makeWrapper ];

  postBuild = ''
    wrapProgram $out/bin/r10k --prefix PATH : ${lib.makeBinPath [ git gnutar gzip ]}
  '';
}
</pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="rust"></a>15.25. Rust</h2></div></div></div><p>
     To install the rust compiler and cargo put
    </p><pre class="programlisting">
environment.systemPackages = [
  rustc
  cargo
];
</pre><p>
     into your <code class="literal">configuration.nix</code> or bring them into scope with <code class="literal">nix-shell -p rustc cargo</code>.
    </p><p>
     For other versions such as daily builds (beta and nightly), use either <code class="literal">rustup</code> from nixpkgs (which will manage the rust installation in your home directory), or use Mozilla’s <a class="link" href="#using-the-rust-nightlies-overlay" title="15.25.5. Using the Rust nightlies overlay">Rust nightlies overlay</a>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="compiling-rust-applications-with-cargo"></a>15.25.1. Compiling Rust applications with Cargo</h3></div></div></div><p>
      Rust applications are packaged by using the <code class="literal">buildRustPackage</code> helper from <code class="literal">rustPlatform</code>:
     </p><pre class="programlisting">
{ lib, rustPlatform }:

rustPlatform.buildRustPackage rec {
  pname = "ripgrep";
  version = "12.1.1";

  src = fetchFromGitHub {
    owner = "BurntSushi";
    repo = pname;
    rev = version;
    sha256 = "1hqps7l5qrjh9f914r5i6kmcz6f1yb951nv4lby0cjnp5l253kps";
  };

  cargoSha256 = "03wf9r2csi6jpa7v5sw5lpxkrk4wfzwmzx7k3991q3bdjzcwnnwp";

  meta = with lib; {
    description = "A fast line-oriented regex search tool, similar to ag and ack";
    homepage = "https://github.com/BurntSushi/ripgrep";
    license = licenses.unlicense;
    maintainers = [ maintainers.tailhook ];
  };
}
</pre><p>
      <code class="literal">buildRustPackage</code> requires either the <code class="literal">cargoSha256</code> or the <code class="literal">cargoHash</code> attribute which is computed over all crate sources of this package. <code class="literal">cargoHash256</code> is used for traditional Nix SHA-256 hashes, such as the one in the example above. <code class="literal">cargoHash</code> should instead be used for <a class="link" href="https://www.w3.org/TR/SRI/" target="_top">SRI</a> hashes. For example:
     </p><pre class="programlisting">
  cargoHash = "sha256-l1vL2ZdtDRxSGvP0X/l3nMw8+6WF67KPutJEzUROjg8=";
</pre><p>
      Both types of hashes are permitted when contributing to nixpkgs. The Cargo hash is obtained by inserting a fake checksum into the expression and building the package once. The correct checksum can then be taken from the failed build. A fake hash can be used for <code class="literal">cargoSha256</code> as follows:
     </p><pre class="programlisting">
  cargoSha256 = lib.fakeSha256;
</pre><p>
      For <code class="literal">cargoHash</code> you can use:
     </p><pre class="programlisting">
  cargoHash = lib.fakeHash;
</pre><p>
      Per the instructions in the <a class="link" href="https://doc.rust-lang.org/cargo/guide/cargo-toml-vs-cargo-lock.html" target="_top">Cargo Book</a> best practices guide, Rust applications should always commit the <code class="literal">Cargo.lock</code> file in git to ensure a reproducible build. However, a few packages do not, and Nix depends on this file, so if it is missing you can use <code class="literal">cargoPatches</code> to apply it in the <code class="literal">patchPhase</code>. Consider sending a PR upstream with a note to the maintainer describing why it’s important to include in the application.
     </p><p>
      The fetcher will verify that the <code class="literal">Cargo.lock</code> file is in sync with the <code class="literal">src</code> attribute, and fail the build if not. It will also will compress the vendor directory into a tar.gz archive.
     </p><p>
      The tarball with vendored dependencies contains a directory with the package’s <code class="literal">name</code>, which is normally composed of <code class="literal">pname</code> and <code class="literal">version</code>. This means that the vendored dependencies hash (<code class="literal">cargoSha256</code>/<code class="literal">cargoHash</code>) is dependent on the package name and version. The <code class="literal">cargoDepsName</code> attribute can be used to use another name for the directory of vendored dependencies. For example, the hash can be made invariant to the version by setting <code class="literal">cargoDepsName</code> to <code class="literal">pname</code>:
     </p><pre class="programlisting">
rustPlatform.buildRustPackage rec {
  pname = "broot";
  version = "1.2.0";

  src = fetchCrate {
    inherit pname version;
    sha256 = "1mqaynrqaas82f5957lx31x80v74zwmwmjxxlbywajb61vh00d38";
  };

  cargoHash = "sha256-JmBZcDVYJaK1cK05cxx5BrnGWp4t8ca6FLUbvIot67s=";
  cargoDepsName = pname;

  # ...
}
</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="cross-compilation"></a>15.25.1.1. Cross compilation</h4></div></div></div><p>
       By default, Rust packages are compiled for the host platform, just like any other package is. The <code class="literal">--target</code> passed to rust tools is computed from this. By default, it takes the <code class="literal">stdenv.hostPlatform.config</code> and replaces components where they are known to differ. But there are ways to customize the argument:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
         To choose a different target by name, define <code class="literal">stdenv.hostPlatform.rustc.config</code> as that name (a string), and that name will be used instead.
        </p><p>
         For example:
        </p><pre class="programlisting">
import &lt;nixpkgs&gt; {
  crossSystem = (import &lt;nixpkgs/lib&gt;).systems.examples.armhf-embedded // {
    rustc.config = "thumbv7em-none-eabi";
  };
}
</pre><p>
         will result in:
        </p><pre class="programlisting">
--target thumbv7em-none-eabi
</pre></li><li class="listitem"><p>
         To pass a completely custom target, define <code class="literal">stdenv.hostPlatform.rustc.config</code> with its name, and <code class="literal">stdenv.hostPlatform.rustc.platform</code> with the value. The value will be serialized to JSON in a file called <code class="literal">${stdenv.hostPlatform.rustc.config}.json</code>, and the path of that file will be used instead.
        </p><p>
         For example:
        </p><pre class="programlisting">
import &lt;nixpkgs&gt; {
  crossSystem = (import &lt;nixpkgs/lib&gt;).systems.examples.armhf-embedded // {
    rustc.config = "thumb-crazy";
    rustc.platform = { foo = ""; bar = ""; };
  };
}
</pre><p>
         will result in:
        </p><pre class="programlisting">
--target /nix/store/asdfasdfsadf-thumb-crazy.json # contains {"foo":"","bar":""}
</pre></li></ul></div><p>
       Finally, as an ad-hoc escape hatch, a computed target (string or JSON file path) can be passed directly to <code class="literal">buildRustPackage</code>:
      </p><pre class="programlisting">
pkgs.rustPlatform.buildRustPackage {
  /* ... */
  target = "x86_64-fortanix-unknown-sgx";
}
</pre><p>
       This is useful to avoid rebuilding Rust tools, since they are actually target agnostic and don’t need to be rebuilt. But in the future, we should always build the Rust tools and standard library crates separately so there is no reason not to take the <code class="literal">stdenv.hostPlatform.rustc</code>-modifying approach, and the ad-hoc escape hatch to <code class="literal">buildRustPackage</code> can be removed.
      </p><p>
       Note that currently custom targets aren’t compiled with <code class="literal">std</code>, so <code class="literal">cargo test</code> will fail. This can be ignored by adding <code class="literal">doCheck = false;</code> to your derivation.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="running-package-tests"></a>15.25.1.2. Running package tests</h4></div></div></div><p>
       When using <code class="literal">buildRustPackage</code>, the <code class="literal">checkPhase</code> is enabled by default and runs <code class="literal">cargo test</code> on the package to build. To make sure that we don’t compile the sources twice and to actually test the artifacts that will be used at runtime, the tests will be ran in the <code class="literal">release</code> mode by default.
      </p><p>
       However, in some cases the test-suite of a package doesn’t work properly in the <code class="literal">release</code> mode. For these situations, the mode for <code class="literal">checkPhase</code> can be changed like so:
      </p><pre class="programlisting">
rustPlatform.buildRustPackage {
  /* ... */
  checkType = "debug";
}
</pre><p>
       Please note that the code will be compiled twice here: once in <code class="literal">release</code> mode for the <code class="literal">buildPhase</code>, and again in <code class="literal">debug</code> mode for the <code class="literal">checkPhase</code>.
      </p><p>
       Test flags, e.g., <code class="literal">--features xxx/yyy</code>, can be passed to <code class="literal">cargo test</code> via the <code class="literal">cargoTestFlags</code> attribute.
      </p><p>
       Another attribute, called <code class="literal">checkFlags</code>, is used to pass arguments to the test binary itself, as stated (here)[https://doc.rust-lang.org/cargo/commands/cargo-test.html].
      </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="tests-relying-on-the-structure-of-the-target-directory"></a>15.25.1.2.1. Tests relying on the structure of the <code class="literal">target/</code> directory</h5></div></div></div><p>
        Some tests may rely on the structure of the <code class="literal">target/</code> directory. Those tests are likely to fail because we use <code class="literal">cargo --target</code> during the build. This means that the artifacts <a class="link" href="https://doc.rust-lang.org/cargo/guide/build-cache.html" target="_top">are stored in <code class="literal">target/&lt;architecture&gt;/release/</code></a>, rather than in <code class="literal">target/release/</code>.
       </p><p>
        This can only be worked around by patching the affected tests accordingly.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="disabling-package-tests"></a>15.25.1.2.2. Disabling package-tests</h5></div></div></div><p>
        In some instances, it may be necessary to disable testing altogether (with <code class="literal">doCheck = false;</code>):
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
          If no tests exist – the <code class="literal">checkPhase</code> should be explicitly disabled to skip unnecessary build steps to speed up the build.
         </p></li><li class="listitem"><p>
          If tests are highly impure (e.g. due to network usage).
         </p></li></ul></div><p>
        There will obviously be some corner-cases not listed above where it’s sensible to disable tests. The above are just guidelines, and exceptions may be granted on a case-by-case basis.
       </p><p>
        However, please check if it’s possible to disable a problematic subset of the test suite and leave a comment explaining your reasoning.
       </p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="setting-test-threads"></a>15.25.1.2.3. Setting <code class="literal">test-threads</code></h5></div></div></div><p>
        <code class="literal">buildRustPackage</code> will use parallel test threads by default, sometimes it may be necessary to disable this so the tests run consecutively.
       </p><pre class="programlisting">
rustPlatform.buildRustPackage {
  /* ... */
  dontUseCargoParallelTests = true;
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="building-a-package-in-debug-mode"></a>15.25.1.3. Building a package in <code class="literal">debug</code> mode</h4></div></div></div><p>
       By default, <code class="literal">buildRustPackage</code> will use <code class="literal">release</code> mode for builds. If a package should be built in <code class="literal">debug</code> mode, it can be configured like so:
      </p><pre class="programlisting">
rustPlatform.buildRustPackage {
  /* ... */
  buildType = "debug";
}
</pre><p>
       In this scenario, the <code class="literal">checkPhase</code> will be ran in <code class="literal">debug</code> mode as well.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="custom-buildinstall-procedures"></a>15.25.1.4. Custom <code class="literal">build</code>/<code class="literal">install</code>-procedures</h4></div></div></div><p>
       Some packages may use custom scripts for building/installing, e.g. with a <code class="literal">Makefile</code>. In these cases, it’s recommended to override the <code class="literal">buildPhase</code>/<code class="literal">installPhase</code>/<code class="literal">checkPhase</code>.
      </p><p>
       Otherwise, some steps may fail because of the modified directory structure of <code class="literal">target/</code>.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="building-a-crate-with-an-absent-or-out-of-date-cargo.lock-file"></a>15.25.1.5. Building a crate with an absent or out-of-date Cargo.lock file</h4></div></div></div><p>
       <code class="literal">buildRustPackage</code> needs a <code class="literal">Cargo.lock</code> file to get all dependencies in the source code in a reproducible way. If it is missing or out-of-date one can use the <code class="literal">cargoPatches</code> attribute to update or add it.
      </p><pre class="programlisting">
rustPlatform.buildRustPackage rec {
  (...)
  cargoPatches = [
    # a patch file to add/update Cargo.lock in the source code
    ./add-Cargo.lock.patch
  ];
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="compiling-non-rust-packages-that-include-rust-code"></a>15.25.2. Compiling non-Rust packages that include Rust code</h3></div></div></div><p>
      Several non-Rust packages incorporate Rust code for performance- or security-sensitive parts. <code class="literal">rustPlatform</code> exposes several functions and hooks that can be used to integrate Cargo in non-Rust packages.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="vendoring-of-dependencies"></a>15.25.2.1. Vendoring of dependencies</h4></div></div></div><p>
       Since network access is not allowed in sandboxed builds, Rust crate dependencies need to be retrieved using a fetcher. <code class="literal">rustPlatform</code> provides the <code class="literal">fetchCargoTarball</code> fetcher, which vendors all dependencies of a crate. For example, given a source path <code class="literal">src</code> containing <code class="literal">Cargo.toml</code> and <code class="literal">Cargo.lock</code>, <code class="literal">fetchCargoTarball</code> can be used as follows:
      </p><pre class="programlisting">
cargoDeps = rustPlatform.fetchCargoTarball {
  inherit src;
  hash = "sha256-BoHIN/519Top1NUBjpB/oEMqi86Omt3zTQcXFWqrek0=";
};
</pre><p>
       The <code class="literal">src</code> attribute is required, as well as a hash specified through one of the <code class="literal">sha256</code> or <code class="literal">hash</code> attributes. The following optional attributes can also be used:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         <code class="literal">name</code>: the name that is used for the dependencies tarball. If <code class="literal">name</code> is not specified, then the name <code class="literal">cargo-deps</code> will be used.
        </p></li><li class="listitem"><p>
         <code class="literal">sourceRoot</code>: when the <code class="literal">Cargo.lock</code>/<code class="literal">Cargo.toml</code> are in a subdirectory, <code class="literal">sourceRoot</code> specifies the relative path to these files.
        </p></li><li class="listitem"><p>
         <code class="literal">patches</code>: patches to apply before vendoring. This is useful when the <code class="literal">Cargo.lock</code>/<code class="literal">Cargo.toml</code> files need to be patched before vendoring.
        </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="hooks"></a>15.25.2.2. Hooks</h4></div></div></div><p>
       <code class="literal">rustPlatform</code> provides the following hooks to automate Cargo builds:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         <code class="literal">cargoSetupHook</code>: configure Cargo to use depenencies vendored through <code class="literal">fetchCargoTarball</code>. This hook uses the <code class="literal">cargoDeps</code> environment variable to find the vendored dependencies. If a project already vendors its dependencies, the variable <code class="literal">cargoVendorDir</code> can be used instead. When the <code class="literal">Cargo.toml</code>/<code class="literal">Cargo.lock</code> files are not in <code class="literal">sourceRoot</code>, then the optional <code class="literal">cargoRoot</code> is used to specify the Cargo root directory relative to <code class="literal">sourceRoot</code>.
        </p></li><li class="listitem"><p>
         <code class="literal">cargoBuildHook</code>: use Cargo to build a crate. If the crate to be built is a crate in e.g. a Cargo workspace, the relative path to the crate to build can be set through the optional <code class="literal">buildAndTestSubdir</code> environment variable. Additional Cargo build flags can be passed through <code class="literal">cargoBuildFlags</code>.
        </p></li><li class="listitem"><p>
         <code class="literal">maturinBuildHook</code>: use <a class="link" href="https://github.com/PyO3/maturin" target="_top">Maturin</a> to build a Python wheel. Similar to <code class="literal">cargoBuildHook</code>, the optional variable <code class="literal">buildAndTestSubdir</code> can be used to build a crate in a Cargo workspace. Additional maturin flags can be passed through <code class="literal">maturinBuildFlags</code>.
        </p></li><li class="listitem"><p>
         <code class="literal">cargoCheckHook</code>: run tests using Cargo. The build type for checks can be set using <code class="literal">cargoCheckType</code>. Additional flags can be passed to the tests using <code class="literal">checkFlags</code> and <code class="literal">checkFlagsArray</code>. By default, tests are run in parallel. This can be disabled by setting <code class="literal">dontUseCargoParallelTests</code>.
        </p></li><li class="listitem"><p>
         <code class="literal">cargoInstallHook</code>: install binaries and static/shared libraries that were built using <code class="literal">cargoBuildHook</code>.
        </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="examples"></a>15.25.2.3. Examples</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="python-package-using-setuptools-rust"></a>15.25.2.3.1. Python package using <code class="literal">setuptools-rust</code></h5></div></div></div><p>
        For Python packages using <code class="literal">setuptools-rust</code>, you can use <code class="literal">fetchCargoTarball</code> and <code class="literal">cargoSetupHook</code> to retrieve and set up Cargo dependencies. The build itself is then performed by <code class="literal">buildPythonPackage</code>.
       </p><p>
        The following example outlines how the <code class="literal">tokenizers</code> Python package is built. Since the Python package is in the <code class="literal">source/bindings/python</code> directory of the <span class="emphasis"><em>tokenizers</em></span> project’s source archive, we use <code class="literal">sourceRoot</code> to point the tooling to this directory:
       </p><pre class="programlisting">
{ fetchFromGitHub
, buildPythonPackage
, rustPlatform
, setuptools-rust
}:

buildPythonPackage rec {
  pname = "tokenizers";
  version = "0.10.0";

  src = fetchFromGitHub {
    owner = "huggingface";
    repo = pname;
    rev = "python-v${version}";
    hash = "sha256-rQ2hRV52naEf6PvRsWVCTN7B1oXAQGmnpJw4iIdhamw=";
  };

  cargoDeps = rustPlatform.fetchCargoTarball {
    inherit src sourceRoot;
    name = "${pname}-${version}";
    hash = "sha256-BoHIN/519Top1NUBjpB/oEMqi86Omt3zTQcXFWqrek0=";
  };

  sourceRoot = "source/bindings/python";

  nativeBuildInputs = [ setuptools-rust ] ++ (with rustPlatform; [
    cargoSetupHook
    rust.cargo
    rust.rustc
  ]);

  # ...
}
</pre><p>
        In some projects, the Rust crate is not in the main Python source directory. In such cases, the <code class="literal">cargoRoot</code> attribute can be used to specify the crate’s directory relative to <code class="literal">sourceRoot</code>. In the following example, the crate is in <code class="literal">src/rust</code>, as specified in the <code class="literal">cargoRoot</code> attribute. Note that we also need to specify the correct path for <code class="literal">fetchCargoTarball</code>.
       </p><pre class="programlisting">

{ buildPythonPackage
, fetchPypi
, rustPlatform
, setuptools-rust
, openssl
}:

buildPythonPackage rec {
  pname = "cryptography";
  version = "3.4.2"; # Also update the hash in vectors.nix

  src = fetchPypi {
    inherit pname version;
    sha256 = "1i1mx5y9hkyfi9jrrkcw804hmkcglxi6rmf7vin7jfnbr2bf4q64";
  };

  cargoDeps = rustPlatform.fetchCargoTarball {
    inherit src;
    sourceRoot = "${pname}-${version}/${cargoRoot}";
    name = "${pname}-${version}";
    hash = "sha256-PS562W4L1NimqDV2H0jl5vYhL08H9est/pbIxSdYVfo=";
  };

  cargoRoot = "src/rust";

  # ...
}
</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="python-package-using-maturin"></a>15.25.2.3.2. Python package using <code class="literal">maturin</code></h5></div></div></div><p>
        Python packages that use <a class="link" href="https://github.com/PyO3/maturin" target="_top">Maturin</a> can be built with <code class="literal">fetchCargoTarball</code>, <code class="literal">cargoSetupHook</code>, and <code class="literal">maturinBuildHook</code>. For example, the following (partial) derivation builds the <code class="literal">retworkx</code> Python package. <code class="literal">fetchCargoTarball</code> and <code class="literal">cargoSetupHook</code> are used to fetch and set up the crate dependencies. <code class="literal">maturinBuildHook</code> is used to perform the build.
       </p><pre class="programlisting">
{ lib
, buildPythonPackage
, rustPlatform
, fetchFromGitHub
}:

buildPythonPackage rec {
  pname = "retworkx";
  version = "0.6.0";

  src = fetchFromGitHub {
    owner = "Qiskit";
    repo = "retworkx";
    rev = version;
    sha256 = "11n30ldg3y3y6qxg3hbj837pnbwjkqw3nxq6frds647mmmprrd20";
  };

  cargoDeps = rustPlatform.fetchCargoTarball {
    inherit src;
    name = "${pname}-${version}";
    hash = "sha256-heOBK8qi2nuc/Ib+I/vLzZ1fUUD/G/KTw9d7M4Hz5O0=";
  };

  format = "pyproject";

  nativeBuildInputs = with rustPlatform; [ cargoSetupHook maturinBuildHook ];

  # ...
}
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="compiling-rust-crates-using-nix-instead-of-cargo"></a>15.25.3. Compiling Rust crates using Nix instead of Cargo</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="simple-operation"></a>15.25.3.1. Simple operation</h4></div></div></div><p>
       When run, <code class="literal">cargo build</code> produces a file called <code class="literal">Cargo.lock</code>, containing pinned versions of all dependencies. Nixpkgs contains a tool called <code class="literal">carnix</code> (<code class="literal">nix-env -iA nixos.carnix</code>), which can be used to turn a <code class="literal">Cargo.lock</code> into a Nix expression.
      </p><p>
       That Nix expression calls <code class="literal">rustc</code> directly (hence bypassing Cargo), and can be used to compile a crate and all its dependencies. Here is an example for a minimal <code class="literal">hello</code> crate:
      </p><pre class="programlisting">
$ cargo new hello
$ cd hello
$ cargo build
 Compiling hello v0.1.0 (file:///tmp/hello)
  Finished dev [unoptimized + debuginfo] target(s) in 0.20 secs
$ carnix -o hello.nix --src ./. Cargo.lock --standalone
$ nix-build hello.nix -A hello_0_1_0
</pre><p>
       Now, the file produced by the call to <code class="literal">carnix</code>, called <code class="literal">hello.nix</code>, looks like:
      </p><pre class="programlisting">
# Generated by carnix 0.6.5: carnix -o hello.nix --src ./. Cargo.lock --standalone
{ stdenv, buildRustCrate, fetchgit }:
let kernel = stdenv.buildPlatform.parsed.kernel.name;
    # ... (content skipped)
in
rec {
  hello = f: hello_0_1_0 { features = hello_0_1_0_features { hello_0_1_0 = f; }; };
  hello_0_1_0_ = { dependencies?[], buildDependencies?[], features?[] }: buildRustCrate {
    crateName = "hello";
    version = "0.1.0";
    authors = [ "pe@pijul.org &lt;pe@pijul.org&gt;" ];
    src = ./.;
    inherit dependencies buildDependencies features;
  };
  hello_0_1_0 = { features?(hello_0_1_0_features {}) }: hello_0_1_0_ {};
  hello_0_1_0_features = f: updateFeatures f (rec {
        hello_0_1_0.default = (f.hello_0_1_0.default or true);
    }) [ ];
}
</pre><p>
       In particular, note that the argument given as <code class="literal">--src</code> is copied verbatim to the source. If we look at a more complicated dependencies, for instance by adding a single line <code class="literal">libc="*"</code> to our <code class="literal">Cargo.toml</code>, we first need to run <code class="literal">cargo build</code> to update the <code class="literal">Cargo.lock</code>. Then, <code class="literal">carnix</code> needs to be run again, and produces the following nix file:
      </p><pre class="programlisting">
# Generated by carnix 0.6.5: carnix -o hello.nix --src ./. Cargo.lock --standalone
{ stdenv, buildRustCrate, fetchgit }:
let kernel = stdenv.buildPlatform.parsed.kernel.name;
    # ... (content skipped)
in
rec {
  hello = f: hello_0_1_0 { features = hello_0_1_0_features { hello_0_1_0 = f; }; };
  hello_0_1_0_ = { dependencies?[], buildDependencies?[], features?[] }: buildRustCrate {
    crateName = "hello";
    version = "0.1.0";
    authors = [ "pe@pijul.org &lt;pe@pijul.org&gt;" ];
    src = ./.;
    inherit dependencies buildDependencies features;
  };
  libc_0_2_36_ = { dependencies?[], buildDependencies?[], features?[] }: buildRustCrate {
    crateName = "libc";
    version = "0.2.36";
    authors = [ "The Rust Project Developers" ];
    sha256 = "01633h4yfqm0s302fm0dlba469bx8y6cs4nqc8bqrmjqxfxn515l";
    inherit dependencies buildDependencies features;
  };
  hello_0_1_0 = { features?(hello_0_1_0_features {}) }: hello_0_1_0_ {
    dependencies = mapFeatures features ([ libc_0_2_36 ]);
  };
  hello_0_1_0_features = f: updateFeatures f (rec {
    hello_0_1_0.default = (f.hello_0_1_0.default or true);
    libc_0_2_36.default = true;
  }) [ libc_0_2_36_features ];
  libc_0_2_36 = { features?(libc_0_2_36_features {}) }: libc_0_2_36_ {
    features = mkFeatures (features.libc_0_2_36 or {});
  };
  libc_0_2_36_features = f: updateFeatures f (rec {
    libc_0_2_36.default = (f.libc_0_2_36.default or true);
    libc_0_2_36.use_std =
      (f.libc_0_2_36.use_std or false) ||
      (f.libc_0_2_36.default or false) ||
      (libc_0_2_36.default or false);
  }) [];
}
</pre><p>
       Here, the <code class="literal">libc</code> crate has no <code class="literal">src</code> attribute, so <code class="literal">buildRustCrate</code> will fetch it from <a class="link" href="https://crates.io" target="_top">crates.io</a>. A <code class="literal">sha256</code> attribute is still needed for Nix purity.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="handling-external-dependencies"></a>15.25.3.2. Handling external dependencies</h4></div></div></div><p>
       Some crates require external libraries. For crates from <a class="link" href="https://crates.io" target="_top">crates.io</a>, such libraries can be specified in <code class="literal">defaultCrateOverrides</code> package in nixpkgs itself.
      </p><p>
       Starting from that file, one can add more overrides, to add features or build inputs by overriding the hello crate in a seperate file.
      </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};
((import ./hello.nix).hello {}).override {
  crateOverrides = defaultCrateOverrides // {
    hello = attrs: { buildInputs = [ openssl ]; };
  };
}
</pre><p>
       Here, <code class="literal">crateOverrides</code> is expected to be a attribute set, where the key is the crate name without version number and the value a function. The function gets all attributes passed to <code class="literal">buildRustCrate</code> as first argument and returns a set that contains all attribute that should be overwritten.
      </p><p>
       For more complicated cases, such as when parts of the crate’s derivation depend on the crate’s version, the <code class="literal">attrs</code> argument of the override above can be read, as in the following example, which patches the derivation:
      </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};
((import ./hello.nix).hello {}).override {
  crateOverrides = defaultCrateOverrides // {
    hello = attrs: lib.optionalAttrs (lib.versionAtLeast attrs.version "1.0")  {
      postPatch = ''
        substituteInPlace lib/zoneinfo.rs \
          --replace "/usr/share/zoneinfo" "${tzdata}/share/zoneinfo"
      '';
    };
  };
}
</pre><p>
       Another situation is when we want to override a nested dependency. This actually works in the exact same way, since the <code class="literal">crateOverrides</code> parameter is forwarded to the crate’s dependencies. For instance, to override the build inputs for crate <code class="literal">libc</code> in the example above, where <code class="literal">libc</code> is a dependency of the main crate, we could do:
      </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};
((import hello.nix).hello {}).override {
  crateOverrides = defaultCrateOverrides // {
    libc = attrs: { buildInputs = []; };
  };
}
</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="options-and-phases-configuration"></a>15.25.3.3. Options and phases configuration</h4></div></div></div><p>
       Actually, the overrides introduced in the previous section are more general. A number of other parameters can be overridden:
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
         The version of rustc used to compile the crate:
        </p><pre class="programlisting">
(hello {}).override { rust = pkgs.rust; };
</pre></li><li class="listitem"><p>
         Whether to build in release mode or debug mode (release mode by default):
        </p><pre class="programlisting">
(hello {}).override { release = false; };
</pre></li><li class="listitem"><p>
         Whether to print the commands sent to rustc when building (equivalent to <code class="literal">--verbose</code> in cargo:
        </p><pre class="programlisting">
(hello {}).override { verbose = false; };
</pre></li><li class="listitem"><p>
         Extra arguments to be passed to <code class="literal">rustc</code>:
        </p><pre class="programlisting">
(hello {}).override { extraRustcOpts = "-Z debuginfo=2"; };
</pre></li><li class="listitem"><p>
         Phases, just like in any other derivation, can be specified using the following attributes: <code class="literal">preUnpack</code>, <code class="literal">postUnpack</code>, <code class="literal">prePatch</code>, <code class="literal">patches</code>, <code class="literal">postPatch</code>, <code class="literal">preConfigure</code> (in the case of a Rust crate, this is run before calling the <span class="quote">“<span class="quote">build</span>”</span> script), <code class="literal">postConfigure</code> (after the <span class="quote">“<span class="quote">build</span>”</span> script),<code class="literal">preBuild</code>, <code class="literal">postBuild</code>, <code class="literal">preInstall</code> and <code class="literal">postInstall</code>. As an example, here is how to create a new module before running the build script:
        </p><pre class="programlisting">
(hello {}).override {
  preConfigure = ''
     echo "pub const PATH=\"${hi.out}\";" &gt;&gt; src/path.rs"
  '';
};
</pre></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="features"></a>15.25.3.4. Features</h4></div></div></div><p>
       One can also supply features switches. For example, if we want to compile <code class="literal">diesel_cli</code> only with the <code class="literal">postgres</code> feature, and no default features, we would write:
      </p><pre class="programlisting">
(callPackage ./diesel.nix {}).diesel {
  default = false;
  postgres = true;
}
</pre><p>
       Where <code class="literal">diesel.nix</code> is the file generated by Carnix, as explained above.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="setting-up-nix-shell"></a>15.25.4. Setting Up <code class="literal">nix-shell</code></h3></div></div></div><p>
      Oftentimes you want to develop code from within <code class="literal">nix-shell</code>. Unfortunately <code class="literal">buildRustCrate</code> does not support common <code class="literal">nix-shell</code> operations directly (see <a class="link" href="https://github.com/NixOS/nixpkgs/issues/37945" target="_top">this issue</a>) so we will use <code class="literal">stdenv.mkDerivation</code> instead.
     </p><p>
      Using the example <code class="literal">hello</code> project above, we want to do the following: - Have access to <code class="literal">cargo</code> and <code class="literal">rustc</code> - Have the <code class="literal">openssl</code> library available to a crate through it’s <span class="emphasis"><em>normal</em></span> compilation mechanism (<code class="literal">pkg-config</code>).
     </p><p>
      A typical <code class="literal">shell.nix</code> might look like:
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

stdenv.mkDerivation {
  name = "rust-env";
  nativeBuildInputs = [
    rustc cargo

    # Example Build-time Additional Dependencies
    pkg-config
  ];
  buildInputs = [
    # Example Run-time Additional Dependencies
    openssl
  ];

  # Set Environment Variables
  RUST_BACKTRACE = 1;
}
</pre><p>
      You should now be able to run the following:
     </p><pre class="programlisting">
$ nix-shell --pure
$ cargo build
$ cargo test
</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="controlling-rust-version-inside-nix-shell"></a>15.25.4.1. Controlling Rust Version Inside <code class="literal">nix-shell</code></h4></div></div></div><p>
       To control your rust version (i.e. use nightly) from within <code class="literal">shell.nix</code> (or other nix expressions) you can use the following <code class="literal">shell.nix</code>
      </p><pre class="programlisting">
# Latest Nightly
with import &lt;nixpkgs&gt; {};
let src = fetchFromGitHub {
      owner = "mozilla";
      repo = "nixpkgs-mozilla";
      # commit from: 2019-05-15
      rev = "9f35c4b09fd44a77227e79ff0c1b4b6a69dff533";
      sha256 = "18h0nvh55b5an4gmlgfbvwbyqj91bklf1zymis6lbdh75571qaz0";
   };
in
with import "${src.out}/rust-overlay.nix" pkgs pkgs;
stdenv.mkDerivation {
  name = "rust-env";
  buildInputs = [
    # Note: to use stable, just replace `nightly` with `stable`
    latest.rustChannels.nightly.rust

    # Add some extra dependencies from `pkgs`
    pkg-config openssl
  ];

  # Set Environment Variables
  RUST_BACKTRACE = 1;
}
</pre><p>
       Now run:
      </p><pre class="programlisting">
$ rustc --version
rustc 1.26.0-nightly (188e693b3 2018-03-26)
</pre><p>
       To see that you are using nightly.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="using-the-rust-nightlies-overlay"></a>15.25.5. Using the Rust nightlies overlay</h3></div></div></div><p>
      Mozilla provides an overlay for nixpkgs to bring a nightly version of Rust into scope. This overlay can <span class="emphasis"><em>also</em></span> be used to install recent unstable or stable versions of Rust, if desired.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="rust-overlay-installation"></a>15.25.5.1. Rust overlay installation</h4></div></div></div><p>
       You can use this overlay by either changing your local nixpkgs configuration, or by adding the overlay declaratively in a nix expression, e.g. in <code class="literal">configuration.nix</code>. For more information see <a class="link" href="the%20manual%20on%20installing%20overlays" target="_top">#sec-overlays-install</a>.
      </p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="imperative-rust-overlay-installation"></a>15.25.5.1.1. Imperative rust overlay installation</h5></div></div></div><p>
        Clone <a class="link" href="https://github.com/mozilla/nixpkgs-mozilla" target="_top">nixpkgs-mozilla</a>, and create a symbolic link to the file <a class="link" href="https://github.com/mozilla/nixpkgs-mozilla/blob/master/rust-overlay.nix" target="_top">rust-overlay.nix</a> in the <code class="literal">~/.config/nixpkgs/overlays</code> directory.
       </p><pre class="programlisting">
$ git clone https://github.com/mozilla/nixpkgs-mozilla.git
$ mkdir -p ~/.config/nixpkgs/overlays
$ ln -s $(pwd)/nixpkgs-mozilla/rust-overlay.nix ~/.config/nixpkgs/overlays/rust-overlay.nix
</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="declarative-rust-overlay-installation"></a>15.25.5.2. Declarative rust overlay installation</h4></div></div></div><p>
       Add the following to your <code class="literal">configuration.nix</code>, <code class="literal">home-configuration.nix</code>, <code class="literal">shell.nix</code>, or similar:
      </p><pre class="programlisting">
{ pkgs ? import &lt;nixpkgs&gt; {
    overlays = [
      (import (builtins.fetchTarball https://github.com/mozilla/nixpkgs-mozilla/archive/master.tar.gz))
      # Further overlays go here
    ];
  };
};
</pre><p>
       Note that this will fetch the latest overlay version when rebuilding your system.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="rust-overlay-usage"></a>15.25.5.3. Rust overlay usage</h4></div></div></div><p>
       The overlay contains attribute sets corresponding to different versions of the rust toolchain, such as:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
         <code class="literal">latest.rustChannels.stable</code>
        </p></li><li class="listitem"><p>
         <code class="literal">latest.rustChannels.nightly</code>
        </p></li><li class="listitem"><p>
         a function <code class="literal">rustChannelOf</code>, called as <code class="literal">(rustChannelOf { date = "2018-04-11"; channel = "nightly"; })</code>, or…
        </p></li><li class="listitem"><p>
         <code class="literal">(nixpkgs.rustChannelOf { rustToolchain = ./rust-toolchain; })</code> if you have a local <code class="literal">rust-toolchain</code> file (see https://github.com/mozilla/nixpkgs-mozilla#using-in-nix-expressions for an example)
        </p></li></ul></div><p>
       Each of these contain packages such as <code class="literal">rust</code>, which contains your usual rust development tools with the respective toolchain chosen. For example, you might want to add <code class="literal">latest.rustChannels.stable.rust</code> to the list of packages in your configuration.
      </p><p>
       Imperatively, the latest stable version can be installed with the following command:
      </p><pre class="programlisting">
$ nix-env -Ai nixpkgs.latest.rustChannels.stable.rust
</pre><p>
       Or using the attribute with nix-shell:
      </p><pre class="programlisting">
$ nix-shell -p nixpkgs.latest.rustChannels.stable.rust
</pre><p>
       Substitute the <code class="literal">nixpkgs</code> prefix with <code class="literal">nixos</code> on NixOS. To install the beta or nightly channel, <span class="quote">“<span class="quote">stable</span>”</span> should be substituted by <span class="quote">“<span class="quote">nightly</span>”</span> or <span class="quote">“<span class="quote">beta</span>”</span>, or use the function provided by this overlay to pull a version based on a build date.
      </p><p>
       The overlay automatically updates itself as it uses the same source as <a class="link" href="https://www.rustup.rs/" target="_top">rustup</a>.
      </p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-language-texlive"></a>15.26. TeX Live</h2></div></div></div><p>
     Since release 15.09 there is a new TeX Live packaging that lives entirely under attribute <code class="literal">texlive</code>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-language-texlive-user-guide"></a>15.26.1. User’s guide</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        For basic usage just pull <code class="literal">texlive.combined.scheme-basic</code> for an environment with basic LaTeX support.
       </p></li><li class="listitem"><p>
        It typically won’t work to use separately installed packages together. Instead, you can build a custom set of packages like this:
       </p><pre class="programlisting">
texlive.combine {
  inherit (texlive) scheme-small collection-langkorean algorithms cm-super;
}
</pre></li><li class="listitem"><p>
        There are all the schemes, collections and a few thousand packages, as defined upstream (perhaps with tiny differences).
       </p></li><li class="listitem"><p>
        By default you only get executables and files needed during runtime, and a little documentation for the core packages. To change that, you need to add <code class="literal">pkgFilter</code> function to <code class="literal">combine</code>.
       </p><pre class="programlisting">
texlive.combine {
  # inherit (texlive) whatever-you-want;
  pkgFilter = pkg:
    pkg.tlType == "run" || pkg.tlType == "bin" || pkg.pname == "cm-super";
  # elem tlType [ "run" "bin" "doc" "source" ]
  # there are also other attributes: version, name
}
</pre></li><li class="listitem"><p>
        You can list packages e.g. by <code class="literal">nix repl</code>.
       </p><pre class="programlisting">
$ nix repl
nix-repl&gt; :l &lt;nixpkgs&gt;
nix-repl&gt; texlive.collection-[TAB]
</pre></li><li class="listitem"><p>
        Note that the wrapper assumes that the result has a chance to be useful. For example, the core executables should be present, as well as some core data files. The supported way of ensuring this is by including some scheme, for example <code class="literal">scheme-basic</code>, into the combination.
       </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-language-texlive-custom-packages"></a>15.26.2. Custom packages</h3></div></div></div><p>
      You may find that you need to use an external TeX package. A derivation for such package has to provide contents of the <span class="quote">“<span class="quote">texmf</span>”</span> directory in its output and provide the <code class="literal">tlType</code> attribute. Here is a (very verbose) example:
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; {};

let
  foiltex_run = stdenvNoCC.mkDerivation {
    pname = "latex-foiltex";
    version = "2.1.4b";
    passthru.tlType = "run";

    srcs = [
      (fetchurl {
        url = "http://mirrors.ctan.org/macros/latex/contrib/foiltex/foiltex.dtx";
        sha256 = "07frz0krpz7kkcwlayrwrj2a2pixmv0icbngyw92srp9fp23cqpz";
      })
      (fetchurl {
        url = "http://mirrors.ctan.org/macros/latex/contrib/foiltex/foiltex.ins";
        sha256 = "09wkyidxk3n3zvqxfs61wlypmbhi1pxmjdi1kns9n2ky8ykbff99";
      })
    ];

    unpackPhase = ''
      runHook preUnpack

      for _src in $srcs; do
        cp "$_src" $(stripHash "$_src")
      done

      runHook postUnpack
    '';

    nativeBuildInputs = [ texlive.combined.scheme-small ];

    dontConfigure = true;

    buildPhase = ''
      runHook preBuild

      # Generate the style files
      latex foiltex.ins

      runHook postBuild
    '';

    installPhase = ''
      runHook preInstall

      path="$out/tex/latex/foiltex"
      mkdir -p "$path"
      cp *.{cls,def,clo} "$path/"

      runHook postInstall
    '';

    meta = with lib; {
      description = "A LaTeX2e class for overhead transparencies";
      license = licenses.unfreeRedistributable;
      maintainers = with maintainers; [ veprbl ];
      platforms = platforms.all;
    };
  };
  foiltex = { pkgs = [ foiltex_run ]; };

  latex_with_foiltex = texlive.combine {
    inherit (texlive) scheme-small;
    inherit foiltex;
  };
in
  runCommand "test.pdf" {
    nativeBuildInputs = [ latex_with_foiltex ];
  } ''
cat &gt;test.tex &lt;&lt;EOF
\documentclass{foils}

\title{Presentation title}
\date{}

\begin{document}
\maketitle
\end{document}
EOF
  pdflatex test.tex
  cp test.pdf $out
''
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="titanium"></a>15.27. Titanium</h2></div></div></div><p>
     The Nixpkgs repository contains facilities to deploy a variety of versions of the <a class="link" href="https://www.appcelerator.com" target="_top">Titanium SDK</a> versions, a cross-platform mobile app development framework using JavaScript as an implementation language, and includes a function abstraction making it possible to build Titanium applications for Android and iOS devices from source code.
    </p><p>
     Not all Titanium features supported – currently, it can only be used to build Android and iOS apps.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="building-a-titanium-app"></a>15.27.1. Building a Titanium app</h3></div></div></div><p>
      We can build a Titanium app from source for Android or iOS and for debugging or release purposes by invoking the <code class="literal">titaniumenv.buildApp {}</code> function:
     </p><pre class="programlisting">
titaniumenv.buildApp {
  name = "myapp";
  src = ./myappsource;

  preBuild = "";
  target = "android"; # or 'iphone'
  tiVersion = "7.1.0.GA";
  release = true;

  androidsdkArgs = {
    platformVersions = [ "25" "26" ];
  };
  androidKeyStore = ./keystore;
  androidKeyAlias = "myfirstapp";
  androidKeyStorePassword = "secret";

  xcodeBaseDir = "/Applications/Xcode.app";
  xcodewrapperArgs = {
    version = "9.3";
  };
  iosMobileProvisioningProfile = ./myprovisioning.profile;
  iosCertificateName = "My Company";
  iosCertificate = ./mycertificate.p12;
  iosCertificatePassword = "secret";
  iosVersion = "11.3";
  iosBuildStore = false;

  enableWirelessDistribution = true;
  installURL = "/installipa.php";
}
</pre><p>
      The <code class="literal">titaniumenv.buildApp {}</code> function takes the following parameters:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        The <code class="literal">name</code> parameter refers to the name in the Nix store.
       </p></li><li class="listitem"><p>
        The <code class="literal">src</code> parameter refers to the source code location of the app that needs to be built.
       </p></li><li class="listitem"><p>
        <code class="literal">preRebuild</code> contains optional build instructions that are carried out before the build starts.
       </p></li><li class="listitem"><p>
        <code class="literal">target</code> indicates for which device the app must be built. Currently only <span class="quote">“<span class="quote">android</span>”</span> and <span class="quote">“<span class="quote">iphone</span>”</span> (for iOS) are supported.
       </p></li><li class="listitem"><p>
        <code class="literal">tiVersion</code> can be used to optionally override the requested Titanium version in <code class="literal">tiapp.xml</code>. If not specified, it will use the version in <code class="literal">tiapp.xml</code>.
       </p></li><li class="listitem"><p>
        <code class="literal">release</code> should be set to true when building an app for submission to the Google Playstore or Apple Appstore. Otherwise, it should be false.
       </p></li></ul></div><p>
      When the <code class="literal">target</code> has been set to <code class="literal">android</code>, we can configure the following parameters:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        The <code class="literal">androidSdkArgs</code> parameter refers to an attribute set that propagates all parameters to the <code class="literal">androidenv.composeAndroidPackages {}</code> function. This can be used to install all relevant Android plugins that may be needed to perform the Android build. If no parameters are given, it will deploy the platform SDKs for API-levels 25 and 26 by default.
       </p></li></ul></div><p>
      When the <code class="literal">release</code> parameter has been set to true, you need to provide parameters to sign the app:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">androidKeyStore</code> is the path to the keystore file
       </p></li><li class="listitem"><p>
        <code class="literal">androidKeyAlias</code> is the key alias
       </p></li><li class="listitem"><p>
        <code class="literal">androidKeyStorePassword</code> refers to the password to open the keystore file.
       </p></li></ul></div><p>
      When the <code class="literal">target</code> has been set to <code class="literal">iphone</code>, we can configure the following parameters:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        The <code class="literal">xcodeBaseDir</code> parameter refers to the location where Xcode has been installed. When none value is given, the above value is the default.
       </p></li><li class="listitem"><p>
        The <code class="literal">xcodewrapperArgs</code> parameter passes arbitrary parameters to the <code class="literal">xcodeenv.composeXcodeWrapper {}</code> function. This can, for example, be used to adjust the default version of Xcode.
       </p></li></ul></div><p>
      When <code class="literal">release</code> has been set to true, you also need to provide the following parameters:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">iosMobileProvisioningProfile</code> refers to a mobile provisioning profile needed for signing.
       </p></li><li class="listitem"><p>
        <code class="literal">iosCertificateName</code> refers to the company name in the P12 certificate.
       </p></li><li class="listitem"><p>
        <code class="literal">iosCertificate</code> refers to the path to the P12 file.
       </p></li><li class="listitem"><p>
        <code class="literal">iosCertificatePassword</code> contains the password to open the P12 file.
       </p></li><li class="listitem"><p>
        <code class="literal">iosVersion</code> refers to the iOS SDK version to use. It defaults to the latest version.
       </p></li><li class="listitem"><p>
        <code class="literal">iosBuildStore</code> should be set to <code class="literal">true</code> when building for the Apple Appstore submission. For enterprise or ad-hoc builds it should be set to <code class="literal">false</code>.
       </p></li></ul></div><p>
      When <code class="literal">enableWirelessDistribution</code> has been enabled, you must also provide the path of the PHP script (<code class="literal">installURL</code>) (that is included with the iOS build environment) to enable wireless ad-hoc installations.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="emulating-or-simulating-the-app"></a>15.27.2. Emulating or simulating the app</h3></div></div></div><p>
      It is also possible to simulate the correspond iOS simulator build by using <code class="literal">xcodeenv.simulateApp {}</code> and emulate an Android APK by using <code class="literal">androidenv.emulateApp {}</code>.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="vim"></a>15.28. Vim</h2></div></div></div><p>
     Both Neovim and Vim can be configured to include your favorite plugins and additional libraries.
    </p><p>
     Loading can be deferred; see examples.
    </p><p>
     At the moment we support three different methods for managing plugins:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       Vim packages (<span class="emphasis"><em>recommend</em></span>)
      </p></li><li class="listitem"><p>
       VAM (=vim-addon-manager)
      </p></li><li class="listitem"><p>
       Pathogen
      </p></li><li class="listitem"><p>
       vim-plug
      </p></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="custom-configuration"></a>15.28.1. Custom configuration</h3></div></div></div><p>
      Adding custom .vimrc lines can be done using the following code:
     </p><pre class="programlisting">
vim_configurable.customize {
  # `name` specifies the name of the executable and package
  name = "vim-with-plugins";

  vimrcConfig.customRC = ''
    set hidden
  '';
}
</pre><p>
      This configuration is used when Vim is invoked with the command specified as name, in this case <code class="literal">vim-with-plugins</code>.
     </p><p>
      For Neovim the <code class="literal">configure</code> argument can be overridden to achieve the same:
     </p><pre class="programlisting">
neovim.override {
  configure = {
    customRC = ''
      # here your custom configuration goes!
    '';
  };
}
</pre><p>
      If you want to use <code class="literal">neovim-qt</code> as a graphical editor, you can configure it by overriding Neovim in an overlay or passing it an overridden Neovimn:
     </p><pre class="programlisting">
neovim-qt.override {
  neovim = neovim.override {
    configure = {
      customRC = ''
        # your custom configuration
      '';
    };
  };
}
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="managing-plugins-with-vim-packages"></a>15.28.2. Managing plugins with Vim packages</h3></div></div></div><p>
      To store you plugins in Vim packages (the native Vim plugin manager, see <code class="literal">:help packages</code>) the following example can be used:
     </p><pre class="programlisting">
vim_configurable.customize {
  vimrcConfig.packages.myVimPackage = with pkgs.vimPlugins; {
    # loaded on launch
    start = [ youcompleteme fugitive ];
    # manually loadable by calling `:packadd $plugin-name`
    # however, if a Vim plugin has a dependency that is not explicitly listed in
    # opt that dependency will always be added to start to avoid confusion.
    opt = [ phpCompletion elm-vim ];
    # To automatically load a plugin when opening a filetype, add vimrc lines like:
    # autocmd FileType php :packadd phpCompletion
  };
}
</pre><p>
      <code class="literal">myVimPackage</code> is an arbitrary name for the generated package. You can choose any name you like. For Neovim the syntax is:
     </p><pre class="programlisting">
neovim.override {
  configure = {
    customRC = ''
      # here your custom configuration goes!
    '';
    packages.myVimPackage = with pkgs.vimPlugins; {
      # see examples below how to use custom packages
      start = [ ];
      # If a Vim plugin has a dependency that is not explicitly listed in
      # opt that dependency will always be added to start to avoid confusion.
      opt = [ ];
    };
  };
}
</pre><p>
      The resulting package can be added to <code class="literal">packageOverrides</code> in <code class="literal">~/.nixpkgs/config.nix</code> to make it installable:
     </p><pre class="programlisting">
{
  packageOverrides = pkgs: with pkgs; {
    myVim = vim_configurable.customize {
      # `name` specifies the name of the executable and package
      name = "vim-with-plugins";
      # add here code from the example section
    };
    myNeovim = neovim.override {
      configure = {
      # add here code from the example section
      };
    };
  };
}
</pre><p>
      After that you can install your special grafted <code class="literal">myVim</code> or <code class="literal">myNeovim</code> packages.
     </p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="what-if-your-favourite-vim-plugin-isnt-already-packaged"></a>15.28.2.1. What if your favourite Vim plugin isn’t already packaged?</h4></div></div></div><p>
       If one of your favourite plugins isn’t packaged, you can package it yourself:
      </p><pre class="programlisting">
{ config, pkgs, ... }:

let
  easygrep = pkgs.vimUtils.buildVimPlugin {
    name = "vim-easygrep";
    src = pkgs.fetchFromGitHub {
      owner = "dkprice";
      repo = "vim-easygrep";
      rev = "d0c36a77cc63c22648e792796b1815b44164653a";
      sha256 = "0y2p5mz0d5fhg6n68lhfhl8p4mlwkb82q337c22djs4w5zyzggbc";
    };
  };
in
{
  environment.systemPackages = [
    (
      pkgs.neovim.override {
        configure = {
          packages.myPlugins = with pkgs.vimPlugins; {
          start = [
            vim-go # already packaged plugin
            easygrep # custom package
          ];
          opt = [];
        };
        # ...
      };
     }
    )
  ];
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="managing-plugins-with-vim-plug"></a>15.28.3. Managing plugins with vim-plug</h3></div></div></div><p>
      To use <a class="link" href="https://github.com/junegunn/vim-plug" target="_top">vim-plug</a> to manage your Vim plugins the following example can be used:
     </p><pre class="programlisting">
vim_configurable.customize {
  vimrcConfig.packages.myVimPackage = with pkgs.vimPlugins; {
    # loaded on launch
    plug.plugins = [ youcompleteme fugitive phpCompletion elm-vim ];
  };
}
</pre><p>
      For Neovim the syntax is:
     </p><pre class="programlisting">
neovim.override {
  configure = {
    customRC = ''
      # here your custom configuration goes!
    '';
    plug.plugins = with pkgs.vimPlugins; [
      vim-go
    ];
  };
}
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="managing-plugins-with-vam"></a>15.28.4. Managing plugins with VAM</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="handling-dependencies-of-vim-plugins"></a>15.28.4.1. Handling dependencies of Vim plugins</h4></div></div></div><p>
       VAM introduced .json files supporting dependencies without versioning assuming that <span class="quote">“<span class="quote">using latest version</span>”</span> is ok most of the time.
      </p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="example"></a>15.28.4.2. Example</h4></div></div></div><p>
       First create a vim-scripts file having one plugin name per line. Example:
      </p><pre class="programlisting">
"tlib"
{'name': 'vim-addon-sql'}
{'filetype_regex': '\%(vim)$', 'names': ['reload', 'vim-dev-plugin']}
</pre><p>
       Such vim-scripts file can be read by VAM as well like this:
      </p><pre class="programlisting">
call vam#Scripts(expand('~/.vim-scripts'), {})
</pre><p>
       Create a default.nix file:
      </p><pre class="programlisting">
{ nixpkgs ? import &lt;nixpkgs&gt; {}, compiler ? "ghc7102" }:
nixpkgs.vim_configurable.customize { name = "vim"; vimrcConfig.vam.pluginDictionaries = [ "vim-addon-vim2nix" ]; }
</pre><p>
       Create a generate.vim file:
      </p><pre class="programlisting">
ActivateAddons vim-addon-vim2nix
let vim_scripts = "vim-scripts"
call nix#ExportPluginsForNix({
\  'path_to_nixpkgs': eval('{"'.substitute(substitute(substitute($NIX_PATH, ':', ',', 'g'), '=',':', 'g'), '\([:,]\)', '"\1"',"g").'"}')["nixpkgs"],
\  'cache_file': '/tmp/vim2nix-cache',
\  'try_catch': 0,
\  'plugin_dictionaries': ["vim-addon-manager"]+map(readfile(vim_scripts), 'eval(v:val)')
\ })
</pre><p>
       Then run
      </p><pre class="programlisting">
nix-shell -p vimUtils.vim_with_vim2nix --command "vim -c 'source generate.vim'"
</pre><p>
       You should get a Vim buffer with the nix derivations (output1) and vam.pluginDictionaries (output2). You can add your Vim to your system’s configuration file like this and start it by <span class="quote">“<span class="quote">vim-my</span>”</span>:
      </p><pre class="programlisting">
my-vim =
  let plugins = let inherit (vimUtils) buildVimPluginFrom2Nix; in {
    copy paste output1 here
  }; in vim_configurable.customize {
    name = "vim-my";

    vimrcConfig.vam.knownPlugins = plugins; # optional
    vimrcConfig.vam.pluginDictionaries = [
       copy paste output2 here
    ];

    # Pathogen would be
    # vimrcConfig.pathogen.knownPlugins = plugins; # plugins
    # vimrcConfig.pathogen.pluginNames = ["tlib"];
  };
</pre><p>
       Sample output1:
      </p><pre class="programlisting">
"reload" = buildVimPluginFrom2Nix { # created by nix#NixDerivation
  name = "reload";
  src = fetchgit {
    url = "git://github.com/xolox/vim-reload";
    rev = "0a601a668727f5b675cb1ddc19f6861f3f7ab9e1";
    sha256 = "0vb832l9yxj919f5hfg6qj6bn9ni57gnjd3bj7zpq7d4iv2s4wdh";
  };
  dependencies = ["nim-misc"];

};
[...]
</pre><p>
       Sample output2:
      </p><pre class="programlisting">
[
  ''vim-addon-manager''
  ''tlib''
  { "name" = ''vim-addon-sql''; }
  { "filetype_regex" = ''\%(vim)$$''; "names" = [ ''reload'' ''vim-dev-plugin'' ]; }
]
</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="adding-new-plugins-to-nixpkgs"></a>15.28.5. Adding new plugins to nixpkgs</h3></div></div></div><p>
      Nix expressions for Vim plugins are stored in <a class="link" href="/pkgs/misc/vim-plugins" target="_top">pkgs/misc/vim-plugins</a>. For the vast majority of plugins, Nix expressions are automatically generated by running <a class="link" href="/pkgs/misc/vim-plugins/update.py" target="_top"><code class="literal">./update.py</code></a>. This creates a <a class="link" href="/pkgs/misc/vim-plugins/generated.nix" target="_top">generated.nix</a> file based on the plugins listed in <a class="link" href="/pkgs/misc/vim-plugins/vim-plugin-names" target="_top">vim-plugin-names</a>. Plugins are listed in alphabetical order in <code class="literal">vim-plugin-names</code> using the format <code class="literal">[github username]/[repository]</code>. For example https://github.com/scrooloose/nerdtree becomes <code class="literal">scrooloose/nerdtree</code>.
     </p><p>
      Some plugins require overrides in order to function properly. Overrides are placed in <a class="link" href="/pkgs/misc/vim-plugins/overrides.nix" target="_top">overrides.nix</a>. Overrides are most often required when a plugin requires some dependencies, or extra steps are required during the build process. For example <code class="literal">deoplete-fish</code> requires both <code class="literal">deoplete-nvim</code> and <code class="literal">vim-fish</code>, and so the following override was added:
     </p><pre class="programlisting">
deoplete-fish = super.deoplete-fish.overrideAttrs(old: {
  dependencies = with super; [ deoplete-nvim vim-fish ];
});
</pre><p>
      Sometimes plugins require an override that must be changed when the plugin is updated. This can cause issues when Vim plugins are auto-updated but the associated override isn’t updated. For these plugins, the override should be written so that it specifies all information required to install the plugin, and running <code class="literal">./update.py</code> doesn’t change the derivation for the plugin. Manually updating the override is required to update these types of plugins. An example of such a plugin is <code class="literal">LanguageClient-neovim</code>.
     </p><p>
      To add a new plugin, run <code class="literal">./update.py --add "[owner]/[name]"</code>. <span class="strong"><strong>NOTE</strong></span>: This script automatically commits to your git repository. Be sure to check out a fresh branch before running.
     </p><p>
      Finally, there are some plugins that are also packaged in nodePackages because they have Javascript-related build steps, such as running webpack. Those plugins are not listed in <code class="literal">vim-plugin-names</code> or managed by <code class="literal">update.py</code> at all, and are included separately in <code class="literal">overrides.nix</code>. Currently, all these plugins are related to the <code class="literal">coc.nvim</code> ecosystem of Language Server Protocol integration with vim/neovim.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="updating-plugins-in-nixpkgs"></a>15.28.6. Updating plugins in nixpkgs</h3></div></div></div><p>
      Run the update script with a GitHub API token that has at least <code class="literal">public_repo</code> access. Running the script without the token is likely to result in rate-limiting (429 errors). For steps on creating an API token, please refer to <a class="link" href="https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token" target="_top">GitHub’s token documentation</a>.
     </p><pre class="programlisting">
GITHUB_API_TOKEN=my_token ./pkgs/misc/vim-plugins/update.py
</pre><p>
      Alternatively, set the number of processes to a lower count to avoid rate-limiting.
     </p><pre class="programlisting">
./pkgs/misc/vim-plugins/update.py --proc 1
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="important-repositories"></a>15.28.7. Important repositories</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <a class="link" href="https://bitbucket.org/vimcommunity/vim-pi" target="_top">vim-pi</a> is a plugin repository from VAM plugin manager meant to be used by others as well used by
       </p></li><li class="listitem"><p>
        <a class="link" href="https://github.com/MarcWeber/vim-addon-vim2nix" target="_top">vim2nix</a> which generates the .nix code
       </p></li></ul></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-packages"></a>Chapter 16. Packages</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-citrix">16.1. Citrix Workspace</a></span></dt><dt><span class="section"><a href="#dlib">16.2. DLib</a></span></dt><dt><span class="section"><a href="#sec-eclipse">16.3. Eclipse</a></span></dt><dt><span class="section"><a href="#sec-elm">16.4. Elm</a></span></dt><dt><span class="section"><a href="#sec-emacs">16.5. Emacs</a></span></dt><dt><span class="section"><a href="#sec-firefox">16.6. Firefox</a></span></dt><dt><span class="section"><a href="#sec-fish">16.7. Fish</a></span></dt><dt><span class="section"><a href="#sec-fuse">16.8. FUSE</a></span></dt><dt><span class="section"><a href="#sec-ibus-typing-booster">16.9. ibus-engines.typing-booster</a></span></dt><dt><span class="section"><a href="#sec-kakoune">16.10. Kakoune</a></span></dt><dt><span class="section"><a href="#sec-linux-kernel">16.11. Linux kernel</a></span></dt><dt><span class="section"><a href="#locales">16.12. Locales</a></span></dt><dt><span class="section"><a href="#sec-nginx">16.13. Nginx</a></span></dt><dt><span class="section"><a href="#sec-opengl">16.14. OpenGL</a></span></dt><dt><span class="section"><a href="#sec-shell-helpers">16.15. Interactive shell helpers</a></span></dt><dt><span class="section"><a href="#sec-steam">16.16. Steam</a></span></dt><dt><span class="section"><a href="#cataclysm-dark-days-ahead">16.17. Cataclysm: Dark Days Ahead</a></span></dt><dt><span class="section"><a href="#sec-urxvt">16.18. Urxvt</a></span></dt><dt><span class="section"><a href="#sec-weechat">16.19. Weechat</a></span></dt><dt><span class="section"><a href="#sec-xorg">16.20. X.org</a></span></dt></dl></div><p>
    This chapter contains information about how to use and maintain the Nix expressions for a number of specific packages, such as the Linux kernel or X.org.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-citrix"></a>16.1. Citrix Workspace</h2></div></div></div><p>
     The <a class="link" href="https://www.citrix.com/products/workspace-app/" target="_top">Citrix Workspace App</a> is a remote desktop viewer which provides access to <a class="link" href="https://www.citrix.com/products/xenapp-xendesktop/" target="_top">XenDesktop</a> installations.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-citrix-base"></a>16.1.1. Basic usage</h3></div></div></div><p>
      The tarball archive needs to be downloaded manually as the license agreements of the vendor for <a class="link" href="https://www.citrix.de/downloads/workspace-app/linux/workspace-app-for-linux-latest.html" target="_top">Citrix Workspace</a> needs to be accepted first. Then run <code class="literal">nix-prefetch-url file://$PWD/linuxx64-$version.tar.gz</code>. With the archive available in the store the package can be built and installed with Nix.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-citrix-selfservice"></a>16.1.2. Citrix Selfservice</h3></div></div></div><p>
      The <a class="link" href="https://support.citrix.com/article/CTX200337" target="_top">selfservice</a> is an application managing Citrix desktops and applications. Please note that this feature only works with at least citrix_workspace_20_06_0 and later versions.
     </p><p>
      In order to set this up, you first have to <a class="link" href="https://its.uiowa.edu/support/article/102186" target="_top">download the <code class="literal">.cr</code> file from the Netscaler Gateway</a>. After that you can configure the <code class="literal">selfservice</code> like this:
     </p><pre class="programlisting">
$ storebrowse -C ~/Downloads/receiverconfig.cr
$ selfservice
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-citrix-custom-certs"></a>16.1.3. Custom certificates</h3></div></div></div><p>
      The <code class="literal">Citrix Workspace App</code> in <code class="literal">nixpkgs</code> trusts several certificates <a class="link" href="https://curl.haxx.se/docs/caextract.html" target="_top">from the Mozilla database</a> by default. However several companies using Citrix might require their own corporate certificate. On distros with imperative packaging these certs can be stored easily in <a class="link" href="https://developer-docs.citrix.com/projects/receiver-for-linux-command-reference/en/13.7/" target="_top"><code class="literal">$ICAROOT</code></a>, however this directory is a store path in <code class="literal">nixpkgs</code>. In order to work around this issue the package provides a simple mechanism to add custom certificates without rebuilding the entire package using <code class="literal">symlinkJoin</code>:
     </p><pre class="programlisting">
with import &lt;nixpkgs&gt; { config.allowUnfree = true; };
let
  extraCerts = [
    ./custom-cert-1.pem
    ./custom-cert-2.pem # ...
  ];
in citrix_workspace.override { inherit extraCerts; }
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="dlib"></a>16.2. DLib</h2></div></div></div><p>
     <a class="link" href="http://dlib.net/" target="_top">DLib</a> is a modern, C++-based toolkit which provides several machine learning algorithms.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="compiling-without-avx-support"></a>16.2.1. Compiling without AVX support</h3></div></div></div><p>
      Especially older CPUs don't support <a class="link" href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions" target="_top">AVX</a> (Advanced Vector Extensions) instructions that are used by DLib to optimize their algorithms.
     </p><p>
      On the affected hardware errors like <code class="literal">Illegal instruction</code> will occur. In those cases AVX support needs to be disabled:
     </p><pre class="programlisting">
self: super: { dlib = super.dlib.override { avxSupport = false; }; }
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-eclipse"></a>16.3. Eclipse</h2></div></div></div><p>
     The Nix expressions related to the Eclipse platform and IDE are in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/eclipse" target="_top"><code class="literal">pkgs/applications/editors/eclipse</code></a>.
    </p><p>
     Nixpkgs provides a number of packages that will install Eclipse in its various forms. These range from the bare-bones Eclipse Platform to the more fully featured Eclipse SDK or Scala-IDE packages and multiple version are often available. It is possible to list available Eclipse packages by issuing the command:
    </p><pre class="programlisting">
$ nix-env -f '&lt;nixpkgs&gt;' -qaP -A eclipses --description
</pre><p>
     Once an Eclipse variant is installed it can be run using the <code class="literal">eclipse</code> command, as expected. From within Eclipse it is then possible to install plugins in the usual manner by either manually specifying an Eclipse update site or by installing the Marketplace Client plugin and using it to discover and install other plugins. This installation method provides an Eclipse installation that closely resemble a manually installed Eclipse.
    </p><p>
     If you prefer to install plugins in a more declarative manner then Nixpkgs also offer a number of Eclipse plugins that can be installed in an <span class="emphasis"><em>Eclipse environment</em></span>. This type of environment is created using the function <code class="literal">eclipseWithPlugins</code> found inside the <code class="literal">nixpkgs.eclipses</code> attribute set. This function takes as argument <code class="literal">{ eclipse, plugins ? [], jvmArgs ? [] }</code> where <code class="literal">eclipse</code> is a one of the Eclipse packages described above, <code class="literal">plugins</code> is a list of plugin derivations, and <code class="literal">jvmArgs</code> is a list of arguments given to the JVM running the Eclipse. For example, say you wish to install the latest Eclipse Platform with the popular Eclipse Color Theme plugin and also allow Eclipse to use more RAM. You could then add
    </p><pre class="programlisting">
packageOverrides = pkgs: {
  myEclipse = with pkgs.eclipses; eclipseWithPlugins {
    eclipse = eclipse-platform;
    jvmArgs = [ "-Xmx2048m" ];
    plugins = [ plugins.color-theme ];
  };
}
</pre><p>
     to your Nixpkgs configuration (<code class="literal">~/.config/nixpkgs/config.nix</code>) and install it by running <code class="literal">nix-env -f '&lt;nixpkgs&gt;' -iA myEclipse</code> and afterward run Eclipse as usual. It is possible to find out which plugins are available for installation using <code class="literal">eclipseWithPlugins</code> by running
    </p><pre class="programlisting">
$ nix-env -f '&lt;nixpkgs&gt;' -qaP -A eclipses.plugins --description
</pre><p>
     If there is a need to install plugins that are not available in Nixpkgs then it may be possible to define these plugins outside Nixpkgs using the <code class="literal">buildEclipseUpdateSite</code> and <code class="literal">buildEclipsePlugin</code> functions found in the <code class="literal">nixpkgs.eclipses.plugins</code> attribute set. Use the <code class="literal">buildEclipseUpdateSite</code> function to install a plugin distributed as an Eclipse update site. This function takes <code class="literal">{ name, src }</code> as argument where <code class="literal">src</code> indicates the Eclipse update site archive. All Eclipse features and plugins within the downloaded update site will be installed. When an update site archive is not available then the <code class="literal">buildEclipsePlugin</code> function can be used to install a plugin that consists of a pair of feature and plugin JARs. This function takes an argument <code class="literal">{ name, srcFeature, srcPlugin }</code> where <code class="literal">srcFeature</code> and <code class="literal">srcPlugin</code> are the feature and plugin JARs, respectively.
    </p><p>
     Expanding the previous example with two plugins using the above functions we have
    </p><pre class="programlisting">
packageOverrides = pkgs: {
  myEclipse = with pkgs.eclipses; eclipseWithPlugins {
    eclipse = eclipse-platform;
    jvmArgs = [ "-Xmx2048m" ];
    plugins = [
      plugins.color-theme
      (plugins.buildEclipsePlugin {
        name = "myplugin1-1.0";
        srcFeature = fetchurl {
          url = "http://…/features/myplugin1.jar";
          sha256 = "123…";
        };
        srcPlugin = fetchurl {
          url = "http://…/plugins/myplugin1.jar";
          sha256 = "123…";
        };
      });
      (plugins.buildEclipseUpdateSite {
        name = "myplugin2-1.0";
        src = fetchurl {
          stripRoot = false;
          url = "http://…/myplugin2.zip";
          sha256 = "123…";
        };
      });
    ];
  };
}
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-elm"></a>16.4. Elm</h2></div></div></div><p>
     To start a development environment do
    </p><pre class="programlisting">
nix-shell -p elmPackages.elm elmPackages.elm-format
</pre><p>
     To update the Elm compiler, see <code class="filename">nixpkgs/pkgs/development/compilers/elm/README.md</code>.
    </p><p>
     To package Elm applications, <a class="link" href="https://github.com/hercules-ci/elm2nix#elm2nix" target="_top">read about elm2nix</a>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-emacs"></a>16.5. Emacs</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-emacs-config"></a>16.5.1. Configuring Emacs</h3></div></div></div><p>
      The Emacs package comes with some extra helpers to make it easier to configure. <code class="literal">emacs.pkgs.withPackages</code> allows you to manage packages from ELPA. This means that you will not have to install that packages from within Emacs. For instance, if you wanted to use <code class="literal">company</code> <code class="literal">counsel</code>, <code class="literal">flycheck</code>, <code class="literal">ivy</code>, <code class="literal">magit</code>, <code class="literal">projectile</code>, and <code class="literal">use-package</code> you could use this as a <code class="literal">~/.config/nixpkgs/config.nix</code> override:
     </p><pre class="programlisting">
{
  packageOverrides = pkgs: with pkgs; {
    myEmacs = emacs.pkgs.withPackages (epkgs: (with epkgs.melpaStablePackages; [
      company
      counsel
      flycheck
      ivy
      magit
      projectile
      use-package
    ]));
  }
}
</pre><p>
      You can install it like any other packages via <code class="literal">nix-env -iA myEmacs</code>. However, this will only install those packages. It will not <code class="literal">configure</code> them for us. To do this, we need to provide a configuration file. Luckily, it is possible to do this from within Nix! By modifying the above example, we can make Emacs load a custom config file. The key is to create a package that provide a <code class="literal">default.el</code> file in <code class="literal">/share/emacs/site-start/</code>. Emacs knows to load this file automatically when it starts.
     </p><pre class="programlisting">
{
  packageOverrides = pkgs: with pkgs; rec {
    myEmacsConfig = writeText "default.el" ''
      ;; initialize package

      (require 'package)
      (package-initialize 'noactivate)
      (eval-when-compile
        (require 'use-package))

      ;; load some packages

      (use-package company
        :bind ("&lt;C-tab&gt;" . company-complete)
        :diminish company-mode
        :commands (company-mode global-company-mode)
        :defer 1
        :config
        (global-company-mode))

      (use-package counsel
        :commands (counsel-descbinds)
        :bind (([remap execute-extended-command] . counsel-M-x)
               ("C-x C-f" . counsel-find-file)
               ("C-c g" . counsel-git)
               ("C-c j" . counsel-git-grep)
               ("C-c k" . counsel-ag)
               ("C-x l" . counsel-locate)
               ("M-y" . counsel-yank-pop)))

      (use-package flycheck
        :defer 2
        :config (global-flycheck-mode))

      (use-package ivy
        :defer 1
        :bind (("C-c C-r" . ivy-resume)
               ("C-x C-b" . ivy-switch-buffer)
               :map ivy-minibuffer-map
               ("C-j" . ivy-call))
        :diminish ivy-mode
        :commands ivy-mode
        :config
        (ivy-mode 1))

      (use-package magit
        :defer
        :if (executable-find "git")
        :bind (("C-x g" . magit-status)
               ("C-x G" . magit-dispatch-popup))
        :init
        (setq magit-completing-read-function 'ivy-completing-read))

      (use-package projectile
        :commands projectile-mode
        :bind-keymap ("C-c p" . projectile-command-map)
        :defer 5
        :config
        (projectile-global-mode))
    '';

    myEmacs = emacs.pkgs.withPackages (epkgs: (with epkgs.melpaStablePackages; [
      (runCommand "default.el" {} ''
         mkdir -p $out/share/emacs/site-lisp
         cp ${myEmacsConfig} $out/share/emacs/site-lisp/default.el
       '')
      company
      counsel
      flycheck
      ivy
      magit
      projectile
      use-package
    ]));
  };
}
</pre><p>
      This provides a fairly full Emacs start file. It will load in addition to the user’s presonal config. You can always disable it by passing <code class="literal">-q</code> to the Emacs command.
     </p><p>
      Sometimes <code class="literal">emacs.pkgs.withPackages</code> is not enough, as this package set has some priorities imposed on packages (with the lowest priority assigned to Melpa Unstable, and the highest for packages manually defined in <code class="literal">pkgs/top-level/emacs-packages.nix</code>). But you can’t control this priorities when some package is installed as a dependency. You can override it on per-package-basis, providing all the required dependencies manually - but it’s tedious and there is always a possibility that an unwanted dependency will sneak in through some other package. To completely override such a package you can use <code class="literal">overrideScope'</code>.
     </p><pre class="programlisting">
overrides = self: super: rec {
  haskell-mode = self.melpaPackages.haskell-mode;
  ...
};
((emacsPackagesFor emacs).overrideScope' overrides).emacs.pkgs.withPackages
  (p: with p; [
    # here both these package will use haskell-mode of our own choice
    ghc-mod
    dante
  ])
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-firefox"></a>16.6. Firefox</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="build-wrapped-firefox-with-extensions-and-policies"></a>16.6.1. Build wrapped Firefox with extensions and policies</h3></div></div></div><p>
      The <code class="literal">wrapFirefox</code> function allows to pass policies, preferences and extension that are available to firefox. With the help of <code class="literal">fetchFirefoxAddon</code> this allows build a firefox version that already comes with addons pre-installed:
     </p><pre class="programlisting">
{
  myFirefox = wrapFirefox firefox-unwrapped {
    nixExtensions = [
      (fetchFirefoxAddon {
        name = "ublock"; # Has to be unique!
        url = "https://addons.mozilla.org/firefox/downloads/file/3679754/ublock_origin-1.31.0-an+fx.xpi";
        sha256 = "1h768ljlh3pi23l27qp961v1hd0nbj2vasgy11bmcrlqp40zgvnr";
      })
    ];

    extraPolicies = {
      CaptivePortal = false;
      DisableFirefoxStudies = true;
      DisablePocket = true;
      DisableTelemetry = true;
      DisableFirefoxAccounts = true;
      FirefoxHome = {
        Pocket = false;
        Snippets = false;
      };
       UserMessaging = {
         ExtensionRecommendations = false;
         SkipOnboarding = true;
       };
    };

    extraPrefs = ''
      // Show more ssl cert infos
      lockPref("security.identityblock.show_extended_validation", true);
    '';
  };
}
</pre><p>
      If <code class="literal">nixExtensions != null</code> then all manually installed addons will be uninstalled from your browser profile. To view available enterprise policies visit <a class="link" href="https://github.com/mozilla/policy-templates#enterprisepoliciesenabled" target="_top">enterprise policies</a> or type into the Firefox url bar: <code class="literal">about:policies#documentation</code>. Nix installed addons do not have a valid signature, which is why signature verification is disabled. This does not compromise security because downloaded addons are checksumed and manual addons can’t be installed. Also make sure that the <code class="literal">name</code> field of fetchFirefoxAddon is unique. If you remove an addon from the nixExtensions array, rebuild and start Firefox the removed addon will be completly removed with all of its settings.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-firefox-troubleshooting"></a>16.6.2. Troubleshooting</h3></div></div></div><p>
      If addons do not appear installed although they have been defined in your nix configuration file reset the local addon state of your Firefox profile by clicking <code class="literal">help -&gt; restart with addons disabled -&gt; restart -&gt; refresh firefox</code>. This can happen if you switch from manual addon mode to nix addon mode and then back to manual mode and then again to nix addon mode.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-fish"></a>16.7. Fish</h2></div></div></div><p>
     Fish is a <span class="quote">“<span class="quote">smart and user-friendly command line shell</span>”</span> with support for plugins.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-fish-vendor"></a>16.7.1. Vendor Fish scripts</h3></div></div></div><p>
      Any package may ship its own Fish completions, configuration snippets, and functions. Those should be installed to <code class="literal">$out/share/fish/vendor_{completions,conf,functions}.d</code> respectively.
     </p><p>
      When the <code class="literal">programs.fish.enable</code> and <code class="literal">programs.fish.vendor.{completions,config,functions}.enable</code> options from the NixOS Fish module are set to true, those paths are symlinked in the current system environment and automatically loaded by Fish.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-fish-plugins-pkg"></a>16.7.2. Packaging Fish plugins</h3></div></div></div><p>
      While packages providing standalone executables belong to the top level, packages which have the sole purpose of extending Fish belong to the <code class="literal">fishPlugins</code> scope and should be registered in <code class="literal">pkgs/shells/fish/plugins/default.nix</code>.
     </p><p>
      The <code class="literal">buildFishPlugin</code> utility function can be used to automatically copy Fish scripts from <code class="literal">$src/{completions,conf,conf.d,functions}</code> to the standard vendor installation paths. It also sets up the test environment so that the optional <code class="literal">checkPhase</code> is executed in a Fish shell with other already packaged plugins and package-local Fish functions specified in <code class="literal">checkPlugins</code> and <code class="literal">checkFunctionDirs</code> respectively.
     </p><p>
      See <code class="literal">pkgs/shells/fish/plugins/pure.nix</code> for an example of Fish plugin package using <code class="literal">buildFishPlugin</code> and running unit tests with the <code class="literal">fishtape</code> test runner.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-fish-wrapper"></a>16.7.3. Fish wrapper</h3></div></div></div><p>
      The <code class="literal">wrapFish</code> package is a wrapper around Fish which can be used to create Fish shells initialised with some plugins as well as completions, configuration snippets and functions sourced from the given paths. This provides a convenient way to test Fish plugins and scripts without having to alter the environment.
     </p><pre class="programlisting">
wrapFish {
  pluginPkgs = with fishPlugins; [ pure foreign-env ];
  completionDirs = [];
  functionDirs = [];
  confDirs = [ "/path/to/some/fish/init/dir/" ];
}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-fuse"></a>16.8. FUSE</h2></div></div></div><p>
     Some packages rely on <a class="link" href="https://www.kernel.org/doc/html/latest/filesystems/fuse.html" target="_top">FUSE</a> to provide support for additional filesystems not supported by the kernel.
    </p><p>
     In general, FUSE software are primarily developed for Linux but many of them can also run on macOS. Nixpkgs supports FUSE packages on macOS, but it requires <a class="link" href="https://osxfuse.github.io" target="_top">macFUSE</a> to be installed outside of Nix. macFUSE currently isn’t packaged in Nixpkgs mainly because it includes a kernel extension, which isn’t supported by Nix outside of NixOS.
    </p><p>
     If a package fails to run on macOS with an error message similar to the following, it’s a likely sign that you need to have macFUSE installed.
    </p><pre class="programlisting">
dyld: Library not loaded: /usr/local/lib/libfuse.2.dylib
Referenced from: /nix/store/w8bi72bssv0bnxhwfw3xr1mvn7myf37x-sshfs-fuse-2.10/bin/sshfs
Reason: image not found
[1]    92299 abort      /nix/store/w8bi72bssv0bnxhwfw3xr1mvn7myf37x-sshfs-fuse-2.10/bin/sshfs
</pre><p>
     Package maintainers may often encounter the following error when building FUSE packages on macOS:
    </p><pre class="programlisting">
checking for fuse.h... no
configure: error: No fuse.h found.
</pre><p>
     This happens on autoconf based projects that uses <code class="literal">AC_CHECK_HEADERS</code> or <code class="literal">AC_CHECK_LIBS</code> to detect libfuse, and will occur even when the <code class="literal">fuse</code> package is included in <code class="literal">buildInputs</code>. It happens because libfuse headers throw an error on macOS if the <code class="literal">FUSE_USE_VERSION</code> macro is undefined. Many proejcts do define <code class="literal">FUSE_USE_VERSION</code>, but only inside C source files. This results in the above error at configure time because the configure script would attempt to compile sample FUSE programs without defining <code class="literal">FUSE_USE_VERSION</code>.
    </p><p>
     There are two possible solutions for this problem in Nixpkgs:
    </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
       Pass <code class="literal">FUSE_USE_VERSION</code> to the configure script by adding <code class="literal">CFLAGS=-DFUSE_USE_VERSION=25</code> in <code class="literal">configureFlags</code>. The actual value would have to match the definition used in the upstream source code.
      </p></li><li class="listitem"><p>
       Remove <code class="literal">AC_CHECK_HEADERS</code> / <code class="literal">AC_CHECK_LIBS</code> for libfuse.
      </p></li></ol></div><p>
     However, a better solution might be to fix the build script upstream to use <code class="literal">PKG_CHECK_MODULES</code> instead. This approach wouldn’t suffer from the problem that <code class="literal">AC_CHECK_HEADERS</code>/<code class="literal">AC_CHECK_LIBS</code> has at the price of introducing a dependency on pkg-config.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-ibus-typing-booster"></a>16.9. ibus-engines.typing-booster</h2></div></div></div><p>
     This package is an ibus-based completion method to speed up typing.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-ibus-typing-booster-activate"></a>16.9.1. Activating the engine</h3></div></div></div><p>
      IBus needs to be configured accordingly to activate <code class="literal">typing-booster</code>. The configuration depends on the desktop manager in use. For detailed instructions, please refer to the <a class="link" href="https://mike-fabian.github.io/ibus-typing-booster/documentation.html" target="_top">upstream docs</a>.
     </p><p>
      On NixOS you need to explicitly enable <code class="literal">ibus</code> with given engines before customizing your desktop to use <code class="literal">typing-booster</code>. This can be achieved using the <code class="literal">ibus</code> module:
     </p><pre class="programlisting">
{ pkgs, ... }: {
  i18n.inputMethod = {
    enabled = "ibus";
    ibus.engines = with pkgs.ibus-engines; [ typing-booster ];
  };
}
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-ibus-typing-booster-customize-hunspell"></a>16.9.2. Using custom hunspell dictionaries</h3></div></div></div><p>
      The IBus engine is based on <code class="literal">hunspell</code> to support completion in many languages. By default the dictionaries <code class="literal">de-de</code>, <code class="literal">en-us</code>, <code class="literal">fr-moderne</code> <code class="literal">es-es</code>, <code class="literal">it-it</code>, <code class="literal">sv-se</code> and <code class="literal">sv-fi</code> are in use. To add another dictionary, the package can be overridden like this:
     </p><pre class="programlisting">
ibus-engines.typing-booster.override { langs = [ "de-at" "en-gb" ]; }
</pre><p>
      <span class="emphasis"><em>Note: each language passed to <code class="literal">langs</code> must be an attribute name in <code class="literal">pkgs.hunspellDicts</code>.</em></span>
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-ibus-typing-booster-emoji-picker"></a>16.9.3. Built-in emoji picker</h3></div></div></div><p>
      The <code class="literal">ibus-engines.typing-booster</code> package contains a program named <code class="literal">emoji-picker</code>. To display all emojis correctly, a special font such as <code class="literal">noto-fonts-emoji</code> is needed:
     </p><p>
      On NixOS it can be installed using the following expression:
     </p><pre class="programlisting">
{ pkgs, ... }: { fonts.fonts = with pkgs; [ noto-fonts-emoji ]; }
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-kakoune"></a>16.10. Kakoune</h2></div></div></div><p>
     Kakoune can be built to autoload plugins:
    </p><pre class="programlisting">
(kakoune.override {
  plugins = with pkgs.kakounePlugins; [ parinfer-rust ];
})
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-linux-kernel"></a>16.11. Linux kernel</h2></div></div></div><p>
     The Nix expressions to build the Linux kernel are in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/os-specific/linux/kernel" target="_top"><code class="literal">pkgs/os-specific/linux/kernel</code></a>.
    </p><p>
     The function that builds the kernel has an argument <code class="literal">kernelPatches</code> which should be a list of <code class="literal">{name, patch, extraConfig}</code> attribute sets, where <code class="literal">name</code> is the name of the patch (which is included in the kernel’s <code class="literal">meta.description</code> attribute), <code class="literal">patch</code> is the patch itself (possibly compressed), and <code class="literal">extraConfig</code> (optional) is a string specifying extra options to be concatenated to the kernel configuration file (<code class="literal">.config</code>).
    </p><p>
     The kernel derivation exports an attribute <code class="literal">features</code> specifying whether optional functionality is or isn’t enabled. This is used in NixOS to implement kernel-specific behaviour. For instance, if the kernel has the <code class="literal">iwlwifi</code> feature (i.e. has built-in support for Intel wireless chipsets), then NixOS doesn’t have to build the external <code class="literal">iwlwifi</code> package:
    </p><pre class="programlisting">
modulesTree = [kernel]
  ++ pkgs.lib.optional (!kernel.features ? iwlwifi) kernelPackages.iwlwifi
  ++ ...;
</pre><p>
     How to add a new (major) version of the Linux kernel to Nixpkgs:
    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
       Copy the old Nix expression (e.g. <code class="literal">linux-2.6.21.nix</code>) to the new one (e.g. <code class="literal">linux-2.6.22.nix</code>) and update it.
      </p></li><li class="listitem"><p>
       Add the new kernel to <code class="literal">all-packages.nix</code> (e.g., create an attribute <code class="literal">kernel_2_6_22</code>).
      </p></li><li class="listitem"><p>
       Now we’re going to update the kernel configuration. First unpack the kernel. Then for each supported platform (<code class="literal">i686</code>, <code class="literal">x86_64</code>, <code class="literal">uml</code>) do the following:
      </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
         Make an copy from the old config (e.g. <code class="literal">config-2.6.21-i686-smp</code>) to the new one (e.g. <code class="literal">config-2.6.22-i686-smp</code>).
        </p></li><li class="listitem"><p>
         Copy the config file for this platform (e.g. <code class="literal">config-2.6.22-i686-smp</code>) to <code class="literal">.config</code> in the kernel source tree.
        </p></li><li class="listitem"><p>
         Run <code class="literal">make oldconfig ARCH={i386,x86_64,um}</code> and answer all questions. (For the uml configuration, also add <code class="literal">SHELL=bash</code>.) Make sure to keep the configuration consistent between platforms (i.e. don’t enable some feature on <code class="literal">i686</code> and disable it on <code class="literal">x86_64</code>).
        </p></li><li class="listitem"><p>
         If needed you can also run <code class="literal">make menuconfig</code>:
        </p><pre class="programlisting">
$ nix-env -i ncurses
$ export NIX_CFLAGS_LINK=-lncurses
$ make menuconfig ARCH=arch
</pre></li><li class="listitem"><p>
         Copy <code class="literal">.config</code> over the new config file (e.g. <code class="literal">config-2.6.22-i686-smp</code>).
        </p></li></ol></div></li><li class="listitem"><p>
       Test building the kernel: <code class="literal">nix-build -A kernel_2_6_22</code>. If it compiles, ship it! For extra credit, try booting NixOS with it.
      </p></li><li class="listitem"><p>
       It may be that the new kernel requires updating the external kernel modules and kernel-dependent packages listed in the <code class="literal">linuxPackagesFor</code> function in <code class="literal">all-packages.nix</code> (such as the NVIDIA drivers, AUFS, etc.). If the updated packages aren’t backwards compatible with older kernels, you may need to keep the older versions around.
      </p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="locales"></a>16.12. Locales</h2></div></div></div><p>
     To allow simultaneous use of packages linked against different versions of <code class="literal">glibc</code> with different locale archive formats Nixpkgs patches <code class="literal">glibc</code> to rely on <code class="literal">LOCALE_ARCHIVE</code> environment variable.
    </p><p>
     On non-NixOS distributions this variable is obviously not set. This can cause regressions in language support or even crashes in some Nixpkgs-provided programs. The simplest way to mitigate this problem is exporting the <code class="literal">LOCALE_ARCHIVE</code> variable pointing to <code class="literal">${glibcLocales}/lib/locale/locale-archive</code>. The drawback (and the reason this is not the default) is the relatively large (a hundred MiB) size of the full set of locales. It is possible to build a custom set of locales by overriding parameters <code class="literal">allLocales</code> and <code class="literal">locales</code> of the package.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-nginx"></a>16.13. Nginx</h2></div></div></div><p>
     <a class="link" href="https://nginx.org" target="_top">Nginx</a> is a reverse proxy and lightweight webserver.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-nginx-etag"></a>16.13.1. ETags on static files served from the Nix store</h3></div></div></div><p>
      HTTP has a couple different mechanisms for caching to prevent clients from having to download the same content repeatedly if a resource has not changed since the last time it was requested. When nginx is used as a server for static files, it implements the caching mechanism based on the <a class="link" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Last-Modified" target="_top"><code class="literal">Last-Modified</code></a> response header automatically; unfortunately, it works by using filesystem timestamps to determine the value of the <code class="literal">Last-Modified</code> header. This doesn’t give the desired behavior when the file is in the Nix store, because all file timestamps are set to 0 (for reasons related to build reproducibility).
     </p><p>
      Fortunately, HTTP supports an alternative (and more effective) caching mechanism: the <a class="link" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag" target="_top"><code class="literal">ETag</code></a> response header. The value of the <code class="literal">ETag</code> header specifies some identifier for the particular content that the server is sending (e.g. a hash). When a client makes a second request for the same resource, it sends that value back in an <code class="literal">If-None-Match</code> header. If the ETag value is unchanged, then the server does not need to resend the content.
     </p><p>
      As of NixOS 19.09, the nginx package in Nixpkgs is patched such that when nginx serves a file out of <code class="literal">/nix/store</code>, the hash in the store path is used as the <code class="literal">ETag</code> header in the HTTP response, thus providing proper caching functionality. This happens automatically; you do not need to do modify any configuration to get this behavior.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-opengl"></a>16.14. OpenGL</h2></div></div></div><p>
     OpenGL support varies depending on which hardware is used and which drivers are available and loaded.
    </p><p>
     Broadly, we support both GL vendors: Mesa and NVIDIA.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="nixos-desktop"></a>16.14.1. NixOS Desktop</h3></div></div></div><p>
      The NixOS desktop or other non-headless configurations are the primary target for OpenGL libraries and applications. The current solution for discovering which drivers are available is based on <a class="link" href="https://gitlab.freedesktop.org/glvnd/libglvnd" target="_top">libglvnd</a>. <code class="literal">libglvnd</code> performs <span class="quote">“<span class="quote">vendor-neutral dispatch</span>”</span>, trying a variety of techniques to find the system’s GL implementation. In practice, this will be either via standard GLX for X11 users or EGL for Wayland users, and supporting either NVIDIA or Mesa extensions.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="nix-on-gnulinux"></a>16.14.2. Nix on GNU/Linux</h3></div></div></div><p>
      If you are using a non-NixOS GNU/Linux/X11 desktop with free software video drivers, consider launching OpenGL-dependent programs from Nixpkgs with Nixpkgs versions of <code class="literal">libglvnd</code> and <code class="literal">mesa.drivers</code> in <code class="literal">LD_LIBRARY_PATH</code>. For Mesa drivers, the Linux kernel version doesn’t have to match nixpkgs.
     </p><p>
      For proprietary video drivers you might have luck with also adding the corresponding video driver package.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-shell-helpers"></a>16.15. Interactive shell helpers</h2></div></div></div><p>
     Some packages provide the shell integration to be more useful. But unlike other systems, nix doesn’t have a standard <code class="literal">share</code> directory location. This is why a bunch <code class="literal">PACKAGE-share</code> scripts are shipped that print the location of the corresponding shared folder. Current list of such packages is as following:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       <code class="literal">fzf</code> : <code class="literal">fzf-share</code>
      </p></li></ul></div><p>
     E.g. <code class="literal">fzf</code> can then used in the <code class="literal">.bashrc</code> like this:
    </p><pre class="programlisting">
source "$(fzf-share)/completion.bash"
source "$(fzf-share)/key-bindings.bash"
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-steam"></a>16.16. Steam</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-steam-nix"></a>16.16.1. Steam in Nix</h3></div></div></div><p>
      Steam is distributed as a <code class="literal">.deb</code> file, for now only as an i686 package (the amd64 package only has documentation). When unpacked, it has a script called <code class="literal">steam</code> that in Ubuntu (their target distro) would go to <code class="literal">/usr/bin</code>. When run for the first time, this script copies some files to the user’s home, which include another script that is the ultimate responsible for launching the steam binary, which is also in $HOME.
     </p><p>
      Nix problems and constraints:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        We don’t have <code class="literal">/bin/bash</code> and many scripts point there. Similarly for <code class="literal">/usr/bin/python</code>.
       </p></li><li class="listitem"><p>
        We don’t have the dynamic loader in <code class="literal">/lib</code>.
       </p></li><li class="listitem"><p>
        The <code class="literal">steam.sh</code> script in $HOME can not be patched, as it is checked and rewritten by steam.
       </p></li><li class="listitem"><p>
        The steam binary cannot be patched, it’s also checked.
       </p></li></ul></div><p>
      The current approach to deploy Steam in NixOS is composing a FHS-compatible chroot environment, as documented <a class="link" href="http://sandervanderburg.blogspot.nl/2013/09/composing-fhs-compatible-chroot.html" target="_top">here</a>. This allows us to have binaries in the expected paths without disrupting the system, and to avoid patching them to work in a non FHS environment.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-steam-play"></a>16.16.2. How to play</h3></div></div></div><p>
      Use <code class="literal">programs.steam.enable = true;</code> if you want to add steam to systemPackages and also enable a few workarrounds aswell as Steam controller support or other Steam supported controllers such as the DualShock 4 or Nintendo Switch Pr.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-steam-troub"></a>16.16.3. Troubleshooting</h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <span class="strong"><strong>Steam fails to start. What do I do?</strong></span> Try to run
       </p><pre class="programlisting">
strace steam
</pre><p>
        to see what is causing steam to fail.
       </p></li><li class="listitem"><p>
        <span class="strong"><strong>Using the FOSS Radeon or nouveau (nvidia) drivers</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
          The <code class="literal">newStdcpp</code> parameter was removed since NixOS 17.09 and should not be needed anymore.
         </p></li><li class="listitem"><p>
          Steam ships statically linked with a version of libcrypto that conflics with the one dynamically loaded by radeonsi_dri.so. If you get the error
         </p><pre class="programlisting">
steam.sh: line 713: 7842 Segmentation fault (core dumped)
</pre><p>
          have a look at <a class="link" href="https://github.com/NixOS/nixpkgs/pull/20269" target="_top">this pull request</a>.
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>Java</strong></span>
       </p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>
          There is no java in steam chrootenv by default. If you get a message like
         </p></li></ol></div><pre class="programlisting">
/home/foo/.local/share/Steam/SteamApps/common/towns/towns.sh: line 1: java: command not found
</pre><p>
        You need to add
       </p><pre class="programlisting">
steam.override { withJava = true; };
</pre></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-steam-run"></a>16.16.4. steam-run</h3></div></div></div><p>
      The FHS-compatible chroot used for steam can also be used to run other linux games that expect a FHS environment. To do it, add
     </p><pre class="programlisting">
pkgs.steam.override ({
          nativeOnly = true;
          newStdcpp = true;
        }).run
</pre><p>
      to your configuration, rebuild, and run the game with
     </p><pre class="programlisting">
steam-run ./foo
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="cataclysm-dark-days-ahead"></a>16.17. Cataclysm: Dark Days Ahead</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="how-to-install-cataclysm-dda"></a>16.17.1. How to install Cataclysm DDA</h3></div></div></div><p>
      To install the latest stable release of Cataclysm DDA to your profile, execute <code class="literal">nix-env -f "&lt;nixpkgs&gt;" -iA cataclysm-dda</code>. For the curses build (build without tiles), install <code class="literal">cataclysmDDA.stable.curses</code>. Note: <code class="literal">cataclysm-dda</code> is an alias to <code class="literal">cataclysmDDA.stable.tiles</code>.
     </p><p>
      If you like access to a development build of your favorite git revision, override <code class="literal">cataclysm-dda-git</code> (or <code class="literal">cataclysmDDA.git.curses</code> if you like curses build):
     </p><pre class="programlisting">
cataclysm-dda-git.override {
  version = "YYYY-MM-DD";
  rev = "YOUR_FAVORITE_REVISION";
  sha256 = "CHECKSUM_OF_THE_REVISION";
}
</pre><p>
      The sha256 checksum can be obtained by
     </p><pre class="programlisting">
nix-prefetch-url --unpack "https://github.com/CleverRaven/Cataclysm-DDA/archive/${YOUR_FAVORITE_REVISION}.tar.gz"
</pre><p>
      The default configuration directory is <code class="literal">~/.cataclysm-dda</code>. If you prefer <code class="literal">$XDG_CONFIG_HOME/cataclysm-dda</code>, override the derivation:
     </p><pre class="programlisting">
cataclysm-dda.override {
  useXdgDir = true;
}
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="important-note-for-overriding-packages"></a>16.17.2. Important note for overriding packages</h3></div></div></div><p>
      After applying <code class="literal">overrideAttrs</code>, you need to fix <code class="literal">passthru.pkgs</code> and <code class="literal">passthru.withMods</code> attributes either manually or by using <code class="literal">attachPkgs</code>:
     </p><pre class="programlisting">
let
  # You enabled parallel building.
  myCDDA = cataclysm-dda-git.overrideAttrs (_: {
    enableParallelBuilding = true;
  });

  # Unfortunately, this refers to the package before overriding and
  # parallel building is still disabled.
  badExample = myCDDA.withMods (_: []);

  inherit (cataclysmDDA) attachPkgs pkgs wrapCDDA;

  # You can fix it by hand
  goodExample1 = myCDDA.overrideAttrs (old: {
    passthru = old.passthru // {
      pkgs = pkgs.override { build = goodExample1; };
      withMods = wrapCDDA goodExample1;
    };
  });

  # or by using a helper function `attachPkgs`.
  goodExample2 = attachPkgs pkgs myCDDA;
in

# badExample                     # parallel building disabled
# goodExample1.withMods (_: [])  # parallel building enabled
goodExample2.withMods (_: [])    # parallel building enabled
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="customizing-with-mods"></a>16.17.3. Customizing with mods</h3></div></div></div><p>
      To install Cataclysm DDA with mods of your choice, you can use <code class="literal">withMods</code> attribute:
     </p><pre class="programlisting">
cataclysm-dda.withMods (mods: with mods; [
  tileset.UndeadPeople
])
</pre><p>
      All mods, soundpacks, and tilesets available in nixpkgs are found in <code class="literal">cataclysmDDA.pkgs</code>.
     </p><p>
      Here is an example to modify existing mods and/or add more mods not available in nixpkgs:
     </p><pre class="programlisting">
let
  customMods = self: super: lib.recursiveUpdate super {
    # Modify existing mod
    tileset.UndeadPeople = super.tileset.UndeadPeople.overrideAttrs (old: {
      # If you like to apply a patch to the tileset for example
      patches = [ ./path/to/your.patch ];
    });

    # Add another mod
    mod.Awesome = cataclysmDDA.buildMod {
      modName = "Awesome";
      version = "0.x";
      src = fetchFromGitHub {
        owner = "Someone";
        repo = "AwesomeMod";
        rev = "...";
        sha256 = "...";
      };
      # Path to be installed in the unpacked source (default: ".")
      modRoot = "contents/under/this/path/will/be/installed";
    };

    # Add another soundpack
    soundpack.Fantastic = cataclysmDDA.buildSoundPack {
      # ditto
    };

    # Add another tileset
    tileset.SuperDuper = cataclysmDDA.buildTileSet {
      # ditto
    };
  };
in
cataclysm-dda.withMods (mods: with mods.extend customMods; [
  tileset.UndeadPeople
  mod.Awesome
  soundpack.Fantastic
  tileset.SuperDuper
])
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-urxvt"></a>16.18. Urxvt</h2></div></div></div><p>
     Urxvt, also known as rxvt-unicode, is a highly customizable terminal emulator.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-urxvt-conf"></a>16.18.1. Configuring urxvt</h3></div></div></div><p>
      In <code class="literal">nixpkgs</code>, urxvt is provided by the package <code class="literal">rxvt-unicode</code>. It can be configured to include your choice of plugins, reducing its closure size from the default configuration which includes all available plugins. To make use of this functionality, use an overlay or directly install an expression that overrides its configuration, such as
     </p><pre class="programlisting">
rxvt-unicode.override {
  configure = { availablePlugins, ... }: {
    plugins = with availablePlugins; [ perls resize-font vtwheel ];
  };
}
</pre><p>
      If the <code class="literal">configure</code> function returns an attrset without the <code class="literal">plugins</code> attribute, <code class="literal">availablePlugins</code> will be used automatically.
     </p><p>
      In order to add plugins but also keep all default plugins installed, it is possible to use the following method:
     </p><pre class="programlisting">
rxvt-unicode.override {
  configure = { availablePlugins, ... }: {
    plugins = (builtins.attrValues availablePlugins) ++ [ custom-plugin ];
  };
}
</pre><p>
      To get a list of all the plugins available, open the Nix REPL and run
     </p><pre class="programlisting">
$ nix repl
:l &lt;nixpkgs&gt;
map (p: p.name) pkgs.rxvt-unicode.plugins
</pre><p>
      Alternatively, if your shell is bash or zsh and have completion enabled, simply type <code class="literal">nixpkgs.rxvt-unicode.plugins.&lt;tab&gt;</code>.
     </p><p>
      In addition to <code class="literal">plugins</code> the options <code class="literal">extraDeps</code> and <code class="literal">perlDeps</code> can be used to install extra packages. <code class="literal">extraDeps</code> can be used, for example, to provide <code class="literal">xsel</code> (a clipboard manager) to the clipboard plugin, without installing it globally:
     </p><pre class="programlisting">
rxvt-unicode.override {
  configure = { availablePlugins, ... }: {
    pluginsDeps = [ xsel ];
  };
}
</pre><p>
      <code class="literal">perlDeps</code> is a handy way to provide Perl packages to your custom plugins (in <code class="literal">$HOME/.urxvt/ext</code>). For example, if you need <code class="literal">AnyEvent</code> you can do:
     </p><pre class="programlisting">
rxvt-unicode.override {
  configure = { availablePlugins, ... }: {
    perlDeps = with perlPackages; [ AnyEvent ];
  };
}
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-urxvt-pkg"></a>16.18.2. Packaging urxvt plugins</h3></div></div></div><p>
      Urxvt plugins resides in <code class="literal">pkgs/applications/misc/rxvt-unicode-plugins</code>. To add a new plugin create an expression in a subdirectory and add the package to the set in <code class="literal">pkgs/applications/misc/rxvt-unicode-plugins/default.nix</code>.
     </p><p>
      A plugin can be any kind of derivation, the only requirement is that it should always install perl scripts in <code class="literal">$out/lib/urxvt/perl</code>. Look for existing plugins for examples.
     </p><p>
      If the plugin is itself a perl package that needs to be imported from other plugins or scripts, add the following passthrough:
     </p><pre class="programlisting">
passthru.perlPackages = [ "self" ];
</pre><p>
      This will make the urxvt wrapper pick up the dependency and set up the perl path accordingly.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-weechat"></a>16.19. Weechat</h2></div></div></div><p>
     Weechat can be configured to include your choice of plugins, reducing its closure size from the default configuration which includes all available plugins. To make use of this functionality, install an expression that overrides its configuration such as
    </p><pre class="programlisting">
weechat.override {configure = {availablePlugins, ...}: {
    plugins = with availablePlugins; [ python perl ];
  }
}
</pre><p>
     If the <code class="literal">configure</code> function returns an attrset without the <code class="literal">plugins</code> attribute, <code class="literal">availablePlugins</code> will be used automatically.
    </p><p>
     The plugins currently available are <code class="literal">python</code>, <code class="literal">perl</code>, <code class="literal">ruby</code>, <code class="literal">guile</code>, <code class="literal">tcl</code> and <code class="literal">lua</code>.
    </p><p>
     The python and perl plugins allows the addition of extra libraries. For instance, the <code class="literal">inotify.py</code> script in <code class="literal">weechat-scripts</code> requires D-Bus or libnotify, and the <code class="literal">fish.py</code> script requires <code class="literal">pycrypto</code>. To use these scripts, use the plugin’s <code class="literal">withPackages</code> attribute:
    </p><pre class="programlisting">
weechat.override { configure = {availablePlugins, ...}: {
    plugins = with availablePlugins; [
            (python.withPackages (ps: with ps; [ pycrypto python-dbus ]))
        ];
    };
}
</pre><p>
     In order to also keep all default plugins installed, it is possible to use the following method:
    </p><pre class="programlisting">
weechat.override { configure = { availablePlugins, ... }: {
  plugins = builtins.attrValues (availablePlugins // {
    python = availablePlugins.python.withPackages (ps: with ps; [ pycrypto python-dbus ]);
  });
}; }
</pre><p>
     WeeChat allows to set defaults on startup using the <code class="literal">--run-command</code>. The <code class="literal">configure</code> method can be used to pass commands to the program:
    </p><pre class="programlisting">
weechat.override {
  configure = { availablePlugins, ... }: {
    init = ''
      /set foo bar
      /server add freenode chat.freenode.org
    '';
  };
}
</pre><p>
     Further values can be added to the list of commands when running <code class="literal">weechat --run-command "your-commands"</code>.
    </p><p>
     Additionally it’s possible to specify scripts to be loaded when starting <code class="literal">weechat</code>. These will be loaded before the commands from <code class="literal">init</code>:
    </p><pre class="programlisting">
weechat.override {
  configure = { availablePlugins, ... }: {
    scripts = with pkgs.weechatScripts; [
      weechat-xmpp weechat-matrix-bridge wee-slack
    ];
    init = ''
      /set plugins.var.python.jabber.key "val"
    '':
  };
}
</pre><p>
     In <code class="literal">nixpkgs</code> there’s a subpackage which contains derivations for WeeChat scripts. Such derivations expect a <code class="literal">passthru.scripts</code> attribute which contains a list of all scripts inside the store path. Furthermore all scripts have to live in <code class="literal">$out/share</code>. An exemplary derivation looks like this:
    </p><pre class="programlisting">
{ stdenv, fetchurl }:

stdenv.mkDerivation {
  name = "exemplary-weechat-script";
  src = fetchurl {
    url = "https://scripts.tld/your-scripts.tar.gz";
    sha256 = "...";
  };
  passthru.scripts = [ "foo.py" "bar.lua" ];
  installPhase = ''
    mkdir $out/share
    cp foo.py $out/share
    cp bar.lua $out/share
  '';
}
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-xorg"></a>16.20. X.org</h2></div></div></div><p>
     The Nix expressions for the X.org packages reside in <code class="literal">pkgs/servers/x11/xorg/default.nix</code>. This file is automatically generated from lists of tarballs in an X.org release. As such it should not be modified directly; rather, you should modify the lists, the generator script or the file <code class="literal">pkgs/servers/x11/xorg/overrides.nix</code>, in which you can override or add to the derivations produced by the generator.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="katamari-tarballs"></a>16.20.1. Katamari Tarballs</h3></div></div></div><p>
      X.org upstream releases used to include <a class="link" href="https://en.wiktionary.org/wiki/%E3%81%8B%E3%81%9F%E3%81%BE%E3%82%8A" target="_top">katamari</a> releases, which included a holistic recommended version for each tarball, up until 7.7. To create a list of tarballs in a katamari release:
     </p><pre class="programlisting">
export release="X11R7.7"
export url="mirror://xorg/$release/src/everything/"
cat $(PRINT_PATH=1 nix-prefetch-url $url | tail -n 1) \
  | perl -e 'while (&lt;&gt;) { if (/(href|HREF)="([^"]*.bz2)"/) { print "$ENV{'url'}$2\n"; }; }' \
  | sort &gt; "tarballs-$release.list"
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="individual-tarballs"></a>16.20.2. Individual Tarballs</h3></div></div></div><p>
      The upstream release process for <a class="link" href="https://x.org/wiki/Releases/7.8/" target="_top">X11R7.8</a> does not include a planned katamari. Instead, each component of X.org is released as its own tarball. We maintain <code class="literal">pkgs/servers/x11/xorg/tarballs.list</code> as a list of tarballs for each individual package. This list includes X.org core libraries and protocol descriptions, extra newer X11 interface libraries, like <code class="literal">xorg.libxcb</code>, and classic utilities which are largely unused but still available if needed, like <code class="literal">xorg.imake</code>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="generating-nix-expressions"></a>16.20.3. Generating Nix Expressions</h3></div></div></div><p>
      The generator is invoked as follows:
     </p><pre class="programlisting">
cd pkgs/servers/x11/xorg
&lt;tarballs.list perl ./generate-expr-from-tarballs.pl
</pre><p>
      For each of the tarballs in the <code class="literal">.list</code> files, the script downloads it, unpacks it, and searches its <code class="literal">configure.ac</code> and <code class="literal">*.pc.in</code> files for dependencies. This information is used to generate <code class="literal">default.nix</code>. The generator caches downloaded tarballs between runs. Pay close attention to the <code class="literal">NOT FOUND: $NAME</code> messages at the end of the run, since they may indicate missing dependencies. (Some might be optional dependencies, however.)
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="overriding-the-generator"></a>16.20.4. Overriding the Generator</h3></div></div></div><p>
      If the expression for a package requires derivation attributes that the generator cannot figure out automatically (say, <code class="literal">patches</code> or a <code class="literal">postInstall</code> hook), you should modify <code class="literal">pkgs/servers/x11/xorg/overrides.nix</code>.
     </p></div></div></div></div><div class="part"><div class="titlepage"><div><div><h1 class="title"><a id="idm140737316362528"></a>Part IV. Contributing to Nixpkgs</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="chapter"><a href="#chap-quick-start">17. Quick Start to Adding a Package</a></span></dt><dt><span class="chapter"><a href="#chap-conventions">18. Coding conventions</a></span></dt><dt><span class="chapter"><a href="#chap-submitting-changes">19. Submitting changes</a></span></dt><dt><span class="chapter"><a href="#chap-vulnerability-roundup">20. Vulnerability Roundup</a></span></dt><dt><span class="chapter"><a href="#chap-reviewing-contributions">21. Reviewing contributions</a></span></dt><dt><span class="chapter"><a href="#chap-contributing">22. Contributing to this documentation</a></span></dt></dl></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-quick-start"></a>Chapter 17. Quick Start to Adding a Package</h2></div></div></div><p>
    To add a package to Nixpkgs:
   </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
      Checkout the Nixpkgs source tree:
     </p><pre class="programlisting">
$ git clone https://github.com/NixOS/nixpkgs
$ cd nixpkgs
</pre></li><li class="listitem"><p>
      Find a good place in the Nixpkgs tree to add the Nix expression for your package. For instance, a library package typically goes into <code class="literal">pkgs/development/libraries/pkgname</code>, while a web browser goes into <code class="literal">pkgs/applications/networking/browsers/pkgname</code>. See <a class="xref" href="#sec-organisation" title="18.3. File naming and organisation">Section 18.3, “File naming and organisation”</a> for some hints on the tree organisation. Create a directory for your package, e.g.
     </p><pre class="programlisting">
$ mkdir pkgs/development/libraries/libfoo
</pre></li><li class="listitem"><p>
      In the package directory, create a Nix expression — a piece of code that describes how to build the package. In this case, it should be a <span class="emphasis"><em>function</em></span> that is called with the package dependencies as arguments, and returns a build of the package in the Nix store. The expression should usually be called <code class="literal">default.nix</code>.
     </p><pre class="programlisting">
$ emacs pkgs/development/libraries/libfoo/default.nix
$ git add pkgs/development/libraries/libfoo/default.nix
</pre><p>
      You can have a look at the existing Nix expressions under <code class="literal">pkgs/</code> to see how it’s done. Here are some good ones:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        GNU Hello: <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/misc/hello/default.nix" target="_top"><code class="literal">pkgs/applications/misc/hello/default.nix</code></a>. Trivial package, which specifies some <code class="literal">meta</code> attributes which is good practice.
       </p></li><li class="listitem"><p>
        GNU cpio: <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/tools/archivers/cpio/default.nix" target="_top"><code class="literal">pkgs/tools/archivers/cpio/default.nix</code></a>. Also a simple package. The generic builder in <code class="literal">stdenv</code> does everything for you. It has no dependencies beyond <code class="literal">stdenv</code>.
       </p></li><li class="listitem"><p>
        GNU Multiple Precision arithmetic library (GMP): <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/libraries/gmp/5.1.x.nix" target="_top"><code class="literal">pkgs/development/libraries/gmp/5.1.x.nix</code></a>. Also done by the generic builder, but has a dependency on <code class="literal">m4</code>.
       </p></li><li class="listitem"><p>
        Pan, a GTK-based newsreader: <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/networking/newsreaders/pan/default.nix" target="_top"><code class="literal">pkgs/applications/networking/newsreaders/pan/default.nix</code></a>. Has an optional dependency on <code class="literal">gtkspell</code>, which is only built if <code class="literal">spellCheck</code> is <code class="literal">true</code>.
       </p></li><li class="listitem"><p>
        Apache HTTPD: <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/servers/http/apache-httpd/2.4.nix" target="_top"><code class="literal">pkgs/servers/http/apache-httpd/2.4.nix</code></a>. A bunch of optional features, variable substitutions in the configure flags, a post-install hook, and miscellaneous hackery.
       </p></li><li class="listitem"><p>
        Thunderbird: <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/networking/mailreaders/thunderbird/default.nix" target="_top"><code class="literal">pkgs/applications/networking/mailreaders/thunderbird/default.nix</code></a>. Lots of dependencies.
       </p></li><li class="listitem"><p>
        JDiskReport, a Java utility: <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/tools/misc/jdiskreport/default.nix" target="_top"><code class="literal">pkgs/tools/misc/jdiskreport/default.nix</code></a>. Nixpkgs doesn’t have a decent <code class="literal">stdenv</code> for Java yet so this is pretty ad-hoc.
       </p></li><li class="listitem"><p>
        XML::Simple, a Perl module: <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/perl-packages.nix" target="_top"><code class="literal">pkgs/top-level/perl-packages.nix</code></a> (search for the <code class="literal">XMLSimple</code> attribute). Most Perl modules are so simple to build that they are defined directly in <code class="literal">perl-packages.nix</code>; no need to make a separate file for them.
       </p></li><li class="listitem"><p>
        Adobe Reader: <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/misc/adobe-reader/default.nix" target="_top"><code class="literal">pkgs/applications/misc/adobe-reader/default.nix</code></a>. Shows how binary-only packages can be supported. In particular the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/misc/adobe-reader/builder.sh" target="_top">builder</a> uses <code class="literal">patchelf</code> to set the RUNPATH and ELF interpreter of the executables so that the right libraries are found at runtime.
       </p></li></ul></div><p>
      Some notes:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        All <a class="link" href="#chap-meta" title="Chapter 7. Meta-attributes"><code class="literal">meta</code></a> attributes are optional, but it’s still a good idea to provide at least the <code class="literal">description</code>, <code class="literal">homepage</code> and <a class="link" href="#sec-meta-license" title="7.2. Licenses"><code class="literal">license</code></a>.
       </p></li><li class="listitem"><p>
        You can use <code class="literal">nix-prefetch-url url</code> to get the SHA-256 hash of source distributions. There are similar commands as <code class="literal">nix-prefetch-git</code> and <code class="literal">nix-prefetch-hg</code> available in <code class="literal">nix-prefetch-scripts</code> package.
       </p></li><li class="listitem"><p>
        A list of schemes for <code class="literal">mirror://</code> URLs can be found in <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/build-support/fetchurl/mirrors.nix" target="_top"><code class="literal">pkgs/build-support/fetchurl/mirrors.nix</code></a>.
       </p></li></ul></div><p>
      The exact syntax and semantics of the Nix expression language, including the built-in function, are described in the Nix manual in the <a class="link" href="https://hydra.nixos.org/job/nix/trunk/tarball/latest/download-by-type/doc/manual/#chap-writing-nix-expressions" target="_top">chapter on writing Nix expressions</a>.
     </p></li><li class="listitem"><p>
      Add a call to the function defined in the previous step to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/all-packages.nix" target="_top"><code class="literal">pkgs/top-level/all-packages.nix</code></a> with some descriptive name for the variable, e.g. <code class="literal">libfoo</code>.
     </p><pre class="programlisting">
$ emacs pkgs/top-level/all-packages.nix
</pre><p>
      The attributes in that file are sorted by category (like <span class="quote">“<span class="quote">Development / Libraries</span>”</span>) that more-or-less correspond to the directory structure of Nixpkgs, and then by attribute name.
     </p></li><li class="listitem"><p>
      To test whether the package builds, run the following command from the root of the nixpkgs source tree:
     </p><pre class="programlisting">
$ nix-build -A libfoo
</pre><p>
      where <code class="literal">libfoo</code> should be the variable name defined in the previous step. You may want to add the flag <code class="literal">-K</code> to keep the temporary build directory in case something fails. If the build succeeds, a symlink <code class="literal">./result</code> to the package in the Nix store is created.
     </p></li><li class="listitem"><p>
      If you want to install the package into your profile (optional), do
     </p><pre class="programlisting">
$ nix-env -f . -iA libfoo
</pre></li><li class="listitem"><p>
      Optionally commit the new package and open a pull request <a class="link" href="https://github.com/NixOS/nixpkgs/pulls" target="_top">to nixpkgs</a>, or use <a class="link" href="https://discourse.nixos.org/t/about-the-patches-category/477" target="_top">the Patches category</a> on Discourse for sending a patch without a GitHub account.
     </p></li></ol></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-conventions"></a>Chapter 18. Coding conventions</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#sec-syntax">18.1. Syntax</a></span></dt><dt><span class="section"><a href="#sec-package-naming">18.2. Package naming</a></span></dt><dt><span class="section"><a href="#sec-organisation">18.3. File naming and organisation</a></span></dt><dt><span class="section"><a href="#sec-sources">18.4. Fetching Sources</a></span></dt><dt><span class="section"><a href="#sec-source-hashes">18.5. Obtaining source hash</a></span></dt><dt><span class="section"><a href="#sec-patches">18.6. Patches</a></span></dt><dt><span class="section"><a href="#sec-package-tests">18.7. Package tests</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-syntax"></a>18.1. Syntax</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       Use 2 spaces of indentation per indentation level in Nix expressions, 4 spaces in shell scripts.
      </p></li><li class="listitem"><p>
       Do not use tab characters, i.e. configure your editor to use soft tabs. For instance, use <code class="literal">(setq-default indent-tabs-mode nil)</code> in Emacs. Everybody has different tab settings so it’s asking for trouble.
      </p></li><li class="listitem"><p>
       Use <code class="literal">lowerCamelCase</code> for variable names, not <code class="literal">UpperCamelCase</code>. Note, this rule does not apply to package attribute names, which instead follow the rules in <a class="xref" href="#sec-package-naming" title="18.2. Package naming">Section 18.2, “Package naming”</a>.
      </p></li><li class="listitem"><p>
       Function calls with attribute set arguments are written as
      </p><pre class="programlisting">
foo {
  arg = ...;
}
</pre><p>
       not
      </p><pre class="programlisting">
foo
{
  arg = ...;
}
</pre><p>
       Also fine is
      </p><pre class="programlisting">
foo { arg = ...; }
</pre><p>
       if it’s a short call.
      </p></li><li class="listitem"><p>
       In attribute sets or lists that span multiple lines, the attribute names or list elements should be aligned:
      </p><pre class="programlisting">
# A long list.
list = [
  elem1
  elem2
  elem3
];

# A long attribute set.
attrs = {
  attr1 = short_expr;
  attr2 =
    if true then big_expr else big_expr;
};

# Combined
listOfAttrs = [
  {
    attr1 = 3;
    attr2 = "fff";
  }
  {
    attr1 = 5;
    attr2 = "ggg";
  }
];
</pre></li><li class="listitem"><p>
       Short lists or attribute sets can be written on one line:
      </p><pre class="programlisting">
# A short list.
list = [ elem1 elem2 elem3 ];

# A short set.
attrs = { x = 1280; y = 1024; };
</pre></li><li class="listitem"><p>
       Breaking in the middle of a function argument can give hard-to-read code, like
      </p><pre class="programlisting">
someFunction { x = 1280;
  y = 1024; } otherArg
  yetAnotherArg
</pre><p>
       (especially if the argument is very large, spanning multiple lines).
      </p><p>
       Better:
      </p><pre class="programlisting">
someFunction
  { x = 1280; y = 1024; }
  otherArg
  yetAnotherArg
</pre><p>
       or
      </p><pre class="programlisting">
let res = { x = 1280; y = 1024; };
in someFunction res otherArg yetAnotherArg
</pre></li><li class="listitem"><p>
       The bodies of functions, asserts, and withs are not indented to prevent a lot of superfluous indentation levels, i.e.
      </p><pre class="programlisting">
{ arg1, arg2 }:
assert system == "i686-linux";
stdenv.mkDerivation { ...
</pre><p>
       not
      </p><pre class="programlisting">
{ arg1, arg2 }:
  assert system == "i686-linux";
    stdenv.mkDerivation { ...
</pre></li><li class="listitem"><p>
       Function formal arguments are written as:
      </p><pre class="programlisting">
{ arg1, arg2, arg3 }:
</pre><p>
       but if they don’t fit on one line they’re written as:
      </p><pre class="programlisting">
{ arg1, arg2, arg3
, arg4, ...
, # Some comment...
  argN
}:
</pre></li><li class="listitem"><p>
       Functions should list their expected arguments as precisely as possible. That is, write
      </p><pre class="programlisting">
{ stdenv, fetchurl, perl }: ...
</pre><p>
       instead of
      </p><pre class="programlisting">
args: with args; ...
</pre><p>
       or
      </p><pre class="programlisting">
{ stdenv, fetchurl, perl, ... }: ...
</pre><p>
       For functions that are truly generic in the number of arguments (such as wrappers around <code class="literal">mkDerivation</code>) that have some required arguments, you should write them using an <code class="literal">@</code>-pattern:
      </p><pre class="programlisting">
{ stdenv, doCoverageAnalysis ? false, ... } @ args:

stdenv.mkDerivation (args // {
  ... if doCoverageAnalysis then "bla" else "" ...
})
</pre><p>
       instead of
      </p><pre class="programlisting">
args:

args.stdenv.mkDerivation (args // {
  ... if args ? doCoverageAnalysis &amp;&amp; args.doCoverageAnalysis then "bla" else "" ...
})
</pre></li><li class="listitem"><p>
       Unnecessary string conversions should be avoided. Do
      </p><pre class="programlisting">
rev = version;
</pre><p>
       instead of
      </p><pre class="programlisting">
rev = "${version}";
</pre></li><li class="listitem"><p>
       Arguments should be listed in the order they are used, with the exception of <code class="literal">lib</code>, which always goes first.
      </p></li><li class="listitem"><p>
       The top-level <code class="literal">lib</code> must be used in the master and 21.05 branch over its alias <code class="literal">stdenv.lib</code> as it now causes evaluation errors when aliases are disabled which is the case for ofborg. <code class="literal">lib</code> is unrelated to <code class="literal">stdenv</code>, and so <code class="literal">stdenv.lib</code> should only be used as a convenience alias when developing locally to avoid having to modify the function inputs just to test something out.
      </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-package-naming"></a>18.2. Package naming</h2></div></div></div><p>
     The key words <span class="emphasis"><em>must</em></span>, <span class="emphasis"><em>must not</em></span>, <span class="emphasis"><em>required</em></span>, <span class="emphasis"><em>shall</em></span>, <span class="emphasis"><em>shall not</em></span>, <span class="emphasis"><em>should</em></span>, <span class="emphasis"><em>should not</em></span>, <span class="emphasis"><em>recommended</em></span>, <span class="emphasis"><em>may</em></span>, and <span class="emphasis"><em>optional</em></span> in this section are to be interpreted as described in <a class="link" href="https://tools.ietf.org/html/rfc2119" target="_top">RFC 2119</a>. Only <span class="emphasis"><em>emphasized</em></span> words are to be interpreted in this way.
    </p><p>
     In Nixpkgs, there are generally three different names associated with a package:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       The <code class="literal">name</code> attribute of the derivation (excluding the version part). This is what most users see, in particular when using <code class="literal">nix-env</code>.
      </p></li><li class="listitem"><p>
       The variable name used for the instantiated package in <code class="literal">all-packages.nix</code>, and when passing it as a dependency to other functions. Typically this is called the <span class="emphasis"><em>package attribute name</em></span>. This is what Nix expression authors see. It can also be used when installing using <code class="literal">nix-env -iA</code>.
      </p></li><li class="listitem"><p>
       The filename for (the directory containing) the Nix expression.
      </p></li></ul></div><p>
     Most of the time, these are the same. For instance, the package <code class="literal">e2fsprogs</code> has a <code class="literal">name</code> attribute <code class="literal">"e2fsprogs-version"</code>, is bound to the variable name <code class="literal">e2fsprogs</code> in <code class="literal">all-packages.nix</code>, and the Nix expression is in <code class="literal">pkgs/os-specific/linux/e2fsprogs/default.nix</code>.
    </p><p>
     There are a few naming guidelines:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       The <code class="literal">name</code> attribute <span class="emphasis"><em>should</em></span> be identical to the upstream package name.
      </p></li><li class="listitem"><p>
       The <code class="literal">name</code> attribute <span class="emphasis"><em>must not</em></span> contain uppercase letters — e.g., <code class="literal">"mplayer-1.0rc2"</code> instead of <code class="literal">"MPlayer-1.0rc2"</code>.
      </p></li><li class="listitem"><p>
       The version part of the <code class="literal">name</code> attribute <span class="emphasis"><em>must</em></span> start with a digit (following a dash) — e.g., <code class="literal">"hello-0.3.1rc2"</code>.
      </p></li><li class="listitem"><p>
       If a package is not a release but a commit from a repository, then the version part of the name <span class="emphasis"><em>must</em></span> be the date of that (fetched) commit. The date <span class="emphasis"><em>must</em></span> be in <code class="literal">"YYYY-MM-DD"</code> format. Also append <code class="literal">"unstable"</code> to the name - e.g., <code class="literal">"pkgname-unstable-2014-09-23"</code>.
      </p></li><li class="listitem"><p>
       Dashes in the package name <span class="emphasis"><em>should</em></span> be preserved in new variable names, rather than converted to underscores or camel cased — e.g., <code class="literal">http-parser</code> instead of <code class="literal">http_parser</code> or <code class="literal">httpParser</code>. The hyphenated style is preferred in all three package names.
      </p></li><li class="listitem"><p>
       If there are multiple versions of a package, this <span class="emphasis"><em>should</em></span> be reflected in the variable names in <code class="literal">all-packages.nix</code>, e.g. <code class="literal">json-c-0-9</code> and <code class="literal">json-c-0-11</code>. If there is an obvious <span class="quote">“<span class="quote">default</span>”</span> version, make an attribute like <code class="literal">json-c = json-c-0-9;</code>. See also <a class="xref" href="#sec-versioning" title="18.3.2. Versioning">Section 18.3.2, “Versioning”</a>
      </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-organisation"></a>18.3. File naming and organisation</h2></div></div></div><p>
     Names of files and directories should be in lowercase, with dashes between words — not in camel case. For instance, it should be <code class="literal">all-packages.nix</code>, not <code class="literal">allPackages.nix</code> or <code class="literal">AllPackages.nix</code>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-hierarchy"></a>18.3.1. Hierarchy</h3></div></div></div><p>
      Each package should be stored in its own directory somewhere in the <code class="literal">pkgs/</code> tree, i.e. in <code class="literal">pkgs/category/subcategory/.../pkgname</code>. Below are some rules for picking the right category for a package. Many packages fall under several categories; what matters is the <span class="emphasis"><em>primary</em></span> purpose of a package. For example, the <code class="literal">libxml2</code> package builds both a library and some tools; but it’s a library foremost, so it goes under <code class="literal">pkgs/development/libraries</code>.
     </p><p>
      When in doubt, consider refactoring the <code class="literal">pkgs/</code> tree, e.g. creating new categories or splitting up an existing category.
     </p><p>
      <span class="strong"><strong>If it’s used to support <span class="emphasis"><em>software development</em></span>:</strong></span>
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <span class="strong"><strong>If it’s a <span class="emphasis"><em>library</em></span> used by other packages:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">development/libraries</code> (e.g. <code class="literal">libxml2</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s a <span class="emphasis"><em>compiler</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">development/compilers</code> (e.g. <code class="literal">gcc</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s an <span class="emphasis"><em>interpreter</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">development/interpreters</code> (e.g. <code class="literal">guile</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s a (set of) development <span class="emphasis"><em>tool(s)</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
          <span class="strong"><strong>If it’s a <span class="emphasis"><em>parser generator</em></span> (including lexers):</strong></span>
         </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
            <code class="literal">development/tools/parsing</code> (e.g. <code class="literal">bison</code>, <code class="literal">flex</code>)
           </p></li></ul></div></li><li class="listitem"><p>
          <span class="strong"><strong>If it’s a <span class="emphasis"><em>build manager</em></span>:</strong></span>
         </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
            <code class="literal">development/tools/build-managers</code> (e.g. <code class="literal">gnumake</code>)
           </p></li></ul></div></li><li class="listitem"><p>
          <span class="strong"><strong>Else:</strong></span>
         </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
            <code class="literal">development/tools/misc</code> (e.g. <code class="literal">binutils</code>)
           </p></li></ul></div></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>Else:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">development/misc</code>
         </p></li></ul></div></li></ul></div><p>
      <span class="strong"><strong>If it’s a (set of) <span class="emphasis"><em>tool(s)</em></span>:</strong></span>
     </p><p>
      (A tool is a relatively small program, especially one intended to be used non-interactively.)
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <span class="strong"><strong>If it’s for <span class="emphasis"><em>networking</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">tools/networking</code> (e.g. <code class="literal">wget</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s for <span class="emphasis"><em>text processing</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">tools/text</code> (e.g. <code class="literal">diffutils</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s a <span class="emphasis"><em>system utility</em></span>, i.e., something related or essential to the operation of a system:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">tools/system</code> (e.g. <code class="literal">cron</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s an <span class="emphasis"><em>archiver</em></span> (which may include a compression function):</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">tools/archivers</code> (e.g. <code class="literal">zip</code>, <code class="literal">tar</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s a <span class="emphasis"><em>compression</em></span> program:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">tools/compression</code> (e.g. <code class="literal">gzip</code>, <code class="literal">bzip2</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s a <span class="emphasis"><em>security</em></span>-related program:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">tools/security</code> (e.g. <code class="literal">nmap</code>, <code class="literal">gnupg</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>Else:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">tools/misc</code>
         </p></li></ul></div></li></ul></div><p>
      <span class="strong"><strong>If it’s a <span class="emphasis"><em>shell</em></span>:</strong></span>
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">shells</code> (e.g. <code class="literal">bash</code>)
       </p></li></ul></div><p>
      <span class="strong"><strong>If it’s a <span class="emphasis"><em>server</em></span>:</strong></span>
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <span class="strong"><strong>If it’s a web server:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">servers/http</code> (e.g. <code class="literal">apache-httpd</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s an implementation of the X Windowing System:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">servers/x11</code> (e.g. <code class="literal">xorg</code> — this includes the client libraries and programs)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>Else:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">servers/misc</code>
         </p></li></ul></div></li></ul></div><p>
      <span class="strong"><strong>If it’s a <span class="emphasis"><em>desktop environment</em></span>:</strong></span>
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">desktops</code> (e.g. <code class="literal">kde</code>, <code class="literal">gnome</code>, <code class="literal">enlightenment</code>)
       </p></li></ul></div><p>
      <span class="strong"><strong>If it’s a <span class="emphasis"><em>window manager</em></span>:</strong></span>
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">applications/window-managers</code> (e.g. <code class="literal">awesome</code>, <code class="literal">stumpwm</code>)
       </p></li></ul></div><p>
      <span class="strong"><strong>If it’s an <span class="emphasis"><em>application</em></span>:</strong></span>
     </p><p>
      A (typically large) program with a distinct user interface, primarily used interactively.
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <span class="strong"><strong>If it’s a <span class="emphasis"><em>version management system</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">applications/version-management</code> (e.g. <code class="literal">subversion</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s a <span class="emphasis"><em>terminal emulator</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">applications/terminal-emulators</code> (e.g. <code class="literal">alacritty</code> or <code class="literal">rxvt</code> or <code class="literal">termite</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s for <span class="emphasis"><em>video playback / editing</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">applications/video</code> (e.g. <code class="literal">vlc</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s for <span class="emphasis"><em>graphics viewing / editing</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">applications/graphics</code> (e.g. <code class="literal">gimp</code>)
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s for <span class="emphasis"><em>networking</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
          <span class="strong"><strong>If it’s a <span class="emphasis"><em>mailreader</em></span>:</strong></span>
         </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
            <code class="literal">applications/networking/mailreaders</code> (e.g. <code class="literal">thunderbird</code>)
           </p></li></ul></div></li><li class="listitem"><p>
          <span class="strong"><strong>If it’s a <span class="emphasis"><em>newsreader</em></span>:</strong></span>
         </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
            <code class="literal">applications/networking/newsreaders</code> (e.g. <code class="literal">pan</code>)
           </p></li></ul></div></li><li class="listitem"><p>
          <span class="strong"><strong>If it’s a <span class="emphasis"><em>web browser</em></span>:</strong></span>
         </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
            <code class="literal">applications/networking/browsers</code> (e.g. <code class="literal">firefox</code>)
           </p></li></ul></div></li><li class="listitem"><p>
          <span class="strong"><strong>Else:</strong></span>
         </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
            <code class="literal">applications/networking/misc</code>
           </p></li></ul></div></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>Else:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">applications/misc</code>
         </p></li></ul></div></li></ul></div><p>
      <span class="strong"><strong>If it’s <span class="emphasis"><em>data</em></span> (i.e., does not have a straight-forward executable semantics):</strong></span>
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <span class="strong"><strong>If it’s a <span class="emphasis"><em>font</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">data/fonts</code>
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s an <span class="emphasis"><em>icon theme</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">data/icons</code>
         </p></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s related to <span class="emphasis"><em>SGML/XML processing</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
          <span class="strong"><strong>If it’s an <span class="emphasis"><em>XML DTD</em></span>:</strong></span>
         </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
            <code class="literal">data/sgml+xml/schemas/xml-dtd</code> (e.g. <code class="literal">docbook</code>)
           </p></li></ul></div></li><li class="listitem"><p>
          <span class="strong"><strong>If it’s an <span class="emphasis"><em>XSLT stylesheet</em></span>:</strong></span>
         </p><p>
          (Okay, these are executable…)
         </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
            <code class="literal">data/sgml+xml/stylesheets/xslt</code> (e.g. <code class="literal">docbook-xsl</code>)
           </p></li></ul></div></li></ul></div></li><li class="listitem"><p>
        <span class="strong"><strong>If it’s a <span class="emphasis"><em>theme</em></span> for a <span class="emphasis"><em>desktop environment</em></span>, a <span class="emphasis"><em>window manager</em></span> or a <span class="emphasis"><em>display manager</em></span>:</strong></span>
       </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
          <code class="literal">data/themes</code>
         </p></li></ul></div></li></ul></div><p>
      <span class="strong"><strong>If it’s a <span class="emphasis"><em>game</em></span>:</strong></span>
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">games</code>
       </p></li></ul></div><p>
      <span class="strong"><strong>Else:</strong></span>
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">misc</code>
       </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-versioning"></a>18.3.2. Versioning</h3></div></div></div><p>
      Because every version of a package in Nixpkgs creates a potential maintenance burden, old versions of a package should not be kept unless there is a good reason to do so. For instance, Nixpkgs contains several versions of GCC because other packages don’t build with the latest version of GCC. Other examples are having both the latest stable and latest pre-release version of a package, or to keep several major releases of an application that differ significantly in functionality.
     </p><p>
      If there is only one version of a package, its Nix expression should be named <code class="literal">e2fsprogs/default.nix</code>. If there are multiple versions, this should be reflected in the filename, e.g. <code class="literal">e2fsprogs/1.41.8.nix</code> and <code class="literal">e2fsprogs/1.41.9.nix</code>. The version in the filename should leave out unnecessary detail. For instance, if we keep the latest Firefox 2.0.x and 3.5.x versions in Nixpkgs, they should be named <code class="literal">firefox/2.0.nix</code> and <code class="literal">firefox/3.5.nix</code>, respectively (which, at a given point, might contain versions <code class="literal">2.0.0.20</code> and <code class="literal">3.5.4</code>). If a version requires many auxiliary files, you can use a subdirectory for each version, e.g. <code class="literal">firefox/2.0/default.nix</code> and <code class="literal">firefox/3.5/default.nix</code>.
     </p><p>
      All versions of a package <span class="emphasis"><em>must</em></span> be included in <code class="literal">all-packages.nix</code> to make sure that they evaluate correctly.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-sources"></a>18.4. Fetching Sources</h2></div></div></div><p>
     There are multiple ways to fetch a package source in nixpkgs. The general guideline is that you should package reproducible sources with a high degree of availability. Right now there is only one fetcher which has mirroring support and that is <code class="literal">fetchurl</code>. Note that you should also prefer protocols which have a corresponding proxy environment variable.
    </p><p>
     You can find many source fetch helpers in <code class="literal">pkgs/build-support/fetch*</code>.
    </p><p>
     In the file <code class="literal">pkgs/top-level/all-packages.nix</code> you can find fetch helpers, these have names on the form <code class="literal">fetchFrom*</code>. The intention of these are to provide snapshot fetches but using the same api as some of the version controlled fetchers from <code class="literal">pkgs/build-support/</code>. As an example going from bad to good:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       Bad: Uses <code class="literal">git://</code> which won’t be proxied.
      </p><pre class="programlisting">
src = fetchgit {
  url = "git://github.com/NixOS/nix.git";
  rev = "1f795f9f44607cc5bec70d1300150bfefcef2aae";
  sha256 = "1cw5fszffl5pkpa6s6wjnkiv6lm5k618s32sp60kvmvpy7a2v9kg";
}
</pre></li><li class="listitem"><p>
       Better: This is ok, but an archive fetch will still be faster.
      </p><pre class="programlisting">
src = fetchgit {
  url = "https://github.com/NixOS/nix.git";
  rev = "1f795f9f44607cc5bec70d1300150bfefcef2aae";
  sha256 = "1cw5fszffl5pkpa6s6wjnkiv6lm5k618s32sp60kvmvpy7a2v9kg";
}
</pre></li><li class="listitem"><p>
       Best: Fetches a snapshot archive and you get the rev you want.
      </p><pre class="programlisting">
src = fetchFromGitHub {
  owner = "NixOS";
  repo = "nix";
  rev = "1f795f9f44607cc5bec70d1300150bfefcef2aae";
  sha256 = "1i2yxndxb6yc9l6c99pypbd92lfq5aac4klq7y2v93c9qvx2cgpc";
}
</pre><p>
       Find the value to put as <code class="literal">sha256</code> by running <code class="literal">nix run -f '&lt;nixpkgs&gt;' nix-prefetch-github -c nix-prefetch-github --rev 1f795f9f44607cc5bec70d1300150bfefcef2aae NixOS nix</code> or <code class="literal">nix-prefetch-url --unpack https://github.com/NixOS/nix/archive/1f795f9f44607cc5bec70d1300150bfefcef2aae.tar.gz</code>.
      </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-source-hashes"></a>18.5. Obtaining source hash</h2></div></div></div><p>
     Preferred source hash type is sha256. There are several ways to get it.
    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
       Prefetch URL (with <code class="literal">nix-prefetch-XXX URL</code>, where <code class="literal">XXX</code> is one of <code class="literal">url</code>, <code class="literal">git</code>, <code class="literal">hg</code>, <code class="literal">cvs</code>, <code class="literal">bzr</code>, <code class="literal">svn</code>). Hash is printed to stdout.
      </p></li><li class="listitem"><p>
       Prefetch by package source (with <code class="literal">nix-prefetch-url '&lt;nixpkgs&gt;' -A PACKAGE.src</code>, where <code class="literal">PACKAGE</code> is package attribute name). Hash is printed to stdout.
      </p><p>
       This works well when you’ve upgraded existing package version and want to find out new hash, but is useless if package can’t be accessed by attribute or package has multiple sources (<code class="literal">.srcs</code>, architecture-dependent sources, etc).
      </p></li><li class="listitem"><p>
       Upstream provided hash: use it when upstream provides <code class="literal">sha256</code> or <code class="literal">sha512</code> (when upstream provides <code class="literal">md5</code>, don’t use it, compute <code class="literal">sha256</code> instead).
      </p><p>
       A little nuance is that <code class="literal">nix-prefetch-*</code> tools produce hash encoded with <code class="literal">base32</code>, but upstream usually provides hexadecimal (<code class="literal">base16</code>) encoding. Fetchers understand both formats. Nixpkgs does not standardize on any one format.
      </p><p>
       You can convert between formats with nix-hash, for example:
      </p><pre class="programlisting">
$ nix-hash --type sha256 --to-base32 HASH
</pre></li><li class="listitem"><p>
       Extracting hash from local source tarball can be done with <code class="literal">sha256sum</code>. Use <code class="literal">nix-prefetch-url file:///path/to/tarball</code> if you want base32 hash.
      </p></li><li class="listitem"><p>
       Fake hash: set fake hash in package expression, perform build and extract correct hash from error Nix prints.
      </p><p>
       For package updates it is enough to change one symbol to make hash fake. For new packages, you can use <code class="literal">lib.fakeSha256</code>, <code class="literal">lib.fakeSha512</code> or any other fake hash.
      </p><p>
       This is last resort method when reconstructing source URL is non-trivial and <code class="literal">nix-prefetch-url -A</code> isn’t applicable (for example, <a class="link" href="https://github.com/NixOS/nixpkgs/blob/d2ab091dd308b99e4912b805a5eb088dd536adb9/pkgs/applications/video/kodi/default.nix#L73%22" target="_top">one of <code class="literal">kodi</code> dependencies</a>). The easiest way then would be replace hash with a fake one and rebuild. Nix build will fail and error message will contain desired hash.
      </p></li></ol></div><div class="warning"><h3 class="title">Warning</h3><p>
      This method has security problems. Check below for details.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sec-source-hashes-security"></a>18.5.1. Obtaining hashes securely</h3></div></div></div><p>
      Let’s say Man-in-the-Middle (MITM) sits close to your network. Then instead of fetching source you can fetch malware, and instead of source hash you get hash of malware. Here are security considerations for this scenario:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <code class="literal">http://</code> URLs are not secure to prefetch hash from;
       </p></li><li class="listitem"><p>
        hashes from upstream (in method 3) should be obtained via secure protocol;
       </p></li><li class="listitem"><p>
        <code class="literal">https://</code> URLs are secure in methods 1, 2, 3;
       </p></li><li class="listitem"><p>
        <code class="literal">https://</code> URLs are not secure in method 5. When obtaining hashes with fake hash method, TLS checks are disabled. So refetch source hash from several different networks to exclude MITM scenario. Alternatively, use fake hash method to make Nix error, but instead of extracting hash from error, extract <code class="literal">https://</code> URL and prefetch it with method 1.
       </p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-patches"></a>18.6. Patches</h2></div></div></div><p>
     Patches available online should be retrieved using <code class="literal">fetchpatch</code>.
    </p><pre class="programlisting">
patches = [
  (fetchpatch {
    name = "fix-check-for-using-shared-freetype-lib.patch";
    url = "http://git.ghostscript.com/?p=ghostpdl.git;a=patch;h=8f5d285";
    sha256 = "1f0k043rng7f0rfl9hhb89qzvvksqmkrikmm38p61yfx51l325xr";
  })
];
</pre><p>
     Otherwise, you can add a <code class="literal">.patch</code> file to the <code class="literal">nixpkgs</code> repository. In the interest of keeping our maintenance burden to a minimum, only patches that are unique to <code class="literal">nixpkgs</code> should be added in this way.
    </p><pre class="programlisting">
patches = [ ./0001-changes.patch ];
</pre><p>
     If you do need to do create this sort of patch file, one way to do so is with git:
    </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
       Move to the root directory of the source code you’re patching.
      </p><pre class="programlisting">
$ cd the/program/source
</pre></li><li class="listitem"><p>
       If a git repository is not already present, create one and stage all of the source files.
      </p><pre class="programlisting">
$ git init
$ git add .
</pre></li><li class="listitem"><p>
       Edit some files to make whatever changes need to be included in the patch.
      </p></li><li class="listitem"><p>
       Use git to create a diff, and pipe the output to a patch file:
      </p><pre class="programlisting">
$ git diff &gt; nixpkgs/pkgs/the/package/0001-changes.patch
</pre></li></ol></div><p>
     If a patch is available online but does not cleanly apply, it can be modified in some fixed ways by using additional optional arguments for <code class="literal">fetchpatch</code>:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       <code class="literal">stripLen</code>: Remove the first <code class="literal">stripLen</code> components of pathnames in the patch.
      </p></li><li class="listitem"><p>
       <code class="literal">extraPrefix</code>: Prefix pathnames by this string.
      </p></li><li class="listitem"><p>
       <code class="literal">excludes</code>: Exclude files matching this pattern.
      </p></li><li class="listitem"><p>
       <code class="literal">includes</code>: Include only files matching this pattern.
      </p></li><li class="listitem"><p>
       <code class="literal">revert</code>: Revert the patch.
      </p></li></ul></div><p>
     Note that because the checksum is computed after applying these effects, using or modifying these arguments will have no effect unless the <code class="literal">sha256</code> argument is changed as well.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="sec-package-tests"></a>18.7. Package tests</h2></div></div></div><p>
     Tests are important to ensure quality and make reviews and automatic updates easy.
    </p><p>
     Nix package tests are a lightweight alternative to <a class="link" href="https://nixos.org/manual/nixos/stable/#sec-nixos-tests" target="_top">NixOS module tests</a>. They can be used to create simple integration tests for packages while the module tests are used to test services or programs with a graphical user interface on a NixOS VM. Unittests that are included in the source code of a package should be executed in the <code class="literal">checkPhase</code>.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-package-tests-writing"></a>18.7.1. Writing package tests</h3></div></div></div><p>
      This is an example using the <code class="literal">phoronix-test-suite</code> package with the current best practices.
     </p><p>
      Add the tests in <code class="literal">passthru.tests</code> to the package definition like this:
     </p><pre class="programlisting">
{ stdenv, lib, fetchurl, callPackage }:

stdenv.mkDerivation {
  …

  passthru.tests = {
    simple-execution = callPackage ./tests.nix { };
  };

  meta = { … };
}
</pre><p>
      Create <code class="literal">tests.nix</code> in the package directory:
     </p><pre class="programlisting">
{ runCommand, phoronix-test-suite }:

let
  inherit (phoronix-test-suite) pname version;
in

runCommand "${pname}-tests" { meta.timeout = 3; }
  ''
    # automatic initial setup to prevent interactive questions
    ${phoronix-test-suite}/bin/phoronix-test-suite enterprise-setup &gt;/dev/null
    # get version of installed program and compare with package version
    if [[ `${phoronix-test-suite}/bin/phoronix-test-suite version` != *"${version}"*  ]]; then
      echo "Error: program version does not match package version"
      exit 1
    fi
    # run dummy command
    ${phoronix-test-suite}/bin/phoronix-test-suite dummy_module.dummy-command &gt;/dev/null
    # needed for Nix to register the command as successful
    touch $out
  ''
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-package-tests-running"></a>18.7.2. Running package tests</h3></div></div></div><p>
      You can run these tests with:
     </p><pre class="programlisting">
$ cd path/to/nixpkgs
$ nix-build -A phoronix-test-suite.tests
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ssec-package-tests-examples"></a>18.7.3. Examples of package tests</h3></div></div></div><p>
      Here are examples of package tests:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/compilers/jasmin/test-assemble-hello-world/default.nix" target="_top">Jasmin compile test</a>
       </p></li><li class="listitem"><p>
        <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/compilers/lobster/test-can-run-hello-world.nix" target="_top">Lobster compile test</a>
       </p></li><li class="listitem"><p>
        <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/python-modules/spacy/annotation-test/default.nix" target="_top">Spacy annotation test</a>
       </p></li><li class="listitem"><p>
        <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/libraries/science/math/libtorch/test/default.nix" target="_top">Libtorch test</a>
       </p></li><li class="listitem"><p>
        <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/libraries/nanopb/default.nix" target="_top">Multiple tests for nanopb</a>
       </p></li></ul></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-submitting-changes"></a>Chapter 19. Submitting changes</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#submitting-changes-making-patches">19.1. Making patches</a></span></dt><dt><span class="section"><a href="#submitting-changes-submitting-changes">19.2. Submitting changes</a></span></dt><dt><span class="section"><a href="#submitting-changes-submitting-security-fixes">19.3. Submitting security fixes</a></span></dt><dt><span class="section"><a href="#submitting-changes-deprecating-packages">19.4. Deprecating/removing packages</a></span></dt><dt><span class="section"><a href="#submitting-changes-pull-request-template">19.5. Pull Request Template</a></span></dt><dt><span class="section"><a href="#submitting-changes-hotfixing-pull-requests">19.6. Hotfixing pull requests</a></span></dt><dt><span class="section"><a href="#submitting-changes-commit-policy">19.7. Commit policy</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="submitting-changes-making-patches"></a>19.1. Making patches</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       Read <a class="link" href="https://nixos.org/nixpkgs/manual/" target="_top">Manual (How to write packages for Nix)</a>.
      </p></li><li class="listitem"><p>
       Fork <a class="link" href="https://github.com/nixos/nixpkgs/" target="_top">the Nixpkgs repository</a> on GitHub.
      </p></li><li class="listitem"><p>
       Create a branch for your future fix.
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
         You can make branch from a commit of your local <code class="literal">nixos-version</code>. That will help you to avoid additional local compilations. Because you will receive packages from binary cache. For example
        </p><pre class="programlisting">
$ nixos-version --hash
0998212
$ git checkout 0998212
$ git checkout -b 'fix/pkg-name-update'
</pre></li><li class="listitem"><p>
         Please avoid working directly on the <code class="literal">master</code> branch.
        </p></li></ul></div></li><li class="listitem"><p>
       Make commits of logical units.
      </p></li><li class="listitem"><p>
       If you removed pkgs or made some major NixOS changes, write about it in the release notes for the next stable release. For example <code class="literal">nixos/doc/manual/release-notes/rl-2003.xml</code>.
      </p></li><li class="listitem"><p>
       Check for unnecessary whitespace with <code class="literal">git diff --check</code> before committing.
      </p></li><li class="listitem"><p>
       Format the commit in a following way:
      </p><pre class="programlisting">
(pkg-name | nixos/&lt;module&gt;): (from -&gt; to | init at version | refactor | etc)
Additional information.
</pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         Examples:
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
           <code class="literal">nginx: init at 2.0.1</code>
          </p></li><li class="listitem"><p>
           <code class="literal">firefox: 54.0.1 -&gt; 55.0</code>
          </p></li><li class="listitem"><p>
           <code class="literal">nixos/hydra: add bazBaz option</code>
          </p></li><li class="listitem"><p>
           <code class="literal">nixos/nginx: refactor config generation</code>
          </p></li></ul></div></li></ul></div></li><li class="listitem"><p>
       Test your changes. If you work with
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
         nixpkgs:
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
           update pkg
          </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
             <code class="literal">nix-env -i pkg-name -f &lt;path to your local nixpkgs folder&gt;</code>
            </p></li></ul></div></li><li class="listitem"><p>
           add pkg
          </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
             Make sure it’s in <code class="literal">pkgs/top-level/all-packages.nix</code>
            </p></li><li class="listitem"><p>
             <code class="literal">nix-env -i pkg-name -f &lt;path to your local nixpkgs folder&gt;</code>
            </p></li></ul></div></li><li class="listitem"><p>
           <span class="emphasis"><em>If you don’t want to install pkg in you profile</em></span>.
          </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
             <code class="literal">nix-build -A pkg-attribute-name &lt;path to your local nixpkgs folder&gt;/default.nix</code> and check results in the folder <code class="literal">result</code>. It will appear in the same directory where you did <code class="literal">nix-build</code>.
            </p></li></ul></div></li><li class="listitem"><p>
           If you did <code class="literal">nix-env -i pkg-name</code> you can do <code class="literal">nix-env -e pkg-name</code> to uninstall it from your system.
          </p></li></ul></div></li><li class="listitem"><p>
         NixOS and its modules:
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
           You can add new module to your NixOS configuration file (usually it’s <code class="literal">/etc/nixos/configuration.nix</code>). And do <code class="literal">sudo nixos-rebuild test -I nixpkgs=&lt;path to your local nixpkgs folder&gt; --fast</code>.
          </p></li></ul></div></li></ul></div></li><li class="listitem"><p>
       If you have commits <code class="literal">pkg-name: oh, forgot to insert whitespace</code>: squash commits in this case. Use <code class="literal">git rebase -i</code>.
      </p></li><li class="listitem"><p>
       <a class="link" href="https://git-scm.com/book/en/v2/Git-Branching-Rebasing" target="_top">Rebase</a> your branch against current <code class="literal">master</code>.
      </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="submitting-changes-submitting-changes"></a>19.2. Submitting changes</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       Push your changes to your fork of nixpkgs.
      </p></li><li class="listitem"><p>
       Create the pull request
      </p></li><li class="listitem"><p>
       Follow <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md#submitting-changes" target="_top">the contribution guidelines</a>.
      </p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="submitting-changes-submitting-security-fixes"></a>19.3. Submitting security fixes</h2></div></div></div><p>
     Security fixes are submitted in the same way as other changes and thus the same guidelines apply.
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
       If a new version fixing the vulnerability has been released, update the package;
      </p></li><li class="listitem"><p>
       If the security fix comes in the form of a patch and a CVE is available, then add the patch to the Nixpkgs tree, and apply it to the package. The name of the patch should be the CVE identifier, so e.g. <code class="literal">CVE-2019-13636.patch</code>; If a patch is fetched the name needs to be set as well, e.g.:
      </p><pre class="programlisting">
(fetchpatch {
  name = "CVE-2019-11068.patch";
  url = "https://gitlab.gnome.org/GNOME/libxslt/commit/e03553605b45c88f0b4b2980adfbbb8f6fca2fd6.patch";
  sha256 = "0pkpb4837km15zgg6h57bncp66d5lwrlvkr73h0lanywq7zrwhj8";
})
</pre></li></ul></div><p>
     If a security fix applies to both master and a stable release then, similar to regular changes, they are preferably delivered via master first and cherry-picked to the release branch.
    </p><p>
     Critical security fixes may by-pass the staging branches and be delivered directly to release branches such as <code class="literal">master</code> and <code class="literal">release-*</code>.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="submitting-changes-deprecating-packages"></a>19.4. Deprecating/removing packages</h2></div></div></div><p>
     There is currently no policy when to remove a package.
    </p><p>
     Before removing a package, one should try to find a new maintainer or fix smaller issues first.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="steps-to-remove-a-package-from-nixpkgs"></a>19.4.1. Steps to remove a package from Nixpkgs</h3></div></div></div><p>
      We use jbidwatcher as an example for a discontinued project here.
     </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
        Have Nixpkgs checked out locally and up to date.
       </p></li><li class="listitem"><p>
        Create a new branch for your change, e.g. <code class="literal">git checkout -b jbidwatcher</code>
       </p></li><li class="listitem"><p>
        Remove the actual package including its directory, e.g. <code class="literal">rm -rf pkgs/applications/misc/jbidwatcher</code>
       </p></li><li class="listitem"><p>
        Remove the package from the list of all packages (<code class="literal">pkgs/top-level/all-packages.nix</code>).
       </p></li><li class="listitem"><p>
        Add an alias for the package name in <code class="literal">pkgs/top-level/aliases.nix</code> (There is also <code class="literal">pkgs/misc/vim-plugins/aliases.nix</code>. Package sets typically do not have aliases, so we can’t add them there.)
       </p><p>
        For example in this case: <code class="literal">jbidwatcher = throw "jbidwatcher was discontinued in march 2021"; # added 2021-03-15</code>
       </p><p>
        The throw message should explain in short why the package was removed for users that still have it installed.
       </p></li><li class="listitem"><p>
        Test if the changes introduced any issues by running <code class="literal">nix-env -qaP -f . --show-trace</code>. It should show the list of packages without errors.
       </p></li><li class="listitem"><p>
        Commit the changes. Explain again why the package was removed. If it was declared discontinued upstream, add a link to the source.
       </p><pre class="programlisting">
$ git add pkgs/applications/misc/jbidwatcher/default.nix pkgs/top-level/all-packages.nix pkgs/top-level/aliases.nix
$ git commit
</pre><p>
        Example commit message:
       </p><pre class="programlisting">
jbidwatcher: remove

project was discontinued in march 2021. the program does not work anymore because ebay changed the login.

https://web.archive.org/web/20210315205723/http://www.jbidwatcher.com/
</pre></li><li class="listitem"><p>
        Push changes to your GitHub fork with <code class="literal">git push</code>
       </p></li><li class="listitem"><p>
        Create a pull request against Nixpkgs. Mention the package maintainer.
       </p></li></ol></div><p>
      This is how the pull request looks like in this case: <a class="link" href="https://github.com/NixOS/nixpkgs/pull/116470" target="_top">https://github.com/NixOS/nixpkgs/pull/116470</a>
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="submitting-changes-pull-request-template"></a>19.5. Pull Request Template</h2></div></div></div><p>
     The pull request template helps determine what steps have been made for a contribution so far, and will help guide maintainers on the status of a change. The motivation section of the PR should include any extra details the title does not address and link any existing issues related to the pull request.
    </p><p>
     When a PR is created, it will be pre-populated with some checkboxes detailed below:
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="submitting-changes-tested-with-sandbox"></a>19.5.1. Tested using sandboxing</h3></div></div></div><p>
      When sandbox builds are enabled, Nix will setup an isolated environment for each build process. It is used to remove further hidden dependencies set by the build environment to improve reproducibility. This includes access to the network during the build outside of <code class="literal">fetch*</code> functions and files outside the Nix store. Depending on the operating system access to other resources are blocked as well (ex. inter process communication is isolated on Linux); see <a class="link" href="https://nixos.org/nix/manual/#conf-sandbox" target="_top">sandbox</a> in Nix manual for details.
     </p><p>
      Sandboxing is not enabled by default in Nix due to a small performance hit on each build. In pull requests for <a class="link" href="https://github.com/NixOS/nixpkgs/" target="_top">nixpkgs</a> people are asked to test builds with sandboxing enabled (see <code class="literal">Tested using sandboxing</code> in the pull request template) because in<a class="link" href="https://nixos.org/hydra/" target="_top">https://nixos.org/hydra/</a> sandboxing is also used.
     </p><p>
      Depending if you use NixOS or other platforms you can use one of the following methods to enable sandboxing <span class="strong"><strong>before</strong></span> building the package:
     </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
        <span class="strong"><strong>Globally enable sandboxing on NixOS</strong></span>: add the following to <code class="literal">configuration.nix</code>
       </p><pre class="programlisting">
nix.useSandbox = true;
</pre></li><li class="listitem"><p>
        <span class="strong"><strong>Globally enable sandboxing on non-NixOS platforms</strong></span>: add the following to: <code class="literal">/etc/nix/nix.conf</code>
       </p><pre class="programlisting">
sandbox = true
</pre></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="submitting-changes-platform-diversity"></a>19.5.2. Built on platform(s)</h3></div></div></div><p>
      Many Nix packages are designed to run on multiple platforms. As such, it’s important to let the maintainer know which platforms your changes have been tested on. It’s not always practical to test a change on all platforms, and is not required for a pull request to be merged. Only check the systems you tested the build on in this section.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="submitting-changes-nixos-tests"></a>19.5.3. Tested via one or more NixOS test(s) if existing and applicable for the change (look inside nixos/tests)</h3></div></div></div><p>
      Packages with automated tests are much more likely to be merged in a timely fashion because it doesn’t require as much manual testing by the maintainer to verify the functionality of the package. If there are existing tests for the package, they should be run to verify your changes do not break the tests. Tests can only be run on Linux. For more details on writing and running tests, see the <a class="link" href="https://nixos.org/nixos/manual/index.html#sec-nixos-tests" target="_top">section in the NixOS manual</a>.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="submitting-changes-tested-compilation"></a>19.5.4. Tested compilation of all pkgs that depend on this change using <code class="literal">nixpkgs-review</code></h3></div></div></div><p>
      If you are updating a package’s version, you can use nixpkgs-review to make sure all packages that depend on the updated package still compile correctly. The <code class="literal">nixpkgs-review</code> utility can look for and build all dependencies either based on uncommited changes with the <code class="literal">wip</code> option or specifying a github pull request number.
     </p><p>
      review changes from pull request number 12345:
     </p><pre class="programlisting">
nix run nixpkgs.nixpkgs-review -c nixpkgs-review pr 12345
</pre><p>
      review uncommitted changes:
     </p><pre class="programlisting">
nix run nixpkgs.nixpkgs-review -c nixpkgs-review wip
</pre><p>
      review changes from last commit:
     </p><pre class="programlisting">
nix run nixpkgs.nixpkgs-review -c nixpkgs-review rev HEAD
</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="submitting-changes-tested-execution"></a>19.5.5. Tested execution of all binary files (usually in <code class="literal">./result/bin/</code>)</h3></div></div></div><p>
      It’s important to test any executables generated by a build when you change or create a package in nixpkgs. This can be done by looking in <code class="literal">./result/bin</code> and running any files in there, or at a minimum, the main executable for the package. For example, if you make a change to texlive, you probably would only check the binaries associated with the change you made rather than testing all of them.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="submitting-changes-contribution-standards"></a>19.5.6. Meets Nixpkgs contribution standards</h3></div></div></div><p>
      The last checkbox is fits <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md" target="_top">CONTRIBUTING.md</a>. The contributing document has detailed information on standards the Nix community has for commit messages, reviews, licensing of contributions you make to the project, etc... Everyone should read and understand the standards the community has for contributing before submitting a pull request.
     </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="submitting-changes-hotfixing-pull-requests"></a>19.6. Hotfixing pull requests</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       Make the appropriate changes in you branch.
      </p></li><li class="listitem"><p>
       Don’t create additional commits, do
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         <code class="literal">git rebase -i</code>
        </p></li><li class="listitem"><p>
         <code class="literal">git push --force</code> to your branch.
        </p></li></ul></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="submitting-changes-commit-policy"></a>19.7. Commit policy</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       Commits must be sufficiently tested before being merged, both for the master and staging branches.
      </p></li><li class="listitem"><p>
       Hydra builds for master and staging should not be used as testing platform, it’s a build farm for changes that have been already tested.
      </p></li><li class="listitem"><p>
       When changing the bootloader installation process, extra care must be taken. Grub installations cannot be rolled back, hence changes may break people’s installations forever. For any non-trivial change to the bootloader please file a PR asking for review, especially from @edolstra.
      </p></li></ul></div><div class="figure"><a id="idm140737315839152"></a><p class="title"><strong>Figure 19.1. Staging workflow</strong></p><div class="figure-contents"><div class="mediaobject"><img src="media/10b31ca7f016ce921774f44c40fe884399373649.svg" alt="Staging workflow" /></div></div></div><br class="figure-break" /><p>
     <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/.github/workflows/merge-staging.yml" target="_top">This GitHub Action</a> brings changes from <code class="literal">master</code> to <code class="literal">staging-next</code> and from <code class="literal">staging-next</code> to <code class="literal">staging</code> every 6 hours.
    </p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="submitting-changes-master-branch"></a>19.7.1. Master branch</h3></div></div></div><p>
      The <code class="literal">master</code> branch is the main development branch. It should only see non-breaking commits that do not cause mass rebuilds.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="submitting-changes-staging-branch"></a>19.7.2. Staging branch</h3></div></div></div><p>
      The <code class="literal">staging</code> branch is a development branch where mass-rebuilds go. It should only see non-breaking mass-rebuild commits. That means it is not to be used for testing, and changes must have been well tested already. If the branch is already in a broken state, please refrain from adding extra new breakages.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="submitting-changes-staging-next-branch"></a>19.7.3. Staging-next branch</h3></div></div></div><p>
      The <code class="literal">staging-next</code> branch is for stabilizing mass-rebuilds submitted to the <code class="literal">staging</code> branch prior to merging them into <code class="literal">master</code>. Mass-rebuilds should go via the <code class="literal">staging</code> branch. It should only see non-breaking commits that are fixing issues blocking it from being merged into the <code class="literal">master</code> branch.
     </p><p>
      If the branch is already in a broken state, please refrain from adding extra new breakages. Stabilize it for a few days and then merge into master.
     </p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="submitting-changes-stable-release-branches"></a>19.7.4. Stable release branches</h3></div></div></div><p>
      For cherry-picking a commit to a stable release branch (<span class="quote">“<span class="quote">backporting</span>”</span>), use <code class="literal">git cherry-pick -x &lt;original commit&gt;</code> so that the original commit id is included in the commit.
     </p><p>
      Add a reason for the backport by using <code class="literal">git cherry-pick -xe &lt;original commit&gt;</code> instead when it is not obvious from the original commit message. It is not needed when it’s a minor version update that includes security and bug fixes but don’t add new features or when the commit fixes an otherwise broken package.
     </p><p>
      Here is an example of a cherry-picked commit message with good reason description:
     </p><pre class="programlisting">
zfs: Keep trying root import until it works

Works around #11003.

(cherry picked from commit 98b213a11041af39b39473906b595290e2a4e2f9)

Reason: several people cannot boot with ZFS on NVMe
</pre><p>
      Other examples of reasons are:
     </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
        Previously the build would fail due to, e.g., <code class="literal">getaddrinfo</code> not being defined
       </p></li><li class="listitem"><p>
        The previous download links were all broken
       </p></li><li class="listitem"><p>
        Crash when starting on some X11 systems
       </p></li></ul></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-vulnerability-roundup"></a>Chapter 20. Vulnerability Roundup</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#vulnerability-roundup-issues">20.1. Issues</a></span></dt><dt><span class="section"><a href="#vulnerability-roundup-triaging-and-fixing">20.2. Triaging and Fixing</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="vulnerability-roundup-issues"></a>20.1. Issues</h2></div></div></div><p>
     Vulnerable packages in Nixpkgs are managed using issues. Currently opened ones can be found using the following:
    </p><p>
     <a class="link" href="https://github.com/NixOS/nixpkgs/issues?q=is%3Aissue+is%3Aopen+%22Vulnerability+roundup%22" target="_top">github.com/NixOS/nixpkgs/issues?q=is:issue+is:open+<span class="quote">“<span class="quote">Vulnerability+roundup</span>”</span></a>
    </p><p>
     Each issue correspond to a vulnerable version of a package; As a consequence:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       One issue can contain several CVEs;
      </p></li><li class="listitem"><p>
       One CVE can be shared across several issues;
      </p></li><li class="listitem"><p>
       A single package can be concerned by several issues.
      </p></li></ul></div><p>
     A <span class="quote">“<span class="quote">Vulnerability roundup</span>”</span> issue usually respects the following format:
    </p><pre class="programlisting">
&lt;link to relevant package search on search.nix.gsc.io&gt;, &lt;link to relevant files in Nixpkgs on GitHub&gt;

&lt;list of related CVEs, their CVSS score, and the impacted NixOS version&gt;

&lt;list of the scanned Nixpkgs versions&gt;

&lt;list of relevant contributors&gt;
</pre><p>
     Note that there can be an extra comment containing links to previously reported (and still open) issues for the same package.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="vulnerability-roundup-triaging-and-fixing"></a>20.2. Triaging and Fixing</h2></div></div></div><p>
     <span class="strong"><strong>Note</strong></span>: An issue can be a <span class="quote">“<span class="quote">false positive</span>”</span> (i.e. automatically opened, but without the package it refers to being actually vulnerable). If you find such a <span class="quote">“<span class="quote">false positive</span>”</span>, comment on the issue an explanation of why it falls into this category, linking as much information as the necessary to help maintainers double check.
    </p><p>
     If you are investigating a <span class="quote">“<span class="quote">true positive</span>”</span>:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       Find the earliest patched version or a code patch in the CVE details;
      </p></li><li class="listitem"><p>
       Is the issue already patched (version up-to-date or patch applied manually) in Nixpkgs’s <code class="literal">master</code> branch?
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         <span class="strong"><strong>No</strong></span>:
        </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
           <a class="link" href="#submitting-changes-submitting-security-fixes" title="19.3. Submitting security fixes">Submit a security fix</a>;
          </p></li><li class="listitem"><p>
           Once the fix is merged into <code class="literal">master</code>, <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#submitting-changes-stable-release-branches" target="_top">submit the change to the vulnerable release branch(es)</a>;
          </p></li></ul></div></li><li class="listitem"><p>
         <span class="strong"><strong>Yes</strong></span>: <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#submitting-changes-stable-release-branches" target="_top">Backport the change to the vulnerable release branch(es)</a>.
        </p></li></ul></div></li><li class="listitem"><p>
       When the patch has made it into all the relevant branches (<code class="literal">master</code>, and the vulnerable releases), close the relevant issue(s).
      </p></li></ul></div></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-reviewing-contributions"></a>Chapter 21. Reviewing contributions</h2></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="#reviewing-contributions-package-updates">21.1. Package updates</a></span></dt><dt><span class="section"><a href="#reviewing-contributions-new-packages">21.2. New packages</a></span></dt><dt><span class="section"><a href="#reviewing-contributions-module-updates">21.3. Module updates</a></span></dt><dt><span class="section"><a href="#reviewing-contributions-new-modules">21.4. New modules</a></span></dt><dt><span class="section"><a href="#reviewing-contributions-other-submissions">21.5. Other submissions</a></span></dt><dt><span class="section"><a href="#reviewing-contributions--merging-pull-requests">21.6. Merging pull requests</a></span></dt></dl></div><div class="warning"><h3 class="title">Warning</h3><p>
     The following section is a draft, and the policy for reviewing is still being discussed in issues such as <a class="link" href="https://github.com/NixOS/nixpkgs/issues/11166" target="_top">#11166</a> and <a class="link" href="https://github.com/NixOS/nixpkgs/issues/20836" target="_top">#20836</a>.
    </p></div><p>
    The Nixpkgs project receives a fairly high number of contributions via GitHub pull requests. Reviewing and approving these is an important task and a way to contribute to the project.
   </p><p>
    The high change rate of Nixpkgs makes any pull request that remains open for too long subject to conflicts that will require extra work from the submitter or the merger. Reviewing pull requests in a timely manner and being responsive to the comments is the key to avoid this issue. GitHub provides sort filters that can be used to see the <a class="link" href="https://github.com/NixOS/nixpkgs/pulls?q=is%3Apr+is%3Aopen+sort%3Aupdated-desc" target="_top">most recently</a> and the <a class="link" href="https://github.com/NixOS/nixpkgs/pulls?q=is%3Apr+is%3Aopen+sort%3Aupdated-asc" target="_top">least recently</a> updated pull requests. We highly encourage looking at <a class="link" href="https://github.com/NixOS/nixpkgs/pulls?q=is%3Apr+is%3Aopen+review%3Anone+status%3Asuccess+-label%3A%222.status%3A+work-in-progress%22+no%3Aproject+no%3Aassignee+no%3Amilestone" target="_top">this list of ready to merge, unreviewed pull requests</a>.
   </p><p>
    When reviewing a pull request, please always be nice and polite. Controversial changes can lead to controversial opinions, but it is important to respect every community member and their work.
   </p><p>
    GitHub provides reactions as a simple and quick way to provide feedback to pull requests or any comments. The thumb-down reaction should be used with care and if possible accompanied with some explanation so the submitter has directions to improve their contribution.
   </p><p>
    pull request reviews should include a list of what has been reviewed in a comment, so other reviewers and mergers can know the state of the review.
   </p><p>
    All the review template samples provided in this section are generic and meant as examples. Their usage is optional and the reviewer is free to adapt them to their liking.
   </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="reviewing-contributions-package-updates"></a>21.1. Package updates</h2></div></div></div><p>
     A package update is the most trivial and common type of pull request. These pull requests mainly consist of updating the version part of the package name and the source hash.
    </p><p>
     It can happen that non-trivial updates include patches or more complex changes.
    </p><p>
     Reviewing process:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       Ensure that the package versioning fits the guidelines.
      </p></li><li class="listitem"><p>
       Ensure that the commit text fits the guidelines.
      </p></li><li class="listitem"><p>
       Ensure that the package maintainers are notified.
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         <a class="link" href="https://help.github.com/articles/about-codeowners" target="_top">CODEOWNERS</a> will make GitHub notify users based on the submitted changes, but it can happen that it misses some of the package maintainers.
        </p></li></ul></div></li><li class="listitem"><p>
       Ensure that the meta field information is correct.
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         License can change with version updates, so it should be checked to match the upstream license.
        </p></li><li class="listitem"><p>
         If the package has no maintainer, a maintainer must be set. This can be the update submitter or a community member that accepts to take maintainership of the package.
        </p></li></ul></div></li><li class="listitem"><p>
       Ensure that the code contains no typos.
      </p></li><li class="listitem"><p>
       Building the package locally.
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><p>
         pull requests are often targeted to the master or staging branch, and building the pull request locally when it is submitted can trigger many source builds.
        </p></li><li class="listitem"><p>
         It is possible to rebase the changes on nixos-unstable or nixpkgs-unstable for easier review by running the following commands from a nixpkgs clone.
        </p><pre class="programlisting">
$ git fetch origin nixos-unstable
$ git fetch origin pull/PRNUMBER/head
$ git rebase --onto nixos-unstable BASEBRANCH FETCH_HEAD
</pre><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: square; "><li class="listitem"><p>
           The first command fetches the nixos-unstable branch.
          </p></li><li class="listitem"><p>
           The second command fetches the pull request changes, <code class="literal">PRNUMBER</code> is the number at the end of the pull request title and <code class="literal">BASEBRANCH</code> the base branch of the pull request.
          </p></li><li class="listitem"><p>
           The third command rebases the pull request changes to the nixos-unstable branch.
          </p></li></ul></div></li><li class="listitem"><p>
         The <a class="link" href="https://github.com/Mic92/nixpkgs-review" target="_top">nixpkgs-review</a> tool can be used to review a pull request content in a single command. <code class="literal">PRNUMBER</code> should be replaced by the number at the end of the pull request title. You can also provide the full github pull request url.
        </p><pre class="programlisting">
$ nix-shell -p nixpkgs-review --run "nixpkgs-review pr PRNUMBER"
</pre></li></ul></div></li><li class="listitem"><p>
       Running every binary.
      </p></li></ul></div><p>
     Sample template for a package update review is provided below.
    </p><pre class="programlisting">
##### Reviewed points

- [ ] package name fits guidelines
- [ ] package version fits guidelines
- [ ] package build on ARCHITECTURE
- [ ] executables tested on ARCHITECTURE
- [ ] all depending packages build

##### Possible improvements

##### Comments
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="reviewing-contributions-new-packages"></a>21.2. New packages</h2></div></div></div><p>
     New packages are a common type of pull requests. These pull requests consists in adding a new nix-expression for a package.
    </p><p>
     Review process:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       Ensure that the package versioning fits the guidelines.
      </p></li><li class="listitem"><p>
       Ensure that the commit name fits the guidelines.
      </p></li><li class="listitem"><p>
       Ensure that the meta fields contain correct information.
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         License must match the upstream license.
        </p></li><li class="listitem"><p>
         Platforms should be set (or the package will not get binary substitutes).
        </p></li><li class="listitem"><p>
         Maintainers must be set. This can be the package submitter or a community member that accepts taking up maintainership of the package.
        </p></li></ul></div></li><li class="listitem"><p>
       Report detected typos.
      </p></li><li class="listitem"><p>
       Ensure the package source:
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         Uses mirror URLs when available.
        </p></li><li class="listitem"><p>
         Uses the most appropriate functions (e.g. packages from GitHub should use <code class="literal">fetchFromGitHub</code>).
        </p></li></ul></div></li><li class="listitem"><p>
       Building the package locally.
      </p></li><li class="listitem"><p>
       Running every binary.
      </p></li></ul></div><p>
     Sample template for a new package review is provided below.
    </p><pre class="programlisting">
##### Reviewed points

- [ ] package path fits guidelines
- [ ] package name fits guidelines
- [ ] package version fits guidelines
- [ ] package build on ARCHITECTURE
- [ ] executables tested on ARCHITECTURE
- [ ] `meta.description` is set and fits guidelines
- [ ] `meta.license` fits upstream license
- [ ] `meta.platforms` is set
- [ ] `meta.maintainers` is set
- [ ] build time only dependencies are declared in `nativeBuildInputs`
- [ ] source is fetched using the appropriate function
- [ ] phases are respected
- [ ] patches that are remotely available are fetched with `fetchpatch`

##### Possible improvements

##### Comments
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="reviewing-contributions-module-updates"></a>21.3. Module updates</h2></div></div></div><p>
     Module updates are submissions changing modules in some ways. These often contains changes to the options or introduce new options.
    </p><p>
     Reviewing process:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       Ensure that the module maintainers are notified.
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         <a class="link" href="https://help.github.com/articles/about-codeowners/" target="_top">CODEOWNERS</a> will make GitHub notify users based on the submitted changes, but it can happen that it misses some of the package maintainers.
        </p></li></ul></div></li><li class="listitem"><p>
       Ensure that the module tests, if any, are succeeding.
      </p></li><li class="listitem"><p>
       Ensure that the introduced options are correct.
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         Type should be appropriate (string related types differs in their merging capabilities, <code class="literal">optionSet</code> and <code class="literal">string</code> types are deprecated).
        </p></li><li class="listitem"><p>
         Description, default and example should be provided.
        </p></li></ul></div></li><li class="listitem"><p>
       Ensure that option changes are backward compatible.
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         <code class="literal">mkRenamedOptionModule</code> and <code class="literal">mkAliasOptionModule</code> functions provide way to make option changes backward compatible.
        </p></li></ul></div></li><li class="listitem"><p>
       Ensure that removed options are declared with <code class="literal">mkRemovedOptionModule</code>
      </p></li><li class="listitem"><p>
       Ensure that changes that are not backward compatible are mentioned in release notes.
      </p></li><li class="listitem"><p>
       Ensure that documentations affected by the change is updated.
      </p></li></ul></div><p>
     Sample template for a module update review is provided below.
    </p><pre class="programlisting">
##### Reviewed points

- [ ] changes are backward compatible
- [ ] removed options are declared with `mkRemovedOptionModule`
- [ ] changes that are not backward compatible are documented in release notes
- [ ] module tests succeed on ARCHITECTURE
- [ ] options types are appropriate
- [ ] options description is set
- [ ] options example is provided
- [ ] documentation affected by the changes is updated

##### Possible improvements

##### Comments
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="reviewing-contributions-new-modules"></a>21.4. New modules</h2></div></div></div><p>
     New modules submissions introduce a new module to NixOS.
    </p><p>
     Reviewing process:
    </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p>
       Ensure that the module tests, if any, are succeeding.
      </p></li><li class="listitem"><p>
       Ensure that the introduced options are correct.
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         Type should be appropriate (string related types differs in their merging capabilities, <code class="literal">optionSet</code> and <code class="literal">string</code> types are deprecated).
        </p></li><li class="listitem"><p>
         Description, default and example should be provided.
        </p></li></ul></div></li><li class="listitem"><p>
       Ensure that module <code class="literal">meta</code> field is present
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         Maintainers should be declared in <code class="literal">meta.maintainers</code>.
        </p></li><li class="listitem"><p>
         Module documentation should be declared with <code class="literal">meta.doc</code>.
        </p></li></ul></div></li><li class="listitem"><p>
       Ensure that the module respect other modules functionality.
      </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle; "><li class="listitem"><p>
         For example, enabling a module should not open firewall ports by default.
        </p></li></ul></div></li></ul></div><p>
     Sample template for a new module review is provided below.
    </p><pre class="programlisting">
##### Reviewed points

- [ ] module path fits the guidelines
- [ ] module tests succeed on ARCHITECTURE
- [ ] options have appropriate types
- [ ] options have default
- [ ] options have example
- [ ] options have descriptions
- [ ] No unneeded package is added to environment.systemPackages
- [ ] meta.maintainers is set
- [ ] module documentation is declared in meta.doc

##### Possible improvements

##### Comments
</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="reviewing-contributions-other-submissions"></a>21.5. Other submissions</h2></div></div></div><p>
     Other type of submissions requires different reviewing steps.
    </p><p>
     If you consider having enough knowledge and experience in a topic and would like to be a long-term reviewer for related submissions, please contact the current reviewers for that topic. They will give you information about the reviewing process. The main reviewers for a topic can be hard to find as there is no list, but checking past pull requests to see who reviewed or git-blaming the code to see who committed to that topic can give some hints.
    </p><p>
     Container system, boot system and library changes are some examples of the pull requests fitting this category.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="reviewing-contributions--merging-pull-requests"></a>21.6. Merging pull requests</h2></div></div></div><p>
     It is possible for community members that have enough knowledge and experience on a special topic to contribute by merging pull requests.
    </p><p>
     Please see the discussion in <a class="link" href="https://github.com/NixOS/nixpkgs/issues/50105" target="_top">GitHub nixpkgs issue #50105</a> for information on how to proceed to be granted this level of access.
    </p><p>
     In a case a contributor definitively leaves the Nix community, they should create an issue or post on <a class="link" href="https://discourse.nixos.org" target="_top">Discourse</a> with references of packages and modules they maintain so the maintainership can be taken over by other contributors.
    </p></div></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="chap-contributing"></a>Chapter 22. Contributing to this documentation</h2></div></div></div><p>
    The DocBook sources of the Nixpkgs manual are in the <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/doc" target="_top">doc</a> subdirectory of the Nixpkgs repository.
   </p><p>
    You can quickly check your edits with <code class="literal">make</code>:
   </p><pre class="programlisting">
$ cd /path/to/nixpkgs/doc
$ nix-shell
[nix-shell]$ make
</pre><p>
    If you experience problems, run <code class="literal">make debug</code> to help understand the docbook errors.
   </p><p>
    After making modifications to the manual, it’s important to build it before committing. You can do that as follows:
   </p><pre class="programlisting">
$ cd /path/to/nixpkgs/doc
$ nix-shell
[nix-shell]$ make clean
[nix-shell]$ nix-build .
</pre><p>
    If the build succeeds, the manual will be in <code class="literal">./result/share/doc/nixpkgs/manual.html</code>.
   </p></div></div></div></body></html>